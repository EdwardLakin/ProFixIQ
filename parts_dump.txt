

==================== FILE: app/api/parts/consume/route.ts ====================

// app/api/parts/consume/route.ts
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { z } from "zod";
import { consumePart } from "@work-orders/lib/parts/consumePart";

// Strict payload schema (no anys)
const Payload = z.object({
  work_order_line_id: z.string().min(1),
  part_id: z.string().min(1),
  qty: z.number().positive(),
  location_id: z.string().min(1).optional(),
});

type Payload = z.infer<typeof Payload>;

export async function POST(req: NextRequest) {
  try {
    const json: unknown = await req.json();
    const parsed = Payload.safeParse(json);
    if (!parsed.success) {
      return NextResponse.json(
        { error: "Invalid payload", issues: parsed.error.flatten() },
        { status: 400 }
      );
    }

    const body: Payload = parsed.data;

    const result = await consumePart({
      work_order_line_id: body.work_order_line_id,
      part_id: body.part_id,
      qty: body.qty,
      location_id: body.location_id,
    });

    return NextResponse.json({ ok: true, result });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Failed to consume part";
    return NextResponse.json({ error: message }, { status: 500 });
  }
}




==================== FILE: app/api/parts/items/[itemId]/receive/route.ts ====================

// app/api/parts/requests/items/[itemId]/receive/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Body = {
  location_id: string;
  qty: number;
  po_id?: string | null;
};

export async function POST(
  req: Request,
  ctx: { params: Promise<{ itemId: string }> },
) {
  try {
    const supabase = createRouteHandlerClient<DB>({ cookies });

    const { itemId } = await ctx.params;

    const body = (await req.json().catch(() => null)) as Body | null;
    if (
      !itemId ||
      !body ||
      typeof body.location_id !== "string" ||
      typeof body.qty !== "number" ||
      !Number.isFinite(body.qty) ||
      body.qty <= 0
    ) {
      return NextResponse.json(
        { error: "Invalid body. Expect { location_id, qty, po_id? }" },
        { status: 400 },
      );
    }

    const {
      data: { user },
      error: userErr,
    } = await supabase.auth.getUser();

    if (userErr) return NextResponse.json({ error: userErr.message }, { status: 401 });
    if (!user) return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

    type RpcArgs =
      DB["public"]["Functions"]["receive_part_request_item"]["Args"];

    const args: RpcArgs = {
      p_item_id: itemId,
      p_location_id: body.location_id,
      p_qty: body.qty,
      ...(body.po_id ? { p_po_id: body.po_id } : {}),
    };

    const { data, error } = await supabase.rpc("receive_part_request_item", args);

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    // data is a row (table return) or array depending on supabase client behavior; normalize
    const row = Array.isArray(data) ? data[0] : data;

    return NextResponse.json({ ok: true, result: row });
  } catch (e: unknown) {
    const message =
      e instanceof Error ? e.message : typeof e === "string" ? e : "Server error";
    return NextResponse.json({ error: message }, { status: 500 });
  }
}

==================== FILE: app/api/parts/receiving/receive-item/route.ts ====================

// app/api/parts/receiving/receive-item/route.ts
import { NextResponse } from "next/server";

type Body = {
  part_request_item_id: string;
  qty: number;
  location_id: string;
  po_id?: string | null;
};

export async function POST(req: Request) {
  try {
    const body = (await req.json().catch(() => null)) as Body | null;
    if (!body) {
      return NextResponse.json({ error: "Invalid body" }, { status: 400 });
    }

    const id = String(body.part_request_item_id ?? "").trim();
    const loc = String(body.location_id ?? "").trim();
    const qty = typeof body.qty === "number" ? body.qty : Number(body.qty);

    const poId =
      typeof body.po_id === "string" && body.po_id.trim().length > 0 ? body.po_id.trim() : null;

    if (!id || !loc || !Number.isFinite(qty) || qty <= 0) {
      return NextResponse.json({ error: "Missing or invalid input" }, { status: 400 });
    }

    // Forward to canonical item-scoped route (which calls receive_part_request_item RPC)
    const res = await fetch(
      `${process.env.NEXT_PUBLIC_SITE_URL ?? ""}/api/parts/requests/items/${encodeURIComponent(id)}/receive`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json", cookie: req.headers.get("cookie") ?? "" },
        body: JSON.stringify({ location_id: loc, qty, po_id: poId }),
      },
    );

    const text = await res.text().catch(() => "");
    return new NextResponse(text, { status: res.status, headers: { "Content-Type": "application/json" } });
  } catch (e: unknown) {
    const message = e instanceof Error ? e.message : typeof e === "string" ? e : "Server error";
    return NextResponse.json({ error: message }, { status: 500 });
  }
}

==================== FILE: app/api/parts/requests/create/route.ts ====================

// app/api/parts/requests/create/route.ts

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type BodyItem = {
  description: string;
  qty: number;
};

type Body = {
  workOrderId: string;
  jobId?: string | null;
  items: BodyItem[];
  notes?: string | null;
};

export async function POST(req: Request) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  // 1) parse + validate
  const body = (await req.json().catch(() => null)) as Body | null;
  if (
    !body ||
    typeof body.workOrderId !== "string" ||
    !Array.isArray(body.items) ||
    body.items.length === 0
  ) {
    return NextResponse.json(
      { error: "Invalid body. Expect { workOrderId, items[] }." },
      { status: 400 },
    );
  }

  const workOrderId = body.workOrderId.trim();
  if (!workOrderId) {
    return NextResponse.json(
      { error: "workOrderId is required." },
      { status: 400 },
    );
  }

  // IMPORTANT: RPC args usually want undefined, not null.
  const jobId =
    typeof body.jobId === "string" && body.jobId.trim().length > 0
      ? body.jobId.trim()
      : undefined;

  const notes =
    typeof body.notes === "string" && body.notes.trim().length > 0
      ? body.notes.trim()
      : undefined;

  // Normalize items: trim, qty>=1, drop empty descriptions
  const items = body.items
    .map((it) => ({
      description: String(it.description ?? "").trim(),
      qty: Math.max(1, Number(it.qty) || 1),
    }))
    .filter((it) => it.description.length > 0);

  if (items.length === 0) {
    return NextResponse.json({ error: "No valid items." }, { status: 400 });
  }

  // 2) auth (return 401 cleanly instead of DB/RLS exception)
  const {
    data: { user },
    error: userErr,
  } = await supabase.auth.getUser();

  if (userErr) {
    return NextResponse.json({ error: userErr.message }, { status: 401 });
  }
  if (!user) {
    return NextResponse.json({ error: "Not authenticated" }, { status: 401 });
  }

  // 3) atomic RPC
  type RpcArgs =
    DB["public"]["Functions"]["create_part_request_with_items"]["Args"];

  const args: RpcArgs = {
    p_work_order_id: workOrderId,
    // json/jsonb in Postgres; generated types may be loose
    p_items: items as unknown as RpcArgs["p_items"],
    ...(jobId ? { p_job_id: jobId } : {}),
    ...(notes ? { p_notes: notes } : {}),
  };

  const { data, error } = await supabase.rpc(
    "create_part_request_with_items",
    args,
  );

  if (error || !data) {
    return NextResponse.json(
      { error: error?.message ?? "Failed to create part request" },
      { status: 500 },
    );
  }

  return NextResponse.json({ requestId: data });
}

==================== FILE: app/api/portal/parts/items/[itemId]/approve/route.ts ====================

// app/api/portal/parts/items/[itemId]/approve/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

function getStringParam(
  params: Record<string, string>,
  key: string,
): string | null {
  const v = params[key];
  return typeof v === "string" && v.trim().length > 0 ? v : null;
}

export async function POST(
  _req: Request,
  ctx: { params: Promise<Record<string, string>> },
) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 401 });
  if (!auth?.user) return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const params = await ctx.params;
  const itemId = getStringParam(params, "itemId");
  if (!itemId) return NextResponse.json({ error: "Missing itemId" }, { status: 400 });

  const { error } = await supabase.rpc("portal_approve_part_request_item", {
    p_item_id: itemId,
  });

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });
  return NextResponse.json({ ok: true });
}

==================== FILE: app/api/portal/parts/items/[itemId]/decline/route.ts ====================

// app/api/portal/parts/items/[itemId]/decline/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

function getStringParam(
  params: Record<string, string>,
  key: string,
): string | null {
  const v = params[key];
  return typeof v === "string" && v.trim().length > 0 ? v : null;
}

export async function POST(
  _req: Request,
  ctx: { params: Promise<Record<string, string>> },
) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 401 });
  if (!auth?.user) return NextResponse.json({ error: "Not authenticated" }, { status: 401 });

  const params = await ctx.params;
  const itemId = getStringParam(params, "itemId");
  if (!itemId) return NextResponse.json({ error: "Missing itemId" }, { status: 400 });

  const { error } = await supabase.rpc("portal_decline_part_request_item", {
    p_item_id: itemId,
  });

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });
  return NextResponse.json({ ok: true });
}

==================== FILE: app/parts/allocations/page.tsx ====================

"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Alloc = DB["public"]["Tables"]["work_order_part_allocations"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type LocRow = DB["public"]["Tables"]["stock_locations"]["Row"];
type WoLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WoRow = DB["public"]["Tables"]["work_orders"]["Row"];

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

async function resolveShopId(supabase: ReturnType<typeof createClientComponentClient<DB>>) {
  const { data: userRes } = await supabase.auth.getUser();
  const uid = userRes.user?.id ?? null;
  if (!uid) return "";

  const { data: profA } = await supabase.from("profiles").select("shop_id").eq("user_id", uid).maybeSingle();
  if (profA?.shop_id) return String(profA.shop_id);

  const { data: profB } = await supabase.from("profiles").select("shop_id").eq("id", uid).maybeSingle();
  return String(profB?.shop_id ?? "");
}

type UiAlloc = {
  alloc: Alloc;
  partName: string;
  partSku: string;
  locCode: string;
  locName: string;
  woCustom: string;
  woLineShort: string;
};

export default function AllocationsPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string>("");

  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [search, setSearch] = useState<string>("");
  const [rows, setRows] = useState<UiAlloc[]>([]);

  useEffect(() => {
    void (async () => {
      setLoading(true);
      setErr(null);

      try {
        const sid = await resolveShopId(supabase);
        setShopId(sid);

        if (!sid) {
          setRows([]);
          setLoading(false);
          return;
        }

        // allocations
        const { data: allocs, error: aerr } = await supabase
          .from("work_order_part_allocations")
          .select("*")
          .eq("shop_id", sid)
          .order("created_at", { ascending: false })
          .limit(400);

        if (aerr) throw aerr;

        const allocList = (allocs ?? []) as Alloc[];

        const partIds = Array.from(
          new Set(allocList.map((a) => a.part_id).filter((x): x is string => typeof x === "string" && x.length > 0)),
        );
        const locIds = Array.from(
          new Set(
            allocList.map((a) => a.location_id).filter((x): x is string => typeof x === "string" && x.length > 0),
          ),
        );
        const lineIds = Array.from(
          new Set(
            allocList
              .map((a) => a.work_order_line_id)
              .filter((x): x is string => typeof x === "string" && x.length > 0),
          ),
        );

        // parts + locations + lines + work orders (for custom_id)
        const [partsRes, locsRes, linesRes] = await Promise.all([
          partIds.length
            ? supabase.from("parts").select("id, name, sku").in("id", partIds)
            : Promise.resolve({ data: [] as unknown[] }),
          locIds.length
            ? supabase.from("stock_locations").select("id, code, name").in("id", locIds)
            : Promise.resolve({ data: [] as unknown[] }),
          lineIds.length
            ? supabase.from("work_order_lines").select("id, work_order_id").in("id", lineIds)
            : Promise.resolve({ data: [] as unknown[] }),
        ]);

        const partById = new Map<string, PartRow>();
        ((partsRes.data ?? []) as PartRow[]).forEach((p) => partById.set(String(p.id), p));

        const locById = new Map<string, LocRow>();
        ((locsRes.data ?? []) as LocRow[]).forEach((l) => locById.set(String(l.id), l));

        const lineById = new Map<string, WoLineRow>();
        ((linesRes.data ?? []) as WoLineRow[]).forEach((l) => lineById.set(String(l.id), l));

        const woIds = Array.from(
          new Set(
            ((linesRes.data ?? []) as WoLineRow[])
              .map((l) => l.work_order_id)
              .filter((x): x is string => typeof x === "string" && x.length > 0),
          ),
        );

        const woById = new Map<string, WoRow>();
        if (woIds.length) {
          const { data: wos } = await supabase.from("work_orders").select("id, custom_id").in("id", woIds);
          ((wos ?? []) as WoRow[]).forEach((w) => woById.set(String(w.id), w));
        }

        const ui: UiAlloc[] = allocList.map((a) => {
          const p = partById.get(String(a.part_id));
          const l = locById.get(String(a.location_id));
          const line = a.work_order_line_id ? lineById.get(String(a.work_order_line_id)) : undefined;
          const wo = line?.work_order_id ? woById.get(String(line.work_order_id)) : undefined;

          return {
            alloc: a,
            partName: p?.name ? String(p.name) : String(a.part_id).slice(0, 8),
            partSku: p?.sku ? String(p.sku) : "",
            locCode: l?.code ? String(l.code) : "LOC",
            locName: l?.name ? String(l.name) : "",
            woCustom: wo?.custom_id ? String(wo.custom_id) : (line?.work_order_id ? String(line.work_order_id).slice(0, 8) : "—"),
            woLineShort: a.work_order_line_id ? String(a.work_order_line_id).slice(0, 8) : "—",
          };
        });

        setRows(ui);
      } catch (e: unknown) {
        setErr(e instanceof Error ? e.message : "Failed to load allocations.");
      } finally {
        setLoading(false);
      }
    })();
  }, [supabase]);

  const filtered = useMemo(() => {
    const q = search.trim().toLowerCase();
    if (!q) return rows;
    return rows.filter((r) => {
      const blob = [
        r.woCustom,
        r.woLineShort,
        r.partName,
        r.partSku,
        r.locCode,
        r.locName,
        r.alloc.id ? String(r.alloc.id) : "",
      ]
        .join(" ")
        .toLowerCase();
      return blob.includes(q);
    });
  }, [rows, search]);

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">Parts</div>
          <h1 className="text-2xl font-bold">Allocations</h1>
          <div className="mt-1 text-sm text-neutral-400">
            Inventory allocations created from request items / consume flows.
          </div>
        </div>

        <div className="flex items-center gap-2">
          <Link
            href="/parts"
            className="rounded-full border border-white/10 bg-black/50 px-4 py-2 text-sm text-neutral-100 hover:border-orange-500/60"
          >
            ← Parts
          </Link>
        </div>
      </div>

      <div className="rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)]">
        <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div className="text-xs text-neutral-500">
            Showing <span className="text-neutral-200">{filtered.length}</span> allocations
          </div>
          <div className="w-full md:w-96">
            <input
              className="w-full rounded-xl border border-white/10 bg-black/60 px-3 py-2 text-sm text-white placeholder:text-neutral-500"
              placeholder="Search WO#, part, SKU, location…"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
        </div>
      </div>

      {loading ? (
        <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-400">Loading…</div>
      ) : err ? (
        <div className="rounded-2xl border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-200">{err}</div>
      ) : !shopId ? (
        <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-400">
          No shop detected for this user.
        </div>
      ) : filtered.length === 0 ? (
        <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-400">
          No allocations found.
        </div>
      ) : (
        <div className="overflow-hidden rounded-2xl border border-white/10 bg-black/40 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)]">
          <table className="w-full text-sm">
            <thead className="bg-white/5 text-left text-neutral-400">
              <tr>
                <th className="p-3">WO</th>
                <th className="p-3">WO Line</th>
                <th className="p-3">Part</th>
                <th className="p-3">Location</th>
                <th className="p-3 text-right">Qty</th>
                <th className="p-3">Created</th>
              </tr>
            </thead>
            <tbody>
              {filtered.map((r) => (
                <tr key={String(r.alloc.id)} className="border-t border-white/10 hover:bg-white/5">
                  <td className="p-3">
                    <span className="font-mono text-xs text-neutral-200">{r.woCustom}</span>
                  </td>
                  <td className="p-3">
                    <span className="font-mono text-xs text-neutral-200">{r.woLineShort}</span>
                  </td>
                  <td className="p-3">
                    <div className="text-neutral-200">{r.partName}</div>
                    {r.partSku ? <div className="text-xs text-neutral-500">{r.partSku}</div> : null}
                  </td>
                  <td className="p-3">
                    <div className="text-neutral-200">
                      {r.locCode} {r.locName ? `— ${r.locName}` : ""}
                    </div>
                  </td>
                  <td className="p-3 text-right font-mono text-neutral-200">{n(r.alloc.qty)}</td>
                  <td className="p-3 text-xs text-neutral-500">
                    {r.alloc.created_at ? new Date(r.alloc.created_at).toLocaleString() : "—"}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

==================== FILE: app/parts/inventory/page.tsx ====================

// app/parts/inventory/page.tsx
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { v4 as uuidv4 } from "uuid";

/* ----------------------------- Types ----------------------------- */

type DB = Database;
type Part = DB["public"]["Tables"]["parts"]["Row"];
type PartInsert = DB["public"]["Tables"]["parts"]["Insert"];
type PartUpdate = DB["public"]["Tables"]["parts"]["Update"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];
type StockMove = DB["public"]["Tables"]["stock_moves"]["Row"];

// app-side view of the enum
type StockMoveReason = "receive" | "adjust" | "consume" | "transfer";

/* --------------------------- UI helpers -------------------------- */

function Modal(props: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
  footer?: React.ReactNode;
  widthClass?: string;
}) {
  const { open, title, onClose, children, footer, widthClass = "max-w-xl" } = props;
  if (!open) return null;

  // ---- Theme (glass + burnt copper / metallic; no orange-400/500) ----
  const COPPER_BORDER = "border-[#8b5a2b]/60";
  const COPPER_FOCUS_RING = "focus:ring-2 focus:ring-[#8b5a2b]/35";

  const shell =
    "rounded-xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl " +
    "shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset] text-white";

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
      onClick={onClose}
    >
      <div
        className={`w-full ${widthClass} ${shell} p-4`}
        onClick={(e) => e.stopPropagation()}
        role="dialog"
        aria-modal="true"
      >
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-lg font-semibold">{title}</h2>
          <button
            onClick={onClose}
            className={`rounded-lg border border-white/10 bg-neutral-950/20 px-2 py-1 text-sm hover:bg-white/5 focus:outline-none ${COPPER_FOCUS_RING}`}
            aria-label="Close"
          >
            ✕
          </button>
        </div>

        <div>{children}</div>

        {footer ? (
          <div className={`mt-4 border-t border-white/10 pt-3 ${COPPER_BORDER}`}>{footer}</div>
        ) : null}
      </div>
    </div>
  );
}

function TextField(props: {
  label: string;
  value: string;
  placeholder?: string;
  onChange: (v: string) => void;
}) {
  const { label, value, placeholder, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <input
        className="w-full rounded-lg border border-white/10 bg-neutral-950/40 p-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
      />
    </div>
  );
}

function NumberField(props: {
  label: string;
  value: number | "";
  min?: number;
  step?: number;
  onChange: (v: number | "") => void;
}) {
  const { label, value, min = 0, step = 0.01, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <input
        type="number"
        className="w-full rounded-lg border border-white/10 bg-neutral-950/40 p-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35"
        value={value === "" ? "" : value}
        min={min}
        step={step}
        onChange={(e) => {
          const raw = e.target.value;
          onChange(raw === "" ? "" : Number(raw));
        }}
      />
    </div>
  );
}

function SelectField(props: {
  label: string;
  value: string;
  options: { value: string; label: string }[];
  onChange: (v: string) => void;
}) {
  const { label, value, options, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <select
        className="w-full rounded-lg border border-white/10 bg-neutral-950/40 p-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35"
        value={value}
        onChange={(e) => onChange(e.target.value)}
      >
        {options.map((o) => (
          <option key={o.value} value={o.value}>
            {o.label}
          </option>
        ))}
      </select>
    </div>
  );
}

/* ---------------------- CSV parsing helper ---------------------- */

function parseCSV(text: string): string[][] {
  const rows: string[][] = [];
  let row: string[] = [];
  let cell = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        const next = text[i + 1];
        if (next === '"') {
          cell += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        cell += ch;
      }
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ",") {
        row.push(cell.trim());
        cell = "";
      } else if (ch === "\n") {
        row.push(cell.trim());
        rows.push(row);
        row = [];
        cell = "";
      } else if (ch !== "\r") {
        cell += ch;
      }
    }
  }
  if (cell.length > 0 || row.length > 0) {
    row.push(cell.trim());
    rows.push(row);
  }
  return rows.filter((r) => r.length > 0 && r.some((c) => c.length > 0));
}

/* ------------------------- Error helper ------------------------- */
function errMsg(err: unknown): string {
  if (typeof err === "string") return err;
  if (err && typeof err === "object" && "message" in err) {
    return String((err as Record<string, unknown>).message);
  }
  try {
    return JSON.stringify(err);
  } catch {
    return String(err);
  }
}

/* ------------------------- RPC helper --------------------------- */
/** Try 6-arg function first; if schema cache hasn’t picked it up,
 * fall back to the 5-arg legacy shape. Strictly typed; ignores return value.
 */
async function applyStockMoveRPC(
  supabase: ReturnType<typeof createClientComponentClient<DB>>,
  args: {
    p_part: string;
    p_loc: string;
    p_qty: number;
    p_reason: StockMoveReason;
    p_ref_kind: string;
    p_ref_id?: string | null;
  },
): Promise<void> {
  type FnArgs = DB["public"]["Functions"]["apply_stock_move"]["Args"];

  // 6-arg (conditionally include p_ref_id so shapes match)
  const payload6 = {
    p_part: args.p_part,
    p_loc: args.p_loc,
    p_qty: args.p_qty,
    p_reason: args.p_reason as FnArgs extends { p_reason: infer R } ? R : never,
    p_ref_kind: args.p_ref_kind,
    ...(args.p_ref_id !== undefined ? { p_ref_id: args.p_ref_id } : {}),
  } as FnArgs;

  const call6 = await supabase.rpc("apply_stock_move", payload6);
  if (!call6.error) return;

  const msg = (call6.error?.message ?? "").toLowerCase();
  const cacheShapeIssue =
    msg.includes("could not find the function") ||
    msg.includes("schema cache") ||
    msg.includes("function apply_stock_move(");

  if (!cacheShapeIssue) throw new Error(call6.error?.message ?? "apply_stock_move failed");

  // 5-arg (legacy, no p_ref_id)
  const payload5 = {
    p_part: args.p_part,
    p_loc: args.p_loc,
    p_qty: args.p_qty,
    p_reason: args.p_reason as FnArgs extends { p_reason: infer R } ? R : never,
    p_ref_kind: args.p_ref_kind,
  } as FnArgs;

  const call5 = await supabase.rpc("apply_stock_move", payload5);
  if (call5.error) {
    throw new Error(call5.error.message ?? "apply_stock_move failed");
  }
}

/* ---------------------------- Page ---------------------------- */

export default function InventoryPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string>("");

  const [search, setSearch] = useState<string>("");
  const [parts, setParts] = useState<Part[]>([]);
  const [loading, setLoading] = useState<boolean>(true);

  // stock locations
  const [locs, setLocs] = useState<StockLoc[]>([]);

  // on-hand map: partId -> total qty
  const [onHand, setOnHand] = useState<Record<string, number>>({});
  // per-location detail modal
  const [ohOpen, setOhOpen] = useState<boolean>(false);
  const [ohForPart, setOhForPart] = useState<Part | null>(null);
  const [ohLines, setOhLines] = useState<{ location: string; qty: number }[]>([]);

  // add modal
  const [addOpen, setAddOpen] = useState<boolean>(false);
  const [name, setName] = useState<string>("");
  const [sku, setSku] = useState<string>("");
  const [category, setCategory] = useState<string>("");
  const [price, setPrice] = useState<number | "">("");

  // initial receive (optional) for Add
  const [initLoc, setInitLoc] = useState<string>("");
  const [initQty, setInitQty] = useState<number | "">("");

  // edit modal
  const [editOpen, setEditOpen] = useState<boolean>(false);
  const [editPart, setEditPart] = useState<Part | null>(null);
  const [editName, setEditName] = useState<string>("");
  const [editSku, setEditSku] = useState<string>("");
  const [editCategory, setEditCategory] = useState<string>("");
  const [editPrice, setEditPrice] = useState<number | "">("");

  // receive modal (standalone quick receive)
  const [recvOpen, setRecvOpen] = useState<boolean>(false);
  const [recvPart, setRecvPart] = useState<Part | null>(null);
  const [recvLoc, setRecvLoc] = useState<string>("");
  const [recvQty, setRecvQty] = useState<number | "">("");

  // CSV Import
  const [csvOpen, setCsvOpen] = useState<boolean>(false);
  const [csvText, setCsvText] = useState<string>("");
  const [csvRows, setCsvRows] = useState<
    { name: string; sku?: string; category?: string; price?: number; qty?: number }[]
  >([]);
  const [csvPreview, setCsvPreview] = useState<boolean>(false);
  const [csvDefaultLoc, setCsvDefaultLoc] = useState<string>("");

  // ---- Theme (glass + burnt copper / metallic; no orange-400/500) ----
  const COPPER_TEXT = "text-[#c88a4d]";
  const COPPER_HOVER_BG = "hover:bg-[#8b5a2b]/10";
  const COPPER_FOCUS_RING = "focus:ring-2 focus:ring-[#8b5a2b]/35";

  const pageWrap = "space-y-4 p-6 text-white";
  const glassCard =
    "rounded-xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset]";
  const glassHeader =
    "bg-gradient-to-b from-white/5 to-transparent border-b border-white/10";

  const inputBase =
    `rounded-lg border bg-neutral-950/40 px-3 py-2 text-sm text-white placeholder:text-neutral-500 border-white/10 focus:outline-none ${COPPER_FOCUS_RING}`;

  const btnBase =
    "inline-flex items-center justify-center rounded-lg border px-3 py-2 text-sm font-semibold transition disabled:opacity-60";
  const btnGhost = `${btnBase} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
  const btnCopper = `${btnBase} border-white/10 ${COPPER_TEXT} bg-neutral-950/20 ${COPPER_HOVER_BG}`;
  const btnBlue = `${btnBase} border-sky-500/30 bg-sky-950/25 text-sky-200 hover:bg-sky-900/25`;

  const pillBase =
    "inline-flex items-center whitespace-nowrap rounded-full border px-3 py-1 text-xs font-semibold";
  const pillOk = `${pillBase} border-emerald-500/30 bg-emerald-950/25 text-emerald-200`;
  const pillZero = `${pillBase} border-red-500/30 bg-red-950/35 text-red-200`;

  // ---------- on-hand loader (pass sid directly; avoids first-render zeros)
  const loadOnHand = useCallback(
    async (sid: string, partIds: string[]) => {
      if (!partIds.length) {
        setOnHand({});
        return;
      }
      const { data, error } = await supabase
        .from("stock_moves")
        .select("part_id, qty_change")
        .in("part_id", partIds)
        .eq("shop_id", sid);

      if (error || !data) {
        setOnHand({});
        return;
      }

      const totals: Record<string, number> = {};
      (data as StockMove[]).forEach((m) => {
        const delta = Number(m.qty_change) || 0;
        totals[m.part_id] = (totals[m.part_id] ?? 0) + delta;
      });
      setOnHand(totals);
    },
    [supabase],
  );

  const load = useCallback(
    async (sid: string) => {
      setLoading(true);

      const base = supabase
        .from("parts")
        .select("*")
        .eq("shop_id", sid)
        .order("name", { ascending: true });

      const q = search.trim();

      const { data, error } = await (q
        ? base.or([`name.ilike.%${q}%`, `sku.ilike.%${q}%`, `category.ilike.%${q}%`].join(","))
        : base);

      const partRows = (!error && (data as Part[])) || [];
      setParts(partRows);
      setLoading(false);

      void loadOnHand(sid, partRows.map((p) => p.id));
    },
    [supabase, search, loadOnHand],
  );

  // --- on-hand detail (per-location)
  const openOnHandDetail = useCallback(
    async (p: Part) => {
      setOhForPart(p);

      const { data, error } = await supabase
        .from("stock_moves")
        .select("location_id, qty_change")
        .eq("part_id", p.id)
        .eq("shop_id", shopId);

      if (error || !data) {
        setOhLines([]);
        setOhOpen(true);
        return;
      }

      const byLoc: Record<string, number> = {};
      (data as StockMove[]).forEach((r) => {
        const loc = r.location_id as string;
        const q = Number(r.qty_change) || 0;
        byLoc[loc] = (byLoc[loc] ?? 0) + q;
      });

      const lines = locs
        .map((l) => ({
          location: `${l.code ?? "LOC"} — ${l.name ?? ""}`,
          qty: byLoc[l.id] ?? 0,
        }))
        .filter((x) => x.qty !== 0);

      setOhLines(lines);
      setOhOpen(true);
    },
    [supabase, shopId, locs],
  );

  /* boot */
  useEffect(() => {
    (async () => {
      const { data: u } = await supabase.auth.getUser();
      const uid = u.user?.id ?? null;
      if (!uid) return;

      const { data: profA } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .maybeSingle();

      const sidA = (profA?.shop_id as string) || "";

      const sid = sidA || "";
      setShopId(sid);
      if (!sid) return;

      const { data: l } = await supabase
        .from("stock_locations")
        .select("*")
        .eq("shop_id", sid)
        .order("code");

      const locRows = (l as StockLoc[]) ?? [];
      setLocs(locRows);

      const main = locRows.find((x) => (x.code ?? "").toUpperCase() === "MAIN");
      if (main) {
        setInitLoc(main.id);
        setRecvLoc(main.id);
        setCsvDefaultLoc(main.id);
      } else if (locRows[0]?.id) {
        setInitLoc(locRows[0].id);
        setRecvLoc(locRows[0].id);
        setCsvDefaultLoc(locRows[0].id);
      }

      await load(sid);
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase, load]);

  /* refetch on search */
  useEffect(() => {
    if (shopId) void load(shopId);
  }, [search, shopId, load]);

  /* ----------------------- CRUD handlers ----------------------- */

  const createPart = async () => {
    if (!shopId || !name.trim()) return;

    const id = uuidv4();
    const insert: PartInsert = {
      id,
      shop_id: shopId,
      name: name.trim(),
      sku: sku.trim() ? sku.trim() : undefined,
      category: category.trim() ? category.trim() : undefined,
      price: typeof price === "number" ? price : undefined,
    };

    const { error } = await supabase.from("parts").insert(insert);
    if (error) {
      alert(error.message);
      return;
    }

    // optional initial receive
    if (initLoc && typeof initQty === "number" && initQty > 0) {
      try {
        await applyStockMoveRPC(supabase, {
          p_part: id,
          p_loc: initLoc,
          p_qty: initQty,
          p_reason: "receive",
          p_ref_kind: "manual_receive",
          p_ref_id: null,
        });
      } catch (err: unknown) {
        alert(`Part created, but stock receive failed: ${errMsg(err)}`);
      }
    }

    setAddOpen(false);
    setName("");
    setSku("");
    setCategory("");
    setPrice("");
    setInitQty("");
    await load(shopId);
  };

  const openEdit = (p: Part) => {
    setEditPart(p);
    setEditName(p.name ?? "");
    setEditSku(p.sku ?? "");
    setEditCategory(p.category ?? "");
    setEditPrice(typeof p.price === "number" ? p.price : "");
    setEditOpen(true);
  };

  const saveEdit = async () => {
    if (!editPart?.id) return;

    const patch: PartUpdate = {
      name: editName.trim() ? editName.trim() : undefined,
      sku: editSku.trim() ? editSku.trim() : undefined,
      category: editCategory.trim() ? editCategory.trim() : undefined,
      price: typeof editPrice === "number" ? editPrice : undefined,
    };

    const { error } = await supabase.from("parts").update(patch).eq("id", editPart.id);
    if (error) {
      alert(error.message);
      return;
    }

    setEditOpen(false);
    await load(shopId);
  };

  const openReceive = (p: Part) => {
    setRecvPart(p);
    setRecvQty("");
    setRecvOpen(true);
  };

  const applyReceive = async () => {
    if (!recvPart?.id || !recvLoc || typeof recvQty !== "number" || recvQty <= 0) return;

    try {
      await applyStockMoveRPC(supabase, {
        p_part: recvPart.id,
        p_loc: recvLoc,
        p_qty: recvQty,
        p_reason: "receive",
        p_ref_kind: "manual_receive",
        p_ref_id: null,
      });
      setRecvOpen(false);
      await load(shopId);
    } catch (err: unknown) {
      alert(errMsg(err));
    }
  };

  /* -------------------------- CSV Import -------------------------- */

  const parseAndPreviewCSV = (raw: string) => {
    const rows = parseCSV(raw);
    if (!rows.length) {
      setCsvRows([]);
      setCsvPreview(false);
      return;
    }
    const header = rows[0].map((h) => h.toLowerCase().trim());
    const idx = {
      name: header.indexOf("name"),
      sku: header.indexOf("sku"),
      category: header.indexOf("category"),
      price: header.indexOf("price"),
      qty: header.indexOf("qty"),
    };

    const out: { name: string; sku?: string; category?: string; price?: number; qty?: number }[] = [];

    for (let r = 1; r < rows.length; r++) {
      const row = rows[r];
      const nm = idx.name >= 0 ? row[idx.name] : "";
      const name = (nm ?? "").trim();
      if (!name) continue;

      const sku = idx.sku >= 0 ? (row[idx.sku] ?? "").trim() : "";
      const category = idx.category >= 0 ? (row[idx.category] ?? "").trim() : "";
      const priceStr = idx.price >= 0 ? (row[idx.price] ?? "").trim() : "";
      const qtyStr = idx.qty >= 0 ? (row[idx.qty] ?? "").trim() : "";

      const priceNum = priceStr ? Number(priceStr) : NaN;
      const qtyNum = qtyStr ? Number(qtyStr) : NaN;

      out.push({
        name,
        sku: sku || undefined,
        category: category || undefined,
        price: Number.isFinite(priceNum) ? priceNum : undefined,
        qty: Number.isFinite(qtyNum) ? qtyNum : undefined,
      });
    }

    setCsvRows(out);
    setCsvPreview(true);
  };

  const handleCsvFile = async (file: File) => {
    const text = await file.text();
    setCsvText(text);
    parseAndPreviewCSV(text);
  };

  const runCsvImport = async () => {
    if (!shopId || !csvRows.length) return;

    // NOTE: intentionally sequential to keep it safe and predictable for now.
    for (const row of csvRows) {
      let partId: string | null = null;

      if (row.sku) {
        const { data: found } = await supabase
          .from("parts")
          .select("id")
          .eq("shop_id", shopId)
          .eq("sku", row.sku)
          .maybeSingle();

        if (found?.id) partId = String(found.id);
      }

      if (!partId) {
        const id = uuidv4();
        const insert: PartInsert = {
          id,
          shop_id: shopId,
          name: row.name,
          sku: row.sku || undefined,
          category: row.category || undefined,
          price: typeof row.price === "number" ? row.price : undefined,
        };
        const { error } = await supabase.from("parts").insert(insert);
        if (error) {
          // eslint-disable-next-line no-console
          console.warn("Insert failed:", row, error.message);
          continue;
        }
        partId = id;
      } else {
        const patch: PartUpdate = {
          name: row.name || undefined,
          sku: row.sku || undefined,
          category: row.category || undefined,
          price: typeof row.price === "number" ? row.price : undefined,
        };
        await supabase.from("parts").update(patch).eq("id", partId);
      }

      if (partId && csvDefaultLoc && typeof row.qty === "number" && row.qty > 0) {
        try {
          await applyStockMoveRPC(supabase, {
            p_part: partId,
            p_loc: csvDefaultLoc,
            p_qty: row.qty,
            p_reason: "receive",
            p_ref_kind: "csv_import",
            p_ref_id: null,
          });
        } catch (err: unknown) {
          // eslint-disable-next-line no-console
          console.warn("Stock receive failed for row:", row, errMsg(err));
        }
      }
    }

    setCsvOpen(false);
    setCsvPreview(false);
    setCsvText("");
    setCsvRows([]);
    await load(shopId);
  };

  /* ----------------------------- UI ----------------------------- */

  return (
    <div className={pageWrap}>
      <div className={`${glassCard} overflow-hidden`}>
        <div className={`${glassHeader} px-5 py-4`}>
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">
                Parts
              </div>
              <h1 className="text-2xl font-semibold" style={{ fontFamily: "var(--font-blackops), system-ui" }}>
                Inventory
              </h1>
              <div className="mt-1 text-sm text-neutral-400">
                Create parts, quick receive, and import stock from CSV.
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-2">
              <input
                className={`${inputBase} w-72`}
                placeholder="Search name / SKU / category"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />

              <button className={btnCopper} onClick={() => setAddOpen(true)} disabled={!shopId}>
                Add Part
              </button>

              <button className={btnBlue} onClick={() => setCsvOpen(true)} disabled={!shopId}>
                CSV Import
              </button>
            </div>
          </div>
        </div>
      </div>

      {loading ? (
        <div className={`${glassCard} p-4 text-sm text-neutral-300`}>Loading…</div>
      ) : parts.length === 0 ? (
        <div className={`${glassCard} p-4 text-sm text-neutral-300`}>
          No parts yet. Click “Add Part” to create your first item or use CSV Import.
        </div>
      ) : (
        <div className={`${glassCard} overflow-hidden`}>
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-white/5 text-neutral-400">
                <tr className="text-left">
                  <th className="p-3">Name</th>
                  <th className="p-3">SKU</th>
                  <th className="p-3">Category</th>
                  <th className="p-3">Price</th>
                  <th className="p-3">On hand</th>
                  <th className="w-56 p-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {parts.map((p) => {
                  const total = onHand[p.id] ?? 0;
                  const onHandPill = total > 0 ? pillOk : pillZero;

                  return (
                    <tr key={p.id} className="border-t border-white/10">
                      <td className="p-3">
                        <div className="font-medium text-white">{p.name}</div>
                        <div className="mt-0.5 text-xs text-neutral-500">
                          {p.id ? `#${String(p.id).slice(0, 8)}` : ""}
                        </div>
                      </td>
                      <td className="p-3">{p.sku ?? "—"}</td>
                      <td className="p-3">{p.category ?? "—"}</td>
                      <td className="p-3 tabular-nums">
                        {typeof p.price === "number" ? `$${p.price.toFixed(2)}` : "—"}
                      </td>
                      <td className="p-3">
                        <button
                          className={`${onHandPill} hover:bg-white/5`}
                          onClick={() => void openOnHandDetail(p)}
                          title="View per-location balance"
                        >
                          {total}
                        </button>
                      </td>
                      <td className="p-3">
                        <div className="flex justify-end gap-2">
                          <button className={btnGhost} onClick={() => openEdit(p)}>
                            Edit
                          </button>
                          <button className={btnBlue} onClick={() => openReceive(p)}>
                            Receive
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="border-t border-white/10 px-5 py-3 text-xs text-neutral-500">
            Tip: Click the on-hand number to see per-location balances.
          </div>
        </div>
      )}

      {/* Add Part */}
      <Modal
        open={addOpen}
        title="Add Part"
        onClose={() => setAddOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button className={btnGhost} onClick={() => setAddOpen(false)}>
              Cancel
            </button>
            <button className={btnCopper} onClick={createPart} disabled={!name.trim()}>
              Save Part
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <div className="sm:col-span-2">
            <TextField label="Name*" value={name} onChange={setName} placeholder="Part name" />
          </div>
          <TextField label="SKU" value={sku} onChange={setSku} placeholder="Optional" />
          <TextField label="Category" value={category} onChange={setCategory} placeholder="Optional" />
          <NumberField label="Price" value={price} onChange={(v) => setPrice(v === "" ? "" : v)} />
        </div>

        <div className="mt-4 rounded-xl border border-white/10 bg-neutral-950/20 p-3">
          <div className="mb-2 text-sm font-semibold text-white">
            Initial Stock <span className="text-xs font-normal text-neutral-400">(optional)</span>
          </div>
          <div className="grid gap-3 sm:grid-cols-2">
            <SelectField
              label="Location"
              value={initLoc}
              onChange={setInitLoc}
              options={[
                { value: "", label: "— none —" },
                ...locs.map((l) => ({
                  value: l.id,
                  label: `${l.code ?? "LOC"} — ${l.name ?? ""}`,
                })),
              ]}
            />
            <NumberField
              label="Qty"
              value={initQty}
              min={0}
              step={1}
              onChange={(v) => setInitQty(v === "" ? "" : Math.max(0, v))}
            />
          </div>
        </div>
      </Modal>

      {/* Edit Part */}
      <Modal
        open={editOpen}
        title="Edit Part"
        onClose={() => setEditOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button className={btnGhost} onClick={() => setEditOpen(false)}>
              Cancel
            </button>
            <button className={btnCopper} onClick={saveEdit} disabled={!editName.trim()}>
              Save Changes
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <div className="sm:col-span-2">
            <TextField label="Name*" value={editName} onChange={setEditName} />
          </div>
          <TextField label="SKU" value={editSku} onChange={setEditSku} />
          <TextField label="Category" value={editCategory} onChange={setEditCategory} />
          <NumberField label="Price" value={editPrice} onChange={(v) => setEditPrice(v === "" ? "" : v)} />
        </div>
      </Modal>

      {/* Receive Stock */}
      <Modal
        open={recvOpen}
        title={recvPart ? `Receive — ${recvPart.name}` : "Receive Stock"}
        onClose={() => setRecvOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button className={btnGhost} onClick={() => setRecvOpen(false)}>
              Cancel
            </button>
            <button
              className={btnBlue}
              onClick={applyReceive}
              disabled={!recvPart?.id || !recvLoc || typeof recvQty !== "number" || recvQty <= 0}
            >
              Apply Receive
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <SelectField
            label="Location"
            value={recvLoc}
            onChange={setRecvLoc}
            options={locs.map((l) => ({
              value: l.id,
              label: `${l.code ?? "LOC"} — ${l.name ?? ""}`,
            }))}
          />
          <NumberField
            label="Qty"
            value={recvQty}
            min={0}
            step={1}
            onChange={(v) => setRecvQty(v === "" ? "" : Math.max(0, v))}
          />
        </div>
      </Modal>

      {/* On-hand detail */}
      <Modal
        open={ohOpen}
        title={ohForPart ? `On hand — ${ohForPart.name}` : "On hand"}
        onClose={() => setOhOpen(false)}
        widthClass="max-w-lg"
      >
        {ohLines.length === 0 ? (
          <div className="text-sm text-neutral-300">No movement found for this part.</div>
        ) : (
          <div className="overflow-hidden rounded-xl border border-white/10 bg-neutral-950/20">
            <table className="w-full text-sm">
              <thead className="bg-white/5 text-left text-neutral-400">
                <tr>
                  <th className="p-3">Location</th>
                  <th className="p-3">Qty</th>
                </tr>
              </thead>
              <tbody>
                {ohLines.map((l, i) => (
                  <tr key={i} className="border-t border-white/10">
                    <td className="p-3">{l.location}</td>
                    <td className="p-3 tabular-nums">{l.qty}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </Modal>

      {/* CSV Import */}
      <Modal
        open={csvOpen}
        title="CSV Import"
        onClose={() => setCsvOpen(false)}
        widthClass="max-w-3xl"
        footer={
          <div className="flex w-full flex-wrap items-end justify-between gap-3">
            <div className="min-w-[260px]">
              <SelectField
                label="Default receive location (for rows with qty)"
                value={csvDefaultLoc}
                onChange={setCsvDefaultLoc}
                options={[
                  { value: "", label: "— none —" },
                  ...locs.map((l) => ({
                    value: l.id,
                    label: `${l.code ?? "LOC"} — ${l.name ?? ""}`,
                  })),
                ]}
              />
            </div>

            <div className="flex items-center gap-2">
              <button
                className={btnGhost}
                onClick={() => {
                  setCsvPreview(false);
                  setCsvText("");
                  setCsvRows([]);
                  setCsvOpen(false);
                }}
              >
                Close
              </button>
              <button
                className={btnBlue}
                onClick={runCsvImport}
                disabled={!csvPreview || csvRows.length === 0}
              >
                Import
              </button>
            </div>
          </div>
        }
      >
        <div className="grid gap-3">
          <div className="rounded-xl border border-white/10 bg-neutral-950/20 p-3 text-sm text-neutral-300">
            Expected headers (case-insensitive): <code className={COPPER_TEXT}>name, sku, category, price, qty</code>.
            Extra columns are ignored.
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <input
              type="file"
              accept=".csv,text/csv"
              onChange={(e) => {
                const f = e.target.files?.[0];
                if (f) void handleCsvFile(f);
              }}
              className="text-sm text-neutral-200"
            />
            <button
              className={btnGhost}
              onClick={() => {
                if (csvText.trim().length) parseAndPreviewCSV(csvText);
              }}
            >
              Parse text
            </button>
          </div>

          <textarea
            rows={8}
            className={`${inputBase} font-mono text-xs`}
            placeholder={`Paste CSV here… e.g.:
name,sku,category,price,qty
Oil Filter – Ford,OF-FORD-01,Filters,9.95,10
Spark Plug – Iridium,SP-IR-01,Ignition,9.95,24
`}
            value={csvText}
            onChange={(e) => setCsvText(e.target.value)}
          />

          {csvPreview && (
            <div className="overflow-hidden rounded-xl border border-white/10 bg-neutral-950/20">
              <table className="w-full text-sm">
                <thead className="bg-white/5 text-left text-neutral-400">
                  <tr>
                    <th className="p-3">Name</th>
                    <th className="p-3">SKU</th>
                    <th className="p-3">Category</th>
                    <th className="p-3">Price</th>
                    <th className="p-3">Qty</th>
                  </tr>
                </thead>
                <tbody>
                  {csvRows.map((r, i) => (
                    <tr key={i} className="border-t border-white/10">
                      <td className="p-3">{r.name}</td>
                      <td className="p-3">{r.sku ?? "—"}</td>
                      <td className="p-3">{r.category ?? "—"}</td>
                      <td className="p-3 tabular-nums">
                        {typeof r.price === "number" ? r.price.toFixed(2) : "—"}
                      </td>
                      <td className="p-3 tabular-nums">
                        {typeof r.qty === "number" ? r.qty : "—"}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}

          {csvPreview && (
            <div className="text-xs text-neutral-500">
              Rows: <span className="font-semibold text-white">{csvRows.length}</span>
              {csvDefaultLoc ? (
                <>
                  {" "}
                  · Default receive loc: <span className={COPPER_TEXT}>{csvDefaultLoc.slice(0, 8)}</span>
                </>
              ) : (
                <>
                  {" "}
                  · <span className="text-neutral-400">No default receive location set</span>
                </>
              )}
            </div>
          )}
        </div>
      </Modal>
    </div>
  );
}

==================== FILE: app/parts/movements/page.tsx ====================

// app/parts/movements/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type StockMove = DB["public"]["Tables"]["stock_moves"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type LocRow = DB["public"]["Tables"]["stock_locations"]["Row"];

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

async function resolveShopId(supabase: ReturnType<typeof createClientComponentClient<DB>>) {
  const { data: userRes } = await supabase.auth.getUser();
  const uid = userRes.user?.id ?? null;
  if (!uid) return "";

  const { data: profA } = await supabase.from("profiles").select("shop_id").eq("user_id", uid).maybeSingle();
  if (profA?.shop_id) return String(profA.shop_id);

  const { data: profB } = await supabase.from("profiles").select("shop_id").eq("id", uid).maybeSingle();
  return String(profB?.shop_id ?? "");
}

export default function StockMovementsPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string>("");

  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  const [moves, setMoves] = useState<StockMove[]>([]);
  const [parts, setParts] = useState<Record<string, PartRow>>({});
  const [locs, setLocs] = useState<Record<string, LocRow>>({});

  const card =
    "metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl";

  const load = async () => {
    setLoading(true);
    setErr(null);

    const sid = shopId || (await resolveShopId(supabase));
    if (!sid) {
      setLoading(false);
      return;
    }
    if (!shopId) setShopId(sid);

    const { data: mv, error: mvErr } = await supabase
      .from("stock_moves")
      .select("id, part_id, location_id, qty_change, reason, reference_kind, reference_id, created_at, created_by, shop_id")
      .eq("shop_id", sid)
      .order("created_at", { ascending: false })
      .limit(200);

    if (mvErr) {
      setErr(mvErr.message);
      setLoading(false);
      return;
    }

    const rows = (mv ?? []) as StockMove[];
    setMoves(rows);

    const partIds = Array.from(new Set(rows.map((r) => String(r.part_id)).filter(Boolean)));
    const locIds = Array.from(new Set(rows.map((r) => String(r.location_id)).filter(Boolean)));

    if (partIds.length) {
      const { data: pr, error: prErr } = await supabase.from("parts").select("*").in("id", partIds);
      if (prErr) setErr(prErr.message);
      const map: Record<string, PartRow> = {};
      (pr ?? []).forEach((p) => (map[String((p as PartRow).id)] = p as PartRow));
      setParts(map);
    } else setParts({});

    if (locIds.length) {
      const { data: lr, error: lrErr } = await supabase.from("stock_locations").select("*").in("id", locIds);
      if (lrErr) setErr(lrErr.message);
      const map: Record<string, LocRow> = {};
      (lr ?? []).forEach((l) => (map[String((l as LocRow).id)] = l as LocRow));
      setLocs(map);
    } else setLocs({});

    setLoading(false);
  };

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex items-start justify-between gap-3">
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">Parts</div>
          <h1 className="text-2xl font-bold" style={{ fontFamily: "var(--font-blackops), system-ui" }}>
            Stock Movements
          </h1>
          <div className="text-sm text-neutral-400">Immutable inventory ledger (stock_moves).</div>
        </div>
        <button
          onClick={() => void load()}
          className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 px-4 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/70"
        >
          Refresh
        </button>
      </div>

      {err ? (
        <div className="rounded-xl border border-red-500/30 bg-red-950/30 p-3 text-sm text-red-200">
          {err}
        </div>
      ) : null}

      {loading ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>Loading…</div>
      ) : moves.length === 0 ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>No movements.</div>
      ) : (
        <div className={`${card} overflow-hidden`}>
          <div className="border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-3">
            <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
              Latest movements
            </div>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-neutral-400">
                  <th className="p-3">Time</th>
                  <th className="p-3">Part</th>
                  <th className="p-3">Location</th>
                  <th className="p-3">Qty</th>
                  <th className="p-3">Reason</th>
                  <th className="p-3">Ref</th>
                </tr>
              </thead>
              <tbody>
                {moves.map((m) => {
                  const part = parts[String(m.part_id)];
                  const loc = locs[String(m.location_id)];
                  const qty = n(m.qty_change);
                  const t = m.created_at ? new Date(m.created_at).toLocaleString() : "—";

                  return (
                    <tr key={String(m.id)} className="border-t border-white/10">
                      <td className="p-3 whitespace-nowrap text-neutral-300">{t}</td>
                      <td className="p-3">
                        <div className="font-semibold text-neutral-100">
                          {part?.name ? String(part.name) : String(m.part_id).slice(0, 8)}
                        </div>
                        <div className="text-[11px] text-neutral-500">
                          {part?.sku ? String(part.sku) + " • " : ""}
                          {String(m.part_id).slice(0, 8)}
                        </div>
                      </td>
                      <td className="p-3">
                        <div className="font-semibold text-neutral-100">{loc?.code ? String(loc.code) : "LOC"}</div>
                        <div className="text-[11px] text-neutral-500">{loc?.name ? String(loc.name) : String(m.location_id).slice(0, 8)}</div>
                      </td>
                      <td className="p-3 tabular-nums font-semibold">
                        <span className={qty >= 0 ? "text-emerald-300" : "text-red-300"}>{qty}</span>
                      </td>
                      <td className="p-3">{String(m.reason ?? "")}</td>
                      <td className="p-3 text-[11px] text-neutral-400">
                        {String(m.reference_kind ?? "—")}
                        {m.reference_id ? " • " + String(m.reference_id).slice(0, 8) : ""}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="border-t border-white/10 px-4 py-3 text-[11px] text-neutral-500">
            This is your source of truth. part_stock is a snapshot maintained by triggers on stock_moves.
          </div>
        </div>
      )}
    </div>
  );
}

==================== FILE: app/parts/page.tsx ====================

//app/parts/page.tsx

"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type StockMoveRow = DB["public"]["Tables"]["stock_moves"]["Row"];
type RequestRow = DB["public"]["Tables"]["part_requests"]["Row"];

// ---------- UI helpers ----------

function Sparkline({
  points,
  width = 120,
  height = 28,
}: {
  points: number[];
  width?: number;
  height?: number;
}) {
  if (!points.length) {
    return (
      <svg width={width} height={height} aria-hidden>
        <line
          x1="0"
          x2={width}
          y1={height / 2}
          y2={height / 2}
          stroke="currentColor"
          opacity={0.2}
        />
      </svg>
    );
  }
  const min = Math.min(...points);
  const max = Math.max(...points);
  const range = max - min || 1;
  const stepX = width / Math.max(1, points.length - 1);
  const path = points
    .map((v, i) => {
      const x = i * stepX;
      const y = height - ((v - min) / range) * height;
      return `${i === 0 ? "M" : "L"} ${x.toFixed(2)} ${y.toFixed(2)}`;
    })
    .join(" ");
  return (
    <svg width={width} height={height} aria-hidden>
      <path d={path} fill="none" stroke="currentColor" />
    </svg>
  );
}

// shared card primitives (mirrors main dashboard look)
function OverviewCard({
  title,
  value,
  href,
}: {
  title: string;
  value: React.ReactNode;
  href?: string;
}) {
  const content = (
    <div className="group relative overflow-hidden rounded-xl border border-white/10 bg-white/[0.04] px-4 py-4 shadow-card backdrop-blur-md transition hover:border-accent hover:shadow-glow">
      <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.12),transparent_60%)] opacity-0 transition-opacity group-hover:opacity-100" />
      <div className="relative">
        <p className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
          {title}
        </p>
        <div className="mt-2 text-2xl font-semibold text-white">{value}</div>
      </div>
    </div>
  );

  if (href) {
    return (
      <Link href={href} className="block">
        {content}
      </Link>
    );
  }
  return content;
}

function QuickButton({
  href,
  children,
  accent,
}: {
  href: string;
  children: React.ReactNode;
  accent?: boolean;
}) {
  return (
    <Link
      href={href}
      className={`inline-flex items-center gap-2 rounded-md border px-4 py-2 text-sm text-whitetypedefs shadow-sm backdrop-blur-md transition ${
        accent
          ? "border-orange-400/60 bg-white/[0.03] hover:bg-orange-500/10 hover:border-orange-400"
          : "border-neutral-700 bg-white/[0.02] hover:bg-neutral-800/80"
      }`}
    >
      {children}
    </Link>
  );
}

// ---------- Page ----------
export default function PartsDashboardPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [loading, setLoading] = useState(true);

  // KPIs
  const [skuTotal, setSkuTotal] = useState<number>(0);
  const [skuNewThis7d, setSkuNewThis7d] = useState<number>(0);

  const [moves7dCount, setMoves7dCount] = useState<number>(0);
  const [moves30Spark, setMoves30Spark] = useState<number[]>([]);

  const [openRequestsCount, setOpenRequestsCount] = useState<number | null>(
    null,
  );

  // Recent moves (list)
  const [recentMoves, setRecentMoves] = useState<
    Pick<
      StockMoveRow,
      "id" | "created_at" | "reason" | "qty_change" | "part_id"
    >[]
  >([]);

  useEffect(() => {
    (async () => {
      setLoading(true);

      const now = new Date();
      const d7Ago = new Date(now.getTime() - 7 * 24 * 3600 * 1000);
      const d30Ago = new Date(now.getTime() - 30 * 24 * 3600 * 1000);

      // -------- parts (for SKUs + 7d new) --------
      const { data: parts, error: perr } = await supabase
        .from("parts")
        .select("id, created_at");

      if (perr) {
        // eslint-disable-next-line no-console
        console.error("[parts] load failed:", perr);
      }
      const partsRows = (parts ?? []) as Pick<
        PartRow,
        "id" | "created_at"
      >[];

      setSkuTotal(partsRows.length);

      const createdInLast7 = partsRows.filter((p) => {
        const ts = p.created_at ? new Date(p.created_at) : null;
        return !!ts && ts >= d7Ago && ts < now;
      }).length;
      setSkuNewThis7d(createdInLast7);

      // -------- stock_moves (for 7d count + 30d sparkline + list) --------
      const { data: moves, error: merr } = await supabase
        .from("stock_moves")
        .select("id, part_id, qty_change, reason, created_at")
        .gte("created_at", d30Ago.toISOString())
        .order("created_at", { ascending: true });

      if (merr) {
        // eslint-disable-next-line no-console
        console.error("[stock_moves] load failed:", merr);
      }

      const mv = (moves ?? []) as Pick<
        StockMoveRow,
        "id" | "part_id" | "qty_change" | "reason" | "created_at"
      >[];

      // 7d moves count
      setMoves7dCount(
        mv.filter((m) => new Date(m.created_at) >= d7Ago).length,
      );

      // 30-day sparkline (daily net qty_change)
      const days = 30;
      const buckets = Array<number>(days).fill(0);
      for (const m of mv) {
        const dt = new Date(m.created_at);
        const idx = Math.min(
          days - 1,
          Math.max(
            0,
            Math.floor(
              (dt.getTime() - d30Ago.getTime()) / (24 * 3600 * 1000),
            ),
          ),
        );
        buckets[idx] += Number(m.qty_change ?? 0);
      }
      setMoves30Spark(buckets);

      // Recent list (latest 10, descending)
      const recent = [...mv]
        .sort(
          (a, b) =>
            new Date(b.created_at).getTime() -
            new Date(a.created_at).getTime(),
        )
        .slice(0, 10);
      setRecentMoves(recent);

      // -------- open parts requests count --------
      const {
        count: openCount,
        error: rerr,
      } = await supabase
        .from("part_requests")
        .select("id", { count: "exact", head: true })
        .in("status", ["requested", "quoted", "approved"] as RequestRow["status"][]);

      if (rerr) {
        // eslint-disable-next-line no-console
        console.error("[part_requests] count failed:", rerr);
        setOpenRequestsCount(0);
      } else {
        setOpenRequestsCount(openCount ?? 0);
      }

      setLoading(false);
    })();
  }, [supabase]);

  const skuTotalDisplay = loading ? "…" : skuTotal.toLocaleString();
  const newSkuDisplay = loading ? "…" : String(skuNewThis7d);
  const moves7dDisplay = loading ? "…" : moves7dCount.toLocaleString();
  const openReqDisplay =
    openRequestsCount === null || loading
      ? "…"
      : openRequestsCount.toLocaleString();

  return (
    <div className="relative space-y-8 p-6 text-white fade-in">
      {/* soft gradient background for this page */}
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(249,115,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.9),#020617_70%)]"
      />

      {/* welcome panel */}
      <section className="flex items-center justify-between gap-4 rounded-xl border border-white/10 bg-white/[0.03] px-5 py-4 shadow-card backdrop-blur-md">
        <div>
          <h1 className="text-2xl font-semibold text-white">
            Parts dashboard
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            Overview of your catalog, movement, and open requests.
          </p>
        </div>
      </section>

      {/* overview cards */}
      <section className="grid gap-4 md:grid-cols-4">
        <OverviewCard
          title="SKUs in catalog"
          value={skuTotalDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="New SKUs (7 days)"
          value={newSkuDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="Stock moves (7 days)"
          value={moves7dDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="Open parts requests"
          value={openReqDisplay}
          href="/parts/requests"
        />
      </section>

      {/* quick actions */}
      <section className="space-y-3">
        <h2 className="text-sm font-medium text-neutral-300">Quick actions</h2>
        <div className="flex flex-wrap gap-3">
          <QuickButton href="/parts/po" accent>
            Create PO
          </QuickButton>
          <QuickButton href="/parts/inventory">Inventory</QuickButton>
          <QuickButton href="/parts/receive">Scan to receive</QuickButton>
          <QuickButton href="/parts/requests">Requests</QuickButton>
          <QuickButton href="/parts/vendors">Vendors</QuickButton>
        </div>
      </section>

      {/* recent moves */}
      <section className="rounded-xl border border-white/10 bg-white/[0.03] px-5 py-4 shadow-card backdrop-blur-md">
        <div className="mb-2 flex items-center justify-between gap-4">
          <div>
            <h2 className="text-lg font-semibold">Recent stock moves</h2>
            <p className="text-xs text-neutral-400">
              Last 30 days of inventory activity.
            </p>
          </div>
          <Sparkline points={moves30Spark} />
        </div>

        {loading ? (
          <div className="text-sm text-neutral-400">Loading…</div>
        ) : recentMoves.length === 0 ? (
          <div className="text-sm text-neutral-400">No recent moves</div>
        ) : (
          <ul className="divide-y divide-neutral-800 text-sm">
            {recentMoves.map((m) => (
              <li
                key={m.id}
                className="flex items-center justify-between py-2"
              >
                <div className="min-w-0">
                  <div className="font-medium">
                    {String(m.reason ?? "move").replaceAll("_", " ")}
                  </div>
                  <div className="text-xs text-neutral-500">
                    {new Date(m.created_at as string).toLocaleString()}
                  </div>
                </div>
                <div className="pl-3 font-semibold">
                  {Number(m.qty_change ?? 0) >= 0 ? "+" : ""}
                  {Number(m.qty_change ?? 0)}
                </div>
              </li>
            ))}
          </ul>
        )}
      </section>
    </div>
  );
}

==================== FILE: app/parts/po/[id]/page.tsx ====================

// app/parts/po/[id]/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type PurchaseOrderRow = DB["public"]["Tables"]["purchase_orders"]["Row"];
type PurchaseOrderUpdate = DB["public"]["Tables"]["purchase_orders"]["Update"];

type SupplierRow = DB["public"]["Tables"]["suppliers"]["Row"];
type SupplierInsert = DB["public"]["Tables"]["suppliers"]["Insert"];

type PartRow = DB["public"]["Tables"]["parts"]["Row"];

type POLineRow = DB["public"]["Tables"]["purchase_order_lines"]["Row"];
type POLineInsert = DB["public"]["Tables"]["purchase_order_lines"]["Insert"];

type Status = PurchaseOrderRow["status"];

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

function fmtDate(v: string | null | undefined): string {
  if (!v) return "—";
  const d = new Date(v);
  return Number.isNaN(d.getTime()) ? "—" : d.toLocaleString();
}

function normalizeName(s: string): string {
  return s.trim().replace(/\s+/g, " ");
}

function statusPill(status: string | null | undefined): string {
  const s = (status ?? "").toLowerCase();
  if (s === "received") return "border-emerald-500/40 bg-emerald-500/10 text-emerald-200";
  if (s === "receiving") return "border-sky-500/40 bg-sky-500/10 text-sky-200";
  if (s === "ordered") return "border-indigo-500/40 bg-indigo-500/10 text-indigo-200";
  if (s === "open" || s === "draft") return "border-[#8b5a2b]/50 bg-[#8b5a2b]/10 text-[#f1c08a]";
  if (s === "cancelled" || s === "canceled") return "border-rose-500/40 bg-rose-500/10 text-rose-200";
  return "border-white/10 bg-white/5 text-neutral-200";
}

type UiLine = POLineRow & {
  ui_part_name: string;
  ui_sku: string;
  ui_ordered: number;
  ui_received: number;
  ui_unit_cost: number;
};

export default function PurchaseOrderDetailPage(): JSX.Element {
  const { id: poId } = useParams<{ id: string }>();
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState<boolean>(true);

  const [po, setPo] = useState<PurchaseOrderRow | null>(null);
  const [suppliers, setSuppliers] = useState<SupplierRow[]>([]);
  const [parts, setParts] = useState<PartRow[]>([]);
  const [lines, setLines] = useState<UiLine[]>([]);

  const [busySaveHeader, setBusySaveHeader] = useState<boolean>(false);
  const [busyAddLine, setBusyAddLine] = useState<boolean>(false);

  // Header edit state
  const [supplierId, setSupplierId] = useState<string>("");
  const [notes, setNotes] = useState<string>("");
  const [status, setStatus] = useState<string>("open");

  // Inline supplier create
  const [newSupplierName, setNewSupplierName] = useState<string>("");
  const [creatingSupplier, setCreatingSupplier] = useState<boolean>(false);

  // Add line form (generic stock PO)
  const [linePartId, setLinePartId] = useState<string>("");
  const [lineOrderedQty, setLineOrderedQty] = useState<number>(1);
  const [lineUnitCost, setLineUnitCost] = useState<number>(0);

  const supplierNameById = useMemo(() => {
    const m = new Map<string, string>();
    for (const s of suppliers) {
      const id = String(s.id);
      const nm = typeof s.name === "string" && s.name.trim() ? s.name.trim() : id.slice(0, 8);
      m.set(id, nm);
    }
    return m;
  }, [suppliers]);

  const partById = useMemo(() => {
    const m = new Map<string, PartRow>();
    for (const p of parts) m.set(String(p.id), p);
    return m;
  }, [parts]);

  const totals = useMemo(() => {
    const ordered = lines.reduce((acc, l) => acc + n(l.ui_ordered), 0);
    const received = lines.reduce((acc, l) => acc + n(l.ui_received), 0);
    const remaining = Math.max(0, ordered - received);

    const cost = lines.reduce((acc, l) => acc + n(l.ui_ordered) * n(l.ui_unit_cost), 0);

    return { ordered, received, remaining, cost };
  }, [lines]);

  function uiMapLine(row: POLineRow): UiLine {
    const raw = row as unknown as {
      ordered_qty?: unknown;
      qty_ordered?: unknown;
      qty?: unknown;
      received_qty?: unknown;
      qty_received?: unknown;
      unit_cost?: unknown;
      cost?: unknown;
    };

    const partId = String((row as unknown as { part_id?: unknown }).part_id ?? "");
    const p = partId ? partById.get(partId) ?? null : null;

    const ordered =
      raw.ordered_qty != null
        ? n(raw.ordered_qty)
        : raw.qty_ordered != null
          ? n(raw.qty_ordered)
          : raw.qty != null
            ? n(raw.qty)
            : 0;

    const received =
      raw.received_qty != null ? n(raw.received_qty) : raw.qty_received != null ? n(raw.qty_received) : 0;

    const unitCost = raw.unit_cost != null ? n(raw.unit_cost) : raw.cost != null ? n(raw.cost) : 0;

    return {
      ...row,
      ui_part_name: p?.name ? String(p.name) : partId ? partId.slice(0, 8) : "—",
      ui_sku: p?.sku ? String(p.sku) : "",
      ui_ordered: ordered,
      ui_received: received,
      ui_unit_cost: unitCost,
    };
  }

  async function load(): Promise<void> {
    if (!poId) return;

    setLoading(true);

    const { data: poRow, error: poErr } = await supabase.from("purchase_orders").select("*").eq("id", poId).maybeSingle();

    if (poErr) {
      toast.error(poErr.message);
      setPo(null);
      setLines([]);
      setLoading(false);
      return;
    }

    if (!poRow) {
      setPo(null);
      setLines([]);
      setLoading(false);
      return;
    }

    setPo(poRow as PurchaseOrderRow);

    const shopId = (poRow as unknown as { shop_id?: unknown }).shop_id as string | null;
    if (!shopId) {
      setSuppliers([]);
      setParts([]);
      setLines([]);
      setLoading(false);
      return;
    }

    const [supRes, partsRes, linesRes] = await Promise.all([
      supabase.from("suppliers").select("*").eq("shop_id", shopId).order("name", { ascending: true }).limit(1000),
      supabase.from("parts").select("*").eq("shop_id", shopId).order("name", { ascending: true }).limit(2000),
      supabase.from("purchase_order_lines").select("*").eq("po_id", poId).order("created_at", { ascending: true }),
    ]);

    if (supRes.error) toast.error(supRes.error.message);
    if (partsRes.error) toast.error(partsRes.error.message);
    if (linesRes.error) toast.error(linesRes.error.message);

    const supList = (supRes.data ?? []) as SupplierRow[];
    const partList = (partsRes.data ?? []) as PartRow[];
    const lineList = (linesRes.data ?? []) as POLineRow[];

    setSuppliers(supList);
    setParts(partList);

    // initialize header edit state
    const sid = ((poRow as unknown as { supplier_id?: unknown }).supplier_id as string | null) ?? "";
    setSupplierId(sid);
    setNotes(((poRow as unknown as { notes?: unknown }).notes as string | null) ?? "");
    setStatus(String(((poRow as unknown as { status?: unknown }).status as string | null) ?? "open"));

    // map lines after parts loaded
    const partMap = new Map<string, PartRow>();
    for (const p of partList) partMap.set(String(p.id), p);
    const mapped = lineList.map((r) => {
      const raw = r as unknown as { part_id?: unknown };
      const pid = String(raw.part_id ?? "");
      const p = pid ? partMap.get(pid) ?? null : null;

      const rr = r as unknown as {
        ordered_qty?: unknown;
        qty_ordered?: unknown;
        qty?: unknown;
        received_qty?: unknown;
        qty_received?: unknown;
        unit_cost?: unknown;
        cost?: unknown;
      };

      const ordered =
        rr.ordered_qty != null
          ? n(rr.ordered_qty)
          : rr.qty_ordered != null
            ? n(rr.qty_ordered)
            : rr.qty != null
              ? n(rr.qty)
              : 0;

      const received = rr.received_qty != null ? n(rr.received_qty) : rr.qty_received != null ? n(rr.qty_received) : 0;
      const unitCost = rr.unit_cost != null ? n(rr.unit_cost) : rr.cost != null ? n(rr.cost) : 0;

      return {
        ...r,
        ui_part_name: p?.name ? String(p.name) : pid ? pid.slice(0, 8) : "—",
        ui_sku: p?.sku ? String(p.sku) : "",
        ui_ordered: ordered,
        ui_received: received,
        ui_unit_cost: unitCost,
      } as UiLine;
    });

    setLines(mapped);

    setLoading(false);
  }

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [poId]);

  async function createSupplierInline(): Promise<void> {
    if (!po) return;
    const shopId = (po.shop_id as string | null) ?? null;
    if (!shopId) return;

    const nm = normalizeName(newSupplierName);
    if (!nm) {
      toast.error("Enter a supplier name.");
      return;
    }

    if (creatingSupplier) return;
    setCreatingSupplier(true);

    try {
      const insert: SupplierInsert = {
        shop_id: shopId,
        name: nm,
      } as SupplierInsert;

      const { data, error } = await supabase.from("suppliers").insert(insert).select("*").single();

      if (error) {
        toast.error(error.message);
        return;
      }

      const created = data as SupplierRow;
      setSuppliers((prev) => {
        const next = [...prev, created];
        next.sort((a, b) => String(a.name ?? "").localeCompare(String(b.name ?? "")));
        return next;
      });

      setSupplierId(String(created.id));
      setNewSupplierName("");
      toast.success("Supplier created.");
    } finally {
      setCreatingSupplier(false);
    }
  }

  async function saveHeader(): Promise<void> {
    if (!po) return;
    if (busySaveHeader) return;

    const sid = supplierId.trim();
    if (!sid) {
      toast.error("Select a supplier (or create one).");
      return;
    }

    setBusySaveHeader(true);
    try {
      const patch: PurchaseOrderUpdate = {
        supplier_id: sid,
        status: status as Status,
        notes: notes.trim() ? notes.trim() : null,
      } as PurchaseOrderUpdate;

      const { error } = await supabase.from("purchase_orders").update(patch).eq("id", po.id);

      if (error) {
        toast.error(error.message);
        return;
      }

      toast.success("PO updated.");
      await load();
    } finally {
      setBusySaveHeader(false);
    }
  }

  async function addLine(): Promise<void> {
    if (!po) return;
    if (busyAddLine) return;

    const pid = linePartId.trim();
    if (!pid) {
      toast.error("Select a part.");
      return;
    }
    const qty = Math.max(0, Math.floor(n(lineOrderedQty)));
    if (!qty || qty <= 0) {
      toast.error("Enter a quantity > 0.");
      return;
    }

    setBusyAddLine(true);
    try {
      // NOTE: your schema might name these columns differently.
      // We use the strongly-typed Insert shape, then fill common fields.
      // If your generated types don't include ordered_qty/unit_cost, rename them to match your schema.
      const insert = {
        po_id: po.id,
        part_id: pid,
        ordered_qty: qty,
        unit_cost: n(lineUnitCost),
      } as unknown as POLineInsert;

      const { data, error } = await supabase.from("purchase_order_lines").insert(insert).select("*").single();

      if (error) {
        toast.error(error.message);
        return;
      }

      const created = data as POLineRow;

      // Add optimistically to UI
      const mapped = uiMapLine(created);
      setLines((prev) => [...prev, mapped]);

      setLinePartId("");
      setLineOrderedQty(1);
      setLineUnitCost(0);

      toast.success("Line added.");
    } finally {
      setBusyAddLine(false);
    }
  }

  async function deleteLine(lineId: string): Promise<void> {
    const ok = window.confirm("Remove this PO line?");
    if (!ok) return;

    const { data, error } = await supabase.from("purchase_order_lines").delete().eq("id", lineId).select("id").maybeSingle();

    if (error) {
      toast.error(error.message);
      return;
    }
    if (!data?.id) {
      toast.error("Not permitted to delete this line (RLS).");
      return;
    }

    setLines((prev) => prev.filter((x) => String(x.id) !== String(lineId)));
    toast.success("Line removed.");
  }

  const panel =
    "rounded-2xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset]";
  const header =
    "border-b border-white/10 bg-gradient-to-b from-white/5 to-transparent px-5 py-4";
  const input =
    "w-full rounded-xl border border-white/10 bg-neutral-950/40 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35";
  const select =
    "w-full rounded-xl border border-white/10 bg-neutral-950/40 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35";

  const btnBase =
    "inline-flex items-center justify-center rounded-xl border px-4 py-2 text-sm font-semibold transition disabled:opacity-60";
  const btnGhost = `${btnBase} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
  const btnCopper = `${btnBase} border-[#8b5a2b]/60 text-[#c88a4d] bg-neutral-950/20 hover:bg-[#8b5a2b]/10`;
  const btnDanger = `${btnBase} border-red-900/60 bg-neutral-950/20 text-red-200 hover:bg-red-900/20`;

  if (loading) {
    return (
      <div className="p-6 text-white">
        <div className={`${panel} p-4 text-neutral-300`}>Loading…</div>
      </div>
    );
  }

  if (!po) {
    return (
      <div className="p-6 text-white">
        <button className={btnGhost} onClick={() => router.back()} type="button">
          ← Back
        </button>
        <div className={`${panel} mt-4 p-4 text-neutral-300`}>PO not found / not visible.</div>
      </div>
    );
  }

  const poSupplierId = supplierId || ((po.supplier_id as string | null) ?? "");
  const supplierName = poSupplierId ? supplierNameById.get(poSupplierId) ?? poSupplierId.slice(0, 8) : "—";
  const poStatus = (status || (po.status as string | null) || "open").toLowerCase();

  return (
    <div className="space-y-4 p-6 text-white">
      <div className="flex flex-wrap items-center justify-between gap-2">
        <div className="flex items-center gap-2">
          <button className={btnGhost} onClick={() => router.back()} type="button">
            ← Back
          </button>

          <Link className={btnGhost} href={`/parts/po/${String(po.id)}/receive`}>
            Receive
          </Link>
        </div>

        <button className={btnCopper} onClick={() => void saveHeader()} disabled={busySaveHeader} type="button">
          {busySaveHeader ? "Saving…" : "Save PO"}
        </button>
      </div>

      <div className={panel}>
        <div className={header}>
          <div className="flex flex-wrap items-start justify-between gap-3">
            <div className="min-w-0">
              <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">Purchase Order</div>
              <div className="mt-1 truncate text-2xl font-semibold text-white">
                PO <span className="text-[#c88a4d]">{String(po.id).slice(0, 8)}</span>
              </div>
              <div className="mt-2 text-sm text-neutral-400">
                Supplier: <span className="text-neutral-200">{supplierName}</span>
                <span className="mx-2 text-neutral-600">·</span>
                Status:{" "}
                <span className={["inline-flex items-center rounded-full border px-2.5 py-1 text-[12px] font-medium", statusPill(poStatus)].join(" ")}>
                  {poStatus}
                </span>
                <span className="mx-2 text-neutral-600">·</span>
                Created: <span className="text-neutral-200">{fmtDate(po.created_at as string | null)}</span>
              </div>
            </div>

            <div className="grid w-full max-w-md gap-2">
              <div>
                <div className="mb-1 text-xs text-neutral-400">Supplier</div>
                <select className={select} value={supplierId} onChange={(e) => setSupplierId(e.target.value)}>
                  <option value="">— select —</option>
                  {suppliers.map((s) => (
                    <option key={String(s.id)} value={String(s.id)}>
                      {String(s.name ?? String(s.id).slice(0, 8))}
                    </option>
                  ))}
                </select>

                <div className="mt-2 flex flex-wrap items-center gap-2">
                  <input
                    className={`${input} flex-1`}
                    value={newSupplierName}
                    onChange={(e) => setNewSupplierName(e.target.value)}
                    placeholder="New supplier name…"
                  />
                  <button
                    className={btnGhost}
                    onClick={() => void createSupplierInline()}
                    disabled={creatingSupplier || !newSupplierName.trim()}
                    type="button"
                  >
                    {creatingSupplier ? "Creating…" : "Add supplier"}
                  </button>
                </div>
              </div>

              <div className="grid gap-2 md:grid-cols-2">
                <div>
                  <div className="mb-1 text-xs text-neutral-400">Status</div>
                  <select className={select} value={status} onChange={(e) => setStatus(e.target.value)}>
                    <option value="open">open</option>
                    <option value="ordered">ordered</option>
                    <option value="receiving">receiving</option>
                    <option value="received">received</option>
                    <option value="cancelled">cancelled</option>
                  </select>
                </div>

                <div>
                  <div className="mb-1 text-xs text-neutral-400">Notes</div>
                  <input className={input} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Vendor instructions / notes…" />
                </div>
              </div>
            </div>
          </div>

          <div className="mt-4 grid gap-3 md:grid-cols-4">
            <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
              <div className="text-xs text-neutral-400">Total Ordered</div>
              <div className="mt-1 text-2xl font-semibold">{totals.ordered}</div>
            </div>
            <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
              <div className="text-xs text-neutral-400">Total Received</div>
              <div className="mt-1 text-2xl font-semibold">{totals.received}</div>
            </div>
            <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
              <div className="text-xs text-neutral-400">Remaining</div>
              <div className="mt-1 text-2xl font-semibold text-[#c88a4d]">{totals.remaining}</div>
            </div>
            <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
              <div className="text-xs text-neutral-400">Est. Cost</div>
              <div className="mt-1 text-2xl font-semibold">{totals.cost.toFixed(2)}</div>
            </div>
          </div>
        </div>

        <div className="p-5 space-y-4">
          <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
            <div className="mb-3 flex flex-wrap items-center justify-between gap-2">
              <div>
                <div className="text-sm font-semibold text-white">Add PO line (stock order)</div>
                <div className="mt-1 text-xs text-neutral-500">
                  Track what the PO is for: part, ordered qty, unit cost. Receiving updates received qty on lines.
                </div>
              </div>

              <button className={btnCopper} onClick={() => void addLine()} disabled={busyAddLine} type="button">
                {busyAddLine ? "Adding…" : "Add line"}
              </button>
            </div>

            <div className="grid gap-3 md:grid-cols-4">
              <div className="md:col-span-2">
                <div className="mb-1 text-xs text-neutral-400">Part</div>
                <select
                  className={select}
                  value={linePartId}
                  onChange={(e) => {
                    const next = e.target.value;
                    setLinePartId(next);
                    const p = next ? partById.get(String(next)) ?? null : null;
                    if (p?.cost != null) setLineUnitCost(n(p.cost));
                  }}
                >
                  <option value="">— select —</option>
                  {parts.map((p) => (
                    <option key={String(p.id)} value={String(p.id)}>
                      {p.sku ? `${String(p.sku)} — ${String(p.name)}` : String(p.name ?? String(p.id).slice(0, 8))}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <div className="mb-1 text-xs text-neutral-400">Qty ordered</div>
                <input
                  className={input}
                  type="number"
                  min={1}
                  step={1}
                  value={String(lineOrderedQty)}
                  onChange={(e) => setLineOrderedQty(Math.max(1, Math.floor(n(e.target.value))))}
                />
              </div>

              <div>
                <div className="mb-1 text-xs text-neutral-400">Unit cost</div>
                <input
                  className={input}
                  type="number"
                  min={0}
                  step={0.01}
                  value={String(lineUnitCost)}
                  onChange={(e) => setLineUnitCost(Math.max(0, n(e.target.value)))}
                />
              </div>

              {linePartId ? (
                <div className="md:col-span-4 text-[11px] text-neutral-500">
                  Part #: <span className="text-neutral-200">{String(partById.get(linePartId)?.sku ?? "—")}</span>
                  <span className="mx-2 text-neutral-600">·</span>
                  Name:{" "}
                  <span className="text-neutral-200">{String(partById.get(linePartId)?.name ?? "—")}</span>
                </div>
              ) : null}
            </div>
          </div>

          <div className="overflow-hidden rounded-2xl border border-white/10 bg-neutral-950/20">
            <div className="flex items-center justify-between border-b border-white/10 bg-white/5 px-4 py-3">
              <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">PO Lines</div>
              <div className="text-[11px] text-neutral-500">{lines.length} lines</div>
            </div>

            <div className="overflow-auto">
              <table className="w-full min-w-[980px] text-sm">
                <thead className="text-left text-neutral-400">
                  <tr>
                    <th className="p-3">Part #</th>
                    <th className="p-3">Part</th>
                    <th className="p-3 text-right">Ordered</th>
                    <th className="p-3 text-right">Received</th>
                    <th className="p-3 text-right">Remaining</th>
                    <th className="p-3 text-right">Unit cost</th>
                    <th className="p-3 text-right">Line cost</th>
                    <th className="p-3 text-right">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  {lines.length === 0 ? (
                    <tr className="border-t border-white/10">
                      <td className="p-4 text-neutral-500" colSpan={8}>
                        No PO lines yet. Add a line above.
                      </td>
                    </tr>
                  ) : (
                    lines.map((l) => {
                      const ordered = n(l.ui_ordered);
                      const received = n(l.ui_received);
                      const remaining = Math.max(0, ordered - received);
                      const unitCost = n(l.ui_unit_cost);
                      const lineCost = ordered * unitCost;

                      return (
                        <tr key={String(l.id)} className="border-t border-white/10 hover:bg-white/5">
                          <td className="p-3 font-mono text-neutral-200">{l.ui_sku || "—"}</td>
                          <td className="p-3 text-neutral-200">{l.ui_part_name}</td>
                          <td className="p-3 text-right tabular-nums text-neutral-200">{ordered}</td>
                          <td className="p-3 text-right tabular-nums text-neutral-200">{received}</td>
                          <td className="p-3 text-right tabular-nums text-[#c88a4d]">{remaining}</td>
                          <td className="p-3 text-right tabular-nums text-neutral-200">{unitCost.toFixed(2)}</td>
                          <td className="p-3 text-right tabular-nums text-neutral-200">{lineCost.toFixed(2)}</td>
                          <td className="p-3 text-right">
                            <button className={btnDanger} onClick={() => void deleteLine(String(l.id))} type="button">
                              Delete
                            </button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>

            <div className="border-t border-white/10 px-4 py-3 text-[11px] text-neutral-500">
              Receiving is done on the <span className="text-neutral-200">Receive PO</span> page and should increment the line’s received qty.
              If your line columns are named differently, we’ll rename the insert + UI mapping to match your schema.
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

==================== FILE: app/parts/po/[id]/receive/page.tsx ====================

//app/parts/po/[id]/receive/page.tsx

"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import Link from "next/link";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { resolveScannedCode } from "@/features/parts/server/scanActions";

type QuaggaResult = { codeResult?: { code?: string | null } | null };

type QuaggaConfig = {
  inputStream: {
    name: string;
    type: "LiveStream";
    target: HTMLElement;
    constraints?: { facingMode?: string };
  };
  decoder: { readers: string[] };
  locate?: boolean;
};

type QuaggaDetectedHandler = (res: QuaggaResult) => void;

type QuaggaLike = {
  init: (cfg: QuaggaConfig, cb: (err?: Error) => void) => void;
  start: () => void;
  stop: () => void;
  onDetected: (handler: QuaggaDetectedHandler) => void;
  offDetected?: (handler: QuaggaDetectedHandler) => void;
};

let Quagga: QuaggaLike | null = null;

if (typeof window !== "undefined") {
  void import("@ericblade/quagga2").then((m) => {
    Quagga = (m.default as unknown) as QuaggaLike;
  });
}

type DB = Database;
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type PurchaseOrderLine = DB["public"]["Tables"]["purchase_order_lines"]["Row"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type SupplierRow = DB["public"]["Tables"]["suppliers"]["Row"];

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

async function resolveShopId(
  supabase: ReturnType<typeof createClientComponentClient<DB>>,
): Promise<string> {
  const { data: userRes } = await supabase.auth.getUser();
  const uid = userRes.user?.id ?? null;
  if (!uid) return "";

  // Option A
  const { data: profA } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("user_id", uid)
    .maybeSingle();
  if (profA?.shop_id) return String(profA.shop_id);

  // Option B
  const { data: profB } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("id", uid)
    .maybeSingle();
  return String(profB?.shop_id ?? "");
}

type AllocationResult = {
  request_item_id?: string;
  qty_allocated?: number;
  status?: string;
};

type ReceiveResult = {
  move_id?: string;
  po_status?: string;
  allocations?: AllocationResult[];
  unallocated_qty?: number;
};

function extractReceiveResult(data: unknown): ReceiveResult | null {
  if (!data) return null;
  if (typeof data === "object") return data as ReceiveResult;
  if (typeof data === "string") {
    try {
      const parsed = JSON.parse(data) as ReceiveResult;
      return parsed;
    } catch {
      return null;
    }
  }
  return null;
}

export default function PoReceivePage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const params = useParams<{ id: string }>();
  const router = useRouter();

  const poId = String(params?.id ?? "");

  const [shopId, setShopId] = useState<string>("");

  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [po, setPo] = useState<PurchaseOrder | null>(null);
  const [supplier, setSupplier] = useState<SupplierRow | null>(null);
  const [lines, setLines] = useState<PurchaseOrderLine[]>([]);
  const [locs, setLocs] = useState<StockLoc[]>([]);
  const [parts, setParts] = useState<PartRow[]>([]);

  const [selectedLoc, setSelectedLoc] = useState<string>("");
  const [qty, setQty] = useState<number>(1);

  const [manualPartId, setManualPartId] = useState<string>("");
  const [manualSearch, setManualSearch] = useState<string>("");

  // scanner
  const videoRef = useRef<HTMLDivElement | null>(null);
  const [scanning, setScanning] = useState<boolean>(false);
  const [lastScan, setLastScan] = useState<string>("");
  const onDetectedRef = useRef<QuaggaDetectedHandler | null>(null);

  // last receive output
  const [result, setResult] = useState<ReceiveResult | null>(null);

  useEffect(() => {
    if (!poId) return;

    void (async () => {
      setLoading(true);
      setErr(null);
      setResult(null);

      try {
        const sid = await resolveShopId(supabase);
        setShopId(sid);

        // Load PO + lines + locations
        const [poRes, lineRes, locRes] = await Promise.all([
          supabase.from("purchase_orders").select("*").eq("id", poId).maybeSingle(),
          supabase
            .from("purchase_order_lines")
            .select("*")
            .eq("po_id", poId)
            .order("created_at", { ascending: true }),
          sid
            ? supabase
                .from("stock_locations")
                .select("*")
                .eq("shop_id", sid)
                .order("code")
            : Promise.resolve({ data: [], error: null }),
        ]);

        if (poRes.error) throw poRes.error;
        if (lineRes.error) throw lineRes.error;
        if (locRes.error) throw locRes.error;

        const poRow = (poRes.data as PurchaseOrder | null) ?? null;
        setPo(poRow);
        setLines((lineRes.data ?? []) as PurchaseOrderLine[]);
        const locRows = (locRes.data ?? []) as StockLoc[];
        setLocs(locRows);

        const main = locRows.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
        if (main) setSelectedLoc(String(main.id));
        else if (locRows[0]?.id) setSelectedLoc(String(locRows[0].id));

        // Supplier (optional)
        const supId = poRow?.supplier_id ? String(poRow.supplier_id) : "";
        if (supId) {
          const { data: supRow, error: supErr } = await supabase
            .from("suppliers")
            .select("*")
            .eq("id", supId)
            .maybeSingle();
          if (!supErr) setSupplier((supRow as SupplierRow | null) ?? null);
        } else {
          setSupplier(null);
        }

        // Load parts list for manual mode (keep it light)
        if (sid) {
          const { data: partRows, error: partErr } = await supabase
            .from("parts")
            .select("id, name, sku, category")
            .eq("shop_id", sid)
            .order("name", { ascending: true })
            .limit(700);

          if (partErr) throw partErr;
          setParts((partRows ?? []) as PartRow[]);
        } else {
          setParts([]);
        }
      } catch (e: unknown) {
        setErr(e instanceof Error ? e.message : "Failed to load PO receive page");
      } finally {
        setLoading(false);
      }
    })();
  }, [poId, supabase]);

  const cleanupScannerHandlers = () => {
    try {
      if (Quagga && onDetectedRef.current && typeof Quagga.offDetected === "function") {
        Quagga.offDetected(onDetectedRef.current);
      }
    } catch {
      // ignore
    }
    onDetectedRef.current = null;
  };

  const stopScan = () => {
    try {
      cleanupScannerHandlers();
      Quagga?.stop();
    } catch {
      /* ignore */
    }
    setScanning(false);
  };

  useEffect(() => {
    return () => stopScan();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const doReceive = async (partId: string, receiveQty: number) => {
    setErr(null);
    setResult(null);

    if (!partId) {
      setErr("Select a part first.");
      return;
    }
    if (!selectedLoc) {
      setErr("Select a location first.");
      return;
    }
    if (!receiveQty || receiveQty <= 0) {
      setErr("Quantity must be greater than 0.");
      return;
    }

    const args = {
      p_po_id: poId,
      p_part_id: partId,
      p_location_id: selectedLoc,
      p_qty: receiveQty,
    };

    const { data, error } = await supabase.rpc(
      "receive_po_part_and_allocate",
      args as unknown as DB["public"]["Functions"]["receive_po_part_and_allocate"]["Args"],
    );

    if (error) {
      setErr(error.message);
      return;
    }

    const parsed = extractReceiveResult(data);
    setResult(parsed ?? {});

    // Refresh PO + lines so UI is accurate after receive
    const [poRes, lineRes] = await Promise.all([
      supabase.from("purchase_orders").select("*").eq("id", poId).maybeSingle(),
      supabase
        .from("purchase_order_lines")
        .select("*")
        .eq("po_id", poId)
        .order("created_at", { ascending: true }),
    ]);

    if (!poRes.error) setPo((poRes.data as PurchaseOrder | null) ?? null);
    if (!lineRes.error) setLines((lineRes.data ?? []) as PurchaseOrderLine[]);

    window.dispatchEvent(new CustomEvent("parts:received"));
  };

  const startScan = async () => {
    if (!videoRef.current) return;
    if (scanning) return;

    // Quagga can be “not yet imported” for a split second
    if (!Quagga) {
      setErr("Scanner loading… try again in 1 second.");
      window.setTimeout(() => setErr(null), 900);
      return;
    }

    setErr(null);
    setResult(null);
    setScanning(true);

    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: videoRef.current,
          constraints: { facingMode: "environment" },
        },
        decoder: {
          readers: ["upc_reader", "upc_e_reader", "ean_reader", "ean_8_reader", "code_128_reader"],
        },
        locate: true,
      },
      (e?: Error) => {
        if (e) {
          // eslint-disable-next-line no-console
          console.error(e);
          setErr(e.message);
          setScanning(false);
          return;
        }
        Quagga?.start();
      },
    );

    cleanupScannerHandlers();

    const handler: QuaggaDetectedHandler = async (res) => {
      const code = res.codeResult?.code ?? "";
      if (!code || code === lastScan) return;

      setLastScan(code);

      const supplierId = po?.supplier_id ? String(po.supplier_id) : null;

      const { part_id } = await resolveScannedCode({
        code,
        supplier_id: supplierId,
      });

      if (!part_id) {
        setErr(`No part found for "${code}". Map it in Parts → Inventory → Edit → Barcodes.`);
        window.setTimeout(() => setLastScan(""), 900);
        return;
      }

      await doReceive(part_id, qty);

      window.setTimeout(() => setLastScan(""), 900);
    };

    onDetectedRef.current = handler;
    Quagga.onDetected(handler);
  };

  const poStatus = String(po?.status ?? "—");
  const supplierName = supplier?.name ?? (po?.supplier_id ? String(po.supplier_id).slice(0, 8) : "—");

  const totalOrdered = useMemo(() => lines.reduce((sum, l) => sum + n(l.qty), 0), [lines]);
  const totalReceived = useMemo(() => lines.reduce((sum, l) => sum + n(l.received_qty), 0), [lines]);
  const remaining = Math.max(0, totalOrdered - totalReceived);

  const filteredParts = useMemo(() => {
    const term = manualSearch.trim().toLowerCase();
    if (!term) return parts.slice(0, 180);
    return parts
      .filter((p) => {
        const name = String(p.name ?? "").toLowerCase();
        const sku = String(p.sku ?? "").toLowerCase();
        const cat = String(p.category ?? "").toLowerCase();
        return name.includes(term) || sku.includes(term) || cat.includes(term);
      })
      .slice(0, 180);
  }, [manualSearch, parts]);

  const locLabel = locs.find((l) => String(l.id) === selectedLoc)?.code ?? "LOC";

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">Purchase order</div>
          <h1 className="text-2xl font-bold">Receive PO</h1>
          <div className="mt-1 text-sm text-neutral-400">
            PO: <span className="font-mono text-neutral-200">{poId.slice(0, 8)}</span> • Status:{" "}
            <span className="text-neutral-200">{poStatus}</span> • Supplier:{" "}
            <span className="text-neutral-200">{supplierName}</span>
          </div>
        </div>

        <div className="flex flex-wrap items-center gap-2">
          <Link
            href="/parts/po"
            className="rounded-full border border-white/10 bg-black/50 px-4 py-2 text-sm text-neutral-100 hover:border-orange-500/60"
          >
            ← POs
          </Link>
          <button
            onClick={() => router.push("/parts/receive")}
            className="rounded-full border border-white/10 bg-black/50 px-4 py-2 text-sm text-neutral-100 hover:border-orange-500/60"
            type="button"
          >
            Generic Receive
          </button>
        </div>
      </div>

      {loading ? (
        <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-400">
          Loading…
        </div>
      ) : (
        <>
          {/* Summary */}
          <div className="rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)]">
            <div className="grid gap-3 md:grid-cols-4">
              <div className="rounded-xl border border-white/10 bg-black/50 p-3">
                <div className="text-xs text-neutral-400">Total Ordered</div>
                <div className="mt-1 text-lg font-semibold">{totalOrdered}</div>
              </div>
              <div className="rounded-xl border border-white/10 bg-black/50 p-3">
                <div className="text-xs text-neutral-400">Total Received</div>
                <div className="mt-1 text-lg font-semibold">{totalReceived}</div>
              </div>
              <div className="rounded-xl border border-white/10 bg-black/50 p-3">
                <div className="text-xs text-neutral-400">Remaining</div>
                <div className="mt-1 text-lg font-semibold text-orange-200">{remaining}</div>
              </div>
              <div className="rounded-xl border border-white/10 bg-black/50 p-3">
                <div className="text-xs text-neutral-400">Receiving Location</div>
                <div className="mt-1 text-lg font-semibold">{locLabel}</div>
              </div>
            </div>
          </div>

          {/* Controls */}
          <div className="grid gap-4 lg:grid-cols-2">
            {/* Left: Scan */}
            <div className="rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)] space-y-3">
              <div className="flex items-center justify-between gap-2">
                <div>
                  <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">Scan</div>
                  <div className="text-lg font-semibold">Scan to Receive</div>
                  <div className="text-xs text-neutral-500">
                    UPC / EAN / Code128 mapped to parts_barcodes / part_barcodes.
                  </div>
                </div>

                {!scanning ? (
                  <button
                    onClick={startScan}
                    className="rounded-full border border-orange-500/70 bg-orange-500/10 px-4 py-2 text-sm text-orange-200 hover:bg-orange-500/20"
                    type="button"
                  >
                    Start Scanner
                  </button>
                ) : (
                  <button
                    onClick={stopScan}
                    className="rounded-full border border-red-500/70 bg-red-500/10 px-4 py-2 text-sm text-red-200 hover:bg-red-500/20"
                    type="button"
                  >
                    Stop Scanner
                  </button>
                )}
              </div>

              <div className="grid gap-3 md:grid-cols-3">
                <div className="md:col-span-2">
                  <div className="text-xs text-neutral-400 mb-1">Location</div>
                  <select
                    className="w-full rounded-xl border border-white/10 bg-black/60 p-2 text-white"
                    value={selectedLoc}
                    onChange={(e) => setSelectedLoc(e.target.value)}
                  >
                    {locs.map((l) => (
                      <option key={String(l.id)} value={String(l.id)}>
                        {l.code ?? "LOC"} — {l.name ?? ""}
                      </option>
                    ))}
                  </select>
                </div>
                <div>
                  <div className="text-xs text-neutral-400 mb-1">Quantity</div>
                  <input
                    type="number"
                    min={0.01}
                    step="0.01"
                    className="w-full rounded-xl border border-white/10 bg-black/60 p-2 text-white"
                    value={qty}
                    onChange={(e) => setQty(Math.max(0, Number(e.target.value || 0)))}
                  />
                </div>
              </div>

              <div
                ref={videoRef}
                className="aspect-video w-full overflow-hidden rounded-xl border border-white/10 bg-black"
              />

              {lastScan ? (
                <div className="text-xs text-neutral-500">
                  Last scan: <span className="font-mono text-neutral-200">{lastScan}</span>
                </div>
              ) : null}
            </div>

            {/* Right: Manual receive */}
            <div className="rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)] space-y-3">
              <div>
                <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">Manual</div>
                <div className="text-lg font-semibold">Receive a Part</div>
                <div className="text-xs text-neutral-500">
                  Calls <span className="font-mono">receive_po_part_and_allocate</span> (stock move + PO receive + request
                  allocation).
                </div>
              </div>

              <div className="grid gap-3 md:grid-cols-3">
                <div className="md:col-span-2">
                  <div className="text-xs text-neutral-400 mb-1">Search parts</div>
                  <input
                    className="w-full rounded-xl border border-white/10 bg-black/60 px-3 py-2 text-sm text-white placeholder:text-neutral-500"
                    placeholder="Name, SKU, category…"
                    value={manualSearch}
                    onChange={(e) => setManualSearch(e.target.value)}
                  />
                </div>

                <div>
                  <div className="text-xs text-neutral-400 mb-1">Quantity</div>
                  <input
                    type="number"
                    min={0.01}
                    step="0.01"
                    className="w-full rounded-xl border border-white/10 bg-black/60 p-2 text-white"
                    value={qty}
                    onChange={(e) => setQty(Math.max(0, Number(e.target.value || 0)))}
                  />
                </div>
              </div>

              <div>
                <div className="text-xs text-neutral-400 mb-1">Part</div>
                <select
                  className="w-full rounded-xl border border-white/10 bg-black/60 p-2 text-white"
                  value={manualPartId}
                  onChange={(e) => setManualPartId(e.target.value)}
                >
                  <option value="">— select —</option>
                  {filteredParts.map((p) => (
                    <option key={String(p.id)} value={String(p.id)}>
                      {p.name ?? "Unnamed"} {p.sku ? `• ${p.sku}` : ""} {p.category ? `• ${p.category}` : ""}
                    </option>
                  ))}
                </select>
                <div className="mt-1 text-[11px] text-neutral-500">Showing up to {filteredParts.length} results.</div>
              </div>

              <div className="flex items-center justify-between gap-2">
                <div className="text-xs text-neutral-500">
                  Location: <span className="text-neutral-200">{locLabel}</span>
                </div>

                <button
                  onClick={() => void doReceive(manualPartId, qty)}
                  disabled={!manualPartId || !selectedLoc || qty <= 0}
                  className="rounded-full border border-orange-500/70 bg-orange-500/10 px-4 py-2 text-sm text-orange-200 hover:bg-orange-500/20 disabled:opacity-50"
                  type="button"
                >
                  Receive & Allocate →
                </button>
              </div>
            </div>
          </div>

          {/* PO lines */}
          <div className="rounded-2xl border border-white/10 bg-black/40 overflow-hidden backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)]">
            <div className="flex items-center justify-between border-b border-white/10 px-4 py-3">
              <div>
                <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">PO lines</div>
                <div className="text-sm text-neutral-300">{lines.length} lines</div>
              </div>
              <div className="text-xs text-neutral-500">
                FIFO receive updates <span className="font-mono">purchase_order_lines.received_qty</span>
              </div>
            </div>

            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-neutral-400 border-b border-white/10">
                  <th className="p-3">Part</th>
                  <th className="p-3">Ordered</th>
                  <th className="p-3">Received</th>
                  <th className="p-3">Remaining</th>
                </tr>
              </thead>
              <tbody>
                {lines.length === 0 ? (
                  <tr>
                    <td className="p-4 text-neutral-400" colSpan={4}>
                      No PO lines yet.
                    </td>
                  </tr>
                ) : (
                  lines.map((ln) => {
                    const ordered = n(ln.qty);
                    const received = n(ln.received_qty);
                    const rem = Math.max(0, ordered - received);

                    return (
                      <tr key={String(ln.id)} className="border-t border-white/5 hover:bg-white/5">
                        <td className="p-3">
                          <div className="font-mono text-xs text-neutral-300">
                            {ln.part_id ? String(ln.part_id).slice(0, 8) : "—"}
                          </div>
                          <div className="text-xs text-neutral-500">{ln.description ?? "—"}</div>
                        </td>
                        <td className="p-3 font-mono">{ordered}</td>
                        <td className="p-3 font-mono">{received}</td>
                        <td className="p-3 font-mono">
                          {rem > 0 ? (
                            <span className="text-orange-200">{rem}</span>
                          ) : (
                            <span className="text-neutral-500">0</span>
                          )}
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>

          {/* Errors */}
          {err ? (
            <div className="rounded-2xl border border-red-500/30 bg-red-500/10 p-4 text-sm text-red-200">{err}</div>
          ) : null}

          {/* Result */}
          {result ? (
            <div className="rounded-2xl border border-white/10 bg-black/40 p-4 backdrop-blur-xl shadow-[0_18px_40px_rgba(0,0,0,0.9)] space-y-3">
              <div className="flex flex-wrap items-center justify-between gap-2">
                <div>
                  <div className="text-xs uppercase tracking-[0.22em] text-neutral-400">Receive result</div>
                  <div className="text-sm text-neutral-200">
                    Move:{" "}
                    <span className="font-mono">{result.move_id ? String(result.move_id).slice(0, 8) : "—"}</span> • PO
                    status: <span className="text-neutral-200">{result.po_status ?? poStatus}</span>
                  </div>
                </div>

                <div className="text-xs text-neutral-400">
                  Unallocated remainder: <span className="text-neutral-200">{n(result.unallocated_qty)}</span>
                </div>
              </div>

              <div className="rounded-xl border border-white/10 bg-black/50 p-3">
                <div className="text-xs text-neutral-400 mb-2">Allocations applied to request items (FIFO)</div>

                {Array.isArray(result.allocations) && result.allocations.length > 0 ? (
                  <div className="overflow-hidden rounded-lg border border-white/10">
                    <table className="w-full text-sm">
                      <thead className="bg-white/5 text-left text-neutral-400">
                        <tr>
                          <th className="p-2">Request item</th>
                          <th className="p-2">Qty allocated</th>
                          <th className="p-2">Status</th>
                        </tr>
                      </thead>
                      <tbody>
                        {result.allocations.map((a, idx) => (
                          <tr key={`${a.request_item_id ?? "x"}-${idx}`} className="border-t border-white/10">
                            <td className="p-2 font-mono text-xs text-neutral-200">
                              {a.request_item_id ? String(a.request_item_id).slice(0, 8) : "—"}
                            </td>
                            <td className="p-2 font-mono text-neutral-200">{n(a.qty_allocated)}</td>
                            <td className="p-2 text-neutral-300">{a.status ?? "—"}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="text-sm text-neutral-400">No request items were allocated from this receive.</div>
                )}
              </div>

              <div className="text-[11px] text-neutral-500">
                Next layer after this: “Receive from PO and automatically apply received qty to matching request items
                (batch allocation)”.
              </div>
            </div>
          ) : null}

          {/* Footer note */}
          {!shopId ? (
            <div className="text-xs text-neutral-500">
              No shop detected for this user. If you’re logged in as a different role, check profiles.shop_id.
            </div>
          ) : null}
        </>
      )}
    </div>
  );
}

==================== FILE: app/parts/po/page.tsx ====================

// app/parts/po/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { v4 as uuidv4 } from "uuid";

type DB = Database;

type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type PurchaseOrderInsert = DB["public"]["Tables"]["purchase_orders"]["Insert"];
type Supplier = DB["public"]["Tables"]["suppliers"]["Row"];
type SupplierInsert = DB["public"]["Tables"]["suppliers"]["Insert"];
type PurchaseOrderLineInsert = DB["public"]["Tables"]["purchase_order_lines"]["Insert"];
type Part = DB["public"]["Tables"]["parts"]["Row"];

type Status = PurchaseOrder["status"];

function fmtDate(v: string | null): string {
  if (!v) return "—";
  const d = new Date(v);
  return Number.isNaN(d.getTime()) ? "—" : d.toLocaleString();
}

function statusPill(status: string | null | undefined): string {
  const s = (status ?? "").toLowerCase();
  if (s === "received") return "border-emerald-500/40 bg-emerald-500/10 text-emerald-200";
  if (s === "receiving") return "border-sky-500/40 bg-sky-500/10 text-sky-200";
  if (s === "ordered") return "border-indigo-500/40 bg-indigo-500/10 text-indigo-200";
  if (s === "open" || s === "draft") return "border-orange-500/40 bg-orange-500/10 text-orange-200";
  if (s === "cancelled" || s === "canceled") return "border-rose-500/40 bg-rose-500/10 text-rose-200";
  return "border-white/10 bg-white/5 text-neutral-200";
}

function isNonEmptyString(v: unknown): v is string {
  return typeof v === "string" && v.trim().length > 0;
}

function normalizeName(s: string): string {
  return s.trim().replace(/\s+/g, " ");
}

function toNum(v: unknown, fallback: number): number {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : fallback;
}

type LineDraft = {
  id: string; // UI-only
  part_id: string | "";
  vendor_part_number: string;
  ordered_qty: number;
  unit_cost: number;
  notes: string;
};

const DEFAULT_SUPPLIER_NAME = "General / Stock";

export default function PurchaseOrdersPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<string>("");

  const [loading, setLoading] = useState(true);
  const [pos, setPOs] = useState<PurchaseOrder[]>([]);
  const [suppliers, setSuppliers] = useState<Supplier[]>([]);
  const [parts, setParts] = useState<Part[]>([]);

  const supplierNameById = useMemo(() => {
    const m = new Map<string, string>();
    for (const s of suppliers) {
      const sid = String(s.id);
      const nm = typeof s.name === "string" && s.name.trim() ? s.name.trim() : sid.slice(0, 8);
      m.set(sid, nm);
    }
    return m;
  }, [suppliers]);

  // Modal state
  const [open, setOpen] = useState(false);
  const [supplierId, setSupplierId] = useState<string>("");
  const [newSupplierName, setNewSupplierName] = useState<string>("");

  const [poNote, setPoNote] = useState<string>("");

  const [lines, setLines] = useState<LineDraft[]>([
    { id: uuidv4(), part_id: "", vendor_part_number: "", ordered_qty: 1, unit_cost: 0, notes: "" },
  ]);

  const [busyCreate, setBusyCreate] = useState(false);
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  const refresh = async (sid: string): Promise<void> => {
    const [poRes, supRes, partsRes] = await Promise.all([
      supabase.from("purchase_orders").select("*").eq("shop_id", sid).order("created_at", { ascending: false }).limit(200),
      supabase.from("suppliers").select("*").eq("shop_id", sid).order("name", { ascending: true }).limit(1000),
      supabase.from("parts").select("*").eq("shop_id", sid).order("name", { ascending: true }).limit(2000),
    ]);

    if (poRes.error) setErrorMsg(poRes.error.message);
    if (supRes.error) setErrorMsg(supRes.error.message);
    if (partsRes.error) setErrorMsg(partsRes.error.message);

    setPOs((poRes.data as PurchaseOrder[]) ?? []);
    setSuppliers((supRes.data as Supplier[]) ?? []);
    setParts((partsRes.data as Part[]) ?? []);
  };

  useEffect(() => {
    (async () => {
      setLoading(true);
      setErrorMsg(null);

      const { data: userRes, error: uErr } = await supabase.auth.getUser();
      const uid = userRes.user?.id ?? null;

      if (uErr) {
        setErrorMsg(uErr.message);
        setLoading(false);
        return;
      }

      if (!uid) {
        setErrorMsg("Not authenticated.");
        setLoading(false);
        return;
      }

      const { data: prof, error: pErr } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .maybeSingle();

      if (pErr) {
        setErrorMsg(pErr.message);
        setLoading(false);
        return;
      }

      const sid = (prof?.shop_id as string | null) ?? "";
      setShopId(sid);

      if (sid) await refresh(sid);

      setLoading(false);
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase]);

  function resetModal(): void {
    setSupplierId("");
    setNewSupplierName("");
    setPoNote("");
    setLines([{ id: uuidv4(), part_id: "", vendor_part_number: "", ordered_qty: 1, unit_cost: 0, notes: "" }]);
    setErrorMsg(null);
  }

  const closeModal = (): void => {
    if (busyCreate) return;
    setOpen(false);
    resetModal();
  };

  function addLine(): void {
    setLines((prev) => [
      ...prev,
      { id: uuidv4(), part_id: "", vendor_part_number: "", ordered_qty: 1, unit_cost: 0, notes: "" },
    ]);
  }

  function removeLine(id: string): void {
    setLines((prev) => {
      if (prev.length <= 1) return prev;
      return prev.filter((x) => x.id !== id);
    });
  }

  function updateLine(id: string, patch: Partial<LineDraft>): void {
    setLines((prev) => prev.map((x) => (x.id === id ? { ...x, ...patch } : x)));
  }

  function validateLines(): string | null {
    const cleaned = lines
      .map((l) => ({
        ...l,
        vendor_part_number: l.vendor_part_number.trim(),
        notes: l.notes.trim(),
      }))
      .filter((l) => l.part_id);

    if (cleaned.length === 0) return null; // allow “header-only” PO

    for (const l of cleaned) {
      if (!isNonEmptyString(l.part_id)) return "Each line must have a part.";
      if (l.ordered_qty <= 0) return "Line qty must be greater than 0.";
      if (l.unit_cost < 0) return "Unit cost cannot be negative.";
    }

    return null;
  }

  async function createSupplier(nameRaw: string): Promise<string> {
    if (!shopId) throw new Error("Missing shop_id.");

    const name = normalizeName(nameRaw);
    const existing = suppliers.find((s) => normalizeName(String(s.name ?? "")) === name);
    if (existing?.id) return String(existing.id);

    const insert: SupplierInsert = {
      id: uuidv4(),
      shop_id: shopId,
      name,
    };

    const { data, error } = await supabase.from("suppliers").insert(insert).select("*").single();
    if (error) throw new Error(error.message);

    const createdId = (data?.id as string | null) ?? null;
    if (!createdId) throw new Error("Supplier create failed.");

    setSuppliers((prev) => [data as Supplier, ...prev]);
    return createdId;
  }

  async function ensureSupplierIdRequired(): Promise<string> {
    if (isNonEmptyString(supplierId)) return supplierId.trim();

    const typed = normalizeName(newSupplierName);
    if (typed) return await createSupplier(typed);

    return await createSupplier(DEFAULT_SUPPLIER_NAME);
  }

  const createPo = async (): Promise<void> => {
    if (!shopId || busyCreate) return;

    setBusyCreate(true);
    setErrorMsg(null);

    try {
      const supplierResolved = await ensureSupplierIdRequired();
      const nowIso = new Date().toISOString();

      const fallbackId = uuidv4();

      const insertPo: PurchaseOrderInsert = {
        id: fallbackId,
        shop_id: shopId,
        supplier_id: supplierResolved,
        status: "open" as Status,
        notes: poNote.trim() ? poNote.trim() : null,
        created_at: nowIso,
      };

      const { data: poData, error: poErr } = await supabase.from("purchase_orders").insert(insertPo).select("id").single();
      if (poErr) throw new Error(poErr.message);

      const newPoId = (poData?.id as string | null) ?? fallbackId;

      const lineError = validateLines();
      if (lineError) throw new Error(lineError);

      const linesToInsert = lines
        .filter((l) => isNonEmptyString(l.part_id))
        .map((l): PurchaseOrderLineInsert => {
          const vendorPn = l.vendor_part_number.trim();
          const notes = l.notes.trim();

          const descriptionParts: string[] = [];
          if (vendorPn) descriptionParts.push(`Vendor PN: ${vendorPn}`);
          if (notes) descriptionParts.push(notes);

          const description = descriptionParts.length ? descriptionParts.join(" • ") : null;

          return {
            id: uuidv4(),
            po_id: newPoId,
            part_id: String(l.part_id),
            qty: Math.max(0, Math.floor(toNum(l.ordered_qty, 0))),
            unit_cost: Math.max(0, toNum(l.unit_cost, 0)),
            sku: vendorPn ? vendorPn : null,
            description,
            received_qty: 0,
            location_id: null,
            created_at: nowIso,
          };
        });

      if (linesToInsert.length > 0) {
        const { error: lineErr } = await supabase.from("purchase_order_lines").insert(linesToInsert);
        if (lineErr) throw new Error(lineErr.message);
      }

      setOpen(false);
      resetModal();

      await refresh(shopId);
    } catch (e: unknown) {
      setErrorMsg(e instanceof Error ? e.message : "Create PO failed.");
    } finally {
      setBusyCreate(false);
    }
  };

  const pageWrap = "relative p-4 md:p-6 text-white";
  const panel =
    "metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl";
  const headerFont = { fontFamily: "var(--font-blackops), system-ui" } as const;

  return (
    <div className={pageWrap}>
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.95),#020617_70%)]"
      />

      <div className="mb-4 flex flex-wrap items-end justify-between gap-3">
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-500">Parts</div>
          <h1 className="mt-1 text-2xl font-semibold text-white" style={headerFont}>
            Purchase Orders
          </h1>
          <div className="mt-1 text-xs text-neutral-500">Create stock POs, receive, and track partials.</div>
        </div>

        <div className="flex items-center gap-2">
          <button
            className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 px-4 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/60 disabled:opacity-60"
            onClick={() => (shopId ? void refresh(shopId) : null)}
            disabled={!shopId || loading}
            type="button"
          >
            Refresh
          </button>

          <button
            className="rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-4 py-2 text-sm font-semibold text-neutral-50 shadow-[0_12px_30px_rgba(0,0,0,0.9)] backdrop-blur-md hover:border-[color:var(--accent-copper-light,#fed7aa)] disabled:opacity-60"
            onClick={() => setOpen(true)}
            disabled={!shopId}
            type="button"
          >
            New PO
          </button>
        </div>
      </div>

      {errorMsg ? (
        <div className={`${panel} mb-4 p-4`}>
          <div className="text-sm text-red-300">{errorMsg}</div>
        </div>
      ) : null}

      {loading ? (
        <div className={`${panel} p-4 text-sm text-neutral-400`}>Loading…</div>
      ) : pos.length === 0 ? (
        <div className={`${panel} p-4 text-sm text-neutral-400`}>No purchase orders yet.</div>
      ) : (
        <div className={`${panel} overflow-hidden`}>
          <div className="flex items-center justify-between border-b border-white/10 bg-gradient-to-r from-black/70 via-slate-950/70 to-black/70 px-4 py-3">
            <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">Recent POs</div>
            <div className="text-[11px] text-neutral-500">{pos.length} shown</div>
          </div>

          <div className="overflow-auto">
            <table className="w-full min-w-[820px] text-sm">
              <thead>
                <tr className="text-left text-neutral-400">
                  <th className="p-3">PO</th>
                  <th className="p-3">Supplier</th>
                  <th className="p-3">Status</th>
                  <th className="p-3">Created</th>
                  <th className="p-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {pos.map((po) => {
                  const id = String(po.id);
                  const sId = String(po.supplier_id);
                  const sName = supplierNameById.get(sId) ?? sId.slice(0, 8);
                  const st = (po.status as string | null) ?? "—";

                  return (
                    <tr key={id} className="border-t border-white/5 hover:bg-white/5">
                      <td className="p-3 font-mono text-neutral-100">{id.slice(0, 8)}</td>
                      <td className="p-3 text-neutral-200">{sName}</td>
                      <td className="p-3">
                        <span
                          className={[
                            "inline-flex items-center rounded-full border px-2.5 py-1 text-[12px] font-medium",
                            statusPill(st),
                          ].join(" ")}
                        >
                          {st}
                        </span>
                      </td>
                      <td className="p-3 text-neutral-300">{fmtDate(po.created_at as string | null)}</td>
                      <td className="p-3 text-right">
                        <div className="inline-flex items-center gap-2">
                          <Link
                            href={`/parts/po/${id}`}
                            className="inline-flex items-center justify-center rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-1.5 text-xs text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/55"
                          >
                            Open
                          </Link>

                          <Link
                            href={`/parts/po/${id}/receive`}
                            className="inline-flex items-center justify-center rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-1.5 text-xs text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/55"
                          >
                            Receive
                          </Link>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {/* New PO Modal */}
      {open ? (
        <div className="fixed inset-0 z-[600] flex items-center justify-center bg-black/70 p-4" onClick={closeModal}>
          <div className="relative w-full max-w-3xl" onClick={(e) => e.stopPropagation()}>
            {/* IMPORTANT: keep modal within viewport and scroll internally */}
            <div className={`${panel} max-h-[85vh] overflow-hidden p-5`}>
              <div className="mb-4 flex items-center justify-between gap-3">
                <div className="min-w-0">
                  <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-500">Create</div>
                  <div className="text-xl font-semibold text-white" style={headerFont}>
                    New Purchase Order
                  </div>
                  <div className="mt-1 text-xs text-neutral-500">Add header + optional line items for stock ordering.</div>
                </div>

                <button
                  className="shrink-0 rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 px-3 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 disabled:opacity-60"
                  onClick={closeModal}
                  disabled={busyCreate}
                  type="button"
                >
                  Close
                </button>
              </div>

              {/* Scrollable body */}
              <div className="max-h-[72vh] overflow-y-auto overflow-x-hidden pr-1">
                <div className="grid gap-4">
                  <div className="grid gap-3 md:grid-cols-2">
                    <div className="min-w-0">
                      <div className="mb-1 text-xs text-neutral-400">Supplier</div>
                      <select
                        className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-sm text-neutral-100"
                        value={supplierId}
                        onChange={(e) => setSupplierId(e.target.value)}
                        disabled={busyCreate}
                      >
                        <option value="">— auto: {DEFAULT_SUPPLIER_NAME} —</option>
                        {suppliers.map((s) => (
                          <option key={String(s.id)} value={String(s.id)}>
                            {typeof s.name === "string" && s.name.trim() ? s.name.trim() : String(s.id).slice(0, 8)}
                          </option>
                        ))}
                      </select>

                      <div className="mt-2 text-[11px] text-neutral-500">or create a new supplier name:</div>
                      <input
                        className="mt-1 w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-sm text-neutral-100 placeholder:text-neutral-600"
                        value={newSupplierName}
                        onChange={(e) => setNewSupplierName(e.target.value)}
                        placeholder="e.g., NAPA / FleetPride / Cummins…"
                        disabled={busyCreate || !!supplierId}
                      />
                      <div className="mt-1 text-[11px] text-neutral-600">
                        If you select a supplier above, this field is ignored.
                      </div>
                    </div>

                    <div className="min-w-0">
                      <div className="mb-1 text-xs text-neutral-400">PO Notes</div>
                      <textarea
                        className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-sm text-neutral-100 placeholder:text-neutral-600"
                        rows={5}
                        value={poNote}
                        onChange={(e) => setPoNote(e.target.value)}
                        placeholder="Optional notes for this PO (delivery time, core return, account #, etc.)"
                        disabled={busyCreate}
                      />
                    </div>
                  </div>

                  <div className="rounded-2xl border border-white/10 bg-black/40 p-4">
                    <div className="mb-3 flex flex-wrap items-center justify-between gap-2">
                      <div className="min-w-0">
                        <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-400">PO Lines</div>
                        <div className="mt-1 text-[11px] text-neutral-500">
                          Add stock lines now, or you can create header-only and add lines later.
                        </div>
                      </div>

                      <button
                        type="button"
                        className="shrink-0 rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 px-3 py-1.5 text-xs text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 disabled:opacity-60"
                        onClick={addLine}
                        disabled={busyCreate}
                      >
                        + Add line
                      </button>
                    </div>

                    {/* Desktop table, scrolls horizontally INSIDE this box */}
                    <div className="hidden md:block">
                      <div className="w-full overflow-x-auto">
                        <table className="w-full min-w-[980px] text-sm">
                          <thead>
                            <tr className="text-left text-neutral-400">
                              <th className="p-2">Part</th>
                              <th className="p-2">Vendor Part #</th>
                              <th className="p-2 text-right">Qty</th>
                              <th className="p-2 text-right">Unit Cost</th>
                              <th className="p-2">Line Notes</th>
                              <th className="p-2 text-right"> </th>
                            </tr>
                          </thead>
                          <tbody>
                            {lines.map((l) => (
                              <tr key={l.id} className="border-t border-white/10">
                                <td className="p-2">
                                  <select
                                    className="w-[380px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100"
                                    value={l.part_id}
                                    onChange={(e) => updateLine(l.id, { part_id: e.target.value })}
                                    disabled={busyCreate}
                                  >
                                    <option value="">— select —</option>
                                    {parts.map((p) => (
                                      <option key={String(p.id)} value={String(p.id)}>
                                        {p.sku
                                          ? `${String(p.sku)} — ${String(p.name ?? "")}`
                                          : String(p.name ?? String(p.id).slice(0, 8))}
                                      </option>
                                    ))}
                                  </select>
                                </td>

                                <td className="p-2">
                                  <input
                                    className="w-[220px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100 placeholder:text-neutral-600"
                                    value={l.vendor_part_number}
                                    onChange={(e) => updateLine(l.id, { vendor_part_number: e.target.value })}
                                    placeholder="Vendor / catalog #"
                                    disabled={busyCreate}
                                  />
                                </td>

                                <td className="p-2 text-right">
                                  <input
                                    type="number"
                                    min={0}
                                    step={1}
                                    className="w-[120px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-right text-xs text-neutral-100"
                                    value={String(l.ordered_qty)}
                                    onChange={(e) =>
                                      updateLine(l.id, {
                                        ordered_qty: Math.max(0, Math.floor(toNum(e.target.value, 0))),
                                      })
                                    }
                                    disabled={busyCreate}
                                  />
                                </td>

                                <td className="p-2 text-right">
                                  <input
                                    type="number"
                                    min={0}
                                    step={0.01}
                                    className="w-[140px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-right text-xs text-neutral-100"
                                    value={String(l.unit_cost)}
                                    onChange={(e) => updateLine(l.id, { unit_cost: Math.max(0, toNum(e.target.value, 0)) })}
                                    disabled={busyCreate}
                                  />
                                </td>

                                <td className="p-2">
                                  <input
                                    className="w-[280px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100 placeholder:text-neutral-600"
                                    value={l.notes}
                                    onChange={(e) => updateLine(l.id, { notes: e.target.value })}
                                    placeholder="Notes (core, urgency, etc.)"
                                    disabled={busyCreate}
                                  />
                                </td>

                                <td className="p-2 text-right">
                                  <button
                                    type="button"
                                    className="rounded-full border border-white/10 bg-black/40 px-3 py-1.5 text-xs text-neutral-100 hover:bg-white/5 disabled:opacity-60"
                                    onClick={() => removeLine(l.id)}
                                    disabled={busyCreate || lines.length <= 1}
                                    title={lines.length <= 1 ? "Keep at least one row" : "Remove line"}
                                  >
                                    Remove
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>

                    {/* Mobile stack layout (keeps everything inside modal) */}
                    <div className="md:hidden grid gap-3">
                      {lines.map((l, idx) => (
                        <div key={l.id} className="rounded-2xl border border-white/10 bg-black/35 p-3">
                          <div className="mb-2 flex items-center justify-between">
                            <div className="text-xs font-semibold text-neutral-300">Line {idx + 1}</div>
                            <button
                              type="button"
                              className="rounded-full border border-white/10 bg-black/40 px-3 py-1 text-xs text-neutral-100 hover:bg-white/5 disabled:opacity-60"
                              onClick={() => removeLine(l.id)}
                              disabled={busyCreate || lines.length <= 1}
                            >
                              Remove
                            </button>
                          </div>

                          <div className="grid gap-2">
                            <div>
                              <div className="mb-1 text-[11px] text-neutral-500">Part</div>
                              <select
                                className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100"
                                value={l.part_id}
                                onChange={(e) => updateLine(l.id, { part_id: e.target.value })}
                                disabled={busyCreate}
                              >
                                <option value="">— select —</option>
                                {parts.map((p) => (
                                  <option key={String(p.id)} value={String(p.id)}>
                                    {p.sku
                                      ? `${String(p.sku)} — ${String(p.name ?? "")}`
                                      : String(p.name ?? String(p.id).slice(0, 8))}
                                  </option>
                                ))}
                              </select>
                            </div>

                            <div>
                              <div className="mb-1 text-[11px] text-neutral-500">Vendor Part #</div>
                              <input
                                className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100 placeholder:text-neutral-600"
                                value={l.vendor_part_number}
                                onChange={(e) => updateLine(l.id, { vendor_part_number: e.target.value })}
                                placeholder="Vendor / catalog #"
                                disabled={busyCreate}
                              />
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <div className="mb-1 text-[11px] text-neutral-500">Qty</div>
                                <input
                                  type="number"
                                  min={0}
                                  step={1}
                                  className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-right text-xs text-neutral-100"
                                  value={String(l.ordered_qty)}
                                  onChange={(e) =>
                                    updateLine(l.id, {
                                      ordered_qty: Math.max(0, Math.floor(toNum(e.target.value, 0))),
                                    })
                                  }
                                  disabled={busyCreate}
                                />
                              </div>

                              <div>
                                <div className="mb-1 text-[11px] text-neutral-500">Unit Cost</div>
                                <input
                                  type="number"
                                  min={0}
                                  step={0.01}
                                  className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-right text-xs text-neutral-100"
                                  value={String(l.unit_cost)}
                                  onChange={(e) => updateLine(l.id, { unit_cost: Math.max(0, toNum(e.target.value, 0)) })}
                                  disabled={busyCreate}
                                />
                              </div>
                            </div>

                            <div>
                              <div className="mb-1 text-[11px] text-neutral-500">Line Notes</div>
                              <input
                                className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-2 text-xs text-neutral-100 placeholder:text-neutral-600"
                                value={l.notes}
                                onChange={(e) => updateLine(l.id, { notes: e.target.value })}
                                placeholder="Notes (core, urgency, etc.)"
                                disabled={busyCreate}
                              />
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="mt-2 text-[11px] text-neutral-600">
                      Tip: If you don’t know the part yet, you can create the PO header only and add lines later from the PO page.
                    </div>
                  </div>

                  {errorMsg ? (
                    <div className="rounded-xl border border-red-500/30 bg-red-500/10 p-3 text-sm text-red-200">{errorMsg}</div>
                  ) : null}

                  <div className="flex flex-wrap justify-end gap-2 pt-1">
                    <button
                      className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 px-4 py-2 text-sm text-neutral-100 hover:bg-black/60 disabled:opacity-60"
                      onClick={closeModal}
                      disabled={busyCreate}
                      type="button"
                    >
                      Cancel
                    </button>

                    <button
                      className="rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-4 py-2 text-sm font-semibold text-neutral-50 shadow-[0_12px_30px_rgba(0,0,0,0.9)] backdrop-blur-md hover:border-[color:var(--accent-copper-light,#fed7aa)] disabled:opacity-60"
                      onClick={() => void createPo()}
                      disabled={!shopId || busyCreate}
                      type="button"
                    >
                      {busyCreate ? "Creating…" : "Create PO"}
                    </button>
                  </div>

                  <div className="text-[11px] text-neutral-600">
                    After creation, you’ll see it in the list. Click <span className="text-neutral-200">Open</span> to review/edit
                    lines, or <span className="text-neutral-200">Receive</span> to receive items.
                  </div>
                </div>
              </div>
              {/* end scroll body */}
            </div>
          </div>
        </div>
      ) : null}
    </div>
  );
}

==================== FILE: app/parts/po/recieve/page.tsx ====================

// app/parts/po/receive/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type PurchaseOrderRow = DB["public"]["Tables"]["purchase_orders"]["Row"];

function safeText(v: unknown): string {
  if (v == null) return "";
  return typeof v === "string" ? v : String(v);
}

function fmtDate(d: string | null | undefined): string {
  if (!d) return "—";
  const dt = new Date(d);
  if (Number.isNaN(dt.getTime())) return "—";
  return dt.toLocaleString();
}

export default function ReceiveFromPOPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [pos, setPOs] = useState<PurchaseOrderRow[]>([]);

  async function load(): Promise<void> {
    setLoading(true);
    setErr(null);

    // Pull recent POs. We keep it broad and allow filtering client-side.
    const { data, error } = await supabase
      .from("purchase_orders")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(100);

    if (error) {
      setErr(error.message);
      setPOs([]);
      setLoading(false);
      return;
    }

    const rows = (data ?? []) as PurchaseOrderRow[];
    setPOs(rows);
    setLoading(false);
  }

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const card =
    "metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl";

  return (
    <div className="p-6 space-y-4 text-white">
      {/* Header */}
      <div className="flex items-start justify-between gap-3">
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">
            Parts
          </div>
          <h1
            className="text-2xl font-bold"
            style={{ fontFamily: "var(--font-blackops), system-ui" }}
          >
            Receive from PO
          </h1>
          <div className="text-sm text-neutral-400">
            Choose a purchase order to receive inventory and update PO line received quantities.
          </div>
        </div>

        <button
          onClick={() => void load()}
          className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 px-4 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/70"
        >
          Refresh
        </button>
      </div>

      {/* Errors */}
      {err ? (
        <div className="rounded-xl border border-red-500/30 bg-red-950/30 p-3 text-sm text-red-200">
          {err}
        </div>
      ) : null}

      {/* Main */}
      {loading ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>Loading…</div>
      ) : pos.length === 0 ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>
          No purchase orders found.
        </div>
      ) : (
        <div className={`${card} overflow-hidden`}>
          <div className="border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-3">
            <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
              Purchase Orders
            </div>
            <div className="mt-1 text-[11px] text-neutral-500">
              Select a PO to open the receiving screen.
            </div>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-neutral-400">
                  <th className="p-3">PO</th>
                  <th className="p-3">Status</th>
                  <th className="p-3">Created</th>
                  <th className="p-3">Vendor</th>
                  <th className="p-3"></th>
                </tr>
              </thead>
              <tbody>
                {pos.map((po) => {
                  const id = safeText(po.id);
                  const status = safeText(po.status ?? "draft");

                  // vendor is schema-dependent; we keep it defensive
                  const vendor =
                    safeText((po as unknown as { vendor?: unknown }).vendor) ||
                    safeText((po as unknown as { vendor_name?: unknown }).vendor_name) ||
                    safeText((po as unknown as { vendor_id?: unknown }).vendor_id) ||
                    "—";

                  return (
                    <tr key={id} className="border-t border-white/10">
                      <td className="p-3">
                        <div className="font-semibold text-neutral-100">
                          {id ? id.slice(0, 8) : "—"}
                        </div>
                        <div className="text-[11px] text-neutral-500">
                          {id ? id : ""}
                        </div>
                      </td>

                      <td className="p-3">
                        <span className="inline-flex items-center rounded-full border border-white/10 bg-black/40 px-3 py-1 text-xs text-neutral-200">
                          {status}
                        </span>
                      </td>

                      <td className="p-3 text-neutral-300">
                        {fmtDate(po.created_at ?? null)}
                      </td>

                      <td className="p-3 text-neutral-300">{vendor}</td>

                      <td className="p-3">
                        <Link
                          href={`/parts/po/${encodeURIComponent(id)}/receive`}
                          className="inline-flex items-center justify-center rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-4 py-2 text-sm font-semibold text-neutral-50 hover:border-[color:var(--accent-copper-light,#fed7aa)]"
                        >
                          Open receive →
                        </Link>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="border-t border-white/10 px-4 py-3 text-[11px] text-neutral-500">
            Tip: Receiving from a PO updates inventory and increments PO line received_qty (FIFO) until complete.
          </div>
        </div>
      )}
    </div>
  );
}

==================== FILE: app/parts/quoting/page.tsx ====================

// app/parts/quoting/page.tsx
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { toast } from "sonner";
import { format } from "date-fns";
import dynamic from "next/dynamic";

import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";
import VoiceContextSetter from "@/features/shared/voice/VoiceContextSetter";
import { requestQuoteSuggestion } from "@inspections/lib/inspection/aiQuote";

const PartsDrawer = dynamic(() => import("@/features/parts/components/PartsDrawer"), {
  ssr: false,
});

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];

type QueueRow = WorkOrderLine & {
  work_order: WorkOrder | null;
  vehicle: Vehicle | null;
  customer: Customer | null;
};

type MenuUpsertResponse = {
  ok: boolean;
  menuItemId?: string;
  updated?: boolean;
  error?: string;
  detail?: string;
};

type ApplyAiUnmatched = { name: string; qty: number };
type ApplyAiResponse = {
  ok?: boolean;
  labor_applied?: boolean;
  unmatched?: ApplyAiUnmatched[];
  error?: string;
};

const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-3 py-1 text-[11px] font-semibold tracking-wide";
const BADGE: Record<string, string> = {
  awaiting: "bg-sky-950/30 border-sky-500/30 text-sky-200",
  awaiting_approval: "bg-blue-950/30 border-blue-500/30 text-blue-200",
  queued: "bg-indigo-950/30 border-indigo-500/30 text-indigo-200",
  in_progress: "bg-amber-950/30 border-amber-500/30 text-amber-200",
  on_hold: "bg-orange-950/30 border-orange-500/30 text-orange-200",
  completed: "bg-emerald-950/25 border-emerald-500/30 text-emerald-200",
  quoted: "bg-teal-950/25 border-teal-500/30 text-teal-200",
};
const chip = (s: string | null | undefined): string => {
  const k = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_");
  return `${BASE_BADGE} ${BADGE[k] ?? BADGE.awaiting}`;
};

// ---- Theme (glass + burnt copper / metallic; no orange-400/500) ----
const COPPER_BORDER = "border-[#8b5a2b]/60";
const COPPER_TEXT = "text-[#c88a4d]";
const COPPER_HOVER_BG = "hover:bg-[#8b5a2b]/10";
const COPPER_FOCUS_RING = "focus:ring-2 focus:ring-[#8b5a2b]/35";

const PAGE = "p-4 sm:p-6 text-white space-y-4";
const CARD =
  "rounded-xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset]";
const CARD_PAD = `${CARD} p-4`;
const HEADER_BAR = "flex flex-col gap-3 md:flex-row md:items-center md:justify-between";

const BTN_BASE =
  "inline-flex items-center justify-center rounded-lg border px-3 py-2 text-sm font-semibold transition disabled:opacity-60";
const BTN_GHOST = `${BTN_BASE} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
const BTN_COPPER = `${BTN_BASE} ${COPPER_BORDER} ${COPPER_TEXT} bg-neutral-950/20 ${COPPER_HOVER_BG}`;
const BTN_GO = `${BTN_BASE} border-emerald-500/30 bg-emerald-950/25 text-emerald-200 hover:bg-emerald-900/25`;
const BTN_AI = `${BTN_BASE} border-sky-500/30 bg-sky-950/25 text-sky-200 hover:bg-sky-900/25`;

const SMALL = "text-xs text-neutral-400";
const INPUT = `w-full rounded-lg border border-white/10 bg-neutral-950/40 px-4 py-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none ${COPPER_FOCUS_RING}`;

async function safeText(res: Response): Promise<string> {
  return res.text().catch(() => "");
}

function tryParseJson<T>(raw: string): T | null {
  try {
    return raw ? (JSON.parse(raw) as T) : null;
  } catch {
    return null;
  }
}

export default function QuotingQueuePage(): JSX.Element {
  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [rows, setRows] = useState<QueueRow[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [selectedId, setSelectedId] = useState<string | null>(null);
  const selected = useMemo(
    () => rows.find((r) => r.id === selectedId) ?? null,
    [rows, selectedId],
  );

  const [bulkQueue, setBulkQueue] = useState<string[]>([]);
  const bulkActive = bulkQueue.length > 0;

  const [search, setSearch] = useState<string>("");
  const filteredRows = useMemo(() => {
    const q = search.trim().toLowerCase();
    if (!q) return rows;
    return rows.filter((r) => {
      const wo = r.work_order?.custom_id ?? r.work_order?.id ?? "";
      const title = r.description ?? r.complaint ?? "";
      const notes = r.notes ?? "";
      const veh = r.vehicle
        ? `${r.vehicle.year ?? ""} ${r.vehicle.make ?? ""} ${r.vehicle.model ?? ""}`.trim()
        : "";
      const cust = r.customer
        ? `${r.customer.first_name ?? ""} ${r.customer.last_name ?? ""}`.trim()
        : "";
      const blob = `${wo} ${title} ${notes} ${veh} ${cust}`.toLowerCase();
      return blob.includes(q);
    });
  }, [rows, search]);

  const fetchQueue = useCallback(async () => {
    setLoading(true);
    setErr(null);

    try {
      const { data: lines, error: lerr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("approval_state", "pending")
        .order("created_at", { ascending: true });

      if (lerr) throw lerr;

      const wol = (lines ?? []) as WorkOrderLine[];
      if (wol.length === 0) {
        setRows([]);
        setLoading(false);
        return;
      }

      const woIds = [...new Set(wol.map((l) => l.work_order_id).filter(Boolean) as string[])];

      const { data: woRows, error: woErr } = await supabase
        .from("work_orders")
        .select("*")
        .in("id", woIds);

      if (woErr) throw woErr;

      const woById = new Map<string, WorkOrder>();
      (woRows ?? []).forEach((w) => woById.set((w as WorkOrder).id, w as WorkOrder));

      const vehIds = [
        ...new Set((woRows ?? []).map((w) => (w as WorkOrder).vehicle_id).filter(Boolean) as string[]),
      ];
      const custIds = [
        ...new Set((woRows ?? []).map((w) => (w as WorkOrder).customer_id).filter(Boolean) as string[]),
      ];

      const [vehRes, custRes] = await Promise.all([
        vehIds.length
          ? supabase.from("vehicles").select("*").in("id", vehIds)
          : Promise.resolve({ data: [] } as const),
        custIds.length
          ? supabase.from("customers").select("*").in("id", custIds)
          : Promise.resolve({ data: [] } as const),
      ]);

      const vById = new Map<string, Vehicle>();
      (vehRes.data ?? []).forEach((v) => vById.set((v as Vehicle).id, v as Vehicle));

      const cById = new Map<string, Customer>();
      (custRes.data ?? []).forEach((c) => cById.set((c as Customer).id, c as Customer));

      const out: QueueRow[] = wol.map((l) => {
        const wo = l.work_order_id ? woById.get(l.work_order_id) ?? null : null;
        const vehicle = wo?.vehicle_id ? vById.get(wo.vehicle_id) ?? null : null;
        const customer = wo?.customer_id ? cById.get(wo.customer_id) ?? null : null;
        return { ...l, work_order: wo, vehicle, customer };
      });

      setRows(out);

      if (selectedId && !out.some((r) => r.id === selectedId)) {
        setSelectedId(null);
      }
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to load quoting queue.";
      setErr(msg);
    } finally {
      setLoading(false);
    }
  }, [supabase, selectedId]);

  useEffect(() => {
    void fetchQueue();
  }, [fetchQueue]);

  useEffect(() => {
    const ch = supabase
      .channel("quote-queue")
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: "approval_state=eq.pending",
        },
        () => void fetchQueue(),
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        // ignore
      }
    };
  }, [supabase, fetchQueue]);

  const startBulk = useCallback(() => {
    if (!rows.length) return;
    const ids = rows.map((r) => r.id);
    setBulkQueue(ids);
    setSelectedId(ids[0] ?? null);
    toast.message(`Quoting ${ids.length} pending line(s)…`);
  }, [rows]);

  useEffect(() => {
    if (!selectedId) return;

    const evt = `parts-drawer:closed:${selectedId}`;
    const handler = () => {
      if (bulkActive) {
        const [, ...rest] = bulkQueue;
        setBulkQueue(rest);
        setSelectedId(rest[0] ?? null);
        if (rest.length === 0) void fetchQueue();
      } else {
        setSelectedId(null);
        void fetchQueue();
      }
    };

    window.addEventListener(evt, handler as EventListener);
    return () => window.removeEventListener(evt, handler as EventListener);
  }, [selectedId, bulkActive, bulkQueue, fetchQueue]);

  // ---- AI Apply: suggest + server inserts allocations + labor
  const aiApply = useCallback(
    async (row: QueueRow) => {
      if (!row.id) return;
      toast.loading("AI preparing parts & labor…", { id: `ai-${row.id}` });

      try {
        const suggestion = await requestQuoteSuggestion({
          item: row.description ?? "Job",
          notes: row.notes ?? "",
          section: "Quote Queue",
          status: "recommend",
          vehicle: row.vehicle ?? undefined,
        });

        if (!suggestion) {
          toast.error("AI returned no suggestion.", { id: `ai-${row.id}` });
          return;
        }

        const r = await fetch("/api/quotes/apply-ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderLineId: row.id, suggestion }),
        });

        const raw = await safeText(r);
        const j = tryParseJson<ApplyAiResponse>(raw);

        if (!r.ok || !j?.ok) {
          throw new Error(j?.error || raw || `HTTP ${r.status}`);
        }

        if (j.unmatched && j.unmatched.length) {
          const list = j.unmatched
            .map((u: ApplyAiUnmatched) => `${u.qty}× ${u.name}`)
            .join(", ");
          toast.message(`Some parts need manual matching: ${list}`, { id: `ai-${row.id}` });
        } else {
          toast.success("AI parts & labor applied", { id: `ai-${row.id}` });
        }

        await fetchQueue();
      } catch (e: unknown) {
        toast.error(e instanceof Error ? e.message : "AI apply failed", { id: `ai-${row.id}` });
      }
    },
    [fetchQueue],
  );

  // ---- Mark as quoted (still pending approval) + grow Saved Menu
  const markQuoted = useCallback(
    async (row: QueueRow) => {
      if (!row.id) return;
      toast.loading("Marking as quoted…", { id: `quoted-${row.id}` });

      try {
        const r = await fetch("/api/menu-items/upsert-from-line", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderLineId: row.id }),
        });

        const raw = await safeText(r);
        const body = tryParseJson<MenuUpsertResponse>(raw);

        if (!r.ok || !body?.ok) {
          const reason = body?.detail || body?.error || raw || `HTTP ${r.status}`;
          toast.warning(`Quoted, but couldn’t save to menu items. ${reason}`, { id: `quoted-${row.id}` });
          return;
        }

        const nextNotes = `${row.notes ?? ""}`.includes("[quoted]")
          ? row.notes
          : [row.notes ?? "", "[quoted]"].filter(Boolean).join(" ").trim();

        const { error: ue } = await supabase
          .from("work_order_lines")
          .update(
            {
              status: "quoted",
              notes: nextNotes,
            } as DB["public"]["Tables"]["work_order_lines"]["Update"],
          )
          .eq("id", row.id);

        if (ue) {
          toast.success("Saved Menu updated, but line status could not be set to quoted.", {
            id: `quoted-${row.id}`,
          });
        } else {
          toast.success("Marked as quoted (awaiting approval). Saved Menu updated.", { id: `quoted-${row.id}` });
        }

        await fetchQueue();
      } catch (e: unknown) {
        toast.error(e instanceof Error ? e.message : "Failed to mark as quoted", { id: `quoted-${row.id}` });
      }
    },
    [supabase, fetchQueue],
  );

  return (
    <div className={PAGE}>
      <VoiceContextSetter currentView="parts_quoting" />

      <div className={HEADER_BAR}>
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">Parts</div>
          <h1 className="text-2xl font-semibold text-white" style={{ fontFamily: "var(--font-blackops), system-ui" }}>
            Quoting Queue
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            Pending approval lines that need quoting. Use AI Apply or open the Parts Drawer.
          </p>
        </div>

        <div className="flex flex-wrap items-center gap-2">
          <Link href="/parts/inventory" className={BTN_COPPER}>
            Inventory →
          </Link>
          <button type="button" className={BTN_GHOST} onClick={() => void fetchQueue()}>
            Refresh
          </button>
          <button
            type="button"
            className={BTN_COPPER}
            onClick={startBulk}
            disabled={rows.length === 0}
            title="Walk through each pending line with the Parts Drawer"
          >
            Quote all pending ({rows.length})
          </button>
        </div>
      </div>

      {err && (
        <div className="rounded-xl border border-red-500/30 bg-red-950/35 p-3 text-red-200">{err}</div>
      )}

      {/* search */}
      <div className={CARD_PAD}>
        <div className="grid gap-3 md:grid-cols-12 md:items-center">
          <div className="md:col-span-8">
            <div className={SMALL}>Search by WO, job, notes, vehicle, customer</div>
            <input
              className={INPUT}
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder="Search…"
            />
          </div>
          <div className="md:col-span-4">
            <div className={SMALL}>Bulk mode</div>
            <div className="rounded-lg border border-white/10 bg-neutral-950/20 px-3 py-2 text-sm text-neutral-200">
              {bulkActive ? (
                <>
                  Active · Remaining <span className={COPPER_TEXT}>{bulkQueue.length}</span>
                </>
              ) : (
                "Inactive"
              )}
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 gap-6 lg:grid-cols-[460px_1fr]">
        {/* LEFT: queue */}
        <div className={CARD}>
          <div className="border-b border-white/10 px-4 py-3 text-sm text-neutral-300">Pending approval lines</div>

          {loading ? (
            <div className="p-4 text-neutral-400">Loading…</div>
          ) : filteredRows.length === 0 ? (
            <div className="p-4 text-neutral-400">Nothing awaiting quoting.</div>
          ) : (
            <ul className="divide-y divide-white/10">
              {filteredRows.map((r) => {
                const active = selectedId === r.id;
                const woLabel = r.work_order?.custom_id || r.work_order?.id?.slice(0, 8) || "—";
                const title = r.description || r.complaint || "Untitled job";
                const veh = r.vehicle
                  ? `${r.vehicle.year ?? ""} ${r.vehicle.make ?? ""} ${r.vehicle.model ?? ""}`.trim()
                  : "No vehicle";
                const when = r.created_at ? format(new Date(r.created_at), "PPp") : "—";

                return (
                  <li key={r.id} className={["px-4 py-3", active ? "bg-white/5" : ""].join(" ")}>
                    <div className="flex items-start justify-between gap-3">
                      <button type="button" className="min-w-0 text-left" onClick={() => setSelectedId(r.id)}>
                        <div className="truncate font-semibold text-white">{title}</div>
                        <div className="mt-1 text-xs text-neutral-400">
                          WO: {woLabel} <span className="mx-2 text-neutral-600">·</span>
                          {veh} <span className="mx-2 text-neutral-600">·</span>
                          {when}
                        </div>
                        {r.notes ? (
                          <div className="mt-1 truncate text-xs text-neutral-400">Notes: {r.notes}</div>
                        ) : null}
                      </button>

                      <div className="flex shrink-0 flex-col items-end gap-2">
                        <span className={chip(r.status)}>{(r.status ?? "awaiting").replaceAll("_", " ")}</span>

                        <div className="flex items-center gap-2">
                          <button type="button" className={BTN_AI} onClick={() => void aiApply(r)}>
                            AI Apply
                          </button>

                          <button type="button" className={BTN_GHOST} onClick={() => setSelectedId(r.id)}>
                            Quote
                          </button>

                          <button type="button" className={BTN_GO} onClick={() => void markQuoted(r)}>
                            Mark Quoted
                          </button>
                        </div>
                      </div>
                    </div>
                  </li>
                );
              })}
            </ul>
          )}
        </div>

        {/* RIGHT: details */}
        <div className={CARD_PAD}>
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-semibold text-white">Details</h2>
            {selected?.work_order?.id ? (
              <Link href={`/work-orders/${selected.work_order.id}`} className={BTN_COPPER}>
                Open Work Order →
              </Link>
            ) : null}
          </div>

          {selected ? (
            <div className="mt-3 space-y-3 text-sm">
              <div>
                <div className={SMALL}>Work Order</div>
                <div className="font-semibold text-white">
                  {selected.work_order?.custom_id || selected.work_order?.id?.slice(0, 8) || "—"}
                </div>
              </div>

              <div>
                <div className={SMALL}>Vehicle</div>
                <div className="font-semibold text-white">
                  {selected.vehicle
                    ? (`${selected.vehicle.year ?? ""} ${selected.vehicle.make ?? ""} ${selected.vehicle.model ?? ""}`.trim() || "—")
                    : "—"}
                </div>
              </div>

              <div>
                <div className={SMALL}>Customer</div>
                <div className="font-semibold text-white">
                  {selected.customer
                    ? ([selected.customer.first_name ?? "", selected.customer.last_name ?? ""].filter(Boolean).join(" ") || "—")
                    : "—"}
                </div>
              </div>

              <div>
                <div className={SMALL}>Description</div>
                <div className="font-semibold text-white">{selected.description ?? "—"}</div>
              </div>

              <div>
                <div className={SMALL}>Notes</div>
                <div className="whitespace-pre-wrap font-semibold text-white">{selected.notes ?? "—"}</div>
              </div>
            </div>
          ) : (
            <div className="mt-3 text-neutral-400">Select a line on the left to see details.</div>
          )}
        </div>
      </div>

      {/* Parts drawer */}
      {selected && selected.work_order?.id && (
        <PartsDrawer
          open
          workOrderId={selected.work_order.id}
          workOrderLineId={selected.id}
          vehicleSummary={
            selected.vehicle
              ? {
                  year: (selected.vehicle.year as string | number | null)?.toString() ?? null,
                  make: selected.vehicle.make ?? null,
                  model: selected.vehicle.model ?? null,
                }
              : null
          }
          jobDescription={selected.description ?? null}
          jobNotes={selected.notes ?? null}
          closeEventName={`parts-drawer:closed:${selected.id}`}
        />
      )}

      
    </div>
  );
}

==================== FILE: app/parts/receive/page.tsx ====================

// app/parts/receive/page.tsx (FULL FILE REPLACEMENT)

"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { resolveScannedCode } from "@/features/parts/server/scanActions";

type QuaggaResult = { codeResult?: { code?: string | null } | null };

type QuaggaConfig = {
  inputStream: {
    name: string;
    type: "LiveStream";
    target: HTMLElement;
    constraints?: { facingMode?: string };
  };
  decoder: { readers: string[] };
  locate?: boolean;
};

type QuaggaDetectedHandler = (res: QuaggaResult) => void;

type QuaggaLike = {
  init: (cfg: QuaggaConfig, cb: (err?: Error) => void) => void;
  start: () => void;
  stop: () => void;
  onDetected: (handler: QuaggaDetectedHandler) => void;
  offDetected?: (handler: QuaggaDetectedHandler) => void;
};

let Quagga: QuaggaLike | null = null;

if (typeof window !== "undefined") {
  void import("@ericblade/quagga2").then((m) => {
    Quagga = (m.default as unknown) as QuaggaLike;
  });
}

type DB = Database;
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];

type ReceiveResult =
  | {
      ok: true;
      mode: "po" | "manual";
      result?: unknown;
    }
  | { error: string };

export default function ReceivePage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string>("");

  const [pos, setPOs] = useState<PurchaseOrder[]>([]);
  const [selectedPo, setSelectedPo] = useState<string>("");
  const [selectedLoc, setSelectedLoc] = useState<string>("");
  const [locs, setLocs] = useState<StockLoc[]>([]);
  const [lastScan, setLastScan] = useState<string>("");

  const videoRef = useRef<HTMLDivElement | null>(null);
  const [scanning, setScanning] = useState<boolean>(false);
  const [qty, setQty] = useState<number>(1);

  const [lastResult, setLastResult] = useState<ReceiveResult | null>(null);
  const [busy, setBusy] = useState(false);

  const onDetectedRef = useRef<QuaggaDetectedHandler | null>(null);

  useEffect(() => {
    (async () => {
      const { data: userRes } = await supabase.auth.getUser();
      const uid = userRes.user?.id;
      if (!uid) return;

      // ✅ profiles.user_id == auth.uid()
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .maybeSingle();

      if (profErr) return;

      const sid = prof?.shop_id ?? "";
      setShopId(sid);
      if (!sid) return;

      const [poRes, locRes] = await Promise.all([
        supabase
          .from("purchase_orders")
          .select("*")
          .eq("shop_id", sid)
          .order("created_at", { ascending: false })
          .limit(50),
        supabase
          .from("stock_locations")
          .select("*")
          .eq("shop_id", sid)
          .order("code"),
      ]);

      setPOs((poRes.data ?? []) as PurchaseOrder[]);
      const locRows = (locRes.data ?? []) as StockLoc[];
      setLocs(locRows);

      const main = locRows.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
      if (main) setSelectedLoc(main.id);
    })();
  }, [supabase]);

  const cleanupScannerHandlers = () => {
    try {
      if (Quagga && onDetectedRef.current && typeof Quagga.offDetected === "function") {
        Quagga.offDetected(onDetectedRef.current);
      }
    } catch {
      // ignore
    }
    onDetectedRef.current = null;
  };

  const startScan = async () => {
    if (!Quagga || scanning || !videoRef.current) return;

    setScanning(true);

    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: videoRef.current,
          constraints: { facingMode: "environment" },
        },
        decoder: {
          readers: [
            "upc_reader",
            "upc_e_reader",
            "ean_reader",
            "ean_8_reader",
            "code_128_reader",
          ],
        },
        locate: true,
      },
      (err?: Error) => {
        if (err) {
          console.error(err);
          setScanning(false);
          return;
        }
        Quagga?.start();
      },
    );

    cleanupScannerHandlers();

    const handler: QuaggaDetectedHandler = async (res) => {
      const code = res.codeResult?.code ?? "";
      if (!code || code === lastScan) return;

      setLastScan(code);
      setLastResult(null);

      if (!selectedLoc) {
        setLastResult({ error: "Select a location first." });
        window.setTimeout(() => setLastScan(""), 800);
        return;
      }

      const supplierId = pos.find((p) => p.id === selectedPo)?.supplier_id ?? null;

      const { part_id } = await resolveScannedCode({
        code,
        supplier_id: supplierId,
      });

      if (!part_id) {
        setLastResult({
          error: `No part found for "${code}". Map it in Parts → Inventory → Edit → Barcodes.`,
        });
        window.setTimeout(() => setLastScan(""), 1200);
        return;
      }

      setBusy(true);
      try {
        const resp = await fetch("/api/receive-scan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            part_id,
            location_id: selectedLoc,
            qty,
            po_id: selectedPo || null,
          }),
        });

        const json = (await resp.json().catch(() => ({}))) as
          | { ok?: boolean; mode?: "po" | "manual"; result?: unknown; error?: string }
          | Record<string, unknown>;

        if (!resp.ok) {
          const errMsg =
            typeof (json as { error?: unknown }).error === "string"
              ? (json as { error: string }).error
              : "Receive failed";
          setLastResult({ error: errMsg });
          return;
        }

        setLastResult({
          ok: true,
          mode: (json as { mode?: "po" | "manual" }).mode ?? (selectedPo ? "po" : "manual"),
          result: (json as { result?: unknown }).result,
        });

        window.dispatchEvent(new CustomEvent("parts:received"));
      } finally {
        setBusy(false);
        window.setTimeout(() => setLastScan(""), 900);
      }
    };

    onDetectedRef.current = handler;
    Quagga.onDetected(handler);
  };

  const stopScan = () => {
    try {
      cleanupScannerHandlers();
      Quagga?.stop();
    } catch {
      /* ignore */
    }
    setScanning(false);
  };

  useEffect(() => {
    return () => stopScan();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const locLabel = locs.find((l) => l.id === selectedLoc)?.code ?? "LOC";

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-bold text-white">Scan to Receive</h1>

      <div className="text-xs text-neutral-500">
        Shop: <span className="text-neutral-300">{shopId ? shopId.slice(0, 8) : "—"}</span>
      </div>

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3 grid gap-3 sm:grid-cols-3">
        <div className="sm:col-span-1">
          <div className="text-xs text-neutral-400 mb-1">Purchase Order (optional)</div>
          <select
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={selectedPo}
            onChange={(e) => setSelectedPo(e.target.value)}
          >
            <option value="">— No PO —</option>
            {pos.map((po) => (
              <option key={po.id} value={po.id}>
                {po.id.slice(0, 8)} • {po.status ?? "draft"}
              </option>
            ))}
          </select>
        </div>

        <div>
          <div className="text-xs text-neutral-400 mb-1">Location</div>
          <select
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={selectedLoc}
            onChange={(e) => setSelectedLoc(e.target.value)}
          >
            {locs.map((l) => (
              <option key={l.id} value={l.id}>
                {l.code ?? "LOC"} — {l.name ?? ""}
              </option>
            ))}
          </select>
        </div>

        <div>
          <div className="text-xs text-neutral-400 mb-1">Quantity</div>
          <input
            type="number"
            min={0.01}
            step="0.01"
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={qty}
            onChange={(e) => setQty(Math.max(0.01, Number(e.target.value || 1)))}
          />
        </div>
      </div>

      {/* Result panel */}
      <div className="rounded border border-neutral-800 bg-neutral-950 p-3">
        <div className="text-xs uppercase tracking-[0.18em] text-neutral-500 mb-2">
          Last receive
        </div>

        {!lastResult ? (
          <div className="text-sm text-neutral-400">
            Scan a barcode to receive into <span className="text-neutral-200">{locLabel}</span>.
          </div>
        ) : "error" in lastResult ? (
          <div className="text-sm text-red-300">{lastResult.error}</div>
        ) : (
          <div className="space-y-1">
            <div className="text-sm text-emerald-300">
              Received ×{qty} to {locLabel} ({lastResult.mode === "po" ? "PO receive + allocate" : "manual receive"})
            </div>

            {lastResult.mode === "po" ? (
              <pre className="mt-2 max-h-64 overflow-auto rounded border border-neutral-800 bg-black/60 p-2 text-xs text-neutral-200">
                {JSON.stringify(lastResult.result ?? {}, null, 2)}
              </pre>
            ) : null}
          </div>
        )}
      </div>

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
        <div className="mb-2 flex items-center gap-2">
          {!scanning ? (
            <button
              onClick={startScan}
              disabled={busy}
              className="rounded border border-orange-500 px-3 py-1.5 text-sm text-orange-300 hover:bg-orange-900/20 disabled:opacity-60"
            >
              Start Scanner
            </button>
          ) : (
            <button
              onClick={stopScan}
              className="rounded border border-red-500 px-3 py-1.5 text-sm text-red-300 hover:bg-red-900/20"
            >
              Stop Scanner
            </button>
          )}
          <span className="text-xs text-neutral-400">
            Use mobile camera to scan UPC/EAN/Code128.
          </span>
        </div>

        <div
          ref={videoRef}
          className="aspect-video w-full overflow-hidden rounded border border-neutral-800 bg-black"
        />
      </div>
    </div>
  );
}

==================== FILE: app/parts/receiving/page.tsx ====================

// app/parts/receiving/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import dynamic from "next/dynamic";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type PartRequestItemRow = DB["public"]["Tables"]["part_request_items"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];

type InboxItem = {
  id: string;
  created_at: string | null;
  shop_id: string | null;
  request_id: string;
  part_id: string | null;
  description: string;
  status: string;
  qty_approved: number;
  qty_received: number;
  qty_remaining: number;
};

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

async function resolveShopId(supabase: ReturnType<typeof createClientComponentClient<DB>>) {
  const { data: userRes } = await supabase.auth.getUser();
  const uid = userRes.user?.id ?? null;
  if (!uid) return "";

  const { data: profA } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("user_id", uid)
    .maybeSingle();
  if (profA?.shop_id) return String(profA.shop_id);

  const { data: profB } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("id", uid)
    .maybeSingle();

  return String(profB?.shop_id ?? "");
}

const ReceiveDrawer = dynamic(() => import("@/features/parts/components/ReceiveDrawer"), {
  ssr: false,
});

type DrawerItem = {
  id: string;
  created_at?: string | null;
  request_id?: string | null;
  part_id?: string | null;
  description?: string | null;
  status?: string | null;
  qty_approved?: number | null;
  qty_received?: number | null;
  qty_remaining?: number | null;
  part_name?: string | null;
  sku?: string | null;
};

export default function ReceivingInboxPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [locs, setLocs] = useState<StockLoc[]>([]);
  const [selectedLoc, setSelectedLoc] = useState<string>("");

  const [pos, setPOs] = useState<PurchaseOrder[]>([]);
  const [selectedPo, setSelectedPo] = useState<string>("");

  const [items, setItems] = useState<InboxItem[]>([]);
  const [partsMap, setPartsMap] = useState<Record<string, PartRow>>({});

  const [drawerOpen, setDrawerOpen] = useState<boolean>(false);
  const [drawerItem, setDrawerItem] = useState<DrawerItem | null>(null);

  const load = async () => {
    setLoading(true);
    setErr(null);

    const sid = shopId || (await resolveShopId(supabase));
    if (!sid) {
      setLoading(false);
      return;
    }
    if (!shopId) setShopId(sid);

    const [locRes, poRes] = await Promise.all([
      supabase.from("stock_locations").select("*").eq("shop_id", sid).order("code"),
      supabase
        .from("purchase_orders")
        .select("*")
        .eq("shop_id", sid)
        .order("created_at", { ascending: false })
        .limit(50),
    ]);

    if (locRes.error) setErr(locRes.error.message);
    if (poRes.error) setErr(poRes.error.message);

    const locRows = (locRes.data ?? []) as StockLoc[];
    setLocs(locRows);

    const main = locRows.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
    if (!selectedLoc && main?.id) setSelectedLoc(String(main.id));

    setPOs((poRes.data ?? []) as PurchaseOrder[]);

    const { data: priRows, error: priErr } = await supabase
      .from("part_request_items")
      .select("id, created_at, shop_id, request_id, part_id, description, status, qty_approved, qty_received")
      .eq("shop_id", sid)
      .order("created_at", { ascending: true })
      .limit(200);

    if (priErr) {
      setErr(priErr.message);
      setItems([]);
      setLoading(false);
      return;
    }

    const normalized: InboxItem[] = (priRows ?? [])
      .map((r) => {
        const approved = n((r as PartRequestItemRow).qty_approved);
        const received = n((r as PartRequestItemRow).qty_received);
        const remaining = Math.max(0, approved - received);

        return {
          id: String((r as PartRequestItemRow).id),
          created_at: (r as PartRequestItemRow).created_at ?? null,
          shop_id: (r as PartRequestItemRow).shop_id ?? null,
          request_id: String((r as PartRequestItemRow).request_id),
          part_id: ((r as PartRequestItemRow).part_id as string | null) ?? null,
          description: String((r as PartRequestItemRow).description ?? ""),
          status: String((r as PartRequestItemRow).status ?? ""),
          qty_approved: approved,
          qty_received: received,
          qty_remaining: remaining,
        };
      })
      .filter((x) => x.qty_approved > 0 && x.qty_remaining > 0);

    setItems(normalized);

    const partIds = Array.from(new Set(normalized.map((x) => x.part_id).filter(Boolean))) as string[];
    if (partIds.length) {
      const { data: partRows, error: pErr } = await supabase.from("parts").select("*").in("id", partIds);
      if (pErr) setErr(pErr.message);

      const map: Record<string, PartRow> = {};
      (partRows ?? []).forEach((p) => {
        map[String((p as PartRow).id)] = p as PartRow;
      });
      setPartsMap(map);
    } else {
      setPartsMap({});
    }

    setLoading(false);
  };

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // any drawer receive triggers refresh via event
  useEffect(() => {
    const handler = () => void load();
    window.addEventListener("parts:received", handler as EventListener);
    return () => window.removeEventListener("parts:received", handler as EventListener);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const openDrawerFor = (it: InboxItem) => {
    const p = it.part_id ? partsMap[it.part_id] : null;

    setDrawerItem({
      id: it.id,
      created_at: it.created_at,
      request_id: it.request_id,
      part_id: it.part_id,
      description: it.description,
      status: it.status,
      qty_approved: it.qty_approved,
      qty_received: it.qty_received,
      qty_remaining: it.qty_remaining,
      part_name: p?.name ? String(p.name) : null,
      sku: p?.sku ? String(p.sku) : null,
    });

    setDrawerOpen(true);
  };

  const card =
    "metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl";

  const locOptions = locs.map((l) => ({
    value: String(l.id),
    label: `${String(l.code ?? "LOC")} — ${String(l.name ?? "")}`,
  }));

  const poOptions = pos.map((po) => ({
    value: String(po.id),
    label: `${String(po.id).slice(0, 8)} • ${String(po.status ?? "draft")}`,
  }));

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex items-start justify-between gap-3">
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">Parts</div>
          <h1 className="text-2xl font-bold" style={{ fontFamily: "var(--font-blackops), system-ui" }}>
            Receiving Inbox
          </h1>
          <div className="text-sm text-neutral-400">Receive against a specific request item (supports partial receiving).</div>
        </div>

        <button
          onClick={() => void load()}
          className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 px-4 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/70"
        >
          Refresh
        </button>
      </div>

      {/* Controls */}
      <div className={`${card} p-4`}>
        <div className="grid gap-3 md:grid-cols-3">
          <div>
            <div className="mb-1 text-xs text-neutral-400">Location</div>
            <select
              className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-2 text-sm text-white"
              value={selectedLoc}
              onChange={(e) => setSelectedLoc(e.target.value)}
            >
              {locs.map((l) => (
                <option key={String(l.id)} value={String(l.id)}>
                  {String(l.code ?? "LOC")} — {String(l.name ?? "")}
                </option>
              ))}
            </select>
          </div>

          <div>
            <div className="mb-1 text-xs text-neutral-400">PO (optional)</div>
            <select
              className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-2 text-sm text-white"
              value={selectedPo}
              onChange={(e) => setSelectedPo(e.target.value)}
            >
              <option value="">— none —</option>
              {pos.map((po) => (
                <option key={String(po.id)} value={String(po.id)}>
                  {String(po.id).slice(0, 8)} • {String(po.status ?? "draft")}
                </option>
              ))}
            </select>
            <div className="mt-1 text-[11px] text-neutral-500">
              If selected, we attribute receiving to that PO via the RPC.
            </div>
          </div>

          <div className="flex items-end">
            <div className="text-[11px] text-neutral-500">
              Showing items where <span className="text-neutral-200">qty_received &lt; qty_approved</span>.
            </div>
          </div>
        </div>
      </div>

      {err ? (
        <div className="rounded-xl border border-red-500/30 bg-red-950/30 p-3 text-sm text-red-200">{err}</div>
      ) : null}

      {loading ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>Loading…</div>
      ) : items.length === 0 ? (
        <div className={`${card} p-4 text-sm text-neutral-400`}>No outstanding receive items.</div>
      ) : (
        <div className={`${card} overflow-hidden`}>
          <div className="border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-3">
            <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">Outstanding items</div>
          </div>

          <div className="overflow-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="text-left text-neutral-400">
                  <th className="p-3">Part</th>
                  <th className="p-3">Approved</th>
                  <th className="p-3">Received</th>
                  <th className="p-3">Remaining</th>
                  <th className="p-3"></th>
                </tr>
              </thead>
              <tbody>
                {items.map((it) => {
                  const p = it.part_id ? partsMap[it.part_id] : null;
                  const sku = (p?.sku as string | null) ?? null;

                  return (
                    <tr key={it.id} className="border-t border-white/10">
                      <td className="p-3">
                        <div className="font-semibold text-neutral-100">{p?.name ? String(p.name) : it.description}</div>
                        <div className="text-[11px] text-neutral-500">
                          {sku ? `${sku} • ` : ""}
                          {it.part_id ? String(it.part_id).slice(0, 8) : "no part_id"}
                          {" • "}
                          status: <span className="text-neutral-300">{it.status}</span>
                        </div>
                      </td>
                      <td className="p-3 tabular-nums">{it.qty_approved}</td>
                      <td className="p-3 tabular-nums">{it.qty_received}</td>
                      <td className="p-3 tabular-nums">{it.qty_remaining}</td>
                      <td className="p-3">
                        <button
                          onClick={() => openDrawerFor(it)}
                          className="rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-4 py-2 text-sm font-semibold text-neutral-50 hover:border-[color:var(--accent-copper-light,#fed7aa)]"
                        >
                          Open receive →
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          <div className="border-t border-white/10 px-4 py-3 text-[11px] text-neutral-500">
            Notes: This flow calls <span className="text-neutral-200">receive_part_request_item</span> RPC and refreshes automatically via{" "}
            <span className="text-neutral-200">parts:received</span>.
          </div>
        </div>
      )}

      <ReceiveDrawer
        open={drawerOpen}
        item={drawerItem}
        onClose={() => {
          setDrawerOpen(false);
          setDrawerItem(null);
          void load();
        }}
        locations={locOptions}
        defaultLocationId={selectedLoc || locOptions[0]?.value || ""}
        purchaseOrders={poOptions}
        defaultPoId={selectedPo ? selectedPo : ""}
        lockLocation={false}
        lockPo={false}
      />
    </div>
  );
}

==================== FILE: app/parts/requests/[id]/page.tsx ====================

// app/parts/requests/[id]/page.tsx  (PART 1/2)
"use client";

import { useEffect, useMemo, useState } from "react";
import dynamic from "next/dynamic";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type RequestRow = DB["public"]["Tables"]["part_requests"]["Row"];
type ItemRow = DB["public"]["Tables"]["part_request_items"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type LocationRow = DB["public"]["Tables"]["stock_locations"]["Row"];
type PurchaseOrderRow = DB["public"]["Tables"]["purchase_orders"]["Row"];
type SupplierRow = DB["public"]["Tables"]["suppliers"]["Row"];

type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type LineLite = Pick<WorkOrderLineRow, "id" | "complaint" | "description">;

type Status = RequestRow["status"];

type UpsertResponse = {
  ok: boolean;
  menuItemId?: string;
  updated?: boolean;
  error?: string;
  detail?: string;
};

type UiItem = ItemRow & {
  ui_part_id: string | null;
  ui_qty: number;
  ui_price?: number; // sell/unit (undefined = not set)
  ui_added?: boolean; // purely UI “added” state (not used for logic)

  // PO assignment UI
  ui_po_id?: string; // derived from it.po_id (if exists) else ""
  ui_supplier_id?: string; // for create/select (optional helper)
};

type RequestUi = {
  req: RequestRow;
  items: UiItem[];
};

type DrawerItem = {
  id: string;
  created_at?: string | null;
  request_id?: string | null;
  part_id?: string | null;
  description?: string | null;
  status?: string | null;
  qty_approved?: number | null;
  qty_received?: number | null;
  qty_remaining?: number | null;
  part_name?: string | null;
  sku?: string | null;
};

function isNonEmptyString(v: unknown): v is string {
  return typeof v === "string" && v.trim().length > 0;
}

function toNum(v: unknown, fallback: number): number {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : fallback;
}

/** Strict UUID check for uuid-typed columns (prevents PostgREST 400 casts). */
function isUuid(v: unknown): v is string {
  if (typeof v !== "string") return false;
  const s = v.trim();
  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(
    s,
  );
}

function looksLikeUuid(s: string): boolean {
  return s.includes("-") && s.length >= 36;
}

function splitCustomId(raw: string): { prefix: string; n: number | null } {
  const m = raw.toUpperCase().match(/^([A-Z]+)\s*0*?(\d+)?$/);
  if (!m) return { prefix: raw.toUpperCase(), n: null };
  const n = m[2] ? parseInt(m[2], 10) : null;
  return { prefix: m[1], n: Number.isFinite(n ?? NaN) ? n : null };
}

/**
 * IMPORTANT:
 * - work_order_line_id is uuid in most schemas.
 * - part_requests.job_id may be legacy/non-uuid in some setups.
 * This helper ONLY returns valid UUIDs to avoid PostgREST 400 errors.
 */
function resolveWorkOrderLineId(
  currentReq: RequestRow,
  list: UiItem[],
): string | null {
  for (const it of list) {
    const v = it.work_order_line_id;
    if (isUuid(v)) return v;
  }
  const j = currentReq.job_id;
  if (isUuid(j)) return j;
  return null;
}

function isRowComplete(it: UiItem): boolean {
  const hasPart = isNonEmptyString(it.part_id ?? it.ui_part_id ?? null);
  const hasPrice = it.quoted_price != null || it.ui_price != null;
  const qty = toNum(it.qty ?? it.ui_qty, 0);
  return hasPart && hasPrice && qty > 0;
}

function computeRequestBadge(
  req: RequestRow,
  items: UiItem[],
): "needs_quote" | "quoted" {
  const status = (req.status ?? "requested").toLowerCase();
  if (status === "quoted" || status === "approved" || status === "fulfilled")
    return "quoted";
  const allDone = items.length > 0 && items.every((it) => isRowComplete(it));
  return allDone ? "quoted" : "needs_quote";
}

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

const ReceiveDrawer = dynamic(
  () => import("@/features/parts/components/ReceiveDrawer"),
  {
    ssr: false,
  },
);

type Opt = { value: string; label: string };

function normalizeName(s: string): string {
  return s.trim().replace(/\s+/g, " ");
}

function lineLabelFrom(line?: LineLite): string {
  if (!line) return "";
  const a = String(line.description ?? "").trim();
  if (a) return a;
  const b = String(line.complaint ?? "").trim();
  return b;
}

export default function PartsRequestsForWorkOrderPage(): JSX.Element {
  const { id: routeId } = useParams<{ id: string }>();
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [wo, setWo] = useState<WorkOrderRow | null>(null);
  const [lineById, setLineById] = useState<Map<string, LineLite>>(
    () => new Map(),
  );
  const [requests, setRequests] = useState<RequestUi[]>([]);
  const [parts, setParts] = useState<PartRow[]>([]);
  const [locations, setLocations] = useState<LocationRow[]>([]);
  const [defaultLocationId, setDefaultLocationId] = useState<string>("");

  const [pos, setPOs] = useState<PurchaseOrderRow[]>([]);
  const [suppliers, setSuppliers] = useState<SupplierRow[]>([]);
  const [selectedPo, setSelectedPo] = useState<string>("");

  const [loading, setLoading] = useState<boolean>(true);
  const [savingReqId, setSavingReqId] = useState<string | null>(null);
  const [savingItemId, setSavingItemId] = useState<string | null>(null);

  // Drawer
  const [recvOpen, setRecvOpen] = useState<boolean>(false);
  const [recvItem, setRecvItem] = useState<DrawerItem | null>(null);

  // ---- Theme (glass + burnt copper / metallic; no orange-400/500) ----
  const COPPER_BORDER = "border-[#8b5a2b]/60";
  const COPPER_TEXT = "text-[#c88a4d]";
  const COPPER_TEXT_SOFT = "text-[#b27a45]";
  const COPPER_HOVER_BG = "hover:bg-[#8b5a2b]/10";
  const COPPER_FOCUS_RING = "focus:ring-2 focus:ring-[#8b5a2b]/35";

  const pageWrap = "space-y-4 p-6 text-white";
  const glassCard =
    "rounded-xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset]";
  const glassHeader =
    "bg-gradient-to-b from-white/5 to-transparent border-b border-white/10";
  const inputBase = `rounded-lg border bg-neutral-950/40 px-3 py-2 text-sm text-white placeholder:text-neutral-500 border-white/10 focus:outline-none ${COPPER_FOCUS_RING}`;
  const selectBase = `rounded-lg border bg-neutral-950/40 px-2 py-2 text-xs text-white border-white/10 focus:outline-none ${COPPER_FOCUS_RING}`;

  const btnBase =
    "inline-flex items-center justify-center rounded-lg border px-3 py-2 text-sm transition disabled:opacity-60";
  const btnGhost = `${btnBase} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
  const btnCopper = `${btnBase} ${COPPER_BORDER} ${COPPER_TEXT} bg-neutral-950/20 ${COPPER_HOVER_BG}`;
  const btnDanger = `${btnBase} border-red-900/60 bg-neutral-950/20 text-red-200 hover:bg-red-900/20`;

  const pillBase =
    "inline-flex items-center whitespace-nowrap rounded-full border px-3 py-1 text-xs font-medium";
  const pillNeedsQuote = `${pillBase} border-red-500/35 bg-red-950/35 text-red-200`;
  const pillQuoted = `${pillBase} border-teal-500/35 bg-teal-950/25 text-teal-200`;

  const supplierNameById = useMemo(() => {
    const m = new Map<string, string>();
    for (const s of suppliers) {
      const id = String(s.id);
      const nm =
        typeof s.name === "string" && s.name.trim()
          ? s.name.trim()
          : id.slice(0, 8);
      m.set(id, nm);
    }
    return m;
  }, [suppliers]);

  const poLabelById = useMemo(() => {
    const m = new Map<string, string>();
    for (const po of pos) {
      const id = String(po.id);
      const supplierId = (po.supplier_id as string | null) ?? null;
      const supplierName = supplierId
        ? supplierNameById.get(String(supplierId)) ??
          String(supplierId).slice(0, 8)
        : "—";
      const st = String(po.status ?? "open");
      m.set(id, `${id.slice(0, 8)} • ${supplierName} • ${st}`);
    }
    return m;
  }, [pos, supplierNameById]);

  async function resolveWorkOrder(
    idOrCustom: string,
  ): Promise<WorkOrderRow | null> {
    const raw = (idOrCustom ?? "").trim();
    if (!raw) return null;

    if (looksLikeUuid(raw)) {
      const { data, error } = await supabase
        .from("work_orders")
        .select("*")
        .eq("id", raw)
        .maybeSingle();
      if (!error && data) return data as WorkOrderRow;
    }

    {
      const { data } = await supabase
        .from("work_orders")
        .select("*")
        .eq("custom_id", raw)
        .maybeSingle();
      if (data) return data as WorkOrderRow;
    }

    {
      const { data } = await supabase
        .from("work_orders")
        .select("*")
        .ilike("custom_id", raw.toUpperCase())
        .maybeSingle();
      if (data) return data as WorkOrderRow;
    }

    {
      const { prefix, n } = splitCustomId(raw);
      if (n != null) {
        const { data: cands } = await supabase
          .from("work_orders")
          .select("*")
          .ilike("custom_id", `${prefix}%`)
          .limit(50);
        const wanted = `${prefix}${n}`;
        const match = (cands ?? []).find((r) => {
          const cid = (r.custom_id ?? "")
            .toUpperCase()
            .replace(/^([A-Z]+)0+/, "$1");
          return cid === wanted;
        });
        if (match) return match as WorkOrderRow;
      }
    }

    return null;
  }

  async function load(): Promise<void> {
    setLoading(true);

    const woRow = await resolveWorkOrder(routeId);
    if (!woRow) {
      setWo(null);
      setLineById(new Map());
      setRequests([]);
      setParts([]);
      setLocations([]);
      setDefaultLocationId("");
      setPOs([]);
      setSuppliers([]);
      setSelectedPo("");
      setLoading(false);
      return;
    }

    setWo(woRow);

    const { data: reqs, error: reqErr } = await supabase
      .from("part_requests")
      .select("*")
      .eq("work_order_id", woRow.id)
      .order("created_at", { ascending: false });

    if (reqErr) toast.error(reqErr.message);

    const reqList = (reqs ?? []) as RequestRow[];
    const reqIds = reqList.map((r) => r.id);

    const itemsByRequest: Record<string, ItemRow[]> = {};
    if (reqIds.length) {
      const { data: items, error: itErr } = await supabase
        .from("part_request_items")
        .select("*")
        .in("request_id", reqIds);
      if (itErr) toast.error(itErr.message);

      for (const it of (items ?? []) as ItemRow[]) {
        (itemsByRequest[it.request_id] ||= []).push(it);
      }
    }

    const uiRequests: RequestUi[] = reqList.map((r) => {
      const itemRows = itemsByRequest[r.id] ?? [];
      const uiItems: UiItem[] = itemRows
        .sort((a, b) => String(a.id).localeCompare(String(b.id)))
        .map((row) => {
          const sell =
            row.quoted_price == null ? undefined : toNum(row.quoted_price, 0);
          const poId =
            (row as unknown as { po_id?: string | null }).po_id ?? null;
          return {
            ...row,
            ui_part_id: row.part_id ?? null,
            ui_qty: toNum(row.qty, 1),
            ui_price: sell,
            ui_added: false,
            ui_po_id: poId ? String(poId) : "",
          };
        });

      return { req: r, items: uiItems };
    });

    setRequests(uiRequests);

    // ✅ Load job complaint/description for each request's line (for UI + prefills)
    {
      const lineIds = new Set<string>();

      for (const r of uiRequests) {
        const id = resolveWorkOrderLineId(r.req, r.items);
        if (id && isUuid(id)) lineIds.add(id);
      }

      if (lineIds.size > 0) {
        const { data: lines, error: lErr } = await supabase
          .from("work_order_lines")
          .select("id, complaint, description")
          .in("id", Array.from(lineIds));

        if (lErr) {
          toast.warning(lErr.message);
          setLineById(new Map());
        } else {
          const m = new Map<string, LineLite>();
          for (const l of (lines ?? []) as LineLite[]) {
            m.set(String(l.id), l);
          }
          setLineById(m);
        }
      } else {
        setLineById(new Map());
      }
    }

    const shopId = woRow.shop_id ?? null;
    if (shopId) {
      const [{ data: ps }, { data: locs }, { data: poRows }, { data: supRows }] =
        await Promise.all([
          supabase
            .from("parts")
            .select("*")
            .eq("shop_id", shopId)
            .order("name")
            .limit(1000),
          supabase
            .from("stock_locations")
            .select("*")
            .eq("shop_id", shopId)
            .order("code"),
          supabase
            .from("purchase_orders")
            .select("*")
            .eq("shop_id", shopId)
            .order("created_at", { ascending: false })
            .limit(200),
          supabase
            .from("suppliers")
            .select("*")
            .eq("shop_id", shopId)
            .order("name", { ascending: true })
            .limit(500),
        ]);

      setParts((ps ?? []) as PartRow[]);

      const locList = (locs ?? []) as LocationRow[];
      setLocations(locList);

      const main = locList.find(
        (l) => String(l.code ?? "").toUpperCase() === "MAIN",
      );
      const chosen = main?.id
        ? String(main.id)
        : locList[0]?.id
          ? String(locList[0].id)
          : "";
      setDefaultLocationId(chosen);

      setPOs((poRows ?? []) as PurchaseOrderRow[]);
      setSuppliers((supRows ?? []) as SupplierRow[]);

      if (
        selectedPo &&
        !(poRows ?? []).some((p) => String(p.id) === selectedPo)
      )
        setSelectedPo("");
    } else {
      setParts([]);
      setLocations([]);
      setDefaultLocationId("");
      setPOs([]);
      setSuppliers([]);
      setSelectedPo("");
    }

    setLoading(false);
  }

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [routeId]);

  useEffect(() => {
    const handler = () => void load();
    window.addEventListener("parts:received", handler as EventListener);
    return () =>
      window.removeEventListener("parts:received", handler as EventListener);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [routeId]);

  function updateItem(
    reqId: string,
    itemId: string,
    patch: Partial<UiItem>,
  ): void {
    setRequests((prev) =>
      prev.map((r) => {
        if (r.req.id !== reqId) return r;
        return {
          ...r,
          items: r.items.map((it) =>
            it.id === itemId ? ({ ...it, ...patch } as UiItem) : it,
          ),
        };
      }),
    );
  }

  async function addRow(reqId: string): Promise<void> {
    const target = requests.find((r) => r.req.id === reqId);
    if (!target) return;

    setSavingReqId(reqId);
    try {
      const lineId = resolveWorkOrderLineId(target.req, target.items);
      const lineText =
        lineId && isUuid(lineId) ? lineLabelFrom(lineById.get(lineId)) : "";

      const insertPayload: DB["public"]["Tables"]["part_request_items"]["Insert"] =
        {
          request_id: target.req.id,
          work_order_line_id: lineId,
          description: lineText ? `(${lineText})` : "",
          qty: 1,
          quoted_price: null,
          vendor: null,
          part_id: null,
          // po_id intentionally omitted; set by per-item PO flow
        };

      const { data, error } = await supabase
        .from("part_request_items")
        .insert(insertPayload)
        .select("*")
        .maybeSingle<ItemRow>();

      if (error) {
        toast.error(error.message);
        return;
      }
      if (!data) {
        toast.error("Could not create a new item.");
        return;
      }

      const poId =
        (data as unknown as { po_id?: string | null }).po_id ?? null;

      const ui: UiItem = {
        ...data,
        ui_part_id: data.part_id ?? null,
        ui_qty: toNum(data.qty, 1),
        ui_price:
          data.quoted_price == null ? undefined : toNum(data.quoted_price, 0),
        ui_added: false,
        ui_po_id: poId ? String(poId) : "",
      };

      setRequests((prev) =>
        prev.map((r) =>
          r.req.id === reqId ? { ...r, items: [...r.items, ui] } : r,
        ),
      );
    } finally {
      setSavingReqId(null);
    }
  }

  async function deleteLine(reqId: string, itemId: string): Promise<void> {
    const ok = window.confirm("Remove this item from the request?");
    if (!ok) return;

    const { data: deleted, error } = await supabase
      .from("part_request_items")
      .delete()
      .eq("id", itemId)
      .select("id")
      .maybeSingle();

    if (error) {
      toast.error(error.message);
      return;
    }
    if (!deleted?.id) {
      toast.error("Not permitted to delete this item (RLS).");
      return;
    }

    setRequests((prev) =>
      prev.map((r) =>
        r.req.id === reqId
          ? { ...r, items: r.items.filter((x) => x.id !== itemId) }
          : r,
      ),
    );
    toast.success("Item removed.");
  }

  function openReceiveFor(reqId: string, it: UiItem): void {
    const partId = (it.part_id ?? it.ui_part_id ?? null) as string | null;
    const part = partId
      ? parts.find((p) => String(p.id) === String(partId)) ?? null
      : null;

    const approved = n(
      (it as unknown as { qty_approved?: unknown }).qty_approved,
    );
    const received = n(
      (it as unknown as { qty_received?: unknown }).qty_received,
    );
    const remaining = Math.max(0, approved - received);

    setRecvItem({
      id: String(it.id),
      created_at: it.created_at ?? null,
      request_id: reqId,
      part_id: partId,
      description: String(it.description ?? ""),
      status: String((it as unknown as { status?: unknown }).status ?? ""),
      qty_approved: approved,
      qty_received: received,
      qty_remaining: remaining,
      part_name: part?.name ? String(part.name) : null,
      sku: part?.sku ? String(part.sku) : null,
    });
    setRecvOpen(true);
  }

  async function setItemPo(
    itemId: string,
    poId: string | null,
  ): Promise<boolean> {
    // ✅ Validate uuid (prevents PostgREST 400 on uuid cast)
    if (poId && !isUuid(poId)) {
      toast.error("Invalid PO id.");
      return false;
    }

    setSavingItemId(itemId);
    try {
      // po_id exists in DB only if you added it; we still send it and rely on DB types at runtime.
      const { data: updated, error } = await supabase
        .from("part_request_items")
        .update(
          { po_id: poId } as unknown as DB["public"]["Tables"]["part_request_items"]["Update"],
        )
        .eq("id", itemId)
        .select("id")
        .maybeSingle();

      if (error) {
        toast.error(error.message);
        return false;
      }
      if (!updated?.id) {
        toast.error("Update did not apply (no matching row or blocked).");
        return false;
      }

      // update UI state
      setRequests((prev) =>
        prev.map((r) => ({
          ...r,
          items: r.items.map((it) =>
            String(it.id) === String(itemId)
              ? ({
                  ...it,
                  ui_po_id: poId ?? "",
                  // keep raw column in sync for any other logic that reads it
                  po_id: poId ?? null,
                } as UiItem)
              : it,
          ),
        })),
      );

      return true;
    } finally {
      setSavingItemId(null);
    }
  }

  async function ensureSupplierExists(
   // CONTINUE FROM HERE (starting at ensureSupplierExists)

    shopId: string,
    supplierName: string,
  ): Promise<string | null> {
    const name = normalizeName(supplierName);
    if (!name) return null;

    // Try exact match
    const { data: existing } = await supabase
      .from("suppliers")
      .select("id, name")
      .eq("shop_id", shopId)
      .ilike("name", name)
      .maybeSingle();

    if (existing?.id) return String(existing.id);

    // Create (accept new entry)
    const { data: created, error: cErr } = await supabase
      .from("suppliers")
      .insert(
        {
          shop_id: shopId,
          name,
        } as unknown as DB["public"]["Tables"]["suppliers"]["Insert"],
      )
      .select("id")
      .single();

    if (cErr) {
      toast.error(cErr.message);
      return null;
    }

    return created?.id ? String(created.id) : null;
  }

  async function createPoForSupplier(
    shopId: string,
    supplierId: string | null,
    notes?: string,
  ): Promise<string | null> {
    const insert = {
      shop_id: shopId,
      supplier_id: supplierId,
      status: "open",
      notes: notes?.trim() ? notes.trim() : null,
    };

    const { data, error } = await supabase
      .from("purchase_orders")
      .insert(
        insert as unknown as DB["public"]["Tables"]["purchase_orders"]["Insert"],
      )
      .select("*")
      .single();

    if (error) {
      toast.error(error.message);
      return null;
    }

    const id = data?.id ? String(data.id) : null;
    if (!id) return null;

    // refresh local PO list (no extra routes)
    setPOs((prev) => [data as PurchaseOrderRow, ...prev]);
    return id;
  }

  async function createOrReusePoAndAssign(
    item: UiItem,
    supplierId: string,
    reuseExistingPoId?: string | null,
  ): Promise<void> {
    if (!wo?.shop_id) {
      toast.error("Missing shop_id.");
      return;
    }

    const shopId = String(wo.shop_id);
    const sid = String(supplierId);

    // Rule: one PO per vendor (per work order) => reuse if one already exists
    const existingForVendor = pos.find(
      (p) =>
        String(p.supplier_id ?? "") === sid &&
        String(p.status ?? "open").toLowerCase() !== "received",
    );

    const useId = reuseExistingPoId?.trim()
      ? reuseExistingPoId.trim()
      : existingForVendor?.id
        ? String(existingForVendor.id)
        : null;

    if (useId && !isUuid(useId)) {
      toast.error("Invalid PO id.");
      return;
    }

    const poId =
      useId ??
      (await createPoForSupplier(
        shopId,
        sid,
        `Auto-created from request ${String(item.request_id ?? "").slice(0, 8)}`,
      ));
    if (!poId) return;

    const ok = await setItemPo(String(item.id), poId);
    if (!ok) return;

    toast.success(`Assigned PO ${poId.slice(0, 8)}.`);
  }

  async function addAndAttach(reqId: string, itemId: string): Promise<void> {
    const target = requests.find((r) => r.req.id === reqId);
    const it = target?.items.find((x) => x.id === itemId);
    if (!target || !it) return;

    const partId = it.ui_part_id;
    const qty = toNum(it.ui_qty, 0);
    const price = it.ui_price;

    if (!partId) {
      toast.error("Pick a stock part first.");
      return;
    }
    if (!isUuid(partId)) {
      toast.error("Invalid part id (must be a UUID).");
      return;
    }
    if (!qty || qty <= 0) {
      toast.error("Enter a quantity greater than 0.");
      return;
    }
    if (price == null || !Number.isFinite(price)) {
      toast.error("Price is missing.");
      return;
    }

    const lineId = resolveWorkOrderLineId(target.req, target.items);
    if (!lineId) {
      toast.error("Missing or invalid work order line id (must be a UUID).");
      return;
    }

    const locId = defaultLocationId || "";

    setSavingReqId(reqId);
    try {
      const part = parts.find((p) => String(p.id) === String(partId));
      const desc = (part?.name ?? it.description ?? "").trim();

      const poId = it.ui_po_id?.trim() ? it.ui_po_id.trim() : null;
      if (poId && !isUuid(poId)) {
        toast.error("Invalid PO id (must be a UUID).");
        return;
      }

      // ✅ work_order_line_id must be UUID (avoid passing legacy strings)
      const safeLineId = isUuid(it.work_order_line_id)
        ? it.work_order_line_id
        : lineId;

      const payload = {
        part_id: partId,
        description: desc || it.description || "Part",
        qty,
        quoted_price: price,
        vendor: null,
        markup_pct: null,
        work_order_line_id: safeLineId,
        ...(poId ? { po_id: poId } : {}),
      } as unknown as DB["public"]["Tables"]["part_request_items"]["Update"];

      // ✅ select to detect “no row updated” and avoid silent failures
      const { data: updated, error: updErr } = await supabase
        .from("part_request_items")
        .update(payload)
        .eq("id", it.id)
        .select("id")
        .maybeSingle();

      if (updErr) {
        toast.error(updErr.message);
        return;
      }
      if (!updated?.id) {
        toast.error("Update did not apply (no matching row or blocked).");
        return;
      }

      if (locId) {
        const { error } = await supabase.rpc(
          "upsert_part_allocation_from_request_item",
          {
            p_request_item_id: it.id,
            p_location_id: locId,
            p_create_stock_move: true,
          },
        );

        if (error) {
          toast.error(error.message);
          return;
        }
      } else {
        toast.warning(
          "No stock location exists for this shop. Item saved, but inventory was not allocated.",
        );
      }

      const nextItems = target.items.map((x) => {
        if (x.id !== itemId) return x;
        return {
          ...x,
          part_id: partId,
          quoted_price: price,
          qty,
          work_order_line_id: safeLineId,
          ui_added: true,
          ui_po_id: poId ?? "",
          po_id: poId ?? null,
        } as UiItem;
      });

      const allNowQuoted =
        nextItems.length > 0 && nextItems.every((x) => isRowComplete(x));

      setRequests((prev) =>
        prev.map((r) =>
          r.req.id !== reqId
            ? r
            : {
                req: {
                  ...r.req,
                  status: allNowQuoted ? "quoted" : (r.req.status ?? "requested"),
                },
                items: r.items.map((x) =>
                  x.id !== itemId
                    ? x
                    : ({
                        ...x,
                        part_id: partId,
                        quoted_price: price,
                        qty,
                        work_order_line_id: safeLineId,
                        ui_added: true,
                        ui_po_id: poId ?? "",
                        po_id: poId ?? null,
                      } as UiItem),
                ),
              },
        ),
      );

      if (allNowQuoted) {
        const { error: statusErr } = await supabase.rpc(
          "set_part_request_status",
          {
            p_request: reqId,
            p_status: "quoted" satisfies Status,
          },
        );
        if (statusErr) toast.warning(statusErr.message);
      }

      window.dispatchEvent(new Event("parts-request:submitted"));
      window.dispatchEvent(new Event("wo:parts-used"));

      try {
        const res = await fetch("/api/menu-items/upsert-from-line", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderLineId: safeLineId }),
        });

        const j = (await res.json().catch(() => null)) as UpsertResponse | null;

        if (!res.ok || !j?.ok) {
          toast.warning(
            j?.detail || j?.error || "Added, but couldn’t save to menu items.",
          );
        }
      } catch {
        // ignore
      }

      toast.success("Added to the work order line.");
    } finally {
      setSavingReqId(null);
    }
  }

  const woDisplay = wo?.custom_id || (wo?.id ? `#${wo.id.slice(0, 8)}` : null);

  const locOptions: Opt[] = locations.map((l) => ({
    value: String(l.id),
    label: `${String(l.code ?? "LOC")} — ${String(l.name ?? "")}`,
  }));

  const poOptions: Opt[] = pos.map((po) => ({
    value: String(po.id),
    label:
      poLabelById.get(String(po.id)) ??
      `${String(po.id).slice(0, 8)} • ${String(po.status ?? "open")}`,
  }));

  const resolvedDefaultLocId = defaultLocationId || locOptions[0]?.value || "";

  // Supplier options (for quick-create per item)
  const supplierOptions: Opt[] = suppliers.map((s) => ({
    value: String(s.id),
    label: String(s.name ?? String(s.id).slice(0, 8)),
  }));

  return (
    <div className={pageWrap}>
      <button className={btnGhost} onClick={() => router.back()} type="button">
        ← Back
      </button>

      {loading ? (
        <div className={`${glassCard} p-4 text-neutral-300`}>Loading…</div>
      ) : !wo ? (
        <div className={`${glassCard} p-4 text-neutral-300`}>
          Work order not found / not visible.
        </div>
      ) : (
        <>
          <div className={`${glassCard} overflow-hidden`}>
            <div className={`${glassHeader} px-5 py-4`}>
              <div className="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <div className="text-xl font-semibold tracking-wide">
                    Work Order <span className={COPPER_TEXT}>{woDisplay}</span>
                  </div>
                  <div className="mt-1 text-sm text-neutral-400">
                    Parts requests for this work order.
                  </div>
                </div>

                {/* Optional PO selector (for receive drawer default) */}
                <div className="flex items-center gap-2">
                  <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-500">
                    PO
                  </div>
                  <select
                    className={`${selectBase} w-72`}
                    value={selectedPo}
                    onChange={(e) => setSelectedPo(e.target.value)}
                    title="Optional: choose PO to apply receiving against"
                  >
                    <option value="">— none —</option>
                    {pos.map((po) => (
                      <option key={String(po.id)} value={String(po.id)}>
                        {poLabelById.get(String(po.id)) ??
                          `${String(po.id).slice(0, 8)} • ${String(po.status ?? "open")}`}
                      </option>
                    ))}
                  </select>
                </div>
              </div>

              <div className="mt-3 text-xs text-neutral-400">
                Add parts to attach them to the work order line. The request becomes{" "}
                <span className={COPPER_TEXT_SOFT}>quoted</span> automatically once
                every row has a part + qty + price.
              </div>
            </div>
          </div>

          {requests.length === 0 ? (
            <div className={`${glassCard} p-4 text-neutral-400`}>
              No parts requests for this work order yet.
            </div>
          ) : (
            <div className="space-y-4">
              {requests.map((r) => {
                const badge = computeRequestBadge(r.req, r.items);
                const busy = savingReqId === r.req.id;

                const lineId = resolveWorkOrderLineId(r.req, r.items);
                const jobText =
                  lineId && isUuid(lineId)
                    ? lineLabelFrom(lineById.get(lineId))
                    : "";

                return (
                  <div key={r.req.id} className={`${glassCard} overflow-hidden`}>
                    <div className={`${glassHeader} px-5 py-4`}>
                      <div className="flex flex-wrap items-start justify-between gap-3">
                        <div>
                          <div className="text-sm font-semibold">
                            Request{" "}
                            <span className={COPPER_TEXT}>
                              #{r.req.id.slice(0, 8)}
                            </span>
                          </div>

                          <div className="mt-1 text-xs text-neutral-400">
                            Created{" "}
                            {r.req.created_at
                              ? new Date(r.req.created_at).toLocaleString()
                              : "—"}
                            <span className="mx-2 text-neutral-600">·</span>
                            Line: {lineId ? lineId.slice(0, 8) : "—"}
                          </div>

                          {jobText ? (
                            <div className="mt-1 text-xs text-neutral-500">
                              Job:{" "}
                              <span className="text-neutral-300">{jobText}</span>
                            </div>
                          ) : null}
                        </div>

                        <div className="flex items-center gap-2">
                          <span
                            className={
                              badge === "needs_quote" ? pillNeedsQuote : pillQuoted
                            }
                          >
                            {badge === "needs_quote" ? "Needs quote" : "Quoted"}
                          </span>

                          <button
                            className={btnGhost}
                            onClick={() => void addRow(r.req.id)}
                            disabled={busy}
                            type="button"
                          >
                            {busy ? "Working…" : "＋ Add part row"}
                          </button>
                        </div>
                      </div>
                    </div>

                    <div className="p-4">
                      <div className="overflow-hidden rounded-xl border border-white/10 bg-neutral-950/20">
                        <table className="w-full text-sm">
                          <thead className="bg-white/5 text-neutral-400">
                            <tr>
                              <th className="p-3 text-left">Requested part</th>
                              <th className="p-3 text-right">Qty</th>
                              <th className="p-3 text-right">Price (unit)</th>
                              <th className="p-3 text-left">PO</th>
                              <th className="p-3 text-right">Line total</th>
                              <th className="w-[260px] p-3" />
                            </tr>
                          </thead>

                          <tbody>
                            {r.items.length === 0 ? (
                              <tr className="border-t border-white/10">
                                <td
                                  className="p-4 text-sm text-neutral-500"
                                  colSpan={6}
                                >
                                  No items yet. Click “Add part row”.
                                </td>
                              </tr>
                            ) : (
                              r.items.map((it) => {
                                const rowBusy =
                                  busy || savingItemId === String(it.id);

                                const qty = toNum(it.ui_qty, 0);
                                const price = it.ui_price ?? 0;
                                const lineTotal = qty > 0 ? price * qty : 0;

                                const approved = n(
                                  (it as unknown as { qty_approved?: unknown })
                                    .qty_approved,
                                );
                                const received = n(
                                  (it as unknown as { qty_received?: unknown })
                                    .qty_received,
                                );
                                const remaining = Math.max(0, approved - received);

                                const effectivePartId = (it.part_id ??
                                  it.ui_part_id ??
                                  null) as string | null;
                                const canReceive =
                                  !!effectivePartId &&
                                  approved > 0 &&
                                  remaining > 0 &&
                                  !!resolvedDefaultLocId;

                                const uiPoId = (it.ui_po_id ?? "").trim();
                                const poLabel = uiPoId
                                  ? poLabelById.get(uiPoId) ?? uiPoId.slice(0, 8)
                                  : "";

                                return (
                                  <tr
                                    key={String(it.id)}
                                    className="border-t border-white/10"
                                  >
                                    {/* ✅ Bigger request description ABOVE stock-part selector */}
                                    <td className="p-3 align-top">
                                      <div className="grid gap-2">
                                        <textarea
                                          className={`${inputBase} w-full py-2 text-xs`}
                                          value={it.description ?? ""}
                                          placeholder="Requested part / notes (ex: Front spring & spring attachment)"
                                          onChange={(e) =>
                                            updateItem(r.req.id, String(it.id), {
                                              description: e.target.value,
                                            })
                                          }
                                          disabled={rowBusy}
                                          rows={2}
                                        />

                                        <select
                                          className={`${selectBase} w-full`}
                                          value={it.ui_part_id ?? ""}
                                          onChange={(e) => {
                                            const nextPartId =
                                              e.target.value || null;
                                            const p = parts.find(
                                              (x) =>
                                                String(x.id) === String(nextPartId),
                                            );

                                            // ✅ do NOT clobber user's typed request; only fill if empty
                                            const currentDesc = String(
                                              it.description ?? "",
                                            ).trim();

                                            updateItem(r.req.id, String(it.id), {
                                              ui_part_id: nextPartId,
                                              description: currentDesc
                                                ? it.description
                                                : (p?.name ??
                                                    it.description ??
                                                    "").trim(),
                                              ui_price:
                                                p?.price == null
                                                  ? undefined
                                                  : toNum(p.price, 0),
                                            });
                                          }}
                                          disabled={rowBusy}
                                        >
                                          <option value="">— select —</option>
                                          {parts.map((p) => (
                                            <option
                                              key={String(p.id)}
                                              value={String(p.id)}
                                            >
                                              {p.sku ? `${p.sku} — ${p.name}` : p.name}
                                            </option>
                                          ))}
                                        </select>

                                        {approved > 0 ? (
                                          <div className="text-[11px] text-neutral-500">
                                            Approved{" "}
                                            <span className="text-neutral-200">
                                              {approved}
                                            </span>{" "}
                                            <span className="text-neutral-600">·</span>{" "}
                                            Received{" "}
                                            <span className="text-neutral-200">
                                              {received}
                                            </span>{" "}
                                            <span className="text-neutral-600">·</span>{" "}
                                            Remaining{" "}
                                            <span className="text-neutral-200">
                                              {remaining}
                                            </span>
                                          </div>
                                        ) : null}
                                      </div>
                                    </td>

                                    <td className="p-3 text-right align-top">
                                      <input
                                        type="number"
                                        min={1}
                                        step={1}
                                        className={`${inputBase} w-20 py-2 text-right text-xs`}
                                        value={
                                          Number.isFinite(it.ui_qty)
                                            ? String(it.ui_qty)
                                            : "1"
                                        }
                                        onChange={(e) => {
                                          const raw = e.target.value;
                                          const nextQty =
                                            raw === ""
                                              ? 1
                                              : Math.max(
                                                  1,
                                                  Math.floor(toNum(raw, 1)),
                                                );
                                          updateItem(r.req.id, String(it.id), {
                                            ui_qty: nextQty,
                                          });
                                        }}
                                        disabled={rowBusy}
                                      />
                                    </td>

                                    <td className="p-3 text-right align-top">
                                      <input
                                        type="number"
                                        step={0.01}
                                        className={`${inputBase} w-28 py-2 text-right text-xs`}
                                        value={
                                          it.ui_price == null ? "" : String(it.ui_price)
                                        }
                                        onChange={(e) => {
                                          const raw = e.target.value;
                                          updateItem(r.req.id, String(it.id), {
                                            ui_price:
                                              raw === "" ? undefined : toNum(raw, 0),
                                          });
                                        }}
                                        disabled={rowBusy}
                                      />
                                    </td>

                                    {/* PO column */}
                                    <td className="p-3 align-top">
                                      <div className="grid gap-2">
                                        <select
                                          className={`${selectBase} w-[260px]`}
                                          value={uiPoId}
                                          onChange={(e) => {
                                            const next = e.target.value || "";
                                            updateItem(r.req.id, String(it.id), {
                                              ui_po_id: next,
                                            });
                                            void setItemPo(
                                              String(it.id),
                                              next ? next : null,
                                            );
                                          }}
                                          disabled={rowBusy}
                                          title="Assign this request item to a PO"
                                        >
                                          <option value="">— no PO —</option>
                                          {pos.map((po) => (
                                            <option
                                              key={String(po.id)}
                                              value={String(po.id)}
                                            >
                                              {poLabelById.get(String(po.id)) ??
                                                `${String(po.id).slice(0, 8)} • ${String(
                                                  po.status ?? "open",
                                                )}`}
                                            </option>
                                          ))}
                                        </select>

                                        <details className="rounded-xl border border-white/10 bg-neutral-950/20 px-3 py-2">
                                          <summary className="cursor-pointer select-none text-xs text-neutral-300">
                                            Create PO for supplier
                                          </summary>

                                          <div className="mt-2 grid gap-2">
                                            <div className="text-[11px] text-neutral-500">
                                              Rule: one PO per supplier. If one exists
                                              (not received), we reuse it.
                                            </div>

                                            <select
                                              className={selectBase}
                                              value={it.ui_supplier_id ?? ""}
                                              onChange={(e) =>
                                                updateItem(r.req.id, String(it.id), {
                                                  ui_supplier_id:
                                                    e.target.value || "",
                                                })
                                              }
                                              disabled={rowBusy}
                                            >
                                              <option value="">— choose supplier —</option>
                                              {supplierOptions.map((o) => (
                                                <option key={o.value} value={o.value}>
                                                  {o.label}
                                                </option>
                                              ))}
                                            </select>

                                            <div className="flex items-center gap-2">
                                              <input
                                                className={`${inputBase} flex-1 py-2 text-xs`}
                                                placeholder="Or type new supplier name…"
                                                onChange={(e) =>
                                                  updateItem(r.req.id, String(it.id), {
                                                    ui_supplier_id: `__new__:${e.target.value}`,
                                                  })
                                                }
                                                disabled={rowBusy}
                                              />
                                            </div>

                                            <button
                                              className={`${btnCopper} py-2 text-xs`}
                                              type="button"
                                              disabled={rowBusy}
                                              onClick={async () => {
                                                if (!wo?.shop_id) return;

                                                const raw = String(
                                                  it.ui_supplier_id ?? "",
                                                ).trim();
                                                if (!raw) {
                                                  toast.error(
                                                    "Choose a supplier or type a new one.",
                                                  );
                                                  return;
                                                }

                                                let supplierId: string | null = null;

                                                if (raw.startsWith("__new__:")) {
                                                  const name = raw.replace(
                                                    "__new__:",
                                                    "",
                                                  );
                                                  supplierId =
                                                    await ensureSupplierExists(
                                                      String(wo.shop_id),
                                                      name,
                                                    );
                                                } else {
                                                  supplierId = raw;
                                                }

                                                if (!supplierId) return;

                                                await createOrReusePoAndAssign(
                                                  it,
                                                  supplierId,
                                                  null,
                                                );
                                              }}
                                            >
                                              Create / Reuse PO & Assign
                                            </button>

                                            {poLabel ? (
                                              <div className="text-[11px] text-neutral-500">
                                                Currently assigned:{" "}
                                                <span className="text-neutral-200">
                                                  {poLabel}
                                                </span>
                                              </div>
                                            ) : null}
                                          </div>
                                        </details>
                                      </div>
                                    </td>

                                    <td className="p-3 text-right tabular-nums align-top">
                                      {lineTotal.toFixed(2)}
                                    </td>

                                    <td className="p-3 align-top">
                                      <div className="flex flex-col items-stretch gap-2">
                                        <button
                                          className={`${btnCopper} py-2 text-xs`}
                                          onClick={() =>
                                            void addAndAttach(r.req.id, String(it.id))
                                          }
                                          disabled={rowBusy}
                                          type="button"
                                        >
                                          {rowBusy ? "Saving…" : "Add"}
                                        </button>

                                        <button
                                          className={btnGhost}
                                          onClick={() => openReceiveFor(r.req.id, it)}
                                          disabled={rowBusy || !canReceive}
                                          type="button"
                                          title={
                                            !resolvedDefaultLocId
                                              ? "No stock locations exist for this shop"
                                              : canReceive
                                                ? "Receive against this request item"
                                                : "Needs qty_approved > qty_received and a selected part"
                                          }
                                        >
                                          Receive…
                                        </button>

                                        <button
                                          className={`${btnDanger} py-2 text-xs`}
                                          onClick={() =>
                                            void deleteLine(r.req.id, String(it.id))
                                          }
                                          disabled={rowBusy}
                                          type="button"
                                        >
                                          Delete
                                        </button>
                                      </div>
                                    </td>
                                  </tr>
                                );
                              })
                            )}
                          </tbody>
                        </table>
                      </div>

                      {locations.length === 0 && (
                        <div className="mt-3 text-xs text-neutral-500">
                          No stock locations exist for this shop, so inventory
                          allocation is skipped. Parts will still be saved to the
                          request item.
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </>
      )}

      <ReceiveDrawer
        open={recvOpen}
        item={recvItem}
        onClose={() => {
          setRecvOpen(false);
          setRecvItem(null);
          void load();
        }}
        locations={locOptions}
        defaultLocationId={resolvedDefaultLocId}
        purchaseOrders={poOptions}
        defaultPoId={selectedPo || ""}
        lockLocation={false}
        lockPo={false}
      />
    </div>
  );
}

==================== FILE: app/parts/requests/page.tsx ====================

// app/parts/requests/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type PartRequest = DB["public"]["Tables"]["part_requests"]["Row"];
type PartRequestItem = DB["public"]["Tables"]["part_request_items"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];

type BucketStatus =
  | "needs_quote"
  | "quoted"
  | "approved"
  | "fulfilled"
  | "mixed";

type WoBucket = {
  workOrderId: string;
  customId: string | null;
  status: BucketStatus;
  requests: PartRequest[];
  itemsCount: number;
  completeCount: number; // items complete (part+qty+price)
  completionPct: number; // 0..100
  latestAt: string | null;
  searchBlob: string; // request ids + item descriptions for search
};

const VISIBLE_STATUSES: PartRequest["status"][] = [
  "requested",
  "quoted",
  "approved",
  "fulfilled",
];

function looksLikeUuid(s: string): boolean {
  return s.includes("-") && s.length >= 36;
}

function toNum(v: unknown): number {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : 0;
}

function isCompleteItem(
  it: Pick<
    PartRequestItem,
    "part_id" | "qty" | "quoted_price" | "description"
  >,
): boolean {
  const hasPart = typeof it.part_id === "string" && it.part_id.length > 0;
  const qty = toNum(it.qty);
  const hasQty = qty > 0;
  const hasPrice =
    it.quoted_price != null && Number.isFinite(Number(it.quoted_price));
  // description is helpful, but not required for “complete”
  return hasPart && hasQty && hasPrice;
}

export default function PartsRequestsPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(true);
  const [search, setSearch] = useState("");
  const [statusFilter, setStatusFilter] = useState<
    "all" | "needs_quote" | "quoted" | "approved" | "fulfilled"
  >("all");

  const [buckets, setBuckets] = useState<WoBucket[]>([]);
  const [deletingWoId, setDeletingWoId] = useState<string | null>(null);

  // ---- Theme (glass + burnt copper / metallic; no orange-400/500) ----
  const COPPER_BORDER = "border-[#8b5a2b]/60";
  const COPPER_TEXT = "text-[#c88a4d]";
  const COPPER_HOVER_BG = "hover:bg-[#8b5a2b]/10";
  const COPPER_FOCUS_RING = "focus:ring-2 focus:ring-[#8b5a2b]/35";

  const PAGE = "w-full px-3 py-6 text-white sm:px-6 lg:px-10 xl:px-16";
  const CARD =
    "rounded-xl border border-white/10 bg-neutral-950/35 backdrop-blur-xl shadow-[0_0_0_1px_rgba(255,255,255,0.03)_inset]";
  const CARD_PAD = `${CARD} p-4`;
  const INPUT = `w-full rounded-lg border border-white/10 bg-neutral-950/40 px-4 py-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none ${COPPER_FOCUS_RING}`;
  const SELECT = `w-full rounded-lg border border-white/10 bg-neutral-950/40 px-3 py-2 text-sm text-white focus:outline-none ${COPPER_FOCUS_RING}`;
  const BTN_BASE =
    "inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-medium transition disabled:opacity-60";
  const BTN_GHOST = `${BTN_BASE} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
  const BTN_COPPER = `${BTN_BASE} ${COPPER_BORDER} ${COPPER_TEXT} bg-neutral-950/20 ${COPPER_HOVER_BG}`;
  const BTN_DANGER = `${BTN_BASE} border-red-500/30 bg-red-950/25 text-red-200 hover:bg-red-950/40`;

  const PILL_BASE =
    "inline-flex items-center whitespace-nowrap rounded-full border px-3 py-1 text-xs font-semibold";
  const PILL_NEEDS = `${PILL_BASE} border-red-500/35 bg-red-950/35 text-red-200`;
  const PILL_QUOTED = `${PILL_BASE} border-teal-500/35 bg-teal-950/25 text-teal-200`;
  const PILL_APPROVED = `${PILL_BASE} border-sky-500/35 bg-sky-950/25 text-sky-200`;
  const PILL_FULFILLED = `${PILL_BASE} border-emerald-500/35 bg-emerald-950/25 text-emerald-200`;
  const PILL_MIXED = `${PILL_BASE} ${COPPER_BORDER} bg-neutral-950/20 ${COPPER_TEXT}`;

  function pillFor(status: BucketStatus): string {
    if (status === "needs_quote") return PILL_NEEDS;
    if (status === "quoted") return PILL_QUOTED;
    if (status === "approved") return PILL_APPROVED;
    if (status === "fulfilled") return PILL_FULFILLED;
    return PILL_MIXED;
  }

  function labelFor(status: BucketStatus): string {
    if (status === "needs_quote") return "Needs quote";
    if (status === "quoted") return "Quoted";
    if (status === "approved") return "Approved";
    if (status === "fulfilled") return "Fulfilled";
    return "Mixed";
  }

  function computeBucketStatus(reqs: PartRequest[]): BucketStatus {
    const statuses = reqs.map((r) => String(r.status ?? "requested").toLowerCase());
    const uniq = Array.from(new Set(statuses));

    const hasRequested = uniq.includes("requested");
    const hasQuoted = uniq.includes("quoted");
    const hasApproved = uniq.includes("approved");
    const hasFulfilled = uniq.includes("fulfilled");

    // priority: requested -> needs_quote
    if (hasRequested) return "needs_quote";

    // if all fulfilled
    if (hasFulfilled && !hasApproved && !hasQuoted) return "fulfilled";
    if (hasFulfilled && hasApproved && !hasQuoted) return "mixed";
    if (hasFulfilled && hasQuoted) return "mixed";

    // if all approved (or mixture of approved+fulfilled will have returned mixed above)
    if (hasApproved && !hasQuoted) return "approved";

    // quoted-only
    if (hasQuoted && !hasApproved && !hasFulfilled) return "quoted";

    // fallback
    if (uniq.length === 1) {
      const only = uniq[0];
      if (only === "fulfilled") return "fulfilled";
      if (only === "approved") return "approved";
      if (only === "quoted") return "quoted";
      return "needs_quote";
    }

    return "mixed";
  }

  const reload = async (): Promise<void> => {
    setLoading(true);

    // 1) load active-ish part_requests
    const { data: reqs, error } = await supabase
      .from("part_requests")
      .select("*")
      .in("status", VISIBLE_STATUSES)
      .order("created_at", { ascending: false });

    if (error) {
      // eslint-disable-next-line no-console
      console.error("[parts/requests] load part_requests failed:", error);
      toast.error("Failed to load parts requests");
      setLoading(false);
      return;
    }

    const requestList = (reqs ?? []) as PartRequest[];

    // 2) load request items (counts + completion + search by description)
    const requestIds = requestList.map((r) => r.id);
    const itemsCountByRequest: Record<string, number> = {};
    const completeCountByRequest: Record<string, number> = {};
    const descByRequest: Record<string, string[]> = {};

    if (requestIds.length) {
      const { data: items, error: itemsErr } = await supabase
        .from("part_request_items")
        .select("request_id, description, part_id, qty, quoted_price")
        .in("request_id", requestIds);

      if (itemsErr) {
        // eslint-disable-next-line no-console
        console.error(
          "[parts/requests] load part_request_items failed:",
          itemsErr,
        );
      } else {
        (items ?? []).forEach((it) => {
          const row = it as Pick<
            PartRequestItem,
            "request_id" | "description" | "part_id" | "qty" | "quoted_price"
          >;

          itemsCountByRequest[row.request_id] =
            (itemsCountByRequest[row.request_id] ?? 0) + 1;

          if (isCompleteItem(row)) {
            completeCountByRequest[row.request_id] =
              (completeCountByRequest[row.request_id] ?? 0) + 1;
          }

          const d = (row.description ?? "").trim();
          if (d) (descByRequest[row.request_id] ||= []).push(d);
        });
      }
    }

    // 3) load work_orders for custom_id
    const woIds = Array.from(
      new Set(
        requestList
          .map((r) => r.work_order_id)
          .filter((x): x is string => typeof x === "string" && x.length > 0),
      ),
    );

    const woById: Record<string, WorkOrder> = {};
    if (woIds.length) {
      const { data: wos, error: woErr } = await supabase
        .from("work_orders")
        .select("id, custom_id")
        .in("id", woIds);

      if (woErr) {
        // eslint-disable-next-line no-console
        console.error("[parts/requests] load work_orders failed:", woErr);
      } else {
        (wos ?? []).forEach((w) => {
          const row = w as WorkOrder;
          woById[row.id] = row;
        });
      }
    }

    // 4) group into 1 card per work order
    const byWo: Record<string, WoBucket> = {};

    for (const r of requestList) {
      const workOrderId = r.work_order_id;
      if (!workOrderId) continue;

      const wo = woById[workOrderId];
      const customId = wo?.custom_id ?? null;

      if (!byWo[workOrderId]) {
        byWo[workOrderId] = {
          workOrderId,
          customId,
          status: "needs_quote",
          requests: [],
          itemsCount: 0,
          completeCount: 0,
          completionPct: 0,
          latestAt: null,
          searchBlob: "",
        };
      }

      byWo[workOrderId].requests.push(r);

      const itemsCount = itemsCountByRequest[r.id] ?? 0;
      const completeCount = completeCountByRequest[r.id] ?? 0;

      byWo[workOrderId].itemsCount += itemsCount;
      byWo[workOrderId].completeCount += completeCount;

      const createdAt = r.created_at ? String(r.created_at) : null;
      if (createdAt) {
        if (!byWo[workOrderId].latestAt) byWo[workOrderId].latestAt = createdAt;
        else if (
          new Date(createdAt).getTime() >
          new Date(byWo[workOrderId].latestAt!).getTime()
        ) {
          byWo[workOrderId].latestAt = createdAt;
        }
      }
    }

    // 5) compute bucket status + search blob + completion %
    Object.values(byWo).forEach((b) => {
      b.status = computeBucketStatus(b.requests);

      const pct =
        b.itemsCount > 0 ? Math.round((b.completeCount / b.itemsCount) * 100) : 0;
      b.completionPct = Math.max(0, Math.min(100, pct));

      const reqIdsBlob = b.requests.map((r) => r.id).join(" ");
      const descBlob = b.requests
        .flatMap((r) => descByRequest[r.id] ?? [])
        .join(" ");
      const woBlob = `${b.customId ?? ""} ${b.workOrderId}`;
      b.searchBlob = `${woBlob} ${reqIdsBlob} ${descBlob}`.toLowerCase();
    });

    const list = Object.values(byWo).sort((a, b) => {
      const ta = a.latestAt ? new Date(a.latestAt).getTime() : 0;
      const tb = b.latestAt ? new Date(b.latestAt).getTime() : 0;
      return tb - ta;
    });

    setBuckets(list);
    setLoading(false);
  };

  const deleteBucket = async (b: WoBucket): Promise<void> => {
    const woLabel =
      b.customId ||
      (looksLikeUuid(b.workOrderId)
        ? `#${b.workOrderId.slice(0, 8)}`
        : b.workOrderId);

    const requestIds = b.requests
      .map((r) => r.id)
      .filter((id): id is string => typeof id === "string" && id.length > 0);

    if (requestIds.length === 0) {
      toast.error("Nothing to delete for this work order");
      return;
    }

    const ok = window.confirm(
      `Delete ${requestIds.length} parts request${
        requestIds.length === 1 ? "" : "s"
      } for Work Order ${woLabel}?\n\nThis will delete the requests and their line items.`,
    );
    if (!ok) return;

    setDeletingWoId(b.workOrderId);
    const t = toast.loading("Deleting requests…");

    try {
      // 1) delete request items first (FK safe)
      const { error: itemsErr } = await supabase
        .from("part_request_items")
        .delete()
        .in("request_id", requestIds);

      if (itemsErr) {
        // eslint-disable-next-line no-console
        console.error("[parts/requests] delete items failed:", itemsErr);
        toast.error("Failed to delete request items", { id: t });
        return;
      }

      // 2) delete requests
      const { error: reqErr } = await supabase
        .from("part_requests")
        .delete()
        .in("id", requestIds);

      if (reqErr) {
        // eslint-disable-next-line no-console
        console.error("[parts/requests] delete requests failed:", reqErr);
        toast.error("Failed to delete requests", { id: t });
        return;
      }

      toast.success("Deleted", { id: t });
      await reload();
    } catch (e) {
      // eslint-disable-next-line no-console
      console.error("[parts/requests] deleteBucket exception:", e);
      toast.error("Delete failed", { id: t });
    } finally {
      setDeletingWoId(null);
    }
  };

  useEffect(() => {
    void reload();

    const onRefresh = () => void reload();
    window.addEventListener("parts-request:submitted", onRefresh);
    window.addEventListener("parts:received", onRefresh);
    return () => {
      window.removeEventListener("parts-request:submitted", onRefresh);
      window.removeEventListener("parts:received", onRefresh);
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const filtered = useMemo(() => {
    const q = search.trim().toLowerCase();

    let list = buckets;

    if (statusFilter !== "all") {
      list = list.filter((b) => b.status === statusFilter);
    }

    if (!q) return list;
    return list.filter((b) => b.searchBlob.includes(q));
  }, [buckets, search, statusFilter]);

  return (
    <div className={PAGE}>
      <div className="mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">
            Parts
          </div>
          <h1
            className="text-2xl font-semibold text-white"
            style={{ fontFamily: "var(--font-blackops), system-ui" }}
          >
            Requests
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            One card per Work Order. Completion % is based on items with part + qty
            + price.
          </p>
        </div>

        <div className="flex flex-wrap gap-2">
          <Link href="/parts" className={BTN_COPPER}>
            Parts Dashboard
          </Link>
          <button type="button" className={BTN_GHOST} onClick={() => void reload()}>
            Refresh
          </button>
        </div>
      </div>

      <div className={`${CARD_PAD} mb-4 space-y-3`}>
        <div className="grid gap-3 md:grid-cols-12 md:items-center">
          <div className="md:col-span-5">
            <div className="mb-1 text-xs text-neutral-400">
              Search (WO#, request id, part description)
            </div>
            <input
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              placeholder="Search…"
              className={INPUT}
            />
          </div>

          <div className="md:col-span-4">
            <div className="mb-1 text-xs text-neutral-400">Status</div>
            <select
              className={SELECT}
              value={statusFilter}
              onChange={(e) =>
                setStatusFilter((e.target.value as typeof statusFilter) ?? "all")
              }
            >
              <option value="all">All</option>
              <option value="needs_quote">Needs quote</option>
              <option value="quoted">Quoted</option>
              <option value="approved">Approved</option>
              <option value="fulfilled">Fulfilled</option>
            </select>
          </div>

          <div className="md:col-span-3">
            <div className="mb-1 text-xs text-neutral-400">Showing</div>
            <div className="rounded-lg border border-white/10 bg-neutral-950/20 px-3 py-2 text-sm text-neutral-200">
              <span className="font-semibold text-white">{filtered.length}</span>{" "}
              work order{filtered.length === 1 ? "" : "s"}
            </div>
          </div>
        </div>
      </div>

      {loading ? (
        <div className={`${CARD_PAD} text-sm text-neutral-300`}>Loading…</div>
      ) : filtered.length === 0 ? (
        <div className={`${CARD_PAD} text-sm text-neutral-400`}>
          No active parts requests.
        </div>
      ) : (
        <div className="grid gap-4 lg:grid-cols-2 xl:grid-cols-3">
          {filtered.map((b) => {
            const woLabel =
              b.customId ||
              (looksLikeUuid(b.workOrderId)
                ? `#${b.workOrderId.slice(0, 8)}`
                : b.workOrderId);

            // ✅ IMPORTANT:
            // This page links to /parts/requests/[id] where [id] resolves a WORK ORDER
            // by custom_id or uuid. So we pass customId if available, else wo id.
            const href = `/parts/requests/${encodeURIComponent(
              b.customId || b.workOrderId,
            )}`;

            const isDeleting = deletingWoId === b.workOrderId;

            return (
              <div key={b.workOrderId} className={`${CARD_PAD}`}>
                <div className="flex items-start justify-between gap-3">
                  <div className="min-w-0">
                    <div className="text-lg font-semibold tracking-wide text-white">
                      {woLabel}
                    </div>
                    <div className="mt-1 text-xs text-neutral-400">
                      {b.requests.length} request{b.requests.length === 1 ? "" : "s"} ·{" "}
                      {b.itemsCount} item{b.itemsCount === 1 ? "" : "s"}
                      {b.itemsCount > 0 ? (
                        <>
                          <span className="mx-2 text-neutral-600">·</span>
                          {b.completeCount}/{b.itemsCount} complete
                        </>
                      ) : null}
                    </div>
                  </div>

                  <span className={pillFor(b.status)}>{labelFor(b.status)}</span>
                </div>

                {/* completion bar */}
                <div className="mt-4">
                  <div className="flex items-center justify-between text-[11px] text-neutral-400">
                    <span>Completion</span>
                    <span className={COPPER_TEXT}>{b.completionPct}%</span>
                  </div>
                  <div className="mt-1 h-2 w-full overflow-hidden rounded-full border border-white/10 bg-black/40">
                    <div
                      className="h-full rounded-full bg-white/20"
                      style={{ width: `${b.completionPct}%` }}
                      aria-hidden="true"
                    />
                  </div>
                </div>

                <div className="mt-4 flex flex-wrap justify-end gap-2">
                  <button
                    type="button"
                    className={BTN_DANGER}
                    onClick={() => void deleteBucket(b)}
                    disabled={isDeleting}
                    title="Delete all requests under this work order"
                  >
                    {isDeleting ? "Deleting…" : "Delete"}
                  </button>

                  <Link href={href} className={BTN_COPPER}>
                    Open requests →
                  </Link>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

==================== FILE: app/portal/parts/page.tsx ====================

import PortalShell from "@/features/portal/components/PortalShell";
import Link from "next/link";

const muted = "text-neutral-400";
const glass =
  "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";

export default function PortalPartsPage() {
  return (
    <PortalShell
      title="Customer Portal"
      subtitle="Parts approvals, requested parts, and statuses"
    >
      <div className="space-y-4">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">
            Parts
          </div>
          <h1 className="font-header text-3xl text-orange-400">Parts & Approvals</h1>
          <p className={`mt-1 text-sm ${muted}`}>
            If your shop requests parts approval, you’ll see them here.
          </p>
        </div>

        <div className={glass}>
          <div className="text-sm font-semibold text-neutral-100">What you can do here</div>
          <ul className={`mt-2 list-disc pl-5 text-sm ${muted} space-y-1`}>
            <li>Review requested parts from the shop</li>
            <li>Approve or decline before ordering</li>
            <li>Track status (requested → approved → ordered → installed)</li>
          </ul>

          <div className="mt-4 flex flex-wrap gap-2">
            <Link
              href="/portal/request/when"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              Start a new request
            </Link>
            <Link
              href="/portal/history"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              View history
            </Link>
          </div>
        </div>

        <div className={`${glass} ${muted} text-sm`}>
          Next step: wire this page to your parts-request table/view once we confirm the exact
          schema you’re using for portal approvals.
        </div>
      </div>
    </PortalShell>
  );
}


==================== FILE: features/dashboard/app/dashboard/parts/page.tsx ====================

// app/dashboard/parts/page.tsx
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import clsx from "clsx";
import { toast } from "sonner";
import PartsRequestChat from "@parts/components/PartsRequestChat";

type PartsRequest = Database["public"]["Tables"]["parts_requests"]["Row"];

export default function PartsDashboard() {
  const supabase = createClientComponentClient<Database>();
  const [requests, setRequests] = useState<PartsRequest[]>([]);
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [userId, setUserId] = useState<string | null>(null);
  const [tab, setTab] = useState<"active" | "archived">("active");
  const [touchStartY, setTouchStartY] = useState(0);
  const [swipeOffset, setSwipeOffset] = useState(0);

  // Fetch current user
  useEffect(() => {
    supabase.auth.getUser().then((res) => {
      setUserId(res.data.user?.id ?? null);
    });
  }, [supabase]);

  // Fetch initial requests
  useEffect(() => {
    const fetch = async () => {
      const { data } = await supabase
        .from("part_requests")
        .select("*")
        .order("created_at", { ascending: false });

      if (data) setRequests(data);
    };
    fetch();
  }, [supabase]);

  // Real-time subscription
  useEffect(() => {
    const channel = supabase
      .channel("parts-requests")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "parts_requests" },
        (payload) => {
          const updated = payload.new as PartsRequest;
          setRequests((prev) => {
            const exists = prev.find((r) => r.id === updated.id);

            // Insert
            if (!exists && payload.eventType === "INSERT") {
              toast.info(`New parts request: ${updated.part_name}`);
              return [updated, ...prev];
            }

            // Update
            return prev.map((r) => (r.id === updated.id ? updated : r));
          });
        },
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [supabase]);

  const handleView = async (id: string) => {
    setSelectedId(id);
    const req = requests.find((r) => r.id === id);
    if (req && !req.viewed_at) {
      const now = new Date().toISOString();
      await supabase.from("parts_requests").update({ viewed_at: now }).eq("id", id);
    }
  };

  const handleFulfill = async (id: string) => {
    const now = new Date().toISOString();
    await supabase.from("parts_requests").update({ fulfilled_at: now }).eq("id", id);
    setRequests((prev) => prev.map((r) => (r.id === id ? { ...r, fulfilled_at: now } : r)));
  };

  const filtered = requests.filter((r) => (tab === "active" ? !r.fulfilled_at : !!r.fulfilled_at));

  return (
    <div className="p-4 md:p-6 max-w-5xl mx-auto text-white font-blackops">
      <h1 className="text-3xl text-orange-500 mb-6">Parts Requests</h1>

      <div className="flex gap-4 mb-6">
        <button
          onClick={() => setTab("active")}
          className={clsx(
            "px-4 py-2 rounded font-semibold",
            tab === "active" ? "bg-orange-500 text-white" : "bg-neutral-700 hover:bg-neutral-600",
          )}
        >
          Active
        </button>
        <button
          onClick={() => setTab("archived")}
          className={clsx(
            "px-4 py-2 rounded font-semibold",
            tab === "archived" ? "bg-orange-500 text-white" : "bg-neutral-700 hover:bg-neutral-600",
          )}
        >
          Archived
        </button>
      </div>

      {filtered.length === 0 ? (
        <p className="text-gray-400">No {tab} requests found.</p>
      ) : (
        <div className="space-y-4">
          {filtered.map((req) => {
            const isNew = !req.viewed_at;
            const photos: string[] = Array.isArray(req.photo_urls) ? req.photo_urls : [];

            return (
              <div
                key={req.id}
                className={clsx(
                  "rounded p-4 border shadow transition",
                  isNew && tab === "active"
                    ? "border-yellow-500 bg-yellow-900/20 animate-pulse"
                    : "border-gray-600 bg-gray-800",
                )}
              >
                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                  <div>
                    <p className="text-lg font-semibold text-orange-300">
                      {req.part_name} × {req.quantity}
                    </p>
                    <p className="text-sm text-gray-400">
                      <strong>Urgency:</strong> {req.urgency}{" "}
                      <strong className="ml-4">Requested by:</strong> {req.requested_by}
                    </p>
                    <p className="text-xs text-gray-500">
                      <strong>Sent:</strong>{" "}
                      {req.created_at ? new Date(req.created_at).toLocaleString() : "—"} <br />
                      <strong>Viewed:</strong>{" "}
                      {req.viewed_at ? new Date(req.viewed_at).toLocaleString() : "—"} <br />
                      <strong>Fulfilled:</strong>{" "}
                      {req.fulfilled_at ? new Date(req.fulfilled_at).toLocaleString() : "—"}
                    </p>
                  </div>

                  <div className="flex flex-col gap-2">
                    {tab === "active" && (
                      <button
                        onClick={() => handleView(req.id)}
                        className="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-white"
                      >
                        {req.viewed_at ? "View Again" : "View"}
                      </button>
                    )}
                    {tab === "active" && !req.fulfilled_at && (
                      <button
                        onClick={() => handleFulfill(req.id)}
                        className="px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-white"
                      >
                        Mark Fulfilled
                      </button>
                    )}
                  </div>
                </div>

                {selectedId === req.id && req.notes && (
                  <div className="mt-2 text-sm text-white">
                    <strong>Notes:</strong> {req.notes}
                  </div>
                )}

                {/* ✅ Safely render photos */}
                {selectedId === req.id && photos.length > 0 && (
                  <div className="mt-2 flex gap-2 flex-wrap">
                    {photos.map((url) => (
                      <img
                        key={url}
                        src={url}
                        alt="Part"
                        className="w-20 h-20 rounded border border-gray-500 object-cover"
                      />
                    ))}
                  </div>
                )}

                {selectedId === req.id && userId && (
                  <>
                    {/* Mobile Full-Screen Chat with Swipe-to-Close */}
                    <div
                      className="fixed inset-0 bg-black bg-opacity-80 z-50 sm:hidden flex flex-col transition-transform duration-300 ease-out"
                      style={{ touchAction: "none", transform: `translateY(${swipeOffset}px)` }}
                      onTouchStart={(e) => setTouchStartY(e.touches[0].clientY)}
                      onTouchMove={(e) => {
                        const delta = e.touches[0].clientY - touchStartY;
                        if (delta > 0) setSwipeOffset(delta);
                      }}
                      onTouchEnd={() => {
                        if (swipeOffset > 100) setSelectedId(null);
                        else setSwipeOffset(0);
                      }}
                    >
                      <div className="flex justify-between items-center p-3 bg-neutral-900 text-white border-b border-gray-700">
                        <h2 className="text-lg font-semibold">Request Chat</h2>
                        <button
                          onClick={() => setSelectedId(null)}
                          className="text-gray-300 hover:text-white text-sm"
                        >
                          Close ✕
                        </button>
                      </div>
                      <div className="flex-1 overflow-y-auto bg-neutral-800">
                        <PartsRequestChat requestId={req.id} senderId={userId} />
                      </div>
                    </div>

                    {/* Desktop Inline View */}
                    <div className="hidden sm:block mt-4">
                      <PartsRequestChat requestId={req.id} senderId={userId} />
                    </div>
                  </>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

==================== FILE: features/dashboard/components/role-panels/PartsPanel.tsx ====================

"use client";
export default function PartsPanel() {
  return null; // add parts-specific widgets later
}


==================== FILE: features/integrations/parts/index.ts ====================

/**
 * Parts Integration Layer
 * Wrapper for PartsTech / WorldPac / NAPA inputs.
 */

export interface PartsSearchInput {
  vin?: string;
  keywords?: string;
}

export interface PartResult {
  id: string;
  supplier: string;
  description: string;
  price: number;
  stock: number;
}

export interface PartsProvider {
  search(input: PartsSearchInput): Promise<PartResult[]>;
}

class MockPartsProvider implements PartsProvider {
  async search(input: PartsSearchInput): Promise<PartResult[]> {
    return [
      {
        id: "demo-123",
        supplier: "MockSupplier",
        description: `Example part for ${input.keywords ?? input.vin}`,
        price: 42,
        stock: 3,
      },
    ];
  }
}

export const Parts = new MockPartsProvider();


==================== FILE: features/parts/actions.ts ====================

"use server";

import { revalidatePath } from "next/cache";
import { cookies } from "next/headers";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

/** Keep this in sync with your Postgres enum stock_move_reason */
export type StockMoveReason =
  | "receive"
  | "adjust"
  | "consume"
  | "sale"
  | "waste"
  | "return_in"
  | "return_out";

export async function createPart(input: {
  shop_id: string;
  sku?: string;
  name: string;
  description?: string;
  default_cost?: number;
  default_price?: number;
  category?: string;
  subcategory?: string;
  low_stock_threshold?: number;
}) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("parts")
    .insert(input)
    .select("id")
    .single();
  if (error) throw error;

  revalidatePath("/parts");
  return data.id as string;
}

/** RPC payload for apply_stock_move */
type ApplyStockMoveArgs = {
  p_part: string;
  p_loc: string;
  p_qty: number;
  p_reason: StockMoveReason | string; // Supabase RPC arg is `string`
  p_ref_kind: string;                 // must be string, not undefined/null
  p_ref_id: string;                   // must be string, not undefined/null
};

/**
 * Adjust on-hand stock for a part at a location.
 * Matches SQL: apply_stock_move(p_part, p_loc, p_qty, p_reason, p_ref_kind, p_ref_id) RETURNS uuid
 */
export async function adjustStock(input: {
  part_id: string;
  location_id: string;
  qty_change: number;
  reason: StockMoveReason;
  reference_kind?: string | null;
  reference_id?: string | null;
}) {
  const supabase = createServerActionClient<DB>({ cookies });

  const rpcArgs: ApplyStockMoveArgs = {
    p_part: input.part_id,
    p_loc: input.location_id,
    p_qty: input.qty_change,
    // The generated type for RPC often expects `string`; our union is compatible.
    p_reason: input.reason,
    // IMPORTANT: RPC arg types are `string`, so pass "" when omitted.
    p_ref_kind: input.reference_kind ?? "",
    p_ref_id: input.reference_id ?? "",
  };

  const { data, error } = await supabase.rpc("apply_stock_move", rpcArgs);
  if (error) throw error;

  // Supabase returns the function result directly; for RETURNS uuid it's a string.
  const moveId =
    typeof data === "string"
      ? data
      : (data as unknown as string); // retain type safety without `any`

  revalidatePath(`/parts/${input.part_id}`);
  return moveId;
}

==================== FILE: features/parts/app/parts/[id]/page.tsx ====================

import Link from "next/link";
import { getPart } from "@/features/parts/lib/parts.queries";
import { AdjustStockForm } from "@/features/parts/components/AdjustStockForm";

const shell = "p-6 text-white";
const glass = "rounded-2xl border border-white/10 bg-black/30 backdrop-blur-sm shadow-[0_0_40px_rgba(0,0,0,0.65)]";
const muted = "text-neutral-400";
const btn =
  "inline-flex items-center justify-center rounded-full border border-white/12 bg-black/40 px-3 py-1.5 text-sm text-neutral-200 hover:border-orange-400/60 hover:text-white";

export default async function PartDetail({ params }: { params: { id: string } }) {
  const part = await getPart(params.id);

  return (
    <div className={shell}>
      <div className="mb-4 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">Parts</div>
          <h1 className="font-header text-3xl text-orange-400">{part.name}</h1>
          <p className={`mt-1 text-sm ${muted}`}>{part.sku ?? ""}</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <Link className={btn} href="/parts">Inventory</Link>
          <Link className={btn} href="/parts/new">New Part</Link>
          <Link className={btn} href="/parts/suppliers">Suppliers</Link>
          <Link className={btn} href="/parts/locations">Locations</Link>
          <Link className={btn} href="/dashboard/parts">Requests</Link>
        </div>
      </div>

      <div className="grid gap-4 md:grid-cols-2">
        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Stock</div>

          {(part.v_part_stock ?? []).length ? (
            <div className="grid gap-2">
              {(part.v_part_stock ?? []).map((s: unknown) => {
                const row = s as {
                  location_id: string;
                  qty_available: number;
                  qty_on_hand: number;
                };
                return (
                  <div
                    key={row.location_id}
                    className="flex items-center justify-between rounded-xl border border-white/10 bg-black/25 px-3 py-2"
                  >
                    <span className="text-sm text-neutral-200">
                      Loc {String(row.location_id).slice(0, 6)}…
                    </span>
                    <span className="text-sm tabular-nums text-neutral-200">
                      {Number(row.qty_available)} avail{" "}
                      <span className="text-xs text-neutral-500">
                        (on hand {Number(row.qty_on_hand)})
                      </span>
                    </span>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className={`rounded-xl border border-white/10 bg-black/25 p-3 text-sm ${muted}`}>
              No stock yet
            </div>
          )}
        </div>

        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Quick Adjust</div>
          <AdjustStockForm partId={part.id} />
          <p className={`mt-2 text-xs ${muted}`}>
            Tip: positive quantity = receive, negative = adjust.
          </p>
        </div>
      </div>
    </div>
  );
}


==================== FILE: features/parts/app/parts/locations/page.tsx ====================

import Link from "next/link";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { listLocations, ensureMainLocation } from "@/features/parts/lib/locations";
import { LocationForm } from "@/features/parts/components/LocationForm";

type DB = Database;

async function getShopId(): Promise<string> {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return "";
  const { data } = await supabase.from("profiles").select("shop_id").eq("user_id", user.id).single();
  return data?.shop_id ?? "";
}

const shell = "p-6 text-white";
const glass = "rounded-2xl border border-white/10 bg-black/30 backdrop-blur-sm shadow-[0_0_40px_rgba(0,0,0,0.65)]";
const muted = "text-neutral-400";
const btn =
  "inline-flex items-center justify-center rounded-full border border-white/12 bg-black/40 px-3 py-1.5 text-sm text-neutral-200 hover:border-orange-400/60 hover:text-white";

export default async function LocationsPage() {
  const shopId = await getShopId();
  if (!shopId) {
    return (
      <div className={shell}>
        <div className={`${glass} p-4 text-sm ${muted}`}>No shop selected.</div>
      </div>
    );
  }

  await ensureMainLocation(shopId);
  const locs = await listLocations(shopId);

  return (
    <div className={shell}>
      <div className="mb-4 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">Parts</div>
          <h1 className="font-header text-3xl text-orange-400">Locations</h1>
          <p className={`mt-1 text-sm ${muted}`}>Manage bins/shelves for parts.</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <Link className={btn} href="/parts">Inventory</Link>
          <Link className={btn} href="/parts/new">New Part</Link>
          <Link className={btn} href="/parts/suppliers">Suppliers</Link>
          <Link className={btn} href="/dashboard/parts">Requests</Link>
        </div>
      </div>

      <div className="grid gap-4">
        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Add Location</div>
          <LocationForm shopId={shopId} />
        </div>

        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Existing</div>
          <div className="grid gap-2">
            {locs.map((l) => (
              <div
                key={l.id}
                className="flex items-center justify-between rounded-xl border border-white/10 bg-black/25 px-3 py-2"
              >
                <span className="font-medium text-neutral-100">{l.code}</span>
                <span className={`text-sm ${muted}`}>{l.name}</span>
              </div>
            ))}
            {locs.length === 0 && (
              <div className={`rounded-xl border border-white/10 bg-black/25 p-3 text-sm ${muted}`}>
                No locations yet.
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


==================== FILE: features/parts/app/parts/new/page.tsx ====================

import Link from "next/link";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { PartForm } from "@parts/components/PartForm";

type DB = Database;

async function getShopId(): Promise<string> {
  const supabase = createServerComponentClient<DB>({ cookies });

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return "";

  const { data } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("user_id", user.id)
    .single();

  return data?.shop_id ?? "";
}

const shell = "p-6 text-white";
const glass = "rounded-2xl border border-white/10 bg-black/30 backdrop-blur-sm shadow-[0_0_40px_rgba(0,0,0,0.65)]";
const muted = "text-neutral-400";
const btn =
  "inline-flex items-center justify-center rounded-full border border-white/12 bg-black/40 px-3 py-1.5 text-sm text-neutral-200 hover:border-orange-400/60 hover:text-white";

export default async function NewPartPage() {
  const shopId = await getShopId();

  return (
    <div className={shell}>
      <div className="mb-4 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">Parts</div>
          <h1 className="font-header text-3xl text-orange-400">New Part</h1>
          <p className={`mt-1 text-sm ${muted}`}>Add a new inventory item.</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <Link className={btn} href="/parts">Inventory</Link>
          <Link className={btn} href="/parts/suppliers">Suppliers</Link>
          <Link className={btn} href="/parts/locations">Locations</Link>
          <Link className={btn} href="/dashboard/parts">Requests</Link>
        </div>
      </div>

      <div className={`${glass} p-4`}>
        {!shopId ? (
          <div className="text-sm text-neutral-300">
            No shop selected. Make sure your profile has a{" "}
            <code className="text-neutral-100">shop_id</code>.
          </div>
        ) : (
          <PartForm shopId={shopId} />
        )}
      </div>
    </div>
  );
}


==================== FILE: features/parts/app/parts/page.tsx ====================

import Link from "next/link";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { listParts } from "@/features/parts/lib/parts.queries";

type DB = Database;

async function getShopId(): Promise<string> {
  const supabase = createServerComponentClient<DB>({ cookies });

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return "";

  const { data: profile } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("user_id", user.id)
    .single();

  return profile?.shop_id ?? "";
}

const shell = "p-6 text-white";
const glass = "rounded-2xl border border-white/10 bg-black/30 backdrop-blur-sm shadow-[0_0_40px_rgba(0,0,0,0.65)]";
const muted = "text-neutral-400";
const accent = "text-orange-300";
const btn =
  "inline-flex items-center justify-center rounded-full border border-white/12 bg-black/40 px-3 py-1.5 text-sm text-neutral-200 hover:border-orange-400/60 hover:text-white";

function PartsSubnav() {
  return (
    <div className="flex flex-wrap items-center gap-2">
      <Link className={btn} href="/parts">Inventory</Link>
      <Link className={btn} href="/parts/new">New Part</Link>
      <Link className={btn} href="/parts/suppliers">Suppliers</Link>
      <Link className={btn} href="/parts/locations">Locations</Link>
      <Link className={btn} href="/dashboard/parts">Requests</Link>
    </div>
  );
}

export default async function PartsPage() {
  const shopId = await getShopId();
  const parts = shopId ? await listParts(shopId) : [];

  return (
    <div className={shell}>
      <div className="mb-4 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">Parts</div>
          <h1 className="font-header text-3xl text-orange-400">Inventory</h1>
          <p className={`mt-1 text-sm ${muted}`}>Manage parts, stock, suppliers, and locations.</p>
        </div>
        <PartsSubnav />
      </div>

      {!shopId ? (
        <div className={`${glass} p-4`}>
          <div className="font-semibold">No shop selected</div>
          <p className={`mt-1 text-sm ${muted}`}>
            Make sure your profile has a <code className="text-neutral-200">shop_id</code>.
          </p>
        </div>
      ) : (
        <div className={`${glass} p-4`}>
          <div className="mb-3 flex items-center justify-between gap-3">
            <div className="text-sm font-semibold text-neutral-200">Parts</div>
            <Link
              href="/parts/new"
              className="rounded-full bg-[var(--accent-copper,theme(colors.orange.500))] px-4 py-1.5 text-sm font-semibold text-black shadow-[0_0_24px_rgba(248,113,22,0.45)] hover:opacity-90"
            >
              + New Part
            </Link>
          </div>

          {parts.length === 0 ? (
            <div className={`rounded-xl border border-white/10 bg-black/30 p-4 text-sm ${muted}`}>
              No parts yet.
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-2">
              {parts.map((p) => (
                <Link
                  key={p.id}
                  href={`/parts/${p.id}`}
                  className="rounded-xl border border-white/10 bg-black/25 px-4 py-3 transition hover:border-orange-400/40 hover:bg-black/35"
                >
                  <div className="flex items-center justify-between gap-3">
                    <div className="min-w-0">
                      <div className="truncate font-medium text-neutral-100">
                        {p.name}
                      </div>
                      <div className={`mt-0.5 truncate text-xs ${muted}`}>
                        {p.sku ?? "—"} • {p.category ?? "Uncategorized"}
                      </div>
                    </div>
                    <div className={`shrink-0 text-xs ${accent}`}>
                      Open →
                    </div>
                  </div>
                </Link>
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}


==================== FILE: features/parts/app/parts/suppliers/page.tsx ====================

import Link from "next/link";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { listSuppliers } from "@/features/parts/lib/suppliers";
import { SupplierForm } from "@/features/parts/components/SupplierForm";

type DB = Database;

async function getShopId(): Promise<string> {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return "";
  const { data } = await supabase.from("profiles").select("shop_id").eq("user_id", user.id).single();
  return data?.shop_id ?? "";
}

const shell = "p-6 text-white";
const glass = "rounded-2xl border border-white/10 bg-black/30 backdrop-blur-sm shadow-[0_0_40px_rgba(0,0,0,0.65)]";
const muted = "text-neutral-400";
const btn =
  "inline-flex items-center justify-center rounded-full border border-white/12 bg-black/40 px-3 py-1.5 text-sm text-neutral-200 hover:border-orange-400/60 hover:text-white";

export default async function SuppliersPage() {
  const shopId = await getShopId();
  if (!shopId) {
    return (
      <div className={shell}>
        <div className={`${glass} p-4 text-sm ${muted}`}>No shop selected.</div>
      </div>
    );
  }

  const suppliers = await listSuppliers(shopId);

  return (
    <div className={shell}>
      <div className="mb-4 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">Parts</div>
          <h1 className="font-header text-3xl text-orange-400">Suppliers</h1>
          <p className={`mt-1 text-sm ${muted}`}>Create and manage parts vendors.</p>
        </div>
        <div className="flex flex-wrap gap-2">
          <Link className={btn} href="/parts">Inventory</Link>
          <Link className={btn} href="/parts/new">New Part</Link>
          <Link className={btn} href="/parts/locations">Locations</Link>
          <Link className={btn} href="/dashboard/parts">Requests</Link>
        </div>
      </div>

      <div className="grid gap-4">
        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Add Supplier</div>
          <SupplierForm shopId={shopId} />
        </div>

        <div className={`${glass} p-4`}>
          <div className="mb-2 text-sm font-semibold text-neutral-200">Existing</div>
          <div className="grid gap-2">
            {suppliers.map((s) => (
              <div
                key={s.id}
                className="flex flex-col gap-1 rounded-xl border border-white/10 bg-black/25 px-3 py-2 sm:flex-row sm:items-center sm:justify-between"
              >
                <span className="font-medium text-neutral-100">{s.name}</span>
                <span className={`text-sm ${muted}`}>
                  {(s.email ?? "")}
                  {s.phone ? ` • ${s.phone}` : ""}
                </span>
              </div>
            ))}
            {suppliers.length === 0 && (
              <div className={`rounded-xl border border-white/10 bg-black/25 p-3 text-sm ${muted}`}>
                No suppliers yet.
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}


==================== FILE: features/parts/components/AdjustStockForm.tsx ====================

"use client";
import { useState, useTransition } from "react";
import { adjustStock } from "@/features/parts/actions";

export function AdjustStockForm({ partId }: { partId: string }) {
  const [locationId, setLocationId] = useState("");
  const [qty, setQty] = useState<number>(0);
  const [pending, start] = useTransition();

  return (
    <form
      onSubmit={(e) => {
        e.preventDefault();
        start(async () => {
          await adjustStock({
            part_id: partId,
            location_id: locationId,
            qty_change: qty,
            reason: qty >= 0 ? "receive" : "adjust",
          });
        });
      }}
      className="space-y-2"
    >
      <input
        className="border rounded px-3 py-2 w-full"
        placeholder="Location ID"
        value={locationId}
        onChange={(e) => setLocationId(e.target.value)}
      />
      <input
        className="border rounded px-3 py-2 w-full"
        placeholder="Qty (+/-)"
        type="number"
        step="0.01"
        value={qty}
        onChange={(e) =>
          setQty(parseFloat(e.target.value || "0"))
        }
      />
      <button
        disabled={pending}
        className="px-3 py-2 rounded-xl bg-neutral-900 text-white"
      >
        {pending ? "Saving…" : "Apply"}
      </button>
    </form>
  );
}


==================== FILE: features/parts/components/LocationForm.tsx ====================

"use client";
import { useState, useTransition } from "react";
import { createLocation } from "@/features/parts/lib/locations";

export function LocationForm({ shopId }: { shopId: string }) {
  const [code, setCode] = useState("MAIN");
  const [name, setName] = useState("Main Stock");
  const [pending, start] = useTransition();
  const [err, setErr] = useState<string | null>(null);

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        setErr(null);
        start(async () => {
          try {
            await createLocation({ shop_id: shopId, code: code.trim(), name: name.trim() });
            window.location.reload();
          } catch (e: any) {
            setErr(e?.message ?? "Failed");
          }
        });
      }}
    >
      {err && <div className="text-sm text-red-600">{err}</div>}
      <div className="grid grid-cols-2 gap-3">
        <label className="block">
          <div className="text-sm font-medium mb-1">Code</div>
          <input className="border rounded w-full px-3 py-2" value={code} onChange={(e) => setCode(e.target.value)} />
        </label>
        <label className="block">
          <div className="text-sm font-medium mb-1">Name</div>
          <input className="border rounded w-full px-3 py-2" value={name} onChange={(e) => setName(e.target.value)} />
        </label>
      </div>
      <button disabled={pending} className="px-3 py-2 rounded-xl bg-neutral-900 text-white">
        {pending ? "Saving…" : "Create Location"}
      </button>
    </form>
  );
}


==================== FILE: features/parts/components/PartForm.tsx ====================

"use client";
import { useState, useTransition } from "react";
import { createPart } from "@/features/parts/actions";

export function PartForm({ shopId }: { shopId: string }) {
  const [form, setForm] = useState({
    sku: "",
    name: "",
    description: "",
    unit: "ea",
    category: "",
    subcategory: "",
    default_cost: 0,
    default_price: 0,
    low_stock_threshold: 0,
    taxable: true,
  });
  const [pending, start] = useTransition();
  const [error, setError] = useState<string | null>(null);

  function set<K extends keyof typeof form>(key: K, value: (typeof form)[K]) {
    setForm((f) => ({ ...f, [key]: value }));
  }

  return (
    <form
      className="space-y-4"
      onSubmit={(e) => {
        e.preventDefault();
        setError(null);
        start(async () => {
          try {
            const id = await createPart({
              shop_id: shopId,
              sku: form.sku || undefined,
              name: form.name,
              description: form.description || undefined,
              default_cost: Number(form.default_cost) || 0,
              default_price: Number(form.default_price) || 0,
              category: form.category || undefined,
              subcategory: form.subcategory || undefined,
              low_stock_threshold: Number(form.low_stock_threshold) || 0,
            });
            window.location.href = `/parts/${id}`;
          } catch (err: any) {
            setError(err?.message ?? "Failed to create part");
          }
        });
      }}
    >
      {error && <div className="text-sm text-red-600">{error}</div>}

      <div className="grid md:grid-cols-2 gap-4">
        <label className="block">
          <div className="text-sm font-medium mb-1">Name</div>
          <input
            className="border rounded w-full px-3 py-2"
            value={form.name}
            onChange={(e) => set("name", e.target.value)}
            required
          />
        </label>

        <label className="block">
          <div className="text-sm font-medium mb-1">SKU</div>
          <input
            className="border rounded w-full px-3 py-2"
            value={form.sku}
            onChange={(e) => set("sku", e.target.value)}
            placeholder="optional"
          />
        </label>

        <label className="block md:col-span-2">
          <div className="text-sm font-medium mb-1">Description</div>
          <textarea
            className="border rounded w-full px-3 py-2"
            rows={3}
            value={form.description}
            onChange={(e) => set("description", e.target.value)}
            placeholder="optional"
          />
        </label>

        <label className="block">
          <div className="text-sm font-medium mb-1">Category</div>
          <input
            className="border rounded w-full px-3 py-2"
            value={form.category}
            onChange={(e) => set("category", e.target.value)}
            placeholder="e.g., filters"
          />
        </label>

        <label className="block">
          <div className="text-sm font-medium mb-1">Subcategory</div>
          <input
            className="border rounded w-full px-3 py-2"
            value={form.subcategory}
            onChange={(e) => set("subcategory", e.target.value)}
            placeholder="e.g., oil filter"
          />
        </label>

        <label className="block">
          <div className="text-sm font-medium mb-1">Unit</div>
          <input
            className="border rounded w-full px-3 py-2"
            value={form.unit}
            onChange={(e) => set("unit", e.target.value)}
            placeholder="ea, box, set"
          />
        </label>

        <div className="grid grid-cols-2 gap-4">
          <label className="block">
            <div className="text-sm font-medium mb-1">Default Cost</div>
            <input
              type="number"
              step="0.01"
              className="border rounded w-full px-3 py-2"
              value={form.default_cost}
              onChange={(e) => set("default_cost", Number(e.target.value))}
            />
          </label>
          <label className="block">
            <div className="text-sm font-medium mb-1">Default Price</div>
            <input
              type="number"
              step="0.01"
              className="border rounded w-full px-3 py-2"
              value={form.default_price}
              onChange={(e) => set("default_price", Number(e.target.value))}
            />
          </label>
        </div>

        <label className="block">
          <div className="text-sm font-medium mb-1">Low Stock Threshold</div>
          <input
            type="number"
            className="border rounded w-full px-3 py-2"
            value={form.low_stock_threshold}
            onChange={(e) => set("low_stock_threshold", Number(e.target.value))}
          />
        </label>
      </div>

      <button
        type="submit"
        disabled={pending || !form.name}
        className="px-4 py-2 rounded-xl bg-neutral-900 text-white"
      >
        {pending ? "Saving…" : "Create Part"}
      </button>
    </form>
  );
}


==================== FILE: features/parts/components/PartPicker.tsx ====================

// features/parts/components/PartPicker.tsx (FULL FILE REPLACEMENT)
// Fixes:
// 1) Unit cost auto-fills when selecting a part (uses parts.unit_cost OR parts.price).
// 2) Quantity input is editable/clearable (string state), converts to number on confirm.
// 3) Keeps strict typing (no `any`).
// 4) Lint: stabilize selectedStocks via useMemo.

"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import {
  useAiPartSuggestions,
  type AiPartSuggestion,
} from "@/features/parts/hooks/useAiPartSuggestions";

type DB = Database;
type UUID = string;

type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];

type VStock = {
  part_id: UUID;
  location_id: UUID;
  qty_available: number;
  qty_on_hand: number;
  qty_reserved: number;
};

export type AvailabilityFlag =
  | "in_stock"
  | "low_stock"
  | "out_of_stock"
  | "unknown";

export type PickedPart = {
  part_id: UUID;
  location_id?: UUID;
  qty: number;
  unit_cost: number | null;
  availability?: AvailabilityFlag | null;
};

type Props = {
  open: boolean;
  channel?: string;
  initialSearch?: string;
  workOrderId?: string;
  workOrderLineId?: string | null;
  vehicleSummary?:
    | {
        year?: number | string | null;
        make?: string | null;
        model?: string | null;
      }
    | null;
  jobDescription?: string | null;
  jobNotes?: string | null;
  onClose?: () => void;
  onPick?: (sel: PickedPart) => void;
};

function cleanNumericString(raw: string): string {
  if (raw === "") return "";
  const v = raw.replace(/[^\d.]/g, "");
  return v === "" ? "" : v.replace(/^0+(?=\d)/, "");
}

function safeQty(n: number): number {
  if (!Number.isFinite(n)) return 1;
  return n <= 0 ? 1 : n;
}

function parseQty(raw: string): number {
  if (raw.trim() === "") return 0;
  const n = Number.parseFloat(raw);
  return Number.isFinite(n) ? n : 0;
}

function getPartDefaultUnitCost(p: PartRow | null): number | null {
  if (!p) return null;

  // common columns used across your app
  const unitCost = (p as unknown as { unit_cost?: unknown }).unit_cost;
  if (typeof unitCost === "number" && Number.isFinite(unitCost)) return unitCost;

  const price = (p as unknown as { price?: unknown }).price;
  if (typeof price === "number" && Number.isFinite(price)) return price;

  return null;
}

export function PartPicker({
  open,
  channel = "partpicker",
  initialSearch = "",
  workOrderId,
  workOrderLineId,
  vehicleSummary,
  jobDescription,
  jobNotes,
  onClose,
  onPick,
}: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<UUID>("");
  const [search, setSearch] = useState(initialSearch);

  const [parts, setParts] = useState<PartRow[]>([]);
  const [stock, setStock] = useState<Record<UUID, VStock[]>>({});
  const [locs, setLocs] = useState<StockLoc[]>([]);

  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const [selectedPartId, setSelectedPartId] = useState<UUID | null>(null);
  const [selectedLocId, setSelectedLocId] = useState<UUID | null>(null);

  // ✅ allow clearing/editing freely
  const [qtyStr, setQtyStr] = useState<string>("1");
  const qtyNum = useMemo(() => parseQty(qtyStr), [qtyStr]);

  const [unitCostStr, setUnitCostStr] = useState<string>("");

  const {
    loading: aiLoading,
    items: aiItems,
    error: aiErr,
    suggest,
  } = useAiPartSuggestions();

  const mainLocId = useMemo(() => {
    const m = locs.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
    return (m?.id as UUID | undefined) ?? null;
  }, [locs]);

  const selectedPart = useMemo(() => {
    if (!selectedPartId) return null;
    return parts.find((p) => (p.id as UUID) === selectedPartId) ?? null;
  }, [parts, selectedPartId]);

  const ensureUnitCostFilled = useCallback(
    (p: PartRow | null) => {
      // only fill if user hasn't typed anything
      if (unitCostStr.trim().length > 0) return;
      const def = getPartDefaultUnitCost(p);
      if (typeof def === "number") setUnitCostStr(def.toFixed(2));
    },
    [unitCostStr],
  );

  useEffect(() => {
    if (!open) return;

    (async () => {
      setErr(null);

      const { data: auth } = await supabase.auth.getUser();
      const userId = auth.user?.id;
      if (!userId) return;

      // profiles keyed by id = auth.uid()
      const { data: prof, error: pe } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("id", userId)
        .maybeSingle();

      if (pe) {
        setErr(pe.message);
        return;
      }

      const sid = (prof?.shop_id as UUID | null) ?? "";
      setShopId(sid);

      if (!sid) return;

      const { data: locsData, error: le } = await supabase
        .from("stock_locations")
        .select("id, code, name, shop_id")
        .eq("shop_id", sid)
        .order("code");

      if (le) {
        setErr(le.message);
        return;
      }

      setLocs((locsData ?? []) as StockLoc[]);
    })();
  }, [open, supabase]);

  useEffect(() => {
    if (!open || !workOrderId) return;

    void suggest({
      workOrderId,
      workOrderLineId: workOrderLineId ?? null,
      vehicle: vehicleSummary ?? null,
      description: jobDescription ?? null,
      notes: jobNotes ?? null,
      topK: 5,
    });
  }, [
    open,
    workOrderId,
    workOrderLineId,
    vehicleSummary,
    jobDescription,
    jobNotes,
    suggest,
  ]);

  useEffect(() => {
    if (!open || !shopId) return;

    let cancelled = false;

    (async () => {
      setLoading(true);
      setErr(null);

      try {
        let q = supabase
          .from("parts")
          .select("*")
          .eq("shop_id", shopId)
          .order("name")
          .limit(50);

        const term = search.trim();
        if (term) {
          q = q.or(
            `name.ilike.%${term}%,sku.ilike.%${term}%,category.ilike.%${term}%`,
          );
        }

        const { data: rows, error } = await q;
        if (error) throw error;
        if (cancelled) return;

        const rowsSafe = (rows ?? []) as PartRow[];
        setParts(rowsSafe);

        const ids = rowsSafe.map((r) => r.id as UUID);
        if (ids.length) {
          const { data: vs, error: ve } = await supabase
            .from("v_part_stock")
            .select("part_id, location_id, qty_available, qty_on_hand, qty_reserved")
            .in("part_id", ids);

          if (ve) throw ve;

          const grouped: Record<UUID, VStock[]> = {};
          (vs ?? []).forEach((s) => {
            const key = s.part_id as UUID;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push({
              part_id: s.part_id as UUID,
              location_id: s.location_id as UUID,
              qty_available: Number(s.qty_available),
              qty_on_hand: Number(s.qty_on_hand),
              qty_reserved: Number(s.qty_reserved),
            });
          });

          if (!cancelled) setStock(grouped);
        } else {
          setStock({});
        }
      } catch (e: unknown) {
        if (!cancelled) setErr(e instanceof Error ? e.message : "Search failed");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [open, shopId, search, supabase]);

  useEffect(() => {
    if (!open) return;
    setSelectedPartId(null);
    setSelectedLocId(null);
    setQtyStr("1");
    setUnitCostStr("");
    setSearch(initialSearch);
  }, [open, initialSearch]);

  // ✅ when selecting a part, auto-fill unit cost (if empty)
  useEffect(() => {
    if (!open) return;
    if (!selectedPartId) return;
    ensureUnitCostFilled(selectedPart);
  }, [open, selectedPartId, selectedPart, ensureUnitCostFilled]);

  // ✅ LINT FIX: stabilize selectedStocks
  const selectedStocks = useMemo(() => {
    return selectedPartId ? stock[selectedPartId] ?? [] : [];
  }, [selectedPartId, stock]);

  const locMap = useMemo(
    () => new Map<UUID, StockLoc>(locs.map((l) => [l.id as UUID, l])),
    [locs],
  );

  const defaultLocId: UUID | null =
    selectedLocId ?? mainLocId ?? (selectedStocks[0]?.location_id ?? null);

  const emit = (name: "close" | "pick", detail?: unknown) => {
    const ev = new CustomEvent(`${channel}:${name}`, { detail });
    window.dispatchEvent(ev);
  };

  const close = () => {
    onClose?.();
    emit("close");
  };

  const parsedUnitCost = useMemo(() => {
    const n = Number.parseFloat(unitCostStr);
    return Number.isFinite(n) ? n : 0;
  }, [unitCostStr]);

  const availabilityLabel = useMemo(() => {
    if (!selectedPartId) return "—";
    if (!selectedStocks.length) return "No stock records";
    const totalAvail = selectedStocks.reduce(
      (sum, s) => sum + Number(s.qty_available || 0),
      0,
    );
    if (totalAvail <= 0) return "Out of stock";
    if (totalAvail < qtyNum) return "Low / partial stock";
    return "In stock";
  }, [selectedPartId, selectedStocks, qtyNum]);

  const computeAvailabilityFlag = (): AvailabilityFlag | null => {
    if (!selectedPartId || !selectedStocks.length) return "unknown";
    const totalAvail = selectedStocks.reduce(
      (sum, s) => sum + Number(s.qty_available || 0),
      0,
    );
    if (totalAvail <= 0) return "out_of_stock";
    if (totalAvail < qtyNum) return "low_stock";
    return "in_stock";
  };

  const confirmPick = () => {
    if (!selectedPartId) return;

    const qty = qtyNum;
    if (qty <= 0) return;

    const payload: PickedPart = {
      part_id: selectedPartId,
      location_id: selectedLocId ?? undefined,
      qty,
      unit_cost: parsedUnitCost || null,
      availability: computeAvailabilityFlag(),
    };

    onPick?.(payload);
    emit("pick", payload);
    close();
  };

  async function resolveSuggestionToPartId(
    s: AiPartSuggestion,
  ): Promise<string | null> {
    if (!shopId) return null;

    if (s.sku) {
      const { data } = await supabase
        .from("parts")
        .select("id")
        .eq("shop_id", shopId)
        .eq("sku", s.sku)
        .maybeSingle();
      if (data?.id) return data.id as string;
    }

    if (s.name) {
      const { data } = await supabase
        .from("parts")
        .select("id")
        .eq("shop_id", shopId)
        .ilike("name", s.name)
        .maybeSingle();
      if (data?.id) return data.id as string;
    }

    return null;
  }

  if (!open) return null;

  return (
    <div
      className="fixed inset-0 z-[500] flex items-center justify-center"
      onClick={(e) => {
        e.stopPropagation();
      }}
    >
      {/* Backdrop */}
      <div
        className="fixed inset-0 bg-black/70 backdrop-blur-sm"
        aria-hidden="true"
        onClick={() => close()}
      />

      {/* Panel */}
      <div
        className="relative z-[510] w-full max-w-4xl"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-4 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl md:p-6">
          {/* Header */}
          <div className="mb-4 flex items-center justify-between gap-4">
            <div>
              <div className="text-xs uppercase tracking-[0.2em] text-neutral-500">
                Select a part
              </div>
              <h3
                className="mt-1 text-2xl font-semibold text-white"
                style={{ fontFamily: "var(--font-blackops), system-ui" }}
              >
                Part Picker
              </h3>
            </div>

            <button
              onClick={close}
              className="rounded-full border border-neutral-700 bg-neutral-950 px-4 py-2 text-sm text-neutral-100 hover:border-orange-500 hover:bg-neutral-900"
              type="button"
            >
              Close
            </button>
          </div>

          {/* AI Suggestions */}
          <div className="mb-4 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl">
            <div className="flex items-center justify-between border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-2.5">
              <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                AI suggestions
              </div>
              {aiLoading ? (
                <div className="text-xs text-neutral-400">Thinking…</div>
              ) : null}
            </div>

            <div className="p-3">
              {aiErr ? (
                <div className="text-xs text-red-300">{aiErr}</div>
              ) : aiItems.length === 0 ? (
                <div className="text-xs text-neutral-500">No suggestions.</div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {aiItems.map((s, i) => (
                    <button
                      key={`${s.sku ?? s.name ?? "s"}-${i}`}
                      className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-1.5 text-xs text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-[color:var(--accent-copper,#f97316)]/10"
                      title={s.rationale || ""}
                      type="button"
                      onClick={async () => {
                        const pid = await resolveSuggestionToPartId(s);
                        if (pid) {
                          setSelectedPartId(pid as UUID);
                          setQtyStr(String(safeQty(Number(s.qty ?? 1))));
                          // unit cost will auto-fill from selectedPart once parts list includes it
                        } else {
                          setSearch(s.sku || s.name || "");
                        }
                      }}
                    >
                      {(s.sku ? `${s.sku} • ` : "") + s.name}
                      {s.qty ? ` ×${s.qty}` : ""}
                    </button>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Search */}
          <div className="mb-4">
            <input
              className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] placeholder:text-neutral-500 backdrop-blur-md"
              placeholder="Search name, SKU, category…"
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>

          {err ? <div className="mb-3 text-sm text-red-300">{err}</div> : null}

          {loading ? (
            <div className="text-sm text-neutral-400">Searching…</div>
          ) : (
            <div className="grid gap-4 md:grid-cols-2">
              {/* Results */}
              <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl">
                <div className="flex items-center justify-between border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-2.5">
                  <div className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                    Results
                  </div>
                  <div className="text-[11px] text-neutral-500">{parts.length} shown</div>
                </div>

                <div className="max-h-80 overflow-auto p-2">
                  {parts.length === 0 ? (
                    <div className="p-3 text-sm text-neutral-400">No parts found.</div>
                  ) : (
                    parts.map((p) => {
                      const pid = p.id as UUID;
                      const active = selectedPartId === pid;
                      return (
                        <button
                          key={pid}
                          onClick={() => {
                            setSelectedPartId(pid);

                            // ✅ auto-fill unit cost immediately from the clicked row (if empty)
                            const def = getPartDefaultUnitCost(p);
                            if (unitCostStr.trim().length === 0 && typeof def === "number") {
                              setUnitCostStr(def.toFixed(2));
                            }
                          }}
                          className={[
                            "block w-full rounded-xl border px-3 py-2 text-left transition",
                            "border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 hover:bg-black/70",
                            active
                              ? "ring-2 ring-[color:var(--accent-copper,#f97316)]/60"
                              : "ring-0",
                          ].join(" ")}
                          type="button"
                        >
                          <div className="truncate text-sm font-semibold text-neutral-50">
                            {p.name ?? "Unnamed part"}
                          </div>
                          <div className="truncate text-xs text-neutral-500">
                            {p.sku ?? "—"} • {p.category ?? "Uncategorized"}
                          </div>
                        </button>
                      );
                    })
                  )}
                </div>
              </div>

              {/* Stock & Pricing */}
              <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-4 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl">
                <div className="mb-2 text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                  Stock & pricing
                </div>

                {!selectedPartId ? (
                  <div className="text-sm text-neutral-400">
                    Select a part to view stock.
                  </div>
                ) : selectedStocks.length === 0 ? (
                  <div className="text-sm text-neutral-400">
                    No stock entries yet (you can still use/consume).
                  </div>
                ) : (
                  <div className="grid gap-2">
                    {selectedStocks
                      .slice()
                      .sort((a, b) => Number(b.qty_available) - Number(a.qty_available))
                      .map((s) => {
                        const l = locMap.get(s.location_id as UUID);
                        const checked =
                          (selectedLocId ?? defaultLocId) === s.location_id;

                        return (
                          <label
                            key={s.location_id}
                            className={[
                              "flex items-center justify-between gap-3 rounded-xl border p-3",
                              "border-[color:var(--metal-border-soft,#1f2937)] bg-black/50",
                              checked
                                ? "ring-2 ring-[color:var(--accent-copper,#f97316)]/50"
                                : "",
                            ].join(" ")}
                          >
                            <div className="min-w-0">
                              <div className="text-sm font-semibold text-neutral-100">
                                {l?.code ?? "LOC"}
                              </div>
                              <div className="truncate text-xs text-neutral-500">
                                {l?.name ?? String(s.location_id).slice(0, 6) + "…"}
                              </div>
                            </div>

                            <div className="tabular-nums text-sm font-semibold text-neutral-50">
                              {Number(s.qty_available)} avail
                            </div>

                            <input
                              type="radio"
                              name="loc"
                              className="ml-1"
                              checked={!!checked}
                              onChange={() => setSelectedLocId(s.location_id as UUID)}
                            />
                          </label>
                        );
                      })}
                  </div>
                )}

                <div className="mt-4 grid grid-cols-2 gap-3">
                  <div className="grid gap-1.5">
                    <div className="text-xs text-neutral-500">Quantity</div>
                    <input
                      type="text"
                      inputMode="decimal"
                      value={qtyStr}
                      onChange={(e) => setQtyStr(cleanNumericString(e.target.value))}
                      className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500"
                      placeholder="e.g. 1"
                    />
                  </div>

                  <div className="grid gap-1.5">
                    <div className="text-xs text-neutral-500">Location</div>
                    <select
                      value={defaultLocId ?? ""}
                      onChange={(e) =>
                        setSelectedLocId((e.target.value || null) as UUID | null)
                      }
                      className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100"
                    >
                      <option value="">Auto</option>
                      {locs.map((l) => (
                        <option key={l.id as UUID} value={l.id as UUID}>
                          {l.code} — {l.name}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>

                <div className="mt-3 grid grid-cols-2 gap-3">
                  <div className="grid gap-1.5">
                    <div className="text-xs text-neutral-500">Unit cost</div>
                    <input
                      type="text"
                      inputMode="decimal"
                      value={unitCostStr}
                      onChange={(e) => setUnitCostStr(cleanNumericString(e.target.value))}
                      className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500"
                      placeholder="e.g. 45.00"
                    />
                  </div>

                  <div className="grid gap-1.5">
                    <div className="text-xs text-neutral-500">Availability</div>
                    <div className="flex items-center rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/50 px-3 py-2 text-sm text-neutral-200">
                      {availabilityLabel}
                    </div>
                  </div>
                </div>

                <div className="mt-4 flex justify-end">
                  <button
                    disabled={!selectedPartId || qtyNum <= 0}
                    onClick={confirmPick}
                    className="inline-flex items-center justify-center rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-5 py-2 text-sm font-semibold text-neutral-50 shadow-[0_16px_36px_rgba(0,0,0,0.95)] backdrop-blur-md transition hover:border-[color:var(--accent-copper-light,#fed7aa)] hover:bg-[color:var(--accent-copper,#f97316)]/20 disabled:cursor-not-allowed disabled:opacity-60"
                    type="button"
                  >
                    Use Part
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default PartPicker;

==================== FILE: features/parts/components/PartsDrawer.tsx ====================

// features/work-orders/components/workorders/PartsDrawer.tsx (FULL FILE REPLACEMENT)
// Drawer modal with tabs: Use from Inventory vs Request to Purchase
// IMPORTANT: PartPicker must be rendered inline (no fixed inset/backdrop) to avoid nested modals.
// This file assumes PartPicker supports `variant="inline"`.

"use client";

import { useCallback, useEffect, useState } from "react";
import PartPicker, {
  type PickedPart,
} from "@/features/parts/components/PartPicker";
import PartsRequestModal from "@/features/work-orders/components/workorders/PartsRequestModal";
import { toast } from "sonner";
import { consumePart } from "@/features/work-orders/lib/parts/consumePart";

type SerializableVehicle =
  | {
      year?: number | string | null;
      make?: string | null;
      model?: string | null;
    }
  | null;

type Props = {
  open: boolean;
  workOrderId: string;
  workOrderLineId: string;
  vehicleSummary?: SerializableVehicle;
  jobDescription?: string | null;
  jobNotes?: string | null;
  closeEventName?: string;
};

function asFiniteNumberOrUndefined(v: unknown): number | undefined {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : undefined;
}

export default function PartsDrawer({
  open,
  workOrderId,
  workOrderLineId,
  vehicleSummary = null,
  jobDescription = null,
  jobNotes = null,
  closeEventName = "parts-drawer:closed",
}: Props) {
  const [tab, setTab] = useState<"use" | "request">("use");

  const emitClose = useCallback(() => {
    window.dispatchEvent(new CustomEvent(closeEventName));
  }, [closeEventName]);

  const handleUsePart = useCallback(
    async (picked: PickedPart) => {
      try {
        const qty = Number(picked.qty);
        if (!picked.part_id || !Number.isFinite(qty) || qty <= 0) {
          toast.error("Pick a part and quantity first.");
          return;
        }

        const unitCost = asFiniteNumberOrUndefined(picked.unit_cost);

        await consumePart({
          work_order_line_id: workOrderLineId,
          part_id: picked.part_id,
          qty,
          location_id: picked.location_id ?? undefined,
          ...(typeof unitCost === "number" ? { unit_cost: unitCost } : {}),
          availability: picked.availability ?? null,
        });

        toast.success("Part used on job (inventory updated).");
        window.dispatchEvent(new CustomEvent("wo:parts-used"));
        emitClose();
      } catch (e: unknown) {
        const msg = e instanceof Error ? e.message : "Failed to use part.";
        toast.error(msg);
      }
    },
    [emitClose, workOrderLineId],
  );

  useEffect(() => {
    if (!open) return;

    const onCloseReq = () => emitClose();
    const onSubmitted = () => {
      toast.success("Parts request submitted");
      emitClose();
    };

    window.addEventListener("parts-request:close", onCloseReq);
    window.addEventListener("parts-request:submitted", onSubmitted);
    return () => {
      window.removeEventListener("parts-request:close", onCloseReq);
      window.removeEventListener("parts-request:submitted", onSubmitted);
    };
  }, [open, emitClose]);

  if (!open) return null;

  const tabBtn = (active: boolean) =>
    active
      ? "rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-4 py-2 text-sm font-semibold text-neutral-50 shadow-[0_12px_30px_rgba(0,0,0,0.9)] backdrop-blur-md"
      : "rounded-full border border-transparent px-4 py-2 text-sm text-neutral-300 hover:text-white";

  return (
    <div className="fixed inset-0 z-[510]" onClick={(e) => e.stopPropagation()}>
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/70 backdrop-blur-sm"
        onClick={emitClose}
        aria-hidden="true"
      />

      {/* Panel */}
      <div
        className="absolute inset-x-0 bottom-0 z-[520] w-full overflow-hidden rounded-t-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 text-white shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl md:inset-auto md:top-1/2 md:left-1/2 md:h-[85vh] md:w-[960px] md:-translate-x-1/2 md:-translate-y-1/2 md:rounded-2xl"
        onClick={(e) => e.stopPropagation()}
      >
        {/* subtle radial like menu page */}
        <div
          aria-hidden
          className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.16),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.95),#020617_70%)]"
        />

        {/* Header */}
        <div className="metal-card flex items-center justify-between gap-3 border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-3 md:px-5">
          <div>
            <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">
              Parts
            </div>
            <div
              className="text-lg font-semibold text-white"
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              Parts Drawer
            </div>
          </div>

          <button
            onClick={emitClose}
            className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 px-4 py-2 text-sm text-neutral-100 hover:border-[color:var(--accent-copper,#f97316)]/70 hover:bg-black/70"
          >
            Close
          </button>
        </div>

        {/* Tabs */}
        <div className="flex flex-wrap items-center gap-2 border-b border-white/10 px-4 py-3 md:px-5">
          <button
            className={tabBtn(tab === "use")}
            onClick={() => setTab("use")}
            type="button"
          >
            Use from Inventory
          </button>
          <button
            className={tabBtn(tab === "request")}
            onClick={() => setTab("request")}
            type="button"
          >
            Request to Purchase
          </button>

          <div className="ml-auto hidden rounded-full border border-white/10 bg-black/50 px-3 py-1 text-[11px] text-neutral-300 md:block">
            Copper / glass theme
          </div>
        </div>

        {/* Body */}
        <div className="h-[70vh] overflow-auto p-4 md:h-[calc(85vh-120px)] md:p-5">
          {tab === "use" ? (
            <div className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-3 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl md:p-4">
              <PartPicker
                open={true}
                // @ts-expect-error If PartPicker doesn't have variant yet, patch PartPicker with variant="inline"
                variant="inline"
                onClose={emitClose}
                onPick={handleUsePart}
                initialSearch=""
                workOrderId={workOrderId}
                workOrderLineId={workOrderLineId}
                jobDescription={jobDescription}
                jobNotes={jobNotes}
                vehicleSummary={vehicleSummary}
              />
            </div>
          ) : (
            <div className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-3 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl md:p-4">
              <PartsRequestModal
                isOpen={true}
                workOrderId={workOrderId}
                jobId={workOrderLineId}
                closeEventName="parts-request:close"
                submittedEventName="parts-request:submitted"
              />
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

==================== FILE: features/parts/components/PartsRequestChat.tsx ====================

// features/parts/components/PartsRequestChat.tsx
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { v4 as uuidv4 } from "uuid";
import { toast } from "sonner";

type Message = Database["public"]["Tables"]["parts_request_messages"]["Row"];

interface Props {
  // allow null/undefined from parents safely
  requestId: string | null | undefined;
  senderId: string;
}

export default function PartsRequestChat({ requestId, senderId }: Props) {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);

  const [messages, setMessages] = useState<Message[]>([]);
  const [newMsg, setNewMsg] = useState("");
  const bottomRef = useRef<HTMLDivElement | null>(null);

  // Fetch messages (guard if requestId isn't ready)
  useEffect(() => {
    if (!requestId) return;

    let cancelled = false;
    (async () => {
      const { data, error } = await supabase
        .from("parts_request_messages")
        .select("*")
        .eq("request_id", requestId)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Failed to load parts request messages:", error);
        return;
      }
      if (!cancelled && data) setMessages(data);
    })();

    return () => {
      cancelled = true;
    };
  }, [requestId, supabase]);

  // Realtime inserts (guard if requestId isn't ready)
  useEffect(() => {
    if (!requestId) return;

    const channel = supabase
      .channel(`req-messages-${requestId}`)
      .on(
        "postgres_changes",
        {
          event: "INSERT",
          schema: "public",
          table: "parts_request_messages",
          filter: `request_id=eq.${requestId}`,
        },
        (payload) => {
          const newMessage = payload.new as Message;
          setMessages((prev) => [...prev, newMessage]);
          if (newMessage.sender_id !== senderId) {
            toast.info("New message on request");
          }
        },
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [requestId, senderId, supabase]);

  // Auto-scroll on new messages
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  const handleSend = async () => {
    const content = newMsg.trim();
    if (!requestId || !content) return;

    const { error } = await supabase.from("parts_request_messages").insert({
      id: uuidv4(),
      request_id: requestId,
      sender_id: senderId,
      message: content,
    });

    if (error) {
      console.error("Failed to send parts request message:", error);
      toast.error("Failed to send message");
    } else {
      setNewMsg("");
    }
  };

  // If we don't have a valid request, render nothing (or a placeholder)
  if (!requestId) {
    return null;
  }

  return (
    <div className="border-t border-gray-700 mt-3 pt-2">
      <div className="max-h-40 overflow-y-auto space-y-2 text-sm">
        {messages.map((msg) => {
          const ts = msg.created_at ? new Date(msg.created_at) : null;
          return (
            <div
              key={msg.id}
              className={`p-2 rounded ${
                msg.sender_id === senderId
                  ? "bg-orange-600 text-white ml-auto text-right"
                  : "bg-gray-700 text-white mr-auto"
              }`}
            >
              <p>{msg.message}</p>
              <p className="text-xs text-gray-400">
                {ts ? ts.toLocaleTimeString() : ""}
              </p>
            </div>
          );
        })}
        <div ref={bottomRef} />
      </div>

      <div className="mt-2 flex items-center gap-2">
        <input
          value={newMsg}
          onChange={(e) => setNewMsg(e.target.value)}
          onKeyDown={(e) => e.key === "Enter" && handleSend()}
          placeholder="Type a message..."
          className="flex-1 rounded bg-neutral-800 border border-neutral-600 px-3 py-2 text-white"
        />
        <button
          onClick={handleSend}
          className="bg-orange-500 hover:bg-orange-600 px-3 py-1 rounded text-white"
          disabled={!requestId || !newMsg.trim()}
        >
          Send
        </button>
      </div>
    </div>
  );
}

==================== FILE: features/parts/components/PartsStaffQueue.tsx ====================

// features/parts/components/PartsStaffQueue.tsx (FULL FILE REPLACEMENT)
// Adds "Receive" UI for part_request_items (partial receive handling).
// No `any`. Uses Supabase row types.

"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { toast } from "sonner";

type DB = Database;
type UUID = string;

type PartRequestItemRow = DB["public"]["Tables"]["part_request_items"]["Row"];
type PartRequestRow = DB["public"]["Tables"]["part_requests"]["Row"];
type StockLocRow = DB["public"]["Tables"]["stock_locations"]["Row"];

type QueueRow = {
  item: PartRequestItemRow;
  request: PartRequestRow | null;
};

function num(v: unknown): number {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function s(v: unknown): string {
  return typeof v === "string" ? v : "";
}

export default function PartsStaffQueue() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [rows, setRows] = useState<QueueRow[]>([]);

  // Receive modal state
  const [receiving, setReceiving] = useState<{
    open: boolean;
    itemId: UUID | null;
    shopId: UUID | null;
    partName: string;
    qtyRemaining: number;
  }>({ open: false, itemId: null, shopId: null, partName: "", qtyRemaining: 0 });

  const [locs, setLocs] = useState<StockLocRow[]>([]);
  const [locationId, setLocationId] = useState<string>("");
  const [qty, setQty] = useState<number>(1);
  const [submitting, setSubmitting] = useState(false);

  const mainLocId = useMemo(() => {
    const main = locs.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
    return (main?.id as string | undefined) ?? "";
  }, [locs]);

  async function loadQueue() {
    setLoading(true);
    setErr(null);

    try {
      const { data, error } = await supabase
        .from("part_request_items")
        .select(
          `
            *,
            part_requests:part_requests (
              id,
              shop_id,
              work_order_id,
              requested_by,
              assigned_to,
              status,
              notes,
              created_at,
              job_id
            )
          `,
        )
        .in("status", [
          "approved",
          "reserved",
          "ordered",
          "picking",
          "picked",
          "partially_received",
          "received",
        ])
        .order("created_at", { ascending: false })
        .limit(200);

      if (error) throw error;

      const mapped: QueueRow[] = (data ?? []).map((r) => {
        const item = r as PartRequestItemRow & { part_requests?: PartRequestRow | null };
        return {
          item,
          request: (item.part_requests ?? null) as PartRequestRow | null,
        };
      });

      setRows(mapped);
    } catch (e: unknown) {
      setErr(e instanceof Error ? e.message : "Failed to load queue");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    void loadQueue();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  async function openReceive(row: QueueRow) {
    const it = row.item;
    const req = row.request;

    const shopId = s((it as unknown as { shop_id?: unknown }).shop_id) || s(req?.shop_id);

    const qtyRequested = num((it as unknown as { qty_requested?: unknown }).qty_requested ?? it.qty);
    const qtyApproved = num((it as unknown as { qty_approved?: unknown }).qty_approved);
    const qtyTarget = qtyApproved > 0 ? qtyApproved : qtyRequested;

    const qtyReceived = num((it as unknown as { qty_received?: unknown }).qty_received);
    const remaining = Math.max(0, qtyTarget - qtyReceived);

    if (!shopId) {
      toast.error("Missing shop_id on item; cannot load locations.");
      return;
    }

    // Load locations for this shop
    const { data: locRows, error: locErr } = await supabase
      .from("stock_locations")
      .select("id, code, name, shop_id")
      .eq("shop_id", shopId)
      .order("code");

    if (locErr) {
      toast.error(locErr.message);
      return;
    }

    setLocs((locRows ?? []) as StockLocRow[]);

    setReceiving({
      open: true,
      itemId: it.id as UUID,
      shopId: shopId as UUID,
      partName: String(it.description ?? "Part"),
      qtyRemaining: remaining,
    });

    const defaultLoc = (locRows ?? []).find((l) => (l.code ?? "").toUpperCase() === "MAIN")?.id;
    setLocationId(typeof defaultLoc === "string" ? defaultLoc : "");
    setQty(remaining > 0 ? Math.min(remaining, 1) : 1);
  }

  async function submitReceive() {
    if (!receiving.itemId) return;

    if (!locationId) {
      toast.error("Select a location.");
      return;
    }

    if (!qty || !Number.isFinite(qty) || qty <= 0) {
      toast.error("Quantity must be > 0.");
      return;
    }

    setSubmitting(true);
    try {
      const res = await fetch(`/api/parts/requests/items/${receiving.itemId}/receive`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          location_id: locationId,
          qty,
        }),
      });

      const json = (await res.json().catch(() => null)) as { ok?: boolean; error?: string } | null;

      if (!res.ok || !json || json.error) {
        throw new Error(json?.error ?? "Receive failed");
      }

      toast.success("Received.");
      setReceiving({ open: false, itemId: null, shopId: null, partName: "", qtyRemaining: 0 });
      setLocs([]);
      setLocationId("");
      setQty(1);

      await loadQueue();
      window.dispatchEvent(new CustomEvent("parts:received"));
    } catch (e: unknown) {
      toast.error(e instanceof Error ? e.message : "Receive failed");
    } finally {
      setSubmitting(false);
    }
  }

  if (loading) return <div className="text-sm text-neutral-400">Loading parts queue…</div>;
  if (err) return <div className="text-sm text-red-300">{err}</div>;
  if (rows.length === 0) return <div className="text-sm text-neutral-400">No queued parts right now.</div>;

  return (
    <div className="grid gap-3">
      {rows.map((r) => {
        const it = r.item;
        const req = r.request;

        const qtyRequested = num((it as unknown as { qty_requested?: unknown }).qty_requested ?? it.qty);
        const qtyApproved = num((it as unknown as { qty_approved?: unknown }).qty_approved);
        const qtyReserved = num((it as unknown as { qty_reserved?: unknown }).qty_reserved);
        const qtyReceived = num((it as unknown as { qty_received?: unknown }).qty_received);

        const qtyTarget = qtyApproved > 0 ? qtyApproved : qtyRequested;
        const remaining = Math.max(0, qtyTarget - qtyReceived);

        const status = String((it as unknown as { status?: unknown }).status ?? "");

        return (
          <div
            key={String(it.id)}
            className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 p-4 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl"
          >
            <div className="flex flex-wrap items-start justify-between gap-3">
              <div className="min-w-0">
                <div className="truncate text-sm font-semibold text-neutral-50">
                  {it.description ?? "Part"}
                </div>
                <div className="mt-1 text-xs text-neutral-500">
                  Status: <span className="text-neutral-200">{status || "—"}</span>
                  {req?.work_order_id ? (
                    <>
                      {" "}
                      • WO:{" "}
                      <span className="text-neutral-200">{String(req.work_order_id).slice(0, 8)}…</span>
                    </>
                  ) : null}
                </div>
              </div>

              <div className="flex flex-wrap items-center gap-2 text-xs">
                <span className="rounded-full border border-white/10 bg-black/50 px-3 py-1 text-neutral-200">
                  Req {qtyRequested}
                </span>
                <span className="rounded-full border border-white/10 bg-black/50 px-3 py-1 text-neutral-200">
                  App {qtyApproved}
                </span>
                <span className="rounded-full border border-white/10 bg-black/50 px-3 py-1 text-neutral-200">
                  Res {qtyReserved}
                </span>
                <span className="rounded-full border border-white/10 bg-black/50 px-3 py-1 text-neutral-200">
                  Rcv {qtyReceived}
                </span>
                <span className="rounded-full border border-white/10 bg-black/50 px-3 py-1 text-neutral-200">
                  Rem {remaining}
                </span>

                <button
                  type="button"
                  onClick={() => openReceive(r)}
                  className="rounded-full border border-[color:var(--accent-copper,#f97316)]/70 bg-[color:var(--accent-copper,#f97316)]/10 px-3 py-1 text-neutral-50 hover:bg-[color:var(--accent-copper,#f97316)]/20"
                >
                  Receive
                </button>
              </div>
            </div>
          </div>
        );
      })}

      {/* Receive Modal */}
      {receiving.open ? (
        <div className="fixed inset-0 z-[700] flex items-center justify-center" onClick={() => setReceiving({ open: false, itemId: null, shopId: null, partName: "", qtyRemaining: 0 })}>
          <div className="absolute inset-0 bg-black/70 backdrop-blur-sm" />
          <div
            className="relative z-[710] w-full max-w-lg rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-5 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="text-xs uppercase tracking-[0.2em] text-neutral-500">Receive</div>
            <div className="mt-1 text-lg font-semibold text-white">{receiving.partName}</div>

            <div className="mt-3 grid gap-3">
              <div className="grid gap-1.5">
                <div className="text-xs text-neutral-500">Location</div>
                <select
                  value={locationId || mainLocId || ""}
                  onChange={(e) => setLocationId(e.target.value)}
                  className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100"
                >
                  <option value="">Select…</option>
                  {locs.map((l) => (
                    <option key={String(l.id)} value={String(l.id)}>
                      {l.code} — {l.name}
                    </option>
                  ))}
                </select>
              </div>

              <div className="grid gap-1.5">
                <div className="text-xs text-neutral-500">
                  Quantity (remaining {receiving.qtyRemaining})
                </div>
                <input
                  type="number"
                  min={0}
                  step="0.01"
                  value={qty}
                  onChange={(e) => setQty(Number(e.target.value || 0))}
                  className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100"
                />
              </div>

              <div className="mt-2 flex items-center justify-end gap-2">
                <button
                  type="button"
                  onClick={() => setReceiving({ open: false, itemId: null, shopId: null, partName: "", qtyRemaining: 0 })}
                  className="rounded-full border border-white/10 bg-black/50 px-4 py-2 text-sm text-neutral-200 hover:bg-black/60"
                  disabled={submitting}
                >
                  Cancel
                </button>
                <button
                  type="button"
                  onClick={submitReceive}
                  className="rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-[color:var(--accent-copper,#f97316)]/15 px-4 py-2 text-sm font-semibold text-neutral-50 hover:bg-[color:var(--accent-copper,#f97316)]/25 disabled:opacity-60"
                  disabled={submitting}
                >
                  {submitting ? "Receiving…" : "Receive"}
                </button>
              </div>
            </div>
          </div>
        </div>
      ) : null}
    </div>
  );
}

==================== FILE: features/parts/components/ReceiveDrawer.tsx ====================

// features/parts/components/ReceiveDrawer.tsx
"use client";

import { useEffect, useMemo, useState } from "react";

type Option = { value: string; label: string };

export type ReceiveDrawerItem = {
  id: string;
  created_at?: string | null;
  request_id?: string | null;
  part_id?: string | null;
  description?: string | null;
  status?: string | null;

  qty_approved?: number | null;
  qty_received?: number | null;
  qty_remaining?: number | null;

  part_name?: string | null;
  sku?: string | null;
};

type ReceiveResult =
  | { ok: true; result?: unknown; item?: unknown }
  | { ok?: false; error?: string };

function n(v: unknown): number {
  const num = typeof v === "number" ? v : Number(v);
  return Number.isFinite(num) ? num : 0;
}

function safeText(res: Response): Promise<string> {
  return res.text().catch(() => "");
}

export default function ReceiveDrawer(props: {
  open: boolean;
  onClose?: () => void;
  closeEventName?: string;

  item: ReceiveDrawerItem | null;

  locations: Option[];
  defaultLocationId?: string;

  purchaseOrders?: Option[];
  defaultPoId?: string | null;

  lockLocation?: boolean;
  lockPo?: boolean;
}): JSX.Element | null {
  const {
    open,
    onClose,
    closeEventName,
    item,
    locations,
    defaultLocationId,
    purchaseOrders,
    defaultPoId,
    lockLocation,
    lockPo,
  } = props;

  const [locationId, setLocationId] = useState<string>(defaultLocationId ?? "");
  const [poId, setPoId] = useState<string>(defaultPoId ?? "");
  const [qty, setQty] = useState<number | "">("");

  const [submitting, setSubmitting] = useState<boolean>(false);
  const [err, setErr] = useState<string | null>(null);

  const remaining = useMemo(() => {
    if (!item) return 0;
    if (typeof item.qty_remaining === "number") return Math.max(0, item.qty_remaining);
    const approved = n(item.qty_approved);
    const received = n(item.qty_received);
    return Math.max(0, approved - received);
  }, [item]);

  // Keep a stable fallback for location (default > first option)
  const resolvedDefaultLocationId = useMemo(() => {
    const fallback = defaultLocationId ?? locations[0]?.value ?? "";
    return typeof fallback === "string" ? fallback : "";
  }, [defaultLocationId, locations]);

  // Keep a stable fallback for PO (default > empty)
  const resolvedDefaultPoId = useMemo(() => {
    const v = defaultPoId ?? "";
    return typeof v === "string" ? v : "";
  }, [defaultPoId]);

  useEffect(() => {
    if (!open) return;

    setErr(null);
    setSubmitting(false);
    setQty("");

    // ✅ Always reset when opening / switching items (prevents stale PO/location)
    setLocationId(resolvedDefaultLocationId);

    // Only set PO if PO list exists; otherwise force empty
    if (purchaseOrders && purchaseOrders.length > 0) {
      setPoId(resolvedDefaultPoId);
    } else {
      setPoId("");
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open, item?.id]);

  useEffect(() => {
    if (!open) return;

    const onKey = (e: KeyboardEvent) => {
      if (e.key === "Escape") {
        e.preventDefault();
        close();
      }
    };
    window.addEventListener("keydown", onKey);
    return () => window.removeEventListener("keydown", onKey);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [open]);

  const title = item?.part_name?.trim()
    ? `Receive — ${item.part_name}`
    : `Receive — ${item?.description ?? "Item"}`;

  const canSubmit =
    !!item?.id &&
    !!locationId &&
    typeof qty === "number" &&
    qty > 0 &&
    !submitting;

  function close(): void {
    setErr(null);
    setSubmitting(false);

    if (onClose) onClose();
    if (closeEventName) window.dispatchEvent(new Event(closeEventName));
  }

  async function submit(): Promise<void> {
    if (!item?.id) return;

    setErr(null);

    if (!locationId) {
      setErr("Select a location first.");
      return;
    }

    const q = typeof qty === "number" ? qty : 0;
    if (!q || q <= 0) {
      setErr("Enter a receive quantity.");
      return;
    }

    if (remaining > 0 && q > remaining) {
      setErr(`Qty exceeds remaining (${remaining}).`);
      return;
    }

    setSubmitting(true);

    try {
      // ✅ Canonical endpoint: item-scoped receive
      const res = await fetch(
        `/api/parts/requests/items/${encodeURIComponent(item.id)}/receive`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            location_id: locationId,
            qty: q,
            po_id: poId?.trim() ? poId.trim() : null,
          }),
        },
      );

      const raw = await safeText(res);
      let json: ReceiveResult | null = null;
      try {
        json = raw ? (JSON.parse(raw) as ReceiveResult) : null;
      } catch {
        // ignore
      }

      if (!res.ok || !json?.ok) {
        const msg =
          json && "error" in json && json.error
            ? String(json.error)
            : raw || `HTTP ${res.status}`;
        setErr(msg);
        setSubmitting(false);
        return;
      }

      // ✅ tell any pages to refresh
      window.dispatchEvent(new Event("parts:received"));

      setSubmitting(false);
      close();
    } catch (e: unknown) {
      setSubmitting(false);
      setErr(e instanceof Error ? e.message : "Receive failed.");
    }
  }

  if (!open) return null;

  const backdrop = "fixed inset-0 z-[60] bg-black/60 backdrop-blur-[2px]";
  const panel =
    "fixed right-0 top-0 z-[61] h-full w-full max-w-xl border-l border-white/10 bg-neutral-950/70 backdrop-blur-xl shadow-[-20px_0_60px_rgba(0,0,0,0.75)]";
  const header = "border-b border-white/10 bg-gradient-to-b from-white/5 to-transparent px-5 py-4";
  const body = "px-5 py-4 space-y-4";
  const footer =
    "absolute bottom-0 left-0 right-0 border-t border-white/10 bg-neutral-950/70 px-5 py-4";

  const input =
    "w-full rounded-xl border border-white/10 bg-neutral-950/40 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35";
  const select =
    "w-full rounded-xl border border-white/10 bg-neutral-950/40 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-[#8b5a2b]/35";

  const btnBase =
    "inline-flex items-center justify-center rounded-xl border px-4 py-2 text-sm font-semibold transition disabled:opacity-60";
  const btnGhost = `${btnBase} border-white/10 bg-neutral-950/20 hover:bg-white/5`;
  const btnCopper = `${btnBase} border-[#8b5a2b]/60 text-[#c88a4d] bg-neutral-950/20 hover:bg-[#8b5a2b]/10`;

  return (
    <>
      <div className={backdrop} onClick={close} />

      <div className={panel} role="dialog" aria-modal="true" aria-label="Receive drawer">
        <div className={header}>
          <div className="flex items-start justify-between gap-3">
            <div className="min-w-0">
              <div className="text-[11px] uppercase tracking-[0.22em] text-neutral-400">Parts</div>
              <div className="mt-1 truncate text-xl font-semibold text-white">{title}</div>
              <div className="mt-2 text-sm text-neutral-400">
                Receive inventory against a specific request item (supports partial receive).
              </div>
            </div>

            <button type="button" onClick={close} className={btnGhost} aria-label="Close">
              ✕
            </button>
          </div>
        </div>

        <div className={body}>
          {item ? (
            <div className="rounded-2xl border border-white/10 bg-neutral-950/35 p-4">
              <div className="text-sm font-semibold text-white">
                {item.part_name?.trim() ? item.part_name : item.description}
              </div>

              <div className="mt-2 grid gap-2 text-xs text-neutral-400">
                <div>
                  <span className="text-neutral-500">Item:</span>{" "}
                  <span className="text-neutral-200">{item.id.slice(0, 8)}</span>
                  {item.request_id ? (
                    <>
                      {" "}
                      <span className="text-neutral-600">·</span>{" "}
                      <span className="text-neutral-500">Request:</span>{" "}
                      <span className="text-neutral-200">{String(item.request_id).slice(0, 8)}</span>
                    </>
                  ) : null}
                </div>

                <div className="flex flex-wrap gap-3">
                  <div>
                    <span className="text-neutral-500">Approved:</span>{" "}
                    <span className="text-neutral-200">{n(item.qty_approved)}</span>
                  </div>
                  <div>
                    <span className="text-neutral-500">Received:</span>{" "}
                    <span className="text-neutral-200">{n(item.qty_received)}</span>
                  </div>
                  <div>
                    <span className="text-neutral-500">Remaining:</span>{" "}
                    <span className="text-neutral-200">{remaining}</span>
                  </div>
                  <div>
                    <span className="text-neutral-500">Status:</span>{" "}
                    <span className="text-neutral-200">{item.status ?? "—"}</span>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <div className="rounded-2xl border border-white/10 bg-neutral-950/35 p-4 text-sm text-neutral-400">
              No item selected.
            </div>
          )}

          {err ? (
            <div className="rounded-xl border border-red-500/30 bg-red-950/35 p-3 text-sm text-red-200">
              {err}
            </div>
          ) : null}

          <div className="grid gap-3 md:grid-cols-2">
            <div>
              <div className="mb-1 text-xs text-neutral-400">Location</div>
              <select
                className={select}
                value={locationId}
                onChange={(e) => setLocationId(e.target.value)}
                disabled={!!lockLocation}
              >
                {locations.length === 0 ? (
                  <option value="">No locations</option>
                ) : (
                  locations.map((o) => (
                    <option key={o.value} value={o.value}>
                      {o.label}
                    </option>
                  ))
                )}
              </select>
            </div>

            <div>
              <div className="mb-1 text-xs text-neutral-400">PO (optional)</div>
              <select
                className={select}
                value={poId}
                onChange={(e) => setPoId(e.target.value)}
                disabled={!!lockPo || !purchaseOrders || purchaseOrders.length === 0}
              >
                <option value="">— none —</option>
                {(purchaseOrders ?? []).map((o) => (
                  <option key={o.value} value={o.value}>
                    {o.label}
                  </option>
                ))}
              </select>
              <div className="mt-1 text-[11px] text-neutral-500">
                If selected, receiving is attributed to that PO via the RPC.
              </div>
            </div>
          </div>

          <div className="rounded-2xl border border-white/10 bg-neutral-950/20 p-4">
            <div className="mb-1 text-xs text-neutral-400">Receive Qty</div>
            <div className="flex flex-wrap items-center gap-2">
              <input
                className={`${input} w-48`}
                type="number"
                min={0.01}
                step={0.01}
                value={qty === "" ? "" : String(qty)}
                onChange={(e) => {
                  const raw = e.target.value;
                  if (raw === "") setQty("");
                  else setQty(Math.max(0, Number(raw)));
                }}
                placeholder="0"
              />

              <button
                type="button"
                className={btnGhost}
                onClick={() => setQty(remaining > 0 ? remaining : "")}
                disabled={!item || remaining <= 0}
                title="Fill with remaining"
              >
                Receive remaining
              </button>

              <button
                type="button"
                className={btnGhost}
                onClick={() => setQty(1)}
                disabled={!item}
                title="Quick set to 1"
              >
                +1
              </button>
            </div>

            {remaining > 0 ? (
              <div className="mt-2 text-[11px] text-neutral-500">
                Recommended max: <span className="text-neutral-200">{remaining}</span>
              </div>
            ) : (
              <div className="mt-2 text-[11px] text-neutral-500">
                Remaining unknown or 0 (check approved/received values).
              </div>
            )}
          </div>
        </div>

        <div className={footer}>
          <div className="flex items-center justify-end gap-2">
            <button type="button" className={btnGhost} onClick={close}>
              Cancel
            </button>
            <button type="button" className={btnCopper} onClick={() => void submit()} disabled={!canSubmit}>
              {submitting ? "Receiving…" : "Receive"}
            </button>
          </div>
        </div>
      </div>
    </>
  );
}

==================== FILE: features/parts/components/SupplierForm.tsx ====================

"use client";
import { useState, useTransition } from "react";
import { createSupplier } from "@/features/parts/lib/suppliers";

export function SupplierForm({ shopId }: { shopId: string }) {
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [phone, setPhone] = useState("");
  const [pending, start] = useTransition();
  const [err, setErr] = useState<string | null>(null);

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        setErr(null);
        start(async () => {
          try {
            await createSupplier({ shop_id: shopId, name: name.trim(), email: email || undefined, phone: phone || undefined });
            window.location.reload();
          } catch (e: any) {
            setErr(e?.message ?? "Failed");
          }
        });
      }}
    >
      {err && <div className="text-sm text-red-600">{err}</div>}
      <div className="grid md:grid-cols-3 gap-3">
        <label className="block md:col-span-1">
          <div className="text-sm font-medium mb-1">Name</div>
          <input className="border rounded w-full px-3 py-2" value={name} onChange={(e) => setName(e.target.value)} required />
        </label>
        <label className="block">
          <div className="text-sm font-medium mb-1">Email</div>
          <input className="border rounded w-full px-3 py-2" type="email" value={email} onChange={(e) => setEmail(e.target.value)} />
        </label>
        <label className="block">
          <div className="text-sm font-medium mb-1">Phone</div>
          <input className="border rounded w-full px-3 py-2" value={phone} onChange={(e) => setPhone(e.target.value)} />
        </label>
      </div>
      <button disabled={pending} className="px-3 py-2 rounded-xl bg-neutral-900 text-white">
        {pending ? "Saving…" : "Create Supplier"}
      </button>
    </form>
  );
}


==================== FILE: features/parts/components/VehiclePhotoGallery.tsx ====================

"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Dialog } from "@headlessui/react";
import {
  PencilIcon,
  TrashIcon,
  XMarkIcon,
} from "@heroicons/react/24/outline";
import type { Database } from "@shared/types/types/supabase";

type VehiclePhoto = Database["public"]["Tables"]["vehicle_photos"]["Row"];

interface Props {
  vehicleId: string;
  currentUserId: string;
}

export default function VehiclePhotoGallery({
  vehicleId,
  currentUserId,
}: Props) {
  const supabase = createClientComponentClient<Database>();

  const [photos, setPhotos] = useState<VehiclePhoto[]>([]);
  const [editingCaptionId, setEditingCaptionId] = useState<string | null>(null);
  const [editedCaption, setEditedCaption] = useState("");
  const [fullscreenPhoto, setFullscreenPhoto] = useState<VehiclePhoto | null>(
    null,
  );

  useEffect(() => {
    const fetchPhotos = async () => {
      const { data, error } = await supabase
        .from("vehicle_photos")
        .select("*")
        .eq("vehicle_id", vehicleId)
        .order("created_at", { ascending: false });

      if (error) {
        console.warn("Failed to load vehicle photos", error);
        return;
      }

      if (data) setPhotos(data);
    };

    void fetchPhotos();
  }, [vehicleId, supabase]);

  const handleDelete = async (id: string) => {
    const { error } = await supabase
      .from("vehicle_photos")
      .delete()
      .eq("id", id);
    if (error) {
      console.warn("Failed to delete vehicle photo", error);
      return;
    }
    setPhotos((prev) => prev.filter((p) => p.id !== id));
  };

  const handleCaptionSave = async (id: string) => {
    const trimmed = editedCaption.trim();
    const { error } = await supabase
      .from("vehicle_photos")
      .update({ caption: trimmed || null })
      .eq("id", id);

    if (error) {
      console.warn("Failed to update caption", error);
      return;
    }

    setPhotos((prev) =>
      prev.map((p) => (p.id === id ? { ...p, caption: trimmed || null } : p)),
    );
    setEditingCaptionId(null);
    setEditedCaption("");
  };

  return (
    <>
      {/* wrapper card for gallery */}
      <div className="mt-4 rounded-2xl border border-white/10 bg-black/30 p-3 shadow-[0_0_40px_rgba(0,0,0,0.85)]">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h3 className="text-sm font-semibold text-neutral-100">
            Vehicle photo history
          </h3>
          <p className="text-[11px] text-neutral-500">
            Click a photo to view full screen.
          </p>
        </div>

        {photos.length === 0 ? (
          <div className="rounded-xl border border-dashed border-white/15 bg-black/40 px-4 py-6 text-center text-sm text-neutral-400">
            No photos for this vehicle yet.
          </div>
        ) : (
          <div className="mt-3 grid grid-cols-2 gap-3 sm:grid-cols-3 md:grid-cols-4">
            {photos.map((photo) => (
              <div
                key={photo.id}
                className="group relative overflow-hidden rounded-xl border border-white/12 bg-black/50 shadow-[0_0_22px_rgba(0,0,0,0.9)] transition hover:border-[var(--accent-copper-light)] hover:bg-black/70"
              >
                <button
                  type="button"
                  className="block w-full focus:outline-none"
                  onClick={() => setFullscreenPhoto(photo)}
                >
                  <div className="relative aspect-video w-full bg-black/40">
                    {/* plain <img> instead of next/image */}
                    <img
                      src={photo.url}
                      alt={photo.caption || "Vehicle photo"}
                      className="h-full w-full object-cover"
                      loading="lazy"
                    />
                  </div>
                </button>

                {/* hover controls */}
                {photo.uploaded_by === currentUserId && (
                  <div className="pointer-events-none absolute inset-x-0 top-0 flex justify-end p-2 opacity-0 transition group-hover:pointer-events-auto group-hover:opacity-100">
                    <div className="flex items-center gap-1 rounded-full bg-black/70 px-2 py-1 shadow-[0_0_14px_rgba(0,0,0,0.9)]">
                      <button
                        type="button"
                        onClick={() => {
                          setEditingCaptionId(photo.id);
                          setEditedCaption(photo.caption || "");
                        }}
                        className="p-0.5 text-[11px] text-[var(--accent-copper-light)] hover:text-white"
                      >
                        <PencilIcon className="h-4 w-4" />
                      </button>
                      <button
                        type="button"
                        onClick={() => handleDelete(photo.id)}
                        className="p-0.5 text-[11px] text-red-400 hover:text-red-200"
                      >
                        <TrashIcon className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                )}

                {/* caption area */}
                <div className="border-t border-white/10 bg-black/60 px-2.5 py-2 text-[11px] text-neutral-300">
                  {editingCaptionId === photo.id ? (
                    <div className="flex items-center gap-2">
                      <input
                        value={editedCaption}
                        onChange={(e) => setEditedCaption(e.target.value)}
                        className="h-7 w-full rounded-md border border-white/20 bg-black/60 px-2 text-[11px] text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
                        placeholder="Add a note about this photo…"
                      />
                      <button
                        type="button"
                        onClick={() => handleCaptionSave(photo.id)}
                        className="rounded-full bg-[var(--accent-copper)] px-2 py-1 text-[10px] font-semibold text-black shadow-[0_0_14px_rgba(248,113,22,0.55)] hover:opacity-90"
                      >
                        Save
                      </button>
                    </div>
                  ) : photo.caption ? (
                    <p className="line-clamp-2 text-[11px] text-neutral-200">
                      {photo.caption}
                    </p>
                  ) : (
                    <p className="text-[11px] italic text-neutral-500">
                      No caption
                    </p>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* fullscreen viewer */}
      <Dialog
        open={!!fullscreenPhoto}
        onClose={() => setFullscreenPhoto(null)}
        className="fixed inset-0 z-[120] flex items-center justify-center"
      >
        {/* backdrop */}
        <div
          className="fixed inset-0 bg-black/75 backdrop-blur-sm"
          aria-hidden="true"
        />

        <div className="relative z-[130] mx-3 my-6 w-full max-w-5xl">
          <Dialog.Panel className="relative overflow-hidden rounded-2xl border border-white/15 bg-neutral-950/95 p-3 shadow-[0_0_60px_rgba(0,0,0,1)]">
            {/* close button */}
            <button
              type="button"
              className="absolute right-3 top-3 inline-flex h-8 w-8 items-center justify-center rounded-full border border-white/20 bg-black/60 text-neutral-200 shadow-sm transition hover:bg-white/10 hover:text-white"
              onClick={() => setFullscreenPhoto(null)}
            >
              <XMarkIcon className="h-4 w-4" />
            </button>

            <div className="flex flex-col gap-3 pt-2">
              <div className="relative mx-auto max-h-[70vh] w-full">
                {fullscreenPhoto && (
                  <img
                    src={fullscreenPhoto.url}
                    alt={fullscreenPhoto.caption || "Vehicle photo"}
                    className="mx-auto max-h-[70vh] w-auto rounded-xl object-contain"
                  />
                )}
              </div>

              {fullscreenPhoto?.caption && (
                <p className="mx-auto max-w-3xl px-2 pb-1 text-center text-sm text-neutral-200">
                  {fullscreenPhoto.caption}
                </p>
              )}

              <p className="text-center text-[11px] text-neutral-500">
                Click outside or press ESC to close.
              </p>
            </div>
          </Dialog.Panel>
        </div>
      </Dialog>
    </>
  );
}

==================== FILE: features/parts/components/VehiclePhotoUploader.tsx ====================

"use client";

import { useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { v4 as uuidv4 } from "uuid";
import { toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";

type VehiclePhoto = Database["public"]["Tables"]["vehicle_photos"]["Row"];

interface Props {
  vehicleId: string;
  onUpload?: (photo: VehiclePhoto) => void;
}

export default function VehiclePhotoUploader({ vehicleId, onUpload }: Props) {
  const supabase = createClientComponentClient<Database>();

  const [file, setFile] = useState<File | null>(null);
  const [caption, setCaption] = useState("");
  const [uploading, setUploading] = useState(false);

  const handleUpload = async () => {
    if (!file) return;
    setUploading(true);

    const {
      data: { user },
      error: userError,
    } = await supabase.auth.getUser();

    if (userError || !user) {
      toast.error("User not authenticated");
      setUploading(false);
      return;
    }

    const fileExt = file.name.split(".").pop();
    const fileName = `${uuidv4()}.${fileExt || "jpg"}`;
    const filePath = `${vehicleId}/${fileName}`;

    const { error: uploadError } = await supabase.storage
      .from("vehicle-photos")
      .upload(filePath, file, {
        cacheControl: "3600",
        upsert: false,
      });

    if (uploadError) {
      console.error("Vehicle photo upload failed", uploadError);
      toast.error("Upload failed");
      setUploading(false);
      return;
    }

    const { data: urlData } = supabase.storage
      .from("vehicle-photos")
      .getPublicUrl(filePath);

    const publicUrl = urlData?.publicUrl;

    if (!publicUrl) {
      toast.error("Could not get image URL");
      setUploading(false);
      return;
    }

    const trimmedCaption = caption.trim();

    const { data: inserted, error: insertError } = await supabase
      .from("vehicle_photos")
      .insert({
        vehicle_id: vehicleId,
        uploaded_by: user.id,
        url: publicUrl,
        caption: trimmedCaption || null,
      })
      .select()
      .single();

    if (insertError || !inserted) {
      console.error("Failed to save vehicle photo row", insertError);
      toast.error("Failed to save photo info");
      setUploading(false);
      return;
    }

    toast.success("Photo uploaded");
    onUpload?.(inserted);
    setFile(null);
    setCaption("");
    setUploading(false);
  };

  return (
    <div className="mt-4 rounded-2xl border border-white/10 bg-black/30 p-4 shadow-[0_0_40px_rgba(0,0,0,0.85)]">
      <div className="mb-3 flex items-center justify-between gap-2">
        <div>
          <h3 className="text-sm font-semibold text-neutral-100">
            Upload vehicle photo
          </h3>
          <p className="mt-0.5 text-[11px] text-neutral-500">
            Attach walkaround or damage documentation to this vehicle.
          </p>
        </div>
      </div>

      <div className="space-y-3">
        {/* file input */}
        <div className="flex flex-col gap-1">
          <label className="text-[11px] uppercase tracking-[0.16em] text-neutral-400">
            Image file
          </label>
          <label className="inline-flex w-full cursor-pointer items-center justify-between gap-2 rounded-full border border-white/15 bg-black/40 px-3 py-1.5 text-[12px] text-neutral-200 shadow-[0_0_18px_rgba(0,0,0,0.9)] hover:border-[var(--accent-copper-light)] hover:bg-black/60">
            <span className="truncate">
              {file ? file.name : "Choose image…"}
            </span>
            <span className="rounded-full bg-[var(--accent-copper)]/90 px-2 py-0.5 text-[11px] font-semibold text-black">
              Browse
            </span>
            <input
              type="file"
              accept="image/*"
              className="hidden"
              onChange={(e) => setFile(e.target.files?.[0] || null)}
            />
          </label>
          <p className="text-[10px] text-neutral-500">
            JPG / PNG recommended. Large images may take a moment to upload.
          </p>
        </div>

        {/* caption input */}
        <div className="flex flex-col gap-1">
          <label className="text-[11px] uppercase tracking-[0.16em] text-neutral-400">
            Caption
          </label>
          <input
            type="text"
            placeholder="e.g. Front right bumper damage, before repair"
            value={caption}
            onChange={(e) => setCaption(e.target.value)}
            className="h-9 w-full rounded-full border border-white/15 bg-black/40 px-3 text-[13px] text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        {/* action */}
        <div className="flex justify-end">
          <button
            type="button"
            onClick={handleUpload}
            disabled={uploading || !file}
            className="inline-flex items-center justify-center rounded-full bg-[var(--accent-copper)] px-4 py-1.5 text-sm font-semibold text-black shadow-[0_0_24px_rgba(248,113,22,0.55)] transition hover:opacity-90 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {uploading ? "Uploading…" : "Upload photo"}
          </button>
        </div>
      </div>
    </div>
  );
}

==================== FILE: features/parts/hooks/useAiPartSuggestions.ts ====================

"use client";

import { useCallback, useState } from "react";

/** A single AI-suggested part candidate. */
export type AiPartSuggestion = {
  name: string;
  sku?: string | null;
  qty?: number | null;
  confidence?: number | null; // 0..1
  rationale?: string | null;  // short reason the model suggested it
};

/** Hook to request AI part suggestions for a WO / WO line. */
export function useAiPartSuggestions() {
  const [loading, setLoading] = useState(false);
  const [items, setItems] = useState<AiPartSuggestion[]>([]);
  const [error, setError] = useState<string | null>(null);

  const suggest = useCallback(
    async (input: {
      workOrderId: string;
      workOrderLineId?: string | null;
      vehicle?: { year?: number | string | null; make?: string | null; model?: string | null } | null;
      description?: string | null;  // complaint / job description
      notes?: string | null;        // any extra text you want to include
      topK?: number;
    }) => {
      setLoading(true);
      setError(null);
      try {
        const res = await fetch("/api/ai/parts/suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(input),
        });
        const j = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(j?.error || "Suggestion failed");
        const arr = Array.isArray(j?.items) ? j.items : [];
        setItems(arr as AiPartSuggestion[]);
      } catch (e: unknown) {
        const msg = e instanceof Error ? e.message : "Suggestion failed";
        setError(msg);
        setItems([]);
      } finally {
        setLoading(false);
      }
    },
    [],
  );

  return { loading, items, error, suggest, setItems };
}

==================== FILE: features/parts/lib/locations.ts ====================

"use server";
import { cookies } from "next/headers";
import { createServerComponentClient, createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
type DB = Database;

export async function ensureMainLocation(shopId: string) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("stock_locations")
    .select("id, code, name")
    .eq("shop_id", shopId)
    .eq("code", "MAIN")
    .maybeSingle();
  if (error) throw error;
  if (data) return data;
  const { data: created, error: cerr } = await supabase
    .from("stock_locations")
    .insert({ shop_id: shopId, code: "MAIN", name: "Main Stock" })
    .select("id, code, name")
    .single();
  if (cerr) throw cerr;
  return created;
}

export async function listLocations(shopId: string) {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("stock_locations")
    .select("id, code, name")
    .eq("shop_id", shopId)
    .order("code");
  if (error) throw error;
  return data ?? [];
}

export async function createLocation(input: { shop_id: string; code: string; name: string }) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("stock_locations")
    .insert(input)
    .select("id")
    .single();
  if (error) throw error;
  return data.id as string;
}


==================== FILE: features/parts/lib/parts.queries.ts ====================

"use server";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
type DB = Database;

export async function listParts(shopId: string) {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("parts")
    .select("id, sku, name, category, default_price, low_stock_threshold")
    .eq("shop_id", shopId)
    .order("name");
  if (error) throw error;
  return data ?? [];
}

export async function getPart(id: string) {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("parts")
    .select("*, part_suppliers(*), v_part_stock(*)")
    .eq("id", id)
    .single();
  if (error) throw error;
  return data;
}


==================== FILE: features/parts/lib/parts/searchParts.ts ====================

//features/parts/lib/parts/searchParts.ts

import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
);

/**
 * Search parts by keyword (fuzzy match on name, description, sku, or supplier).
 */
export async function searchPartsByKeyword(keyword: string): Promise<string[]> {
  if (!keyword || keyword.length < 2) return [];

  const { data, error } = await supabase
    .from("parts")
    .select("name")
    .or(
      `name.ilike.%${keyword}%,description.ilike.%${keyword}%,sku.ilike.%${keyword}%,supplier.ilike.%${keyword}%`,
    )
    .limit(10);

  if (error) {
    console.error("Part search error:", error.message);
    return [];
  }

  return data?.map((part) => part.name) ?? [];
}


==================== FILE: features/parts/lib/po.ts ====================

/** Stubs for PO logic; wire to Supabase tables and email/pdf later. */
export type PoDraft = {
  supplier_id: string | null;
  notes?: string | null;
  lines: Array<{ part_id?: string|null; sku?: string|null; description?: string|null; qty: number; unit_cost?: number|null; location_id?: string|null }>;
};

export async function suggestReorder(): Promise<PoDraft[]> {
  // TODO: compute from low_stock + recent usage
  return [];
}

export async function createPoDraft(_draft: PoDraft): Promise<string> {
  // TODO: insert into purchase_orders + purchase_order_lines and return id
  return "TODO-PO-ID";
}


==================== FILE: features/parts/lib/requests/setPartRequestItemStatus.ts ====================

// features/parts/lib/requests/setPartRequestItemStatus.ts
"use server";

import { cookies } from "next/headers";
import { revalidatePath } from "next/cache";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export async function setPartRequestItemStatus(input: {
  partRequestItemId: string;
  status:
    | "requested"
    | "quoted"
    | "approved"
    | "reserved"
    | "ordered"
    | "picking"
    | "picked"
    | "partially_received"
    | "fulfilled"
    | "rejected"
    | "cancelled"
    | "consumed";
  // optional: revalidate targets (work order pages, parts pages)
  revalidate?: { paths?: string[] };
}) {
  const supabase = createServerActionClient<DB>({ cookies });

  const { error } = await supabase
    .from("part_request_items")
    .update({ status: input.status })
    .eq("id", input.partRequestItemId);

  if (error) throw error;

  const paths = input.revalidate?.paths ?? [];
  for (const p of paths) revalidatePath(p);
}

==================== FILE: features/parts/lib/suppliers.ts ====================

"use server";
import { cookies } from "next/headers";
import { createServerComponentClient, createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
type DB = Database;

export async function listSuppliers(shopId: string) {
  const supabase = createServerComponentClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("suppliers")
    .select("id, name, email, phone, is_active")
    .eq("shop_id", shopId)
    .order("name");
  if (error) throw error;
  return data ?? [];
}

export async function createSupplier(input: { shop_id: string; name: string; email?: string; phone?: string }) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { data, error } = await supabase
    .from("suppliers")
    .insert(input)
    .select("id")
    .single();
  if (error) throw error;
  return data.id as string;
}


==================== FILE: features/parts/server/poActions.ts ====================

"use server";

import { cookies } from "next/headers";
import { revalidatePath } from "next/cache";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
type DB = Database;

export async function createPurchaseOrder(input: {
  shop_id: string;
  supplier_id?: string | null;
  notes?: string | null;
}) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error("Unauthenticated");

  const { data, error } = await supabase
    .from("purchase_orders")
    .insert({
      shop_id: input.shop_id,
      supplier_id: input.supplier_id ?? null,
      notes: input.notes ?? null,
      created_by: user.id,
      status: "draft",
    })
    .select("id")
    .single();
  if (error) throw error;
  revalidatePath("/parts/po");
  return data.id as string;
}

export async function addPoLine(input: {
  po_id: string;
  part_id?: string | null;
  sku?: string | null;
  description?: string | null;
  qty: number;
  unit_cost?: number | null;
  location_id?: string | null;
}) {
  const supabase = createServerActionClient<DB>({ cookies });
  if (input.qty <= 0) throw new Error("Quantity must be > 0");

  const { error } = await supabase.from("purchase_order_lines").insert({
    po_id: input.po_id,
    part_id: input.part_id ?? null,
    sku: input.sku ?? null,
    description: input.description ?? null,
    qty: input.qty,
    unit_cost: input.unit_cost ?? null,
    location_id: input.location_id ?? null,
  });
  if (error) throw error;
  revalidatePath("/parts/po");
}

export async function markPoSent(po_id: string) {
  const supabase = createServerActionClient<DB>({ cookies });
  const { error } = await supabase
    .from("purchase_orders")
    .update({ status: "sent" })
    .eq("id", po_id);
  if (error) throw error;
  revalidatePath("/parts/po");
}

/** Receive all remaining qty for lines (simple MVP).
 *  For a granular UI, create a separate receivePoLine().
 */
export async function receivePo(po_id: string) {
  const supabase = createServerActionClient<DB>({ cookies });

  // Load PO + lines
  const { data: lines, error: le } = await supabase
    .from("purchase_order_lines")
    .select("id, part_id, qty, received_qty, location_id, purchase_orders!inner(shop_id)")
    .eq("po_id", po_id);
  if (le) throw le;

  // Apply stock moves (receive delta)
  for (const ln of lines ?? []) {
    const delta = Number(ln.qty) - Number(ln.received_qty || 0);
    if (delta > 0) {
      // location required: if missing, you can default to MAIN in your UI
      const loc = ln.location_id;
      if (!loc) continue;

      const { error: se } = await supabase.rpc("apply_stock_move", {
        p_part: ln.part_id,           // can be null if only SKU/desc; you may want to require part_id
        p_loc: loc,
        p_qty: delta,
        p_reason: "receive",
        p_ref_kind: "purchase_order",
        p_ref_id: po_id,
      });
      if (se) throw se;

      // Update received tally
      const { error: ue } = await supabase
        .from("purchase_order_lines")
        .update({ received_qty: Number(ln.received_qty || 0) + delta })
        .eq("id", ln.id);
      if (ue) throw ue;
    }
  }

  // Mark PO received
  const { error: pe } = await supabase
    .from("purchase_orders")
    .update({ status: "received" })
    .eq("id", po_id);
  if (pe) throw pe;

  revalidatePath("/parts/po");
}

==================== FILE: features/parts/server/scanActions.ts ====================

"use server";

import { cookies } from "next/headers";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
type DB = Database;

/**
 * Resolve a scanned code (barcode or SKU) to a part_id.
 * Strategy (in order):
 *  1) parts_barcodes(code, supplier_id?) -> part_id
 *  2) parts.sku == code (case-insensitive)
 *  3) parts.upc == code  (if you have this column)
 */
export async function resolveScannedCode(input: {
  code: string;
  supplier_id?: string | null;
}): Promise<{ part_id: string | null }> {
  const supabase = createServerActionClient<DB>({ cookies });
  const code = (input.code || "").trim();
  if (!code) return { part_id: null };

  // 1) explicit barcode mappings (recommended table)
  const { data: map } = await supabase
    .from("parts_barcodes")
    .select("part_id")
    .eq("code", code)
    .maybeSingle();

  if (map?.part_id) return { part_id: map.part_id };

  // If supplier-specific mappings exist, try them too
  if (input.supplier_id) {
    const { data: map2 } = await supabase
      .from("parts_barcodes")
      .select("part_id")
      .eq("code", code)
      .eq("supplier_id", input.supplier_id)
      .maybeSingle();
    if (map2?.part_id) return { part_id: map2.part_id };
  }

  // 2) fallback: SKU match
  const { data: bySku } = await supabase
    .from("parts")
    .select("id")
    .ilike("sku", code)
    .maybeSingle();
  if (bySku?.id) return { part_id: bySku.id };

  // 3) optional UPC column fallback (if present in your schema)
  // Comment out if you don't have this column.
  try {
    const { data: byUpc } = await supabase
      .from("parts")
      .select("id")
      .eq("upc", code as any)
      .maybeSingle();
    if (byUpc?.id) return { part_id: byUpc.id };
  } catch {
    /* column may not exist */
  }

  return { part_id: null };
}

==================== FILE: features/parts/server/transcribe.md ====================

If you want voice receiving, add:
- /api/transcribe (POST audio blob) -> Whisper/OpenAI -> text
- Parse "receive 3 brake pads to main" -> {qty:3, part:"brake pads", loc:"MAIN"}


==================== FILE: features/shared/components/RoleNavParts.tsx ====================

// features/shared/components/RoleNavTech.tsx
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import ShiftTracker from "@shared/components/ShiftTracker";
import Link from "next/link";

export default function RoleNavTech() {
  const supabase = createClientComponentClient<Database>();
  const [isTech, setIsTech] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const uid = session?.user?.id ?? null;
      if (!uid) return;
      setUserId(uid);
      const { data: profile } = await supabase
        .from("profiles")
        .select("role")
        .eq("id", uid)
        .single();
      setIsTech(profile?.role === "mechanic");
    })();
  }, [supabase]);

  if (!isTech) return null;

  return (
    <div className="hidden md:flex md:w-64 flex-col gap-4 border-r border-white/5 bg-surface/80 backdrop-blur">
      <div className="px-4 pt-4 space-y-3 border-t border-white/5">
        <p className="text-xs font-medium text-neutral-400">Tech utilities</p>
        <Link href="/tech/queue" className="block text-sm text-neutral-200 hover:text-white">
          My job queue
        </Link>
        <Link href="/tech/calendar" className="block text-sm text-neutral-200 hover:text-white">
          Shop calendar
        </Link>
      </div>

      {userId ? (
        <div className="px-4 pb-4 border-t border-white/5">
          <p className="text-xs font-medium text-neutral-400 mb-2">
            Shift tracker
          </p>
          <ShiftTracker userId={userId} />
        </div>
      ) : null}
    </div>
  );
}

==================== FILE: features/work-orders/components/ActiveJobWidget.tsx ====================

// features/work-orders/components/ActiveJobWidget.tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import Link from "next/link";
import { format } from "date-fns";
import { toast } from "sonner";

import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type ActiveJobState = {
  line: WorkOrderLine | null;
  workOrder: WorkOrder | null;
  vehicle: Vehicle | null;
};

export function ActiveJobWidget(): JSX.Element {
  const [loading, setLoading] = useState(true);
  const [state, setState] = useState<ActiveJobState>({
    line: null,
    workOrder: null,
    vehicle: null,
  });
  const [error, setError] = useState<string | null>(null);

  const loadActiveJob = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr) throw userErr;

      if (!user) {
        setState({ line: null, workOrder: null, vehicle: null });
        setLoading(false);
        return;
      }

      // 🔍 Find the current user's active punched-in line
      const { data: line, error: lineErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("assigned_to", user.id)
        .not("punched_in_at", "is", null)
        .is("punched_out_at", null)
        .order("punched_in_at", { ascending: false })
        .maybeSingle<WorkOrderLine>();

      if (lineErr) throw lineErr;

      if (!line) {
        setState({ line: null, workOrder: null, vehicle: null });
        setLoading(false);
        return;
      }

      let workOrder: WorkOrder | null = null;
      let vehicle: Vehicle | null = null;

      if (line.work_order_id) {
        const { data: wo, error: woErr } = await supabase
          .from("work_orders")
          .select("*")
          .eq("id", line.work_order_id)
          .maybeSingle<WorkOrder>();
        if (woErr) throw woErr;
        workOrder = wo ?? null;

        if (workOrder?.vehicle_id) {
          const { data: veh, error: vehErr } = await supabase
            .from("vehicles")
            .select("*")
            .eq("id", workOrder.vehicle_id)
            .maybeSingle<Vehicle>();
          if (vehErr) throw vehErr;
          vehicle = veh ?? null;
        }
      }

      setState({ line, workOrder, vehicle });
    } catch (e) {
      console.error("[ActiveJobWidget] load error", e);
      const msg =
        (e as { message?: string })?.message ?? "Failed to load active job.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  }, []);

  // initial load
  useEffect(() => {
    void loadActiveJob();
  }, [loadActiveJob]);

  // refresh whenever job punch fires its global event
  useEffect(() => {
    const handler = () => void loadActiveJob();
    window.addEventListener("wol:refresh", handler);
    return () => window.removeEventListener("wol:refresh", handler);
  }, [loadActiveJob]);

  const { line, workOrder, vehicle } = state;

  const startedAt =
    line?.punched_in_at != null
      ? format(new Date(line.punched_in_at), "PPpp")
      : null;

  const href =
    workOrder && line
      ? `/work-orders/${workOrder.custom_id || workOrder.id}?focus=${line.id}`
      : "#";

  // --- UI states ---

  if (loading) {
    return (
      <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 px-4 py-3 text-xs text-neutral-400">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-500">
          Active job
        </div>
        <div className="mt-2 h-4 w-40 animate-pulse rounded-full bg-neutral-800" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="rounded-xl border border-red-700/60 bg-red-950/60 px-4 py-3 text-xs text-red-100">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-red-300">
          Active job
        </div>
        <div className="mt-1">{error}</div>
      </div>
    );
  }

  if (!line || !workOrder) {
    return (
      <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 px-4 py-3 text-xs text-neutral-400">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-500">
          Active job
        </div>
        <div className="mt-1 text-neutral-300">
          No active job. Punch into a job to start tracking time.
        </div>
      </div>
    );
  }

  return (
    <Link
      href={href}
      onClick={() => {
        if (!workOrder || !line) {
          toast.error("Active job link is not available.");
        }
      }}
      className="group block rounded-xl border border-emerald-500/60 bg-neutral-950/90 px-4 py-3 text-xs text-neutral-200 shadow-[0_0_20px_rgba(16,185,129,0.45)] transition hover:border-emerald-400 hover:shadow-[0_0_26px_rgba(16,185,129,0.75)]"
    >
      <div className="mb-1 flex items-center justify-between gap-2">
        <div className="text-[11px] font-semibold uppercase tracking-[0.2em] text-emerald-300">
          ● Active job
        </div>
        <div className="text-[10px] text-neutral-500">
          Tap to open work order
        </div>
      </div>

      <div className="text-sm font-medium text-neutral-50">
        WO {workOrder.custom_id || workOrder.id.slice(0, 8)}
      </div>
      <div className="mt-0.5 truncate text-[13px] text-neutral-200">
        {line.line_no ? `#${line.line_no} ` : ""}
        {line.description || line.complaint || "Job"}
      </div>

      {vehicle && (
        <div className="mt-0.5 truncate text-[11px] text-neutral-400">
          {vehicle.year ?? ""} {vehicle.make ?? ""} {vehicle.model ?? ""}{" "}
          {vehicle.license_plate ? `• ${vehicle.license_plate}` : ""}
        </div>
      )}

      {startedAt && (
        <div className="mt-1 text-[11px] text-emerald-200">
          Started <span className="font-mono">{startedAt}</span>
        </div>
      )}
    </Link>
  );
}

==================== FILE: features/work-orders/components/AiSuggestModal.tsx ====================

"use client";

import { useEffect, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";

type JobType = "diagnosis" | "repair" | "maintenance" | "inspection" | "tech-suggested";

type RawSuggestion = {
  name: string;
  laborHours: number;
  jobType: JobType;
  notes: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

type UiSuggestion = RawSuggestion & { id: string; selected: boolean };

type AiSuggestModalProps = {
  open: boolean;
  onClose: () => void;
  workOrderId: string;
  vehicleId?: string | null;
  vehicleLabel?: string | null;
  initialComplaint?: string | null;
  onAdded?: (count: number) => void;
};

function normalizeJobType(t: JobType): "diagnosis" | "repair" | "maintenance" | "inspection" {
  if (t === "tech-suggested") return "diagnosis";
  if (t === "diagnosis" || t === "repair" || t === "maintenance" || t === "inspection") return t;
  return "diagnosis";
}

export function AiSuggestModal(props: AiSuggestModalProps) {
  const {
    open,
    onClose,
    workOrderId,
    vehicleId,
    vehicleLabel,
    initialComplaint,
    onAdded,
  } = props;

  const [complaint, setComplaint] = useState(initialComplaint ?? "");
  const [step, setStep] = useState<"input" | "results">("input");
  const [loading, setLoading] = useState(false);
  const [suggestions, setSuggestions] = useState<UiSuggestion[]>([]);

  useEffect(() => {
    if (!open) return;
    setComplaint(initialComplaint ?? "");
    setStep("input");
    setSuggestions([]);
    setLoading(false);
  }, [open, initialComplaint]);

  if (!open) return null;

  const handleGetSuggestions = async () => {
    if (!workOrderId) {
      toast.error("Create and save the work order first.");
      return;
    }

    setLoading(true);
    try {
      const body: Record<string, unknown> = {
        workOrderId,
        complaint: complaint.trim() || null,
      };

      if (vehicleId) {
        body.vehicleId = {
          id: vehicleId,
          year: null,
          make: null,
          model: null,
        };
      }

      const res = await fetch("/api/work-orders/suggest-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const json = (await res.json()) as
        | { suggestions?: RawSuggestion[]; error?: string }
        | undefined;

      if (!res.ok || !json?.suggestions) {
        throw new Error(json?.error || "AI suggestions failed");
      }

      const ui: UiSuggestion[] = json.suggestions.map((s, idx) => ({
        ...s,
        id: `${idx}`,
        selected: true,
        jobType: normalizeJobType(s.jobType) as any,
      }));

      if (ui.length === 0) {
        toast.info("No specific suggestions. Try adding a complaint first.");
      }

      setSuggestions(ui);
      setStep("results");
    } catch (err) {
      const msg =
        err instanceof Error ? err.message : "Could not get AI suggestions.";
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const handleAddSelected = async () => {
    const selected = suggestions.filter((s) => s.selected);
    if (selected.length === 0) {
      toast.info("Select at least one job to add.");
      return;
    }

    setLoading(true);
    try {
      const items = selected.map((s) => ({
        description: s.name,
        serviceCode: undefined,
        jobType: normalizeJobType(s.jobType),
        laborHours: s.laborHours,
        notes: s.notes,
        aiComplaint: s.aiComplaint ?? (complaint.trim() || undefined),
        aiCause: s.aiCause,
        aiCorrection: s.aiCorrection,
      }));

      const res = await fetch("/api/work-orders/add-suggested-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          items,
        }),
      });

      const json = (await res.json()) as
        | { ok?: boolean; inserted?: number; error?: string }
        | undefined;

      if (!res.ok || !json?.ok) {
        throw new Error(json?.error || "Failed to add suggested lines.");
      }

      const count = json.inserted ?? selected.length;
      toast.success(`Added ${count} AI suggested job${count === 1 ? "" : "s"}.`);

      onAdded?.(count);

      window.dispatchEvent(new CustomEvent("wo:line-added"));
      onClose();
    } catch (err) {
      const msg =
        err instanceof Error
          ? err.message
          : "Could not add suggested lines to work order.";
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const handleToggle = (id: string) => {
    setSuggestions((prev) =>
      prev.map((s) => (s.id === id ? { ...s, selected: !s.selected } : s)),
    );
  };

  const btnLabel =
    step === "input"
      ? loading
        ? "Thinking…"
        : "Suggest Jobs"
      : loading
        ? "Adding…"
        : "Add Selected";

  const handlePrimary = async () => {
    if (step === "input") await handleGetSuggestions();
    else await handleAddSelected();
  };

  return (
    <ModalShell
      isOpen={open}
      onClose={onClose}
      title="AI: Suggest Services"
      size="md"
      onSubmit={handlePrimary}
      submitText={btnLabel}
      footerLeft={
        step === "results" ? (
          <button
            type="button"
            onClick={() => {
              setStep("input");
              setSuggestions([]);
            }}
            className="text-xs text-neutral-400 hover:text-neutral-200"
          >
            Start over
          </button>
        ) : null
      }
    >
      <div className="space-y-3">
        <div>
          <p className="text-xs text-neutral-400">
            Describe the concern. We’ll suggest jobs and add them as{" "}
            <span className="font-semibold text-neutral-200">
              quote lines (awaiting approval)
            </span>
            .
          </p>
          {vehicleLabel && (
            <p className="mt-1 text-xs text-neutral-500">
              Using context for:{" "}
              <span className="font-mono text-neutral-100">{vehicleLabel}</span>
            </p>
          )}
        </div>

        <div>
          <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
            Customer concern
          </label>
          <textarea
            rows={3}
            value={complaint}
            onChange={(e) => setComplaint(e.target.value)}
            placeholder="Example: Customer reports vibration at highway speeds, no dash lights on. Recently replaced front tires."
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
          />
        </div>

        {step === "results" && (
          <div className="max-h-56 space-y-2 overflow-y-auto rounded border border-neutral-800 bg-neutral-950 p-2">
            {suggestions.length === 0 ? (
              <p className="text-xs text-neutral-500">
                No suggestions yet. Try adjusting the complaint text.
              </p>
            ) : (
              suggestions.map((s) => (
                <button
                  key={s.id}
                  type="button"
                  onClick={() => handleToggle(s.id)}
                  className={`flex w-full items-start gap-2 rounded px-2 py-1.5 text-left text-xs ${
                    s.selected
                      ? "border border-orange-500/80 bg-orange-500/10"
                      : "border border-neutral-800 bg-neutral-950"
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={s.selected}
                    onChange={() => handleToggle(s.id)}
                    className="mt-0.5 h-3.5 w-3.5 rounded border-neutral-600 bg-neutral-900"
                  />
                  <div className="flex-1">
                    <div className="flex flex-wrap items-center gap-1">
                      <span className="font-medium text-neutral-100">
                        {s.name}
                      </span>
                      <span className="rounded-full border border-neutral-600 px-1.5 py-0.5 text-[10px] uppercase tracking-wide text-neutral-300">
                        {normalizeJobType(s.jobType).replace("-", " ")}
                      </span>
                      <span className="text-[10px] text-neutral-400">
                        ~{s.laborHours}h
                      </span>
                    </div>
                    {s.notes && (
                      <p className="mt-0.5 text-[11px] text-neutral-400">
                        {s.notes}
                      </p>
                    )}
                  </div>
                </button>
              ))
            )}
          </div>
        )}
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/InvoicePreviewPageClient.tsx ====================

"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import type { RepairLine } from "@ai/lib/parseRepairOutput";

import CustomerPaymentButton from "@/features/stripe/components/CustomerPaymentButton";
import { WorkOrderInvoiceDownloadButton } from "@work-orders/components/WorkOrderInvoiceDownloadButton";

type DB = Database;

type VehicleInfo = {
  year?: string;
  make?: string;
  model?: string;
  vin?: string;
  license_plate?: string;
  unit_number?: string;
  mileage?: string;
  color?: string;
  engine_hours?: string;
};

type CustomerInfo = {
  name?: string;
  phone?: string;
  email?: string;
  business_name?: string;
  street?: string;
  city?: string;
  province?: string;
  postal_code?: string;
};

type ShopInfo = {
  name?: string;
  phone_number?: string;
  email?: string;
  street?: string;
  city?: string;
  province?: string;
  postal_code?: string;

  // ✅ needed to convert hours -> $
  labor_rate?: number;
};

type Props = {
  workOrderId: string;
  vehicleInfo?: VehicleInfo;
  customerInfo?: CustomerInfo;
  lines?: RepairLine[];
  summary?: string;
  signatureImage?: string;
  onSent?: () => void | Promise<void>;
};

function normalizeCurrencyFromCountry(country: unknown): "usd" | "cad" {
  const c = String(country ?? "").trim().toUpperCase();
  return c === "CA" ? "cad" : "usd";
}

type ReviewIssue = { kind: string; lineId?: string; message: string };
type ReviewResponse = { ok: boolean; issues: ReviewIssue[] };

type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];
type ShopRow = DB["public"]["Tables"]["shops"]["Row"];
type WorkOrderPartRow = DB["public"]["Tables"]["work_order_parts"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type InspectionRow = DB["public"]["Tables"]["inspections"]["Row"];

type InvoiceLinePayload = {
  complaint?: string | null;
  cause?: string | null;
  correction?: string | null;
  labor_time?: string | number | null;
  lineId?: string;
};

type SendInvoiceResponse = { ok?: boolean; error?: string };

function isRecord(x: unknown): x is Record<string, unknown> {
  return typeof x === "object" && x !== null;
}

function parseLaborTimeToNumber(v: unknown): number | undefined {
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (typeof v === "string") {
    const n = Number(v);
    return Number.isFinite(n) && n > 0 ? n : undefined;
  }
  return undefined;
}

function getLineIdFromRepairLine(line: RepairLine): string | undefined {
  const r = line as unknown;
  if (!isRecord(r)) return undefined;

  const candidates = ["id", "lineId", "line_id", "work_order_line_id"];
  for (const k of candidates) {
    const v = r[k];
    if (typeof v === "string" && v.length > 0) return v;
  }
  return undefined;
}

function joinName(first?: string | null, last?: string | null): string | undefined {
  const f = (first ?? "").trim();
  const l = (last ?? "").trim();
  const s = [f, l].filter(Boolean).join(" ").trim();
  return s.length ? s : undefined;
}

function pickCustomerPhone(
  c?: Pick<CustomerRow, "phone" | "phone_number"> | null,
): string | undefined {
  const p1 = (c?.phone_number ?? "").trim();
  const p2 = (c?.phone ?? "").trim();
  const out = p1 || p2;
  return out.length ? out : undefined;
}

function pickCustomerName(
  c?: Pick<CustomerRow, "name" | "first_name" | "last_name"> | null,
  fallback?: string | null,
): string | undefined {
  const a = (c?.name ?? "").trim();
  const b = joinName(c?.first_name ?? null, c?.last_name ?? null);
  const f = (fallback ?? "").trim();
  const out = a || b || f;
  return out.length ? out : undefined;
}

function pickShopName(
  s?: Pick<ShopRow, "business_name" | "shop_name" | "name"> | null,
): string | undefined {
  const a = (s?.business_name ?? "").trim();
  const b = (s?.shop_name ?? "").trim();
  const c = (s?.name ?? "").trim();
  const out = a || b || c;
  return out.length ? out : undefined;
}

function trimOrUndef(v: unknown): string | undefined {
  const s = typeof v === "string" ? v.trim() : "";
  return s.length ? s : undefined;
}

function numToStringOrUndef(v: unknown): string | undefined {
  if (typeof v === "number" && Number.isFinite(v)) return String(v);
  if (typeof v === "string" && v.trim().length) return v.trim();
  return undefined;
}

function numOrUndef(v: unknown): number | undefined {
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (typeof v === "string") {
    const n = Number(v);
    return Number.isFinite(n) ? n : undefined;
  }
  return undefined;
}

function safeMoney(v: unknown): number {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : 0;
}

/**
 * PDF line-parts shape expected by WorkOrderInvoicePDF extractor:
 * { qty, name, unit_price, total }
 */
type PdfLinePart = {
  qty: number;
  name: string;
  unit_price: number;
  total: number;
};

// ✅ Your DB types for work_order_parts do NOT have qty/line_total/description.
// Use quantity/total_price and pull names from parts table.
// work_order_line_id is treated as optional (in case your DB has it but types are stale).
type WorkOrderPartWithLine = Pick<
  WorkOrderPartRow,
  "id" | "part_id" | "quantity" | "unit_price" | "total_price"
> & {
  work_order_line_id?: string | null;
};

type InspectionPdfInfo = {
  inspectionId: string;
  pdfUrl?: string | null;
  storagePath?: string | null;
  finalizedAt?: string | null;
  createdAt?: string | null;
};

export default function InvoicePreviewPageClient({
  workOrderId,
  vehicleInfo,
  customerInfo,
  lines,
  summary,
  signatureImage,
  onSent,
}: Props) {
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(false);
  const [shopId, setShopId] = useState<string | null>(null);
  const [stripeAccountId, setStripeAccountId] = useState<string | null>(null);
  const [currency, setCurrency] = useState<"usd" | "cad">("usd");

  const [shopInfo, setShopInfo] = useState<ShopInfo | undefined>(undefined);

  const [reviewLoading, setReviewLoading] = useState(false);
  const [reviewOk, setReviewOk] = useState<boolean>(false);
  const [reviewIssues, setReviewIssues] = useState<ReviewIssue[]>([]);
  const [reviewError, setReviewError] = useState<string | null>(null);

  const [wo, setWo] = useState<
    Pick<
      WorkOrderRow,
      | "id"
      | "shop_id"
      | "customer_id"
      | "vehicle_id"
      | "labor_total"
      | "parts_total"
      | "invoice_total"
      | "customer_name"
    > | null
  >(null);

  const [fVehicleInfo, setFVehicleInfo] = useState<VehicleInfo | undefined>(
    undefined,
  );
  const [fCustomerInfo, setFCustomerInfo] = useState<CustomerInfo | undefined>(
    undefined,
  );

  // ✅ our fetched lines can include parts
  const [fLines, setFLines] = useState<
    Array<RepairLine & { lineId?: string; parts?: PdfLinePart[] }>
  >([]);

  const [fSummary, setFSummary] = useState<string | undefined>(undefined);
  const [sending, setSending] = useState(false);

  // ✅ inspection PDF (works even when no invoice exists yet)
  const [inspectionPdfLoading, setInspectionPdfLoading] = useState(false);
  const [inspectionPdf, setInspectionPdf] = useState<InspectionPdfInfo | null>(null);

  const effectiveVehicleInfo = vehicleInfo ?? fVehicleInfo;
  const effectiveCustomerInfo = customerInfo ?? fCustomerInfo;

  const effectiveLines = useMemo(() => {
    const provided = Array.isArray(lines) ? lines : undefined;
    return (
      (provided as
        | Array<RepairLine & { lineId?: string; parts?: PdfLinePart[] }>
        | undefined) ?? fLines
    );
  }, [lines, fLines]);

  const effectiveSummary = summary ?? fSummary;

  const effectiveShopName = useMemo(() => {
    const n = (shopInfo?.name ?? "").trim();
    return n.length ? n : undefined;
  }, [shopInfo?.name]);

  const refreshInspectionPdf = useCallback(async (): Promise<void> => {
    if (!workOrderId) return;

    setInspectionPdfLoading(true);
    try {
      const { data, error } = await supabase
        .from("inspections")
        .select("id, pdf_url, pdf_storage_path, finalized_at, created_at")
        .eq("work_order_id", workOrderId)
        .not("pdf_storage_path", "is", null)
        .order("finalized_at", { ascending: false })
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle<
          Pick<
            InspectionRow,
            "id" | "pdf_url" | "pdf_storage_path" | "finalized_at" | "created_at"
          >
        >();

      if (error || !data?.id) {
        setInspectionPdf(null);
        return;
      }

      setInspectionPdf({
        inspectionId: data.id,
        pdfUrl: data.pdf_url ?? null,
        storagePath: data.pdf_storage_path ?? null,
        finalizedAt: data.finalized_at ?? null,
        createdAt: data.created_at ?? null,
      });
    } finally {
      setInspectionPdfLoading(false);
    }
  }, [supabase, workOrderId]);

  // -------------------------------------------------------------------
  // Load shop/stripe + WO + optional customer/vehicle/lines (when not provided)
  // -------------------------------------------------------------------
  useEffect(() => {
    if (!workOrderId) return;

    let cancelled = false;

    (async () => {
      setLoading(true);

      const { data: woRow, error: woErr } = await supabase
        .from("work_orders")
        .select(
          "id, shop_id, customer_id, vehicle_id, labor_total, parts_total, invoice_total, customer_name",
        )
        .eq("id", workOrderId)
        .maybeSingle<
          Pick<
            WorkOrderRow,
            | "id"
            | "shop_id"
            | "customer_id"
            | "vehicle_id"
            | "labor_total"
            | "parts_total"
            | "invoice_total"
            | "customer_name"
          >
        >();

      if (cancelled) return;

      if (woErr || !woRow?.shop_id) {
        setWo(null);
        setShopId(null);
        setStripeAccountId(null);
        setCurrency("usd");
        setShopInfo(undefined);
        setLoading(false);
        return;
      }

      setWo(woRow);
      setShopId(woRow.shop_id);

      // ✅ include labor_rate
      const { data: shop, error: sErr } = await supabase
        .from("shops")
        .select(
          "stripe_account_id, country, business_name, shop_name, name, phone_number, email, street, city, province, postal_code, labor_rate",
        )
        .eq("id", woRow.shop_id)
        .maybeSingle<
          Pick<
            ShopRow,
            | "stripe_account_id"
            | "country"
            | "business_name"
            | "shop_name"
            | "name"
            | "phone_number"
            | "email"
            | "street"
            | "city"
            | "province"
            | "postal_code"
            | "labor_rate"
          >
        >();

      if (cancelled) return;

      if (sErr) {
        setStripeAccountId(null);
        setCurrency("usd");
        setShopInfo(undefined);
      } else {
        setStripeAccountId(shop?.stripe_account_id ?? null);
        setCurrency(normalizeCurrencyFromCountry(shop?.country));

        setShopInfo({
          name: pickShopName(shop ?? null),
          phone_number: trimOrUndef(shop?.phone_number),
          email: trimOrUndef(shop?.email),
          street: trimOrUndef(shop?.street),
          city: trimOrUndef(shop?.city),
          province: trimOrUndef(shop?.province),
          postal_code: trimOrUndef(shop?.postal_code),
          labor_rate: numOrUndef(shop?.labor_rate),
        });
      }

      const needCustomer = !customerInfo;
      const needVehicle = !vehicleInfo;
      const needLines = !Array.isArray(lines);
      const needSummary = typeof summary !== "string";

      if (needCustomer && woRow.customer_id) {
        const { data: c } = await supabase
          .from("customers")
          .select(
            "name, first_name, last_name, phone, phone_number, email, business_name, street, city, province, postal_code",
          )
          .eq("id", woRow.customer_id)
          .maybeSingle<
            Pick<
              CustomerRow,
              | "name"
              | "first_name"
              | "last_name"
              | "phone"
              | "phone_number"
              | "email"
              | "business_name"
              | "street"
              | "city"
              | "province"
              | "postal_code"
            >
          >();

        if (cancelled) return;

        setFCustomerInfo({
          name: pickCustomerName(c ?? null, woRow.customer_name ?? null),
          phone: pickCustomerPhone(c ?? null),
          email: trimOrUndef(c?.email),
          business_name: trimOrUndef(c?.business_name),
          street: trimOrUndef(c?.street),
          city: trimOrUndef(c?.city),
          province: trimOrUndef(c?.province),
          postal_code: trimOrUndef(c?.postal_code),
        });
      } else if (needCustomer) {
        setFCustomerInfo({ name: trimOrUndef(woRow.customer_name) });
      }

      if (needVehicle && woRow.vehicle_id) {
        const { data: v } = await supabase
          .from("vehicles")
          .select(
            "year, make, model, vin, license_plate, unit_number, mileage, color, engine_hours",
          )
          .eq("id", woRow.vehicle_id)
          .maybeSingle<
            Pick<
              VehicleRow,
              | "year"
              | "make"
              | "model"
              | "vin"
              | "license_plate"
              | "unit_number"
              | "mileage"
              | "color"
              | "engine_hours"
            >
          >();

        if (cancelled) return;

        setFVehicleInfo({
          year:
            v?.year !== null && v?.year !== undefined ? String(v.year) : undefined,
          make: trimOrUndef(v?.make),
          model: trimOrUndef(v?.model),
          vin: trimOrUndef(v?.vin),
          license_plate: trimOrUndef(v?.license_plate),
          unit_number: trimOrUndef(v?.unit_number),
          mileage: numToStringOrUndef(v?.mileage),
          color: trimOrUndef(v?.color),
          engine_hours: numToStringOrUndef(v?.engine_hours),
        });
      } else if (needVehicle) {
        setFVehicleInfo(undefined);
      }

      if (needLines) {
        // 1) load lines
        const { data: wol, error: wolErr } = await supabase
          .from("work_order_lines")
          .select("id, line_no, description, complaint, cause, correction, labor_time")
          .eq("work_order_id", workOrderId)
          .order("line_no", { ascending: true });

        if (cancelled) return;

        if (wolErr || !Array.isArray(wol) || wol.length === 0) {
          setFLines([]);
        } else {
          // 2) load parts for this work order
          const { data: wopRaw } = await supabase
            .from("work_order_parts")
            .select("id, work_order_line_id, part_id, quantity, unit_price, total_price")
            .eq("work_order_id", workOrderId);

          const wop = (Array.isArray(wopRaw) ? wopRaw : []) as WorkOrderPartWithLine[];

          // 3) join to parts table for names + part_number
          const partIds = Array.from(
            new Set(
              wop
                .map((p) => p.part_id)
                .filter((id): id is string => typeof id === "string" && id.trim().length > 0),
            ),
          );

          let partsById = new Map<string, Pick<PartRow, "id" | "name" | "part_number">>();

          if (partIds.length > 0) {
            const { data: parts } = await supabase
              .from("parts")
              .select("id, name, part_number")
              .in("id", partIds);

            const arr = (Array.isArray(parts) ? parts : []) as Array<
              Pick<PartRow, "id" | "name" | "part_number">
            >;

            partsById = new Map(
              arr
                .filter(
                  (p) =>
                    typeof p.id === "string" &&
                    p.id.length > 0 &&
                    typeof p.name === "string",
                )
                .map((p) => [p.id, p]),
            );
          }

          const perLine = new Map<string, PdfLinePart[]>();

          for (const p of wop) {
            const lidRaw = p.work_order_line_id;
            const lid = typeof lidRaw === "string" && lidRaw.trim().length > 0 ? lidRaw.trim() : "";
            if (!lid) continue;

            const qty = Number(p.quantity ?? 1);
            const unit = safeMoney(p.unit_price);
            const totalFromRow = safeMoney(p.total_price);
            const total =
              totalFromRow > 0 ? totalFromRow : Math.max(0, (Number.isFinite(qty) ? qty : 0) * unit);

            const partMeta = typeof p.part_id === "string" ? partsById.get(p.part_id) : undefined;

            const baseName = (partMeta?.name ?? "").trim() || "Part";
            const pretty =
              partMeta?.part_number && partMeta.part_number.trim().length > 0
                ? `${baseName} (${partMeta.part_number.trim()})`
                : baseName;

            const arr = perLine.get(lid) ?? [];
            arr.push({
              qty: Number.isFinite(qty) && qty > 0 ? qty : 1,
              name: pretty,
              unit_price: Number.isFinite(unit) ? unit : 0,
              total: Number.isFinite(total) ? total : 0,
            });
            perLine.set(lid, arr);
          }

          const mapped: Array<RepairLine & { lineId?: string; parts?: PdfLinePart[] }> = wol.map(
            (
              l: Pick<
                WorkOrderLineRow,
                "id" | "line_no" | "description" | "complaint" | "cause" | "correction" | "labor_time"
              >,
            ) => {
              const complaint = (l.description ?? l.complaint ?? "") || "";
              const id = typeof l.id === "string" && l.id.length > 0 ? l.id : undefined;

              return {
                complaint,
                cause: l.cause ?? "",
                correction: l.correction ?? "",
                labor_time: parseLaborTimeToNumber(l.labor_time),
                lineId: id,
                parts: id ? perLine.get(id) ?? [] : [],
              };
            },
          );

          setFLines(mapped);
        }
      }

      if (needSummary) setFSummary(undefined);

      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [workOrderId, supabase, customerInfo, vehicleInfo, lines, summary]);

  // -------------------------------------------------------------------
  // Load inspection PDF for this work order (works even if no invoice exists yet)
  // -------------------------------------------------------------------
  useEffect(() => {
    void refreshInspectionPdf();
  }, [refreshInspectionPdf]);

  // -------------------------------------------------------------------
  // Invoice review gate (runs on mount / id change)
  // -------------------------------------------------------------------
  useEffect(() => {
    if (!workOrderId) return;

    let cancelled = false;

    setReviewLoading(true);
    setReviewError(null);
    setReviewIssues([]);
    setReviewOk(false);

    (async () => {
      try {
        const res = await fetch(`/api/work-orders/${workOrderId}/invoice`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        });

        const json = (await res.json().catch(() => null)) as ReviewResponse | null;

        if (cancelled) return;

        if (!res.ok || !json) {
          setReviewOk(false);
          setReviewIssues([{ kind: "error", message: "Invoice review failed (bad response)" }]);
          return;
        }

        setReviewOk(Boolean(json.ok));
        setReviewIssues(Array.isArray(json.issues) ? json.issues : []);
      } catch (e) {
        if (cancelled) return;
        const msg = e instanceof Error ? e.message : "Invoice review failed";
        setReviewOk(false);
        setReviewError(msg);
        setReviewIssues([{ kind: "error", message: msg }]);
      } finally {
        if (!cancelled) setReviewLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [workOrderId]);

  const issuesByLineId = useMemo(() => {
    const map = new Map<string, ReviewIssue[]>();
    for (const i of reviewIssues) {
      if (!i.lineId) continue;
      const arr = map.get(i.lineId) ?? [];
      arr.push(i);
      map.set(i.lineId, arr);
    }
    return map;
  }, [reviewIssues]);

  const canTakePayment = Boolean(shopId && stripeAccountId);
  const canProceed = canTakePayment && reviewOk && !reviewLoading;

  const handleBack = useCallback(() => {
    router.back();
  }, [router]);

  const openInspectionPdf = useCallback((): void => {
    const url = (inspectionPdf?.pdfUrl ?? "").trim();
    if (!url) return;
    if (typeof window !== "undefined") window.open(url, "_blank", "noopener,noreferrer");
  }, [inspectionPdf?.pdfUrl]);

  const sendInvoiceEmail = useCallback(async () => {
    if (sending) return;
    if (!reviewOk) return;

    const email = effectiveCustomerInfo?.email;
    if (!email) {
      setReviewOk(false);
      setReviewIssues([
        { kind: "missing_email", message: "No customer email on file for this work order." },
      ]);
      return;
    }

    const laborTotal = Number(wo?.labor_total ?? 0);
    const partsTotal = Number(wo?.parts_total ?? 0);
    const invoiceTotal =
      Number(wo?.invoice_total ?? 0) > 0 ? Number(wo?.invoice_total ?? 0) : laborTotal + partsTotal;

    const payloadLines: InvoiceLinePayload[] = (effectiveLines ?? []).map((l) => {
      const lineId = getLineIdFromRepairLine(l);
      const r = l as unknown as Record<string, unknown>;
      return {
        complaint: typeof r["complaint"] === "string" ? (r["complaint"] as string) : null,
        cause: typeof r["cause"] === "string" ? (r["cause"] as string) : null,
        correction: typeof r["correction"] === "string" ? (r["correction"] as string) : null,
        labor_time:
          typeof r["labor_time"] === "number"
            ? (r["labor_time"] as number)
            : typeof r["labor_time"] === "string"
              ? (r["labor_time"] as string)
              : null,
        lineId,
      };
    });

    try {
      setSending(true);

      const res = await fetch("/api/invoices/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          customerEmail: email,
          customerName: effectiveCustomerInfo?.name,
          shopName: effectiveShopName,
          invoiceTotal,
          vehicleInfo: effectiveVehicleInfo,
          lines: payloadLines,
          signatureImage: signatureImage ?? undefined,
        }),
      });

      const json = (await res.json().catch(() => null)) as SendInvoiceResponse | null;

      if (!res.ok || !json?.ok) {
        const msg = json?.error ?? "Failed to send invoice email";
        throw new Error(msg);
      }

      await onSent?.();
      handleBack();
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Failed to send invoice email";
      setReviewOk(false);
      setReviewError(msg);
      setReviewIssues([{ kind: "error", message: msg }]);
    } finally {
      setSending(false);
    }
  }, [
    sending,
    reviewOk,
    effectiveCustomerInfo?.email,
    effectiveCustomerInfo?.name,
    effectiveVehicleInfo,
    effectiveLines,
    workOrderId,
    wo?.labor_total,
    wo?.parts_total,
    wo?.invoice_total,
    onSent,
    handleBack,
    signatureImage,
    effectiveShopName,
  ]);

  return (
    <div className="min-h-[calc(100vh-0px)] bg-black px-3 py-3 sm:px-4 sm:py-4">
      <div className="mx-auto flex max-w-[1400px] flex-col gap-3">
        {/* Top action row */}
        <div className="flex flex-wrap items-center justify-between gap-2 rounded-xl border border-[var(--metal-border-soft)] bg-black/35 px-3 py-2">
          <div className="flex items-center gap-3">
            <button
              type="button"
              onClick={handleBack}
              className="rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-3 py-1.5 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5 active:scale-95"
            >
              Back
            </button>

            <div className="text-[0.7rem] uppercase tracking-[0.22em] text-neutral-300">
              Invoice
              <span className="ml-2 rounded-full border border-[var(--metal-border-soft)] bg-black/40 px-2 py-0.5 text-[0.65rem] text-neutral-200">
                #{workOrderId}
              </span>
            </div>

            {loading ? (
              <span className="text-[0.7rem] text-neutral-400">Loading shop…</span>
            ) : canTakePayment ? (
              <span className="text-[0.7rem] text-neutral-400">
                Payments enabled ({currency.toUpperCase()})
              </span>
            ) : (
              <span className="text-[0.7rem] text-neutral-500">
                Payments unavailable (shop not connected)
              </span>
            )}

            {reviewLoading ? (
              <span className="text-[0.7rem] text-neutral-400">Reviewing…</span>
            ) : reviewOk ? (
              <span className="text-[0.7rem] text-emerald-300">Invoice ready</span>
            ) : (
              <span className="text-[0.7rem] text-amber-300">Missing required info</span>
            )}
          </div>

          <div className="flex items-center gap-2">
            <button
              type="button"
              onClick={() => void sendInvoiceEmail()}
              disabled={!reviewOk || reviewLoading || sending}
              className={
                "rounded-full px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] shadow-[0_0_12px_rgba(212,118,49,0.35)] " +
                (reviewOk && !reviewLoading
                  ? "bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] text-black hover:brightness-110"
                  : "border border-amber-500/40 bg-amber-500/10 text-amber-200 opacity-60")
              }
              title={reviewOk ? "Email invoice (SendGrid)" : "Blocked until required info is complete"}
            >
              {sending ? "Sending…" : "Send invoice"}
            </button>

            {canTakePayment ? (
              <div className={canProceed ? "" : "opacity-50 pointer-events-none"}>
                <CustomerPaymentButton
                  shopId={shopId as string}
                  stripeAccountId={stripeAccountId as string}
                  currency={currency}
                  workOrderId={workOrderId}
                />
              </div>
            ) : null}
          </div>
        </div>

        {/* Review issues panel */}
        {!reviewOk ? (
          <div className="rounded-xl border border-amber-500/30 bg-black/35 px-3 py-2">
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-amber-200">
              Invoice blocked
            </div>
            <div className="mt-1 text-[0.75rem] text-neutral-300">
              Fix the items below, then refresh this page.
            </div>

            {reviewError ? (
              <div className="mt-2 text-[0.75rem] text-red-200">{reviewError}</div>
            ) : null}

            <ul className="mt-2 space-y-1 text-[0.8rem] text-neutral-200">
              {(reviewIssues ?? []).slice(0, 12).map((i, idx) => (
                <li key={`${i.kind}-${idx}`} className="flex gap-2">
                  <span className="text-amber-300">•</span>
                  <span>{i.message}</span>
                </li>
              ))}
            </ul>

            {issuesByLineId.size > 0 ? (
              <div className="mt-3 rounded-lg border border-white/10 bg-black/25 px-3 py-2">
                <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-300">
                  Line issues
                </div>
                <ul className="mt-2 space-y-2 text-[0.8rem] text-neutral-200">
                  {(effectiveLines ?? [])
                    .map((l) => ({ l, id: getLineIdFromRepairLine(l) }))
                    .filter((x) => !!x.id && issuesByLineId.has(x.id as string))
                    .slice(0, 10)
                    .map(({ l, id }) => {
                      const list = issuesByLineId.get(id as string) ?? [];
                      const r = l as unknown as Record<string, unknown>;
                      const label =
                        typeof r["complaint"] === "string" && (r["complaint"] as string).trim().length > 0
                          ? (r["complaint"] as string)
                          : `Line ${String(id).slice(0, 6)}…`;

                      return (
                        <li
                          key={`line-issue-${id}`}
                          className="rounded-md border border-white/10 bg-black/30 px-2 py-1.5"
                        >
                          <div className="flex items-center gap-2">
                            <span className="text-amber-300">⚠</span>
                            <span className="font-medium">{label}</span>
                          </div>
                          <div className="mt-1 space-y-0.5 pl-6 text-neutral-300">
                            {list.slice(0, 3).map((it, idx2) => (
                              <div key={`${id}-${idx2}`}>• {it.message}</div>
                            ))}
                          </div>
                        </li>
                      );
                    })}
                </ul>
              </div>
            ) : null}
          </div>
        ) : null}

        {/* Inspection PDF Panel (works even when invoice doesn't exist yet) */}
        <div className="rounded-xl border border-[var(--metal-border-soft)] bg-black/30 p-4">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
                Inspection PDF
              </div>
              <div className="mt-1 text-sm text-neutral-200">
                Download the finalized inspection report (if available).
              </div>
              {inspectionPdf?.storagePath ? (
                <div className="mt-1 text-[0.75rem] text-neutral-500">
                  Stored: <span className="text-neutral-400">{inspectionPdf.storagePath}</span>
                </div>
              ) : null}
            </div>

            <div className="flex items-center gap-2">
              <button
                type="button"
                onClick={() => void refreshInspectionPdf()}
                className="rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-3 py-1.5 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5 active:scale-95"
                disabled={inspectionPdfLoading}
                title="Reload inspection PDF status"
              >
                {inspectionPdfLoading ? "Refreshing…" : "Refresh"}
              </button>

              <button
                type="button"
                onClick={openInspectionPdf}
                disabled={!inspectionPdf?.pdfUrl}
                className={
                  "rounded-full px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] " +
                  (inspectionPdf?.pdfUrl
                    ? "bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] text-black hover:brightness-110"
                    : "border border-white/10 bg-black/40 text-neutral-400 opacity-60")
                }
                title={inspectionPdf?.pdfUrl ? "Open inspection PDF" : "No inspection PDF found yet"}
              >
                Open PDF
              </button>
            </div>
          </div>

          {!inspectionPdf?.pdfUrl ? (
            <div className="mt-3 text-[0.75rem] text-neutral-400">
              No inspection PDF is attached to this work order yet. Finish/finalize an inspection to generate it.
            </div>
          ) : null}
        </div>

        {/* PDF Download Panel */}
        <div className="rounded-xl border border-[var(--metal-border-soft)] bg-black/30 p-4">
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div>
              <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
                Invoice PDF
              </div>
              <div className="mt-1 text-sm text-neutral-200">
                Download a copy for your records.
              </div>
            </div>

            <div className={reviewOk ? "" : "opacity-60 pointer-events-none"}>
              <WorkOrderInvoiceDownloadButton
                workOrderId={workOrderId}
                lines={effectiveLines}
                summary={effectiveSummary}
                vehicleInfo={effectiveVehicleInfo}
                customerInfo={effectiveCustomerInfo}
                autoTrigger={false}
              />
            </div>
          </div>

          {!reviewOk ? (
            <div className="mt-3 text-[0.75rem] text-amber-200">
              PDF download is shown, but invoice is still blocked until required info is complete.
            </div>
          ) : null}
        </div>
      </div>
    </div>
  );
}

==================== FILE: features/work-orders/components/JobCard.tsx ====================

// features/work-orders/components/JobCard.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import type { Database } from "@shared/types/types/supabase";
import { UsePartButton } from "@work-orders/components/UsePartButton";
import { PartsUsedList } from "@work-orders/components/PartsUsedList";

type DB = Database;

export type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];

export type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

export type TechnicianInfo = {
  id: string;
  full_name: string | null;
  role: string | null;
};

export type JobCardPricing = {
  partsTotal?: number | null;
  laborTotal?: number | null;
  lineTotal?: number | null;
  currency?: string; // e.g. "CAD", "USD"
};

/** Optional per-line review signal from AI invoice review */
export type ReviewIssue = { kind: string; lineId?: string; message: string };

export type JobCardProps = {
  index: number;
  line: WorkOrderLine;
  parts: AllocationRow[];
  technicians: TechnicianInfo[];
  canAssign?: boolean;
  isPunchedIn?: boolean;
  onOpen: () => void;
  onAssign?: () => void;
  onOpenInspection?: () => void;
  onAddPart?: () => void;
  /** Optional pricing info – we’ll wire this from the page later */
  pricing?: JobCardPricing;

  /**
   * ✅ Optional AI review results for THIS line.
   * - Pass issues that belong to this lineId only.
   * - If omitted, card still shows local checks (missing cause/correction, no parts).
   */
  reviewIssues?: ReviewIssue[];
  /** ✅ Optional: if the overall WO review has passed */
  reviewOk?: boolean;
};

/* ---------------------------- Status visuals ---------------------------- */

type KnownStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

/** EXACT same pill basis */
const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-2.5 py-0.5 text-[10px] font-semibold tracking-wide";

const BADGE: Record<KnownStatus, string> = {
  awaiting_approval: "bg-blue-900/30 border-blue-400/50 text-blue-100",
  awaiting: "bg-slate-900/40 border-slate-400/60 text-slate-100",
  queued: "bg-indigo-900/35 border-indigo-400/55 text-indigo-100",
  in_progress:
    "bg-[color:var(--accent-copper,#f97316)]/10 border-[color:var(--accent-copper-soft,#fdba74)] text-[color:var(--accent-copper-light,#fed7aa)]",
  on_hold: "bg-amber-900/30 border-amber-400/55 text-amber-100",
  planned: "bg-purple-900/30 border-purple-400/55 text-purple-100",
  new: "bg-neutral-950/70 border-neutral-600/60 text-neutral-100",
  completed: "bg-emerald-900/25 border-emerald-400/60 text-emerald-100",
  ready_to_invoice:
    "bg-emerald-900/30 border-emerald-400/60 text-emerald-100",
  invoiced: "bg-teal-900/30 border-teal-400/60 text-teal-100",
};

const STATUS_ICON: Record<KnownStatus, string> = {
  awaiting_approval: "⏳",
  awaiting: "●",
  queued: "📋",
  in_progress: "🔧",
  on_hold: "⏸",
  planned: "🧩",
  new: "✨",
  completed: "✅",
  ready_to_invoice: "💳",
  invoiced: "📄",
};

const statusChip = (s: string | null | undefined): string => {
  const key = (s ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;
  return `${BASE_BADGE} ${BADGE[key] ?? BADGE.awaiting}`;
};

/** EXACT surface system but with stronger hero presence */
const CARD_SURFACE: Record<
  KnownStatus,
  { border: string; surface: string; ring: string; rail: string }
> = {
  awaiting_approval: {
    border: "border-sky-500/60",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.12),rgba(15,23,42,0.98))]",
    ring: "ring-sky-400/70",
    rail: "from-sky-500/70 via-sky-400/40 to-transparent",
  },
  awaiting: {
    border: "border-slate-600/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.16),rgba(15,23,42,0.98))]",
    ring: "ring-slate-300/70",
    rail: "from-slate-400/70 via-slate-300/40 to-transparent",
  },
  queued: {
    border: "border-indigo-500/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(129,140,248,0.18),rgba(15,23,42,0.98))]",
    ring: "ring-indigo-400/80",
    rail: "from-indigo-400/80 via-indigo-300/40 to-transparent",
  },
  in_progress: {
    border: "border-[color:var(--accent-copper-soft,#fdba74)]",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.28),rgba(15,23,42,0.98))]",
    ring: "ring-[color:var(--accent-copper-soft,#fdba74)]/80",
    rail:
      "from-[color:var(--accent-copper,#f97316)] via-[color:var(--accent-copper-soft,#fdba74)]/60 to-transparent",
  },
  on_hold: {
    border: "border-amber-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(251,191,36,0.24),rgba(15,23,42,0.97))]",
    ring: "ring-amber-300/80",
    rail: "from-amber-400 via-amber-300/60 to-transparent",
  },
  planned: {
    border: "border-purple-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(192,132,252,0.20),rgba(15,23,42,0.98))]",
    ring: "ring-purple-300/80",
    rail: "from-purple-400 via-purple-300/60 to-transparent",
  },
  new: {
    border: "border-neutral-700/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.12),rgba(15,23,42,0.99))]",
    ring: "ring-neutral-400/80",
    rail: "from-neutral-500 via-neutral-400/60 to-transparent",
  },
  completed: {
    border: "border-teal-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.26),rgba(15,23,42,0.97))]",
    ring: "ring-teal-300/80",
    rail: "from-teal-400 via-teal-300/60 to-transparent",
  },
  ready_to_invoice: {
    border: "border-emerald-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.26),rgba(15,23,42,0.96))]",
    ring: "ring-emerald-300/80",
    rail: "from-emerald-400 via-emerald-300/60 to-transparent",
  },
  invoiced: {
    border: "border-teal-400/85",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.30),rgba(15,23,42,0.96))]",
    ring: "ring-teal-300/80",
    rail: "from-teal-400 via-teal-300/60 to-transparent",
  },
};

/* ---------------------------- Review indicators ---------------------------- */

type ReviewFlags = {
  missingCause: boolean;
  missingCorrection: boolean;
  noParts: boolean;
  missingComplaint: boolean;
  otherIssues: number;
};

function norm(s: unknown): string {
  return String(s ?? "").trim().toLowerCase();
}

function computeReviewFlags(args: {
  line: WorkOrderLine;
  partsCount: number;
  reviewIssues?: ReviewIssue[];
}): ReviewFlags {
  // Local checks (works even without AI review)
  const localMissingCause = !norm(args.line.cause);
  const localMissingCorrection = !norm(args.line.correction);
  const localMissingComplaint =
    !norm(args.line.complaint) && !norm(args.line.description);
  const localNoParts = args.partsCount === 0;

  const issues = Array.isArray(args.reviewIssues) ? args.reviewIssues : [];

  // If AI issues exist, use them to drive flags (but keep local as fallback)
  let aiMissingCause = false;
  let aiMissingCorrection = false;
  let aiMissingComplaint = false;
  let aiNoParts = false;

  let other = 0;

  for (const it of issues) {
    const k = norm(it.kind);
    const m = norm(it.message);

    const hasCause = k.includes("cause") || m.includes("cause");
    const hasCorrection = k.includes("correction") || m.includes("corr");
    const hasComplaint =
      k.includes("complaint") ||
      m.includes("complaint") ||
      m.includes("description");
    const hasParts = k.includes("part") || m.includes("part");

    if (hasCause) aiMissingCause = true;
    else if (hasCorrection) aiMissingCorrection = true;
    else if (hasComplaint) aiMissingComplaint = true;
    else if (hasParts) aiNoParts = true;
    else other += 1;
  }

  return {
    missingCause: aiMissingCause || localMissingCause,
    missingCorrection: aiMissingCorrection || localMissingCorrection,
    missingComplaint: aiMissingComplaint || localMissingComplaint,
    noParts: aiNoParts || localNoParts,
    otherIssues: other,
  };
}

function ReviewIcon({
  title,
  label,
  tone,
}: {
  title: string;
  label: string;
  tone: "ok" | "warn" | "info";
}) {
  const base =
    "inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-semibold tracking-wide";
  const cls =
    tone === "ok"
      ? "border-emerald-400/60 bg-emerald-500/10 text-emerald-100"
      : tone === "warn"
        ? "border-amber-400/60 bg-amber-500/10 text-amber-100"
        : "border-white/15 bg-black/40 text-neutral-200";
  return (
    <span className={`${base} ${cls}`} title={title}>
      {label}
    </span>
  );
}

export function JobCard({
  index,
  line,
  parts,
  technicians,
  canAssign,
  isPunchedIn,
  onOpen,
  onAssign,
  onOpenInspection,
  onAddPart,
  pricing,
  reviewIssues,
  reviewOk,
}: JobCardProps): JSX.Element {
  const statusKey = (line.status ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;

  const surfaceCfg = CARD_SURFACE[statusKey] ?? CARD_SURFACE.awaiting;
  const [partsOpen, setPartsOpen] = useState(false);

  const isCompletedLike = (): boolean => {
    const s = (line.status ?? "").toLowerCase();
    return s === "completed" || s === "ready_to_invoice" || s === "invoiced";
  };

  const [collapsed, setCollapsed] = useState<boolean>(isCompletedLike());

  useEffect(() => {
    setCollapsed(isCompletedLike());
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [line.status]);

  const jobLabel = line.description || line.complaint || "Untitled job";

  const laborText =
    typeof line.labor_time === "number" ? `${line.labor_time}h` : "—";

  const jobTypeText = String(line.job_type ?? "job").replaceAll("_", " ");
  const statusText = String(line.status ?? "awaiting").replaceAll("_", " ");

  const showPricingRow =
    pricing &&
    (pricing.partsTotal != null ||
      pricing.laborTotal != null ||
      pricing.lineTotal != null);

  const currency =
    pricing?.currency && pricing.currency.trim().length > 0
      ? pricing.currency
      : undefined;

  const formatMoney = (v: number | null | undefined): string => {
    if (v == null || Number.isNaN(v)) return "—";
    const n = Number(v);
    return `${currency ?? "$"}${n.toFixed(2)}`;
  };

  const partsCount = parts.length;
  const partsSummary =
    partsCount === 0
      ? "No parts yet"
      : `${partsCount} part${partsCount === 1 ? "" : "s"}`;

  const handleCardClick = (): void => {
    onOpen();
  };

  const toggleCollapsed = (e: React.MouseEvent<HTMLButtonElement>): void => {
    e.stopPropagation();
    setCollapsed((c) => !c);
  };

  const statusIcon = STATUS_ICON[statusKey] ?? "●";

  const reviewFlags = useMemo(
    () =>
      computeReviewFlags({
        line,
        partsCount,
        reviewIssues,
      }),
    [line, partsCount, reviewIssues],
  );

  const showReviewRow = isCompletedLike();

  return (
    <div
      className={[
        "group relative cursor-pointer overflow-hidden rounded-2xl border p-3 md:p-4 transition-transform duration-150",
        surfaceCfg.border,
        surfaceCfg.surface,
        "shadow-[0_18px_45px_rgba(0,0,0,0.90)] hover:-translate-y-[1px] hover:shadow-[0_26px_60px_rgba(0,0,0,0.95)]",
        isPunchedIn ? `ring-2 ${surfaceCfg.ring}` : "ring-0",
      ].join(" ")}
      title="Open focused job"
      onClick={handleCardClick}
    >
      {/* subtle copper glow on hover */}
      <div className="pointer-events-none absolute inset-0 opacity-0 mix-blend-screen blur-xl transition-opacity duration-150 group-hover:opacity-70">
        <div className="absolute inset-x-10 -top-10 h-32 bg-[radial-gradient(circle,_rgba(249,115,22,0.22),transparent_65%)]" />
      </div>

      <div className="relative z-0 flex gap-3">
        <div className="mt-1 hidden h-[calc(100%-0.5rem)] w-[3px] rounded-full bg-gradient-to-b from-transparent via-white/30 to-transparent opacity-60 sm:block" />

        <div className="relative z-10 min-w-0 flex-1 space-y-1.5">
          <div className="flex flex-wrap items-start gap-2">
            <div className="flex min-w-0 flex-1 flex-wrap items-center gap-2">
              <div className="flex min-w-0 items-center gap-2">
                <span className="inline-flex h-6 min-w-[1.75rem] items-center justify-center rounded-full border border-white/15 bg-black/40 text-[11px] font-semibold text-neutral-200 shadow-[0_0_12px_rgba(0,0,0,0.8)]">
                  {index + 1}
                </span>
                <div className="truncate text-sm font-semibold text-white">
                  {jobLabel}
                </div>
              </div>

              {canAssign && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onAssign?.();
                  }}
                  className="inline-flex items-center gap-1 rounded-full border border-sky-500/70 bg-sky-900/20 px-2.5 py-0.5 text-[11px] font-medium text-sky-100 shadow-[0_0_14px_rgba(8,47,73,0.9)] hover:bg-sky-900/40"
                  title="Assign mechanic to this line"
                >
                  <span className="h-1.5 w-1.5 rounded-full bg-sky-300" />
                  Assign mechanic
                </button>
              )}

              {line.job_type === "inspection" && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onOpenInspection?.();
                  }}
                  className={`inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-[11px] font-semibold ${
                    isCompletedLike()
                      ? "border-teal-400 bg-teal-900/20 text-teal-100 hover:bg-teal-900/35"
                      : "border-orange-400 bg-orange-900/10 text-orange-100 hover:bg-orange-900/25"
                  }`}
                >
                  {isCompletedLike() ? "View inspection" : "Open inspection"}
                </button>
              )}
            </div>

            <div className="ml-auto flex items-center gap-2">
              <button
                type="button"
                onClick={toggleCollapsed}
                className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/15 bg-black/40 text-[11px] text-white/80 shadow-[0_0_14px_rgba(0,0,0,0.75)] hover:border-white/25 hover:bg-black/70 hover:text-white"
                title={collapsed ? "Expand job details" : "Collapse job details"}
              >
                <span
                  className={`inline-block transform text-[11px] transition-transform ${
                    collapsed ? "" : "rotate-90"
                  }`}
                >
                  ▶
                </span>
              </button>

              <span className={statusChip(line.status)}>
                <span className="mr-1">{statusIcon}</span>
                {statusText}
              </span>

              <button
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  onAddPart?.();
                }}
                className="hidden items-center gap-1 rounded-full border border-white/20 bg-black/35 px-2.5 py-1 text-[11px] font-medium text-white/85 shadow-[0_0_14px_rgba(0,0,0,0.8)] hover:border-[color:var(--accent-copper-soft,#fdba74)]/80 hover:bg-white/5 hover:text-white sm:inline-flex"
                title="Add / use part on this job"
              >
                ＋ <span className="hidden md:inline">Add part</span>
              </button>

              <div className="sm:hidden">
                <UsePartButton
                  workOrderLineId={line.id}
                  onApplied={() =>
                    window.dispatchEvent(new CustomEvent("wo:parts-used"))
                  }
                  label="Add part"
                />
              </div>
            </div>
          </div>

          {/* ✅ Review icons row (only after completed-like) */}
          {showReviewRow && (
            <div className="flex flex-wrap items-center gap-2 text-[11px]">
              {reviewOk ? (
                <ReviewIcon
                  tone="ok"
                  title="AI invoice review passed for this work order"
                  label="✅ Reviewed"
                />
              ) : (
                <ReviewIcon
                  tone="info"
                  title="Review not passed yet (or not run). Icons below show what needs fixing."
                  label="🧠 Review"
                />
              )}

              {reviewFlags.missingCause && (
                <ReviewIcon tone="warn" title="Cause is missing" label="⚠ Cause" />
              )}
              {reviewFlags.missingCorrection && (
                <ReviewIcon
                  tone="warn"
                  title="Correction is missing"
                  label="⚠ Correction"
                />
              )}
              {reviewFlags.noParts && (
                <ReviewIcon
                  tone="warn"
                  title="No parts recorded on this job line"
                  label="⚠ No parts"
                />
              )}
              {reviewFlags.missingComplaint && (
                <ReviewIcon
                  tone="warn"
                  title="Complaint / description is missing"
                  label="⚠ No complaint"
                />
              )}
              {reviewFlags.otherIssues > 0 && (
                <ReviewIcon
                  tone="warn"
                  title="Other review issues exist for this line"
                  label={`⚠ +${reviewFlags.otherIssues}`}
                />
              )}
            </div>
          )}

          <div className="flex flex-wrap items-center gap-2 text-[11px] text-neutral-300">
            <span className="inline-flex items-center gap-1">
              <span className="h-1.5 w-1.5 rounded-full bg-white/60" />
              {jobTypeText}
            </span>
            <span className="text-neutral-500">•</span>
            <span>Est. labor: {laborText}</span>
            <span className="text-neutral-500">•</span>
            <span className="text-neutral-300/90">
              Status: <span className="capitalize">{statusText}</span>
            </span>
            {isPunchedIn && (
              <>
                <span className="text-neutral-500">•</span>
                <span className="inline-flex items-center gap-1 text-emerald-300">
                  <span className="h-1.5 w-1.5 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(16,185,129,0.9)]" />
                  Punched in
                </span>
              </>
            )}
          </div>

          {isCompletedLike() && (
            <div className="text-[10px] text-emerald-200/80">
              {collapsed
                ? "Completed job – use the chevron to view details."
                : "Completed job – use the chevron to collapse details."}
            </div>
          )}

          {!collapsed && (
            <>
              {technicians.length > 0 && (
                <div className="mt-1.5 flex flex-wrap gap-1.5">
                  {technicians.map((tech) => (
                    <span
                      key={tech.id}
                      className="inline-flex items-center gap-1 rounded-full bg-sky-900/45 px-2.5 py-0.5 text-[10px] text-sky-100 shadow-[0_0_14px_rgba(8,47,73,0.9)]"
                    >
                      <span className="h-1.5 w-1.5 rounded-full bg-sky-300" />
                      {tech.full_name ?? "Mechanic"}
                    </span>
                  ))}
                </div>
              )}

              {(line.complaint || line.cause || line.correction) && (
                <div className="mt-1.5 flex flex-wrap items-center gap-2 rounded-lg bg-black/30 px-2 py-1.5 text-[11px] text-neutral-200">
                  {line.complaint && (
                    <span className="font-medium text-neutral-100">
                      Cmpl:{" "}
                      <span className="font-normal text-neutral-300">
                        {line.complaint}
                      </span>
                    </span>
                  )}
                  {line.cause && (
                    <span className="text-neutral-400">
                      | Cause:{" "}
                      <span className="font-normal text-neutral-200">
                        {line.cause}
                      </span>
                    </span>
                  )}
                  {line.correction && (
                    <span className="text-neutral-400">
                      | Corr:{" "}
                      <span className="font-normal text-neutral-200">
                        {line.correction}
                      </span>
                    </span>
                  )}
                </div>
              )}

              <div className="mt-2 rounded-xl border border-white/10 bg-black/40">
                <button
                  type="button"
                  className="flex w-full items-center justify-between gap-2 px-2.5 py-1.5 text-left"
                  onClick={(e) => {
                    e.stopPropagation();
                    setPartsOpen((open) => !open);
                  }}
                >
                  <div className="flex flex-col">
                    <span className="text-[11px] font-semibold uppercase tracking-[0.16em] text-neutral-200">
                      Parts used
                    </span>
                    <span className="text-[10px] text-neutral-400">
                      {partsSummary}
                    </span>
                  </div>

                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onAddPart?.();
                      }}
                      className="inline-flex items-center rounded-full border border-white/15 bg-black/35 px-2 py-0.5 text-[11px] font-medium text-white/85 hover:border-white/25 hover:bg-white/5 hover:text-white sm:hidden"
                    >
                      ＋ Part
                    </button>

                    <span
                      className={`text-[10px] text-white/60 transition-transform ${
                        partsOpen ? "rotate-90" : ""
                      }`}
                    >
                      ▶
                    </span>
                  </div>
                </button>

                {partsOpen && (
                  <div
                    className="border-t border-white/10 px-2.5 pb-2 pt-1.5"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <PartsUsedList allocations={parts} />
                  </div>
                )}
              </div>

              {showPricingRow && (
                <div className="mt-2 flex flex-wrap items-center justify-end gap-3 text-[11px] text-neutral-300">
                  {pricing?.partsTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Parts</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.partsTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.laborTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Labor</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.laborTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.lineTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Line total</span>
                      <span className="font-semibold text-[color:var(--accent-copper-light,#fed7aa)]">
                        {formatMoney(pricing.lineTotal)}
                      </span>
                    </span>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

==================== FILE: features/work-orders/components/JobPunchButton.tsx ====================

"use client";

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { Button } from "@shared/components/ui/Button";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type Props = {
  lineId: string;
  punchedInAt?: string | null;
  punchedOutAt?: string | null;
  status?: string | null;
  onUpdated?: () => void | Promise<void>;
  onFinishRequested?: () => void;
  disabled?: boolean;
};

type DB = Database;

type RpcErrorLike = { message?: string | null; code?: string | null };

export default function JobPunchButton({
  lineId,
  punchedInAt,
  punchedOutAt,
  status,
  onUpdated,
  onFinishRequested,
  disabled = false,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);
  const [busy, setBusy] = useState(false);
  const [flash, setFlash] = useState<"started" | "finished" | null>(null);

  const normalizedStatus = (status ?? "").toLowerCase();
  const isOnHold = normalizedStatus === "on_hold";

  const isStarted = !!punchedInAt && !punchedOutAt && !isOnHold;
  const effectiveDisabled = disabled || isOnHold;

  const showFlash = (kind: typeof flash) => {
    setFlash(kind);
    window.setTimeout(() => setFlash(null), 1200);
  };

  const showUserFriendlyRpcError = (err: RpcErrorLike): boolean => {
    const msg = String(err.message ?? "");
    const msgLc = msg.toLowerCase();

    if (
      msgLc.includes("schema cache") ||
      msgLc.includes("could not find the function")
    ) {
      toast.error("System updated. Refresh the page and try again.");
      return true;
    }

    if (err.code === "28000" || msgLc.includes("not assigned")) {
      toast.error("This job is assigned to another tech. Ask a manager to reassign it.");
      return true;
    }
    if (msgLc.includes("forbidden") || msgLc.includes("not allowed")) {
      toast.error("You don’t have permission to start this job.");
      return true;
    }

    if (
      err.code === "23505" ||
      msgLc.includes("another active job") ||
      msgLc.includes("active job")
    ) {
      toast.error("You already have another active job. Finish it first.");
      return true;
    }

    return false;
  };

  async function rpcAnyArgs(
    fn: string,
    args: Record<string, unknown>,
  ): Promise<{ error?: RpcErrorLike | null }> {
    // typed call first
    const res = await (supabase as unknown as { rpc: Function }).rpc(fn, args);
    return res ?? { error: { message: "RPC call failed" } };
  }

  async function punchInRpc(): Promise<
    { ok: true } | { ok: false; error: RpcErrorLike }
  > {
    // Try common arg names in order (handles schema drift)
    const tries: Record<string, unknown>[] = [
      { p_line_id: lineId },
      { line_id: lineId },
      { p_job_id: lineId },
      { job_id: lineId },
    ];

    let lastErr: RpcErrorLike = { message: "Start failed" };

    for (const args of tries) {
      const res = await rpcAnyArgs("punch_in", args);
      if (!res.error) return { ok: true };

      lastErr = res.error ?? lastErr;

      // If it’s a “hard” error (permission/constraint), don’t keep retrying
      const msgLc = String(lastErr.message ?? "").toLowerCase();
      const hard =
        msgLc.includes("not allowed") ||
        msgLc.includes("forbidden") ||
        msgLc.includes("not assigned") ||
        msgLc.includes("permission") ||
        msgLc.includes("rls");
      if (hard) break;
    }

    return { ok: false, error: lastErr };
  }

  const start = async () => {
    if (busy || effectiveDisabled) return;
    if (!lineId) {
      toast.error("Missing job line id.");
      return;
    }

    setBusy(true);
    try {
      const rpc = await punchInRpc();

      if (!rpc.ok) {
        if (!showUserFriendlyRpcError(rpc.error)) {
          toast.error(rpc.error.message ?? "Start failed");
        }
        return;
      }

      const nowIso = new Date().toISOString();

      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        status: "in_progress",
        punched_out_at: null,
      };

      if (!punchedInAt) update.punched_in_at = nowIso;

      const { error: lineErr } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", lineId);

      if (lineErr) {
        toast.error(lineErr.message ?? "Failed to update job status");
        return;
      }

      toast.success("Started job");
      showFlash("started");

      window.dispatchEvent(new CustomEvent("wol:refresh"));
      await onUpdated?.();
    } catch (e) {
      toast.error(e instanceof Error ? e.message : "Start failed");
    } finally {
      setBusy(false);
    }
  };

  const handlePrimary = () => {
    if (busy || effectiveDisabled) return;

    if (isStarted) {
      if (!onFinishRequested) {
        toast.error("Finish flow is not wired on this page.");
        return;
      }
      onFinishRequested();
      showFlash("finished");
      return;
    }

    void start();
  };

  const label = busy
    ? "Saving…"
    : isStarted
      ? "Finish job"
      : isOnHold
        ? "On hold"
        : "Start job";

  const startClasses =
    "bg-emerald-600 text-white border-emerald-500 hover:bg-emerald-500 hover:border-emerald-400 focus-visible:ring-emerald-400";
  const finishClasses =
    "border-[var(--accent-copper-light)] text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper-faint)]";

  return (
    <div className="relative w-full">
      <Button
        type="button"
        onClick={handlePrimary}
        disabled={busy || effectiveDisabled}
        isLoading={busy}
        variant="outline"
        size="md"
        className={[
          "inline-flex w-full items-center justify-center text-center text-sm font-blackops tracking-[0.16em] uppercase",
          isStarted ? finishClasses : startClasses,
        ].join(" ")}
        aria-pressed={isStarted}
        aria-busy={busy}
      >
        {label}
      </Button>

      {flash && (
        <div
          className={`pointer-events-none absolute inset-x-0 -top-3 mx-auto w-fit rounded px-2 py-1 text-xs font-semibold shadow-md
            ${
              flash === "started"
                ? "bg-emerald-700/80 text-emerald-100"
                : "bg-[rgba(184,115,51,0.9)] text-black shadow-[0_0_15px_rgba(184,115,51,0.9)]"
            }`}
        >
          {flash === "started" ? "✓ Started" : "✓ Finish requested"}
        </div>
      )}

      {isOnHold && !busy && (
        <div className="mt-1 text-center text-[10px] text-amber-300">
          Job is on hold — release hold to start again.
        </div>
      )}
    </div>
  );
}

==================== FILE: features/work-orders/components/MenuQuickAdd.tsx ====================

// features/work-orders/components/MenuQuickAdd.tsx
"use client";

import { useEffect, useState, useMemo, useRef, useCallback } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database, TablesInsert } from "@shared/types/types/supabase";
import { AiSuggestModal } from "@work-orders/components/AiSuggestModal";
import { calculateTax, type ProvinceCode } from "@/features/integrations/tax";

type DB = Database;
type WorkOrderLineInsert = TablesInsert<"work_order_lines">;

type JobType = "maintenance" | "repair" | "diagnosis" | "inspection";

type PackageItem = {
  description: string;
  jobType?: JobType;
  laborHours?: number | null;
  notes?: string | null;
};

type PackageDef = {
  id: string;
  name: string;
  summary: string;
  jobType: "inspection" | "maintenance";
  estLaborHours: number | null;
  items: PackageItem[];
};

type MenuItemRow = DB["public"]["Tables"]["menu_items"]["Row"];

type TemplateRow = DB["public"]["Tables"]["inspection_templates"]["Row"] & {
  labor_hours?: number | null;
};

type VehicleLite = {
  id?: string | null;
  year?: number | string | null;
  make?: string | null;
  model?: string | null;
  submodel?: string | null;
  engine_type?: string | null;
  transmission_type?: string | null;
  drivetrain?: string | null;
  vin?: string | null;
  license_plate?: string | null;
};

type CustomerLite = {
  id?: string | null;
  first_name?: string | null;
  last_name?: string | null;
  phone?: string | null;
  email?: string | null;
};

type AddMenuParams =
  | {
      kind?: "normal";
      name: string;
      jobType: JobType;
      laborHours?: number | null;
      notes?: string | null;
      source?: "single" | "package" | "menu_item" | "ai" | "inspection";
      returnLineId?: boolean;

      // ✅ persist linkage
      menuItemId?: string | null;
      inspectionTemplateId?: string | null;
    }
  | {
      kind: "template";
      template: TemplateRow;
      name?: string;
      laborHours?: number | null;
    };

type ShopDefaults = {
  country: "US" | "CA";
  province: string | null;
  timezone: string | null;
  labor_rate: number | null;
  tax_rate: number | null; // percent in DB (e.g. 5 => 5%)
};

function normStr(v: unknown): string | null {
  if (typeof v !== "string") return null;
  const t = v.trim();
  return t.length ? t : null;
}
function normLower(v: unknown): string | null {
  const s = normStr(v);
  return s ? s.toLowerCase() : null;
}
function normYear(v: unknown): number | null {
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (typeof v === "string") {
    const n = Number.parseInt(v.trim(), 10);
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

function getStringField(obj: unknown, key: string): string | null {
  if (!obj || typeof obj !== "object") return null;
  const v = (obj as Record<string, unknown>)[key];
  if (typeof v !== "string") return null;
  const t = v.trim();
  return t.length ? t : null;
}

function isGlobalMenuItem(mi: MenuItemRow): boolean {
  const has =
    mi.vehicle_year != null ||
    !!normStr(mi.vehicle_make) ||
    !!normStr(mi.vehicle_model) ||
    !!normStr(mi.submodel) ||
    !!normStr(mi.engine_type) ||
    !!normStr(mi.transmission_type) ||
    !!normStr(mi.drivetrain);
  return !has;
}

function scoreMenuItemFit(args: { mi: MenuItemRow; vehicle: VehicleLite | null }): number {
  const { mi, vehicle } = args;
  if (!vehicle) return isGlobalMenuItem(mi) ? 5 : 0;

  const vYear = normYear(vehicle.year);
  const vMake = normLower(vehicle.make);
  const vModel = normLower(vehicle.model);
  const vSub = normLower(vehicle.submodel);
  const vEng = normLower(vehicle.engine_type);
  const vTrans = normLower(vehicle.transmission_type);
  const vDrive = normLower(vehicle.drivetrain);

  const miYear = mi.vehicle_year ?? null;
  const miMake = normLower(mi.vehicle_make);
  const miModel = normLower(mi.vehicle_model);
  const miSub = normLower(mi.submodel);
  const miEng = normLower(mi.engine_type);
  const miTrans = normLower(mi.transmission_type);
  const miDrive = normLower(mi.drivetrain);

  if (miYear != null && vYear != null && miYear !== vYear) return 0;
  if (miMake && vMake && miMake !== vMake) return 0;
  if (miModel && vModel && miModel !== vModel) return 0;
  if (miSub && vSub && miSub !== vSub) return 0;
  if (miEng && vEng && miEng !== vEng) return 0;
  if (miTrans && vTrans && miTrans !== vTrans) return 0;
  if (miDrive && vDrive && miDrive !== vDrive) return 0;

  let score = 0;

  if (miYear != null && vYear != null && miYear === vYear) score += 30;
  else if (miYear == null) score += 8;

  if (miMake && vMake && miMake === vMake) score += 25;
  else if (!miMake) score += 6;

  if (miModel && vModel && miModel === vModel) score += 25;
  else if (!miModel) score += 6;

  if (miSub && vSub && miSub === vSub) score += 10;
  else if (!miSub) score += 2;

  if (miEng && vEng && miEng === vEng) score += 6;
  else if (!miEng) score += 1;

  if (miTrans && vTrans && miTrans === vTrans) score += 6;
  else if (!miTrans) score += 1;

  if (miDrive && vDrive && miDrive === vDrive) score += 6;
  else if (!miDrive) score += 1;

  return score;
}

function menuSearchHit(mi: MenuItemRow, q: string): boolean {
  const needle = q.trim().toLowerCase();
  if (!needle) return true;

  const hay = [
    mi.name,
    mi.description,
    mi.category,
    mi.service_key,
    mi.complaint,
    mi.cause,
    mi.correction,
  ]
    .map((x) => (typeof x === "string" ? x : ""))
    .join(" ")
    .toLowerCase();

  return hay.includes(needle);
}

function isProvinceCode(v: string): v is ProvinceCode {
  return (
    v === "AB" ||
    v === "BC" ||
    v === "MB" ||
    v === "NB" ||
    v === "NL" ||
    v === "NS" ||
    v === "NT" ||
    v === "NU" ||
    v === "ON" ||
    v === "PE" ||
    v === "QC" ||
    v === "SK" ||
    v === "YT"
  );
}

function moneyLabel(currency: "CAD" | "USD", amount: number): string {
  const rounded = Number.isFinite(amount) ? amount : 0;
  return `${currency} $${rounded.toFixed(0)}`;
}

function calcMenuTotals(args: {
  mi: MenuItemRow;
  shop: ShopDefaults | null;
}): {
  laborHours: number;
  laborRate: number;
  laborTotal: number;
  partsTotal: number;
  subtotal: number;
  taxTotal: number;
  total: number;
  taxLabel: string | null;
} {
  const { mi, shop } = args;

  const laborHours =
    typeof mi.labor_time === "number" && Number.isFinite(mi.labor_time) ? mi.labor_time : 0;

  const partsTotal =
    typeof mi.part_cost === "number" && Number.isFinite(mi.part_cost) ? mi.part_cost : 0;

  const laborRate =
    shop && typeof shop.labor_rate === "number" && Number.isFinite(shop.labor_rate)
      ? shop.labor_rate
      : 0;

  const laborTotal = laborHours * laborRate;
  const subtotal = partsTotal + laborTotal;

  if (shop?.country === "CA") {
    const prov = (shop.province ?? "").trim().toUpperCase();
    if (isProvinceCode(prov)) {
      const res = calculateTax(subtotal, prov);
      const taxTotal = res.taxes.reduce((a, t) => a + t.amount, 0);
      const taxLabel = res.taxes.map((t) => t.label).join("+") || null;
      return {
        laborHours,
        laborRate,
        laborTotal,
        partsTotal,
        subtotal,
        taxTotal,
        total: res.total,
        taxLabel,
      };
    }
  }

  const pct =
    shop && typeof shop.tax_rate === "number" && Number.isFinite(shop.tax_rate)
      ? shop.tax_rate / 100
      : 0;

  const taxTotal = subtotal * pct;
  return {
    laborHours,
    laborRate,
    laborTotal,
    partsTotal,
    subtotal,
    taxTotal,
    total: subtotal + taxTotal,
    taxLabel: pct > 0 ? "Tax" : null,
  };
}

// ✅ Try to infer if a menu item represents a custom inspection
function extractInspectionTemplateIdFromMenuItem(mi: MenuItemRow): string | null {
  // common column names we’ve seen in ProFixIQ evolutions
  return (
    getStringField(mi, "inspection_template_id") ||
    getStringField(mi, "template_id") ||
    getStringField(mi, "inspectionTemplateId") ||
    getStringField(mi, "inspection_template") ||
    null
  );
}

export function MenuQuickAdd({ workOrderId }: { workOrderId: string }) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  const packages: PackageDef[] = [
    {
      id: "oil-gas",
      name: "Oil Change – Gasoline",
      jobType: "maintenance",
      estLaborHours: 0.8,
      summary: "Oil & filter, fluids, tire pressures, quick leak check.",
      items: [],
    },
    {
      id: "insp-gas",
      name: "Multi-Point Inspection – Gas",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "Brakes, tires, suspension, battery, lights, codes scan.",
      items: [],
    },
    {
      id: "maintenance-50",
      name: "Maintenance 50",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "50-point inspection checklist.",
      items: [],
    },
    {
      id: "maintenance-50-air",
      name: "Maintenance 50 – Air",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "50-point inspection checklist (air systems focus).",
      items: [],
    },
  ];

  const [addingId, setAddingId] = useState<string | null>(null);
  const [vehicle, setVehicle] = useState<VehicleLite | null>(null);
  const [, setCustomer] = useState<CustomerLite | null>(null);
  const [woLineCount, setWoLineCount] = useState<number | null>(null);

  const [menuItemsAll, setMenuItemsAll] = useState<MenuItemRow[]>([]);
  const [menuLoading, setMenuLoading] = useState(false);

  const [templates, setTemplates] = useState<TemplateRow[]>([]);
  const [templatesLoading, setTemplatesLoading] = useState(false);

  const [shopId, setShopId] = useState<string | null>(null);
  const shopReady = !!shopId;
  const vehicleId = vehicle?.id ?? null;

  const [shopDefaults, setShopDefaults] = useState<ShopDefaults | null>(null);

  const [aiOpen, setAiOpen] = useState(false);

  const [menuQuery, setMenuQuery] = useState("");
  const [includeGlobal, setIncludeGlobal] = useState(true);

  const lastSetShopId = useRef<string | null>(null);

  const ensureShopContext = useCallback(
    async (id: string | null) => {
      if (!id) return;
      if (lastSetShopId.current === id) return;

      const { error } = await supabase.rpc("set_current_shop_id", {
        p_shop_id: id,
      });

      if (error) throw new Error(error.message || "Failed to set shop context");
      lastSetShopId.current = id;
    },
    [supabase],
  );

  useEffect(() => {
    void (async () => {
      const { data: wo, error: woErr } = await supabase
        .from("work_orders")
        .select("id, vehicle_id, customer_id, shop_id")
        .eq("id", workOrderId)
        .maybeSingle();

      if (woErr) {
        toast.error(woErr.message);
        return;
      }

      const sid = wo?.shop_id ?? null;
      setShopId(sid);

      if (sid) {
        const { data: s, error: sErr } = await supabase
          .from("shops")
          .select("country, province, timezone, labor_rate, tax_rate")
          .eq("id", sid)
          .maybeSingle();

        if (sErr) {
          toast.message(sErr.message);
          setShopDefaults(null);
        } else {
          const countrySafe: "US" | "CA" = s?.country === "CA" ? "CA" : "US";
          setShopDefaults({
            country: countrySafe,
            province: typeof s?.province === "string" ? s.province : null,
            timezone: typeof s?.timezone === "string" ? s.timezone : null,
            labor_rate: typeof s?.labor_rate === "number" ? s.labor_rate : null,
            tax_rate: typeof s?.tax_rate === "number" ? s.tax_rate : null,
          });
        }
      } else {
        setShopDefaults(null);
      }

      if (wo?.vehicle_id) {
        const { data: v, error: vErr } = await supabase
          .from("vehicles")
          .select(
            "id, year, make, model, submodel, engine_type, transmission_type, drivetrain, vin, license_plate",
          )
          .eq("id", wo.vehicle_id)
          .maybeSingle();
        if (vErr) toast.message(vErr.message);
        setVehicle(v ? (v as VehicleLite) : null);
      } else {
        setVehicle(null);
      }

      if (wo?.customer_id) {
        const { data: c, error: cErr } = await supabase
          .from("customers")
          .select("id, first_name, last_name, phone, email")
          .eq("id", wo.customer_id)
          .maybeSingle();
        if (cErr) toast.message(cErr.message);
        setCustomer(c ? (c as CustomerLite) : null);
      } else {
        setCustomer(null);
      }

      const { count, error: cntErr } = await supabase
        .from("work_order_lines")
        .select("*", { count: "exact", head: true })
        .eq("work_order_id", workOrderId);

      if (cntErr) toast.message(cntErr.message);
      setWoLineCount(typeof count === "number" ? count : null);
    })();
  }, [supabase, workOrderId]);

  const loadMenuItems = useCallback(async () => {
    if (!shopId) return;

    setMenuLoading(true);
    try {
      await ensureShopContext(shopId);

      const { data, error } = await supabase
        .from("menu_items")
        .select("*")
        .eq("shop_id", shopId)
        .eq("is_active", true)
        .order("created_at", { ascending: false })
        .limit(400);

      if (error) throw error;

      setMenuItemsAll((data ?? []) as MenuItemRow[]);
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to load menu items.";
      toast.message(msg);
      setMenuItemsAll([]);
    } finally {
      setMenuLoading(false);
    }
  }, [ensureShopContext, supabase, shopId]);

  const loadTemplates = useCallback(async () => {
    if (!shopId) return;

    setTemplatesLoading(true);
    try {
      await ensureShopContext(shopId);

      const [{ data: auth }, { data, error }] = await Promise.all([
        supabase.auth.getUser(),
        supabase.from("inspection_templates").select("*").order("created_at", { ascending: false }),
      ]);

      if (error) throw error;

      const uid = auth?.user?.id ?? null;
      const rows = (data ?? []) as TemplateRow[];

      const score = (t: TemplateRow): number => {
        if (uid && t.user_id === uid) return 0;
        if (t.shop_id && t.shop_id === shopId) return 1;
        if (t.is_public) return 2;
        return 3;
      };

      rows.sort((a, b) => score(a) - score(b));
      setTemplates(rows);
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to load templates.";
      toast.message(msg);
      setTemplates([]);
    } finally {
      setTemplatesLoading(false);
    }
  }, [ensureShopContext, supabase, shopId]);

  useEffect(() => {
    if (!shopId) return;
    void loadMenuItems();
    void loadTemplates();
  }, [shopId, loadMenuItems, loadTemplates]);

  async function addMenuItem(params: AddMenuParams): Promise<string | null> {
    if (!shopReady || !shopId) return null;

    setAddingId(params.kind === "template" ? params.template.id : params.name);

    try {
      await ensureShopContext(shopId);

      if (params.kind === "template") {
        const line: WorkOrderLineInsert & { inspection_template_id?: string | null } = {
          work_order_id: workOrderId,
          vehicle_id: vehicleId,
          description: params.name ?? params.template.template_name ?? "Inspection",
          job_type: "inspection",
          labor_time:
            params.laborHours ??
            (typeof params.template.labor_hours === "number" ? params.template.labor_hours : null),
          status: "awaiting",
          priority: 3,
          notes: params.template.description ?? null,
          shop_id: shopId,
          inspection_template_id: params.template.id,
        };

        const { data, error } = await supabase.from("work_order_lines").insert(line).select("id").single();
        if (error) throw new Error(error.message);

        window.dispatchEvent(new CustomEvent("wo:line-added"));
        toast.success("Inspection added");
        return data?.id ?? null;
      }

      const line: WorkOrderLineInsert & {
        menu_item_id?: string | null;
        inspection_template_id?: string | null;
        template_id?: string | null;
      } = {
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        description: params.name,
        job_type: params.jobType,
        labor_time: params.laborHours ?? null,
        status: "awaiting",
        priority: 3,
        notes: params.notes ?? null,
        shop_id: shopId,

        // ✅ persist linkages that invoicing/attachment logic can rely on
        menu_item_id: params.menuItemId ?? null,
        inspection_template_id: params.inspectionTemplateId ?? null,

        // optional legacy mirror (harmless if column exists)
        template_id: params.inspectionTemplateId ?? null,
      };

      const { data, error } = await supabase.from("work_order_lines").insert(line).select("id").single();
      if (error) throw new Error(error.message);

      window.dispatchEvent(new CustomEvent("wo:line-added"));
      toast.success("Job added");

      return params.returnLineId ? (data?.id ?? null) : null;
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to add job.";
      lastSetShopId.current = null;
      toast.error(msg);
      return null;
    } finally {
      setAddingId(null);
    }
  }

  async function addPackage(pkg: PackageDef) {
    await addMenuItem({
      kind: "normal",
      name: pkg.name,
      jobType: pkg.jobType === "inspection" ? "inspection" : "maintenance",
      laborHours: pkg.estLaborHours ?? null,
      notes: pkg.summary,
      source: "package",
    });
  }

  async function addSavedMenuItem(mi: MenuItemRow) {
    const templateId = extractInspectionTemplateIdFromMenuItem(mi);

    await addMenuItem({
      kind: "normal",
      name: mi.name ?? "Service",

      // ✅ if it has a template id, treat it as an inspection job
      jobType: templateId ? "inspection" : "maintenance",

      laborHours: typeof mi.labor_time === "number" ? mi.labor_time : null,
      notes: mi.description ?? null,
      source: "menu_item",
      returnLineId: false,

      // ✅ persist menu + inspection linkage
      menuItemId: mi.id ?? null,
      inspectionTemplateId: templateId,
    });
  }

  async function addTemplateAsLine(t: TemplateRow) {
    await addMenuItem({ kind: "template", template: t });
  }

  const vehicleLabel =
    vehicle && (vehicle.year || vehicle.make || vehicle.model)
      ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}`.trim()
      : vehicle?.license_plate
        ? `Plate ${vehicle.license_plate}`
        : null;

  const menuItemsDisplay = useMemo(() => {
    const q = menuQuery.trim();
    const scored = menuItemsAll
      .filter((mi) => menuSearchHit(mi, q))
      .map((mi) => ({
        mi,
        score: scoreMenuItemFit({ mi, vehicle }),
        global: isGlobalMenuItem(mi),
      }))
      .filter((x) => (includeGlobal ? true : !x.global))
      .filter((x) => {
        if (!vehicle) return true;
        if (x.global) return true;
        return x.score > 0;
      })
      .sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        const aT = new Date(a.mi.created_at ?? 0).getTime();
        const bT = new Date(b.mi.created_at ?? 0).getTime();
        return bT - aT;
      });

    return scored.map((x) => x.mi);
  }, [menuItemsAll, menuQuery, includeGlobal, vehicle]);

  const currency: "CAD" | "USD" = shopDefaults?.country === "CA" ? "CAD" : "USD";

  return (
    <div className="space-y-5 text-white">
      {/* header */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 px-3 py-3 sm:px-4 sm:py-3">
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-semibold text-orange-400">Quick Add Jobs</h3>
              <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] font-mono text-neutral-300">
                WO {workOrderId.slice(0, 8)}…
              </span>
              {shopDefaults?.labor_rate != null ? (
                <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] text-neutral-300">
                  Labor {shopDefaults.labor_rate.toFixed(0)}/{currency}/hr
                </span>
              ) : null}
            </div>

            {vehicleLabel ? (
              <p className="text-[11px] text-neutral-400">
                Vehicle:&nbsp;<span className="font-medium text-neutral-200">{vehicleLabel}</span>
              </p>
            ) : (
              <p className="text-[11px] text-neutral-500">Add lines now — you can update vehicle details later.</p>
            )}
          </div>

          <div className="flex flex-wrap items-center justify-end gap-2">
            <button
              type="button"
              onClick={() => router.push(`/work-orders/quote-review?woId=${workOrderId}`)}
              className="rounded-md border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-xs sm:text-sm text-neutral-100 hover:border-orange-500 hover:bg-neutral-800"
            >
              Review quote
              {typeof woLineCount === "number" && woLineCount > 0 ? ` (${woLineCount})` : ""}
            </button>
            <button
              type="button"
              onClick={() => setAiOpen(true)}
              className="rounded-md border border-blue-600 bg-neutral-950 px-3 py-1.5 text-xs sm:text-sm text-blue-300 hover:bg-blue-900/30"
              title="Describe work and let AI suggest service lines"
            >
              AI Suggest
            </button>
          </div>
        </div>
      </div>

      {/* packages */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">Packages</h4>
          <p className="text-[10px] text-neutral-500">Common services with pre-set labor & notes.</p>
        </div>
        <div className="grid gap-2 sm:grid-cols-2">
          {packages.map((p) => (
            <button
              type="button"
              key={p.id}
              onClick={() => void addPackage(p)}
              disabled={addingId === p.id || !shopReady}
              className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
              title={p.summary}
            >
              <div className="flex items-center justify-between gap-2">
                <span className="font-medium text-neutral-50">{p.name}</span>
                <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] uppercase tracking-wide text-neutral-300">
                  {p.jobType}
                </span>
              </div>
              <div className="mt-1 text-xs text-neutral-400">
                {p.estLaborHours != null ? `~${p.estLaborHours.toFixed(1)}h` : "Labor TBD"}
              </div>
              <div className="mt-1 line-clamp-2 text-[11px] text-neutral-500">{p.summary}</div>
            </button>
          ))}
        </div>
      </div>

      {/* templates */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">Inspection Templates</h4>
          <p className="text-[10px] text-neutral-500">Saved/standard inspections you can attach as jobs.</p>
        </div>
        <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {templatesLoading ? (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">Loading templates…</div>
          ) : templates.length ? (
            templates.slice(0, 9).map((t) => (
              <button
                key={t.id}
                type="button"
                onClick={() => void addTemplateAsLine(t)}
                disabled={addingId === t.id || !shopReady}
                className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
                title={t.description ?? undefined}
              >
                <span className="font-medium text-neutral-50">{t.template_name ?? "Inspection"}</span>
                <div className="mt-1 text-xs text-neutral-400">
                  inspection • {typeof t.labor_hours === "number" ? `${t.labor_hours.toFixed(1)}h` : "Labor TBD"}
                </div>
              </button>
            ))
          ) : (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">No templates yet.</div>
          )}
        </div>
      </div>

      {/* menu items */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
          <div className="space-y-1">
            <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">From My Menu</h4>
            <p className="text-[10px] text-neutral-500">
              Matches for this vehicle are shown first. Totals use shop labor + tax rules (province engine for CA).
            </p>
          </div>

          <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
            <input
              value={menuQuery}
              onChange={(e) => setMenuQuery(e.target.value)}
              placeholder="Search menu items (e.g. brakes, alignment, oil)…"
              className="w-full sm:w-[320px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-xs sm:text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            />
            <label className="flex items-center gap-2 text-[11px] text-neutral-300">
              <input
                type="checkbox"
                checked={includeGlobal}
                onChange={(e) => setIncludeGlobal(e.target.checked)}
                className="h-4 w-4 rounded border-neutral-700 bg-neutral-900"
              />
              Include global services
            </label>
          </div>
        </div>

        <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {menuLoading ? (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">Loading menu items…</div>
          ) : menuItemsDisplay.length ? (
            menuItemsDisplay.slice(0, 12).map((mi) => {
              const p = calcMenuTotals({ mi, shop: shopDefaults });

              const laborLabel = p.laborHours > 0 ? `${p.laborHours.toFixed(1)}h` : "Labor TBD";
              const partsLabel = p.partsTotal > 0 ? `${moneyLabel(currency, p.partsTotal)} parts` : "No parts";
              const totalLabel = p.total > 0 ? moneyLabel(currency, p.total) : "No total";
              const taxLabel =
                p.taxTotal > 0 ? `${p.taxLabel ?? "Tax"} ${moneyLabel(currency, p.taxTotal)}` : null;

              return (
                <button
                  type="button"
                  key={mi.id}
                  onClick={() => void addSavedMenuItem(mi)}
                  disabled={addingId === (mi.name ?? "") || !shopReady}
                  className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
                  title={mi.description ?? undefined}
                >
                  <span className="font-medium text-neutral-50">{mi.name}</span>

                  <div className="mt-1 text-xs text-neutral-400">
                    {laborLabel} • {partsLabel} • <span className="text-neutral-100">{totalLabel}</span>
                    {taxLabel ? <span className="ml-1 text-neutral-500">• {taxLabel}</span> : null}

                    {isGlobalMenuItem(mi) ? (
                      <span className="ml-2 rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] text-neutral-300">
                        GLOBAL
                      </span>
                    ) : (
                      <span className="ml-2 rounded-full border border-orange-500/60 bg-orange-500/10 px-2 py-0.5 text-[10px] text-orange-200">
                        FIT
                      </span>
                    )}
                  </div>

                  {mi.service_key ? (
                    <div className="mt-1 font-mono text-[10px] text-neutral-500">{mi.service_key}</div>
                  ) : null}
                </button>
              );
            })
          ) : (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">
              No menu items match this filter.
            </div>
          )}
        </div>
      </div>

      <AiSuggestModal
        open={aiOpen}
        onClose={() => setAiOpen(false)}
        workOrderId={workOrderId}
        vehicleId={vehicleId ?? null}
        vehicleLabel={vehicleLabel ?? null}
        onAdded={(count) => {
          setWoLineCount((prev) => (typeof prev === "number" ? prev + count : prev));
        }}
      />
    </div>
  );
}

export default MenuQuickAdd;

==================== FILE: features/work-orders/components/NewLineFormIsland.tsx ====================

"use client";

import { useRouter } from "next/navigation";
import { NewWorkOrderLineForm } from "./NewWorkOrderLineForm";

type Props = {
  workOrderId: string;
  vehicleId: string | null;
  defaultJobType: "inspection" | "maintenance" | "diagnosis" | null;
};

export default function NewLineFormIsland(props: Props) {
  const router = useRouter();
  return <NewWorkOrderLineForm {...props} onCreated={() => router.refresh()} />;
}


==================== FILE: features/work-orders/components/NewWorkOrderLineForm.tsx ====================

//features/work-orders/components/NewWorkOrderLineForm.tsx

"use client";

import { useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type InsertLine = DB["public"]["Tables"]["work_order_lines"]["Insert"];

// Keep in sync with your DB check constraint
type WOJobType = "diagnosis" | "inspection" | "maintenance" | "repair";

const ALLOWED_STATUS = [
  "awaiting",
  "in_progress",
  "on_hold",
  "paused",
  "completed",
] as const;
type AllowedStatus = (typeof ALLOWED_STATUS)[number];

export function NewWorkOrderLineForm(props: {
  workOrderId: string;
  vehicleId: string | null;
  defaultJobType: WOJobType | null;
  shopId?: string | null; // REQUIRED for your shop-based models
  onCreated?: () => void;
}) {
  const { workOrderId, vehicleId, defaultJobType, shopId, onCreated } = props;

  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [complaint, setComplaint] = useState("");
  const [cause, setCause] = useState("");
  const [correction, setCorrection] = useState("");
  const [labor, setLabor] = useState<string>("");
  const [status, setStatus] = useState<InsertLine["status"]>("awaiting");
  const [jobType, setJobType] = useState<WOJobType | null>(
    defaultJobType ?? null,
  );
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const canSave = complaint.trim().length > 0 && !!workOrderId;

  function normalizeJobType(t: WOJobType | null): InsertLine["job_type"] {
    const allowed: WOJobType[] = [
      "diagnosis",
      "inspection",
      "maintenance",
      "repair",
    ];
    return t && (allowed as string[]).includes(t)
      ? (t as InsertLine["job_type"])
      : null;
  }

  function normalizeStatus(
    s: InsertLine["status"] | null | undefined,
  ): AllowedStatus {
    const v = (s ?? "awaiting") as string;
    return (ALLOWED_STATUS as readonly string[]).includes(v)
      ? (v as AllowedStatus)
      : "awaiting";
  }

  async function addLine() {
    if (!canSave) return;

    // If shopId is missing, we don’t even try — this almost always turns into a 403 anyway.
    if (!shopId) {
      setErr(
        "Missing shopId for this work order. Refresh the page and click “Save & Continue” first so the work order loads its shop context.",
      );
      return;
    }

    setBusy(true);
    setErr(null);

    try {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      const payload: InsertLine = {
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        user_id: user?.id ?? null,
        complaint: complaint.trim() || null,
        cause: cause.trim() || null,
        correction: correction.trim() || null,
        labor_time: labor ? Number(labor) : null,
        status: normalizeStatus(status),
        job_type: normalizeJobType(jobType),

        // IMPORTANT: keep shop_id explicit so all RLS/shop triggers stay deterministic
        shop_id: shopId,
      };

      const { data, error } = await supabase
        .from("work_order_lines")
        .insert(payload)
        .select("id")
        .single();

      if (error) {
        const msg = error.message || "Insert failed";

        if (/(job_type).*check/i.test(msg)) {
          setErr("This job type isn’t allowed by the database. Pick another type.");
        } else if (/status.*check/i.test(msg)) {
          setErr("This status isn’t allowed by the database. Try a different status.");
        } else if (/row-level security/i.test(msg) || /permission/i.test(msg)) {
          setErr(
            `Permission blocked (RLS). workOrderId=${workOrderId} shopId=${shopId}. ${msg}`,
          );
        } else {
          setErr(msg);
        }
        return;
      }

      if (!data?.id) {
        setErr("Insert succeeded but no row was returned. Check PostgREST preferences.");
        return;
      }

      setComplaint("");
      setCause("");
      setCorrection("");
      setLabor("");
      setStatus("awaiting");
      setJobType(defaultJobType ?? null);

      onCreated?.();
      window.dispatchEvent(new CustomEvent("wo:line-added"));
    } catch (e: unknown) {
      const msg = (e as Error)?.message ?? "Failed to add line.";
      setErr(msg);
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 text-sm text-white space-y-4">
      <div className="flex items-center justify-between gap-2">
        <div>
          <h3 className="text-sm font-semibold text-neutral-100">Add job line</h3>
          <p className="text-[11px] text-neutral-400">
            Complaint is required. Cause / correction can be filled in later.
          </p>
        </div>
        <div className="rounded-full border border-neutral-700 bg-neutral-900 px-3 py-1 text-[10px] text-neutral-300">
          Linked to WO:{" "}
          <span className="font-mono">{workOrderId.slice(0, 8)}…</span>
        </div>
      </div>

      <div className="grid gap-3 sm:grid-cols-2">
        <div className="sm:col-span-2 space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Complaint <span className="text-red-400">*</span>
          </label>
          <textarea
            value={complaint}
            onChange={(e) => setComplaint(e.target.value)}
            className="w-full min-h-[60px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="Describe the issue / customer concern"
          />
        </div>

        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Cause</label>
          <textarea
            value={cause}
            onChange={(e) => setCause(e.target.value)}
            className="w-full min-h-[48px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="Root cause (optional)"
          />
        </div>

        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Correction</label>
          <textarea
            value={correction}
            onChange={(e) => setCorrection(e.target.value)}
            className="w-full min-h-[48px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="What to do / repair plan (optional)"
          />
        </div>

        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Labor (hrs)</label>
          <input
            inputMode="decimal"
            value={labor}
            onChange={(e) => setLabor(e.target.value)}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="0.0"
          />
          <p className="text-[10px] text-neutral-500">
            Flat-rate or estimated hours. Leave blank if unknown.
          </p>
        </div>

        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Status</label>
          <select
            value={normalizeStatus(status)}
            onChange={(e) => setStatus(e.target.value as InsertLine["status"])}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
          >
            <option value="awaiting">Awaiting</option>
            <option value="in_progress">In progress</option>
            <option value="on_hold">On hold</option>
            <option value="paused">Paused</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Job type</label>
          <select
            value={jobType ?? ""}
            onChange={(e) => setJobType((e.target.value || null) as WOJobType | null)}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
          >
            <option value="">Unspecified</option>
            <option value="diagnosis">Diagnosis</option>
            <option value="inspection">Inspection</option>
            <option value="maintenance">Maintenance</option>
            <option value="repair">Repair</option>
          </select>
        </div>
      </div>

      {err && (
        <div className="rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">
          {err}
        </div>
      )}

      <div className="flex items-center justify-end gap-2 pt-1">
        <button
          disabled={!canSave || busy}
          onClick={addLine}
          className="btn btn-orange px-4 py-1.5 text-xs font-semibold disabled:opacity-60"
        >
          {busy ? "Adding…" : "Add line to work order"}
        </button>
      </div>
    </div>
  );
}

export default NewWorkOrderLineForm;

==================== FILE: features/work-orders/components/PartsUsedList.tsx ====================

//features/work-orders/components/PartsUsedList.tsx

"use client";

import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

export type PartsUsedListProps = {
  allocations: AllocationRow[];
};

function num(v: unknown): number | null {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : null;
}

function pickQty(a: AllocationRow): number | null {
  // common variants: qty, quantity
  return (
    num((a as any).qty) ??
    num((a as any).quantity) ??
    null
  );
}

function pickUnitPrice(a: AllocationRow): number | null {
  // Prefer SELL/unit if present; fall back to cost/unit
  return (
    num((a as any).sell_price) ??
    num((a as any).unit_price) ??
    num((a as any).price) ??
    num((a as any).quoted_price) ??
    num((a as any).unit_cost) ??
    null
  );
}

function pickLabel(a: AllocationRow): string {
  const fromJoin = a.parts?.name ?? null;

  const fallback =
    (a as any).description ??
    (a as any).part_name ??
    (a as any).name ??
    null;

  return String(fromJoin ?? fallback ?? "Part");
}

export function PartsUsedList({ allocations }: PartsUsedListProps): JSX.Element {
  if (!allocations.length) {
    return <div className="text-[11px] text-neutral-500">No parts used yet.</div>;
  }

  return (
    <ul className="mt-1 divide-y divide-neutral-800 rounded border border-neutral-800 text-sm">
      {allocations.map((a) => {
        const label = pickLabel(a);

        const locShort = (a as any).location_id
          ? String((a as any).location_id).slice(0, 6)
          : "-";

        const qty = pickQty(a);
        const unit = pickUnitPrice(a);

        const line =
          qty != null && unit != null ? qty * unit : null;

        return (
          <li
            key={String((a as any).id)}
            className="flex items-center justify-between bg-neutral-900/70 p-2"
          >
            <div className="min-w-0">
              <div className="truncate text-sm text-white">{label}</div>

              <div className="text-[11px] text-neutral-500">
                loc {locShort}
                {unit != null && (
                  <span className="ml-2">@{unit.toFixed(2)}</span>
                )}
              </div>
            </div>

            <div className="pl-3 text-right text-sm font-semibold text-neutral-100">
              {qty != null ? <span>× {qty}</span> : null}
              {line != null && (
                <div className="text-[11px] text-neutral-300">
                  ${line.toFixed(2)}
                </div>
              )}
            </div>
          </li>
        );
      })}
    </ul>
  );
}

==================== FILE: features/work-orders/components/QuickActions.tsx ====================


import { useRouter } from "next/router";

export default function QuickActions() {
  const router = useRouter();

  const actions = [
    { label: "📸 Diagnose from Photo", path: "/diagnose" },
    { label: "🔍 Run DTC Diagnosis", path: "/dtc-lookup" },
    { label: "🧾 View Work Orders", path: "/work-orders" },
    { label: "📋 Start Inspection", path: "/inspections" },
    { label: "🚘 Add Vehicle", path: "/vehicles" },
  ];

  return (
    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
      {actions.map((action) => (
        <button
          key={action.path}
          onClick={() => router.push(action.path)}
          className="bg-surface text-accent shadow-card rounded-lg p-4 hover:shadow-lg transition"
        >
          {action.label}
        </button>
      ))}
    </div>
  );
}


==================== FILE: features/work-orders/components/RecentWorkOrders.tsx ====================

"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { supabaseBrowser } from "@/features/shared/lib/supabase/client";

type WorkOrder = {
  id: string;
  vehicle_make: string | null;
  vehicle_model: string | null;
  status: string;
  created_at: string;
};

export default function RecentWorkOrders() {
  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);
  const router = useRouter();

  useEffect(() => {
    const fetchWorkOrders = async () => {
      const supabase = supabaseBrowser;

      const { data, error } = await supabase
        .from("work_orders")
        .select("id, vehicle_make, vehicle_model, status, created_at")
        .order("created_at", { ascending: false })
        .limit(3);

      if (!error && data) setWorkOrders(data as WorkOrder[]);
      else if (error) console.error("RecentWorkOrders error:", error.message);
    };

    fetchWorkOrders();
  }, []);

  return (
    <div className="bg-surface text-accent p-6 rounded-md shadow-card mb-8">
      <h2 className="text-lg font-semibold mb-4">Recent Work Orders</h2>
      {workOrders.length === 0 ? (
        <p className="text-muted text-sm">No recent work orders found.</p>
      ) : (
        <ul className="space-y-3">
          {workOrders.map((order) => (
            <li
              key={order.id}
              className="cursor-pointer hover:bg-muted/10 p-3 rounded transition"
              onClick={() => router.push(`/work-orders/${order.id}`)}
            >
              <div className="font-medium">
                {order.vehicle_make} {order.vehicle_model}
              </div>
              <div className="text-sm text-muted">Status: {order.status}</div>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

==================== FILE: features/work-orders/components/SuggestedQuickAdd.tsx ====================

// features/work-orders/components/SuggestedQuickAdd.tsx
"use client";

import { useEffect, useState } from "react";

type Suggestion = {
  name: string;
  laborHours: number | null;
  jobType: "diagnosis" | "repair" | "maintenance" | "tech-suggested";
  notes: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

function asSuggestions(input: unknown): Suggestion[] {
  if (!Array.isArray(input)) return [];
  return input.map((raw: any) => {
    const name =
      typeof raw?.name === "string" && raw.name.trim()
        ? raw.name.trim()
        : "Suggested item";
    const hours = Number(raw?.laborHours);
    const jobType =
      raw?.jobType === "diagnosis" ||
      raw?.jobType === "repair" ||
      raw?.jobType === "maintenance" ||
      raw?.jobType === "tech-suggested"
        ? raw.jobType
        : "maintenance";
    const notes = typeof raw?.notes === "string" ? raw.notes : "";
    return {
      name,
      laborHours: Number.isFinite(hours) ? hours : null,
      jobType,
      notes,
      aiComplaint:
        typeof raw?.aiComplaint === "string" ? raw.aiComplaint : undefined,
      aiCause: typeof raw?.aiCause === "string" ? raw.aiCause : undefined,
      aiCorrection:
        typeof raw?.aiCorrection === "string" ? raw.aiCorrection : undefined,
    };
  });
}

export default function SuggestedQuickAdd(props: {
  jobId: string;
  workOrderId: string;
  vehicleId?: string | null;
  onAdded?: () => void | Promise<void>;
}) {
  const { jobId, workOrderId, vehicleId, onAdded } = props;

  const [loading, setLoading] = useState(false);
  const [adding, setAdding] = useState<string | null>(null);
  const [items, setItems] = useState<Suggestion[]>([]);
  const [error, setError] = useState<string | null>(null);

  async function fetchSuggestions() {
    setLoading(true);
    setError(null);
    try {
      const body: any = { jobId };
      if (vehicleId) {
        // simple string for now – your API already accepts VehicleLite | string | null
        body.vehicleId = vehicleId;
      }

      const res = await fetch("/api/work-orders/suggest-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Failed to load suggestions");
      setItems(asSuggestions(j?.suggestions));
    } catch (e) {
      setError(
        e instanceof Error ? e.message : "Failed to load suggestions",
      );
      setItems([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (jobId) void fetchSuggestions();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [jobId]);

  async function addQuote(s: Suggestion) {
    setAdding(s.name);
    try {
      const res = await fetch("/api/work-orders/quotes/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          items: [
            {
              description: s.name,
              jobType: s.jobType,
              estLaborHours: s.laborHours ?? 0,
              notes: s.notes,
              aiComplaint: s.aiComplaint,
              aiCause: s.aiCause,
              aiCorrection: s.aiCorrection,
            },
          ],
        }),
      });
      if (!res.ok) {
        const j = await res.json().catch(() => ({}));
        throw new Error(j?.error || "Failed to add quote line");
      }

      await onAdded?.();
    } catch (e) {
      alert(e instanceof Error ? e.message : "Failed to add quote line");
    } finally {
      setAdding(null);
    }
  }

  return (
    <div className="rounded border border-neutral-800 bg-neutral-950 p-3">
      <div className="flex items-center justify-between">
        <h3 className="font-semibold text-orange-400">AI Suggestions</h3>
        <button
          onClick={fetchSuggestions}
          disabled={loading}
          className="text-xs px-2 py-1 rounded border border-neutral-700 hover:bg-neutral-800 disabled:opacity-60"
        >
          {loading ? "Thinking…" : "Regenerate"}
        </button>
      </div>

      {error && <p className="mt-2 text-xs text-red-400">{error}</p>}

      <div className="mt-3 grid gap-2 sm:grid-cols-2">
        {items.map((s) => (
          <button
            key={s.name}
            onClick={() => addQuote(s)}
            disabled={adding === s.name}
            className="text-left border border-neutral-800 bg-neutral-900 hover:bg-neutral-800 rounded p-3 disabled:opacity-60"
          >
            <div className="font-medium">{s.name}</div>
            <div className="text-xs text-neutral-400">
              {s.jobType} •{" "}
              {typeof s.laborHours === "number"
                ? s.laborHours.toFixed(1)
                : "—"}
              h
            </div>
            {s.notes && (
              <div className="text-xs text-neutral-500 mt-1">{s.notes}</div>
            )}
          </button>
        ))}

        {!loading && items.length === 0 && (
          <div className="text-xs text-neutral-400">No suggestions yet.</div>
        )}
      </div>
    </div>
  );
}

==================== FILE: features/work-orders/components/TechJobScreen.tsx ====================

// features/work-orders/components/workorders/TechJobScreen.tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import JobQueueCard from "@shared/components/JobQueueCard";

// Use the raw DB row for work_order_lines
type JobLine = Database["public"]["Tables"]["work_order_lines"]["Row"];

export default function TechJobScreen() {
  const supabase = createClientComponentClient<Database>();
  const [jobs, setJobs] = useState<JobLine[]>([]);
  const [activeJobId, setActiveJobId] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const fetchJobs = useCallback(async () => {
    setLoading(true);
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) {
      setJobs([]);
      setLoading(false);
      return;
    }

    // Pull the queue directly with the DB row type
    const { data } = await supabase
      .from("work_order_lines")
      .select("*")
      .or(`assigned_to.eq.${user.id},assigned_to.is.null`)
      .in("status", ["awaiting", "in_progress", "on_hold"])
      .order("created_at", { ascending: true });

    setJobs((data ?? []) as JobLine[]);
    setLoading(false);
  }, [supabase]);

  useEffect(() => {
    void fetchJobs();

    const channel = supabase
      .channel("job-updates")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_order_lines" },
        () => void fetchJobs()
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [fetchJobs, supabase]);

  const handlePunchIn = async (job: JobLine) => {
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return;

    setActiveJobId(job.id ?? null);

    await supabase
      .from("work_order_lines")
      .update({ status: "in_progress", assigned_to: user.id })
      .eq("id", job.id as string);

    void fetchJobs();
  };

  const handlePunchOut = async (job: JobLine) => {
    setActiveJobId(null);

    await supabase
      .from("work_order_lines")
      .update({ status: "awaiting" })
      .eq("id", job.id as string);

    void fetchJobs();
  };

  const renderJobCard = (job: JobLine) => (
    <JobQueueCard
      key={job.id as string}
      job={job}
      isActive={activeJobId === job.id}
      onPunchIn={handlePunchIn}
      onPunchOut={handlePunchOut}
    />
  );

  const activeJob = jobs.find((j) => j.id === activeJobId) ?? null;
  const readyJobs = jobs.filter((j) => j.status === "awaiting" && j.id !== activeJobId);
  const onHoldJobs = jobs.filter((j) => j.status === "on_hold");

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-xl font-bold text-accent">Technician Job Queue</h1>

      {loading && <p className="text-sm text-neutral-500">Loading jobs…</p>}

      {activeJob ? (
        <section>
          <h2 className="text-lg font-semibold mb-2">Current Job</h2>
          {renderJobCard(activeJob)}
        </section>
      ) : (
        <section>
          <h2 className="text-lg font-semibold mb-2">Available Jobs</h2>
          {readyJobs.length > 0 ? readyJobs.map(renderJobCard) : <p>No jobs available.</p>}
        </section>
      )}

      {onHoldJobs.length > 0 && (
        <section>
          <h2 className="text-lg font-semibold mb-2">On Hold</h2>
          {onHoldJobs.map(renderJobCard)}
        </section>
      )}
    </div>
  );
}

==================== FILE: features/work-orders/components/TechPanel.tsx ====================

"use client";

import type { Database } from "@shared/types/types/supabase";

type DB = Database;
export type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
export type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
export type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
export type Customer = DB["public"]["Tables"]["customers"]["Row"];

export default function TechPanel({
  workOrder,
  vehicle,
  customer,
  lines,
}: {
  workOrder: WorkOrder;
  vehicle: Vehicle | null;
  customer: Customer | null;
  lines: WorkOrderLine[];
}) {
  const vehicleText = vehicle
    ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}${
        vehicle.license_plate ? ` (${vehicle.license_plate})` : ""
      }`.trim()
    : "—";

  const customerText = customer
    ? [customer.first_name ?? "", customer.last_name ?? ""]
        .filter(Boolean)
        .join(" ")
        .trim() || "—"
    : "—";

  return (
    <div className="rounded border border-neutral-800 bg-neutral-900 p-4">
      <div className="mb-2 font-semibold text-orange-400">Tech Panel</div>
      <p className="text-sm text-neutral-300">
        Work on{" "}
        <strong>{workOrder.custom_id || workOrder.id.slice(0, 8)}</strong>.{" "}
        Vehicle: {vehicleText} · Customer: {customerText}.
      </p>
      <p className="mt-2 text-sm text-neutral-400">Jobs: {lines.length}</p>

      <div className="mt-3">
        <button
          onClick={() => window.location.reload()}
          className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:border-orange-500"
        >
          Refresh
        </button>
      </div>

      <div className="mt-4 text-xs text-neutral-500">
        Placeholder: wire your existing tech UI (punch, cause/correction, add
        job/quote, AI suggestions, photos) here.
      </div>
    </div>
  );
}

==================== FILE: features/work-orders/components/UsePartButton.tsx ====================

// features/work-orders/components/UsePartButton.tsx
"use client";

import { useState, useTransition } from "react";
import { consumePart } from "@work-orders/lib/parts/consumePart";
import { PartPicker, type PickedPart } from "@parts/components/PartPicker";

function errorMessage(e: unknown): string {
  if (e instanceof Error) return e.message;
  if (typeof e === "string") return e;
  try {
    return JSON.stringify(e);
  } catch {
    return "Failed to use part";
  }
}

function asPositiveNumber(v: unknown): number | null {
  const n = typeof v === "number" ? v : Number(v);
  if (!Number.isFinite(n) || n <= 0) return null;
  return n;
}

function asFiniteNumber(v: unknown): number | null {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : null;
}

export function UsePartButton({
  workOrderLineId,
  onApplied,
  label = "Use Part",
}: {
  workOrderLineId: string;
  onApplied?: () => void;
  label?: string;
}) {
  const [open, setOpen] = useState(false);
  const [pending, start] = useTransition();
  const [err, setErr] = useState<string | null>(null);

  const handlePick = (sel: PickedPart) => {
    setErr(null);

    start(async () => {
      try {
        const partId =
          typeof sel.part_id === "string" && sel.part_id.length ? sel.part_id : null;

        const qty = asPositiveNumber(sel.qty);

        const locationId =
          typeof sel.location_id === "string" && sel.location_id.length
            ? sel.location_id
            : undefined;

        const unitCostRaw = asFiniteNumber(sel.unit_cost);
        const unitCost = typeof unitCostRaw === "number" ? unitCostRaw : undefined;

        const availability =
          typeof sel.availability === "string" ? sel.availability : null;

        if (!partId || !qty) {
          setErr("Pick a part and quantity first.");
          return;
        }

        await consumePart({
          work_order_line_id: workOrderLineId,
          part_id: partId,
          qty,
          location_id: locationId,
          ...(typeof unitCost === "number" ? { unit_cost: unitCost } : {}),
          availability,
        });

        onApplied?.();
      } catch (e: unknown) {
        const m = errorMessage(e) || "Failed to use part";
        setErr(m.replace(/^.*error:\s*/i, ""));
      }
    });
  };

  return (
    <>
      <button
        onClick={(e) => {
          e.stopPropagation();
          setOpen(true);
        }}
        className="rounded-xl bg-neutral-900 px-3 py-2 text-white disabled:opacity-60"
        disabled={pending}
        title="Use/consume a part on this job line"
        type="button"
      >
        {pending ? "Applying…" : label}
      </button>

      {err && <span className="ml-2 text-xs text-red-500">{err}</span>}

      <PartPicker open={open} onClose={() => setOpen(false)} onPick={handlePick} />
    </>
  );
}

==================== FILE: features/work-orders/components/WorkOrderAssignedSummary.tsx ====================

// src/features/work-orders/components/WorkOrderAssignedSummary.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Props = {
  workOrderId: string;
};

type AssignmentRow = {
  technician_id: string | null;
  full_name: string | null;
  role: string | null;
  has_active: boolean | null;
};

export function WorkOrderAssignedSummary({ workOrderId }: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(true);
  const [rows, setRows] = useState<AssignmentRow[]>([]);

  useEffect(() => {
    if (!workOrderId) return;

    let cancelled = false;

    const load = async () => {
      setLoading(true);
      try {
        const { data, error } = await supabase.rpc(
          "get_work_order_assignments",
          { p_work_order_id: workOrderId },
        );

        if (error) {
          // eslint-disable-next-line no-console
          console.error("[WorkOrderAssignedSummary] rpc error:", error);
          if (!cancelled) {
            setRows([]);
          }
          return;
        }

        if (!cancelled) {
          setRows((data as AssignmentRow[] | null) ?? []);
        }
      } catch (e) {
        // eslint-disable-next-line no-console
        console.error("[WorkOrderAssignedSummary] unexpected error:", e);
        if (!cancelled) setRows([]);
      } finally {
        if (!cancelled) setLoading(false);
      }
    };

    void load();

    return () => {
      cancelled = true;
    };
  }, [supabase, workOrderId]);

  // ---------- derived values ----------

  const hasActive = useMemo(
    () => rows.some((r) => !!r.has_active),
    [rows],
  );

  const firstTechLabel = useMemo(() => {
    if (!rows.length) return null;
    const first = rows[0];
    const full = first.full_name || "Assigned tech";
    const firstName = full.split(" ")[0] || full;
    return firstName;
  }, [rows]);

  const extraCount = rows.length > 1 ? rows.length - 1 : 0;

  // ---------- Render states ----------

  if (loading) {
    return (
      <span className="inline-flex animate-pulse items-center rounded-full border border-neutral-700 bg-neutral-900/70 px-2.5 py-0.5 text-[0.7rem] text-neutral-400">
        Loading…
      </span>
    );
  }

  if (!rows.length || !firstTechLabel) {
    return (
      <span className="inline-flex items-center rounded-full border border-neutral-700 bg-neutral-950/80 px-2.5 py-0.5 text-[0.7rem] text-neutral-400">
        Unassigned
      </span>
    );
  }

  const base =
    "inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-[0.7rem] font-medium";
  const activeCls =
    "border-emerald-400/80 bg-emerald-500/15 text-emerald-100 shadow-[0_0_18px_rgba(16,185,129,0.8)]";
  const assignedCls =
    "border-amber-400/80 bg-amber-500/15 text-amber-50";

  return (
    <span
      className={`${base} ${hasActive ? activeCls : assignedCls}`}
      title={
        hasActive
          ? "At least one job line is currently punched in."
          : "Jobs assigned to technician(s) on this work order."
      }
    >
      {hasActive && (
        <span className="relative mr-0.5 inline-flex h-2 w-2 items-center justify-center">
          <span className="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400/60" />
          <span className="relative inline-flex h-1.5 w-1.5 rounded-full bg-emerald-300" />
        </span>
      )}
      <span>{firstTechLabel}</span>
      {extraCount > 0 && (
        <span className="text-[0.65rem] text-neutral-100/80">
          +{extraCount} more
        </span>
      )}
    </span>
  );
}

==================== FILE: features/work-orders/components/WorkOrderCard.tsx ====================

"use client";

import { format } from "date-fns";
import Link from "next/link";
import type { Database } from "@shared/types/types/supabase";

type WorkOrderLine = Database["public"]["Tables"]["work_order_lines"]["Row"] & {
  vehicle?: {
    year?: number | null;
    make?: string | null;
    model?: string | null;
  } | null;
  assigned_to?: {
    full_name?: string | null;
  } | null;
};

// restrict keys so indexing is safe
type StatusKey = "awaiting" | "in_progress" | "on_hold" | "completed";

const statusStyles: Record<StatusKey, { tag: string; bar: string }> = {
  awaiting:   { tag: "bg-blue-100 text-blue-800",   bar: "bg-blue-500"   },
  in_progress:{ tag: "bg-orange-100 text-orange-800", bar: "bg-orange-500" },
  on_hold:    { tag: "bg-yellow-100 text-yellow-800", bar: "bg-yellow-500" },
  completed:  { tag: "bg-green-100 text-green-800",  bar: "bg-green-500"  },
};

interface WorkOrderCardProps {
  job: WorkOrderLine;
}

export default function WorkOrderCard({ job }: WorkOrderCardProps) {
  const {
    status,
    created_at,
    vehicle,
    assigned_to,
    complaint,
    work_order_id,
  } = job;

  const vehicleInfo =
    [vehicle?.year, vehicle?.make, vehicle?.model].filter(Boolean).join(" ") ||
    "Unknown vehicle";

  // coalesce nullable status to a known key (and guard)
  const safeStatus = (status ?? "awaiting") as StatusKey;
  const styles = statusStyles[safeStatus] ?? {
    tag: "bg-gray-100 text-gray-800",
    bar: "bg-gray-400",
  };

  const created = created_at ? new Date(created_at) : null;

  return (
    <Link href={`/work-orders/view/${work_order_id ?? ""}`} className="block">
      <div className="flex border rounded overflow-hidden shadow-sm mb-3 bg-white dark:bg-gray-900 hover:shadow-md transition-shadow duration-200">
        <div className={`w-1 ${styles.bar}`} />
        <div className="flex-1 p-4">
          <div className="flex justify-between items-center mb-2">
            <span className={`text-xs font-medium px-2 py-1 rounded ${styles.tag}`}>
              {safeStatus.replace("_", " ")}
            </span>
            <span className="text-xs text-gray-500 dark:text-gray-400">
              {created ? format(created, "PPp") : "—"}
            </span>
          </div>
          <p className="text-sm font-semibold">{vehicleInfo}</p>
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Complaint: {complaint ?? "N/A"}
          </p>
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Assigned: {assigned_to?.full_name ?? "Unassigned"}
          </p>
        </div>
      </div>
    </Link>
  );
}

==================== FILE: features/work-orders/components/WorkOrderEditorPage.tsx ====================

"use client";

import { useEffect, useState } from "react";
import { supabaseBrowser } from "@/features/shared/lib/supabase/client";
import useVehicleInfo from "@shared/hooks/useVehicleInfo";
import { useUser } from "@auth/hooks/useUser";
import WorkOrderLineEditor from "@work-orders/components/WorkOrderLineEditor";

type MenuItem = {
  id: string;
  complaint: string | null;
  cause?: string | null;
  correction?: string | null;
  labor_time?: number | null;
  tools?: string | null;
};

type WorkOrderLine = {
  id?: string;
  complaint: string;
  cause?: string;
  correction?: string;
  labor_time?: number;
  tools?: string;
  status?: "unassigned" | "assigned" | "in_progress" | "on_hold" | "completed" | "awaiting";
  hold_reason?: "parts" | "authorization" | "diagnosis_pending" | "other" | "";
};

export default function WorkOrderEditorPage() {
  const supabase = supabaseBrowser;
  const { vehicleInfo } = useVehicleInfo();
  const { user } = useUser();

  const [menuItems, setMenuItems] = useState<MenuItem[]>([]);
  const [lines, setLines] = useState<WorkOrderLine[]>([]);
  const [query, setQuery] = useState("");
  const [filtered, setFiltered] = useState<MenuItem[]>([]);

  useEffect(() => {
    const fetchMenuItems = async () => {
      if (user && vehicleInfo?.id) {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .eq("vehicle_id", vehicleInfo.id);

        if (!error && data) setMenuItems(data as unknown as MenuItem[]);
      }
    };
    void fetchMenuItems();
  }, [user, vehicleInfo?.id, supabase]);

  useEffect(() => {
    if (query.trim().length > 1) {
      const q = query.toLowerCase();
      setFiltered(menuItems.filter((item) => (item.complaint ?? "").toLowerCase().includes(q)));
    } else {
      setFiltered([]);
    }
  }, [query, menuItems]);

  const handleSuggestionClick = (item: MenuItem) => {
    setLines((prev) => [
      ...prev,
      {
        complaint: item.complaint ?? "",
        cause: item.cause ?? "",
        correction: item.correction ?? "",
        labor_time: item.labor_time ?? 0,
        tools: item.tools ?? "",
        status: "awaiting",
      },
    ]);
    setQuery("");
    setFiltered([]);
  };

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-2">Create Work Order</h1>

      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Enter complaint (e.g. B for brakes)"
        className="w-full px-3 py-2 border rounded shadow mb-2"
      />

      {filtered.length > 0 && (
        <ul className="bg-white border shadow rounded mb-4 max-h-40 overflow-y-auto">
          {filtered.map((item) => (
            <li
              key={item.id}
              onClick={() => handleSuggestionClick(item)}
              className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
            >
              {(item.complaint ?? "Untitled")} — {item.labor_time ?? 0} hr
            </li>
          ))}
        </ul>
      )}

      <div className="space-y-3">
        {lines.map((line, index) => (
          <WorkOrderLineEditor
            key={`${line.id ?? "new"}-${index}`}
            line={line}
            onUpdate$={(updatedLine: WorkOrderLine) => {
              const updated = [...lines];
              updated[index] = updatedLine;
              setLines(updated);
            }}
            onDelete$={() => {
              const updated = [...lines];
              updated.splice(index, 1);
              setLines(updated);
            }}
          />
        ))}
      </div>
    </div>
  );
}

==================== FILE: features/work-orders/components/WorkOrderInvoiceDownloadButton.tsx ====================

// features/work-orders/components/WorkOrderInvoiceDownloadButton.tsx
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import type { RepairLine } from "@ai/lib/parseRepairOutput";

type Props = {
  workOrderId: string;

  // kept for signature parity (server route generates PDF from DB)
  lines?: RepairLine[];
  summary?: string;
  vehicleInfo?: { year?: string; make?: string; model?: string; vin?: string };
  customerInfo?: { name?: string; phone?: string; email?: string };

  autoTrigger?: boolean;
  className?: string;

  // ✅ New: choose where the button goes
  mode?: "pdf" | "preview"; // default "pdf"

  // ✅ PDF behavior
  openInNewTab?: boolean; // default true
  forceDownload?: boolean; // default false (uses ?download=1)
};

export function WorkOrderInvoiceDownloadButton({
  workOrderId,
  autoTrigger = false,
  className,
  mode = "pdf",
  openInNewTab = true,
  forceDownload = false,
}: Props): JSX.Element {
  const [busy, setBusy] = useState(false);

  const urlToOpen = useMemo(() => {
    if (mode === "preview") return `/work-orders/${workOrderId}/invoice`;

    const base = `/api/work-orders/${workOrderId}/invoice-pdf`;
    return forceDownload ? `${base}?download=1` : base;
  }, [mode, workOrderId, forceDownload]);

  const open = useCallback(async (): Promise<void> => {
    if (busy) return;
    if (!workOrderId) return;

    setBusy(true);
    try {
      if (openInNewTab) {
        window.open(urlToOpen, "_blank", "noopener,noreferrer");
        return;
      }
      window.location.href = urlToOpen;
    } finally {
      setBusy(false);
    }
  }, [busy, workOrderId, openInNewTab, urlToOpen]);

  useEffect(() => {
    if (!autoTrigger) return;
    if (!workOrderId) return;
    queueMicrotask(() => void open());
  }, [autoTrigger, workOrderId, open]);

  const label =
    mode === "preview"
      ? "Open invoice preview"
      : openInNewTab
        ? "Open invoice PDF"
        : "View invoice PDF";

  return (
    <button
      type="button"
      onClick={() => void open()}
      disabled={!workOrderId || busy}
      className={
        className ??
        "rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-4 py-2 text-xs font-semibold uppercase tracking-[0.18em] text-black hover:brightness-110 disabled:opacity-60"
      }
    >
      {busy ? "Opening…" : label}
    </button>
  );
}

==================== FILE: features/work-orders/components/WorkOrderInvoicePDF.tsx ====================

// features/work-orders/components/WorkOrderInvoicePDF.tsx
"use client";

import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Image,
} from "@react-pdf/renderer";
import type { RepairLine } from "@ai/lib/parseRepairOutput";

type VehicleInfo = {
  year?: string;
  make?: string;
  model?: string;
  vin?: string;

  license_plate?: string;
  unit_number?: string;
  mileage?: string;
  color?: string;
  engine_hours?: string;
};

type CustomerInfo = {
  name?: string;
  phone?: string;
  email?: string;

  business_name?: string;
  street?: string;
  city?: string;
  province?: string;
  postal_code?: string;
};

type ShopInfo = {
  name?: string;
  phone_number?: string;
  email?: string;
  street?: string;
  city?: string;
  province?: string;
  postal_code?: string;

  // ✅ optional (if fetched) so we can show labor as $
  labor_rate?: number | string;
};

type Currency = "usd" | "cad";

type Props = {
  workOrderId: string;
  vehicleInfo?: VehicleInfo;
  customerInfo?: CustomerInfo;
  shopInfo?: ShopInfo;
  lines: RepairLine[];
  summary?: string;
  signatureImage?: string;

  // ✅ optional totals/currency (ideal: pass from work_orders row)
  currency?: Currency;
  laborTotal?: number;
  partsTotal?: number;
  taxTotal?: number;
  invoiceTotal?: number;
};

const FOOTER_H = 40;

const styles = StyleSheet.create({
  page: {
    paddingTop: 28,
    paddingHorizontal: 32,

    // ✅ critical: leave room for fixed footer + PDF viewer UI
    paddingBottom: 28 + FOOTER_H + 28,

    fontSize: 11,
    fontFamily: "Helvetica",
    lineHeight: 1.4,
    color: "#0a0a0a",
  },

  header: {
    marginBottom: 14,
    paddingBottom: 10,
    borderBottomWidth: 1,
    borderBottomColor: "#ddd",
    borderBottomStyle: "solid",
  },

  headerTop: { flexDirection: "row", justifyContent: "space-between", gap: 12 },
  shopBlock: { flexGrow: 1 },
  shopName: { fontSize: 14, fontWeight: 700, color: "#111" },
  shopLine: { fontSize: 9.5, color: "#333", marginTop: 1 },
  invoiceBlock: { alignItems: "flex-end" },
  invoiceTitle: { fontSize: 18, fontWeight: 700, color: "#111" },
  invoiceMeta: { marginTop: 2, fontSize: 10, color: "#444" },

  grid2: { flexDirection: "row", gap: 12, marginTop: 10 },
  box: {
    flexGrow: 1,
    borderWidth: 1,
    borderColor: "#e1e1e1",
    borderStyle: "solid",
    borderRadius: 6,
    padding: 10,
  },
  boxTitle: { fontSize: 10, fontWeight: 700, marginBottom: 6, color: "#111" },
  row: { flexDirection: "row", justifyContent: "space-between", gap: 10, marginBottom: 2 },
  label: { fontSize: 10, color: "#333" },
  value: { fontSize: 10, color: "#111", maxWidth: 260 },

  section: { marginTop: 12 },
  sectionTitle: { fontSize: 11, fontWeight: 700, marginBottom: 6 },
  paragraph: { fontSize: 10, color: "#222" },

  lineItem: {
    borderWidth: 1,
    borderColor: "#efefef",
    borderStyle: "solid",
    borderRadius: 6,
    padding: 10,
    marginBottom: 8,
  },
  bullet: { fontSize: 10, marginBottom: 2, color: "#111" },
  subText: { fontSize: 9.5, color: "#333" },

  partsWrap: {
    marginTop: 6,
    paddingTop: 6,
    borderTopWidth: 1,
    borderTopColor: "#ededed",
    borderTopStyle: "solid",
  },
  partsTitle: { fontSize: 9.5, fontWeight: 700, color: "#111", marginBottom: 4 },
  partsHeader: {
    flexDirection: "row",
    gap: 8,
    paddingBottom: 3,
    borderBottomWidth: 1,
    borderBottomColor: "#f0f0f0",
    borderBottomStyle: "solid",
    marginBottom: 3,
  },
  partsRow: { flexDirection: "row", gap: 8, marginBottom: 2 },
  colQty: { width: 32, fontSize: 9.5, color: "#111" },
  colPart: { flexGrow: 1, fontSize: 9.5, color: "#111" },
  colMoney: { width: 72, fontSize: 9.5, color: "#111", textAlign: "right" },

  totalsBox: {
    marginTop: 10,
    borderWidth: 1,
    borderColor: "#e6e6e6",
    borderStyle: "solid",
    borderRadius: 6,
    padding: 10,
    alignSelf: "flex-end",
    width: 260,
  },
  totalsTitle: { fontSize: 10, fontWeight: 700, marginBottom: 6, color: "#111" },
  totalsRow: { flexDirection: "row", justifyContent: "space-between", marginBottom: 2 },
  totalsLabel: { fontSize: 10, color: "#333" },
  totalsValue: { fontSize: 10, color: "#111" },
  totalsDivider: {
    marginTop: 6,
    borderTopWidth: 1,
    borderTopColor: "#e8e8e8",
    borderTopStyle: "solid",
    paddingTop: 6,
  },
  totalsGrand: { fontSize: 11, fontWeight: 700, color: "#111" },

  signatureWrap: {
    marginTop: 18,
    borderTopWidth: 1,
    borderTopColor: "#e1e1e1",
    borderTopStyle: "solid",
    paddingTop: 10,
    alignItems: "center",
  },
  signatureLabel: { fontSize: 10, marginBottom: 6, color: "#111", fontWeight: 700 },
  signatureImage: {
    width: 220,
    height: 90,
    borderWidth: 1,
    borderColor: "#cfcfcf",
    borderStyle: "solid",
    borderRadius: 6,
    objectFit: "contain",
  },

  footer: {
    position: "absolute",
    left: 32,
    right: 32,
    bottom: 14,
    borderTopWidth: 1,
    borderTopColor: "#e8e8e8",
    borderTopStyle: "solid",
    paddingTop: 8,
    flexDirection: "row",
    justifyContent: "space-between",
  },
  footerText: { fontSize: 9, color: "#666" },
});

function safeStr(v: unknown): string {
  if (typeof v === "string") return v;
  if (typeof v === "number") return String(v);
  return "";
}

function compactJoin(parts: Array<string | undefined>): string {
  return parts
    .map((p) => (p ?? "").trim())
    .filter((p) => p.length > 0)
    .join(" ");
}

function compactCsv(parts: Array<string | undefined>): string {
  return parts
    .map((p) => (p ?? "").trim())
    .filter((p) => p.length > 0)
    .join(", ");
}

function fmtVehicle(v?: VehicleInfo): string {
  const year = safeStr(v?.year).trim();
  const make = safeStr(v?.make).trim();
  const model = safeStr(v?.model).trim();
  const parts = [year, make, model].filter((p) => p.length > 0);
  return parts.length > 0 ? parts.join(" ") : "—";
}

function fmtVin(v?: VehicleInfo): string {
  const vin = safeStr(v?.vin).trim();
  return vin.length > 0 ? vin : "—";
}

function fmtCustomerAddress(c?: CustomerInfo): string {
  const street = safeStr(c?.street).trim();
  const city = safeStr(c?.city).trim();
  const prov = safeStr(c?.province).trim();
  const postal = safeStr(c?.postal_code).trim();

  const line1 = street.length ? street : "";
  const line2 = compactCsv([city || undefined, prov || undefined, postal || undefined]);

  const out = compactJoin([line1 || undefined, line2 || undefined]);
  return out.length ? out : "—";
}

function fmtShopAddress(s?: ShopInfo): string {
  const street = safeStr(s?.street).trim();
  const city = safeStr(s?.city).trim();
  const prov = safeStr(s?.province).trim();
  const postal = safeStr(s?.postal_code).trim();

  const line1 = street.length ? street : "";
  const line2 = compactCsv([city || undefined, prov || undefined, postal || undefined]);

  const out = compactJoin([line1 || undefined, line2 || undefined]);
  return out.length ? out : "—";
}

type RepairLineFields = {
  complaint?: string;
  cause?: string;
  correction?: string;
  labor_time?: string | number;
};

function isRecord(x: unknown): x is Record<string, unknown> {
  return typeof x === "object" && x !== null;
}

function getRepairLineField(line: RepairLine, key: keyof RepairLineFields): string {
  const obj = line as unknown;
  if (!isRecord(obj)) return "—";
  const v = obj[key];
  const s = safeStr(v).trim();
  return s.length ? s : "—";
}

function parseNum(v: unknown): number | null {
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (typeof v === "string") {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

function fmtMoney(amount: number, currency: Currency): string {
  try {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: currency.toUpperCase(),
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    }).format(amount);
  } catch {
    const sign = currency === "cad" ? "CA$" : "$";
    return `${sign}${amount.toFixed(2)}`;
  }
}

type LinePart = { qty: number; name: string; unitPrice: number; total: number };

function extractLineParts(line: RepairLine): LinePart[] {
  const raw = line as unknown;
  if (!isRecord(raw)) return [];

  const candidates: unknown[] = [
    raw["parts"],
    raw["partLines"],
    raw["part_lines"],
    raw["line_parts"],
    raw["lineParts"],
  ];

  const arr = candidates.find((x) => Array.isArray(x));
  if (!Array.isArray(arr)) return [];

  const out: LinePart[] = [];
  for (const p of arr) {
    if (!isRecord(p)) continue;

    const qty = parseNum(p["qty"] ?? p["quantity"]) ?? 1;
    const unit = parseNum(p["unit_price"] ?? p["unitPrice"] ?? p["price"]) ?? 0;
    const total =
      parseNum(p["total"] ?? p["line_total"] ?? p["lineTotal"]) ?? unit * qty;

    const name =
      safeStr(p["name"] ?? p["part_name"] ?? p["description"] ?? p["sku"]).trim();

    if (!name) continue;

    out.push({
      qty: Number.isFinite(qty) && qty > 0 ? qty : 1,
      name,
      unitPrice: Number.isFinite(unit) ? unit : 0,
      total: Number.isFinite(total) ? total : 0,
    });
  }

  return out;
}

export function WorkOrderInvoicePDF({
  workOrderId,
  vehicleInfo,
  customerInfo,
  shopInfo,
  lines,
  summary,
  signatureImage,
  currency = "usd",
  laborTotal,
  partsTotal,
  taxTotal,
  invoiceTotal,
}: Props): JSX.Element {
  const customerName = safeStr(customerInfo?.name).trim() || "—";
  const customerPhone = safeStr(customerInfo?.phone).trim() || "—";
  const customerEmail = safeStr(customerInfo?.email).trim() || "—";
  const customerBusiness = safeStr(customerInfo?.business_name).trim() || "—";
  const customerAddress = fmtCustomerAddress(customerInfo);

  const shopName = safeStr(shopInfo?.name).trim() || "ProFixIQ";
  const shopPhone = safeStr(shopInfo?.phone_number).trim();
  const shopEmail = safeStr(shopInfo?.email).trim();
  const shopAddress = fmtShopAddress(shopInfo);

  const plate = safeStr(vehicleInfo?.license_plate).trim() || "—";
  const unit = safeStr(vehicleInfo?.unit_number).trim() || "—";
  const mileage = safeStr(vehicleInfo?.mileage).trim() || "—";
  const color = safeStr(vehicleInfo?.color).trim() || "—";
  const engineHours = safeStr(vehicleInfo?.engine_hours).trim() || "—";

  const sig =
    typeof signatureImage === "string" && signatureImage.trim().length > 0
      ? signatureImage.trim()
      : null;

  const generatedOn = new Date().toLocaleDateString();

  const laborRate = parseNum(shopInfo?.labor_rate) ?? null;

  // best-effort derive totals if not passed
  let derivedLabor = 0;
  let derivedParts = 0;

  for (const l of lines ?? []) {
    const hrs = parseNum((l as unknown as Record<string, unknown>)?.["labor_time"]) ?? 0;
    if (laborRate !== null) derivedLabor += Math.max(0, hrs) * laborRate;

    const parts = extractLineParts(l);
    for (const p of parts) derivedParts += p.total;
  }

  const safeLaborTotal =
    typeof laborTotal === "number" && Number.isFinite(laborTotal)
      ? laborTotal
      : laborRate !== null
        ? derivedLabor
        : 0;

  const safePartsTotal =
    typeof partsTotal === "number" && Number.isFinite(partsTotal)
      ? partsTotal
      : derivedParts;

  const safeTaxTotal =
    typeof taxTotal === "number" && Number.isFinite(taxTotal) ? taxTotal : 0;

  const safeSubtotal = safeLaborTotal + safePartsTotal;

  const safeInvoiceTotal =
    typeof invoiceTotal === "number" && Number.isFinite(invoiceTotal) && invoiceTotal > 0
      ? invoiceTotal
      : safeSubtotal + safeTaxTotal;

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        <View style={styles.header}>
          <View style={styles.headerTop}>
            <View style={styles.shopBlock}>
              <Text style={styles.shopName}>{shopName}</Text>
              <Text style={styles.shopLine}>{shopAddress}</Text>
              {shopPhone.length || shopEmail.length ? (
                <Text style={styles.shopLine}>
                  {compactCsv([shopPhone || undefined, shopEmail || undefined])}
                </Text>
              ) : null}
            </View>

            <View style={styles.invoiceBlock}>
              <Text style={styles.invoiceTitle}>INVOICE</Text>
              <Text style={styles.invoiceMeta}>Work Order #{workOrderId}</Text>
              <Text style={styles.invoiceMeta}>Generated {generatedOn}</Text>
            </View>
          </View>

          <View style={styles.grid2}>
            <View style={styles.box}>
              <Text style={styles.boxTitle}>Customer</Text>

              <View style={styles.row}>
                <Text style={styles.label}>Name</Text>
                <Text style={styles.value}>{customerName}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Business</Text>
                <Text style={styles.value}>{customerBusiness}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Phone</Text>
                <Text style={styles.value}>{customerPhone}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Email</Text>
                <Text style={styles.value}>{customerEmail}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Address</Text>
                <Text style={styles.value}>{customerAddress}</Text>
              </View>
            </View>

            <View style={styles.box}>
              <Text style={styles.boxTitle}>Vehicle</Text>

              <View style={styles.row}>
                <Text style={styles.label}>Vehicle</Text>
                <Text style={styles.value}>{fmtVehicle(vehicleInfo)}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>VIN</Text>
                <Text style={styles.value}>{fmtVin(vehicleInfo)}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Plate</Text>
                <Text style={styles.value}>{plate}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Unit #</Text>
                <Text style={styles.value}>{unit}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Mileage</Text>
                <Text style={styles.value}>{mileage}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Color</Text>
                <Text style={styles.value}>{color}</Text>
              </View>

              <View style={styles.row}>
                <Text style={styles.label}>Engine Hours</Text>
                <Text style={styles.value}>{engineHours}</Text>
              </View>
            </View>
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Repair Summary</Text>
          <Text style={styles.paragraph}>
            {typeof summary === "string" && summary.trim().length > 0 ? summary.trim() : "—"}
          </Text>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Line Items</Text>

          {(lines ?? []).length === 0 ? (
            <Text style={styles.paragraph}>—</Text>
          ) : (
            (lines ?? []).map((line, idx) => {
              const complaint = getRepairLineField(line, "complaint");
              const cause = getRepairLineField(line, "cause");
              const correction = getRepairLineField(line, "correction");

              const hrs = parseNum((line as unknown as Record<string, unknown>)?.["labor_time"]) ?? 0;
              const lineLabor = laborRate !== null ? Math.max(0, hrs) * laborRate : 0;

              const parts = extractLineParts(line);
              const linePartsTotal = parts.reduce((a, p) => a + p.total, 0);

              return (
                <View key={`line-${idx}`} style={styles.lineItem}>
                  <Text style={styles.bullet}>#{idx + 1} Complaint: {complaint}</Text>
                  <Text style={styles.subText}>Cause: {cause}</Text>
                  <Text style={styles.subText}>Correction: {correction}</Text>

                  {laborRate !== null ? (
                    <Text style={styles.subText}>
                      Labor: {fmtMoney(lineLabor, currency)}{" "}
                      <Text style={{ color: "#666" }}>
                        ({hrs.toFixed(1)} hrs @ {fmtMoney(laborRate, currency)}/hr)
                      </Text>
                    </Text>
                  ) : (
                    <Text style={styles.subText}>Labor time: {hrs.toFixed(1)} hrs</Text>
                  )}

                  {parts.length > 0 ? (
                    <View style={styles.partsWrap}>
                      <Text style={styles.partsTitle}>
                        Parts (Line Total: {fmtMoney(linePartsTotal, currency)})
                      </Text>

                      <View style={styles.partsHeader}>
                        <Text style={styles.colQty}>Qty</Text>
                        <Text style={styles.colPart}>Part</Text>
                        <Text style={styles.colMoney}>Unit</Text>
                        <Text style={styles.colMoney}>Total</Text>
                      </View>

                      {parts.slice(0, 12).map((p, i2) => (
                        <View key={`p-${idx}-${i2}`} style={styles.partsRow}>
                          <Text style={styles.colQty}>{String(p.qty)}</Text>
                          <Text style={styles.colPart}>{p.name}</Text>
                          <Text style={styles.colMoney}>{fmtMoney(p.unitPrice, currency)}</Text>
                          <Text style={styles.colMoney}>{fmtMoney(p.total, currency)}</Text>
                        </View>
                      ))}

                      {parts.length > 12 ? (
                        <Text style={{ fontSize: 9, color: "#666", marginTop: 2 }}>
                          …and {parts.length - 12} more
                        </Text>
                      ) : null}
                    </View>
                  ) : null}
                </View>
              );
            })
          )}

          <View style={styles.totalsBox}>
            <Text style={styles.totalsTitle}>Totals</Text>

            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>Labor</Text>
              <Text style={styles.totalsValue}>{fmtMoney(safeLaborTotal, currency)}</Text>
            </View>

            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>Parts</Text>
              <Text style={styles.totalsValue}>{fmtMoney(safePartsTotal, currency)}</Text>
            </View>

            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>Subtotal</Text>
              <Text style={styles.totalsValue}>{fmtMoney(safeSubtotal, currency)}</Text>
            </View>

            {safeTaxTotal > 0 ? (
              <View style={styles.totalsRow}>
                <Text style={styles.totalsLabel}>Tax</Text>
                <Text style={styles.totalsValue}>{fmtMoney(safeTaxTotal, currency)}</Text>
              </View>
            ) : null}

            <View style={styles.totalsDivider}>
              <View style={styles.totalsRow}>
                <Text style={styles.totalsGrand}>Total</Text>
                <Text style={styles.totalsGrand}>{fmtMoney(safeInvoiceTotal, currency)}</Text>
              </View>
            </View>
          </View>
        </View>

        {sig ? (
          <View style={styles.signatureWrap}>
            <Text style={styles.signatureLabel}>Customer Signature</Text>
            {/* eslint-disable-next-line jsx-a11y/alt-text */}
            <Image src={sig} style={styles.signatureImage} />
          </View>
        ) : null}

        <View style={styles.footer} fixed>
          <Text style={styles.footerText}>{shopName}</Text>
          <Text style={styles.footerText}>Work Order #{workOrderId}</Text>
        </View>
      </Page>
    </Document>
  );
}

==================== FILE: features/work-orders/components/WorkOrderLineEditor.tsx ====================

"use client";

import { useState, useEffect } from "react";

export type WorkOrderLine = {
  id?: string;
  complaint: string;
  cause?: string;
  correction?: string;
  labor_time?: number;
  status?: "unassigned" | "assigned" | "in_progress" | "on_hold" | "completed" | "awaiting";
  hold_reason?: "parts" | "authorization" | "diagnosis_pending" | "other" | "";
  tools?: string;
};

export type WorkOrderLineEditorProps = {
  line: WorkOrderLine;
  /** Rename per Next.js serializable-props rule */
  onUpdate$?: (line: WorkOrderLine) => void;
  onDelete$?: () => void;
};

export default function WorkOrderLineEditor({
  line,
  onUpdate$,
  onDelete$,
}: WorkOrderLineEditorProps) {
  const [localLine, setLocalLine] = useState<WorkOrderLine>(line);

  useEffect(() => {
    onUpdate$?.(localLine);
  }, [localLine, onUpdate$]);

  return (
    <div className="bg-white border rounded-lg p-4 mb-4 shadow-sm">
      <label className="block text-sm font-semibold mb-1 text-gray-700">Complaint</label>
      <input
        value={localLine.complaint}
        onChange={(e) => setLocalLine({ ...localLine, complaint: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Cause</label>
      <input
        value={localLine.cause || ""}
        onChange={(e) => setLocalLine({ ...localLine, cause: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Correction</label>
      <input
        value={localLine.correction || ""}
        onChange={(e) => setLocalLine({ ...localLine, correction: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Labor Time (hrs)</label>
      <input
        type="number"
        value={localLine.labor_time ?? ""}
        onChange={(e) => {
          const num = e.target.value === "" ? undefined : Number(e.target.value);
          setLocalLine({ ...localLine, labor_time: Number.isFinite(num as number) ? (num as number) : undefined });
        }}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Status</label>
      <select
        value={localLine.status || "unassigned"}
        onChange={(e) => setLocalLine({ ...localLine, status: e.target.value as WorkOrderLine["status"] })}
        className="w-full border rounded px-2 py-1 mb-3"
      >
        <option value="unassigned">Unassigned</option>
        <option value="assigned">Assigned</option>
        <option value="awaiting">Awaiting</option>
        <option value="in_progress">In Progress</option>
        <option value="on_hold">On Hold</option>
        <option value="completed">Completed</option>
      </select>

      {localLine.status === "on_hold" && (
        <>
          <label className="block text-sm font-semibold mb-1 text-gray-700">Hold Reason</label>
          <select
            value={localLine.hold_reason || ""}
            onChange={(e) =>
              setLocalLine({ ...localLine, hold_reason: e.target.value as WorkOrderLine["hold_reason"] })
            }
            className="w-full border rounded px-2 py-1 mb-3"
          >
            <option value="">Select Reason</option>
            <option value="parts">Parts Hold</option>
            <option value="authorization">Awaiting Authorization</option>
            <option value="diagnosis_pending">Waiting Diagnosis</option>
            <option value="other">Other</option>
          </select>
        </>
      )}

      {onDelete$ && (
        <button onClick={onDelete$} className="mt-2 text-sm text-red-600 hover:underline">
          Delete Line
        </button>
      )}
    </div>
  );
}


==================== FILE: features/work-orders/components/WorkOrderPDF.tsx ====================

import { Document, Page, Text, View, StyleSheet } from "@react-pdf/renderer";
import { RepairLine } from "@ai/lib/parseRepairOutput";

type Props = {
  vehicleId: string;
  workOrderId: string;
  vehicleInfo?: { year?: string; make?: string; model?: string; vin?: string };
  customerInfo?: { name?: string; phone?: string; email?: string };
  lines: RepairLine[];
  summary?: string;
};

export function WorkOrderPDF({
  workOrderId,
  vehicleInfo,
  customerInfo,
  lines,
  summary,
}: Props) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Shop Branding */}
        <View style={styles.header}>
          <Text style={styles.logo}>ProFixIQ</Text>
          <Text style={styles.subtitle}>Mobile Repair & Diagnostics</Text>
          <Text>📞 (555) 123-4567 | ✉ support@profixiq.com</Text>
          <Text style={styles.invoiceTitle}>Work Order #{workOrderId}</Text>
        </View>

        {/* Customer + Vehicle Info */}
        <View style={styles.infoSection}>
          <View>
            <Text style={styles.label}>Customer Info:</Text>
            <Text>{customerInfo?.name}</Text>
            <Text>{customerInfo?.phone}</Text>
            <Text>{customerInfo?.email}</Text>
          </View>

          <View>
            <Text style={styles.label}>Vehicle Info:</Text>
            <Text>
              {vehicleInfo?.year} {vehicleInfo?.make} {vehicleInfo?.model}
            </Text>
            <Text>VIN: {vehicleInfo?.vin}</Text>
          </View>
        </View>

        {/* Repair Lines */}
        <View style={styles.lineTable}>
          {lines.map((line, idx) => (
            <View key={idx} style={styles.lineRow}>
              <Text style={styles.lineLabel}>Complaint:</Text>
              <Text>{line.complaint}</Text>
              <Text style={styles.lineLabel}>Correction:</Text>
              <Text>{line.correction}</Text>
            </View>
          ))}
        </View>

        {/* Repair Summary */}
        {summary && (
          <View style={styles.section}>
            <Text style={styles.label}>Repair Summary:</Text>
            <Text>{summary}</Text>
          </View>
        )}
      </Page>
    </Document>
  );
}

const styles = StyleSheet.create({
  page: { padding: 30, fontSize: 12 },
  header: {
    textAlign: "center",
    marginBottom: 20,
  },
  logo: {
    fontSize: 24,
    fontWeight: "bold",
    color: "#1E40AF",
  },
  subtitle: {
    fontSize: 12,
    marginBottom: 4,
  },
  invoiceTitle: {
    fontSize: 14,
    marginTop: 10,
    fontWeight: "bold",
    textDecoration: "underline",
  },
  infoSection: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 20,
  },
  label: { fontWeight: "bold", marginTop: 4 },
  section: { marginVertical: 10 },
  lineTable: { marginTop: 10 },
  lineRow: { marginBottom: 8 },
  lineLabel: { fontWeight: "bold" },
});


==================== FILE: features/work-orders/components/WorkOrderSuggestionsPanel.tsx ====================

// features/work-orders/components/WorkOrderSuggestionsPanel.tsx
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import { toast } from "sonner";

type JobType = "diagnosis" | "repair" | "maintenance" | "tech-suggested";

type RawSuggestion = Record<string, unknown>;

type Suggestion = {
  serviceCode: string | null;
  label: string;
  jobType: JobType;
  laborHours: number | null;
  notes: string;
  isCritical: boolean;
  distanceKmNormal: number | null;
  timeMonthsNormal: number | null;
};

type Props = {
  workOrderId: string;
  vehicleId: string | null;
  odometerKm: number | null;
  onAdded?: () => void | Promise<void>;
};

type SuggestionsApiResponse = {
  ok?: boolean;
  error?: string;
  suggestions?: unknown;
};

type AddSuggestedLinesResponse = {
  ok?: boolean;
  error?: string;
};

function normalizeSuggestions(input: unknown): Suggestion[] {
  if (!Array.isArray(input)) return [];

  const validJobTypes: JobType[] = [
    "diagnosis",
    "repair",
    "maintenance",
    "tech-suggested",
  ];

  const asNum = (v: unknown): number | null =>
    typeof v === "number" && Number.isFinite(v) ? v : null;

  const asStr = (v: unknown): string | null =>
    typeof v === "string" ? v : null;

  return input.map((rawUnknown: unknown): Suggestion => {
    const raw: RawSuggestion =
      rawUnknown && typeof rawUnknown === "object"
        ? (rawUnknown as RawSuggestion)
        : {};

    const serviceCodeVal = asStr(raw["serviceCode"]);
    const serviceCodeRaw =
      serviceCodeVal && serviceCodeVal.trim()
        ? serviceCodeVal.trim().toUpperCase()
        : null;

    const labelVal = asStr(raw["label"]);
    const nameVal = asStr(raw["name"]);
    const labelRaw =
      labelVal && labelVal.trim()
        ? labelVal.trim()
        : nameVal && nameVal.trim()
          ? nameVal.trim()
          : "Maintenance item";

    const jobTypeVal = asStr(raw["jobType"]);
    const jobTypeRaw = jobTypeVal ? jobTypeVal.trim().toLowerCase() : "";
    const jobType: JobType = validJobTypes.includes(jobTypeRaw as JobType)
      ? (jobTypeRaw as JobType)
      : "maintenance";

    const hoursRaw =
      asNum(raw["default_labor_hours"]) ??
      asNum(raw["laborHours"]) ??
      asNum(raw["typicalHours"]) ??
      null;

    const notesRaw =
      (asStr(raw["default_notes"]) ?? asStr(raw["notes"]) ?? "") as string;

    const isCritical =
      typeof raw["is_critical"] === "boolean"
        ? raw["is_critical"]
        : typeof raw["isCritical"] === "boolean"
          ? raw["isCritical"]
          : false;

    const distanceKmNormal =
      asNum(raw["distance_km_normal"]) ?? asNum(raw["distanceKmNormal"]) ?? null;

    const timeMonthsNormal =
      asNum(raw["time_months_normal"]) ?? asNum(raw["timeMonthsNormal"]) ?? null;

    return {
      serviceCode: serviceCodeRaw,
      label: labelRaw,
      jobType,
      laborHours: hoursRaw,
      notes: notesRaw,
      isCritical,
      distanceKmNormal,
      timeMonthsNormal,
    };
  });
}

export function WorkOrderSuggestionsPanel({
  workOrderId,
  vehicleId,
  odometerKm,
  onAdded,
}: Props) {
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [items, setItems] = useState<Suggestion[]>([]);
  const [addingKey, setAddingKey] = useState<string | null>(null);

  const effectiveOdo = useMemo(() => {
    if (typeof odometerKm === "number" && Number.isFinite(odometerKm)) {
      return odometerKm;
    }
    return null;
  }, [odometerKm]);

  const fetchSuggestions = useCallback(
    async (opts?: { isRefresh?: boolean }) => {
      const isRefresh = opts?.isRefresh ?? false;
      if (!workOrderId) return;

      if (isRefresh) setRefreshing(true);
      else setLoading(true);

      setError(null);

      try {
        const res = await fetch("/api/maintenance/suggestions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderId, vehicleId }),
        });

        const json: SuggestionsApiResponse = await res
          .json()
          .catch(() => ({} as SuggestionsApiResponse));

        if (!res.ok) throw new Error(json.error || "Failed to load suggestions");

        const suggestions = normalizeSuggestions(json.suggestions);
        setItems(suggestions);
      } catch (e: unknown) {
        const msg =
          e instanceof Error ? e.message : "Failed to load suggestions";
        setError(msg);
        setItems([]);
      } finally {
        setLoading(false);
        setRefreshing(false);
      }
    },
    [workOrderId, vehicleId],
  );

  useEffect(() => {
    if (workOrderId) void fetchSuggestions();
  }, [workOrderId, fetchSuggestions]);

  async function addSuggestedJob(s: Suggestion) {
    if (!workOrderId) return;

    const key = s.serviceCode || s.label;
    setAddingKey(key);

    try {
      const res = await fetch("/api/work-orders/add-suggested-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          odometerKm: effectiveOdo ?? null,
          items: [
            {
              description: s.label,
              serviceCode: s.serviceCode ?? undefined,
              jobType: s.jobType,
              laborHours: s.laborHours ?? null,
              notes: s.notes || undefined,
            },
          ],
        }),
      });

      const json: AddSuggestedLinesResponse = await res
        .json()
        .catch(() => ({} as AddSuggestedLinesResponse));

      if (!res.ok || json.error) {
        throw new Error(json.error || "Failed to add maintenance job");
      }

      toast.success("Maintenance job added and queued for parts quote");
      await onAdded?.();
    } catch (e: unknown) {
      const msg =
        e instanceof Error ? e.message : "Failed to add maintenance job";
      toast.error(msg);
    } finally {
      setAddingKey(null);
    }
  }

  const hasItems = items.length > 0;

  return (
    <div className="rounded-xl border border-white/12 bg-black/45 p-4 text-sm text-white/80 shadow-[0_18px_45px_rgba(0,0,0,0.70)] backdrop-blur-xl">
      <div className="mb-2 flex items-center justify-between gap-2">
        <div>
          <h2 className="text-sm font-semibold text-[color:var(--accent-copper-light,#f6d2b3)]">
            Maintenance suggestions
          </h2>
          <p className="text-[11px] text-white/45">
            Based on this vehicle&apos;s profile and mileage, add items as jobs
            and send them for parts quoting.
          </p>
        </div>
        <button
          type="button"
          onClick={() => fetchSuggestions({ isRefresh: true })}
          disabled={loading || refreshing}
          className="rounded-md border border-white/12 bg-black/35 px-2 py-1 text-[11px] text-white/75 hover:bg-white/5 disabled:opacity-60"
        >
          {refreshing ? "Refreshing…" : "Refresh"}
        </button>
      </div>

      {effectiveOdo !== null && (
        <div className="mb-2 text-[11px] text-white/55">
          Odometer:&nbsp;
          <span className="font-mono text-white/85">
            {effectiveOdo.toLocaleString()} km
          </span>
        </div>
      )}

      {loading && !hasItems && !error && (
        <div className="mt-2 text-xs text-white/45">Loading…</div>
      )}

      {error && (
        <div className="mt-2 rounded border border-red-500/35 bg-red-950/55 p-2 text-xs text-red-200">
          {error}
        </div>
      )}

      {!loading && !error && !hasItems && (
        <div className="mt-2 text-xs text-white/45">
          No maintenance suggestions recorded for this work order yet.
        </div>
      )}

      {hasItems && (
        <div className="mt-3 space-y-2">
          {items.map((s) => {
            const key = s.serviceCode || s.label;
            const dueBits: string[] = [];

            if (s.distanceKmNormal != null)
              dueBits.push(`${s.distanceKmNormal.toLocaleString()} km`);
            if (s.timeMonthsNormal != null)
              dueBits.push(`${s.timeMonthsNormal} months`);

            return (
              <div
                key={key}
                className="rounded-lg border border-white/10 bg-black/40 p-3 backdrop-blur-md"
              >
                <div className="flex items-start justify-between gap-3">
                  <div className="min-w-0">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="truncate font-medium text-white">
                        {s.label}
                      </div>
                      {s.serviceCode && (
                        <span className="rounded-full border border-white/10 bg-black/30 px-2 py-0.5 text-[10px] font-mono uppercase tracking-wide text-white/70">
                          {s.serviceCode}
                        </span>
                      )}
                      {s.isCritical && (
                        <span className="rounded-full border border-red-700/55 bg-red-900/35 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-red-200">
                          Critical
                        </span>
                      )}
                    </div>

                    <div className="mt-0.5 text-[11px] text-white/55">
                      {s.jobType} •{" "}
                      {typeof s.laborHours === "number"
                        ? `${s.laborHours.toFixed(1)}h`
                        : "Labor TBD"}
                      {dueBits.length > 0 && (
                        <> • Due around: {dueBits.join(" or ")}</>
                      )}
                    </div>

                    {s.notes && (
                      <div className="mt-1 text-[11px] text-white/55">
                        {s.notes}
                      </div>
                    )}
                  </div>

                  <div className="flex shrink-0 flex-col items-end gap-1">
                    <button
                      type="button"
                      onClick={() => void addSuggestedJob(s)}
                      disabled={addingKey === key}
                      className="rounded-md border border-[color:var(--accent-copper-soft,rgba(205,120,64,0.45))] bg-black/25 px-3 py-1 text-[11px] font-medium text-[color:var(--accent-copper-light,#f6d2b3)] hover:bg-[color:var(--accent-copper-900,rgba(120,63,28,0.18))] disabled:opacity-60"
                    >
                      {addingKey === key ? "Adding…" : "Add & send to parts"}
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

==================== FILE: features/work-orders/components/WorkOrderViewer.tsx ====================

import Link from "next/link";

type Currency = "CAD" | "USD";

type WorkOrderLite = {
  id: string;
  custom_id?: string | null;
  status?: string | null;
  created_at?: string | null;
  updated_at?: string | null;

  invoice_total?: number | string | null;
  labor_total?: number | string | null;
  parts_total?: number | string | null;
};

type VehicleLite = {
  year?: string | number | null;
  make?: string | null;
  model?: string | null;
  vin?: string | null;
  license_plate?: string | null;
  unit_number?: string | null;
  mileage?: string | number | null;
  color?: string | null;
  engine_hours?: string | number | null;
};

type CustomerLite = {
  name?: string | null;
  business_name?: string | null;
  phone?: string | null;
  email?: string | null;
  street?: string | null;
  city?: string | null;
  province?: string | null;
  postal_code?: string | null;
};

type ShopLite = {
  name?: string | null;
  phone_number?: string | null;
  email?: string | null;
  street?: string | null;
  city?: string | null;
  province?: string | null;
  postal_code?: string | null;
};

export type WorkOrderViewerLine = {
  id: string;
  line_no?: number | null;
  description?: string | null;
  complaint?: string | null;
  cause?: string | null;
  correction?: string | null;
  labor_time?: string | number | null;
};

export type WorkOrderViewerPart = {
  id: string;
  lineId?: string;
  name: string;
  qty: number;
  unitCost: number;
  totalCost: number;
  sku?: string;
  partNumber?: string;
  unit?: string;
};

type Props = {
  kind: "portal" | "internal";
  workOrder: WorkOrderLite;
  currency: Currency;

  vehicle?: VehicleLite;
  customer?: CustomerLite;
  shop?: ShopLite;

  lines: WorkOrderViewerLine[];
  parts: WorkOrderViewerPart[];

  backHref: string;
  title: string;
  subtitle?: string;

  showPay?: boolean;
  paySlot?: React.ReactNode;
  invoicePdfUrl?: string | null;
};

const COPPER = "#C57A4A";

function safeNumberOrNull(v: unknown): number | null {
  if (v == null) return null;
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : null;
}

function safeNumber(v: unknown): number {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : 0;
}

function formatCurrency(
  value: number | null | undefined,
  currency: Currency,
): string {
  if (value == null || Number.isNaN(value)) return "—";
  return new Intl.NumberFormat(currency === "CAD" ? "en-CA" : "en-US", {
    style: "currency",
    currency,
    maximumFractionDigits: 2,
  }).format(value);
}

function formatDate(value: string | null | undefined): string {
  if (!value) return "—";
  const d = new Date(value);
  if (Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString();
}

function compactCsv(parts: Array<string | undefined>): string {
  return parts
    .map((p) => (p ?? "").trim())
    .filter((p) => p.length > 0)
    .join(", ");
}

function vehicleLabel(v?: VehicleLite): string {
  if (!v) return "—";
  const year = v.year != null ? String(v.year) : "";
  const make = (v.make ?? "").trim();
  const model = (v.model ?? "").trim();
  const main = [year, make, model].filter(Boolean).join(" ").trim();
  const plate = (v.license_plate ?? "").trim();
  const unit = (v.unit_number ?? "").trim();
  const extra = [unit ? `Unit ${unit}` : "", plate ? `Plate ${plate}` : ""]
    .filter(Boolean)
    .join(" • ");
  return [main || "Vehicle", extra].filter(Boolean).join(" — ");
}

function addressLine(
  street?: string | null,
  city?: string | null,
  province?: string | null,
  postal?: string | null,
): string {
  const a = (street ?? "").trim();
  const b = compactCsv([
    (city ?? "").trim() || undefined,
    (province ?? "").trim() || undefined,
    (postal ?? "").trim() || undefined,
  ]);
  const out = compactCsv([a || undefined, b || undefined]);
  return out.length ? out : "—";
}

export default function WorkOrderViewer({
  kind,
  workOrder,
  currency,
  vehicle,
  customer,
  shop,
  lines,
  parts,
  backHref,
  title,
  subtitle,
  showPay,
  paySlot,
  invoicePdfUrl,
}: Props) {
  const woId = workOrder.id;
  const titleLabel = (workOrder.custom_id ?? "").trim()
    ? String(workOrder.custom_id).trim()
    : `Work Order ${woId.slice(0, 8)}…`;

  const woInvoiceTotal = safeNumberOrNull(workOrder.invoice_total);
  const woLabor = safeNumberOrNull(workOrder.labor_total);
  const woParts = safeNumberOrNull(workOrder.parts_total);

  const total =
    woInvoiceTotal != null
      ? woInvoiceTotal
      : woLabor != null || woParts != null
        ? (woLabor ?? 0) + (woParts ?? 0)
        : null;

  const partsGrandTotal = parts.reduce((acc, p) => acc + safeNumber(p.totalCost), 0);

  // group parts per line + unassigned
  const partsByLine = new Map<string, WorkOrderViewerPart[]>();
  const unassignedParts: WorkOrderViewerPart[] = [];

  for (const p of parts) {
    if (p.lineId) {
      const arr = partsByLine.get(p.lineId) ?? [];
      arr.push(p);
      partsByLine.set(p.lineId, arr);
    } else {
      unassignedParts.push(p);
    }
  }

  const partCount = parts.reduce((acc, p) => acc + (Number.isFinite(p.qty) ? p.qty : 0), 0);

  return (
    <div className="min-h-screen px-4 text-foreground bg-background bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]">
      <div className="mx-auto flex min-h-screen max-w-4xl flex-col justify-center py-10">
        <div className="w-full rounded-3xl border border-[color:var(--metal-border-soft,#1f2937)] bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_60%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.98),#020617_82%)] shadow-[0_32px_80px_rgba(0,0,0,0.95)] px-6 py-7 sm:px-8 sm:py-9">

          {/* Header */}
          <div className="mb-5 flex items-center justify-between gap-3">
            <Link
              href={backHref}
              className="inline-flex items-center gap-2 rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/60 px-3 py-1.5 text-[11px] uppercase tracking-[0.2em] text-neutral-200 hover:bg-black/70 hover:text-white"
            >
              <span aria-hidden className="text-base leading-none">←</span>
              Back
            </Link>

            <div
              className="inline-flex items-center gap-2 rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-1 text-[11px] uppercase tracking-[0.22em] text-neutral-300"
              style={{ color: COPPER }}
            >
              <span>{title}</span>
              <span className="text-neutral-500">•</span>
              <span className="text-neutral-300">{titleLabel}</span>
            </div>
          </div>

          <div className="mb-6 space-y-1">
            <h1
              className="text-2xl font-semibold text-white sm:text-3xl"
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              {titleLabel}
            </h1>
            <p className="text-xs text-neutral-400 sm:text-sm">
              {subtitle ?? (kind === "portal" ? "Read-only work order view." : "Work order viewer (read-only).")}
            </p>
          </div>

          {/* Top meta */}
          <div className="mb-6 grid gap-4 sm:grid-cols-3">
            <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-3">
              <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                Total
              </div>
              <div className="mt-1 text-lg font-semibold text-white">
                {formatCurrency(total ?? null, currency)}
              </div>
              <div className="mt-0.5 text-[11px] text-neutral-500">
                Currency: {currency}
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-3">
              <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                Status
              </div>
              <div className="mt-1 text-sm font-semibold text-neutral-100">
                {(workOrder.status ?? "—") as string}
              </div>
              <div className="mt-0.5 text-[11px] text-neutral-500">
                Updated: {formatDate(workOrder.updated_at ?? workOrder.created_at)}
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-3">
              <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                Parts total (allocations)
              </div>
              <div className="mt-1 text-sm font-semibold text-neutral-100">
                {formatCurrency(partsGrandTotal, currency)}
              </div>
              <div className="mt-0.5 text-[11px] text-neutral-500">
                {parts.length === 0 ? "No allocations" : `${parts.length} items • Qty ${partCount}`}
              </div>
            </div>
          </div>

          {/* Optional actions */}
          {showPay ? <div className="mb-6">{paySlot ?? null}</div> : null}

          {invoicePdfUrl ? (
            <div className="mb-6">
              <a
                href={invoicePdfUrl}
                target="_blank"
                rel="noreferrer"
                className="inline-flex items-center gap-2 rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.18em] text-neutral-100 hover:bg-black/80"
              >
                <span>View PDF</span>
              </a>
            </div>
          ) : null}

          {/* Party + Vehicle */}
          <div className="mb-6 grid gap-4 sm:grid-cols-2">
            <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-4">
              <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Customer
              </div>
              <div className="mt-2 space-y-1 text-sm text-neutral-200">
                <div className="font-medium text-neutral-100">
                  {compactCsv([
                    (customer?.business_name ?? "").trim() || undefined,
                    (customer?.name ?? "").trim() || undefined,
                  ]) || "—"}
                </div>
                <div className="text-[12px] text-neutral-400">
                  {compactCsv([
                    (customer?.phone ?? "").trim() || undefined,
                    (customer?.email ?? "").trim() || undefined,
                  ]) || "—"}
                </div>
                <div className="text-[12px] text-neutral-400">
                  {addressLine(customer?.street, customer?.city, customer?.province, customer?.postal_code)}
                </div>
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-4">
              <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Vehicle
              </div>
              <div className="mt-2 space-y-1 text-sm text-neutral-200">
                <div className="font-medium text-neutral-100">{vehicleLabel(vehicle)}</div>
                <div className="text-[12px] text-neutral-400">
                  VIN: {(vehicle?.vin ?? "").trim() || "—"}
                </div>
                <div className="text-[12px] text-neutral-400">
                  {compactCsv([
                    vehicle?.mileage != null ? `Mileage ${String(vehicle.mileage)}` : undefined,
                    vehicle?.engine_hours != null ? `Engine Hrs ${String(vehicle.engine_hours)}` : undefined,
                    (vehicle?.color ?? "").trim() || undefined,
                  ]) || "—"}
                </div>
              </div>
            </div>
          </div>

          {/* Lines */}
          <div className="rounded-2xl border border-white/10 bg-black/40 px-4 py-4 sm:px-5 sm:py-5">
            <div className="mb-3 flex items-center justify-between">
              <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Line Items
              </div>
              <div className="text-[11px] text-neutral-500">
                {lines.length === 0 ? "No line items recorded yet" : `${lines.length} items`}
              </div>
            </div>

            {lines.length > 0 ? (
              <div className="space-y-2">
                {lines.map((line) => {
                  const label =
                    (line.description ?? "").trim() ||
                    (line.complaint ?? "").trim() ||
                    "Line item";

                  const lp = partsByLine.get(line.id) ?? [];

                  return (
                    <div
                      key={line.id}
                      className="rounded-xl border border-white/5 bg-black/40 px-3 py-3"
                    >
                      <div className="flex items-baseline justify-between gap-2">
                        <div className="min-w-0">
                          <div className="text-sm font-medium text-neutral-100">
                            {label}
                          </div>
                          <div className="mt-0.5 text-[11px] text-neutral-500">
                            Line #{line.line_no ?? "—"}
                            {line.labor_time != null ? ` • ${String(line.labor_time)} hr` : ""}
                          </div>
                        </div>
                      </div>

                      {(line.cause ?? "").trim().length ||
                      (line.correction ?? "").trim().length ? (
                        <div className="mt-2 space-y-1 text-[12px] text-neutral-300">
                          {(line.cause ?? "").trim().length ? (
                            <div>
                              <span className="text-neutral-500">Cause:</span>{" "}
                              <span className="text-neutral-200">{String(line.cause)}</span>
                            </div>
                          ) : null}
                          {(line.correction ?? "").trim().length ? (
                            <div>
                              <span className="text-neutral-500">Correction:</span>{" "}
                              <span className="text-neutral-200">{String(line.correction)}</span>
                            </div>
                          ) : null}
                        </div>
                      ) : null}

                      {lp.length > 0 ? (
                        <div className="mt-3 rounded-lg border border-white/5 bg-black/35 px-3 py-2">
                          <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                            Parts (allocations)
                          </div>
                          <div className="mt-2 space-y-1">
                            {lp.map((p) => (
                              <div
                                key={p.id}
                                className="flex items-baseline justify-between gap-2 text-sm"
                              >
                                <div className="min-w-0 text-neutral-200">
                                  <span className="text-neutral-500">x{p.qty}</span>{" "}
                                  {p.name}
                                  {p.partNumber ? (
                                    <span className="text-neutral-500"> ({p.partNumber})</span>
                                  ) : null}
                                </div>
                                <div className="whitespace-nowrap font-semibold text-neutral-100">
                                  {formatCurrency(p.totalCost, currency)}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : null}
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-xs text-neutral-400">
                Line items will appear here when they’re added to the work order.
              </div>
            )}
          </div>

          {/* Parts list */}
          <div className="mt-6 rounded-2xl border border-white/10 bg-black/40 px-4 py-4 sm:px-5 sm:py-5">
            <div className="mb-3 flex items-center justify-between">
              <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Parts
              </div>
              <div className="text-[11px] text-neutral-500">
                {parts.length === 0 ? "No parts recorded" : `${parts.length} parts • Qty ${partCount}`}
              </div>
            </div>

            {parts.length > 0 ? (
              <div className="space-y-2">
                {unassignedParts.length > 0 ? (
                  <div className="rounded-lg border border-amber-500/20 bg-amber-500/5 px-3 py-2 text-[12px] text-amber-200">
                    Some parts aren’t linked to a specific line item (missing{" "}
                    <span className="font-mono">work_order_line_id</span>). They’re
                    listed here anyway.
                  </div>
                ) : null}

                {parts.map((p) => {
                  const meta = compactCsv([
                    p.partNumber,
                    p.sku,
                    p.unit ? `Unit: ${p.unit}` : undefined,
                    p.lineId ? `Line: ${p.lineId.slice(0, 6)}…` : undefined,
                  ]);

                  return (
                    <div
                      key={p.id}
                      className="flex flex-wrap items-baseline justify-between gap-2 rounded-xl border border-white/5 bg-black/40 px-3 py-2"
                    >
                      <div className="min-w-0">
                        <div className="text-sm font-medium text-neutral-100">{p.name}</div>
                        {meta.length ? (
                          <div className="text-[11px] text-neutral-500">{meta}</div>
                        ) : null}
                        <div className="text-[11px] text-neutral-500">Qty: {p.qty}</div>
                      </div>

                      <div className="text-right text-xs text-neutral-300">
                        <div className="text-[11px] text-neutral-500">
                          Unit: {formatCurrency(p.unitCost, currency)}
                        </div>
                        <div className="text-sm font-semibold">
                          {formatCurrency(p.totalCost, currency)}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-xs text-neutral-400">
                Parts will appear here from allocations when they’re added to the work order.
              </div>
            )}
          </div>

          {/* Footer shop info (optional) */}
          {shop ? (
            <div className="mt-6 rounded-2xl border border-white/10 bg-black/30 px-4 py-4">
              <div className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Shop
              </div>
              <div className="mt-2 text-sm text-neutral-200">
                <div className="font-medium text-neutral-100">
                  {(shop.name ?? "").trim() || "—"}
                </div>
                <div className="text-[12px] text-neutral-400">
                  {compactCsv([
                    (shop.phone_number ?? "").trim() || undefined,
                    (shop.email ?? "").trim() || undefined,
                  ]) || "—"}
                </div>
                <div className="text-[12px] text-neutral-400">
                  {addressLine(shop.street, shop.city, shop.province, shop.postal_code)}
                </div>
              </div>
            </div>
          ) : null}
        </div>
      </div>
    </div>
  );
}


==================== FILE: features/work-orders/components/manager/ManagerJobDashboard.tsx ====================

// features/dashboard/app/dashboard/manager/page.tsx
import { Suspense } from "react";
import { redirect } from "next/navigation";
import { createServerSupabaseRSC } from "@shared/lib/supabase/server";
import ManagerJobDashboard from "@work-orders/components/manager/ManagerJobDashboard";

export const metadata = { title: "Manager Dashboard" };

export default async function ManagerDashboardPage() {
  const supabase = await createServerSupabaseRSC();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/auth"); // change to your sign-in route if different
  }

  // Basic role guard – adjust allowed roles as needed
  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  const allowedRoles = new Set(["manager", "advisor", "owner", "admin"]);
  if (!profile || !allowedRoles.has(profile.role ?? "")) {
    redirect("/dashboard");
  }

  return (
    <Suspense fallback={<div className="p-4 text-neutral-400">Loading Manager Dashboard…</div>}>
      <ManagerJobDashboard />
    </Suspense>
  );
}

==================== FILE: features/work-orders/components/workorders/AddJobModal.tsx ====================

// /features/work-orders/components/AddJobModal.tsx (FULL FILE REPLACEMENT)
"use client";

import { useMemo, useRef, useState } from "react";
import { v4 as uuidv4 } from "uuid";
import type { PostgrestError } from "@supabase/supabase-js";
import { toast } from "sonner";

import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import ModalShell from "@/features/shared/components/ModalShell";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLineInsert = DB["public"]["Tables"]["work_order_lines"]["Insert"];

type Props = {
  isOpen: boolean;
  onClose: () => void;
  workOrderId: string;
  vehicleId: string | null;
  techId: string;
  onJobAdded?: () => void;
  shopId?: string | null;
};

type Urgency = "low" | "medium" | "high";

/* ----------------------------- helpers ----------------------------- */

function errorMessage(e: unknown): string {
  if (e instanceof Error) return e.message;
  const pe = e as Partial<PostgrestError> | null;
  if (pe && typeof pe.message === "string") return pe.message;
  return "Unknown error";
}

function safeTrim(x: unknown): string {
  return typeof x === "string" ? x.trim() : "";
}

function asNumber(v: unknown): number | null {
  if (typeof v === "number" && Number.isFinite(v)) return v;
  if (typeof v === "string") {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }
  return null;
}

type ItemRow = { id: string; description: string; qty: string };

type PartRequestCreateBody = {
  workOrderId: string;
  jobId?: string | null;
  items: { description: string; qty: number }[];
  notes?: string | null;
};

function parsePartsPaste(raw: string): { description: string; qty: number }[] {
  const s = safeTrim(raw);
  if (!s) return [];
  const tokens = s
    .split(/[\n,]+/g)
    .map((t) => t.trim())
    .filter(Boolean);

  const out: { description: string; qty: number }[] = [];
  for (const t of tokens) {
    // supports: "2x oil filter", "2 x oil filter", "2 oil filter"
    const m = /^(\d+(?:\.\d+)?)\s*(?:x|×)?\s+(.*)$/i.exec(t);
    if (m) {
      const qtyNum = Number(m[1]);
      const desc = (m[2] ?? "").trim();
      if (!desc) continue;
      out.push({
        description: desc,
        qty: Number.isFinite(qtyNum) && qtyNum > 0 ? qtyNum : 1,
      });
    } else {
      out.push({ description: t, qty: 1 });
    }
  }
  return out;
}

export default function AddJobModal(props: Props) {
  const { isOpen, onClose, workOrderId, vehicleId, techId, onJobAdded, shopId } =
    props;

  const supabase = useMemo(() => createBrowserSupabase(), []);
  const lastSetShopId = useRef<string | null>(null);

  const [jobName, setJobName] = useState("");
  const [notes, setNotes] = useState("");
  const [labor, setLabor] = useState("");
  const [urgency, setUrgency] = useState<Urgency>("medium");

  // ✅ parts request style rows
  const [rows, setRows] = useState<ItemRow[]>([
    { id: uuidv4(), description: "", qty: "1" },
  ]);
  const [headerNotes, setHeaderNotes] = useState("");

  // quick paste
  const [partsPaste, setPartsPaste] = useState("");

  const [submitting, setSubmitting] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function ensureShopContext(id: string | null) {
    if (!id) return;
    if (lastSetShopId.current === id) return;

    const { error } = await supabase.rpc("set_current_shop_id", {
      p_shop_id: id,
    });
    if (error) throw error;

    lastSetShopId.current = id;
  }

  const addRow = () =>
    setRows((r) => [...r, { id: uuidv4(), description: "", qty: "1" }]);

  const removeRow = (id: string) =>
    setRows((r) => (r.length > 1 ? r.filter((x) => x.id !== id) : r));

  const setCell = (id: string, patch: Partial<ItemRow>) =>
    setRows((r) => r.map((x) => (x.id === id ? { ...x, ...patch } : x)));

  const validItems = rows
    .map((r) => {
      const description = r.description.trim();
      const n = Number.parseInt(r.qty, 10);
      const qty = Number.isFinite(n) ? n : 0;
      return { description, qty };
    })
    .filter((i) => i.description && i.qty > 0);

  function importPaste() {
    const parsed = parsePartsPaste(partsPaste);
    if (parsed.length === 0) {
      setErr("Nothing to import. Paste like: 2x oil filter, serpentine belt");
      return;
    }

    setErr(null);
    setRows((prev) => [
      ...prev,
      ...parsed.map((p) => ({
        id: uuidv4(),
        description: p.description,
        qty: String(Math.max(1, Math.floor(p.qty))),
      })),
    ]);
    setPartsPaste("");
  }

  function resetForm() {
    setJobName("");
    setNotes("");
    setLabor("");
    setUrgency("medium");
    setHeaderNotes("");
    setRows([{ id: uuidv4(), description: "", qty: "1" }]);
    setPartsPaste("");
    setErr(null);
  }

  async function createPartsRequest(body: PartRequestCreateBody): Promise<string> {
    const res = await fetch("/api/parts/requests/create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    const raw = await res.text();
    let json: { requestId?: string; error?: string } | null = null;
    try {
      json = raw ? (JSON.parse(raw) as { requestId?: string; error?: string }) : null;
    } catch {
      /* ignore */
    }

    if (!res.ok || !json?.requestId) {
      const msg = json?.error || raw || `Request failed with status ${res.status}`;
      throw new Error(msg);
    }

    return json.requestId;
  }

  const handleSubmit = async () => {
    if (!jobName.trim()) {
      setErr("Job name is required.");
      return;
    }

    setSubmitting(true);
    setErr(null);

    try {
      // resolve shop_id
      let useShopId = shopId ?? null;

      if (!useShopId) {
        const { data: wo, error: woErr } = await supabase
          .from("work_orders")
          .select("shop_id")
          .eq("id", workOrderId)
          .maybeSingle();

        if (woErr) throw woErr;

        useShopId = (wo as Pick<WorkOrderRow, "shop_id"> | null)?.shop_id ?? null;
      }

      if (!useShopId) throw new Error("Couldn’t resolve shop for this work order");

      await ensureShopContext(useShopId);

      const {
        data: { user },
      } = await supabase.auth.getUser();

      const laborNum = asNumber(labor);
      const laborHours = laborNum ?? 0;

      const hasParts = validItems.length > 0;

      // ✅ Your rule:
      // - if parts need quoting => on_hold "waiting for parts"
      // For this modal we assume "parts need quoting" when ANY parts exist.
      // (If later you add a toggle for “priced”, we can route to approval instead.)
      const initialStatus: WorkOrderLineInsert["status"] = hasParts
        ? "on_hold"
        : "awaiting_approval";

      const newLineId = uuidv4();

      const payload: WorkOrderLineInsert = {
        id: newLineId,
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        complaint: jobName.trim(),
        cause: null,
        correction: notes.trim() || null,
        labor_time: laborHours > 0 ? laborHours : null,

        // keep legacy text column filled for now (useful for quick scanning)
        parts: hasParts
          ? validItems.map((p) => `${p.qty}x ${p.description}`).join(", ")
          : null,

        status: initialStatus,
        job_type: "repair",
        shop_id: useShopId,

        ...(user?.id ? { user_id: user.id } : {}),
        ...(techId && techId !== "system" ? { assigned_to: techId } : {}),
        ...(urgency ? { urgency } : {}),
      };

      // 1) Create the line
      const { error: insErr } = await supabase.from("work_order_lines").insert(payload);

      if (insErr) {
        const msg = insErr.message || "Failed to add job.";
        if (/row-level security/i.test(msg)) {
          setErr(
            "Access denied (RLS). Check that your session is scoped to this shop.",
          );
          lastSetShopId.current = null;
        } else if (/status.*check/i.test(msg)) {
          setErr("This status isn’t allowed by the database.");
        } else if (/job_type.*check/i.test(msg)) {
          setErr("This job type isn’t allowed by the database.");
        } else {
          setErr(msg);
        }
        return;
      }

      // 2) Create parts request (keep this behavior)
      if (hasParts) {
        try {
          await createPartsRequest({
            workOrderId,
            jobId: newLineId,
            items: validItems,
            notes: safeTrim(headerNotes) || safeTrim(notes) || null,
          });

          toast.success("Job added + parts request sent.");
        } catch (e: unknown) {
          toast.error(
            `Job added, but parts request failed: ${
              e instanceof Error ? e.message : "Unknown error"
            }`,
          );
        }
      } else {
        toast.success("Job added.");
      }

      onJobAdded?.();
      onClose();
      resetForm();
    } catch (e: unknown) {
      setErr(errorMessage(e) || "Failed to add job.");
      lastSetShopId.current = null;
    } finally {
      setSubmitting(false);
    }
  };

  if (!isOpen) return null;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={() => {
        onClose();
        setErr(null);
      }}
      title="Add New Job Line"
      onSubmit={handleSubmit}
      submitText={submitting ? "Adding…" : "Add Job"}
      size="lg"
    >
      <div className="space-y-4">
        {/* Job fields */}
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Job name
          </label>
          <input
            type="text"
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="e.g. Replace tie rod end RH"
            value={jobName}
            onChange={(e) => setJobName(e.target.value)}
          />
        </div>

        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Notes / correction
          </label>
          <textarea
            rows={3}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="Optional notes, concerns, or correction details…"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
          />
        </div>

        <div className="grid gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
              Labor hours
            </label>
            <input
              type="number"
              step="0.1"
              className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
              placeholder="e.g. 1.5"
              value={labor}
              onChange={(e) => setLabor(e.target.value)}
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
              Urgency
            </label>
            <select
              className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
              value={urgency}
              onChange={(e) => setUrgency(e.target.value as Urgency)}
            >
              <option value="low">Low urgency</option>
              <option value="medium">Medium urgency</option>
              <option value="high">High urgency</option>
            </select>
          </div>
        </div>

        {/* Note to parts */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Note to parts (optional)
          </label>
          <textarea
            rows={2}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={headerNotes}
            onChange={(e) => setHeaderNotes(e.target.value)}
            placeholder="Anything they should know before filling this request…"
          />
        </div>

        {/* Items grid (copied style/behavior from PartsRequestModal) */}
        <div className="overflow-hidden rounded-2xl border border-[var(--metal-border-soft)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.85)]">
          <div className="grid grid-cols-12 bg-gradient-to-r from-slate-900/90 via-slate-950 to-black px-3 py-2 text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
            <div className="col-span-8">Parts description</div>
            <div className="col-span-3 text-right">Qty</div>
            <div className="col-span-1 text-center"> </div>
          </div>

          <div className="max-h-64 overflow-auto bg-black/70">
            {rows.map((r) => (
              <div
                key={r.id}
                className="grid grid-cols-12 gap-2 border-t border-white/5 px-3 py-2"
              >
                <input
                  className="col-span-8 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.description}
                  onChange={(e) => setCell(r.id, { description: e.target.value })}
                  placeholder="e.g. rear pads, serp belt…"
                />

                <input
                  inputMode="numeric"
                  pattern="[0-9]*"
                  className="col-span-3 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-right text-sm text-neutral-100 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.qty}
                  onChange={(e) => {
                    const next = e.target.value.replace(/[^\d]/g, "");
                    setCell(r.id, { qty: next });
                  }}
                  onBlur={() => {
                    const n = Number.parseInt(r.qty, 10);
                    const normalized = Number.isFinite(n) && n > 0 ? String(n) : "1";
                    setCell(r.id, { qty: normalized });
                  }}
                  aria-label="Quantity"
                />

                <div className="col-span-1 flex items-center justify-center">
                  <button
                    className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/70 text-[0.7rem] text-neutral-300 transition hover:bg-red-500/20 hover:text-red-200 disabled:opacity-40 disabled:hover:bg-black/70 disabled:hover:text-neutral-300"
                    onClick={() => removeRow(r.id)}
                    disabled={rows.length <= 1}
                    title={
                      rows.length <= 1 ? "At least one row is required" : "Remove row"
                    }
                    type="button"
                  >
                    ✕
                  </button>
                </div>
              </div>
            ))}
          </div>

          <div className="border-t border-white/5 bg-black/80 px-3 py-2">
            <button
              className="inline-flex items-center gap-1 rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[0.7rem] font-medium uppercase tracking-[0.16em] text-neutral-100 transition hover:border-[var(--accent-copper-soft)] hover:bg-[var(--accent-copper-faint)] hover:text-[var(--accent-copper-soft)]"
              onClick={addRow}
              type="button"
            >
              <span>+</span>
              <span>Add item</span>
            </button>
          </div>
        </div>

        {/* Quick paste */}
        <div className="rounded-md border border-white/10 bg-black/30 p-3">
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Quick paste
          </label>
          <textarea
            rows={2}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="Paste: 2x tie rod end RH, cotter pin"
            value={partsPaste}
            onChange={(e) => setPartsPaste(e.target.value)}
          />
          <div className="mt-2 flex gap-2">
            <button
              type="button"
              onClick={importPaste}
              className="rounded-md border border-[var(--accent-copper-light)]/40 bg-[var(--accent-copper-light)]/10 px-3 py-1.5 text-xs font-semibold text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper-light)]/15"
            >
              Import
            </button>
            <button
              type="button"
              onClick={() => setPartsPaste("")}
              className="rounded-md border border-white/10 bg-black/40 px-3 py-1.5 text-xs font-semibold text-neutral-200 hover:bg-black/55"
            >
              Clear
            </button>
          </div>

          <p className="mt-2 text-[0.7rem] text-neutral-500">
            Only lines with a description and quantity &gt; 0 will be sent.
          </p>
        </div>

        {err && (
          <div className="rounded-md border border-red-500/50 bg-red-950/40 px-3 py-2 text-xs text-red-100">
            {err}
          </div>
        )}
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/AiAssistantModal.tsx ====================

"use client";

import { useEffect, useState } from "react";
import { createPortal } from "react-dom";
import TechAssistant from "@/features/shared/components/TechAssistant";

type AiAssistantModalProps = {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId?: string;
  defaultVehicle?: {
    year?: string;
    make?: string;
    model?: string;
  };
};

export default function AiAssistantModal({
  isOpen,
  onClose,
  workOrderLineId,
  defaultVehicle,
}: AiAssistantModalProps) {
  // Ensure we only portal once we're mounted in the browser
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!isOpen || !mounted) return null;

  return createPortal(
    <div className="fixed inset-0 z-[200] flex items-start justify-center overflow-y-auto pt-10 pb-10">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/75 backdrop-blur-sm"
        onClick={onClose}
        aria-hidden="true"
      />

      {/* Panel wrapper */}
      <div className="relative z-[210] mx-4 w-full max-w-3xl">
        <div className="overflow-hidden rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)] shadow-[0_32px_80px_rgba(0,0,0,0.95)]">
          {/* Header */}
          <div className="flex items-start justify-between border-b border-white/10 px-5 py-3">
            <div>
              <h2
                className="text-xs font-semibold uppercase tracking-[0.24em] text-neutral-300"
                style={{ fontFamily: "var(--font-blackops), system-ui" }}
              >
                AI / Tech Assistant
              </h2>
              <p className="mt-1 text-[11px] text-neutral-400">
                Scoped to this job and vehicle where possible.
              </p>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="ml-3 inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/20 bg-black/60 text-xs text-neutral-200 hover:bg-white/10"
              aria-label="Close AI assistant"
            >
              ✕
            </button>
          </div>

          {/* Body – TechAssistant handles its own inner scroll for messages */}
          <div className="px-5 py-4">
            <div className="rounded-2xl border border-white/12 bg-black/70 p-3 shadow-[0_18px_45px_rgba(0,0,0,0.9)]">
              <TechAssistant
                defaultVehicle={defaultVehicle}
                workOrderLineId={workOrderLineId}
              />
            </div>
          </div>
        </div>
      </div>
    </div>,
    document.body,
  );
}

==================== FILE: features/work-orders/components/workorders/CauseCorrectionModal.tsx ====================

// /features/work-orders/components/workorders/CauseCorrectionModal.tsx (FULL FILE REPLACEMENT)
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface CauseCorrectionModalProps {
  isOpen: boolean;
  onClose: () => void;

  /** still required for submits + parent logic */
  jobId: string;

  /** ✅ NEW: shown in header instead of jobId (use line complaint/description) */
  lineLabel: string;

  onSubmit: (cause: string, correction: string) => Promise<void>;

  /** ✅ Draft save (cause/correction can be partial) */
  onSaveDraft?: (cause: string, correction: string) => Promise<void>;

  initialCause?: string;
  initialCorrection?: string;
}

export default function CauseCorrectionModal({
  isOpen,
  onClose,
  jobId,
  lineLabel,
  onSubmit,
  onSaveDraft,
  initialCause = "",
  initialCorrection = "",
}: CauseCorrectionModalProps) {
  const [cause, setCause] = useState(initialCause);
  const [correction, setCorrection] = useState(initialCorrection);
  const [submitting, setSubmitting] = useState(false);
  const [savingDraft, setSavingDraft] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [ok, setOk] = useState<string | null>(null);

  const causeRef = useRef<HTMLTextAreaElement | null>(null);

  useEffect(() => {
    if (isOpen) {
      setCause(initialCause);
      setCorrection(initialCorrection);
      setError(null);
      setOk(null);
      setTimeout(() => causeRef.current?.focus(), 50);
    }
  }, [isOpen, initialCause, initialCorrection]);

  const trimmedCause = useMemo(() => cause.trim(), [cause]);
  const trimmedCorrection = useMemo(() => correction.trim(), [correction]);

  const canComplete = trimmedCause.length > 0 && trimmedCorrection.length > 0;

  // ✅ allow draft save if user typed anything at all
  const canSaveDraft =
    Boolean(onSaveDraft) &&
    (trimmedCause.length > 0 || trimmedCorrection.length > 0);

  const handleSubmit = async () => {
    if (submitting || savingDraft) return;

    // hard gate: must have both
    if (!canComplete) {
      setError("Cause and correction are required to complete this job.");
      setOk(null);
      return;
    }

    setSubmitting(true);
    setError(null);
    setOk(null);
    try {
      await onSubmit(trimmedCause, trimmedCorrection);
      onClose();
    } catch (e) {
      setError(e instanceof Error ? e.message : "Failed to complete job.");
    } finally {
      setSubmitting(false);
    }
  };

  const handleSaveDraft = async () => {
    if (!onSaveDraft || submitting || savingDraft) return;
    if (!canSaveDraft) return;

    setSavingDraft(true);
    setError(null);
    setOk(null);
    try {
      await onSaveDraft(trimmedCause, trimmedCorrection);
      setOk("Saved.");
    } catch (e) {
      setError(e instanceof Error ? e.message : "Failed to save.");
    } finally {
      setSavingDraft(false);
    }
  };

  const busy = submitting || savingDraft;

  const headerLabel =
    (lineLabel ?? "").trim().length > 0 ? lineLabel.trim() : jobId;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="COMPLETE JOB"
      size="md"
      hideFooter
    >
      <div
        className="max-h-[70vh] space-y-4 overflow-y-auto pr-1"
        style={{ WebkitOverflowScrolling: "touch" }}
      >
        <div className="flex items-center justify-between text-[0.7rem] text-neutral-400">
          <div className="flex min-w-0 flex-col gap-0.5">
            <span className="font-semibold uppercase tracking-[0.18em]">
              Complaint
            </span>
            <span className="truncate text-[0.8rem] font-medium text-neutral-100">
              {headerLabel}
            </span>
            {/* keep id around but de-emphasized (helps debugging) */}
            <span className="font-mono text-[0.65rem] text-neutral-500">
              {jobId}
            </span>
          </div>

          <span className="shrink-0 rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-3 py-1 text-[0.65rem] uppercase tracking-[0.18em] text-neutral-300">
            Cause / Correction
          </span>
        </div>

        {error && (
          <div className="rounded-lg border border-red-500/40 bg-red-950/35 px-3 py-2 text-xs text-red-100">
            {error}
          </div>
        )}

        {ok && !error && (
          <div className="rounded-lg border border-emerald-500/30 bg-emerald-950/25 px-3 py-2 text-xs text-emerald-100">
            {ok}
          </div>
        )}

        {!canComplete && (
          <div className="rounded-lg border border-amber-500/35 bg-black/35 px-3 py-2 text-[0.75rem] text-amber-200">
            <span className="font-semibold">Required:</span> enter both a{" "}
            <span className="font-semibold">cause</span> and{" "}
            <span className="font-semibold">correction</span> to complete the
            job.
          </div>
        )}

        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Cause
          </label>
          <textarea
            ref={causeRef}
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={cause}
            onChange={(e) => {
              setCause(e.target.value);
              if (error) setError(null);
              if (ok) setOk(null);
            }}
            placeholder="What caused the issue?"
          />
        </div>

        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Correction
          </label>
          <textarea
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={correction}
            onChange={(e) => {
              setCorrection(e.target.value);
              if (error) setError(null);
              if (ok) setOk(null);
            }}
            placeholder="Describe what was done to correct the issue…"
            onKeyDown={(e) => {
              if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
                e.preventDefault();
                void handleSubmit();
              }
            }}
          />
          <p className="mt-1 text-[0.7rem] text-neutral-500">
            Press{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              Ctrl
            </kbd>{" "}
            /{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              ⌘
            </kbd>{" "}
            +{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              Enter
            </kbd>{" "}
            to complete.
          </p>
        </div>

        {/* footer */}
        <div className="mt-2 flex flex-col gap-2 border-t border-[var(--metal-border-soft)] pt-3 sm:flex-row sm:items-center sm:justify-between">
          <button
            type="button"
            onClick={onClose}
            disabled={busy}
            className="inline-flex items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-4 py-1.5 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5 disabled:opacity-60"
          >
            Cancel
          </button>

          <div className="flex flex-1 flex-col gap-2 sm:flex-row sm:justify-end">
            {/* ✅ NEW: bottom “Save” button (arrow area) */}
            {onSaveDraft && (
              <button
                type="button"
                onClick={() => void handleSaveDraft()}
                disabled={busy || !canSaveDraft}
                className={[
                  "inline-flex flex-1 items-center justify-center rounded-full px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] sm:flex-none sm:px-5",
                  canSaveDraft
                    ? "border border-[var(--metal-border-soft)] bg-black/50 text-neutral-200 hover:bg-white/5"
                    : "border border-white/10 bg-black/30 text-neutral-500 opacity-70",
                ].join(" ")}
                title={
                  canSaveDraft
                    ? "Save cause/correction without completing"
                    : "Type a cause or correction to enable saving"
                }
              >
                {savingDraft ? "Saving…" : "Save"}
              </button>
            )}

            <button
              type="button"
              onClick={() => void handleSubmit()}
              disabled={busy || !canComplete}
              className={[
                "inline-flex flex-1 items-center justify-center rounded-full px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.22em] shadow-[0_0_20px_rgba(212,118,49,0.7)] sm:flex-none sm:px-6",
                canComplete
                  ? "bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] text-black hover:brightness-110"
                  : "border border-amber-500/40 bg-amber-500/10 text-amber-200 opacity-70",
              ].join(" ")}
              title={
                canComplete
                  ? "Complete job"
                  : "Cause and correction are required to complete this job"
              }
            >
              {submitting ? "Completing…" : "Complete job"}
            </button>
          </div>
        </div>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/DtcSuggestionPopup.tsx ====================

// features/work-orders/components/workorders/extras/DtcSuggestionModal.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Props = {
  isOpen: boolean;
  onClose: () => void;
  jobId: string;
  vehicle?: {
    year?: string | null;
    make?: string | null;
    model?: string | null;
  } | null;
};

type DtcSuggestionResponse = {
  cause: string;
  correction: string;
  laborTime: number | null;
};

export default function DtcSuggestionModal({
  isOpen,
  onClose,
  jobId,
  vehicle,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [cause, setCause] = useState("");
  const [correction, setCorrection] = useState("");
  const [laborTime, setLaborTime] = useState<string>("");
  const [generating, setGenerating] = useState(false);
  const [saving, setSaving] = useState(false);
  const [hasGenerated, setHasGenerated] = useState(false);

  // When modal opens, ask backend to generate suggestions from complaint line
  useEffect(() => {
    if (!isOpen || !jobId) return;

    const run = async () => {
      setGenerating(true);
      try {
        const res = await fetch("/api/work-orders/dtc-suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ jobId }),
        });

        const json = (await res.json()) as
          | { suggestion?: DtcSuggestionResponse; error?: string }
          | undefined;

        if (!res.ok || !json?.suggestion) {
          throw new Error(json?.error || "AI could not generate suggestions.");
        }

        const { cause, correction, laborTime } = json.suggestion;

        setCause(cause ?? "");
        setCorrection(correction ?? "");
        setLaborTime(
          laborTime != null && !Number.isNaN(laborTime)
            ? laborTime.toString()
            : "",
        );
        setHasGenerated(true);
      } catch (err) {
        console.error("[DtcSuggestionModal] generate failed", err);
        setHasGenerated(false);
        toast.error(
          err instanceof Error
            ? err.message
            : "Could not generate DTC suggestions.",
        );
      } finally {
        setGenerating(false);
      }
    };

    void run();
  }, [isOpen, jobId]);

  const handleSave = async () => {
    const trimmedCause = cause.trim();
    const trimmedCorrection = correction.trim();
    const trimmedLabor = laborTime.trim();

    if (!trimmedCause || !trimmedCorrection) {
      toast.error("Cause and correction are required.");
      return;
    }

    const parsedLabor =
      trimmedLabor === "" ? null : Number.parseFloat(trimmedLabor);
    if (trimmedLabor !== "" && Number.isNaN(parsedLabor)) {
      toast.error("Labor time must be a valid number.");
      return;
    }

    setSaving(true);
    try {
      const updates: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        cause: trimmedCause,
        correction: trimmedCorrection,
        labor_time: parsedLabor,
      };

      const { error } = await supabase
        .from("work_order_lines")
        .update(updates)
        .eq("id", jobId);

      if (error) throw error;

      toast.success("AI cause / correction applied to this job.");
      onClose();
      // focused job modal will pick this up via refresh / realtime
    } catch (err: any) {
      console.error("[DtcSuggestionModal] save failed", err);
      toast.error(err?.message ?? "Error saving DTC suggestions.");
    } finally {
      setSaving(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="AI DTC Cause / Correction"
      onSubmit={handleSave}
      submitText={saving ? "Saving…" : "Apply to Job"}
      size="md"
    >
      <div className="space-y-3">
        {vehicle && (
          <p className="text-xs text-neutral-400">
            Using complaint + context for{" "}
            <span className="font-mono text-neutral-100">
              {vehicle.year ?? ""} {vehicle.make ?? ""} {vehicle.model ?? ""}
            </span>
          </p>
        )}

        {generating && (
          <div className="rounded border border-amber-500/40 bg-amber-500/5 px-3 py-2 text-xs text-amber-100">
            Thinking through codes and complaint…
          </div>
        )}

        {!generating && !hasGenerated && (
          <div className="rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-xs text-neutral-300">
            No AI suggestion yet. You can fill in cause, correction and labor
            manually and apply.
          </div>
        )}

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Cause
          </label>
          <textarea
            rows={2}
            value={cause}
            onChange={(e) => setCause(e.target.value)}
            placeholder="AI-generated root cause will appear here…"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Correction
          </label>
          <textarea
            rows={3}
            value={correction}
            onChange={(e) => setCorrection(e.target.value)}
            placeholder="AI-generated correction steps & specs will appear here…"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Labor time (hours)
          </label>
          <input
            type="number"
            min={0}
            step={0.1}
            value={laborTime}
            onChange={(e) => setLaborTime(e.target.value)}
            placeholder="e.g. 1.5"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <p className="mt-1 text-[11px] text-neutral-500">
          This will overwrite the job&apos;s existing{" "}
          <span className="font-semibold text-neutral-100">cause</span>,{" "}
          <span className="font-semibold text-neutral-100">correction</span> and{" "}
          <span className="font-semibold text-neutral-100">labor time</span>.
        </p>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/FocusedJobModal.tsx ====================

// features/work-orders/components/workorders/FocusedJobModal.tsx (FULL FILE REPLACEMENT)
// ✅ Fix build error: pass required `lineLabel` prop to CauseCorrectionModal
// ✅ Uses complaint/description fallback for lineLabel

"use client";

import { useEffect, useMemo, useState, useCallback, useRef } from "react";
import { Dialog } from "@headlessui/react";
import { format } from "date-fns";
import { toast } from "sonner";
import { v4 as uuidv4 } from "uuid";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";

import CauseCorrectionModal from "@work-orders/components/workorders/CauseCorrectionModal";
import PartsRequestModal from "@/features/work-orders/components/workorders/PartsRequestModal";

import HoldModal from "@/features/work-orders/components/workorders/HoldModal";
import PhotoCaptureModal from "@/features/work-orders/components/workorders/extras/PhotoCaptureModal";
import AddJobModal from "@work-orders/components/workorders/AddJobModal";

import AIAssistantModal from "@work-orders/components/workorders/AiAssistantModal";

import NewChatModal from "@/features/ai/components/chat/NewChatModal";
import SuggestedQuickAdd from "@work-orders/components/SuggestedQuickAdd";

import JobPunchButton from "@/features/work-orders/components/JobPunchButton";
import VehicleHistoryModal from "@/features/work-orders/components/workorders/VehicleHistoryModal";

import type { RealtimePostgresChangesPayload } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type Mode = "tech" | "view";

const statusTextColor: Record<string, string> = {
  in_progress: "text-sky-200",
  awaiting: "text-slate-200",
  queued: "text-indigo-200",
  on_hold: "text-amber-200",
  completed: "text-emerald-200",
  paused: "text-amber-200",
  assigned: "text-sky-200",
  unassigned: "text-neutral-200",
  awaiting_approval: "text-blue-200",
  declined: "text-red-200",
};

const chip = (s: string | null) =>
  statusTextColor[(s ?? "awaiting").toLowerCase().replaceAll(" ", "_")] ??
  "text-neutral-200";

const btnBase = "rounded-md border text-sm px-3 py-2 transition-colors text-left";
const btnNeutral =
  btnBase + " border-white/15 bg-black/40 text-neutral-100 hover:bg-white/5";
const btnWarn =
  btnBase +
  " border-amber-400/80 bg-amber-500/10 text-amber-100 hover:bg-amber-500/20";
const btnDanger =
  btnBase + " border-red-500/80 bg-red-500/10 text-red-100 hover:bg-red-500/20";
const btnInfo =
  btnBase + " border-sky-500/80 bg-sky-500/10 text-sky-100 hover:bg-sky-500/20";
const btnAccent =
  btnBase +
  " border-[var(--accent-copper-light)] bg-[var(--accent-copper-faint)] text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper-soft)]";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];

type AllocationRow = DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
  parts?: { name: string | null } | null;
};

type WorkflowStatus =
  | "awaiting"
  | "awaiting_approval"
  | "declined"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "paused"
  | "completed"
  | "assigned"
  | "unassigned";

export default function FocusedJobModal(props: {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId: string;
  onChanged?: () => void | Promise<void>;
  mode?: Mode;
}): JSX.Element {
  const { isOpen, onClose, workOrderLineId, onChanged, mode = "tech" } = props;

  const supabase = useMemo(() => createBrowserSupabase(), []);
  const lastSetShopId = useRef<string | null>(null);

  const [busy, setBusy] = useState(false);
  const [line, setLine] = useState<WorkOrderLine | null>(null);
  const [workOrder, setWorkOrder] = useState<WorkOrder | null>(null);
  const [vehicle, setVehicle] = useState<Vehicle | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);

  const [techNotes, setTechNotes] = useState("");
  const [savingNotes, setSavingNotes] = useState(false);

  // sub-modals
  const [openComplete, setOpenComplete] = useState(false);
  const [openParts, setOpenParts] = useState(false);
  const [openHold, setOpenHold] = useState(false);
  const [openPhoto, setOpenPhoto] = useState(false);
  const [openChat, setOpenChat] = useState(false);
  const [openAddJob, setOpenAddJob] = useState(false);
  const [openAi, setOpenAi] = useState(false);
  const [_openDtc, setOpenDtc] = useState(false);

  // ✅ vehicle history modal
  const [openVehicleHistory, setOpenVehicleHistory] = useState(false);

  // prefill
  const [prefillCause, setPrefillCause] = useState("");
  const [prefillCorrection, setPrefillCorrection] = useState("");

  // parts used
  const [allocs, setAllocs] = useState<AllocationRow[]>([]);
  const [allocsLoading, setAllocsLoading] = useState(false);

  const showErr = (prefix: string, err?: { message?: string } | null) => {
    toast.error(`${prefix}: ${err?.message ?? "Something went wrong."}`);
    // eslint-disable-next-line no-console
    console.error(prefix, err);
  };

  // ✅ stable callback so exhaustive-deps is satisfied
  const ensureShopContext = useCallback(
    async (id: string | null) => {
      if (!id) return;
      if (lastSetShopId.current === id) return;

      const { error } = await supabase.rpc("set_current_shop_id", {
        p_shop_id: id,
      });

      if (error) {
        lastSetShopId.current = null;
        throw error;
      }

      lastSetShopId.current = id;
    },
    [supabase],
  );

  const closeAllSubModals = () => {
    setOpenComplete(false);
    setOpenParts(false);
    setOpenHold(false);
    setOpenPhoto(false);
    setOpenChat(false);
    setOpenAddJob(false);
    setOpenAi(false);
    setOpenVehicleHistory(false);
  };

  useEffect(() => {
    if (!isOpen) {
      closeAllSubModals();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isOpen]);

  // initial load
  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;

    (async () => {
      setBusy(true);
      try {
        const { data: l, error: le } = await supabase
          .from("work_order_lines")
          .select("*")
          .eq("id", workOrderLineId)
          .maybeSingle<WorkOrderLine>();
        if (le) throw le;

        setLine(l ?? null);
        setTechNotes(l?.notes ?? "");

        if (l?.work_order_id) {
          const { data: wo, error: we } = await supabase
            .from("work_orders")
            .select("*")
            .eq("id", l.work_order_id)
            .maybeSingle<WorkOrder>();
          if (we) throw we;

          setWorkOrder(wo ?? null);

          // set shop scope early (helps future writes)
          const sid = (wo?.shop_id as string | null) ?? null;
          if (sid) {
            try {
              await ensureShopContext(sid);
            } catch (e) {
              // eslint-disable-next-line no-console
              console.warn("[FocusedJob] set_current_shop_id failed:", e);
            }
          }

          if (wo?.vehicle_id) {
            const { data: v, error: ve } = await supabase
              .from("vehicles")
              .select("*")
              .eq("id", wo.vehicle_id)
              .maybeSingle<Vehicle>();
            if (ve) throw ve;
            setVehicle(v ?? null);
          } else {
            setVehicle(null);
          }

          if (wo?.customer_id) {
            const { data: c, error: ce } = await supabase
              .from("customers")
              .select("*")
              .eq("id", wo.customer_id)
              .maybeSingle<Customer>();
            if (ce) throw ce;
            setCustomer(c ?? null);
          } else {
            setCustomer(null);
          }
        }
      } catch (e) {
        const err = e as { message?: string };
        toast.error(err?.message ?? "Failed to load job");
      } finally {
        setBusy(false);
      }
    })();
  }, [isOpen, workOrderLineId, supabase, ensureShopContext]);

  // realtime line
  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;
    const ch = supabase
      .channel(`wol-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `id=eq.${workOrderLineId}`,
        },
        (payload: RealtimePostgresChangesPayload<WorkOrderLine>) => {
          const next = payload.new;
          if (next && typeof (next as Partial<WorkOrderLine>).id === "string") {
            setLine(next as WorkOrderLine);
          }
        },
      )
      .subscribe();
    return () => {
      void supabase.removeChannel(ch);
    };
  }, [isOpen, workOrderLineId, supabase]);

  const loadAllocations = useCallback(async () => {
    if (!workOrderLineId) return;
    setAllocsLoading(true);
    try {
      const { data, error } = await supabase
        .from("work_order_part_allocations")
        .select("*, parts(name)")
        .eq("work_order_line_id", workOrderLineId)
        .order("created_at", { ascending: true });
      if (error) throw error;
      setAllocs((data as AllocationRow[]) ?? []);
    } catch (e) {
      // eslint-disable-next-line no-console
      console.warn("[FocusedJob] load allocations failed", e);
    } finally {
      setAllocsLoading(false);
    }
  }, [supabase, workOrderLineId]);

  useEffect(() => {
    if (!isOpen) return;
    void loadAllocations();
  }, [isOpen, loadAllocations]);

  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;

    const ch = supabase
      .channel(`wol-parts-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_part_allocations",
          filter: `work_order_line_id=eq.${workOrderLineId}`,
        },
        () => void loadAllocations(),
      )
      .subscribe();

    return () => {
      try {
        void supabase.removeChannel(ch);
      } catch {
        //
      }
    };
  }, [isOpen, workOrderLineId, supabase, loadAllocations]);

  const refresh = useCallback(async () => {
    const { data: l } = await supabase
      .from("work_order_lines")
      .select("*")
      .eq("id", workOrderLineId)
      .maybeSingle<WorkOrderLine>();
    setLine(l ?? null);
    setTechNotes(l?.notes ?? "");
    await onChanged?.();
    await loadAllocations();
  }, [supabase, workOrderLineId, onChanged, loadAllocations]);

  useEffect(() => {
    const handler = () => void refresh();
    window.addEventListener("wol:refresh", handler);
    return () => window.removeEventListener("wol:refresh", handler);
  }, [refresh]);

  // parts request events
  useEffect(() => {
    const handleClose = () => setOpenParts(false);
    const handleSubmitted = async () => {
      setOpenParts(false);
      await refresh();
    };

    window.addEventListener("parts-request:close", handleClose);
    window.addEventListener("parts-request:submitted", handleSubmitted);
    return () => {
      window.removeEventListener("parts-request:close", handleClose);
      window.removeEventListener("parts-request:submitted", handleSubmitted);
    };
  }, [refresh]);

  // inspection done → open complete
  useEffect(() => {
    const onInspectionDone = (evt: Event) => {
      const e = evt as CustomEvent<{
        workOrderLineId?: string;
        cause?: string;
        correction?: string;
      }>;
      const detail = e.detail || {};
      if (!detail.workOrderLineId) return;
      if (detail.workOrderLineId !== workOrderLineId) return;

      closeAllSubModals();
      setPrefillCause(detail.cause ?? "");
      setPrefillCorrection(detail.correction ?? "");
      setOpenComplete(true);
    };

    window.addEventListener("inspection:completed", onInspectionDone);
    return () => window.removeEventListener("inspection:completed", onInspectionDone);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [workOrderLineId]);

  const applyHold = async (reason: string, notes?: string) => {
    if (busy) return;
    if (!line) return;

    setBusy(true);
    try {
      await ensureShopContext((workOrder?.shop_id as string | null) ?? null);

      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        hold_reason: reason || "On hold",
        status: "on_hold",
        notes: notes ?? line.notes ?? null,
      };

      if (line.punched_in_at && !line.punched_out_at) {
        update.punched_out_at = new Date().toISOString();
      }

      const { error } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", workOrderLineId);

      if (error) throw error;

      toast.success("Hold applied");
      await refresh();
    } catch (e) {
      showErr("Apply hold failed", e as { message?: string });
    } finally {
      setBusy(false);
    }
  };

  const releaseHold = async () => {
    if (busy) return;
    setBusy(true);
    try {
      await ensureShopContext((workOrder?.shop_id as string | null) ?? null);

      const { error } = await supabase
        .from("work_order_lines")
        .update({
          hold_reason: null,
          status: "awaiting",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", workOrderLineId);

      if (error) throw error;

      toast.success("Hold removed");
      await refresh();
    } catch (e) {
      showErr("Remove hold failed", e as { message?: string });
    } finally {
      setBusy(false);
    }
  };

  const uploadPhoto = async (file: File) => {
    if (!workOrderLineId || !workOrder?.id) return;

    // (Optional) scope for storage-related RLS setups
    try {
      await ensureShopContext((workOrder?.shop_id as string | null) ?? null);
    } catch (e) {
      showErr("Shop scope failed", e as { message?: string });
      return;
    }

    const path = `wo/${workOrder.id}/lines/${workOrderLineId}/${uuidv4()}_${file.name}`;
    const { error } = await supabase.storage.from("job-photos").upload(path, file, {
      contentType: file.type || "image/jpeg",
      upsert: true,
    });
    if (error) return showErr("Photo upload failed", error);
    toast.success("Photo attached");
  };

  const saveNotes = async () => {
    setSavingNotes(true);
    try {
      await ensureShopContext((workOrder?.shop_id as string | null) ?? null);

      const { error } = await supabase
        .from("work_order_lines")
        .update({
          notes: techNotes,
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", workOrderLineId);

      if (error) throw error;

      toast.success("Notes saved");
      await refresh();
    } catch (e) {
      showErr("Update notes failed", e as { message?: string });
    } finally {
      setSavingNotes(false);
    }
  };

  const startAt = line?.punched_in_at ?? null;
  const finishAt = line?.punched_out_at ?? null;

  const titleText =
    `${line?.line_no ? `#${line.line_no} ` : ""}` +
    (line?.description || line?.complaint || "Focused Job") +
    (line?.job_type ? ` — ${String(line.job_type).replaceAll("_", " ")}` : "");

  // ✅ REQUIRED BY CauseCorrectionModal: use complaint first, then description
  const lineLabel =
    (line?.complaint ?? "").trim() ||
    (line?.description ?? "").trim() ||
    (line?.line_no ? `Line #${line.line_no}` : "") ||
    "Job";

  const createdStart = startAt ? format(new Date(startAt), "PPpp") : "—";
  const createdFinish = finishAt ? format(new Date(finishAt), "PPpp") : "—";

  const completionBlocked =
    busy ||
    line?.status === "awaiting_approval" ||
    line?.status === "declined" ||
    (!!line?.approval_state && line.approval_state !== "approved");

  return (
    <>
      <Dialog
        open={isOpen}
        onClose={() => {
          closeAllSubModals();
          onClose();
        }}
        className="fixed inset-0 z-[100] flex items-center justify-center"
      >
        <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm" aria-hidden="true" />

        <div
          className="relative z-[110] mx-4 my-6 w-full max-w-5xl"
          onClick={(e) => e.stopPropagation()}
        >
          <div
            className={`rounded-lg border border-white/15 bg-neutral-950/95 p-5 text-foreground shadow-xl ${
              openAi ? "" : "max-h-[75vh] overflow-y-auto"
            }`}
          >
            <div className="mb-3 flex items-start justify-between gap-3">
              <div className="text-lg font-semibold tracking-tight">
                <span className={chip(line?.status ?? null)}>{titleText}</span>
                {workOrder ? (
                  <span className="ml-2 text-xs font-normal text-neutral-400">
                    WO #{workOrder.custom_id || workOrder.id?.slice(0, 8)}
                  </span>
                ) : null}
                {line?.status === "awaiting_approval" && (
                  <span className="ml-2 rounded border border-blue-500/80 px-2 py-0.5 text-[0.65rem] text-blue-100">
                    Awaiting approval
                  </span>
                )}
                {line?.status === "declined" && (
                  <span className="ml-2 rounded border border-red-500/80 px-2 py-0.5 text-[0.65rem] text-red-100">
                    Declined
                  </span>
                )}
              </div>

              <div className="flex items-center gap-2">
                {workOrder?.id && (
                  <button
                    type="button"
                    className="rounded-md border border-[var(--accent-copper-light)] bg-[var(--accent-copper-soft)] px-3 py-1.5 text-xs font-semibold text-black shadow-[0_0_12px_rgba(248,113,22,0.35)] hover:bg-[var(--accent-copper-light)]"
                    onClick={() => {
                      closeAllSubModals();
                      setOpenAddJob(true);
                    }}
                    disabled={busy}
                  >
                    + Job
                  </button>
                )}
                <button
                  type="button"
                  onClick={() => {
                    closeAllSubModals();
                    onClose();
                  }}
                  className="rounded-md border border-white/15 bg-black/40 px-2 py-1 text-xs text-neutral-200 hover:bg-white/5"
                  title="Close"
                >
                  ✕
                </button>
              </div>
            </div>

            {busy && !line ? (
              <div className="grid gap-3">
                <div className="h-6 w-40 animate-pulse rounded-full bg-white/5" />
                <div className="h-24 animate-pulse rounded-2xl bg-white/5" />
              </div>
            ) : !line ? (
              <div className="text-sm text-neutral-300">No job found.</div>
            ) : (
              <div className="space-y-4">
                <div className="grid gap-2 sm:grid-cols-2">
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Status
                    </div>
                    <div className={`mt-1 text-sm font-semibold ${chip(line.status ?? null)}`}>
                      {String(line.status || "awaiting").replaceAll("_", " ")}
                    </div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Start
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">{createdStart}</div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Finish
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">{createdFinish}</div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Hold Reason
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">{line.hold_reason ?? "—"}</div>
                  </div>
                </div>

                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3 text-sm">
                  <div className="grid gap-3 sm:grid-cols-2">
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Vehicle
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {vehicle
                          ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}`
                              .trim()
                              .replace(/\s+/g, " ") || "—"
                          : "—"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        VIN: {vehicle?.vin ?? "—"} • Plate: {vehicle?.license_plate ?? "—"}
                      </div>
                    </div>
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Customer
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {customer
                          ? [customer.first_name ?? "", customer.last_name ?? ""].filter(Boolean).join(" ") ||
                            "—"
                          : "—"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        {customer?.phone ?? "—"} {customer?.email ? `• ${customer.email}` : ""}
                      </div>
                    </div>
                  </div>
                </div>

                {mode === "tech" && line && line.status !== "completed" && (
                  <div className="glass-card relative z-[5] rounded-2xl border border-white/10 bg-black/40 p-3">
                    <JobPunchButton
                      lineId={line.id}
                      punchedInAt={line.punched_in_at}
                      punchedOutAt={line.punched_out_at}
                      status={line.status as WorkflowStatus}
                      onFinishRequested={() => {
                        closeAllSubModals();
                        setPrefillCause(line.cause ?? "");
                        setPrefillCorrection(line.correction ?? "");
                        setOpenComplete(true);
                      }}
                      onUpdated={refresh}
                      disabled={completionBlocked}
                    />
                    {completionBlocked && (
                      <div className="mt-2 text-[11px] text-amber-300">
                        {line.status === "awaiting_approval"
                          ? "Awaiting approval — punching disabled"
                          : line.status === "declined"
                            ? "Declined — punching disabled"
                            : line.approval_state && line.approval_state !== "approved"
                              ? "Not approved — punching disabled"
                              : ""}
                      </div>
                    )}
                  </div>
                )}

                <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                  {mode === "tech" ? (
                    <>
                      <button
                        type="button"
                        className={btnAccent}
                        onClick={() => {
                          closeAllSubModals();
                          setPrefillCause(line?.cause ?? "");
                          setPrefillCorrection(line?.correction ?? "");
                          setOpenComplete(true);
                        }}
                        disabled={completionBlocked}
                      >
                        Complete (Cause / Correction)
                      </button>

                      <button
                        type="button"
                        className={btnDanger}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenParts(true);
                        }}
                        disabled={busy}
                      >
                        Request Parts
                      </button>

                      <button
                        type="button"
                        className={btnWarn}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenHold(true);
                        }}
                        disabled={busy}
                      >
                        {line.status === "on_hold" ? "On Hold" : "Hold"}
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenPhoto(true);
                        }}
                        disabled={busy}
                      >
                        Add Photo
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>

                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          if (!vehicle?.id) {
                            toast.error("No vehicle linked to this work order yet.");
                            return;
                          }
                          setOpenComplete(false);
                          setOpenParts(false);
                          setOpenHold(false);
                          setOpenPhoto(false);
                          setOpenChat(false);
                          setOpenAddJob(false);
                          setOpenAi(false);
                          setOpenVehicleHistory(true);
                        }}
                        disabled={busy || !vehicle?.id}
                      >
                        Vehicle History
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenDtc(true);
                        }}
                        disabled={busy}
                      >
                        DTC Assist (AI)
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          if (!vehicle?.id) {
                            toast.error("No vehicle linked to this work order yet.");
                            return;
                          }
                          setOpenVehicleHistory(true);
                        }}
                        disabled={busy || !vehicle?.id}
                      >
                        Vehicle History
                      </button>
                    </>
                  )}
                </div>

                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <div className="mb-2 text-sm font-medium text-neutral-100">Parts used</div>

                  {allocsLoading ? (
                    <div className="text-sm text-neutral-300">Loading…</div>
                  ) : allocs.length === 0 ? (
                    <div className="text-sm text-neutral-300">No parts used yet.</div>
                  ) : (
                    <div className="overflow-hidden rounded-xl border border-white/10 bg-black/40">
                      <div className="grid grid-cols-12 bg-white/5 px-3 py-2 text-[11px] uppercase tracking-[0.16em] text-neutral-400">
                        <div className="col-span-7">Part</div>
                        <div className="col-span-3">Location</div>
                        <div className="col-span-2 text-right">Qty</div>
                      </div>
                      <ul className="max-h-56 overflow-auto divide-y divide-white/5">
                        {allocs.map((a) => (
                          <li
                            key={a.id}
                            className="grid grid-cols-12 items-center px-3 py-2 text-sm"
                          >
                            <div className="col-span-7 truncate text-neutral-100">
                              {a.parts?.name ?? "Part"}
                            </div>
                            <div className="col-span-3 truncate text-neutral-400">
                              {a.location_id ? `loc ${String(a.location_id).slice(0, 6)}…` : "—"}
                            </div>
                            <div className="col-span-2 text-right font-semibold text-neutral-100">
                              {a.qty}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <label className="mb-1 block text-sm font-medium text-neutral-100">Tech Notes</label>
                  <textarea
                    rows={4}
                    value={techNotes}
                    onChange={(e) => setTechNotes(e.target.value)}
                    onBlur={saveNotes}
                    disabled={savingNotes}
                    className="w-full rounded-md border border-white/15 bg-black/40 px-3 py-2 text-sm text-white placeholder:text-neutral-400 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
                    placeholder="Add notes for this job…"
                  />
                </div>

                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <h3 className="mb-2 text-sm font-medium text-neutral-100">AI Suggested Repairs</h3>
                  {line && workOrder ? (
                    <SuggestedQuickAdd
                      jobId={line.id}
                      workOrderId={workOrder.id}
                      vehicleId={vehicle?.id ?? null}
                      onAdded={async () => {
                        toast.success("Suggested line added");
                        await refresh();
                      }}
                    />
                  ) : (
                    <div className="text-sm text-neutral-300">Vehicle/work order details required.</div>
                  )}
                </div>

                <div className="text-xs text-neutral-400">
                  Job ID: {line.id}
                  {typeof line.labor_time === "number" ? ` • Labor: ${line.labor_time.toFixed(1)}h` : ""}
                  {line.hold_reason ? ` • Hold: ${line.hold_reason}` : ""}
                  {line.approval_state ? ` • Approval: ${line.approval_state}` : ""}
                </div>
              </div>
            )}
          </div>
        </div>
      </Dialog>

      {openVehicleHistory && vehicle?.id ? (
        <VehicleHistoryModal
          isOpen={openVehicleHistory}
          onClose={() => setOpenVehicleHistory(false)}
          vehicleId={vehicle.id}
          shopId={(workOrder?.shop_id as string | null) ?? null}
        />
      ) : null}

      {openComplete && line && (
        <CauseCorrectionModal
          isOpen={openComplete}
          onClose={() => setOpenComplete(false)}
          jobId={line.id}
          lineLabel={lineLabel}
          initialCause={prefillCause}
          initialCorrection={prefillCorrection}
          onSubmit={async (cause: string, correction: string) => {
            await ensureShopContext((workOrder?.shop_id as string | null) ?? null);

            const nowIso = new Date().toISOString();

            const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
              cause,
              correction,
              punched_out_at: nowIso,
              status: "completed",
            };

            if (!line.punched_in_at) update.punched_in_at = nowIso;

            const { error } = await supabase.from("work_order_lines").update(update).eq("id", line.id);

            if (error) {
              showErr("Complete job failed", error);
              throw error;
            }

            toast.success("Job completed");
            setOpenComplete(false);
            await refresh();
          }}
          onSaveDraft={async (cause: string, correction: string) => {
            await ensureShopContext((workOrder?.shop_id as string | null) ?? null);

            const { error } = await supabase
              .from("work_order_lines")
              .update({
                cause,
                correction,
              } as DB["public"]["Tables"]["work_order_lines"]["Update"])
              .eq("id", line.id);

            if (error) {
              showErr("Save story failed", error);
              throw error;
            }

            toast.success("Story saved");
            await refresh();
          }}
        />
      )}

      {openParts && workOrder?.id && line && (
        <PartsRequestModal
          isOpen={openParts}
          workOrderId={workOrder.id}
          jobId={line.id}
          requestNote={line.description ?? ""}
        />
      )}

      {openHold && line && (
        <HoldModal
          isOpen={openHold}
          onClose={() => setOpenHold(false)}
          onApply={applyHold}
          onRelease={line.hold_reason ? releaseHold : undefined}
          canRelease={!!line.hold_reason}
          defaultReason={line.hold_reason || "Awaiting parts"}
        />
      )}

      {openPhoto && (
        <PhotoCaptureModal isOpen={openPhoto} onClose={() => setOpenPhoto(false)} onCapture={uploadPhoto} />
      )}

      {openChat && (
        <NewChatModal
          isOpen={openChat}
          onClose={() => setOpenChat(false)}
          created_by="system"
          onCreated={() => setOpenChat(false)}
          context_type="work_order_line"
          context_id={line?.id ?? null}
        />
      )}

      {openAi && (
        <AIAssistantModal
          isOpen={openAi}
          onClose={() => setOpenAi(false)}
          workOrderLineId={line?.id ?? undefined}
          defaultVehicle={
            vehicle
              ? {
                  year: vehicle.year ? String(vehicle.year) : undefined,
                  make: vehicle.make ?? undefined,
                  model: vehicle.model ?? undefined,
                }
              : undefined
          }
        />
      )}

      {openAddJob && workOrder?.id && (
        <AddJobModal
          isOpen={openAddJob}
          onClose={() => setOpenAddJob(false)}
          workOrderId={workOrder.id}
          vehicleId={vehicle?.id ?? null}
          techId={
            (line as unknown as { assigned_tech_id?: string | null })?.assigned_tech_id ?? "system"
          }
          shopId={workOrder?.shop_id ?? null}
          onJobAdded={async () => {
            await refresh();
            setOpenAddJob(false);
          }}
        />
      )}
    </>
  );
}

==================== FILE: features/work-orders/components/workorders/HoldModal.tsx ====================

"use client";

import { useEffect, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

const HOLD_REASONS = [
  "Awaiting customer authorization",
  "Awaiting parts",
  "Need additional info",
  "Hold for assistance",
  "Foreman hold",
  "Lead hand hold",
] as const;

type HoldReason = (typeof HOLD_REASONS)[number];

interface HoldModalProps {
  isOpen: boolean;
  onClose: () => void;
  onApply: (
    reason: string,
    notes?: string,
    holdUntil?: string | null,
  ) => Promise<void> | void;
  onRelease?: () => Promise<void> | void;
  canRelease?: boolean;
  defaultReason?: string;
  defaultNotes?: string;
  defaultHoldUntil?: string | null;
}

export default function HoldModal({
  isOpen,
  onClose,
  onApply,
  onRelease,
  canRelease = false,
  defaultReason = "Awaiting parts",
  defaultNotes = "",
  defaultHoldUntil = null,
}: HoldModalProps) {
  const [reason, setReason] = useState<string>(defaultReason);
  const [notes, setNotes] = useState<string>(defaultNotes);

  const [autoRelease, setAutoRelease] = useState<boolean>(false);
  const [releaseAfterMinutes, setReleaseAfterMinutes] = useState<number>(60);
  const [releaseAt, setReleaseAt] = useState<string>("");

  const [holdPlacedAt, setHoldPlacedAt] = useState<string>("");

  useEffect(() => {
    if (!isOpen) return;

    setReason(defaultReason);
    setNotes(defaultNotes);
    setHoldPlacedAt(new Date().toLocaleString());

    if (defaultHoldUntil) {
      setAutoRelease(true);
      const dt = new Date(defaultHoldUntil);
      if (!Number.isNaN(dt.getTime())) {
        setReleaseAt(toLocalDatetime(dt));
      } else {
        setReleaseAt("");
      }
    } else {
      setAutoRelease(false);
      setReleaseAfterMinutes(60);
      setReleaseAt("");
    }
  }, [isOpen, defaultReason, defaultNotes, defaultHoldUntil]);

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="PLACE / UPDATE HOLD"
      size="sm"
      footerLeft={
        canRelease ? (
          <button
            type="button"
            className="inline-flex items-center gap-1 rounded-full border border-red-500/80 bg-red-500/10 px-3 py-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-red-100 hover:bg-red-500/20"
            onClick={() => Promise.resolve(onRelease?.()).then(onClose)}
          >
            <span>●</span>
            <span>Release hold</span>
          </button>
        ) : null
      }
      onSubmit={async () => {
        let holdUntil: string | null = null;

        if (autoRelease) {
          if (releaseAt) {
            const d = new Date(releaseAt);
            if (!Number.isNaN(d.getTime())) {
              holdUntil = d.toISOString();
            }
          } else if (releaseAfterMinutes > 0) {
            const d = new Date();
            d.setMinutes(d.getMinutes() + releaseAfterMinutes);
            holdUntil = d.toISOString();
          }
        }

        await onApply(reason, notes, holdUntil);
        onClose();
      }}
      submitText="Apply Hold"
    >
      <div className="space-y-4">
        <p className="text-[0.8rem] text-neutral-300">
          Park this job with a clear reason so advisors and techs know why it&apos;s
          on hold.
        </p>

        {/* Reason */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-400">
            Reason
          </label>
          <div className="relative">
            <select
              className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/70 px-3 py-2 text-sm text-neutral-100 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            >
              {HOLD_REASONS.map((r) => (
                <option key={r} value={r}>
                  {r}
                </option>
              ))}
              {!HOLD_REASONS.includes(reason as HoldReason) && (
                <option value={reason}>{reason}</option>
              )}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-neutral-500">
              ▼
            </div>
          </div>
        </div>

        {/* Notes */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-400">
            Notes
          </label>
          <textarea
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/70 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="Optional notes for this hold…"
          />
        </div>

        {/* Auto-release card */}
        <div className="rounded-xl border border-[var(--metal-border-soft)] bg-black/50 px-3 py-3 shadow-[0_12px_30px_rgba(0,0,0,0.75)]">
          <div className="mb-2 flex items-center justify-between text-[0.7rem] text-neutral-400">
            <span>
              Hold placed at:{" "}
              <span className="text-neutral-100">{holdPlacedAt || "—"}</span>
            </span>
          </div>

          <label className="inline-flex items-center gap-2 text-[0.7rem] text-neutral-100">
            <input
              type="checkbox"
              checked={autoRelease}
              onChange={(e) => setAutoRelease(e.target.checked)}
              className="h-4 w-4 rounded border-[var(--metal-border-soft)] bg-black text-[var(--accent-copper-soft)] focus:ring-[var(--accent-copper-soft)]"
            />
            Auto-release this hold
          </label>

          {autoRelease && (
            <div className="mt-3 space-y-3 text-[0.75rem]">
              <div className="flex flex-wrap items-center gap-2">
                <label className="text-neutral-400">
                  After (minutes)
                </label>
                <input
                  type="number"
                  min={5}
                  step={5}
                  value={releaseAfterMinutes}
                  onChange={(e) =>
                    setReleaseAfterMinutes(Number(e.target.value) || 0)
                  }
                  className="w-24 rounded-md border border-[var(--metal-border-soft)] bg-black/70 px-2 py-1 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/70"
                  disabled={releaseAt !== ""}
                />
                <span className="text-[0.65rem] text-neutral-500">
                  Leave empty if using a specific date/time.
                </span>
              </div>

              <div>
                <label className="mb-1 block text-[0.7rem] text-neutral-400">
                  Or release at date / time
                </label>
                <input
                  type="datetime-local"
                  value={releaseAt}
                  onChange={(e) => setReleaseAt(e.target.value)}
                  className="w-full rounded-md border border-[var(--metal-border-soft)] bg-black/70 px-2 py-1 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/70"
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </ModalShell>
  );
}

function toLocalDatetime(d: Date): string {
  const pad = (n: number) => n.toString().padStart(2, "0");
  const year = d.getFullYear();
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hour = pad(d.getHours());
  const minute = pad(d.getMinutes());
  return `${year}-${month}-${day}T${hour}:${minute}`;
}

==================== FILE: features/work-orders/components/workorders/LinePartsSummary.tsx ====================

// features/work-orders/components/workorders/LinePartsSummary.tsx (FULL FILE REPLACEMENT)
// No unused vars. No `any`. Reads part_request_items for a given work_order_line_id.

"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type PartRequestItemRow = DB["public"]["Tables"]["part_request_items"]["Row"];

type Props = {
  workOrderLineId: string;
};

type Summary = {
  requested: number;
  approved: number;
  reserved: number;
  received: number;
};

function num(v: unknown): number {
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

export default function LinePartsSummary({ workOrderLineId }: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [s, setS] = useState<Summary>({
    requested: 0,
    approved: 0,
    reserved: 0,
    received: 0,
  });

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!workOrderLineId) return;

      const { data, error } = await supabase
        .from("part_request_items")
        .select(
          "id, qty, qty_requested, qty_approved, qty_reserved, qty_received, work_order_line_id",
        )
        .eq("work_order_line_id", workOrderLineId);

      if (error) return;
      if (cancelled) return;

      const rows = (data ?? []) as Array<
        PartRequestItemRow & {
          qty_requested?: number | null;
          qty_approved?: number | null;
          qty_reserved?: number | null;
          qty_received?: number | null;
        }
      >;

      const next: Summary = rows.reduce(
        (acc, r) => {
          acc.requested += num(r.qty_requested ?? r.qty);
          acc.approved += num(r.qty_approved);
          acc.reserved += num(r.qty_reserved);
          acc.received += num(r.qty_received);
          return acc;
        },
        { requested: 0, approved: 0, reserved: 0, received: 0 },
      );

      setS(next);
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase, workOrderLineId]);

  const pill = (k: "req" | "app" | "res" | "rcv") =>
    ({
      req: "rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs text-neutral-200",
      app: "rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs text-neutral-200",
      res: "rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs text-neutral-200",
      rcv: "rounded-full border border-white/10 bg-black/50 px-3 py-1 text-xs text-neutral-200",
    })[k];

  const isReady =
    s.approved > 0 && s.reserved >= s.approved && s.received >= s.approved;

  return (
    <div className="mt-2 flex flex-wrap items-center gap-2">
      <span className={pill("req")}>Req {s.requested}</span>
      <span className={pill("app")}>App {s.approved}</span>
      <span className={pill("res")}>Res {s.reserved}</span>
      <span className={pill("rcv")}>Rcv {s.received}</span>

      {isReady ? (
        <span className="rounded-full border border-emerald-500/40 bg-emerald-500/10 px-3 py-1 text-xs text-emerald-200">
          Ready
        </span>
      ) : null}
    </div>
  );
}

==================== FILE: features/work-orders/components/workorders/PartsRequestModal.tsx ====================

// /features/work-orders/components/workorders/PartsRequestModal.tsx (FULL FILE REPLACEMENT)
"use client";

import { useEffect, useMemo, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Item = { id: string; description: string; qty: string };

type Props = {
  isOpen: boolean;

  /** IDs used for API payload + lookups */
  workOrderId: string;
  jobId: string;

  /** optional prefilled note */
  requestNote?: string | null;

  closeEventName?: string;
  submittedEventName?: string;
};

type SubmittedDetail = {
  requestId: string;
  workOrderId: string;
  jobId: string;
};

type WorkOrderLite = Pick<
  DB["public"]["Tables"]["work_orders"]["Row"],
  "id" | "custom_id"
>;

type WorkOrderLineLite = Pick<
  DB["public"]["Tables"]["work_order_lines"]["Row"],
  "id" | "complaint" | "description"
>;

export default function PartsRequestModal({
  isOpen,
  workOrderId,
  jobId,
  requestNote = "",
  closeEventName = "parts-request:close",
  submittedEventName = "parts-request:submitted",
}: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [headerNotes, setHeaderNotes] = useState(requestNote ?? "");
  const [rows, setRows] = useState<Item[]>([
    { id: crypto.randomUUID(), description: "", qty: "1" },
  ]);
  const [submitting, setSubmitting] = useState(false);

  // ✅ header labels
  const [woLabel, setWoLabel] = useState<string>("");
  const [jobLabel, setJobLabel] = useState<string>("");

  useEffect(() => {
    if (!isOpen) return;

    setHeaderNotes(requestNote ?? "");
    setRows([{ id: crypto.randomUUID(), description: "", qty: "1" }]);

    setWoLabel("");
    setJobLabel("");

    (async () => {
      // Work order custom id
      if (workOrderId) {
        const { data } = await supabase
          .from("work_orders")
          .select("id, custom_id")
          .eq("id", workOrderId)
          .maybeSingle();

        const wo = data as WorkOrderLite | null;
        setWoLabel(wo?.custom_id ?? workOrderId);
      }

      // Job line complaint/description
      if (jobId) {
        const { data } = await supabase
          .from("work_order_lines")
          .select("id, complaint, description")
          .eq("id", jobId)
          .maybeSingle();

        const line = data as WorkOrderLineLite | null;
        const label =
          (line?.complaint ?? "").trim() ||
          (line?.description ?? "").trim() ||
          jobId;

        setJobLabel(label);
      }
    })();
  }, [isOpen, requestNote, supabase, workOrderId, jobId]);

  const addRow = () =>
    setRows((r) => [...r, { id: crypto.randomUUID(), description: "", qty: "1" }]);

  const removeRow = (id: string) =>
    setRows((r) => (r.length > 1 ? r.filter((x) => x.id !== id) : r));

  const setCell = (id: string, patch: Partial<Item>) =>
    setRows((r) => r.map((x) => (x.id === id ? { ...x, ...patch } : x)));

  // ✅ parse qty safely (allows empty while editing)
  const validItems = rows
    .map((r) => {
      const description = r.description.trim();
      const n = Number.parseInt(r.qty, 10);
      const qty = Number.isFinite(n) ? n : 0;
      return { description, qty };
    })
    .filter((i) => i.description && i.qty > 0);

  const emit = (name: string, detail?: unknown) => {
    if (typeof window !== "undefined") {
      window.dispatchEvent(
        new CustomEvent(name, detail ? { detail } : undefined),
      );
    }
  };

  async function submit() {
    if (submitting) return;

    if (!workOrderId || !jobId) {
      toast.error("Missing work order or job id.");
      return;
    }

    if (validItems.length === 0) {
      toast.error("Add at least one line (description + qty).");
      return;
    }

    setSubmitting(true);

    try {
      const res = await fetch("/api/parts/requests/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          jobId,
          notes: headerNotes || undefined,
          items: validItems,
        }),
      });

      const raw = await res.text();
      let json: { requestId?: string; error?: string } | null = null;
      try {
        json = raw
          ? (JSON.parse(raw) as { requestId?: string; error?: string })
          : null;
      } catch {
        /* ignore */
      }

      if (!res.ok || !json?.requestId) {
        const msg = json?.error || raw || `Request failed with status ${res.status}`;
        toast.error(`Parts request failed: ${msg}`);
        return;
      }

      toast.success("Parts request sent.");

      const detail: SubmittedDetail = {
        requestId: json.requestId,
        workOrderId,
        jobId,
      };

      emit(submittedEventName, detail);
      emit(closeEventName);
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "Unable to submit request");
    } finally {
      setSubmitting(false);
    }
  }

  if (!isOpen) return null;

  const woDisplay = woLabel || workOrderId;
  const jobDisplay = jobLabel || jobId;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={() => emit(closeEventName)}
      title="REQUEST PARTS"
      size="lg"
      onSubmit={submit}
      submitText={submitting ? "Submitting…" : "Submit to Parts"}
    >
      <div className="space-y-4">
        {/* Header meta */}
        <div className="flex flex-col gap-2 text-[0.7rem] text-neutral-400 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex min-w-0 flex-wrap items-center gap-2">
            <span className="font-semibold uppercase tracking-[0.18em] text-neutral-300">
              Work order
            </span>
            <span
              className="max-w-[60vw] truncate rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 font-mono text-[0.7rem] text-neutral-100 sm:max-w-[340px]"
              title={woDisplay}
            >
              {woDisplay}
            </span>
          </div>

          <div className="flex min-w-0 flex-wrap items-center gap-2">
            <span className="font-semibold uppercase tracking-[0.18em] text-neutral-300">
              Job
            </span>
            <span
              className="max-w-[60vw] truncate rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[0.75rem] font-medium text-neutral-100 sm:max-w-[420px]"
              title={jobDisplay}
            >
              {jobDisplay}
            </span>
          </div>
        </div>

        {/* Note to parts */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Note to parts (optional)
          </label>
          <textarea
            rows={2}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={headerNotes}
            onChange={(e) => setHeaderNotes(e.target.value)}
            placeholder="Anything they should know before filling this request…"
          />
        </div>

        {/* Items grid */}
        <div className="overflow-hidden rounded-2xl border border-[var(--metal-border-soft)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.85)]">
          {/* Header row */}
          <div className="grid grid-cols-12 bg-gradient-to-r from-slate-900/90 via-slate-950 to-black px-3 py-2 text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
            <div className="col-span-8">Description*</div>
            <div className="col-span-3 text-right">Qty*</div>
            <div className="col-span-1 text-center"> </div>
          </div>

          {/* Rows */}
          <div className="max-h-64 overflow-auto bg-black/70">
            {rows.map((r) => (
              <div
                key={r.id}
                className="grid grid-cols-12 gap-2 border-t border-white/5 px-3 py-2"
              >
                <input
                  className="col-span-8 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.description}
                  onChange={(e) => setCell(r.id, { description: e.target.value })}
                  placeholder="e.g. rear pads, serp belt…"
                />

                {/* ✅ FIX: allow clearing without snapping back to 1 */}
                <input
                  inputMode="numeric"
                  pattern="[0-9]*"
                  className="col-span-3 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-right text-sm text-neutral-100 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.qty}
                  onChange={(e) => {
                    // keep only digits, allow empty while editing
                    const next = e.target.value.replace(/[^\d]/g, "");
                    setCell(r.id, { qty: next });
                  }}
                  onBlur={() => {
                    // normalize on blur
                    const n = Number.parseInt(r.qty, 10);
                    const normalized = Number.isFinite(n) && n > 0 ? String(n) : "1";
                    setCell(r.id, { qty: normalized });
                  }}
                  aria-label="Quantity"
                />

                <div className="col-span-1 flex items-center justify-center">
                  <button
                    className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/70 text-[0.7rem] text-neutral-300 transition hover:bg-red-500/20 hover:text-red-200 disabled:opacity-40 disabled:hover:bg-black/70 disabled:hover:text-neutral-300"
                    onClick={() => removeRow(r.id)}
                    disabled={rows.length <= 1}
                    title={rows.length <= 1 ? "At least one row is required" : "Remove row"}
                    type="button"
                  >
                    ✕
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Add row footer */}
          <div className="border-t border-white/5 bg-black/80 px-3 py-2">
            <button
              className="inline-flex items-center gap-1 rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[0.7rem] font-medium uppercase tracking-[0.16em] text-neutral-100 transition hover:border-[var(--accent-copper-soft)] hover:bg-[var(--accent-copper-faint)] hover:text-[var(--accent-copper-soft)]"
              onClick={addRow}
              type="button"
            >
              <span>+</span>
              <span>Add item</span>
            </button>
          </div>
        </div>

        <p className="text-[0.7rem] text-neutral-500">
          Only lines with a description and quantity &gt; 0 will be sent.
        </p>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/VehicleHistoryModal.tsx ====================

// features/work-orders/components/workorders/extras/VehicleHistoryModal.tsx
"use client";

import Link from "next/link";
import { Dialog } from "@headlessui/react";
import { useCallback, useEffect, useMemo, useRef, useState } from "react";
import { format } from "date-fns";
import { usePathname, useSearchParams } from "next/navigation";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Allocation = DB["public"]["Tables"]["work_order_part_allocations"]["Row"];
type Part = DB["public"]["Tables"]["parts"]["Row"];

type Row = Pick<
  WorkOrder,
  "id" | "custom_id" | "updated_at" | "created_at" | "customer_id" | "shop_id"
> & {
  customers?: Pick<Customer, "first_name" | "last_name" | "email" | "phone"> | null;
  partsSummary?: string;
};

function fmtCustomerName(c: Row["customers"]): string {
  if (!c) return "—";
  const name = [c.first_name ?? "", c.last_name ?? ""].filter(Boolean).join(" ").trim();
  return name.length ? name : "—";
}

function fmtDateShort(iso: string | null | undefined): string {
  if (!iso) return "—";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "—";
  return format(d, "PP");
}

function woLabel(r: Row): string {
  const c = (r.custom_id ?? "").trim();
  if (c) return `WO ${c}`;
  return `WO ${String(r.id).slice(0, 8)}…`;
}

export default function VehicleHistoryModal(props: {
  isOpen: boolean;
  onClose: () => void;
  vehicleId: string;
  shopId: string | null;
}): JSX.Element {
  const { isOpen, onClose, vehicleId, shopId } = props;

  const pathname = usePathname();
  const searchParams = useSearchParams();

  const supabase = useMemo(() => createBrowserSupabase(), []);
  const lastSetShopId = useRef<string | null>(null);

  const [loading, setLoading] = useState(false);
  const [err, setErr] = useState<string | null>(null);
  const [rows, setRows] = useState<Row[]>([]);
  const [q, setQ] = useState("");

  const ensureShopContext = useCallback(
    async (id: string | null) => {
      if (!id) return;
      if (lastSetShopId.current === id) return;

      const { error } = await supabase.rpc("set_current_shop_id", { p_shop_id: id });
      if (error) {
        lastSetShopId.current = null;
        throw error;
      }
      lastSetShopId.current = id;
    },
    [supabase],
  );

  const buildReturnUrl = useCallback((): string => {
    const sp = new URLSearchParams(searchParams.toString());
    sp.set("vh", "1");
    sp.set("vh_vehicle", vehicleId);
    if (shopId) sp.set("vh_shop", shopId);
    const qs = sp.toString();
    return qs ? `${pathname}?${qs}` : pathname;
  }, [pathname, searchParams, vehicleId, shopId]);

  const load = useCallback(async () => {
    if (!vehicleId) return;

    setLoading(true);
    setErr(null);

    try {
      if (shopId) {
        try {
          await ensureShopContext(shopId);
        } catch (e) {
          // eslint-disable-next-line no-console
          console.warn("[VehicleHistoryModal] set_current_shop_id failed:", e);
        }
      }

      // 1) Work orders for this vehicle
      let woQuery = supabase
        .from("work_orders")
        .select(
          "id, custom_id, updated_at, created_at, customer_id, shop_id, customers:customers(first_name,last_name,email,phone)",
        )
        .eq("vehicle_id", vehicleId)
        .order("updated_at", { ascending: false })
        .limit(50);

      if (shopId) woQuery = woQuery.eq("shop_id", shopId);

      const { data: woData, error: woErr } = await woQuery;
      if (woErr) throw woErr;

      const woList = (Array.isArray(woData) ? woData : []) as unknown as Row[];
      const woIds = woList.map((w) => w.id).filter((id): id is string => typeof id === "string");

      if (woIds.length === 0) {
        setRows([]);
        setLoading(false);
        return;
      }

      // 2) Completed lines (this defines "history")
      const { data: lineData, error: lineErr } = await supabase
        .from("work_order_lines")
        .select("id, work_order_id, status, complaint, description")
        .in("work_order_id", woIds)
        .eq("status", "completed");

      if (lineErr) throw lineErr;

      const lines = (Array.isArray(lineData) ? lineData : []) as unknown as WorkOrderLine[];
      const completedWoIds = new Set(
        lines
          .map((l) => l.work_order_id)
          .filter((id): id is string => typeof id === "string"),
      );

      // If no completed lines, show nothing (per your request)
      if (completedWoIds.size === 0) {
        setRows([]);
        setLoading(false);
        return;
      }

      const filteredByCompleted = woList.filter((w) => completedWoIds.has(w.id));

      // 3) Parts used: allocations by those completed lines
      const lineIds = lines.map((l) => l.id).filter((id): id is string => typeof id === "string");

      const lineIdToWoId = new Map<string, string>();
      for (const l of lines) {
        if (typeof l.id === "string" && typeof l.work_order_id === "string") {
          lineIdToWoId.set(l.id, l.work_order_id);
        }
      }

      const { data: allocData, error: allocErr } = lineIds.length
        ? await supabase
            .from("work_order_part_allocations")
            .select("work_order_line_id, qty, part_id")
            .in("work_order_line_id", lineIds)
        : { data: [], error: null };

      if (allocErr) throw allocErr;

      const allocs = (Array.isArray(allocData) ? allocData : []) as unknown as Allocation[];
      const partIds = Array.from(
        new Set(allocs.map((a) => a.part_id).filter((id): id is string => typeof id === "string")),
      );

      const { data: partsData, error: partsErr } = partIds.length
        ? await supabase.from("parts").select("id, name").in("id", partIds)
        : { data: [], error: null };

      if (partsErr) throw partsErr;

      const parts = (Array.isArray(partsData) ? partsData : []) as unknown as Part[];
      const partNameById = new Map<string, string>();
      for (const p of parts) {
        if (typeof p.id === "string") partNameById.set(p.id, (p.name ?? "").toString());
      }

      // Aggregate per work order
      const woPartCounts = new Map<string, Map<string, number>>();
      for (const a of allocs) {
        const lineId = (a as unknown as { work_order_line_id?: string | null }).work_order_line_id ?? null;
        const partId = (a.part_id ?? null) as string | null;
        const qty = typeof a.qty === "number" && Number.isFinite(a.qty) ? a.qty : 1;

        if (!lineId || !partId) continue;

        const woId = lineIdToWoId.get(lineId);
        if (!woId) continue;

        const name = (partNameById.get(partId) ?? "").trim();
        if (!name) continue;

        const perWo = woPartCounts.get(woId) ?? new Map<string, number>();
        perWo.set(name, (perWo.get(name) ?? 0) + qty);
        woPartCounts.set(woId, perWo);
      }

      const withParts: Row[] = filteredByCompleted.map((w) => {
        const m = woPartCounts.get(w.id);
        if (!m || m.size === 0) return { ...w, partsSummary: "—" };

        // top 3, then +N more
        const pairs = Array.from(m.entries()).sort((a, b) => b[1] - a[1]);
        const top = pairs.slice(0, 3).map(([name, qty]) => `${qty}× ${name}`);
        const more = pairs.length > 3 ? ` +${pairs.length - 3} more` : "";
        return { ...w, partsSummary: `${top.join(", ")}${more}` };
      });

      // Search filter (no status now)
      const qlc = q.trim().toLowerCase();
      const searched = qlc
        ? withParts.filter((r) => {
            const cid = (r.custom_id ?? "").toLowerCase();
            const id = (r.id ?? "").toLowerCase();
            const cust = fmtCustomerName(r.customers ?? null).toLowerCase();
            const email = (r.customers?.email ?? "").toLowerCase();
            const phone = (r.customers?.phone ?? "").toLowerCase();
            const partsSummary = (r.partsSummary ?? "").toLowerCase();
            return (
              id.includes(qlc) ||
              cid.includes(qlc) ||
              cust.includes(qlc) ||
              email.includes(qlc) ||
              phone.includes(qlc) ||
              partsSummary.includes(qlc)
            );
          })
        : withParts;

      setRows(searched);
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Failed to load history.";
      setErr(msg);
      setRows([]);
    } finally {
      setLoading(false);
    }
  }, [vehicleId, shopId, supabase, q, ensureShopContext]);

  useEffect(() => {
    if (!isOpen) return;
    void load();
  }, [isOpen, load]);

  const returnUrl = buildReturnUrl();

  return (
    <Dialog
      open={isOpen}
      onClose={onClose}
      className="fixed inset-0 z-[120] flex items-center justify-center"
    >
      <div className="fixed inset-0 z-[120] bg-black/70 backdrop-blur-sm" aria-hidden="true" />

      <div
        className="relative z-[130] mx-4 my-6 w-full max-w-5xl"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="rounded-2xl border border-white/15 bg-neutral-950/95 p-4 text-white shadow-xl">
          <div className="mb-3 flex items-start justify-between gap-3">
            <div className="min-w-0">
              <div className="text-sm font-semibold uppercase tracking-[0.18em] text-neutral-200">
                Vehicle History
              </div>
              <div className="mt-1 text-[11px] text-neutral-500">
                Showing work orders with completed lines {shopId ? "for this shop" : ""}.
              </div>
            </div>

            <button
              type="button"
              onClick={onClose}
              className="rounded-md border border-white/15 bg-black/40 px-2 py-1 text-xs text-neutral-200 hover:bg-white/5"
              title="Close"
            >
              ✕
            </button>
          </div>

          <div className="mb-3 flex flex-wrap items-end gap-2">
            <div className="min-w-[240px] flex-1">
              <label className="mb-1 block text-[11px] font-medium uppercase tracking-[0.18em] text-neutral-400">
                Search
              </label>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && load()}
                placeholder="Custom ID, customer, parts…"
                className="w-full rounded-lg border border-white/10 bg-black/60 px-3 py-1.5 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
              />
            </div>

            <button
              type="button"
              onClick={load}
              className="rounded-full border border-white/10 bg-black/60 px-3 py-1.5 text-[11px] font-medium uppercase tracking-[0.16em] text-neutral-100 hover:border-[var(--accent-copper-soft)] hover:bg-black/70"
            >
              Refresh
            </button>
          </div>

          {err ? (
            <div className="rounded-xl border border-red-500/60 bg-red-950/60 px-4 py-3 text-sm text-red-100">
              {err}
            </div>
          ) : loading ? (
            <div className="rounded-xl border border-white/10 bg-black/40 px-4 py-3 text-sm text-neutral-300">
              Loading…
            </div>
          ) : rows.length === 0 ? (
            <div className="rounded-xl border border-dashed border-white/12 bg-black/30 px-4 py-3 text-sm text-neutral-300">
              No completed history found for this vehicle.
            </div>
          ) : (
            <div className="max-h-[60vh] overflow-auto rounded-xl border border-white/10 bg-black/35">
              <div className="grid grid-cols-12 bg-white/5 px-3 py-2 text-[11px] uppercase tracking-[0.16em] text-neutral-400">
                <div className="col-span-3">Work Order</div>
                <div className="col-span-3">Customer</div>
                <div className="col-span-4">Parts used</div>
                <div className="col-span-2 text-right">Updated</div>
              </div>

              <ul className="divide-y divide-white/5">
                {rows.map((r) => {
                  const updatedIso = r.updated_at ?? r.created_at ?? null;
                  const updated = fmtDateShort(updatedIso);

                  const href = `/work-orders/view/${r.id}?return=${encodeURIComponent(returnUrl)}`;

                  return (
                    <li key={r.id} className="grid grid-cols-12 items-center gap-2 px-3 py-2 text-sm">
                      <div className="col-span-3 min-w-0">
                        <Link
                          href={href}
                          className="truncate font-mono text-[var(--accent-copper-light)] underline decoration-transparent underline-offset-2 hover:decoration-[var(--accent-copper-soft)]"
                        >
                          {woLabel(r)}
                        </Link>
                        <div className="mt-0.5 truncate text-[11px] text-neutral-500">
                          {String(r.id).slice(0, 8)}…
                        </div>
                      </div>

                      <div className="col-span-3 min-w-0">
                        <div className="truncate text-neutral-200">
                          {fmtCustomerName(r.customers ?? null)}
                        </div>
                        <div className="mt-0.5 truncate text-[11px] text-neutral-500">
                          {(r.customers?.email ?? "").toString() || "—"}
                        </div>
                      </div>

                      <div className="col-span-4 min-w-0">
                        <div className="truncate text-[12px] text-neutral-200" title={r.partsSummary ?? "—"}>
                          {r.partsSummary ?? "—"}
                        </div>
                      </div>

                      <div className="col-span-2 text-right text-[11px] text-neutral-400">
                        {updated}
                      </div>
                    </li>
                  );
                })}
              </ul>
            </div>
          )}

          <div className="mt-3 text-[11px] text-neutral-500">
            This list links to:{" "}
            <span className="font-mono text-neutral-300">/work-orders/view/[id]</span>{" "}
            with a <span className="font-mono text-neutral-300">return=</span> that can reopen this modal.
          </div>
        </div>
      </div>
    </Dialog>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/AssignTechModal.tsx ====================

"use client";

import { useEffect, useMemo, useState } from "react";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import ModalShell from "@/features/shared/components/ModalShell";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

interface Assignable {
  id: string;
  full_name: string | null;
  role: string | null;
}

interface Props {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId: string;
  initialMechanics?: Assignable[];
  mechanics?: Assignable[];
  onAssigned?: (techId: string) => void | Promise<void>;
}

export default function AssignTechModal({
  isOpen,
  onClose,
  workOrderLineId,
  initialMechanics,
  mechanics,
  onAssigned,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);
  const [users, setUsers] = useState<Assignable[]>(() => mechanics ?? initialMechanics ?? []);
  const [techId, setTechId] = useState<string>("");
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    if (!isOpen) return;

    const pref = mechanics ?? initialMechanics;
    if (pref && pref.length) {
      setUsers(pref);
      return;
    }

    (async () => {
      // try API first
      try {
        const res = await fetch("/api/assignables");
        const json = (await res.json().catch(() => null)) as { data?: Assignable[] } | null;
        if (res.ok && Array.isArray(json?.data)) {
          setUsers(json.data);
          return;
        }
      } catch {
        // fall through
      }

      // fallback to profiles query
      const { data } = await supabase
        .from("profiles")
        .select("id, full_name, role")
        .in("role", ["mechanic", "tech", "foreman", "lead_hand"])
        .order("full_name", { ascending: true });

      setUsers((data as Assignable[]) ?? []);
    })();
  }, [isOpen, mechanics, initialMechanics, supabase]);

  const submit = async () => {
    if (submitting) return;

    if (!techId) {
      onClose();
      return;
    }

    setSubmitting(true);
    try {
      // Prefer API route if available
      const res = await fetch("/api/work-orders/assign-line", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          work_order_line_id: workOrderLineId,
          tech_id: techId,
        }),
      });

      if (!res.ok) {
        // ✅ Correct DB column (NOT assigned_to)
        const { error } = await supabase
          .from("work_order_lines")
          .update(
            { assigned_tech_id: techId } as DB["public"]["Tables"]["work_order_lines"]["Update"],
          )
          .eq("id", workOrderLineId);

        if (error) throw error;
      }

      // Optional: also keep join table in sync (ignore if blocked/missing)
      try {
        await supabase
          .from("work_order_line_technicians")
          .upsert(
            { work_order_line_id: workOrderLineId, technician_id: techId },
            { onConflict: "work_order_line_id,technician_id" },
          );
      } catch {
        // ignore
      }

      toast.success("Mechanic assigned.");
      await onAssigned?.(techId);
      onClose();
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Failed to assign mechanic.";
      toast.error(msg);
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Assign mechanic"
      submitText={submitting ? "Assigning…" : "Assign"}
      size="sm"
    >
      <label className="block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Choose mechanic
        </span>
        <select
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          value={techId}
          onChange={(e) => setTechId(e.target.value)}
        >
          <option value="">Select…</option>
          {users.map((u) => (
            <option key={u.id} value={u.id}>
              {u.full_name ?? "(no name)"} {u.role ? `(${u.role})` : ""}
            </option>
          ))}
        </select>
      </label>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/CostEstimateModal.tsx ====================

// features/work-orders/components/workorders/CostEstimateModal.tsx
"use client";

import { useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  defaultLaborHours?: number | null;
  defaultPrice?: number | null;
  onApply: (laborHours: number | null, price: number | null) => void | Promise<void>;
}

export default function CostEstimateModal({
  isOpen,
  onClose,
  defaultLaborHours = null,
  defaultPrice = null,
  onApply,
}: Props) {
  const [labor, setLabor] = useState<string>(
    typeof defaultLaborHours === "number" ? String(defaultLaborHours) : "",
  );
  const [price, setPrice] = useState<string>(
    typeof defaultPrice === "number" ? String(defaultPrice) : "",
  );
  const [submitting, setSubmitting] = useState(false);

  const submit = async () => {
    if (submitting) return;
    setSubmitting(true);
    try {
      const lh = labor.trim() ? Number(labor) : null;
      const pr = price.trim() ? Number(price) : null;
      await onApply(lh, pr);
      onClose();
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Cost / Estimate"
      submitText={submitting ? "Saving…" : "Save"}
      size="sm"
    >
      <div className="grid gap-3 sm:grid-cols-2">
        <label className="block text-sm">
          <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
            Labor (hrs)
          </span>
          <input
            type="number"
            step="0.1"
            min="0"
            value={labor}
            onChange={(e) => setLabor(e.target.value)}
            className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
            placeholder="e.g. 1.5"
          />
        </label>
        <label className="block text-sm">
          <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
            Price ($)
          </span>
          <input
            type="number"
            step="1"
            min="0"
            value={price}
            onChange={(e) => setPrice(e.target.value)}
            className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
            placeholder="e.g. 250"
          />
        </label>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/CustomerContactModal.tsx ====================

// features/work-orders/components/workorders/CustomerContactModal.tsx
"use client";

import { useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  customerName?: string | null;
  customerEmail?: string | null;
  customerPhone?: string | null;
  onSendEmail?: (subject: string, body: string) => void | Promise<void>;
  onSendSms?: (message: string) => void | Promise<void>;
}

export default function CustomerContactModal({
  isOpen,
  onClose,
  customerName,
  customerEmail,
  customerPhone,
  onSendEmail,
  onSendSms,
}: Props) {
  const [subject, setSubject] = useState("");
  const [body, setBody] = useState("");
  const [sms, setSms] = useState("");
  const [sendingSms, setSendingSms] = useState(false);
  const [sendingEmail, setSendingEmail] = useState(false);

  const canSendEmail = !!onSendEmail && (subject.trim() || body.trim());
  const canSendSms = !!onSendSms && sms.trim().length > 0;

  const handleSendSms = async () => {
    if (!onSendSms || !canSendSms) return;
    setSendingSms(true);
    try {
      await onSendSms(sms.trim());
      setSms("");
    } finally {
      setSendingSms(false);
    }
  };

  const handleSendEmail = onSendEmail
    ? async () => {
        if (!canSendEmail) return;
        setSendingEmail(true);
        try {
          await onSendEmail(subject.trim(), body.trim());
          setSubject("");
          setBody("");
          onClose();
        } finally {
          setSendingEmail(false);
        }
      }
    : undefined;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="Contact Customer"
      size="md"
      footerLeft={
        onSendSms ? (
          <button
            type="button"
            onClick={() => void handleSendSms()}
            className="rounded border border-emerald-500/70 bg-emerald-500/10 px-3 py-1.5 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/20 disabled:opacity-60"
            disabled={!canSendSms || sendingSms}
          >
            {sendingSms ? "Sending SMS…" : "Send SMS"}{" "}
            {customerPhone ? `(${customerPhone})` : ""}
          </button>
        ) : null
      }
      onSubmit={handleSendEmail}
      submitText={sendingEmail ? "Sending…" : "Send Email"}
    >
      <div className="mb-3 text-sm text-muted-foreground">
        {customerName ? (
          <span className="font-medium text-foreground">{customerName}</span>
        ) : null}{" "}
        {customerEmail ? <span>• {customerEmail}</span> : null}
        {customerPhone ? <span> • {customerPhone}</span> : null}
      </div>

      <label className="block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Subject
        </span>
        <input
          type="text"
          value={subject}
          onChange={(e) => setSubject(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Subject line…"
        />
      </label>

      <label className="mt-3 block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Email Body
        </span>
        <textarea
          rows={6}
          value={body}
          onChange={(e) => setBody(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Write your email to the customer…"
        />
      </label>

      <label className="mt-4 block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          SMS
        </span>
        <textarea
          rows={3}
          value={sms}
          onChange={(e) => setSms(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Quick text message…"
        />
      </label>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/PhotoCaptureModal.tsx ====================

// features/work-orders/components/workorders/extras/PhotoCaptureModal.tsx
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

type Source = "camera" | "photos_files";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  onCapture: (file: File) => void | Promise<void>;
}

function formatBytes(bytes: number): string {
  if (!Number.isFinite(bytes) || bytes <= 0) return "0 B";
  const units = ["B", "KB", "MB", "GB"] as const;
  let i = 0;
  let n = bytes;
  while (n >= 1024 && i < units.length - 1) {
    n /= 1024;
    i += 1;
  }
  return `${n.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
}

function isImageFile(file: File): boolean {
  return typeof file.type === "string" && file.type.startsWith("image/");
}

export default function PhotoCaptureModal({ isOpen, onClose, onCapture }: Props) {
  const [file, setFile] = useState<File | null>(null);
  const [source, setSource] = useState<Source>("camera");
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const cameraRef = useRef<HTMLInputElement | null>(null);
  const pickerRef = useRef<HTMLInputElement | null>(null);

  const previewUrl = useMemo(() => {
    if (!file) return null;
    if (!isImageFile(file)) return null;
    return URL.createObjectURL(file);
  }, [file]);

  // cleanup preview blob URL
  useEffect(() => {
    return () => {
      if (previewUrl) URL.revokeObjectURL(previewUrl);
    };
  }, [previewUrl]);

  // reset when modal opens/closes
  useEffect(() => {
    if (!isOpen) {
      setFile(null);
      setErr(null);
      setBusy(false);
      if (cameraRef.current) cameraRef.current.value = "";
      if (pickerRef.current) pickerRef.current.value = "";
      return;
    }
    setErr(null);
  }, [isOpen]);

  const handlePick = () => {
    setErr(null);

    if (source === "camera") {
      // camera forced
      cameraRef.current?.click();
      return;
    }

    // photos/files picker (no capture)
    pickerRef.current?.click();
  };

  const handleFile = (f: File | null) => {
    if (!f) return;

    // basic guardrails
    if (!isImageFile(f)) {
      setErr("Please select an image file.");
      return;
    }

    // optional: soft limit (adjust or remove)
    const maxBytes = 15 * 1024 * 1024;
    if (f.size > maxBytes) {
      setErr(`Image is too large (${formatBytes(f.size)}). Please use a smaller photo.`);
      return;
    }

    setFile(f);
    setErr(null);
  };

  const clearFile = () => {
    setFile(null);
    setErr(null);
    if (cameraRef.current) cameraRef.current.value = "";
    if (pickerRef.current) pickerRef.current.value = "";
  };

  const submit = async () => {
    if (!file || busy) return;

    setBusy(true);
    setErr(null);
    try {
      await onCapture(file);
      onClose();
      clearFile();
    } catch (e) {
      setErr(e instanceof Error ? e.message : "Upload failed.");
    } finally {
      setBusy(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={() => {
        onClose();
        clearFile();
      }}
      onSubmit={submit}
      title="Attach Photo"
      submitText={busy ? "Uploading…" : "Upload"}
      size="sm"
    >
      <div className="space-y-3">
        <div className="flex items-end justify-between gap-3">
          <div className="space-y-1">
            <label className="block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
              Source
            </label>
            <select
              value={source}
              onChange={(e) => setSource(e.target.value as Source)}
              className="w-full rounded-md border border-[var(--metal-border-soft)] bg-black/60 px-3 py-2 text-sm text-white outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
            >
              <option value="camera">Camera</option>
              <option value="photos_files">Photos / Files</option>
            </select>
          </div>

          <button
            type="button"
            onClick={handlePick}
            className="inline-flex items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-4 py-2 text-xs font-semibold uppercase tracking-[0.18em] text-neutral-100 hover:bg-white/5"
          >
            Choose
          </button>
        </div>

        {/* hidden inputs (we programmatically click them) */}
        <input
          ref={cameraRef}
          type="file"
          accept="image/*"
          capture="environment"
          onChange={(e) => handleFile(e.target.files?.[0] ?? null)}
          className="hidden"
        />
        <input
          ref={pickerRef}
          type="file"
          accept="image/*"
          onChange={(e) => handleFile(e.target.files?.[0] ?? null)}
          className="hidden"
        />

        {err && (
          <div className="rounded-lg border border-red-500/40 bg-red-950/35 px-3 py-2 text-xs text-red-100">
            {err}
          </div>
        )}

        {/* preview */}
        <div className="rounded-xl border border-[var(--metal-border-soft)] bg-black/50 p-3">
          {file ? (
            <div className="flex items-start gap-3">
              {previewUrl ? (
                // eslint-disable-next-line @next/next/no-img-element
                <img
                  src={previewUrl}
                  alt="Selected"
                  className="h-16 w-16 rounded-lg border border-white/10 object-cover"
                />
              ) : (
                <div className="flex h-16 w-16 items-center justify-center rounded-lg border border-white/10 bg-black/60 text-xs text-neutral-400">
                  IMG
                </div>
              )}

              <div className="min-w-0 flex-1">
                <div className="truncate text-sm font-semibold text-neutral-100">
                  {file.name}
                </div>
                <div className="mt-0.5 text-xs text-neutral-400">
                  {formatBytes(file.size)}
                </div>
                <div className="mt-2 flex gap-2">
                  <button
                    type="button"
                    onClick={clearFile}
                    disabled={busy}
                    className="rounded-full border border-white/10 bg-black/60 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-neutral-200 hover:bg-white/5 disabled:opacity-60"
                  >
                    Remove
                  </button>
                  <button
                    type="button"
                    onClick={handlePick}
                    disabled={busy}
                    className="rounded-full border border-[var(--accent-copper-soft)]/70 bg-black/50 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.16em] text-[var(--accent-copper-soft)] hover:bg-[var(--accent-copper-faint)] disabled:opacity-60"
                  >
                    Replace
                  </button>
                </div>
              </div>
            </div>
          ) : (
            <div className="text-xs text-neutral-400">
              Pick a job photo. On mobile, “Camera” opens the camera. “Photos / Files” opens your library or file picker.
            </div>
          )}
        </div>

        {/* small helper */}
        <p className="text-[11px] text-neutral-500">
          Tip: Use <span className="text-neutral-300">Photos / Files</span> if you need to select an existing picture instead of capturing a new one.
        </p>

        {/* soft-disable submit by messaging (ModalShell likely controls button; we still guard in submit) */}
        {!file && (
          <div className="text-[11px] text-amber-200/90">
            Choose a photo to enable upload.
          </div>
        )}
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/StatusPickerModal.tsx ====================

// /features/work-orders/components/StatusPickerModal.tsx
// ✅ FULL FILE REPLACEMENT
// - Removes "new"
// - Simplifies to WORK ORDER statuses (no approval picker in this modal)
// - Strict typing, no `any`

"use client";

import { useEffect, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

export type WorkOrderStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

type StatusPick = `status:${WorkOrderStatus}`;

const WORK_ORDER_OPTIONS: WorkOrderStatus[] = [
  "awaiting_approval",
  "awaiting",
  "queued",
  "in_progress",
  "on_hold",
  "planned",
  "completed",
  "ready_to_invoice",
  "invoiced",
];

export default function StatusPickerModal(props: {
  isOpen: boolean;
  onClose: () => void;
  current?: WorkOrderStatus;
  onChange: (next: StatusPick) => Promise<void> | void;
}) {
  const { isOpen, onClose, current = "awaiting", onChange } = props;

  const [value, setValue] = useState<StatusPick>(`status:${current}`);

  useEffect(() => {
    if (isOpen) setValue(`status:${current}`);
  }, [isOpen, current]);

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="Change Status"
      size="sm"
      onSubmit={async () => {
        await onChange(value);
        onClose();
      }}
      submitText="Apply"
    >
      <div className="flex flex-col gap-3">
        <div className="text-center text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
          Work order status
        </div>

        <select
          className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
          value={value}
          onChange={(e) => setValue(e.target.value as StatusPick)}
        >
          {WORK_ORDER_OPTIONS.map((s) => {
            const v: StatusPick = `status:${s}`;
            return (
              <option key={v} value={v}>
                {s.replaceAll("_", " ")}
              </option>
            );
          })}
        </select>

        <p className="text-center text-[11px] text-neutral-500">
          This updates the <span className="font-semibold">work order</span> status
          (advisor/manager only).
        </p>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/components/workorders/extras/TimeAdjustModal.tsx ====================

"use client";

import { useState } from "react";
import { format } from "date-fns";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  punchedInAt?: string | null;
  punchedOutAt?: string | null;
  onApply: (punchedInAt: string | null, punchedOutAt: string | null) => void | Promise<void>;
}

export default function TimeAdjustModal(props: any) {
  const { isOpen, onClose, punchedInAt, punchedOutAt, onApply } = props as Props;
  const [inAt, setInAt] = useState<string | "">(
    punchedInAt ? format(new Date(punchedInAt), "yyyy-MM-dd'T'HH:mm") : ""
  );
  const [outAt, setOutAt] = useState<string | "">(
    punchedOutAt ? format(new Date(punchedOutAt), "yyyy-MM-dd'T'HH:mm") : ""
  );

  const submit = async () => {
    const inVal = inAt ? new Date(inAt).toISOString() : null;
    const outVal = outAt ? new Date(outAt).toISOString() : null;
    await onApply(inVal, outVal);
    onClose();
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Adjust Time"
      submitText="Save"
      size="sm"
    >
      <div className="grid gap-3">
        <label className="block text-sm">
          <span className="mb-1 block text-neutral-400">Punch In</span>
          <input
            type="datetime-local"
            value={inAt}
            onChange={(e) => setInAt(e.target.value)}
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
          />
        </label>

        <label className="block text-sm">
          <span className="mb-1 block text-neutral-400">Punch Out</span>
          <input
            type="datetime-local"
            value={outAt}
            onChange={(e) => setOutAt(e.target.value)}
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
          />
        </label>
      </div>
    </ModalShell>
  );
}

==================== FILE: features/work-orders/lib/parts/allocateMenuItemParts.ts ====================

// features/work-orders/lib/parts/allocateMenuItemParts.ts
"use server";

import { cookies } from "next/headers";
import { revalidatePath } from "next/cache";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { consumePart } from "@/features/work-orders/lib/parts/consumePart";
import { ensureMainLocation } from "@parts/lib/locations";

type DB = Database;

type MenuItemPartRow = DB["public"]["Tables"]["menu_item_parts"]["Row"];

export type AllocateMenuItemPartsInput = {
  menu_item_id: string;
  work_order_line_id: string;
};

function asPositiveNumber(v: unknown): number | null {
  const n = typeof v === "number" ? v : Number(v);
  if (!Number.isFinite(n) || n <= 0) return null;
  return n;
}

function asFiniteNumberOrUndefined(v: unknown): number | undefined {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : undefined;
}

export async function allocateMenuItemParts(input: AllocateMenuItemPartsInput) {
  const supabase = createServerActionClient<DB>({ cookies });

  // 1) Load line (source of truth for shop + work order)
  const { data: woLine, error: wlErr } = await supabase
    .from("work_order_lines")
    .select("id, work_order_id, shop_id")
    .eq("id", input.work_order_line_id)
    .single();

  if (wlErr) throw wlErr;

  const workOrderId =
    typeof woLine.work_order_id === "string" ? woLine.work_order_id : null;
  const shopId = typeof woLine.shop_id === "string" ? woLine.shop_id : null;

  if (!workOrderId) throw new Error("Missing work_order_id on line");
  if (!shopId) throw new Error("Missing shop_id on line");

  // 2) CRITICAL: set current_shop_id() for THIS server session (RLS)
  const { error: ctxErr } = await supabase.rpc("set_current_shop_id", {
    p_shop_id: shopId,
  });
  if (ctxErr) {
    throw new Error(
      ctxErr.message || "Failed to set server shop context (current_shop_id)",
    );
  }

  // 3) Read menu_item_parts (shop-scoped)
  const { data: parts, error: mpErr } = await supabase
    .from("menu_item_parts")
    .select("id, part_id, quantity, unit_cost, shop_id, name")
    .eq("menu_item_id", input.menu_item_id)
    .eq("shop_id", shopId);

  if (mpErr) throw mpErr;

  const rows = (parts ?? []) as MenuItemPartRow[];
  if (!rows.length) {
    return { ok: true, allocated: 0, skipped: 0 };
  }

  // 4) Default location fallback is MAIN (consumePart can also resolve best-bin if you omit)
  const mainLoc = await ensureMainLocation(shopId);
  const locationId = typeof mainLoc?.id === "string" ? mainLoc.id : null;
  if (!locationId) throw new Error("Failed to resolve MAIN stock location");

  let allocated = 0;
  let skipped = 0;

  // 5) Allocate each part via consumePart() (creates stock move + allocation)
  for (const p of rows) {
    const partId =
      typeof p.part_id === "string" && p.part_id.length ? p.part_id : null;
    if (!partId) {
      skipped += 1;
      continue;
    }

    const qty = asPositiveNumber(p.quantity);
    if (!qty) {
      skipped += 1;
      continue;
    }

    const unitCost = asFiniteNumberOrUndefined(p.unit_cost);

    await consumePart({
      work_order_line_id: input.work_order_line_id,
      part_id: partId,
      qty,
      location_id: locationId, // satisfies NOT NULL + consistent default
      ...(typeof unitCost === "number" ? { unit_cost: unitCost } : {}),
    });

    allocated += 1;
  }

  revalidatePath(`/work-orders/${workOrderId}`);

  return { ok: true, allocated, skipped };
}

==================== FILE: features/work-orders/lib/parts/consumePart.ts ====================

// features/work-orders/lib/parts/consumePart.ts
"use server";

import { cookies } from "next/headers";
import { revalidatePath } from "next/cache";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { ensureMainLocation } from "@parts/lib/locations";

type DB = Database;

type StockMoveRow = DB["public"]["Tables"]["stock_moves"]["Row"];
type PartRow = DB["public"]["Tables"]["parts"]["Row"];

export type ConsumePartInput = {
  work_order_line_id: string;
  part_id: string;
  qty: number; // positive number means "consume qty"
  location_id?: string; // optional; defaults to MAIN for the WO's shop
  unit_cost?: number; // optional override from UI (NO nulls)
  availability?: string | null; // accepted but not stored yet
};

function extractStockMoveId(data: unknown): string | null {
  if (!data || typeof data !== "object") return null;
  const maybe = data as Partial<StockMoveRow>;
  const id = maybe.id;
  return typeof id === "string" && id.length > 0 ? id : null;
}

function asFiniteNumber(v: unknown): number | null {
  const n = typeof v === "number" ? v : Number(v);
  return Number.isFinite(n) ? n : null;
}

/**
 * Best-bin selection:
 * - If part_stock exists and has location rows, pick the location with max(available)
 * - Otherwise fall back to MAIN location.
 *
 * This is defensive: any schema mismatch falls back silently.
 */
async function resolveBestLocationId(args: {
  supabase: ReturnType<typeof createServerActionClient<DB>>;
  shopId: string;
  partId: string;
}): Promise<string> {
  const { supabase, shopId, partId } = args;

  // MAIN fallback is always safe
  const main = await ensureMainLocation(shopId);
  const mainId = typeof main?.id === "string" && main.id.length ? main.id : null;
  if (!mainId) throw new Error("Failed to resolve MAIN stock location");

  try {
    // Try the common schema: part_stock(shop_id, part_id, location_id, qty_on_hand, qty_reserved)
    const { data, error } = await supabase
      .from("part_stock")
      .select("location_id, qty_on_hand, qty_reserved")
      .eq("shop_id", shopId)
      .eq("part_id", partId);

    if (error) return mainId;
    if (!Array.isArray(data) || data.length === 0) return mainId;

    let bestLoc: string | null = null;
    let bestAvail = -Infinity;

    for (const row of data) {
      const rec = row as Record<string, unknown>;
      const loc = typeof rec.location_id === "string" ? rec.location_id : null;
      if (!loc) continue;

      const onHand = asFiniteNumber(rec.qty_on_hand) ?? 0;
      const reserved = asFiniteNumber(rec.qty_reserved) ?? 0;
      const avail = onHand - reserved;

      if (avail > bestAvail) {
        bestAvail = avail;
        bestLoc = loc;
      }
    }

    return bestLoc ?? mainId;
  } catch {
    return mainId;
  }
}

export async function consumePart(input: ConsumePartInput) {
  const supabase = createServerActionClient<DB>({ cookies });

  if (!input.qty || input.qty <= 0) {
    throw new Error("Quantity must be greater than 0");
  }

  // 1) Look up WO + shop_id from the line (single source of truth)
  const { data: woLine, error: wlErr } = await supabase
    .from("work_order_lines")
    .select("id, work_order_id, shop_id")
    .eq("id", input.work_order_line_id)
    .single();

  if (wlErr) throw wlErr;

  const workOrderId =
    typeof woLine.work_order_id === "string" ? woLine.work_order_id : null;
  const shopId = typeof woLine.shop_id === "string" ? woLine.shop_id : null;

  if (!workOrderId) throw new Error("Missing work_order_id on line");
  if (!shopId) throw new Error("Missing shop_id on line");

  // 2) CRITICAL: set current_shop_id() for THIS server session (RLS)
  const { error: ctxErr } = await supabase.rpc("set_current_shop_id", {
    p_shop_id: shopId,
  });
  if (ctxErr) {
    throw new Error(
      ctxErr.message || "Failed to set server shop context (current_shop_id)",
    );
  }

  // 3) Determine location_id (best-bin -> fallback MAIN)
  const locationId =
    typeof input.location_id === "string" && input.location_id.length
      ? input.location_id
      : await resolveBestLocationId({ supabase, shopId, partId: input.part_id });

  // 4) Determine effective unit_cost:
  //    - prefer explicit value from picker
  //    - otherwise fall back to parts.default_cost
  //    - NEVER pass null (use undefined to omit)
  let effectiveUnitCost: number | undefined;

  if (typeof input.unit_cost === "number" && Number.isFinite(input.unit_cost)) {
    effectiveUnitCost = input.unit_cost;
  } else {
    const { data: part, error: partErr } = await supabase
      .from("parts")
      .select("default_cost")
      .eq("id", input.part_id)
      .single();

    if (partErr) throw partErr;

    const dc = (part as PartRow | null)?.default_cost;
    const n = asFiniteNumber(dc);
    if (typeof n === "number") effectiveUnitCost = n;
  }

  const qtyAbs = Math.abs(input.qty);

  // 5) Create stock move (consume = negative)
  // NOTE: apply_stock_move RETURNS stock_moves row, not uuid
  const { data: moveRow, error: mErr } = await supabase.rpc("apply_stock_move", {
    p_part: input.part_id,
    p_loc: locationId,
    p_qty: -qtyAbs,
    p_reason: "consume",
    p_ref_kind: "work_order",
    p_ref_id: workOrderId,
  });

  if (mErr) throw mErr;

  const moveId = extractStockMoveId(moveRow);
  if (!moveId) {
    throw new Error("Inventory move failed: apply_stock_move returned no id");
  }

  // 6) Create allocation row (link to move)
  // CRITICAL: include shop_id to satisfy shop-scoped policies (shop_id = current_shop_id())
  const baseInsert = {
    shop_id: shopId,
    work_order_id: workOrderId,
    work_order_line_id: input.work_order_line_id,
    part_id: input.part_id,
    location_id: locationId,
    qty: qtyAbs,
    stock_move_id: moveId,
  };

  const allocInsert =
    typeof effectiveUnitCost === "number"
      ? { ...baseInsert, unit_cost: effectiveUnitCost }
      : baseInsert;

  const { data: alloc, error: aErr } = await supabase
    .from("work_order_part_allocations")
    .insert(allocInsert)
    .select("id")
    .single();

  if (aErr) throw aErr;

  // 7) Revalidate the WO page
  revalidatePath(`/work-orders/${workOrderId}`);

  const allocationId =
    alloc && typeof alloc.id === "string" ? alloc.id : undefined;

  return { allocationId, moveId };
}