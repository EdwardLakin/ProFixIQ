### ProFixIQ Work Order Bundle
Generated: 2025-12-20T06:43:08Z


========================================
FILE: app/agent/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/agent/agent-console/app/agent/page";


========================================
FILE: app/agent/planner/page.tsx
========================================
//app/agent/planner/page.tsx
"use client";

import { useEffect, useRef, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

import PageShell from "@/features/shared/components/PageShell";
import { Button } from "@shared/components/ui/Button";
import { useWorkOrderDraft } from "app/work-orders/state/useWorkOrderDraft";
import { WorkOrderPreviewTrigger } from "app/work-orders/components/WorkOrderPreviewTrigger";
import { WorkOrderPreview } from "app/work-orders/components/WorkOrderPreview";
import VinCaptureModal from "app/vehicle/VinCaptureModal";

type OcrFields = {
  vin?: string | null;
  plate?: string | null;
  year?: string | null;
  make?: string | null;
  model?: string | null;
  trim?: string | null;
  engine?: string | null;
  first_name?: string | null;
  last_name?: string | null;
  phone?: string | null;
  email?: string | null;
};

type PlannerKind = "simple" | "openai" | "fleet" | "approvals";

type AgentStartOut = { runId: string; alreadyExists: boolean };

type AgentEvent = Record<string, unknown> & { kind?: string };

function asString(v: unknown): string | null {
  return typeof v === "string" ? v : null;
}

function extractWorkOrderId(evt: AgentEvent): string | null {
  return (
    asString(evt.work_order_id) ??
    asString(evt.workOrderId) ??
    asString(evt.wo_id) ??
    asString(evt.id)
  );
}

function toMsg(e: unknown): string {
  if (typeof e === "string") return e;
  if (
    e !== null &&
    typeof e === "object" &&
    "message" in e &&
    typeof (e as { message: unknown }).message === "string"
  ) {
    return (e as { message: string }).message;
  }
  try {
    return JSON.stringify(e);
  } catch {
    return "Unknown error";
  }
}

function labelFor(evt: AgentEvent): string | null {
  const k = (evt.kind ?? "").toString();
  const woId = extractWorkOrderId(evt);
  switch (k) {
    case "run.started":
      return "Started plan";
    case "run.resumed":
      return "Resumed previous run";
    case "vin.decoded":
      return `Decoded VIN${evt.vin ? ` ${evt.vin}` : ""}`;
    case "customer.matched":
      return `Matched customer${evt.customer_name ? ` ${evt.customer_name}` : ""}`;
    case "vehicle.attached":
      return "Attached vehicle to work order";
    case "wo.created":
    case "work_order.created":
      return `Created work order${woId ? ` (${woId.slice(0, 8)})` : ""}`;
    case "wo.line.created":
    case "work_order_line.created":
      return `Added job line${
        evt.description ? ` ‚Äî ${String(evt.description).slice(0, 80)}` : ""
      }`;
    case "email.sent":
    case "invoice.emailed":
      return "Emailed invoice";
    case "invoice.created":
      return "Generated invoice";
    case "run.completed":
      return "Completed";
    case "run.error":
      return `Error: ${evt.message ?? "unknown"}`;
    default:
      if (!k) return null;
      return k.replaceAll("_", " ");
  }
}

export default function PlannerPage() {
  const [goal, setGoal] = useState("");
  const [planner, setPlanner] = useState<PlannerKind>("openai");
  const [customerQuery, setCustomerQuery] = useState("");
  const [plateOrVin, setPlateOrVin] = useState("");
  const [emailInvoiceTo, setEmailInvoiceTo] = useState("");
  const [photo, setPhoto] = useState<File | null>(null);
  const [photoPreview, setPhotoPreview] = useState<string | null>(null);

  const [steps, setSteps] = useState<string[]>([]);
  const [, setLog] = useState<string[]>([]);
  const [runId, setRunId] = useState<string | null>(null);
  const [running, setRunning] = useState(false);

  const esRef = useRef<EventSource | null>(null);

  const [previewWoId, setPreviewWoId] = useState<string | null>(null);
  const [previewOpen, setPreviewOpen] = useState(false);

  const [vinOpen, setVinOpen] = useState(false);
  const [userId, setUserId] = useState<string | null>(null);

  const [toast, setToast] = useState<string | null>(null);

  const supabase = createClientComponentClient<Database>();
  const draft = useWorkOrderDraft();
  const setVehicleDraft = useWorkOrderDraft((s) => s.setVehicle);
  const setCustomerDraft = useWorkOrderDraft((s) => s.setCustomer);
  const router = useRouter();

  useEffect(() => {
    let mounted = true;
    supabase.auth
      .getUser()
      .then(({ data }) => mounted && setUserId(data.user?.id ?? null));
    return () => void (mounted = false);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    return () => {
      if (photoPreview) URL.revokeObjectURL(photoPreview);
      esRef.current?.close();
      esRef.current = null;
    };
  }, [photoPreview]);

  useEffect(() => {
    const v = (draft?.vehicle?.vin ?? "").trim();
    if (v && !plateOrVin) setPlateOrVin(v);
    const em = (draft?.customer?.email ?? "").trim();
    if (em && !emailInvoiceTo) setEmailInvoiceTo(em);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  function onPickPhoto(file: File | null) {
    setPhoto(file);
    if (photoPreview) URL.revokeObjectURL(photoPreview);
    setPhotoPreview(file ? URL.createObjectURL(file) : null);
  }

  async function uploadPhotoIfAny(): Promise<string | undefined> {
    if (!photo) return undefined;
    const path = `agent-uploads/${crypto
      .randomUUID()
      .replace(/-/g, "")}-${photo.name.replace(/[^a-zA-Z0-9.\-_]/g, "_")}`;
    const up = await supabase.storage.from("agent-uploads").upload(path, photo, {
      cacheControl: "3600",
      upsert: false,
    });
    if (up.error) throw new Error(`Upload failed: ${up.error.message}`);
    const pub = supabase.storage.from("agent-uploads").getPublicUrl(path);
    if (!pub.data?.publicUrl) throw new Error("Could not resolve public URL");
    return pub.data.publicUrl;
  }

  function clearAll() {
    setGoal("");
    setCustomerQuery("");
    setPlateOrVin("");
    setEmailInvoiceTo("");
    if (photoPreview) URL.revokeObjectURL(photoPreview);
    setPhoto(null);
    setPhotoPreview(null);
    setSteps([]);
    setLog([]);
    setRunId(null);
    setPreviewWoId(null);
    setPreviewOpen(false);
    esRef.current?.close();
    esRef.current = null;
    setRunning(false);
  }

  const appendStep = (s: string) =>
    setSteps((arr) => (arr.includes(s) ? arr : [...arr, s]));
  const appendLog = (l: string) => setLog((arr) => [...arr, l]);

  async function start() {
    setRunning(true);
    setSteps([]);
    setLog([]);
    esRef.current?.close();
    esRef.current = null;

    try {
      const imageUrl = await uploadPhotoIfAny();
      if (imageUrl && photoPreview) URL.revokeObjectURL(photoPreview);
      if (imageUrl) {
        setPhoto(null);
        setPhotoPreview(null);
      }

      let ocrFields: OcrFields | null = null;
      if (imageUrl) {
        appendStep("Uploading photo‚Ä¶");
        try {
          const res = await fetch("/api/ocr/registration", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ imageUrl }),
          });
          if (res.ok) {
            const j = (await res.json()) as { fields?: OcrFields | null };
            const f = j?.fields || {};
            setVehicleDraft({
              vin: f.vin ?? undefined,
              plate: f.plate ?? undefined,
              year: f.year ?? undefined,
              make: f.make ?? undefined,
              model: f.model ?? undefined,
              trim: f.trim ?? undefined,
              engine: f.engine ?? undefined,
            });
            setCustomerDraft({
              first_name: f.first_name ?? undefined,
              last_name: f.last_name ?? undefined,
              phone: f.phone ?? undefined,
              email: f.email ?? undefined,
            });
            if (!plateOrVin && (f.vin || f.plate)) setPlateOrVin(f.vin || f.plate || "");
            if (!emailInvoiceTo && f.email) setEmailInvoiceTo(f.email || "");
            const quickBits = [
              f.vin ? `VIN ${String(f.vin).slice(0, 8)}‚Ä¶` : null,
              f.plate ? `Plate ${f.plate}` : null,
              f.email ? `Email ${f.email}` : null,
            ]
              .filter(Boolean)
              .join(" ‚Ä¢ ");
            appendStep(`OCR parsed: ${quickBits || "basic details"}`);
            ocrFields = f;
          } else {
            appendStep(`OCR failed (HTTP ${res.status})`);
          }
        } catch (err) {
          appendStep(`OCR error: ${toMsg(err)}`);
        }
      }

      const vinFromDraft = (draft?.vehicle?.vin ?? "").trim() || undefined;
      const decodedVehicle =
        draft?.vehicle &&
        (draft.vehicle.year ||
          draft.vehicle.make ||
          draft.vehicle.model ||
          draft.vehicle.trim ||
          draft.vehicle.engine)
          ? {
              year: draft.vehicle.year ?? null,
              make: draft.vehicle.make ?? null,
              model: draft.vehicle.model ?? null,
              trim: draft.vehicle.trim ?? null,
              engine: draft.vehicle.engine ?? null,
            }
          : undefined;

      const ctx = {
        customerQuery: customerQuery || undefined,
        plateOrVin: plateOrVin || vinFromDraft || undefined,
        emailInvoiceTo: emailInvoiceTo || undefined,
        imageUrl,
        vin: vinFromDraft || (plateOrVin?.length === 17 ? plateOrVin : undefined),
        decodedVehicle,
        ocr: ocrFields || undefined,
        lineDescription: goal?.trim() || undefined,
        jobType: "repair" as const,
        laborHours: 1,
      } as Record<string, unknown>;

      const res = await fetch("/api/agent", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          goal,
          planner,
          context: ctx,
          idempotencyKey: crypto.randomUUID(),
        }),
      });

      if (!res.ok) {
        const j = (await res.json().catch(() => ({}))) as { error?: unknown };
        throw new Error(typeof j?.error === "string" ? j.error : `HTTP ${res.status}`);
      }

      const out = (await res.json()) as AgentStartOut;
      setRunId(out.runId);
      appendStep(out.alreadyExists ? "Resumed previous run‚Ä¶" : "Started plan‚Ä¶");

      const url = `/api/agent/events?runId=${encodeURIComponent(out.runId)}`;
      const es = new EventSource(url);
      esRef.current = es;

      es.onmessage = (ev) => {
        if (!ev.data || ev.data === ":ok" || ev.data === "[DONE]") return;

        try {
          const data = JSON.parse(ev.data) as AgentEvent;
          const label = labelFor(data);
          if (label) appendStep(label);

          const maybeId = extractWorkOrderId(data);
          if (
            (data.kind === "wo.created" || data.kind === "work_order.created") &&
            typeof maybeId === "string"
          ) {
            setPreviewWoId(maybeId);
            setPreviewOpen(true);
          }

          appendLog(ev.data);
          if (data.kind === "run.completed" || data.kind === "run.error") {
            es.close();
            esRef.current = null;
            setRunning(false);
          }
        } catch {
          appendLog(ev.data);
        }
      };

      es.onerror = () => {
        if (esRef.current) {
          appendStep("Stream ended");
          es.close();
          esRef.current = null;
          setRunning(false);
        }
      };
    } catch (e) {
      appendStep(`Error: ${toMsg(e)}`);
      setRunning(false);
    }
  }

  const plannerModes: { id: PlannerKind; label: string }[] = [
    { id: "openai", label: "OpenAI (rich)" },
    { id: "simple", label: "Simple (rules)" },
    { id: "fleet", label: "Fleet PM" },
    { id: "approvals", label: "Advisor approvals" },
  ];

  return (
    <PageShell
      title="AI Planner"
      description="Describe what you want done ‚Äî we'll create the work order, add lines, attach photos, and optionally email the invoice."
    >
      <div className="space-y-4 rounded-lg border border-neutral-800 bg-neutral-950 p-5">
        {/* planner mode buttons */}
        <div className="flex flex-wrap gap-2">
          {plannerModes.map((m) => (
            <Button
              key={m.id}
              variant={planner === m.id ? "outline" : "ghost"}
              size="sm"
              className={
                planner === m.id
                  ? "bg-orange-500/10"
                  : "opacity-80 hover:opacity-100"
              }
              onClick={() => setPlanner(m.id)}
              type="button"
            >
              {m.label}
            </Button>
          ))}
        </div>

        {/* goal textarea (full width) */}
        <textarea
          value={goal}
          onChange={(e) => setGoal(e.target.value)}
          placeholder="e.g. Find John Smith, create inspection WO, add note, email invoice"
          className="w-full min-h-[110px] rounded border border-neutral-800 bg-neutral-900/80 p-3 text-sm text-neutral-100 placeholder:text-neutral-500"
        />

        {/* secondary inputs */}
        <div className="grid gap-3 md:grid-cols-2">
          <label className="block">
            <div className="mb-1 text-sm text-neutral-100">
              Customer query (name)
            </div>
            <input
              value={customerQuery}
              onChange={(e) => setCustomerQuery(e.target.value)}
              className="w-full rounded border border-neutral-800 bg-neutral-900/80 p-2 text-sm text-neutral-100 placeholder:text-neutral-500"
              placeholder="e.g. John Smith"
            />
          </label>

          <label className="block">
            <div className="mb-1 text-sm text-neutral-100">Plate or VIN</div>
            <div className="flex gap-2">
              <input
                value={plateOrVin}
                onChange={(e) => setPlateOrVin(e.target.value)}
                className="w-full rounded border border-neutral-800 bg-neutral-900/80 p-2 text-sm text-neutral-100 placeholder:text-neutral-500"
                placeholder="e.g. 8ABC123 or 1FT‚Ä¶"
              />
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => setVinOpen(true)}
                title="Open VIN capture"
                disabled={!userId}
              >
                Scan VIN
              </Button>
            </div>
          </label>

          <label className="block">
            <div className="mb-1 text-sm text-neutral-100">
              Email invoice to (optional)
            </div>
            <input
              value={emailInvoiceTo}
              onChange={(e) => setEmailInvoiceTo(e.target.value)}
              className="w-full rounded border border-neutral-800 bg-neutral-900/80 p-2 text-sm text-neutral-100 placeholder:text-neutral-500"
              placeholder="customer@example.com"
              type="email"
              inputMode="email"
            />
          </label>

          <label className="block">
            <div className="mb-1 text-sm text-neutral-100">
              Photo (DL / Registration)
            </div>
            <input
              type="file"
              accept="image/*"
              capture="environment"
              onChange={(e) => onPickPhoto(e.target.files?.[0] ?? null)}
              className="block w-full text-sm text-neutral-100 file:mr-4 file:rounded file:border file:border-orange-400 file:bg-transparent file:px-3 file:py-2 file:text-sm file:font-semibold file:text-white hover:file:bg-orange-500/10"
            />
            {photoPreview ? (
              <img
                src={photoPreview}
                alt="Preview"
                className="mt-2 max-h-40 rounded border border-neutral-800 object-contain"
              />
            ) : null}
          </label>
        </div>

        {runId && (
          <div className="text-xs text-neutral-400">
            Run ID: <code>{runId}</code>
          </div>
        )}

        {/* stream above buttons */}
        <div className="rounded border border-neutral-800 bg-neutral-900/80 p-4">
          <div className="mb-2 text-sm font-medium text-neutral-100">Stream</div>
          {steps.length === 0 ? (
            <div className="text-sm text-neutral-400">Waiting for updates‚Ä¶</div>
          ) : (
            <ul className="space-y-2">
              {steps.map((s, i) => (
                <li key={`${i}-${s}`} className="flex items-start gap-2">
                  <span className="mt-1 inline-block h-2.5 w-2.5 rounded-full bg-orange-500/80" />
                  <span className="text-sm text-neutral-100">{s}</span>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* centered actions */}
        <div className="flex items-center justify-center gap-4 pt-1">
          <Button
            onClick={start}
            variant="outline"
            size="md"
            isLoading={running}
            disabled={!goal.trim() || running}
            className="min-w-[140px]"
          >
            Run Plan
          </Button>

          <Button
            onClick={clearAll}
            variant="ghost"
            size="md"
            disabled={running}
            className="min-w-[140px]"
          >
            Clear
          </Button>
        </div>
      </div>

      {previewWoId && (
        <div className="mt-6">
          <WorkOrderPreviewTrigger open={previewOpen} onOpenChange={setPreviewOpen}>
            <WorkOrderPreview woId={previewWoId} />
          </WorkOrderPreviewTrigger>
        </div>
      )}

      {userId ? (
        <VinCaptureModal
          userId={userId}
          open={vinOpen}
          onOpenChange={(open: boolean) => setVinOpen(open)}
          onDecoded={(d) => {
            setVehicleDraft({
              vin: d.vin,
              year: d.year ?? null,
              make: d.make ?? null,
              model: d.model ?? null,
              trim: d.trim ?? null,
              engine: d.engine ?? null,
            });
            setPlateOrVin(d.vin);
            setToast("VIN decoded and recalls queued ‚úÖ");
            window.setTimeout(() => setToast(null), 4000);

            setVehicleDraft({
              vin: d.vin,
              year: d.year,
              make: d.make,
              model: d.model,
              trim: d.trim,
              engine: d.engine,
            });
            setCustomerDraft({
              first_name: undefined,
              last_name: undefined,
              email: emailInvoiceTo || undefined,
              phone: undefined,
            });
            router.push("/work-orders/create?source=ai");
          }}
        />
      ) : null}

      {toast && (
        <div
          className="fixed bottom-4 left-1/2 z-50 -translate-x-1/2 rounded border px-4 py-2 shadow-xl"
          style={{ borderColor: "#f97316", backgroundColor: "#0a0a0a" }}
        >
          <div className="flex items-center gap-2 text-sm text-neutral-100">
            <span className="inline-block h-4 w-4 rounded-full border-2 border-orange-500 border-t-transparent animate-spin" />
            {toast}
          </div>
        </div>
      )}
    </PageShell>
  );
}

========================================
FILE: app/ai/assistant/page.tsx
========================================
"use client";

import dynamic from "next/dynamic";

// Lazy-load both to avoid SSR hiccups and cut JS on pages that don‚Äôt use them
const TechAssistant = dynamic(
  () => import("@/features/shared/components/TechAssistant"),
  { ssr: false }
);
const TechAssistantMobile = dynamic(
  () => import("@/features/shared/components/TechAssistantMobile"),
  { ssr: false }
);

export default function TechAssistantPage() {
  // If you want to seed defaults later, keep these; for now we pass nothing.
  const defaultVehicle: { year?: string; make?: string; model?: string } | undefined = undefined;
  const workOrderLineId: string | undefined = undefined;

  return (
    <div className="mx-auto w-full max-w-5xl p-3 sm:p-4 md:p-6 text-white">
      <h1 className="mb-3 text-lg font-header text-orange-500">Tech Assistant</h1>

      {/* Mobile */}
      <div className="md:hidden rounded border border-neutral-800 bg-neutral-900">
        <TechAssistantMobile
          defaultVehicle={defaultVehicle}
          workOrderLineId={workOrderLineId}
        />
      </div>

      {/* Desktop / tablet */}
      <div className="hidden md:block rounded border border-neutral-800 bg-neutral-900 p-3">
        <TechAssistant
          defaultVehicle={defaultVehicle}
          workOrderLineId={workOrderLineId}
        />
      </div>
    </div>
  );
}

========================================
FILE: app/api/work-orders/add-line/route.ts
========================================
import { NextResponse } from "next/server";
import { createClient, type PostgrestError } from "@supabase/supabase-js";

type PartLine = { name: string; qty?: number; cost?: number; notes?: string };

type AISuggestion = {
  parts: PartLine[];
  laborHours: number;
  laborRate?: number;
  summary: string;
  confidence?: "low" | "medium" | "high";
  price?: number;
  notes?: string;
  title?: string;
};

type LineStatus =
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "paused"
  | "completed"
  | "assigned"
  | "unassigned"
  | "awaiting_approval"   // ‚úÖ now supported in DB CHECK
  | "declined";           // ‚úÖ now supported in DB CHECK

type ApprovalState = "pending" | "approved" | "declined" | null;

type JobType =
  | "diagnosis"
  | "inspection"
  | "maintenance"
  | "repair"
  | "tech-suggested"
  | null;

interface InsertWorkOrderLine {
  work_order_id: string;
  description: string;
  job_type: JobType;
  status: LineStatus;
  approval_state: ApprovalState;
  notes: string | null;
  labor_time: number | null;
}

interface AddLineRequestBody {
  workOrderId: string;
  description: string;
  section?: string;
  status?: "recommend" | "fail";
  suggestion: AISuggestion;
  jobType?: "inspection" | "repair" | "maintenance" | "diagnosis" | "tech-suggested";
}

function isValidBody(b: unknown): b is AddLineRequestBody {
  if (typeof b !== "object" || b === null) return false;
  const o = b as Record<string, unknown>;
  return (
    typeof o.workOrderId === "string" &&
    typeof o.description === "string" &&
    typeof o.suggestion === "object" &&
    o.suggestion !== null
  );
}

export async function POST(req: Request) {
  try {
    const bodyUnknown: unknown = await req.json();

    if (!isValidBody(bodyUnknown)) {
      return NextResponse.json(
        { error: "Invalid body: require workOrderId, description, suggestion" },
        { status: 400 }
      );
    }

    const {
      workOrderId,
      description,
      section,
      status,     // "recommend" | "fail" from inspection
      suggestion,
      jobType = "inspection",
    } = bodyUnknown;

    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
    const serviceKey =
      process.env.SUPABASE_SERVICE_ROLE_KEY ?? process.env.SUPABASE_SERVICE_KEY;

    if (!supabaseUrl || !serviceKey) {
      return NextResponse.json(
        { error: "Server not configured for Supabase" },
        { status: 500 }
      );
    }

    const supabase = createClient(supabaseUrl, serviceKey);

    // Build compact notes (extra context for advisors)
    const notesParts: string[] = [];
    if (section) notesParts.push(`Section: ${section}`);
    if (status) notesParts.push(`From inspection: ${status.toUpperCase()}`);
    if (suggestion.summary?.trim()) notesParts.push(`AI: ${suggestion.summary.trim()}`);
    const notes: string | null = notesParts.length ? notesParts.join(" ‚Ä¢ ") : null;

    const laborTime: number | null =
      typeof suggestion.laborHours === "number" ? suggestion.laborHours : null;

    // ‚úÖ Create as a quote line:
    // - status: awaiting_approval (non-punchable)
    // - approval_state: pending
    const insertPayload: InsertWorkOrderLine = {
      work_order_id: workOrderId,
      description,
      job_type: (jobType as JobType) ?? "inspection",
      status: "awaiting_approval",
      approval_state: "pending",
      notes,
      labor_time: laborTime,
    };

    const { data, error } = await supabase
      .from("work_order_lines")
      .insert(insertPayload)
      .select("id")
      .single();

    if (error) {
      const e = error as PostgrestError;
      return NextResponse.json(
        { error: e.message, details: e.details, hint: e.hint, code: e.code },
        { status: 500 }
      );
    }

    return NextResponse.json({ id: (data as { id: string }).id });
  } catch (e) {
    const msg = e instanceof Error ? e.message : "Unknown error";
    return NextResponse.json({ error: msg }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/add-suggested-lines/route.ts
========================================
// app/api/work-orders/add-suggested-lines/route.ts
import "server-only";
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type JobType = "diagnosis" | "repair" | "maintenance" | "tech-suggested";

type IncomingItem = {
  description: string;
  serviceCode?: string;
  jobType?: JobType;
  laborHours?: number | null;
  notes?: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

function normalizeVehicleId(v?: string | null): string | null {
  if (!v) return null;
  const trimmed = v.trim();
  return trimmed.length === 0 ? null : trimmed;
}

// --- parts request types (same shape as your parts route) ---
type PRInsert = DB["public"]["Tables"]["part_requests"]["Insert"];
type PRIInsert = DB["public"]["Tables"]["part_request_items"]["Insert"];

type PartRequestItemInsertWithExtras = PRIInsert & {
  markup_pct: number;
  work_order_line_id: string | null;
};

const DEFAULT_MARKUP = 30; // %

export async function POST(req: Request) {
  const supabase = createServerComponentClient<DB>({ cookies });

  try {
    const body = (await req.json()) as {
      workOrderId: string;
      vehicleId?: string | null;
      odometerKm?: number | null;
      items: IncomingItem[];
    };

    const { workOrderId, vehicleId, odometerKm, items } = body;

    if (!workOrderId || !Array.isArray(items) || items.length === 0) {
      return NextResponse.json(
        { error: "Missing workOrderId or items" },
        { status: 400 },
      );
    }

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError) {
      return NextResponse.json(
        { error: authError.message },
        { status: 401 },
      );
    }

    if (!user) {
      return NextResponse.json({ error: "Not signed in" }, { status: 401 });
    }

    const { data: wo, error: woError } = await supabase
      .from("work_orders")
      .select("id, shop_id, odometer_km")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woError) {
      return NextResponse.json(
        { error: woError.message },
        { status: 500 },
      );
    }

    if (!wo) {
      return NextResponse.json(
        { error: "Work order not found" },
        { status: 404 },
      );
    }

    const effectiveOdometerKm =
      odometerKm ?? (wo.odometer_km as number | null) ?? null;

    const normalizedVehicleId = normalizeVehicleId(vehicleId ?? null);

    // 1) Insert work_order_lines in "awaiting parts" state
    const lineRows = items.map((i) => ({
      work_order_id: workOrderId,
      vehicle_id: normalizedVehicleId,
      shop_id: wo.shop_id ?? null,
      description: i.description,
      job_type: i.jobType ?? "maintenance",
      labor_time: i.laborHours ?? 0,
      complaint: i.aiComplaint ?? null,
      cause: i.aiCause ?? null,
      correction: i.aiCorrection ?? null,
      status: "on_hold" as const,
      approval_state: "pending" as const,
      hold_reason: "Awaiting parts quote",
      service_code: i.serviceCode ?? null,
      odometer_km: effectiveOdometerKm,
      notes: i.notes ?? null,
    }));

    const {
      data: insertedLines,
      error: insertError,
    } = await supabase
      .from("work_order_lines")
      .insert(lineRows)
      .select("id, description");

    if (insertError || !insertedLines) {
      return NextResponse.json(
        { error: insertError?.message ?? "Failed to insert lines" },
        { status: 500 },
      );
    }

    // 2) Auto-create a single part_request + items for these lines
    if (!wo.shop_id) {
      // if shop_id is missing we just skip PR creation, but lines are still there
      return NextResponse.json({ ok: true, inserted: lineRows.length });
    }

    const header: PRInsert = {
      work_order_id: workOrderId,
      shop_id: wo.shop_id,
      requested_by: user.id,
      status: "requested",
      notes: "Auto-created from AI suggested services",
    };

    const {
      data: pr,
      error: prErr,
    } = await supabase
      .from("part_requests")
      .insert(header)
      .select("id")
      .single();

    if (prErr || !pr?.id) {
      return NextResponse.json(
        { error: prErr?.message ?? "Failed to create part request" },
        { status: 500 },
      );
    }

    const itemRows: PartRequestItemInsertWithExtras[] = insertedLines.map((ln) => ({
      request_id: pr.id,
      description: (ln.description ?? "Service").trim(),
      qty: 1,
      approved: false,
      part_id: null,
      quoted_price: null,
      vendor: null,
      markup_pct: DEFAULT_MARKUP,
      work_order_line_id: ln.id,
    }));

    const { error: itemsErr } = await supabase
      .from("part_request_items")
      .insert(itemRows);

    if (itemsErr) {
      return NextResponse.json(
        { error: itemsErr.message ?? "Failed to insert part request items" },
        { status: 500 },
      );
    }

    return NextResponse.json({
      ok: true,
      inserted: lineRows.length,
      partRequestId: pr.id,
      partItems: itemRows.length,
    });
  } catch (e: unknown) {
    console.error(e);
    return NextResponse.json(
      { error: "Failed to add suggested lines" },
      { status: 500 },
    );
  }
}

========================================
FILE: app/api/work-orders/assign-all/route.ts
========================================
// app/api/work-orders/assign-all/route.ts
export const runtime = "nodejs";
export const dynamic = "force-dynamic";

import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type Body = {
  work_order_id: string;
  tech_id: string;
  // optional, defaults to true ‚Üí only update rows where assigned_to is null
  only_unassigned?: boolean;
  // optional: who is doing the assignment (profiles.id)
  assigned_by?: string | null;
};

type LineTechInsert = {
  work_order_line_id: string;
  technician_id: string;
  assigned_by?: string | null;
};

function mustEnv(name: string): string {
  const v = process.env[name];
  if (!v || v.trim() === "") throw new Error(`Missing required env: ${name}`);
  return v;
}

export async function POST(req: Request) {
  try {
    const {
      work_order_id,
      tech_id,
      only_unassigned = true,
      assigned_by = null,
    } = (await req.json()) as Partial<Body>;

    if (!work_order_id) {
      return NextResponse.json(
        { error: "work_order_id is required" },
        { status: 400 }
      );
    }
    if (!tech_id) {
      return NextResponse.json(
        { error: "tech_id is required" },
        { status: 400 }
      );
    }

    const url = mustEnv("NEXT_PUBLIC_SUPABASE_URL");
    const service = mustEnv("SUPABASE_SERVICE_ROLE_KEY");
    const supabase = createClient<Database>(url, service);

    // (optional) make sure tech exists + is a tech-ish role
    const { data: techProfile, error: techErr } = await supabase
      .from("profiles")
      .select("id, role, full_name")
      .eq("id", tech_id)
      .maybeSingle();

    if (techErr) {
      return NextResponse.json(
        { error: `Failed to load tech profile: ${techErr.message}` },
        { status: 400 }
      );
    }
    if (!techProfile) {
      return NextResponse.json(
        { error: "Tech profile not found for that id." },
        { status: 404 }
      );
    }

    // build update
    let query = supabase
      .from("work_order_lines")
      .update({ assigned_to: tech_id })
      .eq("work_order_id", work_order_id);

    if (only_unassigned) {
      query = query.is("assigned_to", null);
    }

    // we SELECT ids so we know which lines were actually changed
    const { data: updatedRows, error: updErr } = await query.select("id");

    if (updErr) {
      return NextResponse.json(
        { error: `Update failed: ${updErr.message}` },
        { status: 400 }
      );
    }

    // NEW: also reflect this in work_order_line_technicians (many-to-many)
    if (updatedRows && updatedRows.length > 0) {
      const linkRows: LineTechInsert[] = updatedRows.map((row) => ({
        work_order_line_id: row.id,
        technician_id: tech_id,
        assigned_by,
      }));

      const { error: linkErr } = await supabase
        .from("work_order_line_technicians")
        .upsert(linkRows, {
          onConflict: "work_order_line_id,technician_id",
        });

      // not fatal ‚Äî we still assigned the lines
      if (linkErr) {
        // you can log this to your logs if you want
        console.warn(
          "assign-all: failed to upsert work_order_line_technicians:",
          linkErr.message
        );
      }
    }

    return NextResponse.json({
      ok: true,
      updated_count: updatedRows?.length ?? 0,
      tech: {
        id: techProfile.id,
        role: techProfile.role,
        full_name: techProfile.full_name,
      },
    });
  } catch (e) {
    const msg = e instanceof Error ? e.message : "Unexpected error.";
    return NextResponse.json({ error: msg }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/assign-line/route.ts
========================================
// app/api/work-orders/assign-line/route.ts
import { NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

function must(name: string): string {
  const v = process.env[name];
  if (!v) throw new Error(`Missing env ${name}`);
  return v;
}

export async function POST(req: Request) {
  try {
    const body = (await req.json()) as {
      work_order_line_id?: string;
      tech_id?: string;
      // optional, so we can record who assigned
      assigned_by?: string | null;
    };

    const lineId = body.work_order_line_id;
    const techId = body.tech_id;
    const assignedBy = body.assigned_by ?? null;

    if (!lineId || !techId) {
      return NextResponse.json(
        { error: "work_order_line_id and tech_id are required" },
        { status: 400 }
      );
    }

    const url = must("NEXT_PUBLIC_SUPABASE_URL");
    const service = must("SUPABASE_SERVICE_ROLE_KEY");
    const supabase = createClient<DB>(url, service);

    // 1) keep the simple column up to date
    const { error: lineErr } = await supabase
      .from("work_order_lines")
      .update({ assigned_to: techId })
      .eq("id", lineId);

    if (lineErr) {
      return NextResponse.json({ error: lineErr.message }, { status: 400 });
    }

    // 2) also record in the 1..n table (ignore duplicates)
    const { error: relErr } = await supabase
      .from("work_order_line_technicians")
      .upsert(
        {
          work_order_line_id: lineId,
          technician_id: techId,
          assigned_by: assignedBy,
        },
        {
          // because you declared unique (work_order_line_id, technician_id)
          onConflict: "work_order_line_id,technician_id",
        }
      );

    if (relErr) {
      // not fatal for UI
      console.warn("assign-line: technician link failed:", relErr.message);
    }

    return NextResponse.json({ ok: true });
  } catch (e) {
    const msg = e instanceof Error ? e.message : "Unexpected error";
    return NextResponse.json({ error: msg }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/[id]/ai-review/route.ts
========================================
import { NextResponse } from "next/server";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import type { Database } from "@shared/types/types/supabase";
import { recordWorkOrderTraining } from "@/features/integrations/ai";

type DB = Database;

function getIdFromUrl(url: string): string | null {
  const parts = new URL(url).pathname.split("/"); // ["", "api", "work-orders", "<id>", "ai-review"]
  return parts.length >= 5 ? parts[3] : null;
}

function isError(x: unknown): x is Error {
  return typeof x === "object" && x !== null && "message" in x;
}

export async function POST(req: Request) {
  const supabase = createRouteHandlerClient<DB>({ cookies });
  const woId = getIdFromUrl(req.url);

  if (!woId) {
    return NextResponse.json(
      {
        ok: false,
        issues: [{ kind: "bad_request", message: "Missing work order id" }],
      },
      { status: 400 },
    );
  }

  try {
    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("*")
      .eq("id", woId)
      .maybeSingle();

    if (woErr) throw woErr;
    if (!wo) {
      return NextResponse.json(
        {
          ok: false,
          issues: [{ kind: "missing_wo", message: "WO not found" }],
        },
        { status: 404 },
      );
    }

    const { data: lines, error: lnErr } = await supabase
      .from("work_order_lines")
      .select("*")
      .eq("work_order_id", wo.id);

    if (lnErr) throw lnErr;

    const issues: { kind: string; lineId?: string; message: string }[] = [];

    for (const ln of lines ?? []) {
      const st = String(ln.status ?? "awaiting");

      if (st !== "completed") {
        issues.push({
          kind: "line_not_completed",
          lineId: ln.id,
          message: `Line not completed: ${
            ln.description ?? ln.complaint ?? "job"
          }`,
        });
      }

      // optional ‚Äúmarked N/A‚Äù booleans if you add them later; kept narrow without any
      const causeNA =
        (ln as Record<string, unknown>)["cause_marked_na"] === true;
      const correctionNA =
        (ln as Record<string, unknown>)["correction_marked_na"] === true;

      if (!ln.cause && !causeNA) {
        issues.push({
          kind: "missing_cause",
          lineId: ln.id,
          message: `Missing cause: ${ln.description ?? "job"}`,
        });
      }

      if (!ln.correction && !correctionNA) {
        issues.push({
          kind: "missing_correction",
          lineId: ln.id,
          message: `Missing correction: ${ln.description ?? "job"}`,
        });
      }

      if (!(typeof ln.labor_time === "number" && ln.labor_time > 0)) {
        issues.push({
          kind: "no_labor_time",
          lineId: ln.id,
          message: `No labor time set: ${ln.description ?? "job"}`,
        });
      }
    }

    if (!wo.customer_id) {
      issues.push({
        kind: "missing_customer",
        message: "Missing customer on WO",
      });
    } else {
      const { data: cust } = await supabase
        .from("customers")
        .select("email")
        .eq("id", wo.customer_id)
        .maybeSingle();

      if (!cust?.email) {
        issues.push({
          kind: "missing_email",
          message: "Customer has no email",
        });
      }
    }

    const ok = issues.length === 0;

    // üîé AI training hook: log each AI review run as a training event
    if (wo.shop_id) {
      try {
        await recordWorkOrderTraining({
          shopId: wo.shop_id,
          workOrderId: wo.id,
          vehicleYmm: null, // TODO: hydrate from vehicles table if you want Y/M/M context
          payload: {
            kind: "ai_review",
            ok,
            issue_count: issues.length,
            issues,
          },
        });
      } catch (trainErr) {
        // Never block users on training/logging problems
        console.warn("AI training (ai-review) failed:", trainErr);
      }
    }

    return NextResponse.json({ ok, issues });
  } catch (e: unknown) {
    const msg = isError(e) ? e.message : "AI review failed";
    return NextResponse.json(
      { ok: false, issues: [{ kind: "error", message: msg }] },
      { status: 500 },
    );
  }
}


========================================
FILE: app/api/work-orders/[id]/invoice/route.ts
========================================
import { NextResponse } from "next/server";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import type { Database } from "@shared/types/types/supabase";
import { recordWorkOrderTraining } from "@/features/integrations/ai";

type DB = Database;

function getIdFromUrl(url: string): string | null {
  const parts = new URL(url).pathname.split("/"); // ["", "api", "work-orders", "<id>", "ai-review"]
  return parts.length >= 5 ? parts[3] : null;
}

function isError(x: unknown): x is Error {
  return typeof x === "object" && x !== null && "message" in x;
}

export async function POST(req: Request) {
  const supabase = createRouteHandlerClient<DB>({ cookies });
  const woId = getIdFromUrl(req.url);

  if (!woId) {
    return NextResponse.json(
      {
        ok: false,
        issues: [{ kind: "bad_request", message: "Missing work order id" }],
      },
      { status: 400 },
    );
  }

  try {
    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("*")
      .eq("id", woId)
      .maybeSingle();

    if (woErr) throw woErr;
    if (!wo) {
      return NextResponse.json(
        {
          ok: false,
          issues: [{ kind: "missing_wo", message: "WO not found" }],
        },
        { status: 404 },
      );
    }

    const { data: lines, error: lnErr } = await supabase
      .from("work_order_lines")
      .select("*")
      .eq("work_order_id", wo.id);

    if (lnErr) throw lnErr;

    const issues: { kind: string; lineId?: string; message: string }[] = [];

    for (const ln of lines ?? []) {
      const st = String(ln.status ?? "awaiting");

      if (st !== "completed") {
        issues.push({
          kind: "line_not_completed",
          lineId: ln.id,
          message: `Line not completed: ${
            ln.description ?? ln.complaint ?? "job"
          }`,
        });
      }

      // optional ‚Äúmarked N/A‚Äù booleans if you add them later; kept narrow without any
      const causeNA =
        (ln as Record<string, unknown>)["cause_marked_na"] === true;
      const correctionNA =
        (ln as Record<string, unknown>)["correction_marked_na"] === true;

      if (!ln.cause && !causeNA) {
        issues.push({
          kind: "missing_cause",
          lineId: ln.id,
          message: `Missing cause: ${ln.description ?? "job"}`,
        });
      }

      if (!ln.correction && !correctionNA) {
        issues.push({
          kind: "missing_correction",
          lineId: ln.id,
          message: `Missing correction: ${ln.description ?? "job"}`,
        });
      }

      if (!(typeof ln.labor_time === "number" && ln.labor_time > 0)) {
        issues.push({
          kind: "no_labor_time",
          lineId: ln.id,
          message: `No labor time set: ${ln.description ?? "job"}`,
        });
      }
    }

    if (!wo.customer_id) {
      issues.push({
        kind: "missing_customer",
        message: "Missing customer on WO",
      });
    } else {
      const { data: cust } = await supabase
        .from("customers")
        .select("email")
        .eq("id", wo.customer_id)
        .maybeSingle();

      if (!cust?.email) {
        issues.push({
          kind: "missing_email",
          message: "Customer has no email",
        });
      }
    }

    const ok = issues.length === 0;

    // üîé AI training hook: log each AI review run as a training event
    if (wo.shop_id) {
      try {
        await recordWorkOrderTraining({
          shopId: wo.shop_id,
          workOrderId: wo.id,
          vehicleYmm: null, // TODO: hydrate from vehicles table if you want Y/M/M context
          payload: {
            kind: "ai_review",
            ok,
            issue_count: issues.length,
            issues,
          },
        });
      } catch (trainErr) {
        // Never block users on training/logging problems
        console.warn("AI training (ai-review) failed:", trainErr);
      }
    }

    return NextResponse.json({ ok, issues });
  } catch (e: unknown) {
    const msg = isError(e) ? e.message : "AI review failed";
    return NextResponse.json(
      { ok: false, issues: [{ kind: "error", message: msg }] },
      { status: 500 },
    );
  }
}


========================================
FILE: app/api/work-orders/[id]/mark-ready/route.ts
========================================
import { NextResponse } from "next/server";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

function getIdFromUrl(url: string): string | null {
  const parts = new URL(url).pathname.split("/"); // ["", "api", "work-orders", "<id>", "mark-ready"]
  return parts.length >= 5 ? parts[3] : null;
}

function isError(x: unknown): x is Error {
  return typeof x === "object" && x !== null && "message" in x;
}

export async function POST(req: Request) {
  const supabase = createRouteHandlerClient<DB>({ cookies });
  const woId = getIdFromUrl(req.url);
  if (!woId) {
    return NextResponse.json({ ok: false, error: "Missing work order id" }, { status: 400 });
  }

  try {
    // verify all lines completed first
    const { data: lines, error: lnErr } = await supabase
      .from("work_order_lines")
      .select("id,status")
      .eq("work_order_id", woId);
    if (lnErr) throw lnErr;

    const notDone = (lines ?? []).some((l) => String(l.status ?? "awaiting") !== "completed");
    if (notDone) {
      return NextResponse.json({ ok: false, error: "All lines must be completed first." }, { status: 400 });
    }

    const { error: updErr } = await supabase
      .from("work_orders")
      .update({ status: "ready_to_invoice" })
      .eq("id", woId);
    if (updErr) throw updErr;

    return NextResponse.json({ ok: true });
  } catch (e: unknown) {
    const msg = isError(e) ? e.message : "Failed to mark ready";
    return NextResponse.json({ ok: false, error: msg }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/import-from-inspection/route.ts
========================================
// app/api/work-orders/import-from-inspection/route.ts
import "server-only";
import { NextResponse } from "next/server";
import { insertPrioritizedJobsFromInspection } from "@/features/work-orders/lib/work-orders/insertPrioritizedJobsFromInspection";

type ImportBody = {
  workOrderId: string;
  inspectionId: string;
  userId: string;
  vehicleId: string;
};

export async function POST(req: Request) {
  try {
    const body = (await req.json()) as Partial<ImportBody>;
    const { workOrderId, inspectionId, userId, vehicleId } = body;

    if (!workOrderId || !inspectionId || !userId || !vehicleId) {
      return NextResponse.json({ error: "Missing fields" }, { status: 400 });
    }

    await insertPrioritizedJobsFromInspection(workOrderId, inspectionId, userId, vehicleId);

    return NextResponse.json({ ok: true });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Unknown error";
    // Keep logs private; respond with a generic error
    console.error("import-from-inspection error:", message);
    return NextResponse.json(
      { error: "Failed to import inspection jobs." },
      { status: 500 }
    );
  }
}

// Ensure Node runtime (OpenAI SDK, if used downstream)
export const runtime = "nodejs";

========================================
FILE: app/api/work-orders/lines/[id]/finish/route.ts
========================================
// app/api/work-orders/lines/[id]/finish/route.ts
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type Body = { cause?: string; correction?: string };

function extractLineId(req: NextRequest) {
  // matches /api/work-orders/lines/<id>/finish
  const m = req.nextUrl.pathname.match(/\/api\/work-orders\/lines\/([^/]+)\/finish$/);
  return m?.[1] ?? null;
}

export async function POST(req: NextRequest) {
  const id = extractLineId(req);
  if (!id) return NextResponse.json({ error: "Missing id" }, { status: 400 });

  const supabase = createRouteHandlerClient<Database>({ cookies });

  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 500 });
  if (!auth?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const now = new Date().toISOString();
  const { cause, correction } = (await req.json().catch(() => ({}))) as Body;

  const updatePayload: Database["public"]["Tables"]["work_order_lines"]["Update"] = {
    status: "completed",
    punched_out_at: now,
    ...(cause !== undefined ? { cause } : {}),
    ...(correction !== undefined ? { correction } : {}),
  };

  const { data, error } = await supabase
    .from("work_order_lines")
    .update(updatePayload)
    .eq("id", id)
    .select("id, status, punched_in_at, punched_out_at, cause, correction")
    .single();

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });

  await supabase.from("activity_logs").insert({
    entity_type: "work_order_line",
    entity_id: id,
    action: "finish",
    actor_id: auth.user.id,
    created_at: now,
  });

  return NextResponse.json({ success: true, line: data });
}

========================================
FILE: app/api/work-orders/lines/[id]/pause/route.ts
========================================
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

function getId(req: NextRequest) {
  const m = req.nextUrl.pathname.match(/\/api\/work-orders\/lines\/([^/]+)\/pause$/);
  return m?.[1] ?? null;
}

export async function POST(req: NextRequest) {
  const id = getId(req);
  if (!id) return NextResponse.json({ error: "Missing id" }, { status: 400 });

  const supabase = createRouteHandlerClient<Database>({ cookies });
  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 500 });
  if (!auth?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const now = new Date().toISOString();

  const { error } = await supabase
    .from("work_order_lines")
    .update({
      status: "paused",
      // keep punched_in_at as-is; do NOT set punched_out_at on pause
    } as Database["public"]["Tables"]["work_order_lines"]["Update"])
    .eq("id", id)
    .single();

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });

  await supabase.from("activity_logs").insert({
    entity_type: "work_order_line",
    entity_id: id,
    action: "pause",
    actor_id: auth.user.id,
    created_at: now,
  });

  return NextResponse.json({ ok: true });
}

========================================
FILE: app/api/work-orders/lines/[id]/resume/route.ts
========================================
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

function getId(req: NextRequest) {
  const m = req.nextUrl.pathname.match(/\/api\/work-orders\/lines\/([^/]+)\/resume$/);
  return m?.[1] ?? null;
}

export async function POST(req: NextRequest) {
  const id = getId(req);
  if (!id) return NextResponse.json({ error: "Missing id" }, { status: 400 });

  const supabase = createRouteHandlerClient<Database>({ cookies });
  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 500 });
  if (!auth?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const now = new Date().toISOString();

  const { error } = await supabase
    .from("work_order_lines")
    .update({
      status: "in_progress",
      // punched_out_at stays null until finish
    } as Database["public"]["Tables"]["work_order_lines"]["Update"])
    .eq("id", id)
    .single();

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });

  await supabase.from("activity_logs").insert({
    entity_type: "work_order_line",
    entity_id: id,
    action: "resume",
    actor_id: auth.user.id,
    created_at: now,
  });

  return NextResponse.json({ ok: true });
}

========================================
FILE: app/api/work-orders/lines/[id]/start/route.ts
========================================
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

function getId(req: NextRequest) {
  const m = req.nextUrl.pathname.match(/\/api\/work-orders\/lines\/([^/]+)\/start$/);
  return m?.[1] ?? null;
}

export async function POST(req: NextRequest) {
  const id = getId(req);
  if (!id) return NextResponse.json({ error: "Missing id" }, { status: 400 });

  const supabase = createRouteHandlerClient<Database>({ cookies });
  const { data: auth, error: authErr } = await supabase.auth.getUser();
  if (authErr) return NextResponse.json({ error: authErr.message }, { status: 500 });
  if (!auth?.user) return NextResponse.json({ error: "Unauthorized" }, { status: 401 });

  const now = new Date().toISOString();

  const { error } = await supabase
    .from("work_order_lines")
    .update({
      status: "in_progress",
      punched_in_at: now,
      punched_out_at: null,
    })
    .eq("id", id)
    .single();

  if (error) return NextResponse.json({ error: error.message }, { status: 400 });

  await supabase.from("activity_logs").insert({
    entity_type: "work_order_line",
    entity_id: id,
    action: "start",
    actor_id: auth.user.id,
    created_at: now,
  });

  return NextResponse.json({ ok: true });
}

========================================
FILE: app/api/work-orders/maintenance-suggestions/route.ts
========================================
// app/api/work-orders/maintenance-suggestions/route.ts
import "server-only";
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { computeMaintenanceSuggestionsForWorkOrder } from "@/features/maintenance/server/computeMaintenanceSuggestions";

type DB = Database;

export const runtime = "nodejs";

/* ------------------------- GET ------------------------- */

export async function GET(req: Request) {
  const url = new URL(req.url);
  const workOrderId = url.searchParams.get("workOrderId");

  if (!workOrderId) {
    return NextResponse.json(
      { error: "Missing workOrderId" },
      { status: 400 }
    );
  }

  const supabase = createServerComponentClient<DB>({ cookies });

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ error: "Not signed in" }, { status: 401 });
  }

  const { data, error } = await supabase
    .from("maintenance_suggestions")
    .select("*")
    .eq("work_order_id", workOrderId)
    .maybeSingle();

  if (error) {
    return NextResponse.json(
      { error: error.message },
      { status: 500 }
    );
  }

  if (!data) {
    return NextResponse.json(
      { status: "empty", suggestions: [] },
      { status: 200 }
    );
  }

  return NextResponse.json({
    status: data.status,
    suggestions: data.suggestions ?? [],
    mileage_km: data.mileage_km,
    error_message: data.error_message,
  });
}

/* ------------------------- POST ------------------------- */

type PostBody = {
  workOrderId?: string;
};

export async function POST(req: Request) {
  const supabase = createServerComponentClient<DB>({ cookies });

  let body: PostBody = {};

  // Safely parse once
  try {
    body = (await req.json()) as PostBody;
  } catch {
    return NextResponse.json(
      { error: "Invalid JSON body" },
      { status: 400 }
    );
  }

  const workOrderId = body.workOrderId;

  if (!workOrderId) {
    return NextResponse.json(
      { error: "Missing workOrderId" },
      { status: 400 }
    );
  }

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return NextResponse.json({ error: "Not signed in" }, { status: 401 });
  }

  try {
    // Mark as pending
    const { error: upsertErr } = await supabase
      .from("maintenance_suggestions")
      .upsert(
        {
          work_order_id: workOrderId,
          status: "pending",
          error_message: null,
        },
        { onConflict: "work_order_id" }
      );

    if (upsertErr) {
      return NextResponse.json(
        { error: upsertErr.message },
        { status: 500 }
      );
    }

    // Compute immediately
    const { suggestions } =
      await computeMaintenanceSuggestionsForWorkOrder({
        supabase,
        workOrderId,
      });

    return NextResponse.json({
      status: "ready",
      suggestions,
    });
  } catch (e) {
    const errorMessage =
      e instanceof Error ? e.message : "Failed to compute suggestions";

    // Best effort update
    await supabase
      .from("maintenance_suggestions")
      .upsert(
        {
          work_order_id: workOrderId,
          status: "error",
          error_message: errorMessage,
        },
        { onConflict: "work_order_id" }
      );

    return NextResponse.json(
      { error: errorMessage },
      { status: 500 }
    );
  }
}

========================================
FILE: app/api/work-orders/quotes/add/route.ts
========================================
import "server-only";
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type QuoteInsert = DB["public"]["Tables"]["work_order_quote_lines"]["Insert"];

export async function POST(req: Request) {
  const supabase = createServerComponentClient<DB>({ cookies });

  try {
    const body = (await req.json()) as {
      workOrderId: string;
      vehicleId?: string | null;
      items: Array<{
        description: string;
        jobType?: "diagnosis" | "repair" | "maintenance" | "tech-suggested";
        estLaborHours?: number;
        notes?: string;
        aiComplaint?: string;
        aiCause?: string;
        aiCorrection?: string;
      }>;
    };

    const { workOrderId, vehicleId, items } = body;

    if (!workOrderId || !Array.isArray(items) || items.length === 0) {
      return NextResponse.json(
        { error: "Missing workOrderId or items" },
        { status: 400 }
      );
    }

    // Get current user
    const {
      data: { user },
    } = await supabase.auth.getUser();
    const suggested_by = user?.id ?? null;

    // Load work order ‚Üí for shop_id
    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("shop_id")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woErr) {
      return NextResponse.json(
        { error: `Failed to load work order: ${woErr.message}` },
        { status: 500 }
      );
    }

    if (!wo?.shop_id) {
      return NextResponse.json(
        { error: "Work order has no shop_id; cannot create quote lines." },
        { status: 400 }
      );
    }

    // Build rows fully typed
    const rows: QuoteInsert[] = items.map((i) => ({
      work_order_id: workOrderId,
      work_order_line_id: null,
      shop_id: wo.shop_id,

      vehicle_id: vehicleId ?? null,
      suggested_by,
      description: i.description,
      job_type: i.jobType ?? "tech-suggested",
      est_labor_hours: i.estLaborHours ?? null,
      notes: i.notes ?? null,
      status: "pending_parts",
      ai_complaint: i.aiComplaint ?? null,
      ai_cause: i.aiCause ?? null,
      ai_correction: i.aiCorrection ?? null,

      // NEW fields ‚Äï now fully typed, no @ts-ignore
      stage: "advisor_pending",
      qty: 1,

      labor_hours: null,
      parts_total: null,
      labor_total: null,
      subtotal: null,
      tax_total: null,
      grand_total: null,
      metadata: null,
      group_id: null,
      sent_to_customer_at: null,
      approved_at: null,
      declined_at: null,
    }));

    const { error } = await supabase
      .from("work_order_quote_lines")
      .insert(rows);

    if (error) {
      return NextResponse.json({ error: error.message }, { status: 500 });
    }

    return NextResponse.json({ ok: true });
  } catch (err) {
    console.error("[quotes/add] error:", err);
    return NextResponse.json(
      { error: "Failed to add quote items" },
      { status: 500 }
    );
  }
}

========================================
FILE: app/api/work-orders/quotes/[id]/authorize/route.ts
========================================
// app/api/work-orders/quotes/[id]/authorize/route.ts
import "server-only";
import { NextResponse, type NextRequest } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database, TablesInsert } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;
type WorkOrderLineInsert = TablesInsert<"work_order_lines">;

export async function POST(req: NextRequest) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  try {
    // Extract `[id]` from the pathname .../quotes/<id>/authorize
    const segments = req.nextUrl.pathname.split("/").filter(Boolean);
    const id = segments[segments.length - 2]; // the segment before "authorize"

    if (!id) {
      return NextResponse.json({ error: "Missing quote line id" }, { status: 400 });
    }

    // 1) Load the quote line we‚Äôre authorizing
    const { data: q, error: qErr } = await supabase
      .from("work_order_quote_lines")
      .select("*")
      .eq("id", id)
      .single();

    if (qErr || !q) {
      return NextResponse.json({ error: "Quote line not found" }, { status: 404 });
    }

    // 2) Turn it into a punchable job line
    const newLine: WorkOrderLineInsert = {
      work_order_id: q.work_order_id,
      vehicle_id: q.vehicle_id,
      description: q.description,
      job_type: q.job_type ?? "repair",
      status: "queued",
      labor_time: q.est_labor_hours ?? null,
      complaint: q.ai_complaint ?? q.description,
      cause: q.ai_cause ?? null,
      correction: q.ai_correction ?? null,
    };

    const { data: inserted, error: insErr } = await supabase
      .from("work_order_lines")
      .insert(newLine)
      .select("id")
      .single();

    if (insErr) {
      return NextResponse.json({ error: insErr.message }, { status: 500 });
    }

    // 3) Mark quote line as converted
    const { error: updErr } = await supabase
      .from("work_order_quote_lines")
      .update({ status: "converted", updated_at: new Date().toISOString() })
      .eq("id", id);

    if (updErr) {
      return NextResponse.json({ error: updErr.message }, { status: 500 });
    }

    return NextResponse.json({ ok: true, jobLineId: inserted?.id ?? null });
  } catch {
    return NextResponse.json({ error: "Failed to authorize" }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/quotes/[id]/mark-quoted/route.ts
========================================
// app/api/work-orders/quotes/[id]/mark-quoted/route.ts
import "server-only";
import { NextResponse, type NextRequest } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;

export async function PATCH(req: NextRequest) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  try {
    // Extract `[id]` from the pathname .../quotes/<id>/mark-quoted
    const segments = req.nextUrl.pathname.split("/").filter(Boolean);
    const id = segments[segments.length - 2]; // segment before "mark-quoted"

    if (!id) {
      return NextResponse.json({ error: "Missing quote line id" }, { status: 400 });
    }

    // Mark the quote line as quoted
    const { error: updErr } = await supabase
      .from("work_order_quote_lines")
      .update({ status: "quoted", updated_at: new Date().toISOString() })
      .eq("id", id);

    if (updErr) {
      return NextResponse.json({ error: updErr.message }, { status: 500 });
    }

    return NextResponse.json({ ok: true });
  } catch {
    return NextResponse.json({ error: "Failed to mark as quoted" }, { status: 500 });
  }
}

========================================
FILE: app/api/work-orders/suggest-lines/route.ts
========================================
// app/api/work-orders/suggest-lines/route.ts
import "server-only";
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { openai } from "lib/server/openai";

export const runtime = "nodejs";

type DB = Database;

type VehicleLite = {
  id: string | null;
  year: string | null;
  make: string | null;
  model: string | null;
};

type ReqBody =
  | { jobId: string; vehicleId?: VehicleLite | string | null }
  | { workOrderId: string; vehicleId?: VehicleLite | string | null };

type Suggestion = {
  name: string;
  laborHours: number;
  jobType: "diagnosis" | "repair" | "maintenance" | "tech-suggested";
  notes: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

function isVehicleLite(v: unknown): v is VehicleLite {
  if (typeof v !== "object" || v === null) return false;
  const o = v as Record<string, unknown>;
  return (
    "id" in o &&
    "year" in o &&
    "make" in o &&
    "model" in o &&
    (o.id === null || typeof o.id === "string") &&
    (o.year === null || typeof o.year === "string") &&
    (o.make === null || typeof o.make === "string") &&
    (o.model === null || typeof o.model === "string")
  );
}

function coerceSuggestion(u: unknown): Suggestion | null {
  if (typeof u !== "object" || u === null) return null;
  const o = u as Record<string, unknown>;

  const name = typeof o.name === "string" ? o.name : null;
  const laborHours =
    typeof o.laborHours === "number" && Number.isFinite(o.laborHours)
      ? o.laborHours
      : null;
  const jobType =
    o.jobType === "diagnosis" ||
    o.jobType === "repair" ||
    o.jobType === "maintenance" ||
    o.jobType === "tech-suggested"
      ? o.jobType
      : null;
  const notes = typeof o.notes === "string" ? o.notes : "";

  if (!name || laborHours === null || !jobType) return null;

  const aiComplaint =
    typeof o.aiComplaint === "string" ? o.aiComplaint : undefined;
  const aiCause = typeof o.aiCause === "string" ? o.aiCause : undefined;
  const aiCorrection =
    typeof o.aiCorrection === "string" ? o.aiCorrection : undefined;

  return { name, laborHours, jobType, notes, aiComplaint, aiCause, aiCorrection };
}

export async function POST(req: Request) {
  const supabase = createServerComponentClient<DB>({ cookies });

  try {
    const body = (await req.json()) as ReqBody;

    // Gather context
    let complaint: string | null = null;
    let vehicle: VehicleLite | null = null;

    if ("jobId" in body) {
      const { data: line } = await supabase
        .from("work_order_lines")
        .select("complaint, vehicle_id, vehicles:vehicle_id ( year, make, model )")
        .eq("id", body.jobId)
        .single();

      if (line?.complaint) complaint = line.complaint;

      // Prefer explicit vehicleId passed in the request, else derive from the joined record
      if (isVehicleLite(body.vehicleId)) {
        vehicle = body.vehicleId;
      } else if (line?.vehicles) {
        const v = line.vehicles as unknown as { year: number | null; make: string | null; model: string | null };
        vehicle = {
          id: (line as unknown as { vehicle_id: string | null }).vehicle_id ?? null,
          year: v?.year != null ? String(v.year) : null,
          make: v?.make ?? null,
          model: v?.model ?? null,
        };
      }
    } else if ("workOrderId" in body) {
      // Pull minimal context from the work order (first line complaint if present)
      const { data: lines } = await supabase
        .from("work_order_lines")
        .select("complaint, vehicle_id")
        .eq("work_order_id", body.workOrderId)
        .order("created_at", { ascending: true })
        .limit(1);

      if (lines && lines.length > 0) {
        complaint = lines[0]?.complaint ?? null;
      }

      if (isVehicleLite(body.vehicleId)) {
        vehicle = body.vehicleId;
      }
    }

    // Compose prompt
    const vStr =
      vehicle && (vehicle.make || vehicle.model || vehicle.year)
        ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}`.trim()
        : "Unknown vehicle";

    const userContext =
      [
        complaint ? `Complaint: ${complaint}` : null,
        vehicle ? `Vehicle: ${vStr}` : null,
      ]
        .filter(Boolean)
        .join("\n") || "No complaint provided. Vehicle unknown.";

    const system = [
      "You are a service advisor assistant for an auto shop.",
      "Return a JSON array of 3-6 suggested jobs related to the complaint and vehicle.",
      "Each item must have fields: name (string), laborHours (number), jobType ('diagnosis'|'repair'|'maintenance'|'tech-suggested'), notes (string).",
      "When helpful, include aiComplaint, aiCause, aiCorrection to pre-fill story text.",
      "Keep laborHours realistic; do not exceed 8 hours for a single item.",
      "Only output raw JSON (no markdown).",
    ].join(" ");

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      temperature: 0.4,
      messages: [
        { role: "system", content: system },
        { role: "user", content: userContext },
      ],
      max_tokens: 500,
    });

    const raw = completion.choices[0]?.message?.content ?? "[]";

    // Parse & validate
    let parsed: unknown;
    try {
      parsed = JSON.parse(raw);
    } catch {
      parsed = [];
    }

    const suggestions: Suggestion[] = Array.isArray(parsed)
      ? (parsed
          .map(coerceSuggestion)
          .filter((s): s is Suggestion => s !== null)
          .slice(0, 6))
      : [];

    return NextResponse.json({ suggestions });
  } catch {
    return NextResponse.json(
      { error: "Failed to generate suggestions" },
      { status: 500 }
    );
  }
}

========================================
FILE: app/billing/page.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { format } from "date-fns";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type Row = WorkOrder & {
  customers: Pick<Customer, "first_name" | "last_name" | "email"> | null;
  vehicles: Pick<Vehicle, "year" | "make" | "model" | "license_plate"> | null;
};

// ‚úÖ Exclude null so <select> value is always a string (or "")
type Status = Exclude<WorkOrder["status"], null> | "ready_to_invoice" | "invoiced";

const BADGE: Record<string, string> = {
  completed: "bg-blue-900/20 border-blue-500/40 text-blue-300",
  ready_to_invoice: "bg-amber-900/20 border-amber-500/40 text-amber-300",
  invoiced: "bg-green-900/20 border-green-500/40 text-green-300",
};

const BILLING_STATUSES: Status[] = ["completed", "ready_to_invoice", "invoiced"];

export default function BillingPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<Status | "">("");
  const [err, setErr] = useState<string | null>(null);

  const chip = (s: string | null | undefined) =>
    `inline-flex items-center rounded border px-2 py-0.5 text-xs font-medium ${
      BADGE[s ?? "completed"] ?? BADGE.completed
    }`;

  const load = useCallback(async () => {
    setLoading(true);
    setErr(null);

    let query = supabase
      .from("work_orders")
      .select(
        `
        *,
        customers:customers(first_name,last_name,email),
        vehicles:vehicles(year,make,model,license_plate)
      `
      )
      .order("updated_at", { ascending: false })
      .limit(100);

    if (status) {
      query = query.eq("status", status);
    } else {
      query = query.in("status", BILLING_STATUSES as unknown as string[]);
    }

    const { data, error } = await query;
    if (error) {
      setErr(error.message);
      setRows([]);
      setLoading(false);
      return;
    }

    const qlc = q.trim().toLowerCase();
    const filtered =
      qlc.length === 0
        ? (data as Row[])
        : (data as Row[]).filter((r) => {
            const name = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
              .join(" ")
              .toLowerCase();
            const plate = r.vehicles?.license_plate?.toLowerCase() ?? "";
            const ymm = [r.vehicles?.year ?? "", r.vehicles?.make ?? "", r.vehicles?.model ?? ""]
              .join(" ")
              .toLowerCase();
            const cid = (r.custom_id ?? "").toLowerCase();
            return (
              r.id.toLowerCase().includes(qlc) ||
              cid.includes(qlc) ||
              name.includes(qlc) ||
              plate.includes(qlc) ||
              ymm.includes(qlc)
            );
          });

    setRows(filtered);
    setLoading(false);
  }, [q, status, supabase]);

  useEffect(() => {
    void load();
  }, [load]);

  const handleAiReview = useCallback(async (id: string) => {
    const res = await fetch(`/api/work-orders/${id}/ai-review`, { method: "POST" });
    const j = (await res.json()) as {
      ok: boolean;
      issues: { kind: string; lineId?: string; message: string }[];
      suggested?: unknown;
    };
    if (!res.ok || !j.ok) {
      alert(
        j.issues?.length
          ? `Found issues:\n- ${j.issues.map((i) => i.message).join("\n- ")}`
          : "AI review failed.",
      );
      return;
    }
    alert("AI review passed. You can mark Ready to Invoice.");
  }, []);

  const handleMarkReady = useCallback(
    async (id: string) => {
      const res = await fetch(`/api/work-orders/${id}/mark-ready`, { method: "POST" });
      const j = (await res.json()) as { ok: boolean; error?: string };
      if (!res.ok || !j.ok) {
        alert(j.error ?? "Failed to mark ready.");
        return;
      }
      void load();
    },
    [load],
  );

  const handleInvoice = useCallback(
    async (id: string) => {
      if (!confirm("Create and email a Stripe invoice to the customer?")) return;
      const res = await fetch(`/api/work-orders/${id}/invoice`, { method: "POST" });
      const j = (await res.json()) as { ok: boolean; stripeInvoiceId?: string; error?: string };
      if (!res.ok || !j.ok) {
        alert(j.error ?? "Failed to create invoice.");
        return;
      }
      alert("Invoice created and emailed.");
      void load();
    },
    [load],
  );

  return (
    <div className="mx-auto max-w-6xl p-6 text-white">
      <div className="mb-4 flex flex-wrap items-center gap-3">
        <h1 className="text-2xl font-bold text-orange-400">Billing</h1>
        <div className="ml-auto flex gap-2">
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && void load()}
            placeholder="Search id, custom id, name, plate, YMM‚Ä¶"
            className="rounded border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm"
          />
          <select
            value={status}
            onChange={(e) => setStatus(e.target.value as Status | "")}
            className="rounded border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm"
            aria-label="Filter by status"
          >
            <option value="">All (completed ‚Üí invoiced)</option>
            <option value="completed">Completed</option>
            <option value="ready_to_invoice">Ready to invoice</option>
            <option value="invoiced">Invoiced</option>
          </select>
          <button
            onClick={() => void load()}
            className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
          >
            Refresh
          </button>
        </div>
      </div>

      {err && <div className="mb-3 rounded bg-red-500/10 p-2 text-sm text-red-300">{err}</div>}

      {loading ? (
        <div className="text-neutral-300">Loading‚Ä¶</div>
      ) : rows.length === 0 ? (
        <div className="text-neutral-400">Nothing here yet.</div>
      ) : (
        <div className="divide-y divide-neutral-800 rounded border border-neutral-800 bg-neutral-900">
          {rows.map((r) => {
            const href = `/work-orders/${r.custom_id ?? r.id}?mode=view`;
            return (
              <div key={r.id} className="flex items-center gap-3 p-3">
                <div className="w-28 text-xs text-neutral-400">
                  {r.updated_at ? format(new Date(r.updated_at), "PP") : "‚Äî"}
                </div>
                <div className="min-w-0 flex-1">
                  <div className="flex items-center gap-2">
                    <Link
                      href={href}
                      className="font-medium underline decoration-neutral-600 underline-offset-2 hover:decoration-orange-500"
                    >
                      {r.custom_id ? r.custom_id : `#${r.id.slice(0, 8)}`}
                    </Link>
                    <span className="text-[10px] rounded border border-neutral-700 px-1 py-0.5 text-neutral-300">
                      #{r.id.slice(0, 6)}
                    </span>
                    <span className={chip(r.status)}>{String(r.status ?? "completed").replaceAll("_", " ")}</span>
                  </div>
                  <div className="truncate text-sm text-neutral-300">
                    {r.customers
                      ? `${[r.customers.first_name ?? "", r.customers.last_name ?? ""]
                          .filter(Boolean)
                          .join(" ")}`
                      : "‚Äî"}{" "}
                    ‚Ä¢{" "}
                    {r.vehicles
                      ? `${r.vehicles.year ?? ""} ${r.vehicles.make ?? ""} ${r.vehicles.model ?? ""} ${
                          r.vehicles.license_plate ? `(${r.vehicles.license_plate})` : ""
                        }`
                      : "‚Äî"}
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button
                    onClick={() => void handleAiReview(r.id)}
                    className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
                    title="Run AI checklist"
                  >
                    AI Review
                  </button>
                  <button
                    onClick={() => void handleMarkReady(r.id)}
                    className="rounded border border-amber-600/60 px-2 py-1 text-sm text-amber-300 hover:bg-amber-900/20 disabled:opacity-50"
                    disabled={r.status === "invoiced" || r.status === "ready_to_invoice"}
                    title="Mark as Ready to invoice"
                  >
                    Mark Ready
                  </button>
                  <button
                    onClick={() => void handleInvoice(r.id)}
                    className="rounded border border-green-600/60 px-2 py-1 text-sm text-green-300 hover:bg-green-900/20 disabled:opacity-50"
                    disabled={r.status === "invoiced"}
                    title="Create & email Stripe invoice"
                  >
                    Invoice
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/chat/[chatId]/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import PageShell from "@/features/shared/components/PageShell";
import ChatWindow from "@/features/ai/components/chat/ChatWindow";

type DB = Database;

type ConversationPayload = {
  conversation: DB["public"]["Tables"]["conversations"]["Row"];
  latest_message: DB["public"]["Tables"]["messages"]["Row"] | null;
  participants: Array<{ id: string; full_name: string | null }>;
  unread_count: number;
};

export default function ChatThreadPage(): JSX.Element {
  const params = useParams<{ chatId: string }>();
  const conversationId = params.chatId;

  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [userId, setUserId] = useState<string | null>(null);
  const [title, setTitle] = useState<string>("Conversation");

  // who am I
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      setUserId(user?.id ?? null);

      // fetch conversations and try to label nicely
      try {
        const res = await fetch("/api/chat/my-conversations", {
          method: "GET",
          credentials: "include",
        });
        if (res.ok) {
          const data = (await res.json()) as ConversationPayload[];
          const found = data.find(
            (item) => item.conversation.id === conversationId,
          );
          if (found) {
            const others =
              user?.id == null
                ? found.participants
                : found.participants.filter((p) => p.id !== user.id);
            const label =
              others[0]?.full_name ??
              found.conversation.context_type ??
              `Conversation ${conversationId.slice(0, 6)}`;
            setTitle(label);
          }
        }
      } catch {
        // ignore ‚Äî we'll keep "Conversation"
      }
    })();
  }, [supabase, conversationId]);

  return (
    <PageShell title={title}>
      {!userId ? (
        <div className="rounded border border-[#3b2a21] bg-[#0b0806] p-4 text-sm text-[#d5b9a0]">
          Loading‚Ä¶
        </div>
      ) : (
        <div className="h-[70vh]">
          <ChatWindow
            conversationId={conversationId}
            userId={userId}
            title={title}
          />
        </div>
      )}
    </PageShell>
  );
}

========================================
FILE: app/chat/page.tsx
========================================
// app/chat/page.tsx
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import PageShell from "@/features/shared/components/PageShell";
import NewChatModal from "@/features/ai/components/chat/NewChatModal";

type DB = Database;

type ConversationRow = DB["public"]["Tables"]["conversations"]["Row"];

type ParticipantInfo = {
  id: string;
  full_name: string | null;
};

type ConversationWithMeta = {
  conversation: ConversationRow;
  latest_message: DB["public"]["Tables"]["messages"]["Row"] | null;
  participants: ParticipantInfo[];
  unread_count: number;
};

function formatRelative(dateIso: string | null): string {
  if (!dateIso) return "";
  const date = new Date(dateIso);
  const diffMs = Date.now() - date.getTime();
  const diffMin = Math.floor(diffMs / (1000 * 60));
  if (diffMin < 1) return "just now";
  if (diffMin < 60) return `${diffMin}m`;
  const diffHr = Math.floor(diffMin / 60);
  if (diffHr < 24) return `${diffHr}h`;
  const diffDay = Math.floor(diffHr / 24);
  if (diffDay < 7) return `${diffDay}d`;
  return date.toLocaleDateString();
}

export default function ChatListPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [me, setMe] = useState<string | null>(null);
  const [conversations, setConversations] = useState<ConversationWithMeta[]>([]);
  const [loading, setLoading] = useState(true);
  const [isNewChatOpen, setIsNewChatOpen] = useState(false);
  const [search, setSearch] = useState("");

  // who am I
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      setMe(user?.id ?? null);
    })();
  }, [supabase]);

  // load conversations
  const loadConversations = useCallback(async () => {
    setLoading(true);
    try {
      const res = await fetch("/api/chat/my-conversations", {
        method: "GET",
        credentials: "include",
      });
      if (!res.ok) {
        setConversations([]);
        setLoading(false);
        return;
      }
      const data = (await res.json()) as ConversationWithMeta[];
      setConversations(data);
    } catch (err) {
      console.error("[/chat] failed to load conversations:", err);
      setConversations([]);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    void loadConversations();
  }, [loadConversations]);

  // live refresh
  useEffect(() => {
    const channel = supabase
      .channel("chat-page-refresh")
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "messages" },
        () => void loadConversations(),
      )
      .on(
        "postgres_changes",
        { event: "INSERT", schema: "public", table: "conversations" },
        () => void loadConversations(),
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [supabase, loadConversations]);

  // search filter uses names (recipients) + latest text
  const filtered = conversations.filter((item) => {
    const term = search.trim().toLowerCase();
    if (!term) return true;

    const names = item.participants
      .map((p) => p.full_name ?? "")
      .join(" ")
      .toLowerCase();
    const latest = (item.latest_message?.content ?? "").toLowerCase();

    return names.includes(term) || latest.includes(term);
  });

  // delete conversation (optimistic, then rollback on error)
  const handleDelete = useCallback(async (id: string) => {
    let prev: ConversationWithMeta[] = [];
    setConversations((curr) => {
      prev = curr;
      return curr.filter((c) => c.conversation.id !== id);
    });

    try {
      const res = await fetch("/api/chat/delete-conversation", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id }),
      });
      if (!res.ok) {
        console.error("[/chat] delete failed:", await res.text());
        setConversations(prev);
      }
    } catch (err) {
      console.error("[/chat] delete failed:", err);
      setConversations(prev);
    }
  }, []);

  return (
    <PageShell title="Conversations">
      <div className="mb-4 flex items-center justify-between gap-3">
        <div className="flex items-center gap-3">
          <h1 className="text-xl font-semibold text-foreground">Conversations</h1>
          <input
            type="search"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search‚Ä¶"
            autoComplete="off"
            className={[
              "rounded-md",
              "border border-neutral-700",
              "!bg-neutral-900", // force dark
              "px-3 py-2 text-sm",
              "text-foreground placeholder:text-neutral-500",
              "focus:border-orange-400 focus:outline-none focus:ring-0",
              "appearance-none",
              "[color-scheme:dark]",
            ].join(" ")}
          />
        </div>
        <button
          type="button"
          onClick={() => setIsNewChatOpen(true)}
          className="inline-flex items-center gap-2 rounded-md border border-orange-500/70 bg-transparent px-4 py-2 text-sm font-medium text-orange-200 hover:bg-orange-500/10 focus:outline-none focus:ring-2 focus:ring-orange-500/60"
        >
          <span className="text-base leading-none">Ôºã</span>
          New conversation
        </button>
      </div>

      {loading ? (
        <div className="rounded-md border border-border/60 bg-muted/20 p-4 text-sm text-muted-foreground">
          Loading‚Ä¶
        </div>
      ) : filtered.length === 0 ? (
        <div className="flex flex-col items-center justify-center gap-2 rounded-md border border-border/60 bg-muted/5 py-10 text-center text-sm text-muted-foreground">
          <p>No conversations yet.</p>
          <button
            type="button"
            onClick={() => setIsNewChatOpen(true)}
            className="rounded-md bg-orange-500 px-3 py-1.5 text-xs font-semibold text-black hover:bg-orange-400"
          >
            Start a conversation
          </button>
        </div>
      ) : (
        <div className="rounded-lg border border-neutral-800/70 bg-neutral-950/40 shadow-sm">
          <ul className="divide-y divide-neutral-800/70">
            {filtered.map((item) => {
              const conv = item.conversation;
              const latest = item.latest_message;

              // ---- LABEL BY RECIPIENTS (not me) ----
              const others =
                me == null
                  ? item.participants
                  : item.participants.filter((p) => p.id !== me);

              const recipientNames = (others.length > 0 ? others : item.participants)
                .map((p) => p.full_name?.trim() ?? "")
                .filter((n) => n.length > 0);

              const nameLabel =
                recipientNames.length > 0
                  ? recipientNames.slice(0, 2).join(", ") +
                    (recipientNames.length > 2 ? ` +${recipientNames.length - 2}` : "")
                  : conv.context_type ?? `Conversation ${conv.id.slice(0, 6)}`;

              const preview = latest?.content?.slice(0, 140) ?? "No messages yet";

              const timeLabel =
                formatRelative(
                  latest?.sent_at ?? latest?.created_at ?? conv.created_at ?? null,
                ) || "";

              const initials =
                nameLabel && nameLabel.length > 0
                  ? nameLabel.charAt(0).toUpperCase()
                  : "C";

              const secondary =
                recipientNames.length > 1
                  ? (recipientNames.length > 3
                      ? `${recipientNames.slice(0, 3).join(", ")}‚Ä¶`
                      : recipientNames.join(", "))
                  : null;

              return (
                <li key={conv.id} className="flex items-center gap-3 px-3 py-3">
                  <Link
                    href={`/chat/${conv.id}`}
                    className="flex flex-1 items-center gap-3 hover:bg-neutral-900/30 rounded-md px-1 py-1 transition-colors"
                  >
                    <div className="flex h-9 w-9 items-center justify-center rounded-full bg-orange-500/90 text-sm font-semibold text-black">
                      {initials}
                    </div>

                    <div className="min-w-0 flex-1">
                      <div className="flex items-center gap-2">
                        <p className="truncate text-sm font-medium text-foreground">
                          {nameLabel}
                        </p>
                        {item.unread_count > 0 ? (
                          <span className="inline-flex items-center rounded-full bg-orange-500 px-1.5 py-0.5 text-[10px] font-semibold text-black">
                            {item.unread_count}
                          </span>
                        ) : null}
                      </div>
                      {secondary ? (
                        <p className="mt-0.5 line-clamp-1 text-[10px] text-neutral-400">
                          {secondary}
                        </p>
                      ) : null}
                      <p className="mt-1 line-clamp-1 text-xs text-neutral-400">
                        {preview}
                      </p>
                    </div>

                    <div className="flex flex-col items-end gap-1">
                      {timeLabel ? (
                        <span className="text-[10px] text-neutral-500">
                          {timeLabel}
                        </span>
                      ) : null}
                    </div>
                  </Link>

                  <button
                    type="button"
                    onClick={() => void handleDelete(conv.id)}
                    className="ml-2 rounded-md border border-red-500/50 px-2 py-1 text-[10px] font-semibold text-red-200 hover:bg-red-500/20"
                  >
                    Delete
                  </button>
                </li>
              );
            })}
          </ul>
        </div>
      )}

      <NewChatModal
        isOpen={isNewChatOpen}
        onClose={() => setIsNewChatOpen(false)}
        onCreated={() => {
          void loadConversations();
        }}
      />
    </PageShell>
  );
}

========================================
FILE: app/coming-soon/page.tsx
========================================
// app/coming-soon/page.tsx

// Let Next treat this as a normal (dynamic) page so it can safely use cookies
// or other dynamic features in the shared layout. If you want, you can
// explicitly say `force-dynamic`, but omitting `dynamic` is enough.
export default function ComingSoonPage() {
  return (
    <main className="min-h-screen flex items-center justify-center bg-black text-white">
      <div className="text-center space-y-6 px-6">
        <h1 className="font-header text-4xl text-accent">üöß Coming Soon üöß</h1>
        <p className="text-neutral-300">
          ProFixIQ is under active development. Please check back soon.
        </p>
      </div>
    </main>
  );
}

========================================
FILE: app/compare-plans/page.tsx
========================================
"use client";

import Link from "next/link";
import { FaCheck, FaTimes } from "react-icons/fa";

export default function ComparePlansPage() {
  const features = [
    "AI Diagnosis & Tech Assistant",
    "Custom Inspection System ( mobile & desktop)",
    "Work Orders & Job Queue",
    "Voice-Controlled Inspections",
    "Photo-to-Quote & PDF Export",
    "Custom Inspection Creation",
    "Shop Setup & Team Roles",
    "Mobile Companion Access",
    "User Limit",
    "Priority Support",
  ];

  const plans = [
    {
      name: "Shop 30",
      price: "$300",
      tag: "Up to 30 users",
      description: "Full ProFixIQ stack for small & mid-size teams.",
      values: [
        // AI Diagnosis & Tech Assistant
        <FaCheck key="shop30-ai" className="mx-auto text-emerald-400" />,
        // Inspection System
        <FaCheck key="shop30-insp" className="mx-auto text-emerald-400" />,
        // Work Orders & Job Queue
        <FaCheck key="shop30-wo" className="mx-auto text-emerald-400" />,
        // Voice-Controlled Inspections
        <FaCheck key="shop30-voice" className="mx-auto text-emerald-400" />,
        // Photo-to-Quote & PDF Export
        <FaCheck key="shop30-photo" className="mx-auto text-emerald-400" />,
        // Custom Inspection Creation
        <FaCheck key="shop30-custom" className="mx-auto text-emerald-400" />,
        // Shop Setup & Team Roles
        <FaCheck key="shop30-roles" className="mx-auto text-emerald-400" />,
        // Mobile Companion Access
        <FaCheck key="shop30-mobile" className="mx-auto text-emerald-400" />,
        // User Limit
        <span
          key="shop30-users"
          className="text-xs font-medium text-neutral-100"
        >
          Up to 30 users
        </span>,
        // Priority Support
        <span
          key="shop30-support"
          className="text-xs font-medium text-neutral-300"
        >
          Standard
        </span>,
      ],
    },
    {
      name: "Unlimited Shop",
      price: "$500",
      tag: "Unlimited users",
      description: "Larger teams, multi-bay shops & power users.",
      values: [
        // AI Diagnosis & Tech Assistant
        <FaCheck key="unlim-ai" className="mx-auto text-emerald-400" />,
        // Inspection System
        <FaCheck key="unlim-insp" className="mx-auto text-emerald-400" />,
        // Work Orders & Job Queue
        <FaCheck key="unlim-wo" className="mx-auto text-emerald-400" />,
        // Voice-Controlled Inspections
        <FaCheck key="unlim-voice" className="mx-auto text-emerald-400" />,
        // Photo-to-Quote & PDF Export
        <FaCheck key="unlim-photo" className="mx-auto text-emerald-400" />,
        // Custom Inspection Creation
        <FaCheck key="unlim-custom" className="mx-auto text-emerald-400" />,
        // Shop Setup & Team Roles
        <FaCheck key="unlim-roles" className="mx-auto text-emerald-400" />,
        // Mobile Companion Access
        <FaCheck key="unlim-mobile" className="mx-auto text-emerald-400" />,
        // User Limit
        <span
          key="unlim-users"
          className="text-xs font-medium text-neutral-100"
        >
          Unlimited users
        </span>,
        // Priority Support
        <span
          key="unlim-support"
          className="rounded-full bg-emerald-500/15 px-2 py-0.5 text-xs font-semibold text-emerald-300">
          Priority
        </span>,
      ],
    },
  ];

  return (
    <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#1f2937_0,_#020617_55%,_#000000_100%)] px-4 py-12 text-white">
      <div className="mx-auto max-w-6xl">
        {/* Header */}
        <div className="mb-8 flex flex-col items-start justify-between gap-4 sm:flex-row sm:items-center">
          <div>
            <p className="mb-1 text-xs font-semibold uppercase tracking-[0.25em] text-neutral-400">
              ProFixIQ ‚Ä¢ Pricing
            </p>
            <h1 className="bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] bg-clip-text text-4xl font-blackops text-transparent sm:text-5xl">
              Shop Plans
            </h1>
            <p className="mt-2 max-w-xl text-sm text-neutral-300">
              One platform for inspections, work orders, AI diagnosis and the
              mobile tech companion. Choose the seat count that fits your shop.
            </p>
          </div>

          <Link
            href="/"
            className="inline-flex items-center rounded-full border border-[var(--accent-copper-soft)] bg-black/60 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-[var(--accent-copper-soft)] shadow-[0_0_16px_rgba(212,118,49,0.55)] hover:bg-[var(--accent-copper-faint)]"
          >
            ‚Üê Back to app
          </Link>
        </div>

        {/* Plans table */}
        <div className="overflow-x-auto rounded-2xl border border-[var(--metal-border-soft)] bg-black/60 backdrop-blur">
          <table className="w-full text-left text-sm">
            <thead className="bg-[linear-gradient(to_right,rgba(24,24,27,0.95),rgba(15,23,42,0.98))]">
              <tr>
                <th className="border-b border-[var(--metal-border-soft)] px-4 py-4 text-xs font-semibold uppercase tracking-[0.2em] text-neutral-400">
                  Features
                </th>
                {plans.map((plan) => (
                  <th
                    key={plan.name}
                    className="border-b border-[var(--metal-border-soft)] px-4 py-4 text-center align-bottom"
                  >
                    <div className="inline-flex flex-col items-center gap-1 rounded-2xl bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.3),_rgba(15,23,42,0.9))] px-4 py-3 shadow-[0_0_25px_rgba(212,118,49,0.45)]">
                      <span className="text-xs font-semibold uppercase tracking-[0.22em] text-neutral-300">
                        {plan.tag}
                      </span>
                      <div className="text-lg font-blackops text-white">
                        {plan.name}
                      </div>
                      <div className="text-sm font-semibold text-[var(--accent-copper-soft)]">
                        {plan.price}
                        <span className="text-xs text-neutral-400"> / month</span>
                      </div>
                      <p className="mt-1 max-w-[14rem] text-[11px] text-neutral-300">
                        {plan.description}
                      </p>
                    </div>
                  </th>
                ))}
              </tr>
            </thead>
            <tbody>
              {features.map((feature, i) => (
                <tr
                  key={feature}
                  className={
                    i % 2 === 0
                      ? "bg-gradient-to-r from-black via-neutral-950 to-black"
                      : "bg-neutral-950/90"
                  }
                >
                  <td className="border-t border-[var(--metal-border-soft)] px-4 py-3 text-xs font-medium text-neutral-200">
                    {feature}
                  </td>
                  {plans.map((plan) => (
                    <td
                      key={plan.name + "-" + i}
                      className="border-t border-[var(--metal-border-soft)] px-4 py-3 text-center align-middle"
                    >
                      {plan.values[i] ?? (
                        <FaTimes className="mx-auto text-neutral-600" />
                      )}
                    </td>
                  ))}
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {/* CTA */}
        <div className="mt-10 text-center">
          <Link
            href="/subscribe"
            className="inline-flex items-center justify-center rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-8 py-3 text-sm font-blackops uppercase tracking-[0.26em] text-black shadow-[0_0_30px_rgba(212,118,49,0.8)] hover:brightness-110"
          >
            Get started with ProFixIQ
          </Link>
          <p className="mt-3 text-[11px] text-neutral-500">
            No per-inspection fees. Cancel anytime.
          </p>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/confirm/ConfirmContent.tsx
========================================
"use client";

import { useEffect, useRef } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export default function ConfirmContent() {
  const router = useRouter();
  const sp = useSearchParams();
  const supabase = createClientComponentClient<Database>();
  const ran = useRef(false);

  useEffect(() => {
    const run = async () => {
      if (ran.current) return;
      ran.current = true;

      try {
        // ‚úÖ Exchange the code in the URL for a session (safe for all typings)
        const url = typeof window !== "undefined" ? window.location.href : "";
        await supabase.auth.exchangeCodeForSession(url);

        // ‚úÖ Ensure cookies are written and middleware can see the session
        await supabase.auth.getSession();
        router.refresh();
      } catch (err) {
        console.warn("exchangeCodeForSession failed (continuing):", err);
      }

      // ‚úÖ Decide where to go next
      const redirect = sp.get("redirect") || undefined;
      let completed = false;

      try {
        const { data: u } = await supabase.auth.getUser();
        if (u?.user?.id) {
          const { data: profile } = await supabase
            .from("profiles")
            .select("completed_onboarding")
            .eq("id", u.user.id)
            .maybeSingle();
          completed = !!profile?.completed_onboarding;
        }
      } catch {
        /* ignore */
      }

      // ‚úÖ Route depending on onboarding status
      const dest = completed ? (redirect ?? "/dashboard") : "/onboarding";
      router.replace(dest);

      // ‚úÖ Hard fallback for Safari / mobile cache
      setTimeout(() => {
        if (typeof window !== "undefined") {
          const want = new URL(dest, window.location.origin).href;
          if (window.location.href !== want) window.location.assign(dest);
        }
      }, 100);
    };

    void run();
  }, [router, sp, supabase]);

  return (
    <div className="min-h-[60vh] grid place-items-center text-white">
      <div className="text-center">
        <h1 className="text-2xl font-bold">Finishing sign-in‚Ä¶</h1>
        <p className="text-sm text-neutral-400">One moment while we set things up.</p>
      </div>
    </div>
  );
}

========================================
FILE: app/confirm/page.tsx
========================================
"use client";

// app/confirm/page.tsx
import { Suspense } from "react";
import ConfirmContent from "./ConfirmContent";

export default function Page() {
  return (
    <Suspense
      fallback={
        <div className="min-h-[60vh] grid place-items-center text-white">
          <div className="text-center">
            <p className="text-lg font-semibold">Finishing sign-in‚Ä¶</p>
            <p className="text-sm text-neutral-400">One moment.</p>
          </div>
        </div>
      }
    >
      <ConfirmContent />
    </Suspense>
  );
}

========================================
FILE: app/customers/[id]/page.tsx
========================================
export { default } from "@/features/customers/app/customers/[id]/page";

========================================
FILE: app/dashboard/admin/audit/page.tsx
========================================

import AuditClient from "@/features/dashboard/app/dashboard/admin/AuditClient";
export default function Page(){ return <AuditClient/>; }


========================================
FILE: app/dashboard/admin/billing/page.tsx
========================================
// app/dashboard/admin/billing/page.tsx

import BillingClient from "@/features/dashboard/app/dashboard/admin/BillingClient";

export default function Page() {
  return <BillingClient />;
}

========================================
FILE: app/dashboard/admin/certifications/page.tsx
========================================
// app/dashboard/admin/certifications/page.tsx

import CertificationsClient from "@/features/dashboard/app/dashboard/admin/CertificationsClient";

export default function Page() {
  return <CertificationsClient />;
}

========================================
FILE: app/dashboard/admin/create-user/page.tsx
========================================

import CreateUserClient from "@/features/dashboard/app/dashboard/admin/CreateUserClient";
export default function Page(){ return <CreateUserClient/>; }


========================================
FILE: app/dashboard/admin/employee-docs/page.tsx
========================================

import EmployeeDocsClient from "@/features/dashboard/app/dashboard/admin/EmployeeDocsClient";
export default function Page(){ return <EmployeeDocsClient/>; }


========================================
FILE: app/dashboard/admin/employees/page.tsx
========================================

import EmployeesClient from "@/features/dashboard/app/dashboard/admin/EmployeesClient";
export default function Page(){ return <EmployeesClient/>; }


========================================
FILE: app/dashboard/admin/roles/page.tsx
========================================

import RolesClient from "@/features/dashboard/app/dashboard/admin/RolesClient";
export default function Page(){ return <RolesClient/>; }


========================================
FILE: app/dashboard/admin/scheduling/page.tsx
========================================
// app/dashboard/admin/scheduling/page.tsx

import SchedulingClient from "@/features/dashboard/app/dashboard/admin/SchedulingClient";

export default function Page() {
  return <SchedulingClient />;
}


========================================
FILE: app/dashboard/admin/shops/page.tsx
========================================

import ShopsClient from "@/features/dashboard/app/dashboard/admin/ShopsClient";
export default function Page(){ return <ShopsClient/>; }


========================================
FILE: app/dashboard/admin/teams/page.tsx
========================================
// app/dashboard/admin/teams/page.tsx

import TeamsClient from "@/features/dashboard/app/dashboard/admin/TeamsClient";

export default function Page() {
  return <TeamsClient />;
}


========================================
FILE: app/dashboard/admin/users/page.tsx
========================================
import { Suspense } from "react";
import UsersPageClient from "@/features/dashboard/app/dashboard/admin//UsersPageClient";

export default function Page() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading users‚Ä¶</div>}>
      <UsersPageClient />
    </Suspense>
  );
}


========================================
FILE: app/dashboard/advisor/bookings/page.tsx
========================================
export { default } from "../../bookings/page";

========================================
FILE: app/dashboard/bookings/BookingsTable.tsx
========================================
"use client";

import { useState } from "react";
import { toast } from "sonner";

type Row = {
  id: string;
  starts_at: string;
  ends_at: string;
  status: "pending" | "confirmed" | "cancelled" | "completed";
  notes: string | null;
  customer_id: string | null;
  vehicle_id: string | null;
};

export default function BookingsTable({
  initialRows,
  canEdit,
}: {
  initialRows: Row[];
  canEdit: boolean;
}) {
  const [rows, setRows] = useState<Row[]>(initialRows);
  const [busy, setBusy] = useState<string | null>(null);

  async function patch(id: string, body: Partial<Row>) {
    setBusy(id);
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (!res.ok) throw new Error((await res.json()).error || "Update failed");
      const updated = await res.json();
      setRows((prev) => prev.map((r) => (r.id === id ? { ...r, ...updated } : r)));
      toast.success("Booking updated.");
    } catch (e: unknown) {
    const message = e instanceof Error ? e.message : "Could not update booking.";
    toast.error(message);
    } finally {
      setBusy(null);
    }
  }

  return (
    <div className="overflow-x-auto rounded-xl border border-neutral-800">
      <table className="min-w-full text-sm">
        <thead className="bg-neutral-900 text-neutral-300">
          <tr>
            <th className="px-3 py-2 text-left">When</th>
            <th className="px-3 py-2 text-left">Ends</th>
            <th className="px-3 py-2 text-left">Status</th>
            <th className="px-3 py-2 text-left">Notes</th>
            {canEdit && <th className="px-3 py-2 text-right">Actions</th>}
          </tr>
        </thead>
        <tbody>
          {rows.map((r) => (
            <tr key={r.id} className="border-t border-neutral-800">
              <td className="px-3 py-2">
                {new Date(r.starts_at).toLocaleString()}
              </td>
              <td className="px-3 py-2">
                {new Date(r.ends_at).toLocaleString()}
              </td>
              <td className="px-3 py-2">{r.status}</td>
              <td className="px-3 py-2 text-neutral-300">
                {r.notes || <span className="text-neutral-500">‚Äî</span>}
              </td>
              {canEdit && (
                <td className="px-3 py-2 text-right">
                  <div className="inline-flex gap-2">
                    <button
                      disabled={busy === r.id}
                      className="px-2 py-1 rounded border border-orange-600 text-orange-400 hover:bg-orange-600 hover:text-black"
                      onClick={() => patch(r.id, { status: "confirmed" })}
                    >
                      Confirm
                    </button>
                    <button
                      disabled={busy === r.id}
                      className="px-2 py-1 rounded border border-neutral-600 text-neutral-300 hover:bg-neutral-700"
                      onClick={() => patch(r.id, { status: "completed" })}
                    >
                      Complete
                    </button>
                    <button
                      disabled={busy === r.id}
                      className="px-2 py-1 rounded border border-red-600 text-red-400 hover:bg-red-600 hover:text-black"
                      onClick={() => patch(r.id, { status: "cancelled" })}
                    >
                      Cancel
                    </button>
                  </div>
                </td>
              )}
            </tr>
          ))}
          {rows.length === 0 && (
            <tr>
              <td className="px-3 py-6 text-neutral-400" colSpan={5}>
                No bookings yet.
              </td>
            </tr>
          )}
        </tbody>
      </table>
    </div>
  );
}

========================================
FILE: app/dashboard/bookings/BookingsTableWrapper.tsx
========================================
// app/dashboard/bookings/BookingsTableWrapper.tsx
"use client";

import BookingsTable from "./BookingsTable";

type Row = {
  id: string;
  starts_at: string;
  ends_at: string;
  status: "pending" | "confirmed" | "cancelled" | "completed";
  notes: string | null;
  customer_id: string | null;
  vehicle_id: string | null;
};

export default function BookingsTableWrapper({
  initialRows,
  canEdit,
}: {
  initialRows: Row[];
  canEdit: boolean;
}) {
  return <BookingsTable initialRows={initialRows} canEdit={canEdit} />;
}

========================================
FILE: app/dashboard/bookings/page.tsx
========================================
// app/dashboard/bookings/page.tsx
export const dynamic = "force-dynamic";
export const revalidate = 0;

import { cookies } from "next/dist/server/request/cookies";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import BookingsTable from "./BookingsTable";

export default async function BookingsPage() {
  // ‚úÖ correct helper for server components
  const supabase = createServerComponentClient<Database>({ cookies });

  // who am I?
  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-black via-slate-950 to-black px-4 py-10 text-foreground">
        <div className="mx-auto max-w-xl rounded-2xl border border-[var(--metal-border-soft)] bg-card/95 p-6 text-center shadow-[0_20px_50px_rgba(0,0,0,0.9)]">
          <h1
            className="mb-3 text-2xl font-blackops tracking-[0.24em] text-[var(--accent-copper-light)]"
            style={{ fontFamily: "var(--font-blackops), system-ui" }}
          >
            Shop Bookings
          </h1>
          <p className="text-sm text-neutral-300">
            You must be signed in to view bookings.
          </p>
        </div>
      </div>
    );
  }

  // get staff shop
  const { data: prof } = await supabase
    .from("profiles")
    .select("shop_id, full_name, role")
    .eq("id", user.id)
    .single();

  if (!prof?.shop_id) {
    return (
      <div className="min-h-screen bg-gradient-to-b from-black via-slate-950 to-black px-4 py-10 text-foreground">
        <div className="mx-auto max-w-xl rounded-2xl border border-[var(--metal-border-soft)] bg-card/95 p-6 text-center shadow-[0_20px_50px_rgba(0,0,0,0.9)]">
          <h1
            className="mb-3 text-2xl font-blackops tracking-[0.24em] text-[var(--accent-copper-light)]"
            style={{ fontFamily: "var(--font-blackops), system-ui" }}
          >
            Shop Bookings
          </h1>
          <p className="text-sm text-neutral-300">
            No shop is linked to your profile yet. Complete onboarding or ask an
            admin to assign you to a shop.
          </p>
        </div>
      </div>
    );
  }

  // fetch future (and recent) bookings in the same shop
  const sevenDaysAgoIso = new Date(
    new Date().setDate(new Date().getDate() - 7),
  ).toISOString();

  const { data: bookings } = await supabase
    .from("bookings")
    .select("id, starts_at, ends_at, status, notes, customer_id, vehicle_id")
    .eq("shop_id", prof.shop_id)
    .gte("starts_at", sevenDaysAgoIso)
    .order("starts_at", { ascending: true });

  return (
    <div className="min-h-screen bg-gradient-to-b from-black via-slate-950 to-black px-4 py-10 text-foreground">
      <div className="mx-auto max-w-6xl space-y-6">
        {/* Header */}
        <header className="space-y-2">
          <div className="inline-flex items-center rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.24em] text-neutral-400">
            Advisor ‚Ä¢ Bookings
          </div>
          <h1
            className="text-3xl font-blackops tracking-[0.26em] text-[var(--accent-copper-light)] sm:text-4xl"
            style={{ fontFamily: "var(--font-blackops), system-ui" }}
          >
            Shop Bookings
          </h1>
          <p className="max-w-xl text-xs text-neutral-400 sm:text-sm">
            View and manage upcoming appointments for{" "}
            <span className="font-medium text-neutral-200">
              {prof.full_name ?? "your shop"}
            </span>
            .
          </p>
        </header>

        {/* Card */}
        <section
          className="
            rounded-2xl border border-[var(--metal-border-soft)]
            bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.16),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.98),#020617_80%)]
            p-4 sm:p-6
            shadow-[0_24px_70px_rgba(0,0,0,0.95)]
          "
        >
          <div className="mb-4 flex items-center justify-between gap-2">
            <h2 className="text-sm font-semibold uppercase tracking-[0.18em] text-neutral-300">
              Upcoming & recent
            </h2>
            <span className="h-px flex-1 bg-gradient-to-r from-[var(--accent-copper-soft)]/70 via-neutral-700 to-transparent" />
          </div>

          <BookingsTable
            initialRows={bookings ?? []}
            canEdit={["owner", "admin", "manager", "advisor"].includes(
              prof.role ?? "",
            )}
          />
        </section>
      </div>
    </div>
  );
}

========================================
FILE: app/dashboard/error.tsx
========================================
// app/dashboard/error.tsx
"use client";

import { useEffect } from "react";

export default function DashboardError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error("Dashboard error:", error);
  }, [error]);

  return (
    <div className="p-6 text-red-400 space-y-4">
      <h1 className="text-2xl font-bold">‚ö†Ô∏è Dashboard Error</h1>
      <p>Something went wrong while loading the dashboard.</p>

      {/* Helpful details during dev */}
      <pre className="whitespace-pre-wrap bg-neutral-900 text-orange-400 p-3 rounded-lg overflow-x-auto">
        {error.message}
        {error.digest ? `\nDigest: ${error.digest}` : null}
      </pre>

      <button
        onClick={() => reset()}
        className="mt-4 rounded bg-orange-600 px-4 py-2 text-white hover:bg-orange-500"
      >
        Try again
      </button>
    </div>
  );
}

========================================
FILE: app/dashboard/layout.tsx
========================================
// app/dashboard/layout.tsx
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return children;
}

========================================
FILE: app/dashboard/manager/dispatch/page.tsx
========================================
export default function Page() {
  return (
    <div className="p-6 text-white">
      <p>Placeholder route. Wire up the real UI next.</p>
    </div>
  );
}


========================================
FILE: app/dashboard/owner/create-user/page.tsx
========================================
"use client";

import { Suspense } from "react";
import FeaturePage from "@/features/dashboard/app/dashboard/owner/create-user/page";

export default function Page() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading‚Ä¶</div>}>
      <FeaturePage />
    </Suspense>
  );
}


========================================
FILE: app/dashboard/owner/import-customers/page.tsx
========================================
"use client";

import { Suspense } from "react";
import FeaturePage from "@/features/dashboard/app/dashboard/owner/import-customers/page";


export default function Page() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading‚Ä¶</div>}>
      <FeaturePage />
    </Suspense>
  );
}


========================================
FILE: app/dashboard/owner/payments/page.tsx
========================================
// app/dashboard/owner/payments/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type ProfileScope = {
  id: string;
  role: string | null;
  shop_id: string | null;
};

type PaymentRow = DB["public"]["Tables"]["payments"]["Row"];

const ADMIN_ROLES = new Set(["owner", "admin", "manager"]);

function fmtMoney(cents: number | null, currency: string | null): string {
  const c = typeof cents === "number" ? cents : 0;
  const cur = String(currency ?? "usd").toUpperCase();
  const amt = (c / 100).toFixed(2);
  return `${cur} ${amt}`;
}

function fmtDate(v: string | null): string {
  if (!v) return "‚Äî";
  const d = new Date(v);
  if (Number.isNaN(d.getTime())) return v;
  return d.toLocaleString();
}

function calcNet(amountCents: number | null, feeCents: number | null): number {
  const a = typeof amountCents === "number" ? amountCents : 0;
  const f = typeof feeCents === "number" ? feeCents : 0;
  return Math.max(0, a - f);
}

export default function OwnerPaymentsPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(true);
  const [forbidden, setForbidden] = useState<string | null>(null);

  const [shopId, setShopId] = useState<string | null>(null);
  const [rows, setRows] = useState<PaymentRow[]>([]);

  // UI filters
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<"all" | "succeeded" | "pending" | "failed" | "refunded">("all");

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);
      setForbidden(null);

      const {
        data: { session },
      } = await supabase.auth.getSession();

      const uid = session?.user?.id ?? null;
      if (!uid) {
        if (!cancelled) {
          setForbidden("Not signed in.");
          setLoading(false);
        }
        return;
      }

      const { data: me, error: meErr } = await supabase
        .from("profiles")
        .select("id, role, shop_id")
        .eq("id", uid)
        .maybeSingle<ProfileScope>();

      if (meErr) {
        if (!cancelled) {
          setForbidden(meErr.message);
          setLoading(false);
        }
        return;
      }

      const role = String(me?.role ?? "").toLowerCase();
      const sId = me?.shop_id ?? null;

      if (!sId || !ADMIN_ROLES.has(role)) {
        if (!cancelled) {
          setForbidden("Forbidden.");
          setLoading(false);
        }
        return;
      }

      if (!cancelled) setShopId(sId);

      const { data: payments, error: pErr } = await supabase
        .from("payments")
        .select(
          "id, shop_id, work_order_id, stripe_payment_intent_id, stripe_checkout_session_id, amount_cents, currency, platform_fee_cents, status, created_at",
        )
        .eq("shop_id", sId)
        .order("created_at", { ascending: false })
        .limit(200);

      if (pErr) {
        if (!cancelled) {
          setForbidden(pErr.message);
          setLoading(false);
        }
        return;
      }

      if (!cancelled) {
        setRows((payments ?? []) as PaymentRow[]);
        setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase]);

  const filtered = useMemo(() => {
    const needle = q.trim().toLowerCase();
    return rows.filter((r) => {
      if (status !== "all" && String(r.status ?? "").toLowerCase() !== status) return false;

      if (!needle) return true;

      const w = String(r.work_order_id ?? "").toLowerCase();
      const pi = String(r.stripe_payment_intent_id ?? "").toLowerCase();
      const cs = String(r.stripe_checkout_session_id ?? "").toLowerCase();
      return w.includes(needle) || pi.includes(needle) || cs.includes(needle);
    });
  }, [rows, q, status]);

  if (loading) {
    return (
      <div className="p-6">
        <div className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/40 px-4 py-3 text-sm text-neutral-300">
          Loading payments‚Ä¶
        </div>
      </div>
    );
  }

  if (forbidden) {
    return (
      <div className="p-6">
        <div className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/40 px-4 py-3 text-sm text-neutral-300">
          {forbidden}
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-4">
      {/* Header */}
      <div className="rounded-2xl border border-[var(--metal-border-soft)] bg-[radial-gradient(circle_at_top,_#050910,_#020308_60%,_#000)] px-4 py-4 shadow-[0_24px_80px_rgba(0,0,0,0.75)]">
        <div className="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
          <div>
            <div className="font-blackops text-[0.75rem] tracking-[0.22em] text-neutral-200">
              PAYMENTS
            </div>
            <div className="mt-1 text-sm text-neutral-400">
              Customer payments collected through Stripe Connect ‚Ä¢ Platform fee applied automatically (3%).
            </div>
            {shopId ? (
              <div className="mt-1 text-[0.7rem] text-neutral-500">Shop: {shopId}</div>
            ) : null}
          </div>

          <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              placeholder="Search WO / payment_intent / session‚Ä¶"
              className="h-9 w-full sm:w-72 rounded-xl border border-[var(--metal-border-soft)] bg-black/40 px-3 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none focus:border-[var(--accent-copper-soft)]"
            />

            <select
              value={status}
              onChange={(e) =>
                setStatus(
                  (String(e.target.value) as typeof status) ?? "all",
                )
              }
              className="h-9 rounded-xl border border-[var(--metal-border-soft)] bg-black/40 px-3 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)]"
            >
              <option value="all">All statuses</option>
              <option value="succeeded">Succeeded</option>
              <option value="pending">Pending</option>
              <option value="failed">Failed</option>
              <option value="refunded">Refunded</option>
            </select>
          </div>
        </div>
      </div>

      {/* Table */}
      <div className="overflow-hidden rounded-2xl border border-[var(--metal-border-soft)] bg-black/35">
        <div className="border-b border-[var(--metal-border-soft)] bg-black/40 px-4 py-2 text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
          Recent payments
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-black/30 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-400">
              <tr>
                <th className="px-4 py-3 text-left">Date</th>
                <th className="px-4 py-3 text-left">Work Order</th>
                <th className="px-4 py-3 text-left">Amount</th>
                <th className="px-4 py-3 text-left">Platform Fee</th>
                <th className="px-4 py-3 text-left">Net to Shop</th>
                <th className="px-4 py-3 text-left">Status</th>
                <th className="px-4 py-3 text-left">Stripe IDs</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-[var(--metal-border-soft)]">
              {filtered.length === 0 ? (
                <tr>
                  <td colSpan={7} className="px-4 py-6 text-neutral-400">
                    No payments found.
                  </td>
                </tr>
              ) : (
                filtered.map((p) => {
                  const amt = fmtMoney(p.amount_cents, p.currency);
                  const fee = fmtMoney(p.platform_fee_cents, p.currency);
                  const net = fmtMoney(
                    calcNet(p.amount_cents, p.platform_fee_cents),
                    p.currency,
                  );

                  const woId = p.work_order_id ? String(p.work_order_id) : "";

                  return (
                    <tr key={String(p.id)} className="hover:bg-white/5">
                      <td className="px-4 py-3 text-neutral-200">
                        {fmtDate(p.created_at)}
                      </td>

                      <td className="px-4 py-3">
                        {woId ? (
                          <Link
                            href={`/work-orders/${woId}`}
                            className="text-[var(--accent-copper-soft)] hover:text-[var(--accent-copper-light)] underline underline-offset-4"
                          >
                            {woId.slice(0, 8)}‚Ä¶
                          </Link>
                        ) : (
                          <span className="text-neutral-500">‚Äî</span>
                        )}
                      </td>

                      <td className="px-4 py-3 text-neutral-200">{amt}</td>
                      <td className="px-4 py-3 text-neutral-200">{fee}</td>
                      <td className="px-4 py-3 text-neutral-200">{net}</td>

                      <td className="px-4 py-3">
                        <span className="inline-flex items-center rounded-full border border-[var(--metal-border-soft)] bg-black/40 px-2 py-1 text-[0.7rem] tracking-[0.12em] text-neutral-200">
                          {String(p.status ?? "unknown").toUpperCase()}
                        </span>
                      </td>

                      <td className="px-4 py-3 text-[0.75rem] text-neutral-300">
                        <div className="space-y-1">
                          <div>
                            <span className="text-neutral-500">pi:</span>{" "}
                            <span className="font-mono">{String(p.stripe_payment_intent_id ?? "‚Äî")}</span>
                          </div>
                          <div>
                            <span className="text-neutral-500">cs:</span>{" "}
                            <span className="font-mono">{String(p.stripe_checkout_session_id ?? "‚Äî")}</span>
                          </div>
                        </div>
                      </td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>

        <div className="border-t border-[var(--metal-border-soft)] bg-black/40 px-4 py-2 text-[0.7rem] text-neutral-500">
          Showing {filtered.length} of {rows.length} (latest 200)
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/dashboard/owner/reports/page.tsx
========================================
"use client";

import { Suspense } from "react";
import FeaturePage from "@/features/dashboard/app/dashboard/owner/reports/page";

export default function Page() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading‚Ä¶</div>}>
      <FeaturePage />
    </Suspense>
  );
}


========================================
FILE: app/dashboard/owner/reports/technicians/page.tsx
========================================
// app/dashboard/owner/reports/technicians/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import type { TimeRange } from "@shared/lib/stats/getShopStats";
import {
  getTechLeaderboard,
  type TechLeaderboardRow,
} from "@shared/lib/stats/getTechLeaderboard";
import { formatCurrency } from "@shared/lib/formatters";
import { Button } from "@shared/components/ui/Button";
import PageShell from "@/features/shared/components/PageShell";

type Range = TimeRange;

const RANGE_LABELS: Record<Range, string> = {
  weekly: "Last 7 days",
  monthly: "Last 30 days",
  quarterly: "Last 90 days",
  yearly: "Last 12 months",
};

/* ---------------------------------------------------------------------- */
/* Theme tokens (burnt copper / metallic / glass)                          */
/* ---------------------------------------------------------------------- */

const T = {
  border: "border-[color:var(--metal-border-soft,#1f2937)]",
  borderStrong: "border-[color:var(--metal-border,#111827)]", // ‚úÖ ADD THIS
  panel:
    "bg-[linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02))] bg-black/35 backdrop-blur-md",
  panelStrong:
    "bg-[radial-gradient(900px_520px_at_18%_0%,rgba(197,106,47,0.12),transparent_55%),linear-gradient(180deg,rgba(0,0,0,0.62),rgba(0,0,0,0.42))] backdrop-blur-md",
  shadow: "shadow-[0_18px_40px_rgba(0,0,0,0.85)]",
  copperFill:
    "border-[color:var(--accent-copper,#c56a2f)] bg-[color:var(--accent-copper,#c56a2f)] text-black shadow-[0_0_22px_rgba(197,106,47,0.35)]",
  copperSoftText: "text-[color:var(--accent-copper-soft,#e7a36c)]",
  copperSoftBorder: "border-[color:var(--accent-copper-soft,#e7a36c)]/55",
};

export default function TechLeaderboardPage() {
  const supabase = useMemo(
    () => createClientComponentClient<Database>(),
    [],
  );

  const [shopId, setShopId] = useState<string | null>(null);
  const [range, setRange] = useState<Range>("monthly");
  const [rows, setRows] = useState<TechLeaderboardRow[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [start, setStart] = useState<string | null>(null);
  const [end, setEnd] = useState<string | null>(null);

  // resolve shop
  useEffect(() => {
    (async () => {
      try {
        const {
          data: { user },
          error: userErr,
        } = await supabase.auth.getUser();

        if (userErr || !user) {
          setError("You must be signed in to view reports.");
          return;
        }

        const { data, error: profErr } = await supabase
          .from("profiles")
          .select("shop_id")
          .eq("id", user.id)
          .maybeSingle();

        if (profErr) {
          setError(profErr.message);
          return;
        }

        if (!data?.shop_id) {
          setError("No shop linked to your profile yet.");
          return;
        }

        setShopId(data.shop_id);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load shop information.";
        setError(msg);
      }
    })();
  }, [supabase]);

  // load leaderboard
  useEffect(() => {
    if (!shopId) return;

    (async () => {
      setLoading(true);
      setError(null);

      try {
        const result = await getTechLeaderboard(shopId, range);
        setRows(result.rows);
        setStart(result.start);
        setEnd(result.end);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load tech leaderboard.";
        setError(msg);
        setRows([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [shopId, range]);

  const dateRangeLabel =
    start && end
      ? `${new Date(start).toLocaleDateString()} ‚Äì ${new Date(
          end,
        ).toLocaleDateString()}`
      : RANGE_LABELS[range];

  return (
    <PageShell
      title="Tech Leaderboard"
      description="Per-technician revenue, jobs, hours and efficiency for your chosen time range."
    >
      <div className="mx-auto max-w-6xl space-y-6 text-foreground">
        {/* Controls -------------------------------------------------------- */}
        <section
          className={[
            "flex flex-wrap items-center gap-3 rounded-2xl border px-4 py-3",
            T.border,
            T.panel,
            T.shadow,
          ].join(" ")}
        >
          <div className="space-y-1">
            <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
              Time range
            </div>

            <div className="flex flex-wrap gap-2">
              {(["weekly", "monthly", "quarterly", "yearly"] as Range[]).map(
                (r) => {
                  const isActive = range === r;
                  return (
                    <Button
                      key={r}
                      type="button"
                      size="sm"
                      variant={isActive ? "default" : "outline"}
                      className={
                        isActive
                          ? T.copperFill
                          : [
                              "text-sm",
                              T.border,
                              "bg-black/25",
                              "hover:bg-black/35",
                            ].join(" ")
                      }
                      onClick={() => setRange(r)}
                    >
                      {r.charAt(0).toUpperCase() + r.slice(1)}
                    </Button>
                  );
                },
              )}
            </div>

            <div className="text-[0.7rem] text-neutral-400">
              {dateRangeLabel}
            </div>
          </div>
        </section>

        {/* Error / loading ------------------------------------------------- */}
        {error && (
          <div className="rounded-xl border border-red-500/30 bg-red-950/35 px-4 py-3 text-sm text-red-100">
            {error}
          </div>
        )}

        {loading && (
          <div
            className={[
              "rounded-2xl border px-4 py-6 text-sm text-neutral-400",
              T.border,
              T.panel,
              T.shadow,
            ].join(" ")}
          >
            Loading tech leaderboard‚Ä¶
          </div>
        )}

        {/* No data --------------------------------------------------------- */}
        {!loading && !error && rows.length === 0 && (
          <div
            className={[
              "rounded-2xl border px-4 py-6 text-sm text-neutral-400",
              T.border,
              T.panel,
              T.shadow,
            ].join(" ")}
          >
            No technician data found for this range.
          </div>
        )}

        {/* Table ----------------------------------------------------------- */}
        {!loading && !error && rows.length > 0 && (
          <section
            className={[
              "rounded-2xl border p-4",
              T.border,
              T.panelStrong,
              T.shadow,
            ].join(" ")}
          >
            <div className="mb-3 flex flex-wrap items-center justify-between gap-2">
              <div>
                <h2 className="text-sm font-semibold text-foreground">
                  Technician performance
                </h2>
                <p className="text-[0.7rem] text-neutral-400">
                  Revenue, jobs, hours and efficiency per technician.
                </p>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="min-w-full border-collapse text-left text-xs sm:text-sm">
                <thead
                  className={[
                    "border-b bg-black/35",
                    T.borderStrong,
                  ].join(" ")}
                >
                  <tr>
                    <Th>#</Th>
                    <Th>Tech</Th>
                    <Th>Role</Th>
                    <Th>Jobs</Th>
                    <Th>Revenue</Th>
                    <Th>Labor cost</Th>
                    <Th>Profit</Th>
                    <Th>Clocked hrs</Th>
                    <Th>Rev / hr</Th>
                    <Th>Efficiency</Th>
                    <Th className="text-center">Badge</Th>
                  </tr>
                </thead>
                <tbody>
                  {rows.map((row, idx) => {
                    const badge = efficiencyBadge(row.efficiencyPct);
                    const billedVsClockedPct =
                      row.clockedHours > 0
                        ? (row.billedHours / row.clockedHours) * 100
                        : 0;

                    return (
                      <tr
                        key={row.techId}
                        className={[
                          "border-b last:border-0",
                          "odd:bg-black/10 even:bg-black/0",
                          "hover:bg-black/20",
                          T.border,
                        ].join(" ")}
                      >
                        <Td className="font-mono text-[11px] text-neutral-500">
                          {idx + 1}
                        </Td>
                        <Td className="text-sm font-medium text-neutral-100">
                          {row.name}
                        </Td>
                        <Td className="text-[11px] text-neutral-500">
                          {row.role ?? "‚Äî"}
                        </Td>
                        <Td>{row.jobs}</Td>
                        <Td>{formatCurrency(row.revenue)}</Td>
                        <Td>{formatCurrency(row.laborCost)}</Td>
                        <Td>{formatCurrency(row.profit)}</Td>
                        <Td>
                          {row.clockedHours.toFixed(1)}
                          {row.clockedHours > 0 && (
                            <span className="ml-1 text-[11px] text-neutral-500">
                              ({billedVsClockedPct.toFixed(0)}% billed)
                            </span>
                          )}
                        </Td>
                        <Td>{formatCurrency(row.revenuePerHour)}</Td>
                        <Td>{row.efficiencyPct.toFixed(0)}%</Td>
                        <Td className="text-center">
                          {badge && (
                            <span
                              className={[
                                "inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-semibold",
                                badge.className,
                              ].join(" ")}
                            >
                              <span className="mr-1">{badge.emoji}</span>
                              {badge.label}
                            </span>
                          )}
                        </Td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </section>
        )}
      </div>
    </PageShell>
  );
}

/* ---------------------------------------------------------------------- */
/* Small helpers                                                          */
/* ---------------------------------------------------------------------- */

function efficiencyBadge(
  efficiencyPct: number,
):
  | {
      label: string;
      className: string;
      emoji: string;
    }
  | null {
  // Keep medal colors but match ‚Äúmetal/glass‚Äù + thin borders (no orange-*).
  if (efficiencyPct >= 180) {
    return {
      label: "Gold",
      className:
        "bg-yellow-500/10 border-yellow-300/40 text-yellow-200",
      emoji: "ü•á",
    };
  }
  if (efficiencyPct >= 130) {
    return {
      label: "Silver",
      className:
        "bg-slate-200/10 border-slate-200/35 text-slate-100",
      emoji: "ü•à",
    };
  }
  if (efficiencyPct >= 90) {
    return {
      label: "Bronze",
      className:
        "bg-amber-700/15 border-amber-300/35 text-amber-200",
      emoji: "ü•â",
    };
  }
  return null;
}

function Th({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <th
      className={`px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.16em] text-neutral-400 ${className}`}
    >
      {children}
    </th>
  );
}

function Td({
  children,
  className = "",
}: {
  children: React.ReactNode;
  className?: string;
}) {
  return (
    <td className={`px-3 py-2 text-xs text-neutral-100 ${className}`}>
      {children}
    </td>
  );
}

========================================
FILE: app/dashboard/owner/settings/page.tsx
========================================
"use client";

import { Suspense } from "react";
import FeaturePage from "@/features/dashboard/app/dashboard/owner/settings/page";

export default function Page() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading‚Ä¶</div>}>
      <FeaturePage />
    </Suspense>
  );
}


========================================
FILE: app/dashboard/page.tsx
========================================
// app/dashboard/page.tsx
"use client";

import { useEffect, useState, useCallback } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import Link from "next/link";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type CountState = {
  appointments: number | null;
  workOrders: number | null;
  partsRequests: number | null;
};

export default function DashboardPage() {
  const supabase = createClientComponentClient<Database>();

  const [name, setName] = useState<string | null>(null);
  const [role, setRole] = useState<string | null>(null);
  const [userId, setUserId] = useState<string | null>(null);

  const [counts, setCounts] = useState<CountState>({
    appointments: null,
    workOrders: null,
    partsRequests: null,
  });

  // current punched-in job for this user
  const [currentJob, setCurrentJob] = useState<WorkOrderLine | null>(null);
  const [currentJobWorkOrder, setCurrentJobWorkOrder] =
    useState<WorkOrder | null>(null);
  const [currentJobVehicle, setCurrentJobVehicle] =
    useState<Vehicle | null>(null);
  const [loadingCurrentJob, setLoadingCurrentJob] = useState(false);

  // fetch profile + user id
  useEffect(() => {
    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      const uid = session?.user?.id ?? null;
      setUserId(uid);

      if (!uid) return;

      const { data: profile } = await supabase
        .from("profiles")
        .select("full_name, role")
        .eq("id", uid)
        .maybeSingle();

      setName(profile?.full_name ?? null);
      setRole(profile?.role ?? null);
    })();
  }, [supabase]);

  // fetch the 3 counts
  useEffect(() => {
    (async () => {
      const [appt, wo, parts] = await Promise.all([
        supabase
          .from("bookings")
          .select("id", { count: "exact", head: true }),
        supabase
          .from("work_orders")
          .select("id", { count: "exact", head: true }),
        supabase
          .from("parts_requests")
          .select("id", { count: "exact", head: true }),
      ]);

      setCounts({
        appointments: appt.error ? 0 : appt.count ?? 0,
        workOrders: wo.error ? 0 : wo.count ?? 0,
        partsRequests: parts.error ? 0 : parts.count ?? 0,
      });
    })();
  }, [supabase]);

  /* ---------------------------------------------------------------------- */
  /* Current job ‚Äì job this user is actively punched in on                  */
  /* ---------------------------------------------------------------------- */

  const loadCurrentJob = useCallback(
    async (uid: string | null) => {
      if (!uid) {
        setCurrentJob(null);
        setCurrentJobWorkOrder(null);
        setCurrentJobVehicle(null);
        return;
      }

      setLoadingCurrentJob(true);
      try {
        const { data, error } = await supabase
  .from("work_order_lines")
  .select(
    "id, work_order_id, description, complaint, job_type, punched_in_at, punched_out_at, assigned_to",
  )
  .eq("assigned_to", uid)
  .not("punched_in_at", "is", null)
  .is("punched_out_at", null)
  .order("punched_in_at", { ascending: false })
  .limit(1)
  .maybeSingle();
         

        if (error) {
          // eslint-disable-next-line no-console
          console.error("[Dashboard] current job load error:", error);
          setCurrentJob(null);
          setCurrentJobWorkOrder(null);
          setCurrentJobVehicle(null);
          return;
        }

        const line = (data as WorkOrderLine | null) ?? null;
        setCurrentJob(line);

        if (!line?.work_order_id) {
          setCurrentJobWorkOrder(null);
          setCurrentJobVehicle(null);
          return;
        }

        // related work order
        const { data: wo, error: woErr } = await supabase
          .from("work_orders")
          .select("id, custom_id, vehicle_id")
          .eq("id", line.work_order_id)
          .maybeSingle<WorkOrder>();

        if (woErr) {
          console.error("[Dashboard] current job WO load error:", woErr);
          setCurrentJobWorkOrder(null);
          setCurrentJobVehicle(null);
          return;
        }

        const workOrder = wo ?? null;
        setCurrentJobWorkOrder(workOrder);

        if (workOrder?.vehicle_id) {
          const { data: veh, error: vehErr } = await supabase
            .from("vehicles")
            .select("id, year, make, model, license_plate")
            .eq("id", workOrder.vehicle_id)
            .maybeSingle<Vehicle>();

          if (vehErr) {
            console.error("[Dashboard] current job vehicle load error:", vehErr);
            setCurrentJobVehicle(null);
          } else {
            setCurrentJobVehicle(veh ?? null);
          }
        } else {
          setCurrentJobVehicle(null);
        }
      } finally {
        setLoadingCurrentJob(false);
      }
    },
    [supabase],
  );

  useEffect(() => {
    void loadCurrentJob(userId);
  }, [userId, loadCurrentJob]);

  const firstName = name ? name.split(" ")[0] : null;

  const isTechRole =
    role === "tech" || role === "mechanic" || role === "technician";

  return (
    <div className="relative space-y-8 fade-in">
      {/* soft gradient background for this page (extra metal wash) */}
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.95),#020617_70%)]"
      />

      {/* welcome panel */}
      <section className="flex items-center justify-between gap-4 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-r from-black/80 via-slate-950/90 to-black/80 px-5 py-4 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl">
        <div>
          <h1 className="text-2xl font-semibold text-white">
            {firstName ? `Welcome back, ${firstName} üëã` : "Welcome üëã"}
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            Here‚Äôs a quick view of what matters today in your shop.
          </p>
        </div>
      </section>

      {/* active job pill ‚Äì only for tech/mechanic roles */}
      {isTechRole && (
        <section>
          <ActiveJobCard
            loading={loadingCurrentJob}
            job={currentJob}
            workOrder={currentJobWorkOrder}
            vehicle={currentJobVehicle}
          />
        </section>
      )}

      {/* overview cards */}
      <section className="grid gap-4 md:grid-cols-4">
        <OverviewCard
          title="Today‚Äôs appointments"
          value={
            counts.appointments === null ? "‚Ä¶" : String(counts.appointments)
          }
          href="/dashboard/appointments"
        />
        <OverviewCard
          title="Open work orders"
          value={counts.workOrders === null ? "‚Ä¶" : String(counts.workOrders)}
          href="/work-orders/view"
        />
        <OverviewCard
          title="Parts requests"
          value={
            counts.partsRequests === null ? "‚Ä¶" : String(counts.partsRequests)
          }
          href="/parts/requests"
        />
        <OverviewCard title="Team chat" value="Open" href="/chat" />
      </section>

      {/* quick actions */}
      <section className="space-y-3">
        <h2 className="text-sm font-medium text-neutral-300">Quick actions</h2>
        <div className="flex flex-wrap gap-3">
          <QuickButton href="/work-orders/create?autostart=1">
            New work order
          </QuickButton>
          <QuickButton href="/dashboard/appointments">Appointments</QuickButton>
          <QuickButton href="/ai/assistant">AI assistant</QuickButton>
          {role === "owner" || role === "admin" ? (
            <QuickButton href="/dashboard/owner/reports">
              Reports
            </QuickButton>
          ) : null}
        </div>
      </section>
    </div>
  );
}

/* ------------------------------------------------------------------------ */
/* Active Job Card                                                          */
/* ------------------------------------------------------------------------ */

function ActiveJobCard({
  loading,
  job,
  workOrder,
  vehicle,
}: {
  loading: boolean;
  job: WorkOrderLine | null;
  workOrder: WorkOrder | null;
  vehicle: Vehicle | null;
}) {
  if (loading) {
    return (
      <div className="group relative overflow-hidden rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-r from-black/85 via-slate-950/95 to-black/85 px-4 py-3 shadow-[0_20px_40px_rgba(0,0,0,0.95)]">
        <div className="flex items-center justify-between gap-3">
          <div>
            <p className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
              Active job
            </p>
            <p className="mt-1 text-sm text-neutral-300">Checking‚Ä¶</p>
          </div>
        </div>
      </div>
    );
  }

  if (!job || !workOrder) {
    return (
      <div className="group relative overflow-hidden rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-r from-black/85 via-slate-950/95 to-black/85 px-4 py-3 shadow-[0_20px_40px_rgba(0,0,0,0.95)]">
        <div className="flex items-center justify-between gap-3">
          <div>
            <p className="text-[11px] uppercase tracking-[0.18em] text-neutral-500">
              Active job
            </p>
            <p className="mt-1 text-sm text-neutral-400">
              No active job punch.
            </p>
          </div>
        </div>
      </div>
    );
  }

  const jobLabel =
    job.description ||
    job.complaint ||
    String(job.job_type ?? "Job in progress");

  const vehicleLabel = vehicle
    ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}`
        .trim()
        .replace(/\s+/g, " ")
    : null;

  const woLabel = workOrder.custom_id || workOrder.id.slice(0, 8);

  // üîó Include the line id so the job page can focus that line
  const href = `/work-orders/${workOrder.id}?focus=${job.id}`;

  return (
    <Link
      href={href}
      className="group relative block overflow-hidden rounded-2xl border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/85 via-slate-950/95 to-black/85 px-4 py-3 shadow-[0_24px_45px_rgba(0,0,0,0.95),0_0_35px_rgba(249,115,22,0.55)]"
    >
      <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.12),transparent_60%)] opacity-0 transition-opacity group-hover:opacity-100" />
      <div className="relative flex items-center justify-between gap-3">
        <div>
          <p className="text-[11px] uppercase tracking-[0.18em] text-[color:var(--accent-copper,#f97316)]">
            Active job
          </p>
          <p className="mt-1 line-clamp-1 text-sm font-semibold text-white">
            {jobLabel}
          </p>
          <p className="mt-1 text-xs text-neutral-300">
            WO {woLabel}
            {vehicleLabel ? ` ‚Ä¢ ${vehicleLabel}` : ""}
          </p>
        </div>
        <span className="text-xs text-[color:var(--accent-copper,#f97316)]">
          Open ‚Üí
        </span>
      </div>
    </Link>
  );
}

/* ------------------------------------------------------------------------ */
/* Existing cards/buttons                                                   */
/* ------------------------------------------------------------------------ */

function OverviewCard({
  title,
  value,
  href,
}: {
  title: string;
  value: string;
  href?: string;
}) {
  const content = (
    <div className="group relative overflow-hidden rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-br from-black/80 via-slate-950/90 to-black/85 px-4 py-4 shadow-[0_20px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl transition hover:border-[color:var(--accent-copper,#f97316)]/80 hover:shadow-[0_0_35px_rgba(249,115,22,0.55)]">
      <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.12),transparent_60%)] opacity-0 transition-opacity group-hover:opacity-100" />
      <div className="relative">
        <p className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
          {title}
        </p>
        <p className="mt-2 text-2xl font-semibold text-white">{value}</p>
      </div>
    </div>
  );

  if (href) {
    return (
      <Link href={href} className="block">
        {content}
      </Link>
    );
  }
  return content;
}

function QuickButton({
  href,
  children,
}: {
  href: string;
  children: React.ReactNode;
}) {
  return (
    <Link
      href={href}
      className="inline-flex items-center gap-2 rounded-full border border-[color:var(--accent-copper,#f97316)]/70 bg-gradient-to-r from-black/70 via-slate-950/90 to-black/80 px-4 py-2 text-sm text-white shadow-[0_12px_28px_rgba(0,0,0,0.9)] backdrop-blur-md transition hover:bg-[color:var(--accent-copper,#f97316)]/15 hover:border-[color:var(--accent-copper-light,#fed7aa)]"
    >
      {children}
    </Link>
  );
}

========================================
FILE: app/dashboard/tech/queue/page.tsx
========================================
export default function Page() {
  return (
    <div className="p-6 text-white">
      <p>Placeholder route. Wire up the real UI next.</p>
    </div>
  );
}


========================================
FILE: app/dashboard/tech/settings/page.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const PREFS_KEY = "profixiq.tech.prefs.v1";

type TechPrefs = {
  defaultBucket: "awaiting" | "in_progress" | "on_hold" | "completed";
  showUnassigned: boolean;
  compactCards: boolean;
  autoRefresh: boolean;
};

export default function TechSettingsPage() {
  const supabase = createClientComponentClient<Database>();

  // profile fields (from profiles table)
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [ok, setOk] = useState<string | null>(null);

  const [profileId, setProfileId] = useState<string | null>(null);
  const [shopId, setShopId] = useState<string | null>(null);
  const [username, setUsername] = useState<string>("");
  const [fullName, setFullName] = useState("");
  const [email, setEmail] = useState(""); // <- user asked to include email
  const [phone, setPhone] = useState("");
  const [street, setStreet] = useState("");
  const [city, setCity] = useState("");
  const [province, setProvince] = useState("");
  const [postal, setPostal] = useState("");

  // local (non-DB) prefs for the tech queue
  const [prefs, setPrefs] = useState<TechPrefs>({
    defaultBucket: "awaiting",
    showUnassigned: false,
    compactCards: false,
    autoRefresh: false,
  });

  // load profile + prefs
  useEffect(() => {
    (async () => {
      setLoading(true);
      setError(null);

      // 1) auth user
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) {
        setError("Not signed in.");
        setLoading(false);
        return;
      }

      // 2) profile
      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select(
          "id, shop_id, username, full_name, email, phone, street, city, province, postal_code",
        )
        .eq("id", user.id)
        .maybeSingle();

      if (profErr) {
        setError(profErr.message);
        setLoading(false);
        return;
      }

      if (profile) {
        setProfileId(profile.id);
        setShopId(profile.shop_id ?? null);
        setUsername(profile.username ?? "");
        setFullName(profile.full_name ?? "");
        setEmail(profile.email ?? "");
        setPhone(profile.phone ?? "");
        setStreet(profile.street ?? "");
        setCity(profile.city ?? "");
        setProvince(profile.province ?? "");
        setPostal(profile.postal_code ?? "");
      }

      // 3) local prefs
      if (typeof window !== "undefined") {
        try {
          const raw = localStorage.getItem(PREFS_KEY);
          if (raw) {
            const parsed = JSON.parse(raw) as TechPrefs;
            setPrefs((prev) => ({ ...prev, ...parsed }));
          }
        } catch {
          // ignore
        }
      }

      setLoading(false);
    })();
  }, [supabase]);

  // helper to persist prefs to localStorage
  const savePrefs = (next: TechPrefs) => {
    setPrefs(next);
    if (typeof window !== "undefined") {
      localStorage.setItem(PREFS_KEY, JSON.stringify(next));
    }
  };

  const handleSaveProfile = async () => {
    if (!profileId) return;
    setSaving(true);
    setError(null);
    setOk(null);
    try {
      // NOTE: this updates the *profiles* table email, not auth.users email
      const { error: updErr } = await supabase
        .from("profiles")
        .update({
          full_name: fullName,
          email,
          phone,
          street,
          city,
          province,
          postal_code: postal,
          updated_at: new Date().toISOString(),
        })
        .eq("id", profileId);

      if (updErr) throw updErr;

      setOk("Profile updated.");
    } catch (e) {
      setError(e instanceof Error ? e.message : "Failed to save profile.");
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="p-6 text-white">
        <div className="h-6 w-36 animate-pulse rounded bg-neutral-800" />
        <div className="mt-4 grid gap-4 md:grid-cols-2">
          <div className="h-40 rounded-lg bg-neutral-900/50" />
          <div className="h-40 rounded-lg bg-neutral-900/50" />
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 text-white space-y-6">
      {/* header */}
      <div className="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 className="text-2xl font-blackops text-orange-400">
            Tech Settings
          </h1>
          <p className="text-sm text-neutral-400">
            Personal info and queue preferences for your workstation.
          </p>
        </div>
        {shopId ? (
          <div className="rounded border border-neutral-700 bg-neutral-900 px-3 py-1 text-xs text-neutral-300">
            Shop: <span className="text-orange-300">{shopId}</span>
          </div>
        ) : null}
      </div>

      {/* 2-column layout */}
      <div className="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
        {/* LEFT: profile */}
        <div className="space-y-6">
          <section className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 space-y-4">
            <div className="flex items-center justify-between gap-3">
              <div>
                <h2 className="text-sm font-semibold text-neutral-100">
                  Your Profile
                </h2>
                <p className="text-xs text-neutral-400">
                  This is what your team sees on work orders.
                </p>
              </div>
              {username ? (
                <span className="rounded bg-neutral-900 px-2 py-1 text-[10px] text-neutral-400">
                  Username: <span className="text-white">{username}</span>
                </span>
              ) : null}
            </div>

            <div className="grid gap-3 md:grid-cols-2">
              <div className="space-y-1">
                <label className="text-[11px] text-neutral-300">Full name</label>
                <input
                  value={fullName}
                  onChange={(e) => setFullName(e.target.value)}
                  className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm focus:border-orange-500 outline-none"
                  placeholder="Jane Tech"
                />
              </div>
              <div className="space-y-1">
                <label className="text-[11px] text-neutral-300">
                  Email (profile only)
                </label>
                <input
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm focus:border-orange-500 outline-none"
                  placeholder="jane@example.com"
                  type="email"
                />
                <p className="text-[10px] text-neutral-500">
                  Changing this won‚Äôt change your login email.
                </p>
              </div>
              <div className="space-y-1">
                <label className="text-[11px] text-neutral-300">Phone</label>
                <input
                  value={phone}
                  onChange={(e) => setPhone(e.target.value)}
                  className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm focus:border-orange-500 outline-none"
                  placeholder="+1 (555) 123-4567"
                />
              </div>
            </div>

            <div className="grid gap-3 md:grid-cols-2">
              <div className="space-y-1">
                <label className="text-[11px] text-neutral-300">
                  Street address
                </label>
                <input
                  value={street}
                  onChange={(e) => setStreet(e.target.value)}
                  className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm focus:border-orange-500 outline-none"
                  placeholder="123 Fleet Ave."
                />
              </div>
              <div className="grid grid-cols-3 gap-2">
                <div className="space-y-1">
                  <label className="text-[11px] text-neutral-300">City</label>
                  <input
                    value={city}
                    onChange={(e) => setCity(e.target.value)}
                    className="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-2 text-sm focus:border-orange-500 outline-none"
                  />
                </div>
                <div className="space-y-1">
                  <label className="text-[11px] text-neutral-300">
                    Province
                  </label>
                  <input
                    value={province}
                    onChange={(e) => setProvince(e.target.value)}
                    className="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-2 text-sm focus:border-orange-500 outline-none"
                  />
                </div>
                <div className="space-y-1">
                    <label className="text-[11px] text-neutral-300">
                      Postal
                    </label>
                    <input
                      value={postal}
                      onChange={(e) => setPostal(e.target.value)}
                      className="w-full rounded border border-neutral-700 bg-neutral-900 px-2 py-2 text-sm focus:border-orange-500 outline-none"
                    />
                </div>
              </div>
            </div>

            <div className="flex flex-wrap items-center gap-3">
              <button
                onClick={handleSaveProfile}
                disabled={saving}
                className="rounded bg-orange-500 px-4 py-2 text-sm font-semibold text-black hover:bg-orange-600 disabled:opacity-60"
              >
                {saving ? "Saving‚Ä¶" : "Save profile"}
              </button>
              {error && <span className="text-xs text-red-300">{error}</span>}
              {ok && <span className="text-xs text-green-300">{ok}</span>}
            </div>
          </section>

          {/* Notifications */}
          <section className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 space-y-3">
            <div className="flex items-center justify-between">
              <h2 className="text-sm font-semibold text-neutral-100">
                Notifications
              </h2>
              <span className="text-[10px] text-neutral-500">
                Local preference
              </span>
            </div>
            <p className="text-xs text-neutral-400">
              These are per-device; your manager controls shop-wide emails.
            </p>
            <label className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                checked={prefs.autoRefresh}
                onChange={(e) =>
                  savePrefs({ ...prefs, autoRefresh: e.target.checked })
                }
                className="h-4 w-4 rounded border-neutral-500 bg-neutral-900"
              />
              Auto-refresh tech queue
            </label>
            <label className="flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                checked={prefs.showUnassigned}
                onChange={(e) =>
                  savePrefs({ ...prefs, showUnassigned: e.target.checked })
                }
                className="h-4 w-4 rounded border-neutral-500 bg-neutral-900"
              />
              Show unassigned jobs too
            </label>
          </section>
        </div>

        {/* RIGHT: work prefs */}
        <div className="space-y-6">
          <section className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-sm font-semibold text-neutral-100">
                Work Preferences
              </h2>
              <span className="text-[10px] text-neutral-500">
                Used by /tech/queue
              </span>
            </div>

            <div className="space-y-2">
              <label className="text-[11px] text-neutral-300">
                Default queue status
              </label>
              <select
                value={prefs.defaultBucket}
                onChange={(e) =>
                  savePrefs({
                    ...prefs,
                    defaultBucket: e.target.value as TechPrefs["defaultBucket"],
                  })
                }
                className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm focus:border-orange-500 outline-none"
              >
                <option value="awaiting">Awaiting</option>
                <option value="in_progress">In progress</option>
                <option value="on_hold">On hold</option>
                <option value="completed">Completed</option>
              </select>
              <p className="text-[10px] text-neutral-500">
                We can read this on the queue page to preselect your tab.
              </p>
            </div>

            <div className="space-y-2">
              <label className="text-[11px] text-neutral-300">
                Card layout
              </label>
              <div className="flex gap-2">
                <button
                  type="button"
                  onClick={() =>
                    savePrefs({ ...prefs, compactCards: false })
                  }
                  className={`rounded border px-3 py-2 text-sm ${
                    !prefs.compactCards
                      ? "border-orange-500 bg-orange-500/10"
                      : "border-neutral-700 bg-neutral-900"
                  }`}
                >
                  Full cards
                </button>
                <button
                  type="button"
                  onClick={() =>
                    savePrefs({ ...prefs, compactCards: true })
                  }
                  className={`rounded border px-3 py-2 text-sm ${
                    prefs.compactCards
                      ? "border-orange-500 bg-orange-500/10"
                      : "border-neutral-700 bg-neutral-900"
                  }`}
                >
                  Compact
                </button>
              </div>
              <p className="text-[10px] text-neutral-500">
                Compact is better on small screens.
              </p>
            </div>
          </section>

          {/* account info */}
          <section className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 space-y-3">
            <h2 className="text-sm font-semibold text-neutral-100">
              Account
            </h2>
            <p className="text-xs text-neutral-400">
              Username and shop are managed by your owner/admin.
            </p>
            <dl className="space-y-1 text-xs text-neutral-300">
              <div className="flex justify-between gap-3">
                <dt className="text-neutral-500">Username</dt>
                <dd>{username || "‚Äî"}</dd>
              </div>
              <div className="flex justify-between gap-3">
                <dt className="text-neutral-500">Shop</dt>
                <dd>{shopId || "‚Äî"}</dd>
              </div>
            </dl>
            <p className="text-[10px] text-neutral-500">
              Need a password reset? Ask your manager or owner ‚Äî they can set a
              new temporary password from the admin screen.
            </p>
          </section>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/dashboard/workspace/page.tsx
========================================
"use client";

import { useState } from "react";

const TABS = [
  { key: "work",  label: "Work Orders",  src: "/work-orders" },
  { key: "parts", label: "Parts",        src: "/parts" },
  { key: "insp",  label: "Inspections",  src: "/inspections" },
];

export default function Workspace() {
  const [active, setActive] = useState("work");

  return (
    <div className="h-[calc(100dvh-140px)] flex flex-col">
      <div className="mb-3 flex gap-2">
        {TABS.map((t) => (
          <button
            key={t.key}
            onClick={() => setActive(t.key)}
            className={`rounded px-3 py-1 text-sm border
              ${active === t.key ? "bg-orange-500 text-black border-orange-500"
                                 : "bg-neutral-900 text-white border-white/15 hover:border-orange-500"}`}
          >
            {t.label}
          </button>
        ))}
      </div>

      {TABS.map((t) => (
        <iframe
          key={t.key}
          src={t.src}
          className={`${active === t.key ? "block" : "hidden"} flex-1 w-full rounded-lg border border-white/10`}
        />
      ))}
    </div>
  );
}

========================================
FILE: app/debug/client/page.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type AuthInfo = {
  hasSession: boolean;
  userId: string | null;
  expiresAt: number | null;
  expiresInSec: number | null;
};

export default function ClientDebug(): JSX.Element {
  const sb = createClientComponentClient<Database>();

  const [info, setInfo] = useState<AuthInfo | null>(null);
  const [repl, setRepl] = useState<Record<string, unknown> | null>(null);

  useEffect(() => {
    let mounted = true;

    const load = async (): Promise<void> => {
      const { data: s } = await sb.auth.getSession();
      const { data: u } = await sb.auth.getUser();
      const sess = s?.session ?? null;

      if (!mounted) return;

      setInfo({
        hasSession: !!sess,
        userId: u?.user?.id ?? null,
        expiresAt: sess?.expires_at ?? null,
        expiresInSec:
          sess?.expires_at != null
            ? sess.expires_at - Math.floor(Date.now() / 1000)
            : null,
      });
      setRepl({ session: s, user: u });
    };

    void load();

    const { data: sub } = sb.auth.onAuthStateChange((_event, session) => {
      setInfo((prev): AuthInfo => ({
        ...(prev ?? {
          hasSession: false,
          userId: null,
          expiresAt: null,
          expiresInSec: null,
        }),
        hasSession: !!session,
        userId: session?.user?.id ?? null,
        expiresAt: session?.expires_at ?? null,
        expiresInSec:
          session?.expires_at != null
            ? session.expires_at - Math.floor(Date.now() / 1000)
            : null,
      }));
    });

    return () => {
      mounted = false;
      sub.subscription.unsubscribe();
    };
  }, [sb]);

  if (!info) {
    return (
      <div className="p-4 text-sm text-neutral-400">Loading auth debug‚Ä¶</div>
    );
  }

  return (
    <div className="p-4 space-y-2 text-sm">
      <h1 className="text-xl font-semibold mb-2">Client Auth / Context Debug</h1>

      <div className="rounded border border-amber-500/30 bg-amber-500/10 p-2">
        <div>
          <b>hasSession:</b> {String(info.hasSession)}
        </div>
        <div>
          <b>userId:</b> {info.userId ?? "null"}
        </div>
        <div>
          <b>expiresInSec:</b> {info.expiresInSec ?? "?"}
        </div>
      </div>

      <pre className="rounded bg-neutral-900 p-3 text-xs overflow-auto">
        {JSON.stringify(repl, null, 2)}
      </pre>
    </div>
  );
}

========================================
FILE: app/debug/session/page.tsx
========================================
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";

export default async function SessionDebug() {
  const sb = createServerComponentClient({ cookies });

  // session + user
  const { data: s } = await sb.auth.getSession();
  const sess = s && s.session ? s.session : null;

  // profile basics (safe columns)
  let profile = null;
  if (sess && sess.user) {
    try {
      const { data } = await sb
        .from("profiles")
        .select("id, shop_id, completed_onboarding")
        .eq("id", sess.user.id)
        .maybeSingle();
      profile = data || null;
    } catch {}
  }

  // current shop id from session (via accessor RPC)
  let currentShopId = null;
  try {
    const { data } = await sb.rpc("get_current_shop_id");
    currentShopId = data || null;
  } catch {}

  // tiny WO probe (does RLS allow the example WC0001 or your first WO?)
  let woProbe = null;
  try {
    const { data } = await sb
      .from("work_orders")
      .select("id, custom_id, shop_id")
      .limit(1);
    woProbe = data || null;
  } catch (e) {
    woProbe = { error: String(e) };
  }

  const dump = {
    session: {
      hasSession: !!sess,
      userId: sess && sess.user ? sess.user.id : null,
      expiresAt: sess ? sess.expires_at : null,
    },
    profile,
    current_shop_id: currentShopId,
    wo_probe: woProbe,
  };

  return (
    <div className="p-6 space-y-4 text-sm">
      <h1 className="text-xl font-semibold">Server Session / RLS Debug</h1>
      <pre className="rounded bg-neutral-900 p-3 overflow-auto">
        {JSON.stringify(dump, null, 2)}
      </pre>
    </div>
  );
}

========================================
FILE: app/global-error.tsx
========================================
"use client";

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  console.error("GlobalError:", error);
  return (
    <html>
      <body style={{ background: "#000", color: "#fff", fontFamily: "monospace" }}>
        <div style={{ maxWidth: 800, margin: "3rem auto", lineHeight: 1.5 }}>
          <h1 style={{ color: "#f97316" }}>Something went wrong</h1>
          <pre style={{ whiteSpace: "pre-wrap" }}>{String(error?.stack ?? error?.message)}</pre>
          <button
            onClick={reset}
            style={{
              marginTop: 16,
              border: "1px solid #f97316",
              padding: "8px 12px",
              background: "transparent",
              color: "#f97316",
              cursor: "pointer",
            }}
          >
            Try again
          </button>
        </div>
      </body>
    </html>
  );
}

========================================
FILE: app/inspections/created/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/created/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/custom-draft/page.tsx
========================================
// Server component wrapper (no "use client")
import CustomRunPage from "@/features/inspections/app/inspection/custom-draft/page";

export const dynamic = "force-dynamic"; // optional, if you need runtime params each load
export default function Page() {
  return <CustomRunPage />;
}

========================================
FILE: app/inspections/customer-vehicle/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/customer-vehicle/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/custom-inspection/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/custom-inspection/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/error.tsx
========================================
// app/dashboard/inspections/error.tsx
"use client";

import { useEffect } from "react";

export default function InspectionsError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error("Inspections error:", error);
  }, [error]);

  return (
    <div className="p-6 text-red-400 space-y-4">
      <h1 className="text-xl font-bold">‚ö†Ô∏è Inspections Error</h1>
      <p>Something went wrong while loading Inspections.</p>

      <pre className="whitespace-pre-wrap bg-neutral-900 text-orange-400 p-3 rounded-lg overflow-x-auto">
        {error.message}
        {error.digest ? `\nDigest: ${error.digest}` : null}
      </pre>

      <button
        onClick={() => reset()}
        className="mt-4 rounded bg-orange-600 px-4 py-2 text-white hover:bg-orange-500"
      >
        Try again
      </button>
    </div>
  );
}

========================================
FILE: app/inspections/fill/page.tsx
========================================
// Server wrapper
import FillPage from "@/features/inspections/app/inspection/fill/page";
export const dynamic = "force-dynamic";
export default function Page() { return <FillPage />; }

========================================
FILE: app/inspections/fleet-import/page.tsx
========================================
"use client";

import FleetFormImportCard from "@/features/inspections/components/FleetFormImportCard";

export default function FleetFormImportPage() {
  return (
    <main className="mx-auto max-w-4xl px-4 py-6 text-white">
      {/* metallic / copper wash */}
      <div
        aria-hidden
        className="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]"
      />

      <div className="mb-4">
        <div className="text-[11px] font-blackops uppercase tracking-[0.22em] text-neutral-400">
          Fleet Inspections
        </div>
        <h1 className="mt-1 text-xl font-blackops text-neutral-50 md:text-2xl">
          Import a fleet inspection form
        </h1>
        <p className="mt-1 text-xs text-neutral-400">
          Upload a customer&apos;s existing paper/PDF inspection sheet and turn it
          into a reusable ProFixIQ template.
        </p>
      </div>

      <FleetFormImportCard />
    </main>
  );
}

========================================
FILE: app/inspections/fleet-review/page.tsx
========================================
//app/inspections/fleet-review/page.tsx

"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";

type DB = Database;
type DutyClass = "light" | "medium" | "heavy";

type FleetFormUpload = DB["public"]["Tables"]["fleet_form_uploads"]["Row"];

type EditableItem = { item: string; unit?: string | null };
type EditableSection = { title: string; items: EditableItem[] };

/* ------------------------ parsed_sections normalizer ------------------------ */

function normalizeParsedSections(parsed: FleetFormUpload["parsed_sections"]): EditableSection[] {
  if (!Array.isArray(parsed)) return [];

  const sections: EditableSection[] = [];

  for (const sec of parsed) {
    if (typeof sec !== "object" || sec === null) continue;

    const sectionCandidate = sec as {
      title?: unknown;
      items?: unknown;
    };

    const rawTitle = sectionCandidate.title;
    const title = typeof rawTitle === "string" ? rawTitle.trim() : "";

    const itemsRaw = Array.isArray(sectionCandidate.items)
      ? (sectionCandidate.items as unknown[])
      : [];

    const items: EditableItem[] = [];

    for (const item of itemsRaw) {
      if (typeof item !== "object" || item === null) continue;

      const itemCandidate = item as {
        item?: unknown;
        unit?: unknown;
      };

      const rawLabel = itemCandidate.item;
      const label = typeof rawLabel === "string" ? rawLabel.trim() : "";
      if (!label) continue;

      const rawUnit = itemCandidate.unit;
      let unit: string | null = null;
      if (typeof rawUnit === "string" && rawUnit.trim().length > 0) {
        unit = rawUnit;
      }

      items.push({ item: label, unit });
    }

    if (!title && items.length === 0) continue;

    sections.push({
      title: title || "Section",
      items,
    });
  }

  return sections;
}

/* -------------------------------------------------------------------------- */

export default function FleetFormReviewPage() {
  const router = useRouter();
  const sp = useSearchParams();
  const supabase = useMemo(
    () => createClientComponentClient<DB>(),
    [],
  );

  const uploadId = sp.get("uploadId");
  const vehicleTypeParam = sp.get("vehicleType") || "";
  const dutyClassParam = sp.get("dutyClass") as DutyClass | "" | null;
  const titleHintParam = sp.get("titleHint") || "";

  const [loading, setLoading] = useState(true);
  const [upload, setUpload] = useState<FleetFormUpload | null>(null);
  const [sections, setSections] = useState<EditableSection[]>([]);
  const [templateTitle, setTemplateTitle] = useState("");
  const [errorMsg, setErrorMsg] = useState<string | null>(null);

  useEffect(() => {
    if (!uploadId) {
      setErrorMsg("Missing uploadId.");
      setLoading(false);
      return;
    }

    (async () => {
      setLoading(true);
      setErrorMsg(null);

      const { data, error } = await supabase
        .from("fleet_form_uploads")
        .select("*")
        .eq("id", uploadId)
        .maybeSingle<FleetFormUpload>();

      if (error || !data) {
        // eslint-disable-next-line no-console
        console.error("fleet_form_upload fetch error:", error);
        setErrorMsg("Unable to load fleet form.");
        setLoading(false);
        return;
      }

      setUpload(data);

      const editable = normalizeParsedSections(data.parsed_sections);
      setSections(editable);

      const defaultTitle =
        titleHintParam ||
        data.original_filename?.replace(/\.[^.]+$/, "") ||
        "Fleet Inspection Template";

      setTemplateTitle(defaultTitle);

      setLoading(false);
    })();
  }, [uploadId, supabase, titleHintParam]);

  const statusChip = useMemo(() => {
    const s = upload?.status || "";
    if (!s) return "Unknown";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }, [upload]);

  const dutyClass: DutyClass | "" = dutyClassParam || "";

  const handleSectionTitleChange = (index: number, title: string) => {
    setSections((prev) => {
      const next = [...prev];
      next[index] = { ...next[index], title };
      return next;
    });
  };

  const handleItemChange = (
    sectionIndex: number,
    itemIndex: number,
    field: "item" | "unit",
    value: string,
  ) => {
    setSections((prev) => {
      const next = [...prev];
      const sec = next[sectionIndex];
      const items = [...sec.items];

      const updated: EditableItem =
        field === "item"
          ? {
              ...items[itemIndex],
              item: value,
            }
          : {
              ...items[itemIndex],
              unit: value || null,
            };

      items[itemIndex] = updated;
      next[sectionIndex] = { ...sec, items };
      return next;
    });
  };

  const handleAddSection = () => {
    setSections((prev) => [
      ...prev,
      { title: "New Section", items: [{ item: "New item", unit: null }] },
    ]);
  };

  const handleAddItem = (sectionIndex: number) => {
    setSections((prev) => {
      const next = [...prev];
      const sec = next[sectionIndex];
      next[sectionIndex] = {
        ...sec,
        items: [...sec.items, { item: "New item", unit: null }],
      };
      return next;
    });
  };

  const handleUseInDraft = () => {
    if (!sections.length) {
      setErrorMsg("Add at least one section with items before continuing.");
      return;
    }

    const cleanedSections: EditableSection[] = sections
      .map((s) => ({
        title: s.title.trim() || "Section",
        items: s.items
          .map<EditableItem>((it) => ({
            item: (it.item || "").trim(),
            unit: it.unit && it.unit.trim().length > 0 ? it.unit : null,
          }))
          .filter((it) => it.item.length > 0),
      }))
      .filter((s) => s.items.length > 0);

    if (!cleanedSections.length) {
      setErrorMsg("All sections are empty ‚Äî add items before continuing.");
      return;
    }

    const title =
      templateTitle.trim() ||
      titleHintParam ||
      "Imported Fleet Inspection";

    if (typeof window !== "undefined") {
      window.sessionStorage.setItem(
        "customInspection:sections",
        JSON.stringify(cleanedSections),
      );
      window.sessionStorage.setItem("customInspection:title", title);
      window.sessionStorage.setItem(
        "customInspection:includeOil",
        JSON.stringify(false),
      );
      if (dutyClass) {
        window.sessionStorage.setItem("customInspection:dutyClass", dutyClass);
      }
    }

    const qs = new URLSearchParams();
    qs.set("template", title);
    if (vehicleTypeParam) qs.set("vehicleType", vehicleTypeParam);
    if (dutyClass) qs.set("dutyClass", dutyClass);
    qs.set("source", "fleet-import");
    if (uploadId) qs.set("fleetUploadId", uploadId);

    router.push(`/inspections/custom-draft?${qs.toString()}`);
  };

  return (
    <main className="mx-auto max-w-6xl px-4 py-6 text-white">
      {/* metallic / copper wash */}
      <div
        aria-hidden
        className="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]"
      />

      {/* Header + chips */}
      <div className="mb-4 flex flex-wrap items-center justify-between gap-3">
        <div>
          <div className="text-[11px] font-blackops uppercase tracking-[0.22em] text-neutral-400">
            Fleet Form Review
          </div>
          <h1 className="mt-1 text-xl font-blackops text-neutral-50 md:text-2xl">
            Map fleet form into a ProFixIQ template
          </h1>
        </div>

        <div className="flex flex-wrap items-center gap-2 text-[10px] uppercase tracking-[0.16em]">
          <span className="rounded-full border border-neutral-600 bg-black/60 px-2 py-1 text-neutral-300">
            Status:{" "}
            <span className="font-semibold text-neutral-100">
              {statusChip}
            </span>
          </span>
          {vehicleTypeParam && (
            <span className="rounded-full border border-neutral-600 bg-black/60 px-2 py-1 text-neutral-300">
              Vehicle:{" "}
              <span className="font-semibold text-neutral-100">
                {vehicleTypeParam}
              </span>
            </span>
          )}
          {dutyClass && (
            <span className="rounded-full border border-neutral-600 bg-black/60 px-2 py-1 text-neutral-300">
              Duty:{" "}
              <span className="font-semibold text-neutral-100">
                {dutyClass}
              </span>
            </span>
          )}
        </div>
      </div>

      {errorMsg && (
        <div className="mb-4 rounded-xl border border-red-700 bg-red-900/30 px-4 py-3 text-sm text-red-200">
          {errorMsg}
        </div>
      )}

      {loading ? (
        <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-6 text-sm text-neutral-300 shadow-[0_24px_80px_rgba(0,0,0,0.95)]">
          Loading fleet form‚Ä¶
        </div>
      ) : !upload ? (
        <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-6 text-sm text-neutral-300 shadow-[0_24px_80px_rgba(0,0,0,0.95)]">
          No fleet form found for that id.
        </div>
      ) : (
        <div className="grid gap-4 md:grid-cols-[minmax(0,1.1fr),minmax(0,1.4fr)]">
          {/* Left: OCR text */}
          <section
            className="
              relative rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)]
              bg-black/70 p-4 shadow-[0_24px_80px_rgba(0,0,0,0.95)] backdrop-blur-xl
            "
          >
            <div className="mb-3 flex items-center justify-between gap-2">
              <div>
                <div className="text-[11px] font-blackops uppercase tracking-[0.18em] text-neutral-400">
                  OCR Snapshot
                </div>
                <p className="mt-1 text-xs text-neutral-300">
                  Full text detected from the fleet‚Äôs inspection form.
                </p>
              </div>
              <span className="rounded-full border border-neutral-700 bg-black/40 px-2 py-0.5 text-[10px] uppercase tracking-[0.16em] text-neutral-400">
                Read-only
              </span>
            </div>

            <div className="h-[320px] overflow-auto rounded-xl border border-[color:var(--metal-border-soft,#374151)] bg-black/70 p-3 text-xs text-neutral-200">
              {upload.extracted_text?.trim() ? (
                upload.extracted_text.split("\n").map((line, idx) => (
                  <p key={idx} className="whitespace-pre-wrap">
                    {line}
                  </p>
                ))
              ) : (
                <p className="text-neutral-500">
                  No OCR text stored for this form.
                </p>
              )}
            </div>

            <p className="mt-2 text-[10px] text-neutral-500">
              Use this as a reference if any sections or items look off on the
              right-hand side.
            </p>
          </section>

          {/* Right: sections + mapping */}
          <section
            className="
              relative rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)]
              bg-black/70 p-4 shadow-[0_24px_80px_rgba(0,0,0,0.95)] backdrop-blur-xl
            "
          >
            <div className="mb-3">
              <div className="mb-1 flex items-center justify-between gap-2">
                <div className="text-[11px] font-blackops uppercase tracking-[0.18em] text-neutral-400">
                  Map to Template
                </div>
                <span className="rounded-full border border-neutral-700 bg-black/40 px-2 py-0.5 text-[10px] uppercase tracking-[0.16em] text-neutral-400">
                  Editable
                </span>
              </div>

              <label className="flex flex-col gap-1 text-xs text-neutral-300">
                Template title
                <input
                  value={templateTitle}
                  onChange={(e) => setTemplateTitle(e.target.value)}
                  className="
                    rounded-xl border border-[color:var(--metal-border-soft,#374151)]
                    bg-black/75 px-3 py-2 text-xs text-white placeholder:text-neutral-500
                  "
                  placeholder="ABC Logistics ‚Äì Daily Truck Inspection"
                />
              </label>
            </div>

            <div className="h-[360px] space-y-3 overflow-auto pr-1">
              {sections.length === 0 ? (
                <div className="rounded-xl border border-dashed border-[color:var(--metal-border-soft,#374151)] bg-black/50 px-3 py-4 text-xs text-neutral-400">
                  No sections were parsed from this form. You can still build a
                  template by adding sections and items manually.
                </div>
              ) : (
                sections.map((sec, i) => (
                  <div
                    key={`${sec.title}-${i}`}
                    className="rounded-xl border border-[color:var(--metal-border-soft,#374151)] bg-black/75 px-3 py-3"
                  >
                    <div className="mb-2 flex items-center justify-between gap-2">
                      <label className="flex flex-1 flex-col gap-1 text-[11px] text-neutral-300">
                        Section {i + 1} title
                        <input
                          value={sec.title}
                          onChange={(e) =>
                            handleSectionTitleChange(i, e.target.value)
                          }
                          className="
                            rounded-lg border border-[color:var(--metal-border-soft,#374151)]
                            bg-black/75 px-2 py-1.5 text-xs text-white placeholder:text-neutral-500
                          "
                          placeholder="Section title"
                        />
                      </label>
                      <span className="whitespace-nowrap text-[10px] text-neutral-500">
                        {sec.items.length} items
                      </span>
                    </div>

                    <div className="space-y-1.5">
                      {sec.items.map((it, j) => (
                        <div
                          key={`${i}-${j}-${it.item}`}
                          className="grid grid-cols-[minmax(0,1.6fr),minmax(0,0.7fr)] gap-2"
                        >
                          <input
                            value={it.item}
                            onChange={(e) =>
                              handleItemChange(i, j, "item", e.target.value)
                            }
                            className="
                              rounded-lg border border-[color:var(--metal-border-soft,#374151)]
                              bg-black/80 px-2 py-1.5 text-xs text-white placeholder:text-neutral-500
                            "
                            placeholder="Item label"
                          />
                          <input
                            value={it.unit ?? ""}
                            onChange={(e) =>
                              handleItemChange(i, j, "unit", e.target.value)
                            }
                            className="
                              rounded-lg border border-[color:var(--metal-border-soft,#374151)]
                              bg-black/80 px-2 py-1.5 text-xs text-white placeholder:text-neutral-500
                            "
                            placeholder="Unit (mm, psi, in, kPa, ft¬∑lb‚Ä¶)"
                          />
                        </div>
                      ))}
                    </div>

                    <div className="mt-2">
                      <button
                        type="button"
                        onClick={() => handleAddItem(i)}
                        className="
                          rounded-full border border-[color:var(--metal-border-soft,#374151)]
                          bg-black/70 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.16em]
                          text-neutral-200 hover:bg-black/80
                        "
                      >
                        + Add item
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="mt-3 flex items-center justify-between gap-2 border-t border-white/5 pt-3">
              <button
                type="button"
                onClick={handleAddSection}
                className="
                  rounded-full border border-[color:var(--metal-border-soft,#374151)]
                  bg-black/70 px-3 py-1.5 text-[10px] font-semibold uppercase
                  tracking-[0.16em] text-neutral-200 hover:bg-black/80
                "
              >
                + Add Section
              </button>

              <Button
                type="button"
                onClick={handleUseInDraft}
                className="
                  rounded-full border border-[color:var(--metal-border-soft,#374151)]
                  bg-black/70 px-4 py-2 text-[11px] font-semibold uppercase tracking-[0.16em]
                  text-neutral-100 hover:bg-black/80 hover:border-neutral-500
                "
              >
                Use in Custom Draft
              </Button>
            </div>
          </section>
        </div>
      )}
    </main>
  );
}

========================================
FILE: app/inspections/genericInspection/page.tsx
========================================
// Mounts GenericInspectionScreen at /inspections/generic
export { default } from "@/features/inspections/screens/GenericInspectionScreen";
export const dynamic = "force-dynamic";
export const revalidate = 0;


========================================
FILE: app/inspections/[id]/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/[id]/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/maintenance50-air/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/maintenance50-air/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/maintenance50/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/maintenance50/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/page.tsx
========================================
"use client";

import { Suspense } from "react";
// re-use the client component that lives under features/
import InspectionMenuClient from "@/features/inspections/app/inspection/InspectionMenuClient";

export default function InspectionsPage() {
  return (
    <Suspense fallback={<div className="p-6 text-white">Loading‚Ä¶</div>}>
      <InspectionMenuClient />
    </Suspense>
  );
}

// If Vercel still tries to fully prerender this page, you can also
// un-comment the following line to force dynamic rendering:
// export const dynamic = "force-dynamic";


========================================
FILE: app/inspections/run/page.tsx
========================================
import RunPage from "@/features/inspections/app/inspection/run/page";
export const dynamic = "force-dynamic";
export default function Page() { return <RunPage />; }

========================================
FILE: app/inspections/saved/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/saved/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/summary/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/summary/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/inspections/templates/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import FeaturePage from "@/features/inspections/app/inspection/templates/page";

export default function Page() {
  return <FeaturePage />;
}


========================================
FILE: app/(landing)/layout.tsx
========================================
import "./globals.css";
import type { Metadata } from "next";
import Providers from "../providers";
import { Toaster } from "sonner";

export const metadata: Metadata = {
  title: "ProFixIQ",
  description: "AI-powered vehicle diagnostics and repair assistant",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <head />
      <body
        id="root"
        className="bg-gradient-to-br from-black via-neutral-900 to-[#1a1a1a] text-white font-header"
      >
        <Providers initialSession={null}>
          <Toaster position="top-center" />
          {children}
        </Providers>
      </body>
    </html>
  );
}

========================================
FILE: app/landing/PlanComparison.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { PLAN_LOOKUP_KEYS, type PlanKey } from "@/features/stripe/lib/stripe/constants";

type StripePrice = {
  id: string;
  nickname: string | null;
  unit_amount: number | null;
  currency: string | null;
  recurring?: { interval?: string | null } | null;
  lookup_key?: string | null;
};

type UiPlan = {
  key: PlanKey;
  priceId: string;
  title: string;
  amountCents: number;
  currency: string;
  interval: string; // "month"
  subtitle: string;
  bullets: string[];
};

function fmtMoney(amountCents: number, currency: string): string {
  const cur = String(currency ?? "usd").toUpperCase();
  const dollars = (amountCents / 100).toFixed(0);
  return `${cur} $${dollars}`;
}

export default function PlanComparison() {
  const [prices, setPrices] = useState<StripePrice[]>([]);
  const [loading, setLoading] = useState(true);
  const [busyId, setBusyId] = useState<string | null>(null);

  useEffect(() => {
    const loadPlans = async () => {
      try {
        const res = await fetch("/api/plans", { cache: "no-store" });
        const planData = (await res.json()) as StripePrice[];
        setPrices(Array.isArray(planData) ? planData : []);
      } catch {
        setPrices([]);
      } finally {
        setLoading(false);
      }
    };
    void loadPlans();
  }, []);

  const uiPlans = useMemo<UiPlan[]>(() => {
    // We only support TWO plans: pro30 + unlimited (monthly)
    const wanted: Array<{ key: PlanKey; lookup: string }> = [
      { key: "pro30", lookup: PLAN_LOOKUP_KEYS.pro30 },
      { key: "unlimited", lookup: PLAN_LOOKUP_KEYS.unlimited },
    ];

    // Find active monthly-ish prices by lookup_key
    const found = wanted
      .map(({ key, lookup }) => {
        const match = prices.find((p) => {
          const lk = String(p.lookup_key ?? "").trim();
          const interval = String(p.recurring?.interval ?? "").trim();
          return lk === lookup && (interval === "month" || interval === "monthly" || interval === "");
        });

        if (!match?.id || typeof match.unit_amount !== "number" || !match.currency) return null;

        const base: Omit<UiPlan, "subtitle" | "bullets"> = {
          key,
          priceId: match.id,
          title: key === "pro30" ? "Pro" : "Unlimited",
          amountCents: match.unit_amount,
          currency: match.currency,
          interval: "month",
        };

        if (key === "pro30") {
          return {
            ...base,
            subtitle: "Up to 30 users ‚Ä¢ $300 / month",
            bullets: [
              "Work orders + invoicing",
              "Inspections + templates",
              "Parts + inventory",
              "AI assistant + diagnostics",
              "Up to 30 team users",
            ],
          };
        }

        return {
          ...base,
          subtitle: "Unlimited users ‚Ä¢ $500 / month",
          bullets: [
            "Everything in Pro",
            "Unlimited team users",
            "Best for multi-tech shops",
            "Priority feature access (as released)",
          ],
        };
      })
      .filter((x): x is UiPlan => Boolean(x));

    // Keep fixed order
    const order: PlanKey[] = ["pro30", "unlimited"];
    found.sort((a, b) => order.indexOf(a.key) - order.indexOf(b.key));

    return found;
  }, [prices]);

  async function handleCheckout(priceId: string) {
    if (busyId) return;
    setBusyId(priceId);

    try {
      const res = await fetch("/api/stripe/checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // Server route in your app expects planKey (Stripe price id)
        body: JSON.stringify({ planKey: priceId }),
      });

      const j = (await res.json().catch(() => ({}))) as { url?: string; error?: string };

      if (!res.ok || !j.url) {
        alert(j.error || "Checkout failed");
        return;
      }

      window.location.href = j.url;
    } finally {
      setBusyId(null);
    }
  }

  return (
    <section className="px-4 py-14 text-neutral-100 bg-[radial-gradient(circle_at_top,_#050910,_#020308_60%,_#000)]">
      <div className="mx-auto w-full max-w-6xl">
        <div className="text-center">
          <div className="font-blackops text-[0.75rem] tracking-[0.28em] text-neutral-300">
            PROFIXIQ PLANS
          </div>
          <h2 className="mt-2 text-3xl sm:text-4xl font-semibold text-neutral-50">
            Simple pricing for real shops
          </h2>
          <p className="mt-2 text-sm text-neutral-300">
            Two plans. Monthly only. Upgrade anytime.
          </p>
        </div>

        <div className="mt-10 grid grid-cols-1 gap-6 md:grid-cols-2">
          {loading ? (
            <>
              <div className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.75)] backdrop-blur">
                <div className="h-6 w-40 rounded bg-white/10" />
                <div className="mt-3 h-10 w-48 rounded bg-white/10" />
                <div className="mt-6 space-y-2">
                  <div className="h-4 w-full rounded bg-white/10" />
                  <div className="h-4 w-5/6 rounded bg-white/10" />
                  <div className="h-4 w-2/3 rounded bg-white/10" />
                </div>
              </div>
              <div className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.75)] backdrop-blur">
                <div className="h-6 w-40 rounded bg-white/10" />
                <div className="mt-3 h-10 w-48 rounded bg-white/10" />
                <div className="mt-6 space-y-2">
                  <div className="h-4 w-full rounded bg-white/10" />
                  <div className="h-4 w-5/6 rounded bg-white/10" />
                  <div className="h-4 w-2/3 rounded bg-white/10" />
                </div>
              </div>
            </>
          ) : uiPlans.length === 0 ? (
            <div className="md:col-span-2 rounded-2xl border border-[var(--metal-border-soft)] bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.75)] backdrop-blur">
              <div className="text-sm text-neutral-200">Plans unavailable.</div>
              <div className="mt-1 text-xs text-neutral-400">
                Make sure Stripe Prices have the lookup keys:
                <span className="ml-2 font-mono text-neutral-300">
                  {PLAN_LOOKUP_KEYS.pro30}
                </span>
                <span className="mx-2 text-neutral-500">‚Ä¢</span>
                <span className="font-mono text-neutral-300">
                  {PLAN_LOOKUP_KEYS.unlimited}
                </span>
              </div>
            </div>
          ) : (
            uiPlans.map((p) => {
              const primary = p.key === "unlimited";
              return (
                <div
                  key={p.priceId}
                  className={[
                    "rounded-2xl border bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.75)] backdrop-blur",
                    "border-[var(--metal-border-soft)]",
                    primary
                      ? "ring-1 ring-[color:var(--accent-copper)]/35 shadow-[0_0_30px_rgba(212,118,49,0.22)]"
                      : "",
                  ].join(" ")}
                >
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="font-blackops text-[0.7rem] tracking-[0.24em] text-[var(--accent-copper-light)]">
                        {p.title.toUpperCase()}
                      </div>
                      <div className="mt-1 text-xs text-neutral-300">{p.subtitle}</div>
                    </div>

                    {primary ? (
                      <div className="rounded-full border border-[var(--metal-border-soft)] bg-black/40 px-3 py-1 text-[0.65rem] uppercase tracking-[0.18em] text-neutral-200">
                        Recommended
                      </div>
                    ) : null}
                  </div>

                  <div className="mt-5 flex items-end gap-2">
                    <div className="text-4xl font-semibold text-neutral-50">
                      {fmtMoney(p.amountCents, p.currency)}
                    </div>
                    <div className="pb-1 text-sm text-neutral-400">/ month</div>
                  </div>

                  <ul className="mt-5 space-y-2 text-sm text-neutral-200">
                    {p.bullets.map((b) => (
                      <li key={b} className="flex items-start gap-2">
                        <span className="mt-[0.2rem] inline-block h-1.5 w-1.5 rounded-full bg-[color:var(--accent-copper)] shadow-[0_0_14px_rgba(212,118,49,0.55)]" />
                        <span className="text-neutral-200">{b}</span>
                      </li>
                    ))}
                  </ul>

                  <button
                    onClick={() => handleCheckout(p.priceId)}
                    disabled={busyId === p.priceId}
                    className={[
                      "mt-6 w-full rounded-full px-4 py-2 text-xs font-semibold uppercase tracking-[0.22em] text-black",
                      "bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))]",
                      "shadow-[0_0_20px_rgba(212,118,49,0.55)] hover:brightness-110 disabled:opacity-60",
                    ].join(" ")}
                  >
                    {busyId === p.priceId ? "Starting‚Ä¶" : "Choose plan"}
                  </button>

                  <div className="mt-3 text-[11px] text-neutral-400">
                    Users are enforced in-app (Pro: 30 ‚Ä¢ Unlimited: no cap).
                  </div>
                </div>
              );
            })
          )}
        </div>
      </div>
    </section>
  );
}

========================================
FILE: app/layout.tsx
========================================
// app/layout.tsx
import "./globals.css";
import { Inter, Black_Ops_One } from "next/font/google";
import Providers from "./providers";
import AppShell from "@/features/shared/components/AppShell";
import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { VoiceProvider } from "@/features/shared/voice/VoiceProvider";

import { Toaster } from "react-hot-toast";

const inter = Inter({
  subsets: ["latin"],
  variable: "--font-inter",
  display: "swap",
});

const blackOps = Black_Ops_One({
  weight: "400",
  subsets: ["latin"],
  variable: "--font-blackops",
  display: "swap",
});

export const metadata = {
  title: "ProFixIQ",
  description: "Tech tools for modern shops",
};

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const supabase = createServerComponentClient<Database>({ cookies });
  const {
    data: { session },
  } = await supabase.auth.getSession();

  return (
    <html
      lang="en"
      className={`${inter.variable} ${blackOps.variable} dark`}
      suppressHydrationWarning
    >
      <body
        className="
          min-h-screen
          bg-[radial-gradient(circle_at_top,_rgba(249,115,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_70%)]
          text-white
          antialiased
        "
      >
        <Providers initialSession={session ?? null}>
          <VoiceProvider>
            {/* ‚úÖ AppShell now decides whether to wrap content in TabsBridge */}
            <AppShell>{children}</AppShell>
          </VoiceProvider>

          {/* Legacy toast for older parts of the app ‚Äì dark metal theme */}
          <Toaster
            position="bottom-center"
            toastOptions={{
              style: {
                background:
                  "radial-gradient(circle at top, rgba(15,23,42,0.96), #020617 70%)",
                border: "1px solid rgba(148, 163, 184, 0.5)",
                color: "#e5e7eb",
              },
            }}
          />
        </Providers>
      </body>
    </html>
  );
}

========================================
FILE: app/menu/page.tsx
========================================
// app/menu/page.tsx
"use client";

import  {
  useEffect,
  useState,
  useCallback,
  useMemo,
} from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { useUser } from "@auth/hooks/useUser";
import { toast } from "sonner";

import { PartPicker, type PickedPart } from "@parts/components/PartPicker";
import { masterServicesList } from "@inspections/lib/inspection/masterServicesList";

type DB = Database;

type MenuItemRow = DB["public"]["Tables"]["menu_items"]["Row"];
type InsertMenuItemPart =
  DB["public"]["Tables"]["menu_item_parts"]["Insert"];
type TemplateRow = DB["public"]["Tables"]["inspection_templates"]["Row"] & {
  labor_hours?: number | null;
};

type PartFormRow = {
  name: string;
  quantityStr: string;
  unitCostStr: string;
  part_id?: string | null;
};

type FormState = {
  source: "master" | "manual";
  name: string;
  description: string;
  laborTimeStr: string;
  laborRateStr: string;
  inspectionTemplateId: string;
};

export default function MenuItemsPage() {
  const supabase = createClientComponentClient<DB>();
  const { user, isLoading } = useUser();

  const [menuItems, setMenuItems] = useState<MenuItemRow[]>([]);
  const [saving, setSaving] = useState(false);

  const [pickerOpenForRow, setPickerOpenForRow] = useState<number | null>(
    null,
  );
  const [parts, setParts] = useState<PartFormRow[]>([
    { name: "", quantityStr: "", unitCostStr: "", part_id: null },
  ]);

  const [templates, setTemplates] = useState<TemplateRow[]>([]);

  const [form, setForm] = useState<FormState>({
    source: "master",
    name: "",
    description: "",
    laborTimeStr: "",
    laborRateStr: "",
    inspectionTemplateId: "",
  });

  // --------- tiny numeric helper ----------
  const toNum = (s: string) => {
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  };

  const partsTotal = useMemo(
    () =>
      parts.reduce((sum, p) => {
        const q = toNum(p.quantityStr);
        const u = toNum(p.unitCostStr);
        return sum + q * u;
      }, 0),
    [parts],
  );

  const laborTotal = useMemo(
    () => toNum(form.laborTimeStr) * toNum(form.laborRateStr),
    [form.laborTimeStr, form.laborRateStr],
  );

  const grandTotal = useMemo(
    () => partsTotal + laborTotal,
    [partsTotal, laborTotal],
  );

  // --------- fetch menu items ----------
  const fetchItems = useCallback(async () => {
    const { data, error } = await supabase
      .from("menu_items")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(100);

    if (error) {
      console.error("Failed to fetch menu items:", error);
      toast.error("Could not load menu items");
      return;
    }

    setMenuItems(data ?? []);
  }, [supabase]);

  // --------- fetch templates ----------
  const fetchTemplates = useCallback(async () => {
    const { data: me } = await supabase.auth.getUser();
    const uid = me?.user?.id ?? null;

    const minePromise = uid
      ? supabase
          .from("inspection_templates")
          .select("*")
          .eq("user_id", uid)
          .order("created_at", { ascending: false })
      : Promise.resolve({
          data: [] as TemplateRow[],
          error: null,
        });

    const sharedPromise = supabase
      .from("inspection_templates")
      .select("*")
      .eq("is_public", true)
      .order("created_at", { ascending: false });

    const [{ data: mineRaw }, { data: sharedRaw }] = await Promise.all([
      minePromise,
      sharedPromise,
    ]);

    setTemplates([
      ...(Array.isArray(mineRaw) ? mineRaw : []),
      ...(Array.isArray(sharedRaw) ? sharedRaw : []),
    ]);
  }, [supabase]);

  // --------- bootstrap ----------
  useEffect(() => {
    void fetchItems();
    void fetchTemplates();

    const channel = supabase
      .channel("menu-items-sync")
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "menu_items",
        },
        () => {
          void fetchItems();
        },
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [supabase, fetchItems, fetchTemplates]);

  // --------- parts helpers ----------
  const setPartField = (
    idx: number,
    field: "name" | "quantityStr" | "unitCostStr",
    value: string,
  ) => {
    const cleanNumeric = (v: string) => {
      if (v === "") return "";
      if (/^\d/.test(v)) v = v.replace(/^0+(?=\d)/, "");
      return v;
    };

    setParts((rows) =>
      rows.map((r, i) =>
        i === idx
          ? {
              ...r,
              [field]:
                field === "name"
                  ? value
                  : cleanNumeric(value.replace(/[^\d.]/g, "")),
            }
          : r,
      ),
    );
  };

  const addPartRow = () => {
    setParts((rows) => [
      ...rows,
      { name: "", quantityStr: "", unitCostStr: "", part_id: null },
    ]);
  };

  const removePartRow = (idx: number) => {
    setParts((rows) => rows.filter((_, i) => i !== idx));
  };

  const handlePickPart =
    (rowIdx: number) =>
    (sel: PickedPart): void => {
      (async () => {
        const { data } = await supabase
          .from("parts")
          .select("name, sku")
          .eq("id", sel.part_id)
          .maybeSingle();

        const label = data?.name ?? "Part";
        const qtyFromSel =
          sel.qty && sel.qty > 0 ? String(sel.qty) : "";

        const unitCostFromSel =
          sel.unit_cost != null && !Number.isNaN(sel.unit_cost)
            ? String(sel.unit_cost)
            : "";

        setParts((rows) =>
          rows.map((r, i) =>
            i === rowIdx
              ? {
                  ...r,
                  part_id: sel.part_id,
                  name: label,
                  quantityStr: r.quantityStr || qtyFromSel,
                  unitCostStr: r.unitCostStr || unitCostFromSel,
                }
              : r,
          ),
        );

        toast.success(`Added ${label} to row`);
      })().catch(() => {
        setParts((rows) =>
          rows.map((r, i) =>
            i === rowIdx ? { ...r, part_id: sel.part_id } : r,
          ),
        );
      });
    };

  // --------- SAVE ----------
  const handleSubmit = useCallback(async () => {
    if (!form.name.trim()) {
      toast.error("Service name is required");
      return;
    }

    setSaving(true);
    try {
      const cleanedParts: InsertMenuItemPart[] = parts
        .filter(
          (p) => p.name.trim().length > 0 && toNum(p.quantityStr) > 0,
        )
        .map<InsertMenuItemPart>((p) => ({
          menu_item_id: "placeholder",
          name: p.name.trim(),
          quantity: toNum(p.quantityStr),
          unit_cost: toNum(p.unitCostStr),
          user_id: user?.id ?? null,
        }));

      const payload = {
        item: {
          name: form.name.trim(),
          description: form.description.trim() || null,
          labor_time: toNum(form.laborTimeStr),
          labor_hours: null,
          part_cost: partsTotal,
          total_price: grandTotal,
          inspection_template_id: form.inspectionTemplateId || null,
          shop_id:
            (user as unknown as { shop_id?: string | null })?.shop_id ??
            null,
        },
        parts: cleanedParts,
      };

      const res = await fetch("/api/menu/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const json = (await res.json()) as {
        ok?: boolean;
        error?: string;
      };

      if (!res.ok || json.error) {
        console.error("[menu] save failed:", json.error);
        toast.error(json.error ?? "Failed to save menu item.");
        return;
      }

      toast.success("Menu item created");

      setForm((f) => ({
        ...f,
        name: "",
        description: "",
        laborTimeStr: "",
        inspectionTemplateId: "",
      }));
      setParts([
        { name: "", quantityStr: "", unitCostStr: "", part_id: null },
      ]);

      await fetchItems();
    } catch (err) {
      console.error("[menu] unexpected save error", err);
      toast.error("Could not save menu item.");
    } finally {
      setSaving(false);
    }
  }, [form, parts, partsTotal, grandTotal, user, fetchItems]);

  if (isLoading) {
    return (
      <div className="flex min-h-[200px] items-center justify-center text-sm text-neutral-300">
        Loading‚Ä¶
      </div>
    );
  }

  const flatMaster = masterServicesList.flatMap((cat) =>
    cat.items.map((i) => i.item),
  );

  return (
    <div className="relative space-y-8 fade-in">
      {/* extra radial wash for this page */}
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.16),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.95),#020617_70%)]"
      />

      {/* Header */}
      <section className="metal-card mb-2 flex items-center justify-between gap-4 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-r from-black/85 via-slate-950/95 to-black/85 px-5 py-4 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl">
        <div>
          <h1
            className="text-2xl font-semibold text-white"
            style={{
              fontFamily: "var(--font-blackops), system-ui",
            }}
          >
            Service Menu
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            Build reusable service packages with linked inspections, labor, and
            parts.
          </p>
        </div>
      </section>

      {/* Form + parts editor */}
      <section className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/65 p-4 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl md:p-6">
        <div className="mb-4 flex items-center justify-between gap-3">
          <h2 className="text-sm font-semibold uppercase tracking-[0.2em] text-neutral-400">
            Create menu item
          </h2>
          <div className="rounded-full border border-[color:var(--accent-copper,#f97316)]/50 bg-black/70 px-3 py-1 text-[11px] text-neutral-300">
            Parts + labor + inspection template
          </div>
        </div>

        {/* form */}
        <div className="mb-8 grid max-w-3xl gap-4">
          {/* Service name */}
          <div className="grid gap-2">
            <label className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
              Service name
            </label>
            <div className="flex flex-col gap-2 sm:flex-row">
              <select
                value={form.source}
                onChange={(e) =>
                  setForm((f) => ({
                    ...f,
                    source: e.target.value as "master" | "manual",
                  }))
                }
                className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] backdrop-blur-md sm:w-44"
              >
                <option value="master">From master list</option>
                <option value="manual">Manual</option>
              </select>
              <div className="flex-1">
                <input
                  placeholder="e.g. Front brake pads & rotors"
                  value={form.name}
                  onChange={(e) =>
                    setForm((f) => ({ ...f, name: e.target.value }))
                  }
                  list={
                    form.source === "master" ? "master-services" : undefined
                  }
                  autoComplete="off"
                  className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] placeholder:text-neutral-500 backdrop-blur-md"
                />
                {form.source === "master" ? (
                  <datalist id="master-services">
                    {flatMaster.map((s) => (
                      <option key={s} value={s} />
                    ))}
                  </datalist>
                ) : null}
              </div>
            </div>
          </div>

          {/* inspection template pick */}
          <div className="grid gap-2">
            <label className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
              Inspection template (optional)
            </label>
            <select
              value={form.inspectionTemplateId}
              onChange={(e) =>
                setForm((f) => ({
                  ...f,
                  inspectionTemplateId: e.target.value,
                }))
              }
              className="w-full rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] backdrop-blur-md"
            >
              <option value="">‚Äî none ‚Äî</option>
              {templates.map((t) => (
                <option key={t.id} value={t.id}>
                  {t.template_name ?? "Untitled"}
                  {typeof t.labor_hours === "number"
                    ? ` (${t.labor_hours.toFixed(1)}h)`
                    : ""}
                </option>
              ))}
            </select>
          </div>

          {/* description */}
          <div className="grid gap-2">
            <label className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
              Description
            </label>
            <textarea
              placeholder="Optional details visible to customer"
              value={form.description}
              onChange={(e) =>
                setForm((f) => ({ ...f, description: e.target.value }))
              }
              className="min-h-[80px] rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] placeholder:text-neutral-500 backdrop-blur-md"
            />
          </div>

          {/* labor */}
          <div className="grid gap-3 md:grid-cols-2">
            <div className="grid gap-2">
              <label className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                Labor time (hrs)
              </label>
              <input
                type="text"
                inputMode="decimal"
                placeholder="e.g. 1.5"
                value={form.laborTimeStr}
                onChange={(e) => {
                  const v = e.target.value.replace(/[^\d.]/g, "");
                  const cleaned = v === "" ? "" : v.replace(/^0+(?=\d)/, "");
                  setForm((f) => ({ ...f, laborTimeStr: cleaned }));
                }}
                className="rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] placeholder:text-neutral-500 backdrop-blur-md"
              />
            </div>
            <div className="grid gap-2">
              <label className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                Labor rate ($/hr)
              </label>
              <input
                type="text"
                inputMode="decimal"
                placeholder="e.g. 120"
                value={form.laborRateStr}
                onChange={(e) => {
                  const v = e.target.value.replace(/[^\d.]/g, "");
                  const cleaned = v === "" ? "" : v.replace(/^0+(?=\d)/, "");
                  setForm((f) => ({ ...f, laborRateStr: cleaned }));
                }}
                className="rounded-xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-3 py-2 text-sm text-neutral-100 shadow-[0_10px_24px_rgba(0,0,0,0.9)] placeholder:text-neutral-500 backdrop-blur-md"
              />
            </div>
          </div>

          {/* parts */}
          <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 shadow-[0_18px_40px_rgba(0,0,0,0.95)] backdrop-blur-xl">
            <div className="flex items-center justify-between border-b border-white/10 bg-gradient-to-r from-black/80 via-slate-950/80 to-black/80 px-4 py-2.5">
              <h3 className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
                Parts
              </h3>
              <span className="text-[11px] text-neutral-500">
                Linked to parts catalog
              </span>
            </div>
            <div className="space-y-3 p-4">
              {parts.map((p, idx) => (
                <div
                  key={idx}
                  className="grid grid-cols-1 items-center gap-2 rounded-xl border border-white/5 bg-black/60 p-3 text-sm shadow-[0_12px_30px_rgba(0,0,0,0.9)] backdrop-blur-md md:grid-cols-[2fr_0.8fr_0.8fr_auto_auto]"
                >
                  <input
                    placeholder="Part name (or pick)"
                    value={p.name}
                    onChange={(e) =>
                      setPartField(idx, "name", e.target.value)
                    }
                    className="w-full rounded-lg border border-[color:var(--metal-border-soft,#1f2937)] bg-transparent px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:outline-none"
                  />
                  <input
                    placeholder="Qty"
                    inputMode="numeric"
                    value={p.quantityStr}
                    onChange={(e) =>
                      setPartField(idx, "quantityStr", e.target.value)
                    }
                    className="w-full rounded-lg border border-[color:var(--metal-border-soft,#1f2937)] bg-transparent px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:outline-none"
                  />
                  <input
                    placeholder="Unit cost"
                    inputMode="decimal"
                    value={p.unitCostStr}
                    onChange={(e) =>
                      setPartField(idx, "unitCostStr", e.target.value)
                    }
                    className="w-full rounded-lg border border-[color:var(--metal-border-soft,#1f2937)] bg-transparent px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:outline-none"
                  />
                  <button
                    type="button"
                    onClick={() => setPickerOpenForRow(idx)}
                    className="rounded-lg border border-[color:var(--accent-copper-soft,#fdba74)]/60 px-3 py-2 text-xs font-medium text-neutral-100 hover:bg-[color:var(--accent-copper,#f97316)]/15"
                  >
                    Pick
                  </button>
                  <button
                    type="button"
                    onClick={() => removePartRow(idx)}
                    className="text-xs text-red-400 hover:text-red-300"
                  >
                    ‚úï
                  </button>
                </div>
              ))}
              <button
                onClick={addPartRow}
                type="button"
                className="text-xs font-medium text-[color:var(--accent-copper,#f97316)] hover:text-[color:var(--accent-copper-light,#fed7aa)]"
              >
                + Add part
              </button>
            </div>
          </div>

          {/* totals + save */}
          <div className="flex flex-col items-end gap-3 pt-2 text-sm md:flex-row md:items-center md:justify-between">
            <div className="flex flex-wrap items-center gap-4 text-xs md:text-sm">
              <div className="text-neutral-300">
                Parts:{" "}
                <span className="text-white">
                  ${partsTotal.toFixed(2)}
                </span>
              </div>
              <div className="text-neutral-300">
                Labor:{" "}
                <span className="text-white">
                  ${laborTotal.toFixed(2)}
                </span>
              </div>
              <div className="text-neutral-300">
                Total:{" "}
                <span className="font-semibold text-[color:var(--accent-copper,#f97316)]">
                  ${grandTotal.toFixed(2)}
                </span>
              </div>
            </div>
            <button
              onClick={handleSubmit}
              disabled={saving}
              className="inline-flex items-center justify-center rounded-full border border-[color:var(--accent-copper,#f97316)]/80 bg-gradient-to-r from-black/80 via-[color:var(--accent-copper,#f97316)]/15 to-black/80 px-6 py-2 text-sm font-semibold text-neutral-50 shadow-[0_16px_36px_rgba(0,0,0,0.95)] backdrop-blur-md transition hover:border-[color:var(--accent-copper-light,#fed7aa)] hover:bg-[color:var(--accent-copper,#f97316)]/20 disabled:opacity-60 disabled:cursor-not-allowed"
            >
              {saving ? "Saving‚Ä¶" : "Save menu item"}
            </button>
          </div>
        </div>
      </section>

      {/* existing items */}
      <section className="space-y-3">
        <h2 className="text-xs font-medium uppercase tracking-[0.18em] text-neutral-400">
          Saved menu items
        </h2>
        <ul className="space-y-2">
          {menuItems.map((item) => (
            <li
              key={item.id}
              className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 p-3 shadow-[0_16px_36px_rgba(0,0,0,0.95)] backdrop-blur-xl"
            >
              <div className="flex flex-col items-start justify-between gap-2 md:flex-row md:items-center">
                <div>
                  <div className="text-sm font-semibold text-[color:var(--accent-copper,#f97316)]">
                    {item.name}
                  </div>
                  {item.description ? (
                    <span className="block text-xs text-neutral-400">
                      {item.description}
                    </span>
                  ) : null}
                </div>
                <div className="text-xs text-neutral-300 md:text-sm">
                  {typeof item.total_price === "number" && (
                    <span>
                      Total{" "}
                      <span className="font-semibold text-neutral-50">
                        ${item.total_price.toFixed(2)}
                      </span>
                    </span>
                  )}
                </div>
              </div>
            </li>
          ))}
          {menuItems.length === 0 && (
            <li className="text-sm text-neutral-400">
              No menu items yet. Create your first service above.
            </li>
          )}
        </ul>
      </section>

      {/* Part picker modal */}
      {pickerOpenForRow !== null && (
        <PartPicker
          open={true}
          onClose={() => setPickerOpenForRow(null)}
          onPick={(sel) => {
            const idx = pickerOpenForRow;
            setPickerOpenForRow(null);
            handlePickPart(idx)(sel);
          }}
        />
      )}
    </div>
  );
}

========================================
FILE: app/mobile/appointments/page.tsx
========================================
// app/mobile/appointments/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";

type DB = Database;
type ShopRow = DB["public"]["Tables"]["shops"]["Row"];
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];

export type Booking = {
  id: string;
  shop_slug?: string | null;
  starts_at: string; // ISO
  ends_at: string; // ISO
  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;
  notes?: string | null;
  status?: string | null; // pending, confirmed, cancelled...
};

const isoDate = (d: Date) => d.toISOString().slice(0, 10);

function startOfToday(): Date {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
}

/* -------------------------------------------------------------------------- */
/* Page                                                                        */
/* -------------------------------------------------------------------------- */

export default function MobileAppointmentsPage() {
  const supabase = createClientComponentClient<DB>();
  const search = useSearchParams();
  const router = useRouter();

  // shops
  const [shops, setShops] = useState<ShopRow[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");

  // customers for selected shop
  const [customers, setCustomers] = useState<CustomerRow[]>([]);
  const [loadingCustomers, setLoadingCustomers] = useState(false);

  // day (mobile: single-day view, not weekly)
  const [day, setDay] = useState<string>(() => isoDate(startOfToday()));

  // data
  const [bookings, setBookings] = useState<Booking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  // form state
  const [editing, setEditing] = useState<Booking | null>(null);

  /* --------------------------------- Shops --------------------------------- */

  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        // eslint-disable-next-line no-console
        console.error(error);
        toast.error("Unable to load shops.");
        return;
      }

      const rows = (data ?? []) as ShopRow[];
      setShops(rows);

      // default to first shop if none selected
      if (!shopSlug && rows.length > 0) {
        const first = rows[0].slug as string;
        setShopSlug(first);
        router.replace(
          `/mobile/appointments?shop=${encodeURIComponent(first)}`,
        );
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // selected shop row
  const selectedShop = useMemo(
    () => shops.find((s) => (s.slug as string | null) === shopSlug) ?? null,
    [shops, shopSlug],
  );

  /* ------------------------------ Customers -------------------------------- */

  useEffect(() => {
    if (!selectedShop) return;

    (async () => {
      setLoadingCustomers(true);
      try {
        const { data, error } = await supabase
          .from("customers")
          .select("*")
          .eq("shop_id", selectedShop.id)
          .order("last_name", { ascending: true })
          .order("first_name", { ascending: true });

        if (error) {
          // eslint-disable-next-line no-console
          console.error(error);
          toast.error("Unable to load customers.");
          setCustomers([]);
        } else {
          setCustomers((data ?? []) as CustomerRow[]);
        }
      } catch (e) {
        // eslint-disable-next-line no-console
        console.error(e);
        toast.error("Unable to load customers.");
        setCustomers([]);
      } finally {
        setLoadingCustomers(false);
      }
    })();
  }, [supabase, selectedShop]);

  /* ------------------------------ Bookings --------------------------------- */

  useEffect(() => {
    if (!shopSlug || !day) return;

    (async () => {
      setLoadingBookings(true);
      try {
        // mobile: single day window
        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(
            shopSlug,
          )}&start=${day}&end=${day}`,
          { cache: "no-store" },
        );
        if (!res.ok) throw new Error("Failed to load appointments.");
        const j = (await res.json().catch(() => [])) as Booking[];
        setBookings(j ?? []);
      } catch (err) {
        // eslint-disable-next-line no-console
        console.error(err);
        toast.error("Failed to load appointments.");
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [shopSlug, day]);

  async function refreshDay() {
    if (!shopSlug || !day) return;
    try {
      const res = await fetch(
        `/api/portal/bookings?shop=${encodeURIComponent(
          shopSlug,
        )}&start=${day}&end=${day}`,
        { cache: "no-store" },
      );
      const refreshed = (await res.json().catch(() => [])) as Booking[];
      setBookings(refreshed ?? []);
    } catch {
      // ignore, already tosted by caller usually
    }
  }

  /* -------------------------- Create / Update / Delete --------------------- */

  async function handleCreate(form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) {
    if (!shopSlug) {
      toast.error("Select a shop first.");
      return;
    }

    try {
      const startIso = new Date(`${form.date}T${form.startsAt}`).toISOString();
      const endIso = new Date(`${form.date}T${form.endsAt}`).toISOString();

      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: form.notes,
          customerId: form.customerId ?? null,
          customerName: form.customerName,
          customerEmail: form.customerEmail,
          customerPhone: form.customerPhone,
        }),
      });

      const j = (await res
        .json()
        .catch(() => ({}))) as { booking?: Booking; error?: string };

      if (!res.ok || !j.booking) {
        throw new Error(j?.error || "Unable to create appointment.");
      }

      toast.success("Appointment created.");
      setDay(form.date); // jump day to created date if different
      await refreshDay();
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Create failed";
      toast.error(message);
    }
  }

  async function handleUpdate(id: string, patch: Partial<Booking>) {
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(patch),
      });
      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Update failed");

      toast.success("Appointment updated.");
      setEditing(null);
      await refreshDay();
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Update failed";
      toast.error(message);
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("Delete this appointment?")) return;
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Delete failed.");
      toast.success("Appointment deleted.");
      setBookings((prev) => prev.filter((b) => b.id !== id));
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Delete failed";
      toast.error(message);
    }
  }

  const totalForDay = bookings.length;

  /* -------------------------------- Render --------------------------------- */

  return (
    <main className="min-h-screen bg-black text-white">
      <Toaster position="top-center" />

      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-4">
        {/* Header */}
        <header className="space-y-1">
          <div className="text-[0.7rem] uppercase tracking-[0.24em] text-neutral-500">
            ProFixIQ ‚Ä¢ Appointments
          </div>
          <h1 className="font-blackops text-lg uppercase tracking-[0.18em] text-orange-400">
            Today&apos;s bookings
          </h1>
          <p className="text-[0.75rem] text-neutral-400">
            Mobile view for advisors / managers to manage the day&apos;s
            appointments.
          </p>
        </header>

        {/* Shop + day picker */}
        <section className="space-y-3 rounded-2xl border border-white/10 bg-black/40 p-3 shadow-card backdrop-blur-md">
          <div className="flex items-center justify-between gap-3">
            <label className="flex-1 text-[0.65rem] uppercase tracking-[0.12em] text-neutral-400">
              Shop
              <select
                value={shopSlug}
                onChange={(e) => {
                  const slug = e.target.value;
                  setShopSlug(slug);
                  router.replace(
                    `/mobile/appointments?shop=${encodeURIComponent(slug)}`,
                  );
                }}
                className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
              >
                {shops.map((s) => (
                  <option key={s.slug as string} value={s.slug as string}>
                    {s.name}
                  </option>
                ))}
              </select>
            </label>

            <div className="flex flex-col items-end text-right">
              <span className="text-[0.6rem] uppercase tracking-[0.12em] text-neutral-500">
                Today
              </span>
              <span className="text-sm font-semibold text-neutral-100">
                {totalForDay} appt{totalForDay === 1 ? "" : "s"}
              </span>
            </div>
          </div>

          <div className="flex items-center gap-2">
            <label className="flex-1 text-[0.65rem] uppercase tracking-[0.12em] text-neutral-400">
              Date
              <input
                type="date"
                value={day}
                onChange={(e) => setDay(e.target.value)}
                className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
              />
            </label>
            <div className="flex flex-col gap-1">
              <Button
                type="button"
                variant="outline"
                size="xs"
                onClick={() => {
                  const d = new Date(day);
                  d.setDate(d.getDate() - 1);
                  setDay(isoDate(d));
                }}
              >
                ‚Üê
              </Button>
              <Button
                type="button"
                variant="outline"
                size="xs"
                onClick={() => setDay(isoDate(startOfToday()))}
              >
                Today
              </Button>
              <Button
                type="button"
                variant="outline"
                size="xs"
                onClick={() => {
                  const d = new Date(day);
                  d.setDate(d.getDate() + 1);
                  setDay(isoDate(d));
                }}
              >
                ‚Üí
              </Button>
            </div>
          </div>
        </section>

        {/* Create / edit form */}
        <section className="space-y-2 rounded-2xl border border-white/10 bg-black/40 p-3 shadow-card backdrop-blur-md">
          {editing ? (
            <EditForm
              booking={editing}
              customers={customers}
              loadingCustomers={loadingCustomers}
              onCancel={() => setEditing(null)}
              onSave={(patch) => void handleUpdate(editing.id, patch)}
            />
          ) : (
            <CreateForm
              defaultDate={day}
              customers={customers}
              loadingCustomers={loadingCustomers}
              onSubmit={handleCreate}
            />
          )}
        </section>

        {/* List for the selected day */}
        <section className="space-y-2 rounded-2xl border border-white/10 bg-black/40 p-3 shadow-card backdrop-blur-md">
          <div className="flex items-center justify-between">
            <h2 className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-400">
              Appointments for this day
            </h2>
            {loadingBookings && (
              <span className="text-[0.65rem] text-neutral-400">
                Loading‚Ä¶
              </span>
            )}
          </div>

          {loadingBookings ? (
            <p className="text-xs text-neutral-400">Fetching appointments‚Ä¶</p>
          ) : bookings.length === 0 ? (
            <p className="text-xs text-neutral-400">
              No appointments for this day.
            </p>
          ) : (
            <ul className="space-y-2">
              {bookings
                .slice()
                .sort(
                  (a, b) =>
                    +new Date(a.starts_at) - +new Date(b.starts_at),
                )
                .map((b) => {
                  const start = new Date(b.starts_at);
                  const end = new Date(b.ends_at);
                  const timeLabel = `${start.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })} ‚Äì ${end.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })}`;

                  return (
                    <li
                      key={b.id}
                      className="flex items-start justify-between gap-2 rounded-xl border border-white/12 bg-black/50 px-3 py-2 text-xs"
                    >
                      <div className="min-w-0 flex-1">
                        <div className="font-medium text-neutral-50">
                          {b.customer_name || "Customer"}
                        </div>
                        <div className="mt-0.5 text-[0.7rem] text-neutral-400">
                          {timeLabel}
                        </div>
                        {b.notes && (
                          <div className="mt-0.5 line-clamp-2 text-[0.7rem] text-neutral-500">
                            {b.notes}
                          </div>
                        )}
                      </div>
                      <div className="flex flex-col items-end gap-1">
                        <Button
                          type="button"
                          size="xs"
                          variant="outline"
                          onClick={() => setEditing(b)}
                        >
                          Edit
                        </Button>
                        <Button
                          type="button"
                          size="xs"
                          variant="ghost"
                          className="text-red-300 hover:bg-red-900/25"
                          onClick={() => void handleDelete(b.id)}
                        >
                          Delete
                        </Button>
                      </div>
                    </li>
                  );
                })}
            </ul>
          )}
        </section>

        <footer className="pt-1 text-center text-[0.65rem] text-neutral-500">
          Mobile day planner ‚Ä¢ desktop view is available under Appointments in
          the main app.
        </footer>
      </div>
    </main>
  );
}

/* -------------------------------------------------------------------------- */
/* Forms                                                                      */
/* -------------------------------------------------------------------------- */

function customerLabel(c: CustomerRow): string {
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const anyC: any = c;
  const name =
    anyC.full_name ||
    anyC.name ||
    `${anyC.first_name ?? ""} ${anyC.last_name ?? ""}`.trim() ||
    "Customer";
  const phone = anyC.phone || anyC.mobile || "";
  return phone ? `${name} (${phone})` : name;
}

function CreateForm({
  defaultDate,
  customers,
  loadingCustomers,
  onSubmit,
}: {
  defaultDate: string;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onSubmit: (form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) => void;
}) {
  const [date, setDate] = useState(defaultDate);
  const [startsAt, setStartsAt] = useState("09:00");
  const [endsAt, setEndsAt] = useState("10:00");
  const [customerId, setCustomerId] = useState<string>("");
  const [customerName, setCustomerName] = useState("");
  const [customerEmail, setCustomerEmail] = useState("");
  const [customerPhone, setCustomerPhone] = useState("");
  const [notes, setNotes] = useState("");

  useEffect(() => {
    setDate(defaultDate);
  }, [defaultDate]);

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const anyC: any = c;
    const name =
      anyC.full_name ||
      anyC.name ||
      `${anyC.first_name ?? ""} ${anyC.last_name ?? ""}`.trim();
    setCustomerName(name || "");
    setCustomerEmail(anyC.email || anyC.contact_email || "");
    setCustomerPhone(anyC.phone || anyC.mobile || "");
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        onSubmit({
          date,
          startsAt,
          endsAt,
          customerId: customerId || undefined,
          customerName,
          customerEmail,
          customerPhone,
          notes,
        });
      }}
    >
      <h3 className="text-xs font-semibold uppercase tracking-[0.16em] text-neutral-300">
        Create appointment
      </h3>

      <div className="space-y-2">
        <label className="text-[0.7rem] text-neutral-300">
          Date
          <input
            type="date"
            value={date}
            onChange={(e) => setDate(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
          />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-[0.7rem] text-neutral-300">
            Start
            <input
              type="time"
              value={startsAt}
              onChange={(e) => setStartsAt(e.target.value)}
              className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
            />
          </label>
          <label className="flex-1 text-[0.7rem] text-neutral-300">
            End
            <input
              type="time"
              value={endsAt}
              onChange={(e) => setEndsAt(e.target.value)}
              className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
            />
          </label>
        </div>
      </div>

      <label className="text-[0.7rem] text-neutral-300">
        Customer (from database)
        <select
          value={customerId}
          onChange={(e) => handleSelectCustomer(e.target.value)}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
        >
          <option value="">
            {loadingCustomers ? "Loading‚Ä¶" : "Select‚Ä¶"}
          </option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-[0.7rem] text-neutral-300">
        Customer name
        <input
          value={customerName}
          onChange={(e) => setCustomerName(e.target.value)}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          placeholder="John Smith"
        />
      </label>

      <div className="flex flex-col gap-2 sm:flex-row">
        <label className="flex-1 text-[0.7rem] text-neutral-300">
          Email
          <input
            type="email"
            value={customerEmail}
            onChange={(e) => setCustomerEmail(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          />
        </label>
        <label className="flex-1 text-[0.7rem] text-neutral-300">
          Phone
          <input
            value={customerPhone}
            onChange={(e) => setCustomerPhone(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          />
        </label>
      </div>

      <label className="text-[0.7rem] text-neutral-300">
        Notes
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          rows={3}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
        />
      </label>

      <Button type="submit" size="sm" className="mt-1 font-semibold">
        Save appointment
      </Button>
    </form>
  );
}

function EditForm({
  booking,
  customers,
  loadingCustomers,
  onCancel,
  onSave,
}: {
  booking: Booking;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onCancel: () => void;
  onSave: (patch: Partial<Booking>) => void;
}) {
  const start = new Date(booking.starts_at);
  const end = new Date(booking.ends_at);

  const [date, setDate] = useState(booking.starts_at.slice(0, 10));
  const [startsAt, setStartsAt] = useState(start.toISOString().slice(11, 16));
  const [endsAt, setEndsAt] = useState(end.toISOString().slice(11, 16));

  const [customerId, setCustomerId] = useState<string>(
    booking.customer_id ?? "",
  );
  const [customerName, setCustomerName] = useState(
    booking.customer_name ?? "",
  );
  const [customerEmail, setCustomerEmail] = useState(
    booking.customer_email ?? "",
  );
  const [customerPhone, setCustomerPhone] = useState(
    booking.customer_phone ?? "",
  );
  const [notes, setNotes] = useState(booking.notes ?? "");
  const [status, setStatus] = useState(booking.status ?? "pending");

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const anyC: any = c;
    const name =
      anyC.full_name ||
      anyC.name ||
      `${anyC.first_name ?? ""} ${anyC.last_name ?? ""}`.trim();
    setCustomerName(name || "");
    setCustomerEmail(anyC.email || anyC.contact_email || "");
    setCustomerPhone(anyC.phone || anyC.mobile || "");
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        const starts_at = new Date(`${date}T${startsAt}`).toISOString();
        const ends_at = new Date(`${date}T${endsAt}`).toISOString();
        onSave({
          starts_at,
          ends_at,
          customer_id: customerId || null,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          notes,
          status,
        });
      }}
    >
      <h3 className="text-xs font-semibold uppercase tracking-[0.16em] text-neutral-300">
        Edit appointment
      </h3>

      <div className="space-y-2">
        <label className="text-[0.7rem] text-neutral-300">
          Date
          <input
            type="date"
            value={date}
            onChange={(e) => setDate(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-[0.7rem] text-neutral-300">
            Start
            <input
              type="time"
              value={startsAt}
              onChange={(e) => setStartsAt(e.target.value)}
              className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
            />
          </label>
          <label className="flex-1 text-[0.7rem] text-neutral-300">
            End
            <input
              type="time"
              value={endsAt}
              onChange={(e) => setEndsAt(e.target.value)}
              className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
            />
          </label>
        </div>
      </div>

      <label className="text-[0.7rem] text-neutral-300">
        Customer (from database)
        <select
          value={customerId}
          onChange={(e) => handleSelectCustomer(e.target.value)}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
        >
          <option value="">
            {loadingCustomers ? "Loading‚Ä¶" : "Select‚Ä¶"}
          </option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-[0.7rem] text-neutral-300">
        Customer name
        <input
          value={customerName}
          onChange={(e) => setCustomerName(e.target.value)}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
        />
      </label>

      <div className="flex flex-col gap-2 sm:flex-row">
        <label className="flex-1 text-[0.7rem] text-neutral-300">
          Email
          <input
            type="email"
            value={customerEmail}
            onChange={(e) => setCustomerEmail(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          />
        </label>
        <label className="flex-1 text-[0.7rem] text-neutral-300">
          Phone
          <input
            value={customerPhone}
            onChange={(e) => setCustomerPhone(e.target.value)}
            className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
          />
        </label>
      </div>

      <label className="text-[0.7rem] text-neutral-300">
        Notes
        <textarea
          value={notes}
          onChange={(e) => setNotes(e.target.value)}
          rows={3}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
        />
      </label>

      <label className="text-[0.7rem] text-neutral-300">
        Status
        <select
          value={status}
          onChange={(e) => setStatus(e.target.value)}
          className="mt-1 w-full rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1.5 text-xs text-white"
        >
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </label>

      <div className="flex gap-2">
        <Button type="submit" size="sm" className="font-semibold">
          Save changes
        </Button>
        <Button type="button" size="sm" variant="outline" onClick={onCancel}>
          Cancel
        </Button>
      </div>
    </form>
  );
}

========================================
FILE: app/mobile/customers/[id]/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { format } from "date-fns";
import { MobileShell } from "components/layout/MobileShell";

type DB = Database;
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];

type ParamsShape = Record<string, string | string[]>;

function paramToString(v: string | string[] | undefined): string | null {
  if (!v) return null;
  return Array.isArray(v) ? v[0] ?? null : v;
}

const STATUS_BADGE: Record<string, string> = {
  awaiting:
    "bg-sky-500/10 border border-sky-500/60 text-[0.65rem] uppercase tracking-[0.16em] text-sky-100 rounded-full px-2 py-0.5",
  in_progress:
    "bg-orange-500/10 border border-orange-500/60 text-[0.65rem] uppercase tracking-[0.16em] text-orange-100 rounded-full px-2 py-0.5",
  on_hold:
    "bg-yellow-500/10 border border-yellow-500/60 text-[0.65rem] uppercase tracking-[0.16em] text-yellow-100 rounded-full px-2 py-0.5",
  completed:
    "bg-emerald-500/10 border border-emerald-500/60 text-[0.65rem] uppercase tracking-[0.16em] text-emerald-100 rounded-full px-2 py-0.5",
  invoiced:
    "bg-purple-500/10 border border-purple-500/60 text-[0.65rem] uppercase tracking-[0.16em] text-purple-100 rounded-full px-2 py-0.5",
};

function statusChipClass(status: string | null | undefined): string {
  const key = (status ?? "awaiting").toLowerCase().replace(/\s+/g, "_");
  return STATUS_BADGE[key] ?? STATUS_BADGE.awaiting;
}

export default function MobileCustomerProfilePage() {
  const params = useParams();
  const router = useRouter();
  const customerId = useMemo(() => {
    const raw = (params as ParamsShape)?.id;
    return paramToString(raw);
  }, [params]);

  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [customer, setCustomer] = useState<Customer | null>(null);
  const [vehicles, setVehicles] = useState<Vehicle[]>([]);
  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    if (!customerId) return;

    (async () => {
      setLoading(true);
      setErr(null);
      try {
        const [cRes, vRes, woRes] = await Promise.all([
          supabase
            .from("customers")
            .select("*")
            .eq("id", customerId)
            .maybeSingle(),
          supabase
            .from("vehicles")
            .select("*")
            .eq("customer_id", customerId)
            .order("created_at", { ascending: true }),
          supabase
            .from("work_orders")
            .select("*")
            .eq("customer_id", customerId)
            .order("created_at", { ascending: false }),
        ]);

        if (cRes.error) throw cRes.error;
        setCustomer(cRes.data ?? null);

        if (vRes.error) throw vRes.error;
        setVehicles(vRes.data ?? []);

        if (woRes.error) throw woRes.error;
        setWorkOrders(woRes.data ?? []);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load customer profile.";
        setErr(msg);
        setCustomer(null);
        setVehicles([]);
        setWorkOrders([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [customerId, supabase]);

  if (!customerId) {
    return (
      <MobileShell>
        <div className="px-4 py-4 text-sm text-red-400">
          Missing customer id.
        </div>
      </MobileShell>
    );
  }

  return (
    <MobileShell>
      <div className="px-4 py-4 space-y-4 text-foreground">
        {/* Top bar */}
        <div className="flex items-center justify-between gap-2">
          <button
            type="button"
            onClick={() => router.back()}
            className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs text-neutral-200 hover:bg-neutral-900"
          >
            ‚Üê Back
          </button>

          <Link
            href={`/customers/${customerId}`}
            className="rounded-full border border-orange-500/70 bg-orange-500 px-3 py-1 text-[0.7rem] font-semibold text-black hover:bg-orange-400"
          >
            Open full view
          </Link>
        </div>

        {/* Heading */}
        <div className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Customer
          </h1>
          {customer && (
            <p className="text-xs text-neutral-400">
              {[customer.first_name ?? "", customer.last_name ?? ""]
                .filter(Boolean)
                .join(" ") || "Customer"}
            </p>
          )}
        </div>

        {err && (
          <div className="rounded-md border border-red-500/60 bg-red-950/40 px-3 py-2 text-xs text-red-200">
            {err}
          </div>
        )}

        {loading ? (
          <div className="rounded-lg border border-white/10 bg-black/40 px-3 py-4 text-sm text-neutral-300">
            Loading customer‚Ä¶
          </div>
        ) : !customer ? (
          <div className="rounded-lg border border-dashed border-white/15 bg-black/40 px-3 py-6 text-sm text-neutral-400">
            Customer not found.
          </div>
        ) : (
          <>
            {/* Customer details */}
            <section className="space-y-2 rounded-lg border border-neutral-800 bg-neutral-950/80 px-3 py-3 text-sm">
              <div className="mb-1 text-[0.7rem] uppercase tracking-[0.16em] text-neutral-500">
                Contact
              </div>
              <div className="space-y-1 text-xs text-neutral-200">
                <div>
                  <span className="text-neutral-500">Name:</span>{" "}
                  {[customer.first_name ?? "", customer.last_name ?? ""]
                    .filter(Boolean)
                    .join(" ") || "‚Äî"}
                </div>
                <div>
                  <span className="text-neutral-500">Email:</span>{" "}
                  {customer.email ?? "‚Äî"}
                </div>
                <div>
                  <span className="text-neutral-500">Phone:</span>{" "}
                  {customer.phone ?? "‚Äî"}
                </div>
              </div>

              <div className="mt-3 mb-1 text-[0.7rem] uppercase tracking-[0.16em] text-neutral-500">
                Address
              </div>
              <div className="space-y-1 text-xs text-neutral-200">
                <div>{customer.address || "‚Äî"}</div>
                <div>
                  {[
                    customer.city || "",
                    customer.province || "",
                    customer.postal_code || "",
                  ]
                    .filter(Boolean)
                    .join(", ") || "‚Äî"}
                </div>
              </div>
            </section>

            {/* Vehicles */}
            <section className="space-y-2 rounded-lg border border-neutral-800 bg-neutral-950/80 px-3 py-3 text-sm">
              <div className="mb-1 flex items-center justify-between">
                <div className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-500">
                  Vehicles
                </div>
                {vehicles.length > 0 && (
                  <div className="text-[0.7rem] text-neutral-500">
                    {vehicles.length} total
                  </div>
                )}
              </div>

              {vehicles.length === 0 ? (
                <p className="text-xs text-neutral-400">No vehicles yet.</p>
              ) : (
                <div className="space-y-2">
                  {vehicles.map((v) => {
                    const title = [
                      v.year ? String(v.year) : "",
                      v.make ?? "",
                      v.model ?? "",
                    ]
                      .filter(Boolean)
                      .join(" ");

                    return (
                      <div
                        key={v.id}
                        className="rounded-md border border-neutral-800 bg-neutral-950 px-3 py-2 text-xs text-neutral-200"
                      >
                        <div className="flex items-center justify-between gap-2">
                          <div className="font-medium text-neutral-50">
                            {title || "Vehicle"}
                          </div>
                          {v.license_plate && (
                            <span className="rounded-full border border-neutral-700 px-2 py-0.5 text-[0.65rem] text-neutral-200">
                              {v.license_plate}
                            </span>
                          )}
                        </div>

                        <div className="mt-2 grid grid-cols-2 gap-1 text-[0.7rem] text-neutral-400">
                          <div>
                            <span className="text-neutral-500">VIN:</span>{" "}
                            {v.vin || "‚Äî"}
                          </div>
                          <div>
                            <span className="text-neutral-500">Mileage:</span>{" "}
                            {v.mileage || "‚Äî"}
                          </div>
                          <div>
                            <span className="text-neutral-500">Unit #:</span>{" "}
                            {v.unit_number || "‚Äî"}
                          </div>
                          <div>
                            <span className="text-neutral-500">Color:</span>{" "}
                            {v.color || "‚Äî"}
                          </div>
                          <div>
                            <span className="text-neutral-500">Engine hrs:</span>{" "}
                            {v.engine_hours != null ? String(v.engine_hours) : "‚Äî"}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </section>

            {/* Work order history */}
            <section className="space-y-2 rounded-lg border border-neutral-800 bg-neutral-950/80 px-3 py-3 text-sm">
              <div className="mb-1 flex items-center justify-between">
                <div className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-500">
                  Work Orders
                </div>
                {workOrders.length > 0 && (
                  <div className="text-[0.7rem] text-neutral-500">
                    {workOrders.length} total
                  </div>
                )}
              </div>

              {workOrders.length === 0 ? (
                <p className="text-xs text-neutral-400">
                  No work orders yet for this customer.
                </p>
              ) : (
                <div className="space-y-2">
                  {workOrders.map((wo) => (
                    <button
                      key={wo.id}
                      type="button"
                      onClick={() => router.push(`/mobile/work-orders/${wo.id}`)}
                      className="w-full rounded-md border border-neutral-800 bg-neutral-950 px-3 py-2 text-left text-xs text-neutral-200 hover:border-orange-500/80"
                    >
                      <div className="flex items-center justify-between gap-2">
                        <div className="min-w-0">
                          <div className="font-medium text-neutral-50 truncate">
                            {wo.custom_id
                              ? `WO ${wo.custom_id}`
                              : `WO #${wo.id.slice(0, 8)}`}
                          </div>
                          <div className="text-[0.7rem] text-neutral-400">
                            {wo.created_at
                              ? format(new Date(wo.created_at), "PP p")
                              : "‚Äî"}
                          </div>
                        </div>
                        <span className={statusChipClass(wo.status ?? null)}>
                          {(wo.status ?? "awaiting").replaceAll("_", " ")}
                        </span>
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </section>
          </>
        )}
      </div>
    </MobileShell>
  );
}

========================================
FILE: app/mobile/inspections/[id]/page.tsx
========================================
// app/mobile/inspections/[id]/page.tsx
"use client";

import { useEffect, useState, useMemo } from "react";
import { useParams, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import toast from "react-hot-toast";

import GenericInspectionScreen from "@/features/inspections/screens/GenericInspectionScreen";

/* ------------------------------------------------------------------ */
/* Types                                                              */
/* ------------------------------------------------------------------ */

type SectionItem = { item: string; unit?: string | null };
type Section = { title: string; items: SectionItem[] };

/* ------------------------------------------------------------------ */
/* Regex helpers to detect existing ‚Äúcorner grid‚Äù sections             */
/* (copied from /features/inspections/app/inspection/run/page.tsx)    */
/* ------------------------------------------------------------------ */

// LF/RF/LR/RR ...
const HYD_ITEM_RE = /^(LF|RF|LR|RR)\s+/i;

// Steer/Drive/Tag/Trailer <N> Left|Right ...
const AIR_ITEM_RE =
  /^(Steer\s*\d*|Drive\s*\d+|Tag|Trailer\s*\d+)\s+(Left|Right)\s+/i;

function looksLikeCornerTitle(title: string | undefined | null): boolean {
  if (!title) return false;
  const t = title.toLowerCase();
  return (
    t.includes("corner grid") ||
    t.includes("tires & brakes") ||
    t.includes("tires and brakes") ||
    t.includes("air brake") ||
    t.includes("hydraulic brake")
  );
}

function stripExistingCornerGrids(sections: Section[]): Section[] {
  return sections.filter((s) => {
    if (looksLikeCornerTitle(s.title)) return false;

    const items = s.items ?? [];
    const looksHyd = items.some((it) => HYD_ITEM_RE.test(it.item || ""));
    const looksAir = items.some((it) => AIR_ITEM_RE.test(it.item || ""));
    return !(looksHyd || looksAir);
  });
}

/* ------------------------------------------------------------------ */
/* Canonical corner grid builders (labels match AxlesCornerGrid)      */
/* ------------------------------------------------------------------ */

function buildHydraulicCornerSection(): Section {
  const metrics: Array<{ label: string; unit: string | null }> = [
    { label: "Tire Pressure", unit: "psi" },
    { label: "Tire Tread", unit: "mm" },
    { label: "Brake Pad", unit: "mm" },
    { label: "Rotor", unit: "mm" },
    { label: "Rotor Condition", unit: null },
    { label: "Rotor Thickness", unit: "mm" },
    { label: "Wheel Torque", unit: "ft¬∑lb" },
  ];
  const corners = ["LF", "RF", "LR", "RR"];
  const items: SectionItem[] = [];
  for (const c of corners) {
    for (const m of metrics) {
      items.push({ item: `${c} ${m.label}`, unit: m.unit });
    }
  }
  return { title: "Corner Grid (Hydraulic)", items };
}

/** Default air corner grid: Steer 1 + Drive 1 (explicit Inner/Outer where needed) */
function buildAirCornerSection(): Section {
  const steer: SectionItem[] = [
    { item: "Steer 1 Left Tire Pressure", unit: "psi" },
    { item: "Steer 1 Right Tire Pressure", unit: "psi" },
    { item: "Steer 1 Left Tread Depth", unit: "mm" },
    { item: "Steer 1 Right Tread Depth", unit: "mm" },
    { item: "Steer 1 Left Lining/Shoe", unit: "mm" },
    { item: "Steer 1 Right Lining/Shoe", unit: "mm" },
    { item: "Steer 1 Left Drum/Rotor", unit: "mm" },
    { item: "Steer 1 Right Drum/Rotor", unit: "mm" },
    { item: "Steer 1 Left Push Rod Travel", unit: "in" },
    { item: "Steer 1 Right Push Rod Travel", unit: "in" },
  ];

  const drive: SectionItem[] = [
    { item: "Drive 1 Left Tire Pressure", unit: "psi" },
    { item: "Drive 1 Right Tire Pressure", unit: "psi" },
    { item: "Drive 1 Left Tread Depth (Outer)", unit: "mm" },
    { item: "Drive 1 Left Tread Depth (Inner)", unit: "mm" },
    { item: "Drive 1 Right Tread Depth (Outer)", unit: "mm" },
    { item: "Drive 1 Right Tread Depth (Inner)", unit: "mm" },
    { item: "Drive 1 Left Lining/Shoe", unit: "mm" },
    { item: "Drive 1 Right Lining/Shoe", unit: "mm" },
    { item: "Drive 1 Left Drum/Rotor", unit: "mm" },
    { item: "Drive 1 Right Drum/Rotor", unit: "mm" },
    { item: "Drive 1 Left Push Rod Travel", unit: "in" },
    { item: "Drive 1 Right Push Rod Travel", unit: "in" },
  ];

  return { title: "Corner Grid (Air)", items: [...steer, ...drive] };
}

/* ------------------------------------------------------------------ */
/* Deterministic grid selection (same rules as /inspection/run)       */
/* ------------------------------------------------------------------ */

function prepareSectionsWithCornerGrid(
  sections: Section[],
  vehicleType: string | null | undefined,
  gridParam: string | null,
): Section[] {
  const s = Array.isArray(sections) ? sections : [];

  // 1) If there is already a corner-style title, trust the template
  const hasCornerByTitle = s.some((sec) => looksLikeCornerTitle(sec.title));
  if (hasCornerByTitle) return s;

  // 2) Otherwise, strip out any corner-looking item patterns
  const withoutGrids = stripExistingCornerGrids(s);
  const gridMode = (gridParam || "").toLowerCase(); // air | hyd | none | ""

  if (gridMode === "none") return withoutGrids;

  // 3) Decide air vs hyd
  let injectAir: boolean;
  if (gridMode === "air" || gridMode === "hyd") {
    // URL override wins on mobile too
    injectAir = gridMode === "air";
  } else {
    const vt = (vehicleType || "").toLowerCase();

    // Anything clearly heavy / commercial => air brakes
    const isAirByVehicle =
      vt.includes("truck") ||
      vt.includes("bus") ||
      vt.includes("coach") ||
      vt.includes("trailer") ||
      vt.includes("heavy") || // matches your custom builder "heavy"
      vt.includes("medium-heavy") ||
      vt.includes("air");

    injectAir = isAirByVehicle;
  }

  const injected = injectAir
    ? buildAirCornerSection()
    : buildHydraulicCornerSection();

  return [injected, ...withoutGrids];
}

/* ------------------------------------------------------------------ */
/* Mobile runner page                                                 */
/* ------------------------------------------------------------------ */

export default function MobileInspectionRunnerPage() {
  const params = useParams<{ id: string }>();
  const search = useSearchParams();
  const supabase = useMemo(
    () => createClientComponentClient<Database>(),
    [],
  );

  const lineId = params?.id ? String(params.id) : null;
  const workOrderId = search.get("workOrderId");
  const templateId = search.get("templateId");
  const gridOverride = search.get("grid"); // 'air' | 'hyd' | 'none' | null

  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!lineId || !templateId) {
      setError("Missing inspection line or template.");
      setLoading(false);
      return;
    }

    (async () => {
      try {
        const { data, error } = await supabase
          .from("inspection_templates")
          .select("template_name, sections, vehicle_type")
          .eq("id", templateId)
          .maybeSingle();

        if (error || !data) {
          console.error(error);
          setError("Template not found.");
          toast.error("Template not found.");
          return;
        }

        const rawSections = (data.sections ?? []) as Section[];
        const title = data.template_name ?? "Inspection";
        const vehicleType = String(data.vehicle_type ?? "");

        const sections = prepareSectionsWithCornerGrid(
          rawSections,
          vehicleType,
          gridOverride,
        );

        // Build params object the runtime expects
        const paramsObj: Record<string, string> = {};
        search.forEach((v, k) => {
          paramsObj[k] = v;
        });

        paramsObj.workOrderLineId = lineId;
        if (workOrderId) paramsObj.workOrderId = workOrderId;
        if (templateId) paramsObj.templateId = templateId;
        paramsObj.view = "mobile"; // turn on mobile voice controls

        if (typeof window !== "undefined") {
          sessionStorage.setItem(
            "inspection:sections",
            JSON.stringify(sections),
          );
          sessionStorage.setItem("inspection:title", title);
          sessionStorage.setItem("inspection:vehicleType", vehicleType);
          sessionStorage.setItem("inspection:template", "generic");
          sessionStorage.setItem(
            "inspection:params",
            JSON.stringify(paramsObj),
          );

          // legacy/custom keys so older flows still work
          sessionStorage.setItem(
            "customInspection:sections",
            JSON.stringify(sections),
          );
          sessionStorage.setItem("customInspection:title", title);
          sessionStorage.setItem(
            "customInspection:includeOil",
            JSON.stringify(false),
          );
        }
      } catch (e) {
        console.error(e);
        setError("Failed to prepare inspection.");
        toast.error("Failed to prepare inspection.");
      } finally {
        setLoading(false);
      }
    })();
  }, [lineId, templateId, workOrderId, gridOverride, search, supabase]);

  if (!lineId) {
    return (
      <main className="flex min-h-[calc(100vh-3rem)] items-center justify-center px-3 py-4 text-sm text-red-300">
        Missing inspection id.
      </main>
    );
  }

  if (loading) {
    return (
      <main className="flex min-h-[calc(100vh-3rem)] items-center justify-center px-3 py-4 text-sm text-neutral-300">
        Preparing inspection‚Ä¶
      </main>
    );
  }

  if (error) {
    return (
      <main className="flex min-h-[calc(100vh-3rem)] items-center justify-center px-3 py-4 text-sm text-red-300">
        {error}
      </main>
    );
  }

  // At this point sessionStorage is ready; GenericInspectionScreen
  // will read sections + params and render the full template
  return (
    <main className="mx-auto flex min-h-[calc(100vh-3rem)] max-w-4xl flex-col bg-transparent px-3 py-4 text-white">
      <GenericInspectionScreen />
    </main>
  );
}

========================================
FILE: app/mobile/inspections/[id]/run/page.tsx
========================================
// app/mobile/inspections/[id]/run/page.tsx
"use client";

import { useMemo } from "react";
import { useParams } from "next/navigation";
import type { JSX } from "react";

function MobileInspectionRunnerFrame({
  lineId,
}: {
  lineId: string;
}): JSX.Element {
  const src = useMemo(() => {
    const sp = new URLSearchParams();
    sp.set("workOrderLineId", lineId);
    sp.set("view", "mobile");
    sp.set("embed", "1");
    return `/inspections/run?${sp.toString()}`;
  }, [lineId]);

  return (
    <div className="rounded-2xl border border-white/10 bg-black/40 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.85)] backdrop-blur-md">
      {/* Card header */}
      <div className="flex items-center justify-between gap-2 border-b border-white/10 pb-2">
        <div>
          <p className="text-xs font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Inspection runner
          </p>
          <p className="mt-0.5 text-[11px] text-neutral-400">
            Work-order line{" "}
            <span className="font-mono text-[10px] text-neutral-200">
              {lineId}
            </span>
          </p>
        </div>

        <span className="inline-flex items-center rounded-full border border-sky-400/80 bg-sky-500/15 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-sky-100 shadow-[0_0_16px_rgba(56,189,248,0.55)]">
          Corner grids
        </span>
      </div>

      {/* Runner frame */}
      <div className="mt-2 h-[calc(100vh-9rem)] overflow-hidden rounded-xl border border-white/8 bg-black/90">
        <iframe
          src={src}
          title="Mobile inspection runner"
          className="h-full w-full border-0"
        />
      </div>
    </div>
  );
}

export default function MobileInspectionRunnerRunPage(): JSX.Element {
  const params = useParams<{ id: string }>();
  const id = params?.id;

  if (!id) {
    return (
      <main className="flex min-h-[calc(100vh-3rem)] items-center justify-center px-3 py-4 text-sm text-red-300">
        Missing inspection id.
      </main>
    );
  }

  return (
    <main className="mx-auto flex min-h-[calc(100vh-3rem)] max-w-4xl flex-col bg-transparent px-3 py-4 text-white">
      <div className="space-y-4">
        <MobileInspectionRunnerFrame lineId={String(id)} />
      </div>
    </main>
  );
}

========================================
FILE: app/mobile/inspections/maintenance-50-air/page.tsx
========================================
// app/mobile/inspections/maintenance-50-air/page.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";

export default function MobileMaintenance50AirRunnerPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const qs = searchParams.toString();
  const extra = qs ? `&${qs}` : "";

  // Desktop route, reused in mobile view + embed mode
  const src = `/inspections/maintenance-50-air?view=mobile&embed=1${extra}`;

  return (
    <div className="flex min-h-screen flex-col bg-neutral-950 text-foreground">
      <header className="flex items-center justify-between gap-2 border-b border-white/10 px-3 py-2">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs text-neutral-200 hover:bg-neutral-900"
        >
          ‚Üê Back
        </button>

        <div className="flex-1 px-2 text-center">
          <h1 className="truncate text-xs font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Maint. 50 (Air Brake)
          </h1>
        </div>

        <Link
          href={`/inspections/maintenance-50-air${qs ? `?${qs}` : ""}`}
          className="rounded-full border border-[color:var(--accent-copper-soft)] bg-[color:var(--accent-copper-soft)] px-3 py-1 text-[0.7rem] font-semibold text-black hover:bg-[color:var(--accent-copper-light)]"
        >
          Desktop
        </Link>
      </header>

      <main className="flex-1 overflow-hidden">
        <iframe
          src={src}
          title="Maintenance 50 Air Inspection"
          className="h-full w-full border-0 bg-black"
        />
      </main>
    </div>
  );
}

========================================
FILE: app/mobile/inspections/maintenance-50/page.tsx
========================================
// app/mobile/inspections/maintenance-50/page.tsx
"use client";

import { useRouter, useSearchParams } from "next/navigation";
import Link from "next/link";

export default function MobileMaintenance50RunnerPage() {
  const router = useRouter();
  const searchParams = useSearchParams();

  const qs = searchParams.toString();
  const extra = qs ? `&${qs}` : "";

  // Desktop route, reused in mobile view + embed mode
  const src = `/inspections/maintenance-50?view=mobile&embed=1${extra}`;

  return (
    <div className="flex min-h-screen flex-col bg-neutral-950 text-foreground">
      <header className="flex items-center justify-between gap-2 border-b border-white/10 px-3 py-2">
        <button
          type="button"
          onClick={() => router.back()}
          className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs text-neutral-200 hover:bg-neutral-900"
        >
          ‚Üê Back
        </button>

        <div className="flex-1 px-2 text-center">
          <h1 className="truncate text-xs font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Maint. 50 (Hydraulic)
          </h1>
        </div>

        <Link
          href={`/inspections/maintenance-50${qs ? `?${qs}` : ""}`}
          className="rounded-full border border-[color:var(--accent-copper-soft)] bg-[color:var(--accent-copper-soft)] px-3 py-1 text-[0.7rem] font-semibold text-black hover:bg-[color:var(--accent-copper-light)]"
        >
          Desktop
        </Link>
      </header>

      <main className="flex-1 overflow-hidden">
        <iframe
          src={src}
          title="Maintenance 50 Inspection"
          className="h-full w-full border-0 bg-black"
        />
      </main>
    </div>
  );
}

========================================
FILE: app/mobile/inspections/page.tsx
========================================
// app/mobile/inspections/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { format } from "date-fns";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

/** Only the columns we actually care about for mobile */
type InspectionRow = {
  id: string;
  custom_id: string | null;
  status: string | null;
  created_at: string | null;
  customer_name: string | null;
  vehicle_label: string | null;
};

const BADGE_BASE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.12em]";

const STATUS_CLASS: Record<string, string> = {
  open: "border-sky-500/70 bg-sky-500/10 text-sky-100",
  in_progress: "border-orange-500/70 bg-orange-500/10 text-orange-100",
  completed: "border-emerald-500/70 bg-emerald-500/10 text-emerald-100",
  archived: "border-neutral-500/70 bg-neutral-800/80 text-neutral-200",
};

function statusChip(status: string | null | undefined): string {
  const key = (status ?? "open").toLowerCase().replace(/\s+/g, "_");
  const extra = STATUS_CLASS[key] ?? STATUS_CLASS.open;
  return `${BADGE_BASE} ${extra}`;
}

export default function MobileInspectionsListPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [rows, setRows] = useState<InspectionRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);

      try {
        const { data, error } = await supabase
          .from("inspection_sessions")
          .select(
            "id, custom_id, status, created_at, customer_name, vehicle_label",
          )
          .order("created_at", { ascending: false })
          .limit(50);

        if (error) throw error;

        const mapped: InspectionRow[] = (data ?? []).map((r) => ({
          id: r.id,
          custom_id: r.custom_id ?? null,
          status: r.status ?? null,
          created_at: r.created_at ?? null,
          customer_name: r.customer_name ?? null,
          vehicle_label: r.vehicle_label ?? null,
        }));

        setRows(mapped);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load inspections.";
        setErr(msg);
        setRows([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [supabase]);

  return (
    <div className="min-h-screen space-y-4 bg-neutral-950 px-4 py-4 text-foreground">
      {/* Header */}
      <div className="flex items-center justify-between gap-2">
        <div>
          <h1 className="font-blackops text-lg uppercase tracking-[0.18em] text-neutral-200">
            Inspections
          </h1>
          <p className="mt-1 text-xs text-neutral-400">
            Quick mobile view of recent inspections for this shop.
          </p>
        </div>
        <Link
          href="/inspections"
          className="rounded-full border border-neutral-700 bg-neutral-900 px-3 py-1 text-[0.7rem] text-neutral-200 hover:border-orange-400 hover:bg-neutral-800"
        >
          Desktop view
        </Link>
      </div>

      {err && (
        <div className="rounded-md border border-red-500/60 bg-red-950/40 px-3 py-2 text-xs text-red-200">
          {err}
        </div>
      )}

      {loading ? (
        <div className="rounded-lg border border-white/10 bg-black/40 px-3 py-4 text-sm text-neutral-300">
          Loading inspections‚Ä¶
        </div>
      ) : rows.length === 0 ? (
        <div className="rounded-lg border border-dashed border-white/15 bg-black/40 px-3 py-6 text-sm text-neutral-400">
          No inspections found yet.
        </div>
      ) : (
        <div className="space-y-2">
          {rows.map((r) => {
            const href = `/mobile/inspections/${r.id}`;
            const created =
              r.created_at != null
                ? format(new Date(r.created_at), "PP p")
                : "‚Äî";

            return (
              <Link
                key={r.id}
                href={href}
                className="block rounded-xl border border-neutral-800 bg-neutral-950/80 px-3 py-3 text-sm text-neutral-100 shadow-sm shadow-black/30 hover:border-orange-500/70 hover:bg-neutral-900/80"
              >
                <div className="flex items-center justify-between gap-2">
                  <div className="min-w-0">
                    <div className="flex flex-wrap items-center gap-1.5">
                      <span className="font-semibold text-neutral-50">
                        {r.custom_id ?? `Inspect ${r.id.slice(0, 6)}`}
                      </span>

                      <span className={statusChip(r.status ?? "open")}>
                        {(r.status ?? "open").replaceAll("_", " ")}
                      </span>
                    </div>

                    <div className="mt-1 truncate text-[0.75rem] text-neutral-300">
                      {r.customer_name ?? "No customer"}{" "}
                      <span className="mx-1 text-neutral-600">‚Ä¢</span>
                      {r.vehicle_label ?? "No vehicle"}
                    </div>
                  </div>

                  <span className="ml-2 shrink-0 text-[0.7rem] text-neutral-400">
                    {created}
                  </span>
                </div>
              </Link>
            );
          })}
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/mobile/jobs/[lineId]/page.tsx
========================================
"use client";

import { useRouter, useParams } from "next/navigation";
import MobileFocusedJob from "@/features/work-orders/mobile/MobileFocusedJob";

export default function MobileJobPage() {
  const router = useRouter();
  const params = useParams<{ lineId: string }>();
  const lineId = params.lineId;

  return (
    <MobileFocusedJob
      workOrderLineId={lineId}
      onBack={() => {
        // Prefer going back, but if there's no history, go to WO list
        if (window.history.length > 1) router.back();
        else router.push("/mobile/work-orders");
      }}
    />
  );
}

========================================
FILE: app/mobile/layout.tsx
========================================
// app/mobile/layout.tsx
"use client";


import { MobileShell } from "components/layout/MobileShell";

export default function MobileLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <MobileShell>{children}</MobileShell>;
}

========================================
FILE: app/mobile/messages/[chatId]/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import ChatWindow from "@/features/ai/components/chat/ChatWindow";

type DB = Database;

type ConversationRow = DB["public"]["Tables"]["conversations"]["Row"];
type Participant = { id: string; full_name: string | null };

type ConversationPayload = {
  conversation: ConversationRow;
  latest_message: DB["public"]["Tables"]["messages"]["Row"] | null;
  participants: Participant[];
  unread_count: number;
};

export default function MobileChatThreadPage() {
  const params = useParams<{ chatId: string }>();
  const router = useRouter();
  const conversationId = params.chatId;

  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [userId, setUserId] = useState<string | null>(null);
  const [title, setTitle] = useState<string>("Conversation");

  // who am I + build a nice title
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      const uid = user?.id ?? null;
      setUserId(uid);

      try {
        const res = await fetch("/api/chat/my-conversations", {
          method: "GET",
          credentials: "include",
        });
        if (!res.ok) return;

        const data = (await res.json()) as ConversationPayload[];
        const found = data.find(
          (item) => item.conversation.id === conversationId,
        );
        if (!found) return;

        const others =
          uid == null
            ? found.participants
            : found.participants.filter((p) => p.id !== uid);

        const label =
          others[0]?.full_name ??
          found.conversation.context_type ??
          found.conversation.title ??
          `Conversation ${conversationId.slice(0, 6)}`;

        setTitle(label);
      } catch {
        // keep default title
      }
    })();
  }, [supabase, conversationId]);

  return (
    <div className="flex min-h-screen flex-col bg-background px-4 py-3 text-foreground">
      {/* Top bar */}
      <div className="metal-bar mb-3 flex items-center justify-between gap-2 border-b border-[var(--metal-border-soft)] pb-2">
        <button
          type="button"
          onClick={() => router.back()}
          className="inline-flex items-center rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-3 py-1 text-xs text-neutral-200 shadow-[0_4px_10px_rgba(0,0,0,0.7)] hover:bg-black/80"
        >
          ‚Üê Back
        </button>
        <div className="min-w-0 text-right">
          <h1 className="truncate text-sm font-blackops uppercase tracking-[0.18em] text-[var(--accent-copper-light)]">
            {title}
          </h1>
          <p className="mt-0.5 text-[0.65rem] text-neutral-500">Chat</p>
        </div>
      </div>

      {/* Chat window */}
      {!userId ? (
        <div className="metal-card mt-4 rounded-xl border border-[var(--metal-border-soft)] bg-black/40 p-4 text-sm text-neutral-300">
          Loading‚Ä¶
        </div>
      ) : (
        <div className="metal-panel metal-panel--card flex min-h-0 flex-1 flex-col rounded-2xl border border-[var(--metal-border-soft)] bg-black/40 px-2 py-2">
          <ChatWindow
            conversationId={conversationId}
            userId={userId}
            title={title}
          />
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/mobile/messages/new/page.tsx
========================================
// app/mobile/messages/new/page.tsx
"use client";

import MobileNewMessagePage from "@/features/mobile/messages/new/page.client";

export default function MobileNewMessageRoute() {
  return <MobileNewMessagePage />;
}

========================================
FILE: app/mobile/messages/page.tsx
========================================
// app/mobile/messages/page.client.tsx
"use client";

import { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { formatDistanceToNow } from "date-fns";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type ConversationRow = {
  conversation: DB["public"]["Tables"]["conversations"]["Row"];
  latest_message: DB["public"]["Tables"]["messages"]["Row"] | null;
  participants: Array<{ id: string; full_name: string | null }>;
  unread_count: number;
};

export default function MobileMessagesPage() {
  const router = useRouter();
  const [rows, setRows] = useState<ConversationRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);
      try {
        const res = await fetch("/api/chat/my-conversations", {
          method: "GET",
          credentials: "include",
        });

        if (!res.ok) {
          throw new Error(`Failed to load conversations (${res.status})`);
        }

        const data = (await res.json()) as ConversationRow[];
        setRows(data ?? []);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load conversations.";
        setErr(msg);
        setRows([]);
      } finally {
        setLoading(false);
      }
    })();
  }, []);

  return (
    <div className="min-h-screen bg-background px-4 py-4 text-foreground">
      <div className="mx-auto max-w-2xl space-y-4">

        {/* Header */}
        <div className="flex items-center justify-between gap-2">
          <h1 className="font-blackops text-lg uppercase tracking-[0.16em] text-neutral-200">
            Messages
          </h1>

          <button
            type="button"
            onClick={() => router.push("/mobile/messages/new")}
            className="
              rounded-full border border-[var(--accent-copper-soft)]
              bg-black/60 px-3 py-1 text-[0.7rem] font-semibold
              text-[var(--accent-copper-soft)]
              shadow-[0_10px_20px_rgba(0,0,0,0.65)]
              hover:bg-black/80 hover:border-[var(--accent-copper)]
            "
          >
            New chat
          </button>
        </div>

        {/* Error */}
        {err && (
          <div className="rounded-md border border-red-500/60 bg-red-950/40 px-3 py-2 text-xs text-red-200">
            {err}
          </div>
        )}

        {/* Loading */}
        {loading ? (
          <div className="metal-card rounded-xl border border-[var(--metal-border-soft)] px-3 py-4 text-sm text-neutral-300">
            Loading conversations‚Ä¶
          </div>
        ) : rows.length === 0 ? (
          // Empty state
          <div className="metal-card rounded-xl border border-dashed border-[var(--metal-border-soft)] px-3 py-6 text-sm text-neutral-400 text-center">
            No conversations yet.
            <br />
            Tap <span className="text-[var(--accent-copper-soft)]">New chat</span> to begin.
          </div>
        ) : (
          // List
          <div className="space-y-3">
            {rows.map((row) => {
              const { conversation, latest_message, participants, unread_count } = row;

              const href = `/mobile/messages/${conversation.id}`;
              const preview =
                latest_message?.content?.slice(0, 80) ?? "No messages yet.";

              const ts = latest_message?.created_at ?? conversation.created_at;
              const when = ts
                ? formatDistanceToNow(new Date(ts), { addSuffix: true })
                : "";

              const participantNames = participants
                .map((p) => p.full_name)
                .filter((name): name is string => Boolean(name));

              const title =
  conversation.title ??
  (participantNames.join(", ") ||
    `Conversation ${conversation.id.slice(0, 6)}`);

              return (
                <Link
                  key={conversation.id}
                  href={href}
                  className="
                    metal-card relative flex items-start gap-3 rounded-xl 
                    border border-[var(--metal-border-soft)]
                    bg-[var(--metal-surface)] px-3 py-3
                    hover:border-[var(--accent-copper-soft)]
                    hover:shadow-[0_0_18px_rgba(255,125,0,0.25)]
                    transition
                  "
                >
                  {/* Copper glow line */}
                  <div className="
                    absolute top-0 left-0 right-0 h-[2px]
                    bg-gradient-to-r from-[var(--accent-copper-soft)]/40
                    via-[var(--accent-copper)]/70
                    to-[var(--accent-copper-soft)]/40
                    rounded-t-xl
                  " />

                  {/* Avatar chip */}
                  <div className="
                    mt-1 flex h-8 w-8 shrink-0 items-center justify-center
                    rounded-full border border-[var(--accent-copper-soft)]
                    bg-black/50 text-[0.7rem] font-semibold text-[var(--accent-copper-soft)]
                    shadow-[0_0_8px_rgba(255,125,0,0.25)]
                  ">
                    {title.slice(0, 1).toUpperCase()}
                  </div>

                  {/* Body */}
                  <div className="min-w-0 flex-1 space-y-1">
                    <div className="flex items-center gap-2">
                      <span className="truncate font-semibold text-neutral-50">
                        {title}
                      </span>

                      {unread_count > 0 && (
                        <span
                          className="
                            inline-flex h-5 min-w-[20px] items-center justify-center
                            rounded-full bg-[var(--accent-copper-soft)]
                            px-1 text-[0.65rem] font-bold text-black
                          "
                        >
                          {unread_count}
                        </span>
                      )}
                    </div>

                    <p className="truncate text-[0.75rem] text-neutral-300">
                      {preview}
                    </p>
                  </div>

                  <span className="shrink-0 pt-1 text-[0.65rem] text-neutral-500">
                    {when}
                  </span>
                </Link>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/page.tsx
========================================
"use client";

import Link from "next/link";
import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

import {
  MobileTechHome,
  type MobileTechStats,
  type MobileTechJob,
} from "@/features/mobile/dashboard/MobileTechHome";
import MobileAdvisorHome from "@/features/mobile/dashboard/MobileAdvisorHome";
import MobileManagerHome from "@/features/mobile/dashboard/MobileManagerHome";
import MobileLeadHome from "@/features/mobile/dashboard/MobileLeadHandHome";
import type { MobileRole } from "@/features/mobile/config/mobile-tiles";

type DB = Database;

type Profile = DB["public"]["Tables"]["profiles"]["Row"];
type Shop = DB["public"]["Tables"]["shops"]["Row"];
type TechShift = DB["public"]["Tables"]["tech_shifts"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];

// helpers for date windows (local time)
function startOfDayLocal(d: Date): Date {
  const x = new Date(d);
  x.setHours(0, 0, 0, 0);
  return x;
}

function endOfDayLocal(d: Date): Date {
  const x = new Date(d);
  x.setHours(23, 59, 59, 999);
  return x;
}

// week starting Monday
function startOfWeekLocal(d: Date): Date {
  const x = startOfDayLocal(d);
  const day = x.getDay(); // 0 (Sun) .. 6 (Sat)
  const diffToMonday = (day + 6) % 7; // 0 if Mon, 1 if Tue, etc.
  x.setDate(x.getDate() - diffToMonday);
  return x;
}

function endOfWeekLocal(d: Date): Date {
  const start = startOfWeekLocal(d);
  const end = new Date(start);
  end.setDate(end.getDate() + 6);
  end.setHours(23, 59, 59, 999);
  return end;
}

function msToHours(ms: number): number {
  return ms <= 0 ? 0 : ms / (1000 * 60 * 60);
}

function round1(n: number): number {
  return Math.round(n * 10) / 10;
}

function calcEfficiencyPct(worked: number, billed: number): number | null {
  if (worked <= 0) return null;
  // billed / worked, like: 10h worked, 7.6h billed ‚Üí 76%
  return (billed / worked) * 100;
}

export default function MobileHome() {
  const supabase = createClientComponentClient<DB>();

  const [profile, setProfile] = useState<Profile | null>(null);
  const [shop, setShop] = useState<Shop | null>(null);
  const [loading, setLoading] = useState(true);

  const [stats, setStats] = useState<MobileTechStats | null>(null);
  const [jobs, setJobs] = useState<MobileTechJob[]>([]);
  const [statsLoading, setStatsLoading] = useState(false);

  // Load profile + shop
  useEffect(() => {
    (async () => {
      try {
        const { data: sessionData } = await supabase.auth.getUser();
        if (!sessionData?.user) {
          setLoading(false);
          return;
        }

        const uid = sessionData.user.id;

        const { data: profileRow } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", uid)
          .maybeSingle();

        setProfile(profileRow ?? null);

        if (profileRow?.shop_id) {
          const { data: shopRow } = await supabase
            .from("shops")
            .select("*")
            .eq("id", profileRow.shop_id)
            .maybeSingle();

          setShop(shopRow ?? null);
        }
      } finally {
        setLoading(false);
      }
    })();
  }, [supabase]);

  // Load mechanic stats + today's jobs (used by MobileTechHome)
  useEffect(() => {
    const loadStats = async () => {
      if (!profile?.id || profile.role !== "mechanic") return;

      setStatsLoading(true);
      try {
        const uid = profile.id;
        const now = new Date();

        const dayStart = startOfDayLocal(now);
        const dayEnd = endOfDayLocal(now);
        const weekStart = startOfWeekLocal(now);
        const weekEnd = endOfWeekLocal(now);

        const dayStartIso = dayStart.toISOString();
        const dayEndIso = dayEnd.toISOString();
        const weekStartIso = weekStart.toISOString();
        const weekEndIso = weekEnd.toISOString();

        // Exclude breaks/lunch by only counting tech_shifts.type = 'shift'
        const [
          { data: todayShifts },
          { data: weekShifts },
          { data: todayCompletedLines },
          { data: weekCompletedLines },
          { data: activeLines },
          { data: todayJobsRaw },
        ] = await Promise.all([
          supabase
            .from("tech_shifts")
            .select("start_time,end_time,type,user_id")
            .eq("user_id", uid)
            .eq("type", "shift")
            .gte("start_time", dayStartIso)
            .lte("start_time", dayEndIso),

          supabase
            .from("tech_shifts")
            .select("start_time,end_time,type,user_id")
            .eq("user_id", uid)
            .eq("type", "shift")
            .gte("start_time", weekStartIso)
            .lte("start_time", weekEndIso),

          // completed jobs today for billed hours + jobsCompletedToday
          supabase
            .from("work_order_lines")
            .select("id,labor_time,punched_out_at,status")
            .or(
              `assigned_tech_id.eq.${uid},assigned_to.eq.${uid},user_id.eq.${uid}`,
            )
            .eq("status", "completed")
            .gte("punched_out_at", dayStartIso)
            .lte("punched_out_at", dayEndIso),

          // completed this week for weekly billed hours
          supabase
            .from("work_order_lines")
            .select("id,labor_time,punched_out_at,status")
            .or(
              `assigned_tech_id.eq.${uid},assigned_to.eq.${uid},user_id.eq.${uid}`,
            )
            .eq("status", "completed")
            .gte("punched_out_at", weekStartIso)
            .lte("punched_out_at", weekEndIso),

          // active / open jobs assigned to this tech
          supabase
            .from("work_order_lines")
            .select("id,status,description,job_type")
            .or(
              `assigned_tech_id.eq.${uid},assigned_to.eq.${uid},user_id.eq.${uid}`,
            )
            .in("status", [
              "awaiting",
              "queued",
              "in_progress",
              "on_hold",
              "paused",
              "assigned",
            ]),

          // today's jobs list for the card (simple label)
          supabase
            .from("work_order_lines")
            .select("id,status,description,job_type,created_at,complaint")
            .or(
              `assigned_tech_id.eq.${uid},assigned_to.eq.${uid},user_id.eq.${uid}`,
            )
            .gte("created_at", dayStartIso)
            .lte("created_at", dayEndIso)
            .order("created_at", { ascending: false }),
        ]);

        const nowMs = now.getTime();

        const sumWorkedHours = (rows: TechShift[] | null | undefined) => {
          if (!rows) return 0;
          let total = 0;
          for (const r of rows) {
            if (!r.start_time) continue;
            const s = new Date(r.start_time).getTime();
            const e = r.end_time ? new Date(r.end_time).getTime() : nowMs;
            if (Number.isNaN(s) || Number.isNaN(e)) continue;
            total += Math.max(0, e - s);
          }
          return msToHours(total);
        };

        const sumBilledHours = (rows: WorkOrderLine[] | null | undefined) => {
          if (!rows) return 0;
          return rows.reduce((acc, line) => {
            const raw = line.labor_time;
            const n =
              typeof raw === "number"
                ? raw
                : raw != null
                ? Number(raw)
                : 0;
            if (!Number.isFinite(n)) return acc;
            return acc + n;
          }, 0);
        };

        const todayWorked = round1(sumWorkedHours(todayShifts as TechShift[]));
        const weekWorked = round1(sumWorkedHours(weekShifts as TechShift[]));

        const todayBilled = round1(
          sumBilledHours(todayCompletedLines as WorkOrderLine[]),
        );
        const weekBilled = round1(
          sumBilledHours(weekCompletedLines as WorkOrderLine[]),
        );

        const todayEff = calcEfficiencyPct(todayWorked, todayBilled);
        const weekEff = calcEfficiencyPct(weekWorked, weekBilled);

        const completedTodayCount = todayCompletedLines?.length ?? 0;

        const active = (activeLines as WorkOrderLine[] | null) ?? [];
        const openJobs = active.length;
        const assignedJobs =
          active.filter(
            (l) => (l.status ?? "").toLowerCase() === "assigned",
          ).length || openJobs;

        const jobsList: MobileTechJob[] =
          (todayJobsRaw as WorkOrderLine[] | null)?.slice(0, 6).map((l) => {
            const base =
              l.description ||
              l.complaint ||
              (l.job_type
                ? String(l.job_type).replace(/_/g, " ")
                : "Job");
            return {
              id: String(l.id),
              label: base,
              status: String(l.status ?? "in_progress"),
              href: `/mobile/work-orders?focus=${l.id}`,
            };
          }) ?? [];

        const nextStats: MobileTechStats = {
          openJobs,
          assignedJobs,
          jobsCompletedToday: completedTodayCount,
          today: {
            workedHours: todayWorked,
            billedHours: todayBilled,
            efficiencyPct: todayEff,
          },
          week: {
            workedHours: weekWorked,
            billedHours: weekBilled,
            efficiencyPct: weekEff,
          },
        };

        setStats(nextStats);
        setJobs(jobsList);
      } finally {
        setStatsLoading(false);
      }
    };

    void loadStats();
  }, [profile, supabase]);

  const role = (profile?.role ?? null) as MobileRole | null;
  const userName = profile?.full_name ?? null;
  const shopName = shop?.name ?? null;

  /* ------------------------------------------------------------------ */
  /* Role-specific mobile home pages                                    */
  /* ------------------------------------------------------------------ */

  if (!loading && profile && role === "mechanic") {
    // Tech dashboard (bench-side)
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-4 px-0 pb-8 pt-2">
          <MobileTechHome
            techName={profile.full_name || "Tech"}
            role="mechanic"
            stats={stats}
            jobs={jobs}
            loadingStats={statsLoading}
          />
        </div>
      </main>
    );
  }

  if (!loading && profile && role === "advisor") {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-4 px-0 pb-8 pt-2">
          <MobileAdvisorHome
            advisorName={profile.full_name || "Advisor"}
            role="advisor"
          />
        </div>
      </main>
    );
  }

  if (!loading && profile && (role === "manager" || role === "owner" || role === "admin")) {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-4 px-0 pb-8 pt-2">
          <MobileManagerHome
            managerName={profile.full_name || "Manager"}
            role={role}
          />
        </div>
      </main>
    );
  }

  // optional: if you‚Äôre using a separate "lead hand" MobileRole mapped from profiles
  if (!loading && profile && (role as string) === "lead_hand") {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-4 px-0 pb-8 pt-2">
          <MobileLeadHome
            leadName={profile.full_name || "Lead"}
            role={role as MobileRole}
          />
        </div>
      </main>
    );
  }

  /* ------------------------------------------------------------------ */
  /* Fallback companion home (parts, unknown roles, loading)            */
  /* ------------------------------------------------------------------ */

  return (
    <main className="min-h-screen bg-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-6">
        {/* Header */}
        <header className="space-y-1 text-center">
          <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
            ProFixIQ ‚Ä¢ Mobile
          </div>

          <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
            Shop Console
          </h1>

          {loading ? (
            <p className="text-[0.8rem] text-neutral-400">Loading‚Ä¶</p>
          ) : userName ? (
            <p className="text-[0.8rem] text-neutral-400">
              Hi{" "}
              <span className="font-medium text-neutral-100">
                {userName}
              </span>
              {shopName && (
                <span className="ml-1 text-neutral-300">
                  ({shopName})
                </span>
              )}
              .
            </p>
          ) : (
            <p className="text-[0.8rem] text-neutral-400">
              Stay on top of jobs from your phone.
            </p>
          )}
        </header>

        {/* App tiles */}
        <section className="grid grid-cols-2 gap-3">
          {/* Jobs / Work Orders */}
          <Link
            href="/mobile/work-orders"
            className="flex h-28 flex-col justify-between rounded-2xl border border-orange-500/70 bg-gradient-to-br from-orange-500/20 via-black/40 to-black/80 p-3 shadow-lg shadow-orange-500/30"
          >
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-orange-200/80">
              Jobs
            </div>
            <div>
              <div className="text-sm font-semibold text-white">
                Work Orders
              </div>
              <div className="mt-1 text-[0.75rem] text-orange-100/90">
                View &amp; update live jobs.
              </div>
            </div>
          </Link>

          {/* New work order */}
          <Link
            href="/mobile/work-orders/create"
            className="flex h-28 flex-col justify-between rounded-2xl border border-neutral-700 bg-gradient-to-br from-neutral-900 via-black to-black p-3"
          >
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Quick
            </div>
            <div>
              <div className="text-sm font-semibold text-white">
                New Work Order
              </div>
              <div className="mt-1 text-[0.75rem] text-neutral-400">
                Capture customer &amp; vehicle.
              </div>
            </div>
          </Link>

          {/* Inspections */}
          <Link
            href="/mobile/inspections"
            className="flex h-28 flex-col justify-between rounded-2xl border border-neutral-700 bg-gradient-to-br from-neutral-900 via-black to-black p-3"
          >
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Inspections
            </div>
            <div>
              <div className="text-sm font-semibold text-white">
                Inspection Queue
              </div>
              <div className="mt-1 text-[0.75rem] text-neutral-400">
                Start &amp; review inspection forms.
              </div>
            </div>
          </Link>

          {/* AI & Messages */}
          <Link
            href="/mobile/messages"
            className="flex h-28 flex-col justify-between rounded-2xl border border-neutral-700 bg-gradient-to-br from-neutral-900 via-black to-black p-3"
          >
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              AI
            </div>
            <div>
              <div className="text-sm font-semibold text-white">
                AI &amp; Messages
              </div>
              <div className="mt-1 text-[0.75rem] text-neutral-400">
                Chat with AI and your team.
              </div>
            </div>
          </Link>

          {/* Planner */}
          <Link
            href="/mobile/planner"
            className="col-span-2 flex h-28 flex-col justify-between rounded-2xl border border-neutral-700 bg-gradient-to-br from-neutral-900 via-black to-black p-3"
          >
            <div className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Planner
            </div>
            <div>
              <div className="text-sm font-semibold text-white">
                Tech &amp; Job Planner
              </div>
              <div className="mt-1 text-[0.75rem] text-neutral-400">
                See what‚Äôs coming up and who‚Äôs on it.
              </div>
            </div>
          </Link>
        </section>

        <footer className="mt-2 text-center text-[0.65rem] text-neutral-500">
          Mobile companion ‚Ä¢ Use the desktop app for admin &amp; setup.
        </footer>
      </div>
    </main>
  );
}

========================================
FILE: app/mobile/planner/page.tsx
========================================
"use client";

import Link from "next/link";
import { useRouter } from "next/navigation";
import { MobileShell } from "components/layout/MobileShell";

export default function MobilePlannerPage() {
  const router = useRouter();

  // Re-use the existing desktop AI planner route.
  // Note: this *targets* /agent/planner internally, but the mobile route is /mobile/planner
  const src = "/agent/planner?view=mobile";

  return (
    <MobileShell>
      <div className="flex h-full flex-col bg-neutral-950 text-foreground">
        {/* Top bar */}
        <header className="flex items-center justify-between gap-2 border-b border-white/10 px-3 py-2">
          <button
            type="button"
            onClick={() => router.back()}
            className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs text-neutral-200 hover:bg-neutral-900"
          >
            ‚Üê Back
          </button>

          <div className="flex-1 px-2 text-center">
            <h1 className="truncate text-xs font-blackops uppercase tracking-[0.18em] text-neutral-200">
              AI Planner
            </h1>
          </div>

          <Link
            href="/agent/planner"
            className="rounded-full border border-orange-500/70 bg-orange-500 px-3 py-1 text-[0.7rem] font-semibold text-black hover:bg-orange-400"
          >
            Desktop
          </Link>
        </header>

        {/* Planner iframe */}
        <main className="flex-1 overflow-hidden">
          <iframe
            src={src}
            title="AI Planner"
            className="h-full w-full border-0 bg-black"
          />
        </main>
      </div>
    </MobileShell>
  );
}

========================================
FILE: app/mobile/reports/page.tsx
========================================
// app/mobile/reports/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import {
  getShopStats,
  type TimeRange,
} from "@shared/lib/stats/getShopStats";
import { Button } from "@shared/components/ui/Button";

type DB = Database;
type Range = TimeRange;

type StatsTotals = {
  revenue: number;
  profit: number;
  labor: number;
  expenses: number;
  jobs: number;
  techEfficiency: number;
};

type PeriodStats = {
  label: string;
  revenue: number;
  profit: number;
  labor: number;
  expenses: number;
  jobs: number;
};

type ShopStats = {
  shop_id: string;
  start: string;
  end: string;
  range: Range;
  total: StatsTotals;
  periods: PeriodStats[];
};

const RANGE_LABELS: Record<Range, string> = {
  weekly: "This week",
  monthly: "This month",
  quarterly: "This quarter",
  yearly: "This year",
};

type ProfileRole = DB["public"]["Tables"]["profiles"]["Row"]["role"];
const OWNER_ROLES: ProfileRole[] = ["owner", "admin", "manager"];

export default function MobileReportsPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<string | null>(null);
  const [role, setRole] = useState<ProfileRole | null>(null);
  const [range, setRange] = useState<Range>("monthly");

  const [stats, setStats] = useState<ShopStats | null>(null);
  const [aiSummary, setAiSummary] = useState<string | null>(null);

  const [loading, setLoading] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  /* ---------------------------------------------------------------------- */
  /* Load profile + shop for current user                                   */
  /* ---------------------------------------------------------------------- */

  useEffect(() => {
    (async () => {
      try {
        const {
          data: { user },
          error: userErr,
        } = await supabase.auth.getUser();

        if (userErr || !user) {
          setError("You must be signed in to view mobile reports.");
          return;
        }

        const { data: profile, error: profErr } = await supabase
          .from("profiles")
          .select("shop_id, role")
          .eq("id", user.id)
          .maybeSingle();

        if (profErr) {
          setError(profErr.message);
          return;
        }

        if (!profile?.shop_id) {
          setError("No shop linked to your profile yet.");
          return;
        }

        setShopId(profile.shop_id);
        setRole(profile.role ?? null);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load profile.";
        setError(msg);
      }
    })();
  }, [supabase]);

  /* ---------------------------------------------------------------------- */
  /* Load stats whenever shop or range changes                              */
  /* ---------------------------------------------------------------------- */

  useEffect(() => {
    if (!shopId) return;

    (async () => {
      setLoading(true);
      setError(null);
      setAiSummary(null);

      try {
        const fetched = (await getShopStats(
          shopId,
          range,
        )) as ShopStats;

        setStats(fetched);

        // Fire AI summary in the background (mobile-friendly)
        try {
          setAiLoading(true);
          const res = await fetch("/api/ai/summarize-stats", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stats: fetched, timeRange: range }),
          });

          if (!res.ok) {
            throw new Error(`AI summary failed (${res.status})`);
          }

          const json = (await res.json()) as { summary?: string };
          if (json?.summary) setAiSummary(json.summary);
        } catch (e) {
          // eslint-disable-next-line no-console
          console.error(e);
          toast.error("AI summary could not be generated.");
        } finally {
          setAiLoading(false);
        }
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load shop stats.";
        setError(msg);
        setStats(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [shopId, range]);

  const hasAccess = !!role && OWNER_ROLES.includes(role);
  const hasData = !!stats;

  const dateRangeLabel =
    stats?.start && stats?.end
      ? `${new Date(stats.start).toLocaleDateString()} ‚Äì ${new Date(
          stats.end,
        ).toLocaleDateString()}`
      : RANGE_LABELS[range];

  /* ---------------------------------------------------------------------- */
  /* Role gate: only owners/admins/managers                                 */
  /* ---------------------------------------------------------------------- */

  if (!hasAccess && role) {
    return (
      <main className="min-h-screen bg-gradient-to-b from-black via-slate-950 to-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-3 px-4 pb-8 pt-6">
          <header className="space-y-1">
            <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
              ProFixIQ ‚Ä¢ Mobile
            </div>
            <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
              Reports
            </h1>
          </header>
          <p className="text-sm text-neutral-400">
            Mobile reports are available for owners, admins, and managers.
          </p>
        </div>
      </main>
    );
  }

  /* ---------------------------------------------------------------------- */
  /* Main mobile reports UI                                                 */
  /* ---------------------------------------------------------------------- */

  return (
    <main className="min-h-screen bg-gradient-to-b from-black via-slate-950 to-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-6">
        {/* Header */}
        <header className="space-y-1">
          <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
            ProFixIQ ‚Ä¢ Mobile
          </div>
          <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
            Shop Reports
          </h1>
          <p className="text-[0.8rem] text-neutral-400">
            Quick performance view in your pocket.
          </p>
        </header>

        {/* Time range selector */}
        <section className="space-y-2 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-3 shadow-[0_18px_40px_rgba(0,0,0,0.85)]">
          <div className="flex items-center justify-between gap-2">
            <span className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Time range
            </span>
            <span className="text-[0.7rem] text-neutral-300">
              {dateRangeLabel}
            </span>
          </div>
          <div className="mt-1 flex flex-wrap gap-1.5">
            {(["weekly", "monthly", "quarterly", "yearly"] as Range[]).map(
              (r) => {
                const active = range === r;
                return (
                  <Button
                    key={r}
                    type="button"
                    size="xs"
                    variant={active ? "default" : "outline"}
                    className={
                      active
                        ? "border-orange-500 bg-orange-500 text-black text-[0.7rem] px-3 py-1"
                        : "border-white/15 bg-transparent text-[0.7rem] px-3 py-1"
                    }
                    onClick={() => setRange(r)}
                  >
                    {r.charAt(0).toUpperCase() + r.slice(1)}
                  </Button>
                );
              },
            )}
          </div>
        </section>

        {/* Error / loading states */}
        {error && (
          <div className="rounded-2xl border border-red-500/40 bg-red-900/30 px-3 py-3 text-[0.8rem] text-red-100">
            {error}
          </div>
        )}

        {loading && (
          <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            Loading stats‚Ä¶
          </div>
        )}

        {/* Stats cards */}
        {!loading && !error && hasData && stats && (
          <>
            <section className="grid grid-cols-2 gap-3">
              <SummaryCard
                label="Revenue"
                value={`$${stats.total.revenue.toFixed(0)}`}
                accent="text-emerald-300"
              />
              <SummaryCard
                label="Profit"
                value={`$${stats.total.profit.toFixed(0)}`}
                accent="text-amber-300"
              />
              <SummaryCard
                label="Labor cost"
                value={`$${stats.total.labor.toFixed(0)}`}
                accent="text-red-300"
              />
              <SummaryCard
                label="Expenses"
                value={`$${stats.total.expenses.toFixed(0)}`}
                accent="text-fuchsia-300"
              />
              <SummaryCard
                label="Jobs"
                value={String(stats.total.jobs)}
                accent="text-sky-300"
              />
              <SummaryCard
                label="Tech efficiency"
                value={`${stats.total.techEfficiency.toFixed(1)}%`}
                accent="text-cyan-300"
              />
            </section>

            {/* AI summary */}
            <section className="space-y-1 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-3 text-xs text-neutral-200 shadow-[0_18px_40px_rgba(0,0,0,0.75)]">
              <div className="flex items-center justify-between gap-2">
                <span className="text-[0.65rem] uppercase tracking-[0.18em] text-orange-300">
                  AI summary
                </span>
                {aiLoading && (
                  <span className="text-[0.65rem] text-neutral-400">
                    Analyzing‚Ä¶
                  </span>
                )}
              </div>
              {aiSummary ? (
                <p className="whitespace-pre-wrap">{aiSummary}</p>
              ) : !aiLoading ? (
                <p className="text-[0.7rem] text-neutral-400">
                  No AI summary yet for this range.
                </p>
              ) : null}
            </section>
          </>
        )}

        {!loading && !error && !hasData && (
          <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            No stats found for this range. Try a different time range.
          </div>
        )}
      </div>
    </main>
  );
}

/* ---------------------------------------------------------------------------
 * Simple mobile summary card
 * ------------------------------------------------------------------------ */

function SummaryCard({
  label,
  value,
  accent,
}: {
  label: string;
  value: string;
  accent?: string;
}) {
  return (
    <div className="rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-white/[0.03] px-3 py-3 shadow-[0_16px_32px_rgba(0,0,0,0.75)]">
      <div className="text-[0.6rem] uppercase tracking-[0.18em] text-neutral-400">
        {label}
      </div>
      <div className={`mt-1 text-lg font-semibold ${accent ?? ""}`}>
        {value}
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/settings/page.tsx
========================================
// app/mobile/settings/page.tsx
"use client";

import MobileSettingsScreen from "@/features/mobile/settings/MobileSettingsScreen";

export default function MobileSettingsRoute() {
  return <MobileSettingsScreen />;
}

========================================
FILE: app/mobile/sign-in/page.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

// same synthetic-username domain as portal sign-in
const SHOP_USER_DOMAIN = "local.profix-internal";

export default function MobileSignInPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<DB>();

  const [identifier, setIdentifier] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState<string>("");
  const [loading, setLoading] = useState(false);

  // If already signed in, gate by onboarding before letting them into mobile
  useEffect(() => {
    (async () => {
      const { data } = await supabase.auth.getSession();
      const session = data.session;
      if (!session?.user) return;

      const { data: profile } = await supabase
        .from("profiles")
        .select("completed_onboarding, shop_id")
        .eq("id", session.user.id)
        .maybeSingle();

      const hasShop = !!profile?.shop_id;
      const isOnboarded = !!profile?.completed_onboarding || hasShop;

      if (!isOnboarded) {
        router.replace("/onboarding");
        return;
      }

      router.replace("/mobile/dashboard");
    })();
  }, [router, supabase]);

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    const raw = identifier.trim();
    let emailToUse = raw;

    // username ‚Üí synthetic email (same behavior as main sign-in)
    if (!raw.includes("@")) {
      emailToUse = `${raw.toLowerCase()}@${SHOP_USER_DOMAIN}`;
    }

    const { error: signInErr } = await supabase.auth.signInWithPassword({
      email: emailToUse,
      password,
    });

    if (signInErr) {
      setError(signInErr.message || "Sign in failed.");
      setLoading(false);
      return;
    }

    await supabase.auth.refreshSession();

    const { data: u } = await supabase.auth.getUser();
    if (!u.user) {
      setError("Signed in, but no session is visible yet. Try again.");
      setLoading(false);
      return;
    }

    const { data: profile } = await supabase
      .from("profiles")
      .select("completed_onboarding, shop_id")
      .eq("id", u.user.id)
      .maybeSingle();

    const hasShop = !!profile?.shop_id;
    const isOnboarded = !!profile?.completed_onboarding || hasShop;

    if (!isOnboarded) {
      // must finish setup in the full portal first
      router.replace("/onboarding");
    } else {
      // ‚úÖ fully onboarded ‚Üí go straight to mobile companion
      router.replace("/mobile/dashboard");
    }

    setLoading(false);
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-black via-neutral-950 to-black px-4 text-white">
      <div className="mx-auto flex min-h-screen max-w-md flex-col items-center justify-center">
        <div className="w-full rounded-2xl border border-neutral-800 bg-neutral-950/90 p-6 shadow-xl shadow-black/40 sm:p-8">
          {/* Brand / title */}
          <div className="mb-6 space-y-2 text-center">
            <div className="inline-flex items-center rounded-full border border-neutral-800 bg-neutral-900 px-3 py-1 text-[11px] uppercase tracking-[0.2em] text-neutral-400">
              ProFixIQ Mobile Companion
            </div>
            <h1 className="mt-2 text-3xl font-blackops text-orange-500 sm:text-4xl">
              Sign in
            </h1>
            <p className="text-xs text-neutral-400 sm:text-sm">
              Use your shop username or email. Only onboarded users can use the
              mobile companion.
            </p>
          </div>

          {/* Error */}
          {error && (
            <div className="mb-3 rounded-lg border border-red-500/60 bg-red-950/60 px-3 py-2 text-xs text-red-100">
              {error}
            </div>
          )}

          {/* Form */}
          <form onSubmit={handleSignIn} className="space-y-4">
            <div className="space-y-1 text-sm">
              <label className="block text-xs font-medium text-neutral-300">
                Email or username
              </label>
              <input
                type="text"
                placeholder="jane@shop.com or shop username"
                autoComplete="username"
                value={identifier}
                onChange={(e) => setIdentifier(e.target.value)}
                className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none focus:ring-0"
                required
              />
              <p className="text-[11px] text-neutral-500">
                Shop accounts can sign in using the username provided by your
                admin.
              </p>
            </div>

            <div className="space-y-1 text-sm">
              <label className="block text-xs font-medium text-neutral-300">
                Password
              </label>
              <input
                type="password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                autoComplete="current-password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none focus:ring-0"
                required
                minLength={6}
              />
            </div>

            <button
              type="submit"
              className="mt-2 w-full rounded-md bg-orange-500 py-2.5 text-center text-sm font-blackops text-black tracking-wide transition hover:bg-orange-400 disabled:cursor-not-allowed disabled:opacity-60"
              disabled={loading}
            >
              {loading ? "Signing in‚Ä¶" : "Sign in"}
            </button>
          </form>

          {/* Link back to full portal sign-in */}
          <div className="mt-4 text-center text-[11px] text-neutral-500">
            Need the full desktop portal?{" "}
            <button
              type="button"
              onClick={() => router.push("/sign-in")}
              className="font-medium text-orange-400 hover:text-orange-300 hover:underline"
            >
              Open portal sign in
            </button>
          </div>

          <div className="mt-6 text-center text-[11px] text-neutral-500">
            <p>
              By continuing you agree to our{" "}
              <a
                href="/terms"
                className="font-medium text-orange-400 hover:text-orange-300 hover:underline"
              >
                Terms
              </a>{" "}
              and{" "}
              <a
                href="/privacy"
                className="font-medium text-orange-400 hover:text-orange-300 hover:underline"
              >
                Privacy Policy
              </a>
              .
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/technicians/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import type { ReactNode } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import type { TimeRange } from "@shared/lib/stats/getShopStats";
import {
  getTechLeaderboard,
  type TechLeaderboardRow,
} from "@shared/lib/stats/getTechLeaderboard";
import { formatCurrency } from "@shared/lib/formatters";
import { Button } from "@shared/components/ui/Button";

type DB = Database;
type Range = TimeRange;

const RANGE_LABELS: Record<Range, string> = {
  weekly: "This week",
  monthly: "This month",
  quarterly: "This quarter",
  yearly: "This year",
};

type ProfileRole = DB["public"]["Tables"]["profiles"]["Row"]["role"];
const OWNER_ROLES: ProfileRole[] = ["owner", "admin", "manager"];

export default function MobileTechniciansPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<string | null>(null);
  const [role, setRole] = useState<ProfileRole | null>(null);

  const [range, setRange] = useState<Range>("monthly");
  const [rows, setRows] = useState<TechLeaderboardRow[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [start, setStart] = useState<string | null>(null);
  const [end, setEnd] = useState<string | null>(null);

  // Load profile + shop for current user
  useEffect(() => {
    (async () => {
      try {
        const {
          data: { user },
          error: userErr,
        } = await supabase.auth.getUser();

        if (userErr || !user) {
          setError("You must be signed in to view technicians.");
          return;
        }

        const { data: profile, error: profErr } = await supabase
          .from("profiles")
          .select("shop_id, role")
          .eq("id", user.id)
          .maybeSingle();

        if (profErr) {
          setError(profErr.message);
          return;
        }

        if (!profile?.shop_id) {
          setError("No shop linked to your profile yet.");
          return;
        }

        setShopId(profile.shop_id);
        setRole(profile.role ?? null);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load profile.";
        setError(msg);
      }
    })();
  }, [supabase]);

  // Load leaderboard whenever shop / range change
  useEffect(() => {
    if (!shopId) return;

    (async () => {
      setLoading(true);
      setError(null);

      try {
        const result = await getTechLeaderboard(shopId, range);
        setRows(result.rows);
        setStart(result.start);
        setEnd(result.end);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load tech data.";
        setError(msg);
        setRows([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [shopId, range]);

  const hasAccess = !!role && OWNER_ROLES.includes(role);
  const hasData = rows.length > 0;

  const dateRangeLabel =
    start && end
      ? `${new Date(start).toLocaleDateString()} ‚Äì ${new Date(
          end,
        ).toLocaleDateString()}`
      : RANGE_LABELS[range];

  if (!hasAccess && role) {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto flex max-w-md flex-col gap-3 px-4 pb-8 pt-6">
          <h1 className="text-lg font-semibold">Technicians</h1>
          <p className="text-sm text-neutral-400">
            Mobile technician stats are available for owners, admins, and
            managers.
          </p>
        </div>
      </main>
    );
  }

  return (
    <main className="min-h-screen bg-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-6">
        {/* Header */}
        <header className="space-y-1">
          <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
            ProFixIQ ‚Ä¢ Mobile
          </div>
          <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
            Tech Leaderboard
          </h1>
          <p className="text-[0.8rem] text-neutral-400">
            Per-tech revenue, hours and efficiency in your pocket.
          </p>
        </header>

        {/* Range selector */}
        <section className="space-y-2 rounded-2xl border border-white/10 bg-black/40 px-3 py-3 shadow-card">
          <div className="flex items-center justify-between gap-2">
            <span className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Time range
            </span>
            <span className="text-[0.7rem] text-neutral-300">
              {dateRangeLabel}
            </span>
          </div>
          <div className="flex flex-wrap gap-1.5">
            {(["weekly", "monthly", "quarterly", "yearly"] as Range[]).map(
              (r) => {
                const active = range === r;
                return (
                  <Button
                    key={r}
                    type="button"
                    size="xs"
                    variant={active ? "default" : "outline"}
                    className={
                      active
                        ? "border-orange-500 bg-orange-500 text-black text-[0.7rem] px-3 py-1"
                        : "border-white/15 bg-transparent text-[0.7rem] px-3 py-1"
                    }
                    onClick={() => setRange(r)}
                  >
                    {r.charAt(0).toUpperCase() + r.slice(1)}
                  </Button>
                );
              },
            )}
          </div>
        </section>

        {/* Error / loading */}
        {error && (
          <div className="rounded-xl border border-red-500/40 bg-red-900/30 px-3 py-3 text-[0.8rem] text-red-100">
            {error}
          </div>
        )}

        {loading && (
          <div className="rounded-xl border border-white/10 bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            Loading technician stats‚Ä¶
          </div>
        )}

        {/* No data */}
        {!loading && !error && !hasData && (
          <div className="rounded-xl border border-white/10 bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            No technician data found for this range.
          </div>
        )}

        {/* Tech cards */}
        {!loading && !error && hasData && (
          <section className="space-y-3">
            {rows.map((row, index) => {
              const badge = efficiencyBadge(row.efficiencyPct);
              const billedVsClockedPct =
                row.clockedHours > 0
                  ? (row.billedHours / row.clockedHours) * 100
                  : 0;

              return (
                <article
                  key={row.techId}
                  className="rounded-2xl border border-white/10 bg-white/[0.03] px-3 py-3 shadow-card"
                >
                  <div className="flex items-center justify-between gap-2">
                    <div>
                      <div className="text-[0.6rem] uppercase tracking-[0.18em] text-neutral-500">
                        #{index + 1} Technician
                      </div>
                      <div className="text-sm font-semibold text-white">
                        {row.name}
                      </div>
                      {row.role && (
                        <div className="text-[0.7rem] text-neutral-400">
                          {row.role}
                        </div>
                      )}
                    </div>
                    {badge && (
                      <span
                        className={`inline-flex items-center rounded-full border px-2 py-0.5 text-[0.65rem] font-semibold ${badge.className}`}
                      >
                        <span className="mr-1">{badge.emoji}</span>
                        {badge.label}
                      </span>
                    )}
                  </div>

                  <div className="mt-3 grid grid-cols-2 gap-2 text-[0.75rem] text-neutral-200">
                    <TechStat label="Jobs" value={row.jobs} />
                    <TechStat
                      label="Revenue"
                      value={formatCurrency(row.revenue)}
                    />
                    <TechStat
                      label="Profit"
                      value={formatCurrency(row.profit)}
                    />
                    <TechStat
                      label="Labor cost"
                      value={formatCurrency(row.laborCost)}
                    />
                    <TechStat
                      label="Clocked hrs"
                      value={row.clockedHours.toFixed(1)}
                    />
                    <TechStat
                      label="Billed hrs"
                      value={row.billedHours.toFixed(1)}
                    />
                    <TechStat
                      label="Rev / hr"
                      value={formatCurrency(row.revenuePerHour)}
                    />
                    <TechStat
                      label="Efficiency"
                      value={`${row.efficiencyPct.toFixed(0)}%`}
                    />
                  </div>

                  {row.clockedHours > 0 && (
                    <div className="mt-2 text-[0.7rem] text-neutral-400">
                      Billed vs clocked:{" "}
                      <span className="font-semibold text-orange-300">
                        {billedVsClockedPct.toFixed(0)}%
                      </span>
                    </div>
                  )}
                </article>
              );
            })}
          </section>
        )}
      </div>
    </main>
  );
}

/* ------------------------------------------------------------------ */
/* Helpers                                                            */
/* ------------------------------------------------------------------ */

function efficiencyBadge(
  efficiencyPct: number,
):
  | {
      label: string;
      className: string;
      emoji: string;
    }
  | null {
  if (efficiencyPct >= 180) {
    return {
      label: "Gold",
      className: "bg-yellow-500/15 border-yellow-400 text-yellow-200",
      emoji: "ü•á",
    };
  }
  if (efficiencyPct >= 130) {
    return {
      label: "Silver",
      className: "bg-slate-200/10 border-slate-200 text-slate-100",
      emoji: "ü•à",
    };
  }
  if (efficiencyPct >= 90) {
    return {
      label: "Bronze",
      className: "bg-amber-800/30 border-amber-500 text-amber-200",
      emoji: "ü•â",
    };
  }
  return null;
}

function TechStat({
  label,
  value,
}: {
  label: string;
  value: ReactNode;
}) {
  return (
    <div>
      <div className="text-[0.6rem] uppercase tracking-[0.16em] text-neutral-500">
        {label}
      </div>
      <div className="mt-0.5 text-[0.8rem] font-semibold text-neutral-100">
        {value}
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/tech/performance/page.tsx
========================================
// app/mobile/tech/performance/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import type { TimeRange } from "@shared/lib/stats/getShopStats";
import {
  getTechLeaderboard,
  type TechLeaderboardRow,
} from "@shared/lib/stats/getTechLeaderboard";
import { formatCurrency } from "@shared/lib/formatters";
import { Button } from "@shared/components/ui/Button";

type DB = Database;
type Range = TimeRange;
type ProfileRole = DB["public"]["Tables"]["profiles"]["Row"]["role"];

const RANGE_LABELS: Record<Range, string> = {
  weekly: "This week",
  monthly: "This month",
  quarterly: "This quarter",
  yearly: "This year",
};

export default function MobileTechPerformancePage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [userId, setUserId] = useState<string | null>(null);
  const [shopId, setShopId] = useState<string | null>(null);
  const [, setRole] = useState<ProfileRole | null>(null);

  const [range, setRange] = useState<Range>("monthly");
  const [rows, setRows] = useState<TechLeaderboardRow[]>([]);
  const [myRow, setMyRow] = useState<TechLeaderboardRow | null>(null);

  const [start, setStart] = useState<string | null>(null);
  const [end, setEnd] = useState<string | null>(null);

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [aiSummary, setAiSummary] = useState<string | null>(null);
  const [aiLoading, setAiLoading] = useState(false);

  // Load profile (user, shop, role)
  useEffect(() => {
    (async () => {
      try {
        const {
          data: { user },
          error: userErr,
        } = await supabase.auth.getUser();

        if (userErr || !user) {
          setError("You must be signed in to view tech performance.");
          return;
        }

        setUserId(user.id);

        const { data: profile, error: profErr } = await supabase
          .from("profiles")
          .select("shop_id, role")
          .eq("id", user.id)
          .maybeSingle();

        if (profErr) {
          setError(profErr.message);
          return;
        }

        if (!profile?.shop_id) {
          setError("No shop linked to your profile yet.");
          return;
        }

        setShopId(profile.shop_id);
        setRole(profile.role ?? null);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load profile.";
        setError(msg);
      }
    })();
  }, [supabase]);

  // Load leaderboard data for this shop/range
  useEffect(() => {
    if (!shopId) return;

    (async () => {
      setLoading(true);
      setError(null);
      setAiSummary(null); // reset when changing range/shop

      try {
        const result = await getTechLeaderboard(shopId, range);
        setRows(result.rows);
        setStart(result.start);
        setEnd(result.end);

        if (userId) {
          const mine =
            result.rows.find((row) => row.techId === userId) ?? null;
          setMyRow(mine);
        } else {
          setMyRow(null);
        }
      } catch (e) {
        const msg =
          e instanceof Error
            ? e.message
            : "Failed to load tech performance.";
        setError(msg);
        setRows([]);
        setMyRow(null);
      } finally {
        setLoading(false);
      }
    })();
  }, [shopId, range, userId]);

  // Fire AI summary once we have myRow + rows
  useEffect(() => {
    if (!myRow) return;

    (async () => {
      setAiLoading(true);
      try {
        const res = await fetch("/api/ai/summarize-tech-performance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            timeRange: range,
            tech: {
              name: myRow.name,
              jobs: myRow.jobs,
              revenue: myRow.revenue,
              laborCost: myRow.laborCost,
              profit: myRow.profit,
              billedHours: myRow.billedHours,
              clockedHours: myRow.clockedHours,
              revenuePerHour: myRow.revenuePerHour,
              efficiencyPct: myRow.efficiencyPct,
            },
            peers: rows.map((r) => ({
              name: r.name,
              jobs: r.jobs,
              revenue: r.revenue,
              laborCost: r.laborCost,
              profit: r.profit,
              billedHours: r.billedHours,
              clockedHours: r.clockedHours,
              revenuePerHour: r.revenuePerHour,
              efficiencyPct: r.efficiencyPct,
            })),
          }),
        });

        if (!res.ok) {
          throw new Error(`AI summary failed (${res.status})`);
        }

        const json = (await res.json()) as { summary?: string };
        if (json.summary) {
          setAiSummary(json.summary);
        }
      } catch (e) {
        console.error(e);
        toast.error("AI performance summary could not be generated.");
      } finally {
        setAiLoading(false);
      }
    })();
  }, [myRow, rows, range]);

  const dateRangeLabel =
    start && end
      ? `${new Date(start).toLocaleDateString()} ‚Äì ${new Date(
          end,
        ).toLocaleDateString()}`
      : RANGE_LABELS[range];

  const hasData = rows.length > 0;

  return (
    <main className="min-h-screen bg-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-6">
        {/* Header */}
        <header className="space-y-1">
          <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
            ProFixIQ ‚Ä¢ Tech
          </div>
          <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
            My Performance
          </h1>
          <p className="text-[0.8rem] text-neutral-400">
            Jobs, hours and efficiency for your chosen time range.
          </p>
        </header>

        {/* Time range selector */}
        <section className="space-y-2 rounded-2xl border border-white/10 bg-black/40 px-3 py-3 shadow-card">
          <div className="flex items-center justify-between gap-2">
            <span className="text-[0.7rem] uppercase tracking-[0.18em] text-neutral-400">
              Time range
            </span>
            <span className="text-[0.7rem] text-neutral-300">
              {dateRangeLabel}
            </span>
          </div>
          <div className="flex flex-wrap gap-1.5">
            {(["weekly", "monthly", "quarterly", "yearly"] as Range[]).map(
              (r) => {
                const active = range === r;
                return (
                  <Button
                    key={r}
                    type="button"
                    size="xs"
                    variant={active ? "default" : "outline"}
                    className={
                      active
                        ? "border-orange-500 bg-orange-500 text-black text-[0.7rem] px-3 py-1"
                        : "border-white/15 bg-transparent text-[0.7rem] px-3 py-1"
                    }
                    onClick={() => setRange(r)}
                  >
                    {r.charAt(0).toUpperCase() + r.slice(1)}
                  </Button>
                );
              },
            )}
          </div>
        </section>

        {/* Error / loading */}
        {error && (
          <div className="rounded-xl border border-red-500/40 bg-red-900/30 px-3 py-3 text-[0.8rem] text-red-100">
            {error}
          </div>
        )}

        {loading && (
          <div className="rounded-xl border border-white/10 bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            Loading performance‚Ä¶
          </div>
        )}

        {/* No data */}
        {!loading && !error && !hasData && (
          <div className="rounded-xl border border-white/10 bg-black/40 px-3 py-4 text-[0.8rem] text-neutral-400">
            No technician data found for this range.
          </div>
        )}

        {/* My stats summary */}
        {!loading && !error && myRow && (
          <section className="space-y-3">
            <div className="grid grid-cols-2 gap-3">
              <SummaryCard
                label="Jobs"
                value={String(myRow.jobs)}
                accent="text-sky-300"
              />
              <SummaryCard
                label="Revenue"
                value={formatCurrency(myRow.revenue)}
                accent="text-emerald-300"
              />
              <SummaryCard
                label="Clocked hours"
                value={myRow.clockedHours.toFixed(1) + " h"}
              />
              <SummaryCard
                label="Billed hours"
                value={myRow.billedHours.toFixed(1) + " h"}
              />
              <SummaryCard
                label="Rev / hour"
                value={formatCurrency(myRow.revenuePerHour)}
              />
              <SummaryCard
                label="Efficiency"
                value={myRow.efficiencyPct.toFixed(1) + "%"}
                accent="text-cyan-300"
              />
            </div>
          </section>
        )}

        {/* AI summary */}
        {!loading && !error && (
          <section className="space-y-1 rounded-2xl border border-white/10 bg-black/40 px-3 py-3 text-xs text-neutral-200">
            <div className="flex items-center justify-between gap-2">
              <span className="text-[0.65rem] uppercase tracking-[0.18em] text-orange-300">
                AI summary
              </span>
              {aiLoading && (
                <span className="text-[0.65rem] text-neutral-400">
                  Analyzing‚Ä¶
                </span>
              )}
            </div>
            {aiSummary ? (
              <p className="whitespace-pre-wrap">{aiSummary}</p>
            ) : !aiLoading ? (
              <p className="text-[0.7rem] text-neutral-400">
                No AI summary yet for this range.
              </p>
            ) : null}
          </section>
        )}
      </div>
    </main>
  );
}

/* ------------------------------------------------------------------------ */
/* Small mobile summary card                                                */
/* ------------------------------------------------------------------------ */

function SummaryCard({
  label,
  value,
  accent,
}: {
  label: string;
  value: string;
  accent?: string;
}) {
  return (
    <div className="rounded-xl border border-white/10 bg-white/[0.03] px-3 py-3 shadow-card">
      <div className="text-[0.6rem] uppercase tracking-[0.18em] text-neutral-400">
        {label}
      </div>
      <div className={`mt-1 text-lg font-semibold ${accent ?? ""}`}>
        {value}
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/tech/queue/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Line = DB["public"]["Tables"]["work_order_lines"]["Row"];

type RollupStatus = "awaiting" | "in_progress" | "on_hold" | "completed";

const STATUS_LABELS: Record<RollupStatus, string> = {
  awaiting: "Awaiting",
  in_progress: "In progress",
  on_hold: "On hold",
  completed: "Completed",
};

// summary chip styles (unchanged)
const STATUS_STYLES: Record<RollupStatus, string> = {
  awaiting:
    "border-slate-700 bg-neutral-950/90 hover:border-orange-400 data-[active=true]:border-emerald-500 data-[active=true]:bg-emerald-500/15",
  in_progress:
    "border-amber-700 bg-neutral-950/90 hover:border-orange-400 data-[active=true]:border-emerald-500 data-[active=true]:bg-emerald-500/15",
  on_hold:
    "border-purple-700 bg-neutral-950/90 hover:border-orange-400 data-[active=true]:border-emerald-500 data-[active=true]:bg-emerald-500/15",
  completed:
    "border-emerald-700 bg-neutral-950/90 hover:border-orange-400 data-[active=true]:border-emerald-500 data-[active=true]:bg-emerald-500/15",
};

function toBucket(status: string | null | undefined): RollupStatus {
  const s = (status ?? "").toLowerCase();
  if (s === "in_progress") return "in_progress";
  if (s === "on_hold") return "on_hold";
  if (s === "completed") return "completed";
  return "awaiting";
}

// queue sort priority: in-progress first, then on-hold, awaiting, completed
const STATUS_RANK: Record<RollupStatus, number> = {
  in_progress: 0,
  on_hold: 1,
  awaiting: 2,
  completed: 3,
};

export default function MobileTechQueuePage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  const [lines, setLines] = useState<Line[]>([]);
  const [workOrderMap, setWorkOrderMap] = useState<
    Record<string, { id: string; custom_id: string | null }>
  >({});

  // line.id -> 1-based ‚Äúclient view‚Äù line number
  const [lineNumberMap, setLineNumberMap] = useState<Record<string, number>>(
    {},
  );

  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);
  const [activeFilter, setActiveFilter] = useState<RollupStatus | null>(null);

  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);

      // 1) auth
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();
      if (userErr || !user) {
        setErr("You must be signed in.");
        setLoading(false);
        return;
      }

      // 2) profile (shop linkage)
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .maybeSingle();

      if (profErr) {
        setErr(profErr.message);
        setLoading(false);
        return;
      }
      if (!prof?.shop_id) {
        setErr("No shop linked to your profile yet.");
        setLoading(false);
        return;
      }

      // 3) lines assigned to this tech
      const { data: techLines, error: linesErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("assigned_to", user.id);

      if (linesErr) {
        setErr(linesErr.message);
        setLoading(false);
        return;
      }

      const assignedLines = techLines ?? [];
      setLines(assignedLines);

      // 4) fetch WOs + all lines for those WOs, to compute ‚Äúclient‚Äù line numbers
      const woIds = Array.from(
        new Set(
          assignedLines
            .map((l) => l.work_order_id)
            .filter((id): id is string => Boolean(id)),
        ),
      );

      if (woIds.length > 0) {
        const [wosRes, allLinesRes] = await Promise.all([
          supabase
            .from("work_orders")
            .select("id, custom_id")
            .in("id", woIds),
          supabase
            .from("work_order_lines")
            .select(
              "id, work_order_id, created_at, job_type, approval_state",
            )
            .in("work_order_id", woIds),
        ]);

        const mapWO: Record<string, { id: string; custom_id: string | null }> =
          {};
        (wosRes.data ?? []).forEach((wo) => {
          mapWO[wo.id] = { id: wo.id, custom_id: wo.custom_id };
        });
        setWorkOrderMap(mapWO);

        // Build lineNumberMap using the SAME sort as MobileWorkOrderClient
        const lnMap: Record<string, number> = {};
        const allLines = allLinesRes.data ?? [];

        const grouped: Record<
          string,
          {
            id: string;
            work_order_id: string | null;
            created_at: string | null;
            job_type: string | null;
            approval_state: string | null;
          }[]
        > = {};

        allLines.forEach((ln) => {
          if (!ln.work_order_id) return;
          if ((ln.approval_state ?? "").toLowerCase() === "pending") return;
          if (!grouped[ln.work_order_id]) grouped[ln.work_order_id] = [];
          grouped[ln.work_order_id].push(ln);
        });

        const jobTypePriority: Record<string, number> = {
          diagnosis: 1,
          inspection: 2,
          maintenance: 3,
          repair: 4,
        };

        Object.values(grouped).forEach((arr) => {
          arr.sort((a, b) => {
            const pa =
              jobTypePriority[String(a.job_type ?? "repair")] ?? 999;
            const pb =
              jobTypePriority[String(b.job_type ?? "repair")] ?? 999;
            if (pa !== pb) return pa - pb;

            const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
            const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
            return ta - tb;
          });

          arr.forEach((ln, idx) => {
            lnMap[ln.id] = idx + 1; // 1-based line numbers
          });
        });

        setLineNumberMap(lnMap);
      } else {
        setWorkOrderMap({});
        setLineNumberMap({});
      }

      setLoading(false);
    })();
  }, [supabase]);

  // counts per bucket
  const counts = useMemo(() => {
    const base: Record<RollupStatus, number> = {
      awaiting: 0,
      in_progress: 0,
      on_hold: 0,
      completed: 0,
    };
    for (const line of lines) {
      base[toBucket(line.status)] += 1;
    }
    return base;
  }, [lines]);

  // sort queue: in-progress first, then by line number, then newest
  const sortedLines = useMemo(() => {
    const copy = [...lines];
    copy.sort((a, b) => {
      const ba = toBucket(a.status);
      const bb = toBucket(b.status);

      const ra = STATUS_RANK[ba];
      const rb = STATUS_RANK[bb];
      if (ra !== rb) return ra - rb;

      const na = lineNumberMap[a.id] ?? 9999;
      const nb = lineNumberMap[b.id] ?? 9999;
      if (na !== nb) return na - nb;

      const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
      const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
      return tb - ta;
    });
    return copy;
  }, [lines, lineNumberMap]);

  // apply filter on top of that sort
  const filteredLines = useMemo(() => {
    if (activeFilter == null) return sortedLines;
    return sortedLines.filter((l) => toBucket(l.status) === activeFilter);
  }, [sortedLines, activeFilter]);

  if (loading) {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto max-w-md px-4 py-8 text-sm text-neutral-300">
          Loading assigned jobs‚Ä¶
        </div>
      </main>
    );
  }

  if (err) {
    return (
      <main className="min-h-screen bg-black text-white">
        <div className="mx-auto max-w-md px-4 py-8 text-sm text-red-200">
          {err}
        </div>
      </main>
    );
  }

  return (
    <main className="min-h-screen bg-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-4">
        {/* Header / summary */}
        <section className="rounded-2xl border border-white/10 bg-gradient-to-br from-black via-neutral-950 to-black px-4 py-4 shadow-card">
          <div className="space-y-1">
            <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
              ProFixIQ ‚Ä¢ Tech
            </div>
            <h1 className="font-blackops text-xl uppercase tracking-[0.18em] text-orange-400">
              My jobs
            </h1>
            <p className="text-[0.75rem] text-neutral-300">
              Jobs currently assigned to you. Tap a job to open the work order
              in tech mode.
            </p>
          </div>

          <div className="mt-3 grid grid-cols-3 gap-3 text-[0.7rem] text-neutral-300">
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                Total lines
              </div>
              <div className="text-base font-semibold text-white">
                {lines.length}
              </div>
            </div>
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                In progress
              </div>
              <div className="text-base font-semibold text-emerald-200">
                {counts.in_progress}
              </div>
            </div>
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                On hold
              </div>
              <div className="text-base font-semibold text-amber-200">
                {counts.on_hold}
              </div>
            </div>
          </div>
        </section>

        {/* Filter chips */}
        <section className="grid grid-cols-2 gap-3 text-xs">
          {(
            ["awaiting", "in_progress", "on_hold", "completed"] as RollupStatus[]
          ).map((s) => {
            const isActive = activeFilter === s;
            return (
              <button
                key={s}
                type="button"
                onClick={() => setActiveFilter(isActive ? null : s)}
                className={`rounded-2xl border px-3 py-2 text-left transition ${STATUS_STYLES[s]}`}
                data-active={isActive ? "true" : "false"}
              >
                <div className="text-[0.6rem] uppercase tracking-[0.16em] text-neutral-400">
                  {STATUS_LABELS[s]}
                </div>
                <div className="mt-1 text-lg font-semibold">
                  {counts[s]}
                </div>
                {isActive && (
                  <div className="mt-1 text-[0.6rem] text-orange-200">
                    Showing only {STATUS_LABELS[s].toLowerCase()}
                  </div>
                )}
              </button>
            );
          })}
        </section>

        {/* Jobs list */}
        <section className="space-y-2">
          {filteredLines.map((line) => {
            const bucket = toBucket(line.status);
            const wo = line.work_order_id
              ? workOrderMap[line.work_order_id]
              : null;
            const slug = wo?.custom_id ?? wo?.id ?? line.work_order_id ?? "";

            const lineNumber = lineNumberMap[line.id];

            return (
              <button
                key={line.id}
                type="button"
                onClick={() => {
                  if (!slug) return;
                  router.push(`/mobile/work-orders/${slug}?mode=tech`);
                }}
                className="flex w-full items-center justify-between gap-3 rounded-2xl border border-neutral-800 bg-neutral-950/90 px-3 py-3 text-left shadow-[0_0_0_1px_rgba(15,23,42,0.9)] active:scale-[0.99]"
              >
                <div className="min-w-0">
                  <div className="truncate text-[0.85rem] font-medium text-neutral-50">
                    {wo?.custom_id
                      ? wo.custom_id
                      : line.work_order_id
                      ? `WO #${line.work_order_id.slice(0, 8)}`
                      : "Work order line"}
                  </div>
                  <div className="mt-0.5 text-[0.7rem] text-neutral-400">
                    {lineNumber
                      ? `Line #${lineNumber}`
                      : `Line id ${line.id.slice(0, 8)}`}
                  </div>
                </div>
                <span className="shrink-0 rounded-full border border-neutral-700 px-2 py-0.5 text-[0.7rem] text-neutral-200">
                  {STATUS_LABELS[bucket]}
                </span>
              </button>
            );
          })}

          {filteredLines.length === 0 && (
            <div className="rounded-2xl border border-dashed border-neutral-700 bg-neutral-950/80 px-3 py-4 text-sm text-neutral-400">
              No jobs in this bucket.
            </div>
          )}
        </section>
      </div>
    </main>
  );
}

========================================
FILE: app/mobile/work-orders/create/page.tsx
========================================
"use client";

/**
 * Mobile Create Work Order (Companion App)
 * ---------------------------------------------------------------------------
 * Mobile-first create flow:
 * - Auto-creates a placeholder WO tied to Walk-in Customer / Unassigned vehicle
 * - Lets you capture customer + vehicle + lines
 * - VIN scan support
 * - Sends you to the mobile WO detail view on submit
 */

import { useEffect, useMemo, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { v4 as uuidv4 } from "uuid";

import type { Database } from "@shared/types/types/supabase";
import type {
  MobileCustomer,
  MobileVehicle,
} from "@/features/work-orders/mobile/types";

import { MobileCustomerVehicleForm } from "@/features/work-orders/mobile/MobileCustomerVehicleForm";
import { MobileWorkOrderLines } from "@/features/work-orders/mobile/MobileWorkOrderLines";
import { MobileJobLineAdd } from "@/features/work-orders/mobile/MobileJobLineAdd";
import { useWorkOrderDraft } from "app/work-orders/state/useWorkOrderDraft";
import VinCaptureModal from "app/vehicle/VinCaptureModal";

// üî¢ shared custom-id generator (same as desktop)
import { generateWorkOrderCustomId } from "@/features/work-orders/lib/generateCustomId";

type DB = Database;
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderInsert = DB["public"]["Tables"]["work_orders"]["Insert"];
type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];

type DraftCustomerShape = {
  first_name?: string | null;
  last_name?: string | null;
  phone?: string | null;
  email?: string | null;
};

type DraftVehicleShape = {
  vin?: string | null;
  year?: string | null;
  make?: string | null;
  model?: string | null;
  license_plate?: string | null;
  plate?: string | null;
};

/* -------------------------------------------------------------------------- */
/* Helpers (mirrored from desktop create page)                                */
/* -------------------------------------------------------------------------- */

/**
 * Resolve the user's shop_id.
 * - First tries profiles.id = userId
 * - If none, tries shops.owner_id = userId and writes back to profile
 */
async function getOrLinkShopId(
  supabase: ReturnType<typeof createClientComponentClient<DB>>,
  userId: string,
): Promise<string | null> {
  const { data: profileById, error: profErr } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("id", userId)
    .maybeSingle();

  if (profErr) throw profErr;
  if (profileById?.shop_id) return profileById.shop_id;

  const { data: ownedShop, error: shopErr } = await supabase
    .from("shops")
    .select("id")
    .eq("owner_id", userId)
    .maybeSingle();

  if (shopErr) throw shopErr;
  if (!ownedShop?.id) return null;

  const { error: updErr } = await supabase
    .from("profiles")
    .update({ shop_id: ownedShop.id })
    .eq("id", userId);

  if (updErr) throw updErr;
  return ownedShop.id;
}

export default function MobileCreateWorkOrderPage() {
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const draft = useWorkOrderDraft();

  const [wo, setWo] = useState<WorkOrderRow | null>(null);

  const [customer, setCustomer] = useState<MobileCustomer>({
    id: null,
    first_name: null,
    last_name: null,
    phone: null,
    email: null,
  });

  const [vehicle, setVehicle] = useState<MobileVehicle>({
    id: null,
    vin: null,
    year: null,
    make: null,
    model: null,
    license_plate: null,
    mileage: null,
    color: null,
  });

  const [lines, setLines] = useState<WorkOrderLineRow[]>([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);

  // waiter flag (customer waiting on-site)
  const [isWaiter, setIsWaiter] = useState(false);

  /* ------------------------------------------------------------------------ */
  /* Hydrate from shared VIN / OCR draft (desktop + mobile shared store)      */
  /* ------------------------------------------------------------------------ */
  useEffect(() => {
    const draftCustomer = (draft.customer ?? null) as DraftCustomerShape | null;
    const draftVehicle = (draft.vehicle ?? null) as DraftVehicleShape | null;

    const hasCust =
      draftCustomer != null &&
      Object.values(draftCustomer).some((v) => v != null && v !== "");
    const hasVeh =
      draftVehicle != null &&
      Object.values(draftVehicle).some((v) => v != null && v !== "");

    if (hasCust && draftCustomer) {
      setCustomer((prev) => ({
        ...prev,
        first_name: draftCustomer.first_name ?? prev.first_name,
        last_name: draftCustomer.last_name ?? prev.last_name,
        phone: draftCustomer.phone ?? prev.phone,
        email: draftCustomer.email ?? prev.email,
      }));
    }

    if (hasVeh && draftVehicle) {
      setVehicle((prev) => ({
        ...prev,
        vin: draftVehicle.vin ?? prev.vin,
        year: draftVehicle.year ?? prev.year,
        make: draftVehicle.make ?? prev.make,
        model: draftVehicle.model ?? prev.model,
        license_plate:
          draftVehicle.license_plate ??
          draftVehicle.plate ??
          prev.license_plate,
      }));
    }

    if (hasVeh || hasCust) {
      draft.reset();
    }
  }, [draft]);

  /* ------------------------------------------------------------------------ */
  /* Resolve current user id (for VIN modal)                                  */
  /* ------------------------------------------------------------------------ */
  useEffect(() => {
    void (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      setCurrentUserId(user?.id ?? null);
    })();
  }, [supabase]);

  /* ------------------------------------------------------------------------ */
  /* Auto-create placeholder WO (aligned with desktop Create)                 */
  /* ------------------------------------------------------------------------ */
  useEffect(() => {
    void (async () => {
      try {
        const {
          data: { user },
        } = await supabase.auth.getUser();

        if (!user?.id) return;

        const shopId = await getOrLinkShopId(supabase, user.id);
        if (!shopId) return;

        // Ensure Walk-in Customer
        let placeholderCustomer: CustomerRow | null = null;

        const { data: customers } = await supabase
          .from("customers")
          .select("*")
          .eq("shop_id", shopId)
          .ilike("first_name", "Walk-in")
          .ilike("last_name", "Customer")
          .limit(1);

        if (customers && customers.length > 0) {
          placeholderCustomer = customers[0] as CustomerRow;
        } else {
          const { data } = await supabase
            .from("customers")
            .insert({
              first_name: "Walk-in",
              last_name: "Customer",
              shop_id: shopId,
            })
            .select("*")
            .single();
          placeholderCustomer = (data as CustomerRow) ?? null;
        }

        if (!placeholderCustomer) return;

        // Ensure Unassigned vehicle
        let placeholderVehicle: VehicleRow | null = null;
        const { data: vehicles } = await supabase
          .from("vehicles")
          .select("*")
          .eq("customer_id", placeholderCustomer.id)
          .eq("shop_id", shopId)
          .ilike("model", "Unassigned")
          .limit(1);

        if (vehicles && vehicles.length > 0) {
          placeholderVehicle = vehicles[0] as VehicleRow;
        } else {
          const { data } = await supabase
            .from("vehicles")
            .insert({
              customer_id: placeholderCustomer.id,
              shop_id: shopId,
              make: "‚Äî",
              model: "Unassigned",
            })
            .select("*")
            .single();
          placeholderVehicle = (data as VehicleRow) ?? null;
        }

        if (!placeholderVehicle) return;

        // üî¢ Generate custom_id using shared helper (same as desktop)
        const customId = await generateWorkOrderCustomId(
          supabase,
          placeholderCustomer.id,
        );

        const newId = uuidv4();

        const insertPayload: WorkOrderInsert & {
          is_waiter?: boolean | null;
        } = {
          id: newId,
          custom_id: customId ?? null,
          user_id: user.id,
          shop_id: shopId,
          customer_id: placeholderCustomer.id,
          vehicle_id: placeholderVehicle.id,
          status: "awaiting_approval",
          priority: 3,
          // mobile defaults to drop-off; user can flip to waiter
          is_waiter: false,
        };

        const { data: inserted, error: insertErr } = await supabase
          .from("work_orders")
          .insert(insertPayload)
          .select("*")
          .single();

        if (insertErr || !inserted) {
          throw new Error(insertErr?.message ?? "Failed to create work order.");
        }

        const insertedWo = inserted as WorkOrderRow & {
          is_waiter?: boolean | null;
        };

        setWo(insertedWo);
        setIsWaiter(Boolean(insertedWo.is_waiter));

        // Seed local state
        setCustomer((prev) => ({
          ...prev,
          id: placeholderCustomer.id,
          first_name: placeholderCustomer.first_name ?? prev.first_name,
          last_name: placeholderCustomer.last_name ?? prev.last_name,
        }));

        setVehicle((prev) => ({
          ...prev,
          id: placeholderVehicle.id,
          make: placeholderVehicle.make ?? prev.make,
          model: placeholderVehicle.model ?? prev.model,
          license_plate:
            placeholderVehicle.license_plate ?? prev.license_plate,
        }));
      } catch (e) {
        const msg =
          e instanceof Error
            ? e.message
            : "Failed to auto-create mobile work order.";
        setError(msg);
      }
    })();
  }, [supabase]);

  /* ------------------------------------------------------------------------ */
  /* Fetch lines for this WO                                                  */
  /* ------------------------------------------------------------------------ */
  const fetchLines = useCallback(async () => {
    if (!wo?.id) return;

    const { data } = await supabase
      .from("work_order_lines")
      .select("*")
      .eq("work_order_id", wo.id)
      .order("created_at");

    setLines((data ?? []) as WorkOrderLineRow[]);
  }, [wo?.id, supabase]);

  useEffect(() => {
    if (!wo?.id) return;
    void fetchLines();

    // realtime refresh when lines change
    const ch = supabase
      .channel(`m:create-wo:${wo.id}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => {
          void fetchLines();
        },
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        /* noop */
      }
    };
  }, [wo?.id, supabase, fetchLines]);

  /* ------------------------------------------------------------------------ */
  /* Waiter toggle ‚Üí persist to work_orders                                   */
  /* ------------------------------------------------------------------------ */
  const handleWaiterChange = useCallback(
    async (value: boolean) => {
      setIsWaiter(value);
      if (!wo?.id) return;

      try {
        const updatePayload: Partial<
          WorkOrderRow & { is_waiter?: boolean | null }
        > = {
          is_waiter: value,
        };

        await supabase
          .from("work_orders")
          .update(updatePayload)
          .eq("id", wo.id);
      } catch (e) {
        const msg =
          e instanceof Error
            ? e.message
            : "Failed to update visit type.";
        setError(msg);
      }
    },
    [wo?.id, supabase],
  );

  /* ------------------------------------------------------------------------ */
  /* Submit ‚Üí go to mobile WO detail                                          */
  /* ------------------------------------------------------------------------ */
  const handleSubmit = async () => {
    if (!wo?.id) return;
    setLoading(true);
    setError(null);

    try {
      // If the VIN / OCR draft has anything, it is already reflected in vehicle state.
      if (draft?.customer || draft?.vehicle) {
        // Mobile create currently relies on the detail page to finish deep persistence.
      }

      router.push(`/mobile/work-orders/${wo.id}`);
    } catch (e) {
      const msg =
        e instanceof Error ? e.message : "Failed to continue to work order.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  };

  /* ------------------------------------------------------------------------ */
  /* UI                                                                       */
  /* ------------------------------------------------------------------------ */
  return (
    <div className="px-4 py-4">
      <div className="mx-auto max-w-xl space-y-6">
        {/* Header card */}
        <section className="metal-panel metal-panel--card rounded-2xl border border-white/10 px-4 py-4 shadow-card text-white">
          <div className="flex items-center justify-between gap-3">
            <div>
              <h1 className="text-lg font-blackops tracking-[0.16em] text-[var(--accent-copper-light)]">
                Create Work Order
              </h1>
              <p className="mt-1 text-[0.75rem] text-neutral-300">
                Start a new ticket from the lane.
              </p>
            </div>
            {wo?.custom_id && (
              <div className="rounded-full border border-white/15 bg-black/40 px-3 py-1 text-[0.7rem] font-mono text-neutral-100">
                WO&nbsp;
                <span className="text-[var(--accent-copper-soft)]">
                  {wo.custom_id}
                </span>
              </div>
            )}
          </div>

          {/* Visit type / waiter toggle */}
          <div className="mt-3 flex items-center justify-between gap-3">
            <span className="text-[0.68rem] font-medium uppercase tracking-[0.16em] text-neutral-400">
              Visit type
            </span>
            <div className="inline-flex overflow-hidden rounded-full border border-white/15 bg-black/60 text-[0.7rem]">
              <button
                type="button"
                onClick={() => handleWaiterChange(false)}
                className={`px-3 py-1.5 font-medium transition ${
                  !isWaiter
                    ? "bg-white/10 text-neutral-50"
                    : "text-neutral-400"
                }`}
              >
                Drop-off
              </button>
              <button
                type="button"
                onClick={() => handleWaiterChange(true)}
                className={`px-3 py-1.5 font-medium transition border-l border-white/10 ${
                  isWaiter
                    ? "bg-[var(--accent-copper)]/20 text-[var(--accent-copper-light)]"
                    : "text-neutral-400"
                }`}
              >
                Waiter
              </button>
            </div>
          </div>

          {error && (
            <p className="mt-3 rounded-lg border border-red-500/50 bg-red-950/70 px-3 py-2 text-[0.7rem] text-red-100">
              {error}
            </p>
          )}
        </section>

        {/* Customer + Vehicle Form */}
        <div className="glass-card rounded-2xl border border-white/10 px-3 py-3">
          <MobileCustomerVehicleForm
            wo={wo}
            customer={customer}
            vehicle={vehicle}
            onCustomerChange={setCustomer}
            onVehicleChange={setVehicle}
            supabase={supabase}
          />

          {/* VIN scan (reads decoded VIN and patches local + draft state) */}
          <div className="mt-3 flex flex-wrap gap-2">
            <VinCaptureModal
              userId={currentUserId ?? "anon"}
              action="/api/vin"
              onDecoded={(decoded) => {
                // store in shared draft (used by desktop + other flows)
                draft.setVehicle({
                  vin: decoded.vin ?? null,
                  year: decoded.year ?? null,
                  make: decoded.make ?? null,
                  model: decoded.model ?? null,
                });

                // patch local mobile vehicle state
                setVehicle((prev) => ({
                  ...prev,
                  vin: decoded.vin ?? prev.vin,
                  year: decoded.year ?? prev.year,
                  make: decoded.make ?? prev.make,
                  model: decoded.model ?? prev.model,
                }));
              }}
            >
              <span className="cursor-pointer rounded-full border border-[var(--accent-copper)] px-3 py-1.5 text-[0.7rem] font-medium text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper)]/10">
                Add by VIN / Scan
              </span>
            </VinCaptureModal>
          </div>
        </div>

        {/* Job Lines */}
        <MobileWorkOrderLines
          lines={lines}
          workOrderId={wo?.id ?? null}
          onDelete={async (lineId) => {
            if (!wo?.id) return;
            await supabase
              .from("work_order_lines")
              .delete()
              .eq("id", lineId)
              .eq("work_order_id", wo.id);
            await fetchLines();
          }}
        />

        {/* Add a Line */}
        <div className="glass-card rounded-2xl border border-white/10 px-3 py-3">
          <MobileJobLineAdd
            workOrderId={wo?.id ?? null}
            vehicleId={vehicle.id}
            defaultJobType="diagnosis"
            onCreated={fetchLines}
          />
        </div>

        {/* Continue */}
        <button
          disabled={loading || !wo?.id}
          onClick={handleSubmit}
          className="w-full rounded-full bg-[var(--accent-copper)] py-3 text-sm font-semibold text-black shadow-[0_0_25px_rgba(0,0,0,0.9)] transition active:opacity-85 disabled:opacity-60"
        >
          {loading ? "Saving‚Ä¶" : "Approve & Continue"}
        </button>
      </div>
    </div>
  );
}


========================================
FILE: app/mobile/work-orders/[id]/page.tsx
========================================
// app/mobile/work-orders/[id]/page.tsx
"use client";

import { useParams } from "next/navigation";
import MobileWorkOrderClient from "@/features/work-orders/mobile/MobileWorkOrderClient";

export default function MobileWorkOrderDetailsPage() {
  const params = useParams<{ id: string }>();
  const id = params.id;

  return <MobileWorkOrderClient routeId={id} />;
}

========================================
FILE: app/mobile/work-orders/[id]/vehicle/page.tsx
========================================
// app/mobile/work-orders/[id]/vehicle/page.tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { useParams } from "next/navigation";

import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

import MobileCustomerVehicleForm from "@/features/work-orders/mobile/MobileCustomerVehicleForm";
import type {
  MobileCustomer,
  MobileVehicle,
} from "@/features/work-orders/mobile/types";

type DB = Database;
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];

export default function MobileWorkOrderVehiclePage() {
  const params = useParams<{ id: string }>();
  const workOrderId = params?.id;

  const [wo, setWo] = useState<WorkOrderRow | null>(null);

  const [customer, setCustomer] = useState<MobileCustomer>({
    id: null,
    first_name: null,
    last_name: null,
    phone: null,
    email: null,
  });

  const [vehicle, setVehicle] = useState<MobileVehicle>({
    id: null,
    year: null,
    make: null,
    model: null,
    license_plate: null,
    mileage: null,
  });

  const [loading, setLoading] = useState<boolean>(true);
  const [error, setError] = useState<string | null>(null);

  const fetchData = useCallback(async () => {
    if (!workOrderId) return;

    setLoading(true);
    setError(null);

    try {
      // 1) Load the work order (just the fields we care about)
      const { data: woRow, error: woErr } = await supabase
        .from("work_orders")
        .select("id, custom_id, customer_id, vehicle_id, shop_id")
        .eq("id", workOrderId)
        .maybeSingle();

      if (woErr) throw woErr;

      if (!woRow) {
        setError("Work order not found.");
        setLoading(false);
        return;
      }

      setWo(woRow as WorkOrderRow);

      // 2) Load customer, if linked
      if (woRow.customer_id) {
        const { data: cust, error: custErr } = await supabase
          .from("customers")
          .select(
            "id, first_name, last_name, phone, phone_number, email",
          )
          .eq("id", woRow.customer_id)
          .maybeSingle();

        if (custErr) throw custErr;

        if (cust) {
          const c = cust as CustomerRow;
          setCustomer({
            id: c.id,
            first_name: (c.first_name as string | null) ?? null,
            last_name: (c.last_name as string | null) ?? null,
            // prefer phone, fall back to phone_number
            phone:
              (c.phone as string | null) ??
              (c.phone_number as string | null) ??
              null,
            email: (c.email as string | null) ?? null,
          });
        }
      }

      // 3) Load vehicle, if linked
      if (woRow.vehicle_id) {
        const { data: veh, error: vehErr } = await supabase
          .from("vehicles")
          .select(
            "id, year, make, model, license_plate, mileage",
          )
          .eq("id", woRow.vehicle_id)
          .maybeSingle();

        if (vehErr) throw vehErr;

        if (veh) {
          const v = veh as VehicleRow;
          setVehicle({
            id: v.id,
            year: (v.year as number | null) ?? null,
            make: (v.make as string | null) ?? null,
            model: (v.model as string | null) ?? null,
            license_plate: (v.license_plate as string | null) ?? null,
            mileage: (v.mileage as string | null) ?? null,
          });
        }
      }
    } catch (e) {
      console.error("[MobileWorkOrderVehiclePage] fetch error:", e);
      const msg =
        e instanceof Error
          ? e.message
          : "Failed to load customer/vehicle info.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  }, [workOrderId]);

  useEffect(() => {
    void fetchData();
  }, [fetchData]);

  if (!workOrderId) {
    return (
      <div className="p-4 text-sm text-red-300">
        Missing work order id in route.
      </div>
    );
  }

  if (loading) {
    return (
      <div className="p-4 text-sm text-neutral-200">
        Loading customer &amp; vehicle‚Ä¶
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-4 text-sm text-red-300">{error}</div>
    );
  }

  return (
    <div className="min-h-screen bg-[#020617] px-3 py-4 text-white">
      <div className="mx-auto max-w-xl">
        <MobileCustomerVehicleForm
          wo={wo}
          customer={customer}
          vehicle={vehicle}
          onCustomerChange={setCustomer}
          onVehicleChange={setVehicle}
          supabase={supabase}
        />
      </div>
    </div>
  );
}

========================================
FILE: app/mobile/work-orders/page.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { format } from "date-fns";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type Row = WorkOrder & {
  customers: Pick<Customer, "first_name" | "last_name" | "phone"> | null;
  vehicles: Pick<Vehicle, "year" | "make" | "model" | "license_plate"> | null;
};

type StatusKey =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

const NORMAL_FLOW_STATUSES: StatusKey[] = [
  "awaiting",
  "queued",
  "in_progress",
  "on_hold",
  "planned",
  "new",
];

const STATUS_LABEL: Record<StatusKey, string> = {
  awaiting_approval: "Awaiting approval",
  awaiting: "Awaiting",
  queued: "Queued",
  in_progress: "In progress",
  on_hold: "On hold",
  planned: "Planned",
  new: "New",
  completed: "Completed",
  ready_to_invoice: "Ready to invoice",
  invoiced: "Invoiced",
};

const STATUS_CHIP: Record<StatusKey, string> = {
  awaiting_approval:
    "bg-blue-500/10 text-blue-200 border border-blue-400/60",
  awaiting:
    "bg-sky-500/10 text-sky-200 border border-sky-400/60",
  queued:
    "bg-indigo-500/10 text-indigo-200 border border-indigo-400/60",
  in_progress:
    "bg-orange-500/10 text-orange-200 border border-orange-400/70",
  on_hold:
    "bg-amber-500/10 text-amber-200 border border-amber-400/70",
  planned:
    "bg-purple-500/10 text-purple-200 border border-purple-400/70",
  new:
    "bg-neutral-800 text-neutral-100 border border-neutral-600",
  completed:
    "bg-green-500/10 text-green-200 border border-green-400/70",
  ready_to_invoice:
    "bg-emerald-500/10 text-emerald-200 border border-emerald-400/70",
  invoiced:
    "bg-teal-500/10 text-teal-200 border border-teal-400/70",
};

const INPUT_DARK =
  "w-full rounded-lg border border-neutral-700 bg-neutral-950 px-3 py-2 text-sm text-neutral-50 placeholder:text-neutral-500 " +
  "focus:border-orange-400 focus:outline-none focus:ring-1 focus:ring-orange-500/60 [color-scheme:dark]";

const SELECT_DARK =
  "w-full rounded-lg border border-neutral-700 bg-neutral-950 px-3 py-2 text-sm text-neutral-50 " +
  "focus:border-orange-400 focus:outline-none focus:ring-1 focus:ring-orange-500/60 [color-scheme:dark]";

function statusKey(raw: string | null | undefined): StatusKey {
  const key = (raw ?? "awaiting").toLowerCase().replaceAll(" ", "_") as StatusKey;
  if (key in STATUS_LABEL) return key;
  return "awaiting";
}

export default function MobileWorkOrdersListPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<string>("");
  const [err, setErr] = useState<string | null>(null);

  const load = useCallback(async () => {
    setLoading(true);
    setErr(null);

    let query = supabase
      .from("work_orders")
      .select(
        `
        *,
        customers:customers(first_name,last_name,phone),
        vehicles:vehicles(year,make,model,license_plate)
      `
      )
      .order("created_at", { ascending: false })
      .limit(100);

    if (status === "") {
      query = query.in("status", NORMAL_FLOW_STATUSES as unknown as string[]);
    } else {
      query = query.eq("status", status);
    }

    const { data, error } = await query;

    if (error) {
      setErr(error.message);
      setRows([]);
      setLoading(false);
      return;
    }

    const list = (data ?? []) as Row[];

    const qlc = q.trim().toLowerCase();
    const filtered =
      qlc.length === 0
        ? list
        : list.filter((r) => {
            const name = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            const plate = r.vehicles?.license_plate?.toLowerCase() ?? "";
            const ymm = [r.vehicles?.year ?? "", r.vehicles?.make ?? "", r.vehicles?.model ?? ""]
              .join(" ")
              .toLowerCase();
            const cid = (r.custom_id ?? "").toLowerCase();
            return (
              r.id.toLowerCase().includes(qlc) ||
              cid.includes(qlc) ||
              name.includes(qlc) ||
              plate.includes(qlc) ||
              ymm.includes(qlc)
            );
          });

    setRows(filtered);
    setLoading(false);
  }, [q, status, supabase]);

  useEffect(() => {
    void load();
  }, [load]);

  useEffect(() => {
    const ch = supabase
      .channel("mobile:work_orders:list")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_orders" },
        () => {
          setTimeout(() => void load(), 80);
        }
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        // ignore
      }
    };
  }, [supabase, load]);

  const total = rows.length;
  const activeCount = useMemo(
    () =>
      rows.filter((r) =>
        NORMAL_FLOW_STATUSES.includes(
          statusKey(r.status ?? "awaiting")
        )
      ).length,
    [rows]
  );

  return (
    <main className="mx-auto flex min-h-screen max-w-md flex-col bg-gradient-to-b from-black to-neutral-950 px-3 pb-6 pt-4 text-neutral-50">
      {/* Header */}
      <header className="mb-4 flex flex-col gap-1">
        <h1 className="text-base font-blackops uppercase tracking-[0.18em] text-neutral-100">
          Jobs
        </h1>
        <p className="text-[11px] text-neutral-400">
          Work orders for this shop. Tap a card to open details.
        </p>
      </header>

      {/* Filters */}
      <section className="mb-3 space-y-2 rounded-2xl border border-white/10 bg-black/60 p-3 shadow-lg shadow-black/40 backdrop-blur-md">
        <div className="space-y-2">
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && void load()}
            placeholder="Search id, customer, plate, YMM‚Ä¶"
            className={INPUT_DARK + " text-xs"}
          />
          <div className="flex flex-col gap-2 sm:flex-row sm:items-center">
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className={SELECT_DARK + " text-xs"}
            >
              <option value="">Active (normal flow)</option>
              <option value="awaiting_approval">Awaiting approval</option>
              <option value="awaiting">Awaiting</option>
              <option value="queued">Queued</option>
              <option value="in_progress">In progress</option>
              <option value="on_hold">On hold</option>
              <option value="planned">Planned</option>
              <option value="new">New</option>
              <option value="completed">Completed</option>
              <option value="ready_to_invoice">Ready to invoice</option>
              <option value="invoiced">Invoiced</option>
            </select>
            <button
              type="button"
              onClick={() => void load()}
              className="mt-1 inline-flex items-center justify-center rounded-lg border border-neutral-700 bg-neutral-950 px-3 py-1.5 text-[11px] font-medium text-neutral-100 hover:bg-neutral-900"
            >
              Refresh
            </button>
          </div>
        </div>

        <div className="mt-1 flex items-center justify-between text-[10px] text-neutral-300">
          <div className="flex items-center gap-4">
            <div className="flex flex-col">
              <span className="uppercase tracking-[0.14em] text-neutral-500">
                Total
              </span>
              <span className="text-sm font-semibold text-white">
                {total}
              </span>
            </div>
            <div className="h-7 w-px bg-neutral-700/70" />
            <div className="flex flex-col">
              <span className="uppercase tracking-[0.14em] text-neutral-500">
                Active
              </span>
              <span className="text-sm font-semibold text-sky-200">
                {activeCount}
              </span>
            </div>
          </div>
          <Link
            href="/work-orders/create"
            className="inline-flex items-center rounded-full border border-orange-500/70 bg-orange-500 px-3 py-1 text-[11px] font-semibold text-black shadow-sm hover:bg-orange-400"
          >
            <span className="mr-1 text-base leading-none">Ôºã</span>
            New
          </Link>
        </div>
      </section>

      {err && (
        <div className="mb-3 rounded-xl border border-red-500/60 bg-red-950/50 px-3 py-2 text-[11px] text-red-100">
          {err}
        </div>
      )}

      {/* List */}
      <section className="flex-1 space-y-2">
        {loading ? (
          <div className="rounded-2xl border border-white/10 bg-black/60 p-4 text-sm text-neutral-300">
            Loading work orders‚Ä¶
          </div>
        ) : rows.length === 0 ? (
          <div className="rounded-2xl border border-dashed border-white/20 bg-black/50 p-5 text-sm text-neutral-400">
            No work orders match your filters.
          </div>
        ) : (
          <div className="space-y-2">
            {rows.map((wo) => {
              const key = statusKey(wo.status);
              const customerName = wo.customers
                ? [wo.customers.first_name ?? "", wo.customers.last_name ?? ""]
                    .filter(Boolean)
                    .join(" ")
                : "No customer";

              const vehicleLabel = wo.vehicles
                ? `${wo.vehicles.year ?? ""} ${wo.vehicles.make ?? ""} ${
                    wo.vehicles.model ?? ""
                  }`.trim()
                : "";

              const plate = wo.vehicles?.license_plate ?? "";
              const idLabel = wo.custom_id || `#${wo.id.slice(0, 8)}`;

              return (
                <Link
                  key={wo.id}
                  href={`/mobile/work-orders/${wo.id}`}
                  className="block rounded-2xl border border-white/10 bg-black/70 px-3.5 py-3 shadow-md shadow-black/50 active:scale-[0.99]"
                >
                  <div className="mb-1 flex items-center justify-between gap-2">
                    <div className="flex flex-col">
                      <span className="text-[11px] text-neutral-400">
                        {wo.created_at
                          ? format(new Date(wo.created_at), "PP")
                          : "‚Äî"}
                      </span>
                      <span className="text-sm font-semibold text-neutral-50">
                        {idLabel}
                      </span>
                    </div>
                    <span
                      className={
                        "inline-flex items-center rounded-full px-2 py-0.5 text-[9px] font-medium uppercase tracking-[0.14em] " +
                        STATUS_CHIP[key]
                      }
                    >
                      {STATUS_LABEL[key]}
                    </span>
                  </div>

                  <div className="mt-1 space-y-1 text-[11px] text-neutral-300">
                    <div className="flex items-center justify-between gap-2">
                      <span className="line-clamp-1">
                        {customerName || "No customer"}
                      </span>
                      {wo.customers?.phone && (
                        <span className="font-mono text-neutral-400">
                          {wo.customers.phone}
                        </span>
                      )}
                    </div>
                    <div className="text-[10px] text-neutral-400">
                      {vehicleLabel || "No vehicle"}
                      {plate ? (
                        <span className="ml-1 text-neutral-500">
                          ({plate})
                        </span>
                      ) : null}
                    </div>
                  </div>
                </Link>
              );
            })}
          </div>
        )}
      </section>
    </main>
  );
}


========================================
FILE: app/mobile/work-orders/view/page.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { format } from "date-fns";
import { toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import AssignTechModal from "@/features/work-orders/components/workorders/extras/AssignTechModal";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Profile = DB["public"]["Tables"]["profiles"]["Row"];

type Row = WorkOrder & {
  customers: Pick<Customer, "first_name" | "last_name" | "phone" | "email"> | null;
  vehicles: Pick<Vehicle, "year" | "make" | "model" | "license_plate"> | null;
};

/* ------------------------------------------------------------------ */
/* Status badges                                                      */
/* ------------------------------------------------------------------ */

type StatusKey =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

const BADGE_BASE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.12em]";

const STATUS_BADGE: Record<StatusKey, string> = {
  awaiting_approval: "bg-blue-500/10 border-blue-400/60 text-blue-100",
  awaiting: "bg-sky-500/10 border-sky-400/60 text-sky-100",
  queued: "bg-indigo-500/10 border-indigo-400/60 text-indigo-100",
  in_progress:
    "bg-[var(--accent-copper)]/15 border-[var(--accent-copper-light)]/70 text-[var(--accent-copper-light)]",
  on_hold: "bg-amber-500/10 border-amber-400/70 text-amber-100",
  planned: "bg-purple-500/10 border-purple-400/70 text-purple-100",
  new: "bg-neutral-900/80 border-neutral-500/80 text-neutral-100",
  completed: "bg-green-500/10 border-green-400/70 text-green-100",
  ready_to_invoice:
    "bg-emerald-500/10 border-emerald-400/70 text-emerald-100",
  invoiced: "bg-teal-500/10 border-teal-400/70 text-teal-100",
};

const statusChip = (s: string | null | undefined) => {
  const key = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_") as StatusKey;
  const cls = STATUS_BADGE[key] ?? STATUS_BADGE.awaiting;
  return `${BADGE_BASE} ${cls}`;
};

/** ‚ÄúNormal flow‚Äù = tech/active; hides AA, completed, billing states */
const NORMAL_FLOW_STATUSES: StatusKey[] = [
  "awaiting",
  "queued",
  "in_progress",
  "on_hold",
  "planned",
  "new",
];

// roles that can assign techs from mobile advisor view
const ASSIGN_ROLES = new Set(["owner", "admin", "manager", "advisor"]);

/* ------------------------------------------------------------------ */
/* Input styles                                                        */
/* ------------------------------------------------------------------ */

const INPUT_DARK =
  "w-full rounded-full border border-white/15 bg-black/40 px-3 py-1.5 text-xs text-neutral-100 placeholder:text-neutral-500 " +
  "shadow-[0_0_18px_rgba(0,0,0,0.8)] backdrop-blur focus:border-[var(--accent-copper)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper)]";

const SELECT_DARK =
  "w-full rounded-full border border-white/15 bg-black/40 px-3 py-1.5 text-xs text-neutral-100 " +
  "shadow-[0_0_18px_rgba(0,0,0,0.8)] backdrop-blur focus:border-[var(--accent-copper)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper)]";

const BUTTON_MUTED =
  "rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs text-neutral-100 shadow-[0_0_14px_rgba(0,0,0,0.7)] " +
  "transition hover:border-[var(--accent-copper-light)] hover:bg-[var(--accent-copper)]/15 hover:text-white active:opacity-80";

/* ------------------------------------------------------------------ */
/* Page                                                                */
/* ------------------------------------------------------------------ */

export default function MobileWorkOrdersViewPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<string>("");
  const [err, setErr] = useState<string | null>(null);

  const [currentRole, setCurrentRole] = useState<string | null>(null);

  // mechanics for AssignTechModal
  const [mechanics, setMechanics] = useState<
    Array<Pick<Profile, "id" | "full_name" | "role">>
  >([]);

  // primary line per WO (for assigning via modal)
  const [primaryLineByWo, setPrimaryLineByWo] = useState<Record<string, string>>(
    {},
  );

  // assign-tech modal state
  const [assignModalOpen, setAssignModalOpen] = useState(false);
  const [assignModalLineId, setAssignModalLineId] = useState<string | null>(
    null,
  );

  // load role + mechanics once
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (user?.id) {
        const { data: prof } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", user.id)
          .maybeSingle();
        setCurrentRole(prof?.role ?? null);
      }

      try {
        const res = await fetch("/api/assignables");
        const json = await res.json();
        if (res.ok && Array.isArray(json.data)) {
          setMechanics(json.data);
        }
      } catch {
        // silent ‚Äì modal can still fall back to its own fetch
      }
    })();
  }, [supabase]);

  const canAssign = currentRole ? ASSIGN_ROLES.has(currentRole) : false;

  const load = useCallback(async () => {
    setLoading(true);
    setErr(null);

    // 1) fetch work orders
    let woQuery = supabase
      .from("work_orders")
      .select(
        `
        *,
        customers:customers(first_name,last_name,phone,email),
        vehicles:vehicles(year,make,model,license_plate)
      `,
      )
      .order("created_at", { ascending: false })
      .limit(50);

    if (status === "") {
      woQuery = woQuery.in(
        "status",
        NORMAL_FLOW_STATUSES as unknown as string[],
      );
    } else {
      woQuery = woQuery.eq("status", status);
    }

    const { data, error } = await woQuery;

    if (error) {
      setErr(error.message);
      setRows([]);
      setPrimaryLineByWo({});
      setLoading(false);
      return;
    }

    const workOrders = (data ?? []) as Row[];

    // 2) client-side text search
    const qlc = q.trim().toLowerCase();
    const filtered =
      qlc.length === 0
        ? workOrders
        : workOrders.filter((r) => {
            const name = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            const plate = r.vehicles?.license_plate?.toLowerCase() ?? "";
            const ymm = [
              r.vehicles?.year ?? "",
              r.vehicles?.make ?? "",
              r.vehicles?.model ?? "",
            ]
              .join(" ")
              .toLowerCase();
            const cid = (r.custom_id ?? "").toLowerCase();
            return (
              r.id.toLowerCase().includes(qlc) ||
              cid.includes(qlc) ||
              name.includes(qlc) ||
              plate.includes(qlc) ||
              ymm.includes(qlc)
            );
          });

    setRows(filtered);

    // 3) get a primary line id for each work order (first line)
    const ids = filtered.map((r) => r.id);
    if (ids.length > 0) {
      const { data: lines, error: lineErr } = await supabase
        .from("work_order_lines")
        .select("id, work_order_id, created_at")
        .in("work_order_id", ids)
        .order("created_at", { ascending: true });

      if (!lineErr && lines) {
        const map: Record<string, string> = {};
        lines.forEach((ln) => {
          const woId = ln.work_order_id as string;
          if (!map[woId]) {
            map[woId] = ln.id as string;
          }
        });
        setPrimaryLineByWo(map);
      } else {
        setPrimaryLineByWo({});
      }
    } else {
      setPrimaryLineByWo({});
    }

    setLoading(false);
  }, [q, status, supabase]);

  useEffect(() => {
    void load();
  }, [load]);

  const total = rows.length;
  const activeCount = useMemo(
    () =>
      rows.filter((r) =>
        NORMAL_FLOW_STATUSES.includes(
          (r.status ?? "awaiting").toLowerCase().replaceAll(
            " ",
            "_",
          ) as StatusKey,
        ),
      ).length,
    [rows],
  );
  const awaitingApprovalCount = useMemo(
    () =>
      rows.filter(
        (r) => (r.status ?? "").toLowerCase() === "awaiting_approval",
      ).length,
    [rows],
  );

  const openAssignModalForWo = (woId: string) => {
    const lineId = primaryLineByWo[woId];
    if (!lineId) {
      toast.error("No job lines on this work order yet.");
      return;
    }
    setAssignModalLineId(lineId);
    setAssignModalOpen(true);
  };

  return (
    <main className="min-h-screen bg-black text-white">
      <div className="mx-auto flex max-w-md flex-col gap-4 px-4 pb-8 pt-4">
        {/* Header */}
        <section className="rounded-2xl border border-white/10 bg-gradient-to-br from-black via-neutral-950 to-black px-4 py-4 shadow-card">
          <h1 className="font-blackops text-lg uppercase tracking-[0.2em] text-[var(--accent-copper-light)]">
            Work orders
          </h1>
          <p className="mt-1 text-[0.75rem] text-neutral-300">
            Advisor view of active jobs and their tech assignments.
          </p>

          <div className="mt-3 flex gap-4 text-[0.7rem] text-neutral-300">
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                Total
              </div>
              <div className="text-sm font-semibold text-white">{total}</div>
            </div>
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                Active
              </div>
              <div className="text-sm font-semibold text-sky-200">
                {activeCount}
              </div>
            </div>
            <div>
              <div className="uppercase tracking-[0.13em] text-neutral-500">
                Awaiting approval
              </div>
              <div className="text-sm font-semibold text-blue-200">
                {awaitingApprovalCount}
              </div>
            </div>
          </div>
        </section>

        {/* Filters */}
        <section className="space-y-2 rounded-2xl border border-white/10 bg-black/40 p-3 text-xs shadow-[0_0_40px_rgba(0,0,0,0.8)] backdrop-blur-md">
          <div>
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && void load()}
              placeholder="Search id, customer, plate, YMM‚Ä¶"
              className={INPUT_DARK}
            />
          </div>
          <div className="flex gap-2">
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className={SELECT_DARK}
            >
              <option value="">Active (normal flow)</option>
              <option value="awaiting_approval">Awaiting approval</option>
              <option value="awaiting">Awaiting</option>
              <option value="queued">Queued</option>
              <option value="in_progress">In progress</option>
              <option value="on_hold">On hold</option>
              <option value="planned">Planned</option>
              <option value="new">New</option>
              <option value="completed">Completed</option>
              <option value="ready_to_invoice">Ready to invoice</option>
              <option value="invoiced">Invoiced</option>
            </select>
            <button type="button" onClick={() => void load()} className={BUTTON_MUTED}>
              Refresh
            </button>
          </div>
        </section>

        {err && (
          <div className="rounded-xl border border-red-500/50 bg-red-950/60 px-3 py-2 text-xs text-red-100">
            {err}
          </div>
        )}

        {/* List */}
        {loading ? (
          <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-300 shadow-[0_0_40px_rgba(0,0,0,0.7)]">
            Loading work orders‚Ä¶
          </div>
        ) : rows.length === 0 ? (
          <div className="rounded-2xl border border-dashed border-white/20 bg-black/40 p-6 text-sm text-neutral-400 shadow-[0_0_40px_rgba(0,0,0,0.6)]">
            No work orders match your current filters.
          </div>
        ) : (
          <section className="space-y-2">
            {rows.map((r) => {
              const href = `/work-orders/${r.custom_id ?? r.id}?mode=view`;

              const customerName = r.customers
                ? [r.customers.first_name ?? "", r.customers.last_name ?? ""]
                    .filter(Boolean)
                    .join(" ")
                : "";

              const vehicleLabel = r.vehicles
                ? `${r.vehicles.year ?? ""} ${r.vehicles.make ?? ""} ${
                    r.vehicles.model ?? ""
                  }`.trim()
                : "";

              const plate = r.vehicles?.license_plate ?? "";

              return (
                <article
                  key={r.id}
                  className="rounded-2xl border border-white/12 bg-gradient-to-br from-neutral-950/95 via-neutral-900/90 to-black/90 px-3 py-3 text-sm shadow-[0_0_0_1px_rgba(15,23,42,0.9)]"
                >
                  <div className="flex items-start justify-between gap-2">
                    <div className="min-w-0">
                      <div className="flex flex-wrap items-center gap-1.5">
                        <Link
                          href={href}
                          className="text-sm font-semibold text-white underline decoration-neutral-600/50 underline-offset-2 hover:decoration-[var(--accent-copper-light)]"
                        >
                          {r.custom_id ? r.custom_id : `#${r.id.slice(0, 8)}`}
                        </Link>
                        {r.custom_id && (
                          <span className="rounded-full border border-white/15 bg-black/60 px-1.5 py-0.5 text-[0.6rem] font-mono text-neutral-400">
                            #{r.id.slice(0, 6)}
                          </span>
                        )}
                        <span className={statusChip(r.status)}>
                          {(r.status ?? "awaiting").replaceAll("_", " ")}
                        </span>
                      </div>

                      <div className="mt-1 text-[0.75rem] text-neutral-300">
                        {customerName || "No customer"}{" "}
                        <span className="mx-1 text-neutral-600">‚Ä¢</span>
                        {vehicleLabel || "No vehicle"}
                        {plate ? (
                          <span className="ml-1 text-neutral-400">
                            ({plate})
                          </span>
                        ) : null}
                      </div>

                      <div className="mt-1 text-[0.7rem] text-neutral-500">
                        {r.created_at
                          ? format(new Date(r.created_at), "PP p")
                          : "‚Äî"}
                      </div>
                    </div>

                    <div className="flex flex-col items-end gap-1">
                      <Link
                        href={href}
                        className="rounded-full border border-white/15 bg-white/5 px-2.5 py-1 text-[0.7rem] text-neutral-100 transition hover:border-[var(--accent-copper-light)] hover:bg-[var(--accent-copper)]/20"
                      >
                        Open
                      </Link>
                      {canAssign && (
                        <button
                          type="button"
                          onClick={() => openAssignModalForWo(r.id)}
                          className="rounded-full border border-sky-500/60 bg-sky-500/10 px-2.5 py-1 text-[0.7rem] text-sky-100 transition hover:bg-sky-500/25"
                        >
                          Assign tech
                        </button>
                      )}
                    </div>
                  </div>
                </article>
              );
            })}
          </section>
        )}

        {/* Assign-tech modal ‚Äì uses first job line on the WO */}
        <AssignTechModal
          isOpen={assignModalOpen && !!assignModalLineId}
          onClose={() => {
            setAssignModalOpen(false);
            setAssignModalLineId(null);
          }}
          workOrderLineId={assignModalLineId ?? ""}
          mechanics={mechanics}
          onAssigned={async () => {
            // after assigning, refresh the list
            await load();
          }}
        />
      </div>
    </main>
  );
}

========================================
FILE: app/onboarding/page.tsx
========================================
// app/onboarding/page.tsx
"use client";

import { Suspense } from "react";
import OnboardingPage from "@/features/auth/app/onboarding/OnboardingPage";

export default function OnboardingPageWrapper() {
  return (
    <Suspense fallback={<div className="text-white">Loading...</div>}>
      <OnboardingPage />
    </Suspense>
  );
}

========================================
FILE: app/onboarding/shop-defualts/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const TIMEZONES = [
  "America/New_York",
  "America/Chicago",
  "America/Denver",
  "America/Edmonton",
  "America/Phoenix",
  "America/Los_Angeles",
  "America/Vancouver",
  "America/Toronto",
  "America/Halifax",
] as const;

export default function ShopDefaultsStep2Page() {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);
  const router = useRouter();

  const [loading, setLoading] = useState(true);
  const [shopId, setShopId] = useState<string | null>(null);
  const [error, setError] = useState("");

  // Defaults
  const [country, setCountry] = useState<"US" | "CA">("US");
  const [province, setProvince] = useState("");
  const [timezone, setTimezone] = useState<string>("America/New_York");

  const [laborRate, setLaborRate] = useState("150");
  const [taxRate, setTaxRate] = useState("5"); // percent in UI
  const [diagnosticFee, setDiagnosticFee] = useState("");
  const [suppliesPercent, setSuppliesPercent] = useState("");

  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (!user) {
        router.replace("/sign-in");
        return;
      }

      const { data: prof } = await supabase
        .from("profiles")
        .select("role, shop_id")
        .eq("id", user.id)
        .maybeSingle();

      if (!prof?.shop_id) {
        router.replace("/onboarding");
        return;
      }

      setShopId(prof.shop_id);

      // Prefill from shops if available
      const { data: shop } = await supabase
        .from("shops")
        .select("country, province, timezone, labor_rate, tax_rate, diagnostic_fee, supplies_percent")
        .eq("id", prof.shop_id)
        .maybeSingle();

      if (shop) {
        if (shop.country === "US" || shop.country === "CA") setCountry(shop.country);
        setProvince(shop.province ?? "");
        setTimezone(shop.timezone ?? "America/New_York");
        if (typeof shop.labor_rate === "number") setLaborRate(String(shop.labor_rate));
        if (typeof shop.tax_rate === "number") setTaxRate(String(shop.tax_rate));
        if (typeof shop.diagnostic_fee === "number") setDiagnosticFee(String(shop.diagnostic_fee));
        if (typeof shop.supplies_percent === "number") setSuppliesPercent(String(shop.supplies_percent));
      }

      setLoading(false);
    })();
  }, [router, supabase]);

  const provinceLabel = country === "CA" ? "Province" : "State";
  const taxLabel = country === "CA" ? "Tax rate (GST/PST/HST %)": "Tax rate (Sales tax %)";
  const currency = country === "CA" ? "CAD" : "USD";

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");

    if (!province.trim()) {
      setError(`Please enter a ${provinceLabel}.`);
      return;
    }

    const res = await fetch("/api/onboarding/shop-defaults", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        country,
        province,
        timezone,
        labor_rate: Number(laborRate),
        tax_rate: Number(taxRate),
        diagnostic_fee: diagnosticFee ? Number(diagnosticFee) : null,
        supplies_percent: suppliesPercent ? Number(suppliesPercent) : null,
      }),
    });

    if (!res.ok) {
      const j = await res.json().catch(() => ({}));
      setError(j?.error || "Failed to save defaults.");
      return;
    }

    router.replace("/dashboard/owner");
  };

  if (loading) {
    return (
      <div className="min-h-screen grid place-items-center bg-black text-white">
        <div className="rounded-lg border border-neutral-800 bg-neutral-950 px-4 py-3 text-xs text-neutral-300">
          Loading step 2‚Ä¶
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black text-white">
      <header className="border-b border-neutral-900 bg-neutral-950/70 px-4 py-4 sm:px-6">
        <div className="mx-auto max-w-3xl">
          <p className="text-xs uppercase tracking-[0.2em] text-neutral-500">
            ProFixIQ ‚Ä¢ Onboarding
          </p>
          <h1 className="text-xl font-blackops text-orange-400">
            Shop defaults (Step 2 of 2)
          </h1>
          <p className="text-xs text-neutral-400">
            This makes invoices, quotes, totals, and taxes correct from day one.
          </p>
        </div>
      </header>

      <main className="mx-auto max-w-3xl px-4 py-6 sm:px-6">
        <form onSubmit={onSubmit} className="space-y-6">
          <section className="rounded-xl border border-neutral-800 bg-neutral-950 p-4 sm:p-5">
            <h2 className="text-sm font-semibold text-neutral-100">
              Location + formatting
            </h2>
            <p className="mt-1 text-[11px] text-neutral-500">
              Country controls labels, currency display ({currency}), and tax wording.
            </p>

            <div className="mt-4 grid gap-3 md:grid-cols-2">
              <div className="space-y-1">
                <label className="text-xs text-neutral-300">Country</label>
                <select
                  value={country}
                  onChange={(e) => setCountry(e.target.value as "US" | "CA")}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                >
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                </select>
              </div>

              <div className="space-y-1">
                <label className="text-xs text-neutral-300">Timezone</label>
                <select
                  value={timezone}
                  onChange={(e) => setTimezone(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                >
                  {TIMEZONES.map((tz) => (
                    <option key={tz} value={tz}>
                      {tz}
                    </option>
                  ))}
                </select>
              </div>

              <div className="space-y-1 md:col-span-2">
                <label className="text-xs text-neutral-300">{provinceLabel}</label>
                <input
                  value={province}
                  onChange={(e) => setProvince(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                  placeholder={provinceLabel}
                />
              </div>
            </div>
          </section>

          <section className="rounded-xl border border-neutral-800 bg-neutral-950 p-4 sm:p-5">
            <h2 className="text-sm font-semibold text-neutral-100">
              Money defaults
            </h2>
            <p className="mt-1 text-[11px] text-neutral-500">
              These become your shop-wide defaults (can be changed later).
            </p>

            <div className="mt-4 grid gap-3 md:grid-cols-2">
              <div className="space-y-1">
                <label className="text-xs text-neutral-300">
                  Labor rate ({currency}/hr)
                </label>
                <input
                  value={laborRate}
                  onChange={(e) => setLaborRate(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                  inputMode="decimal"
                />
              </div>

              <div className="space-y-1">
                <label className="text-xs text-neutral-300">{taxLabel}</label>
                <input
                  value={taxRate}
                  onChange={(e) => setTaxRate(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                  inputMode="decimal"
                />
              </div>

              <div className="space-y-1">
                <label className="text-xs text-neutral-300">
                  Diagnostic fee ({currency})
                </label>
                <input
                  value={diagnosticFee}
                  onChange={(e) => setDiagnosticFee(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                  inputMode="decimal"
                  placeholder="Optional"
                />
              </div>

              <div className="space-y-1">
                <label className="text-xs text-neutral-300">
                  Supplies percent (%)
                </label>
                <input
                  value={suppliesPercent}
                  onChange={(e) => setSuppliesPercent(e.target.value)}
                  className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
                  inputMode="decimal"
                  placeholder="Optional"
                />
              </div>
            </div>
          </section>

          {error && (
            <div className="rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm text-red-200">
              {error}
            </div>
          )}

          <div className="flex items-center gap-3">
            <button
              type="submit"
              className="inline-flex items-center justify-center rounded-md bg-orange-500 px-4 py-2 text-sm font-semibold text-black shadow-sm transition hover:bg-orange-400"
            >
              Finish setup
            </button>
            {shopId ? (
              <span className="text-[11px] text-neutral-500">
                Shop ID: {shopId}
              </span>
            ) : null}
          </div>
        </form>
      </main>
    </div>
  );
}

========================================
FILE: app/page.tsx
========================================
"use client";

// app/page.tsx
import ProFixIQLanding from "@shared/components/ProFixIQLanding";

export default function Page() {
  return <ProFixIQLanding />;
}

========================================
FILE: app/parts/inventory/page.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { v4 as uuidv4 } from "uuid";

/* ----------------------------- Types ----------------------------- */

type DB = Database;
type Part = DB["public"]["Tables"]["parts"]["Row"];
type PartInsert = DB["public"]["Tables"]["parts"]["Insert"];
type PartUpdate = DB["public"]["Tables"]["parts"]["Update"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];
type StockMove = DB["public"]["Tables"]["stock_moves"]["Row"];

// app-side view of the enum
type StockMoveReason = "receive" | "adjust" | "consume" | "transfer";

/* --------------------------- UI helpers -------------------------- */

function Modal(props: {
  open: boolean;
  title: string;
  onClose: () => void;
  children: React.ReactNode;
  footer?: React.ReactNode;
  widthClass?: string;
}) {
  const { open, title, onClose, children, footer, widthClass = "max-w-xl" } = props;
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
      <div
        className={`w-full ${widthClass} rounded border border-orange-500 bg-neutral-950 p-4 text-white shadow-xl`}
        onClick={(e) => e.stopPropagation()}
        role="dialog"
        aria-modal="true"
      >
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-lg font-semibold">{title}</h2>
          <button
            onClick={onClose}
            className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
            aria-label="Close"
          >
            ‚úï
          </button>
        </div>
        <div>{children}</div>
        {footer ? <div className="mt-4">{footer}</div> : null}
      </div>
    </div>
  );
}

function TextField(props: {
  label: string;
  value: string;
  placeholder?: string;
  onChange: (v: string) => void;
}) {
  const { label, value, placeholder, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <input
        className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
      />
    </div>
  );
}

function NumberField(props: {
  label: string;
  value: number | "";
  min?: number;
  step?: number;
  onChange: (v: number | "") => void;
}) {
  const { label, value, min = 0, step = 0.01, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <input
        type="number"
        className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
        value={value === "" ? "" : value}
        min={min}
        step={step}
        onChange={(e) => {
          const raw = e.target.value;
          onChange(raw === "" ? "" : Number(raw));
        }}
      />
    </div>
  );
}

function SelectField(props: {
  label: string;
  value: string;
  options: { value: string; label: string }[];
  onChange: (v: string) => void;
}) {
  const { label, value, options, onChange } = props;
  return (
    <div>
      <div className="mb-1 text-xs text-neutral-400">{label}</div>
      <select
        className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
        value={value}
        onChange={(e) => onChange(e.target.value)}
      >
        {options.map((o) => (
          <option key={o.value} value={o.value}>
            {o.label}
          </option>
        ))}
      </select>
    </div>
  );
}

/* ---------------------- CSV parsing helper ---------------------- */

function parseCSV(text: string): string[][] {
  const rows: string[][] = [];
  let row: string[] = [];
  let cell = "";
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (inQuotes) {
      if (ch === '"') {
        const next = text[i + 1];
        if (next === '"') {
          cell += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        cell += ch;
      }
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === ",") {
        row.push(cell.trim());
        cell = "";
      } else if (ch === "\n") {
        row.push(cell.trim());
        rows.push(row);
        row = [];
        cell = "";
      } else if (ch !== "\r") {
        cell += ch;
      }
    }
  }
  if (cell.length > 0 || row.length > 0) {
    row.push(cell.trim());
    rows.push(row);
  }
  return rows.filter((r) => r.length > 0 && r.some((c) => c.length > 0));
}

/* ------------------------- Error helper ------------------------- */
function errMsg(err: unknown): string {
  if (typeof err === "string") return err;
  if (err && typeof err === "object" && "message" in err) {
    return String((err as Record<string, unknown>).message);
  }
  try {
    return JSON.stringify(err);
  } catch {
    return String(err);
  }
}

/* ------------------------- RPC helper --------------------------- */
/** Try 6-arg function first; if schema cache hasn‚Äôt picked it up,
 * fall back to the 5-arg legacy shape. Strictly typed; ignores return value.
 */
async function applyStockMoveRPC(
  supabase: ReturnType<typeof createClientComponentClient<DB>>,
  args: {
    p_part: string;
    p_loc: string;
    p_qty: number;
    p_reason: StockMoveReason;
    p_ref_kind: string;
    p_ref_id?: string | null;
  },
): Promise<void> {
  type FnArgs = DB["public"]["Functions"]["apply_stock_move"]["Args"];

  // 6-arg (conditionally include p_ref_id so shapes match)
  const payload6 = {
    p_part: args.p_part,
    p_loc: args.p_loc,
    p_qty: args.p_qty,
    p_reason: args.p_reason as FnArgs extends { p_reason: infer R } ? R : never,
    p_ref_kind: args.p_ref_kind,
    ...(args.p_ref_id !== undefined ? { p_ref_id: args.p_ref_id } : {}),
  } as FnArgs;

  const call6 = await supabase.rpc("apply_stock_move", payload6);
  if (!call6.error) return;

  const msg = (call6.error?.message ?? "").toLowerCase();
  const cacheShapeIssue =
    msg.includes("could not find the function") ||
    msg.includes("schema cache") ||
    msg.includes("function apply_stock_move(");

  if (!cacheShapeIssue) throw new Error(call6.error?.message ?? "apply_stock_move failed");

  // 5-arg (legacy, no p_ref_id)
  const payload5 = {
    p_part: args.p_part,
    p_loc: args.p_loc,
    p_qty: args.p_qty,
    p_reason: args.p_reason as FnArgs extends { p_reason: infer R } ? R : never,
    p_ref_kind: args.p_ref_kind,
  } as FnArgs;

  const call5 = await supabase.rpc("apply_stock_move", payload5);
  if (call5.error) {
    throw new Error(call5.error.message ?? "apply_stock_move failed");
  }
}

/* ---------------------------- Page ---------------------------- */

export default function InventoryPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string>("");
  const [search, setSearch] = useState<string>("");
  const [parts, setParts] = useState<Part[]>([]);
  const [loading, setLoading] = useState<boolean>(true);

  // stock locations
  const [locs, setLocs] = useState<StockLoc[]>([]);

  // on-hand map: partId -> total qty
  const [onHand, setOnHand] = useState<Record<string, number>>({});
  // per-location detail modal
  const [ohOpen, setOhOpen] = useState<boolean>(false);
  const [ohForPart, setOhForPart] = useState<Part | null>(null);
  const [ohLines, setOhLines] = useState<{ location: string; qty: number }[]>([]);

  // add modal
  const [addOpen, setAddOpen] = useState<boolean>(false);
  const [name, setName] = useState<string>("");
  const [sku, setSku] = useState<string>("");
  const [category, setCategory] = useState<string>("");
  const [price, setPrice] = useState<number | "">("");

  // initial receive (optional) for Add
  const [initLoc, setInitLoc] = useState<string>("");
  const [initQty, setInitQty] = useState<number | "">("");

  // edit modal
  const [editOpen, setEditOpen] = useState<boolean>(false);
  const [editPart, setEditPart] = useState<Part | null>(null);
  const [editName, setEditName] = useState<string>("");
  const [editSku, setEditSku] = useState<string>("");
  const [editCategory, setEditCategory] = useState<string>("");
  const [editPrice, setEditPrice] = useState<number | "">("");

  // receive modal (standalone quick receive)
  const [recvOpen, setRecvOpen] = useState<boolean>(false);
  const [recvPart, setRecvPart] = useState<Part | null>(null);
  const [recvLoc, setRecvLoc] = useState<string>("");
  const [recvQty, setRecvQty] = useState<number | "">("");

  // CSV Import
  const [csvOpen, setCsvOpen] = useState<boolean>(false);
  const [csvText, setCsvText] = useState<string>("");
  const [csvRows, setCsvRows] = useState<
    { name: string; sku?: string; category?: string; price?: number; qty?: number }[]
  >([]);
  const [csvPreview, setCsvPreview] = useState<boolean>(false);
  const [csvDefaultLoc, setCsvDefaultLoc] = useState<string>("");

  // ---------- on-hand loader (pass sid directly; avoids first-render zeros)
  const loadOnHand = useCallback(
    async (sid: string, partIds: string[]) => {
      if (!partIds.length) {
        setOnHand({});
        return;
      }
      const { data, error } = await supabase
        .from("stock_moves")
        .select("part_id, qty_change")
        .in("part_id", partIds)
        .eq("shop_id", sid);

      if (error || !data) {
        setOnHand({});
        return;
      }

      const totals: Record<string, number> = {};
      (data as StockMove[]).forEach((m) => {
        const delta = Number(m.qty_change) || 0;
        totals[m.part_id] = (totals[m.part_id] ?? 0) + delta;
      });
      setOnHand(totals);
    },
    [supabase],
  );

  const load = async (sid: string) => {
    setLoading(true);
    const base = supabase
      .from("parts")
      .select("*")
      .eq("shop_id", sid)
      .order("name", { ascending: true });

    const { data, error } = await (search.trim()
      ? base.or(
          [
            `name.ilike.%${search}%`,
            `sku.ilike.%${search}%`,
            `category.ilike.%${search}%`,
          ].join(","),
        )
      : base);

    const partRows = (!error && (data as Part[])) || [];
    setParts(partRows);
    setLoading(false);

    void loadOnHand(sid, partRows.map((p) => p.id));
  };

  // --- on-hand detail (per-location)
  const openOnHandDetail = async (p: Part) => {
    setOhForPart(p);
    const { data, error } = await supabase
      .from("stock_moves")
      .select("location_id, qty_change")
      .eq("part_id", p.id)
      .eq("shop_id", shopId);

    if (error || !data) {
      setOhLines([]);
      setOhOpen(true);
      return;
    }

    const byLoc: Record<string, number> = {};
    (data as StockMove[]).forEach((r) => {
      const loc = r.location_id as string;
      const q = Number(r.qty_change) || 0;
      byLoc[loc] = (byLoc[loc] ?? 0) + q;
    });

    const lines = locs
      .map((l) => ({
        location: `${l.code ?? "LOC"} ‚Äî ${l.name ?? ""}`,
        qty: byLoc[l.id] ?? 0,
      }))
      .filter((x) => x.qty !== 0);

    setOhLines(lines);
    setOhOpen(true);
  };

  /* boot */
  useEffect(() => {
    (async () => {
      const { data: u } = await supabase.auth.getUser();
      const uid = u.user?.id ?? null;
      if (!uid) return;

      const { data: prof } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .maybeSingle();

      const sid = (prof?.shop_id as string) || "";
      setShopId(sid);
      if (!sid) return;

      const { data: l } = await supabase
        .from("stock_locations")
        .select("*")
        .eq("shop_id", sid)
        .order("code");

      const locRows = (l as StockLoc[]) ?? [];
      setLocs(locRows);

      const main = locRows.find((x) => (x.code ?? "").toUpperCase() === "MAIN");
      if (main) {
        setInitLoc(main.id);
        setRecvLoc(main.id);
        setCsvDefaultLoc(main.id);
      }

      await load(sid);
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase]);

  /* refetch on search */
  useEffect(() => {
    if (shopId) void load(shopId);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [search, shopId]);

  /* ----------------------- CRUD handlers ----------------------- */

  const createPart = async () => {
    if (!shopId || !name.trim()) return;

    const id = uuidv4();
    const insert: PartInsert = {
      id,
      shop_id: shopId,
      name: name.trim(),
      sku: sku.trim() ? sku.trim() : undefined,
      category: category.trim() ? category.trim() : undefined,
      price: typeof price === "number" ? price : undefined,
    };

    const { error } = await supabase.from("parts").insert(insert);
    if (error) {
      alert(error.message);
      return;
    }

    // optional initial receive
    if (initLoc && typeof initQty === "number" && initQty > 0) {
      try {
        await applyStockMoveRPC(supabase, {
          p_part: id,
          p_loc: initLoc,
          p_qty: initQty,
          p_reason: "receive",
          p_ref_kind: "manual_receive",
          p_ref_id: null,
        });
      } catch (err: unknown) {
        alert(`Part created, but stock receive failed: ${errMsg(err)}`);
      }
    }

    setAddOpen(false);
    setName("");
    setSku("");
    setCategory("");
    setPrice("");
    setInitQty("");
    await load(shopId);
  };

  const openEdit = (p: Part) => {
    setEditPart(p);
    setEditName(p.name ?? "");
    setEditSku(p.sku ?? "");
    setEditCategory(p.category ?? "");
    setEditPrice(typeof p.price === "number" ? p.price : "");
    setEditOpen(true);
  };

  const saveEdit = async () => {
    if (!editPart?.id) return;

    const patch: PartUpdate = {
      name: editName.trim() ? editName.trim() : undefined,
      sku: editSku.trim() ? editSku.trim() : undefined,
      category: editCategory.trim() ? editCategory.trim() : undefined,
      price: typeof editPrice === "number" ? editPrice : undefined,
    };

    const { error } = await supabase.from("parts").update(patch).eq("id", editPart.id);
    if (error) {
      alert(error.message);
      return;
    }

    setEditOpen(false);
    await load(shopId);
  };

  const openReceive = (p: Part) => {
    setRecvPart(p);
    setRecvQty("");
    setRecvOpen(true);
  };

  const applyReceive = async () => {
    if (!recvPart?.id || !recvLoc || typeof recvQty !== "number" || recvQty <= 0) return;
    try {
      await applyStockMoveRPC(supabase, {
        p_part: recvPart.id,
        p_loc: recvLoc,
        p_qty: recvQty,
        p_reason: "receive",
        p_ref_kind: "manual_receive",
        p_ref_id: null,
      });
      setRecvOpen(false);
      await load(shopId);
    } catch (err: unknown) {
      alert(errMsg(err));
    }
  };

  /* -------------------------- CSV Import -------------------------- */

  const parseAndPreviewCSV = (raw: string) => {
    const rows = parseCSV(raw);
    if (!rows.length) {
      setCsvRows([]);
      setCsvPreview(false);
      return;
    }
    const header = rows[0].map((h) => h.toLowerCase().trim());
    const idx = {
      name: header.indexOf("name"),
      sku: header.indexOf("sku"),
      category: header.indexOf("category"),
      price: header.indexOf("price"),
      qty: header.indexOf("qty"),
    };

    const out: { name: string; sku?: string; category?: string; price?: number; qty?: number }[] = [];

    for (let r = 1; r < rows.length; r++) {
      const row = rows[r];
      const name = idx.name >= 0 ? row[idx.name] : "";
      if (!name) continue;
      const sku = idx.sku >= 0 ? row[idx.sku] : undefined;
      const category = idx.category >= 0 ? row[idx.category] : undefined;
      const priceStr = idx.price >= 0 ? row[idx.price] : undefined;
      const qtyStr = idx.qty >= 0 ? row[idx.qty] : undefined;

      const price = priceStr && priceStr.length ? Number(priceStr) : undefined;
      const qty = qtyStr && qtyStr.length ? Number(qtyStr) : undefined;

      out.push({
        name,
        sku: sku && sku.length ? sku : undefined,
        category: category && category.length ? category : undefined,
        price: typeof price === "number" && !Number.isNaN(price) ? price : undefined,
        qty: typeof qty === "number" && !Number.isNaN(qty) ? qty : undefined,
      });
    }

    setCsvRows(out);
    setCsvPreview(true);
  };

  const handleCsvFile = async (file: File) => {
    const text = await file.text();
    setCsvText(text);
    parseAndPreviewCSV(text);
  };

  const runCsvImport = async () => {
    if (!shopId || !csvRows.length) return;

    for (const row of csvRows) {
      let partId: string | null = null;

      if (row.sku) {
        const { data: found } = await supabase
          .from("parts")
          .select("id")
          .eq("shop_id", shopId)
          .eq("sku", row.sku)
          .maybeSingle();
        if (found?.id) partId = found.id;
      }

      if (!partId) {
        const id = uuidv4();
        const insert: PartInsert = {
          id,
          shop_id: shopId,
          name: row.name,
          sku: row.sku || undefined,
          category: row.category || undefined,
          price: typeof row.price === "number" ? row.price : undefined,
        };
        const { error } = await supabase.from("parts").insert(insert);
        if (error) {
          console.warn("Insert failed:", row, error.message);
          continue;
        }
        partId = id;
      } else {
        const patch: PartUpdate = {
          name: row.name || undefined,
          sku: row.sku || undefined,
          category: row.category || undefined,
          price: typeof row.price === "number" ? row.price : undefined,
        };
        await supabase.from("parts").update(patch).eq("id", partId);
      }

      if (partId && csvDefaultLoc && typeof row.qty === "number" && row.qty > 0) {
        try {
          await applyStockMoveRPC(supabase, {
            p_part: partId,
            p_loc: csvDefaultLoc,
            p_qty: row.qty,
            p_reason: "receive",
            p_ref_kind: "csv_import",
            p_ref_id: null,
          });
        } catch (err: unknown) {
          console.warn("Stock receive failed for row:", row, errMsg(err));
        }
      }
    }

    setCsvOpen(false);
    setCsvPreview(false);
    setCsvText("");
    setCsvRows([]);
    await load(shopId);
  };

  /* ----------------------------- UI ----------------------------- */

  return (
    <div className="space-y-4 p-6 text-white">
      <div className="flex flex-wrap items-center justify-between gap-3">
        <h1 className="text-2xl font-bold">Inventory</h1>
        <div className="flex items-center gap-2">
          <input
            className="w-64 rounded border border-neutral-700 bg-neutral-900 p-2 text-sm"
            placeholder="Search name / SKU / category"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />
          <button
            className="font-header rounded border border-orange-500 px-3 py-1.5 text-sm hover:bg-orange-500/10 disabled:opacity-60"
            onClick={() => setAddOpen(true)}
            disabled={!shopId}
          >
            Add Part
          </button>
          <button
            className="font-header rounded border border-blue-600 px-3 py-1.5 text-sm text-blue-300 hover:bg-blue-900/20 disabled:opacity-60"
            onClick={() => setCsvOpen(true)}
            disabled={!shopId}
          >
            CSV Import
          </button>
        </div>
      </div>

      {loading ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm text-neutral-400">
          Loading‚Ä¶
        </div>
      ) : parts.length === 0 ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm text-neutral-400">
          No parts yet. Click ‚ÄúAdd Part‚Äù to create your first item or use CSV Import.
        </div>
      ) : (
        <div className="overflow-hidden rounded border border-neutral-800 bg-neutral-900">
          <table className="w-full text-sm">
            <thead className="bg-neutral-900">
              <tr className="text-left text-neutral-400">
                <th className="p-2">Name</th>
                <th className="p-2">SKU</th>
                <th className="p-2">Category</th>
                <th className="p-2">Price</th>
                <th className="p-2">On hand</th>
                <th className="p-2 w-48 text-right">Actions</th>
              </tr>
            </thead>
            <tbody>
              {parts.map((p) => {
                const total = onHand[p.id] ?? 0;
                return (
                  <tr key={p.id} className="border-t border-neutral-800">
                    <td className="p-2">{p.name}</td>
                    <td className="p-2">{p.sku ?? "‚Äî"}</td>
                    <td className="p-2">{p.category ?? "‚Äî"}</td>
                    <td className="p-2">
                      {typeof p.price === "number" ? `$${p.price.toFixed(2)}` : "‚Äî"}
                    </td>
                    <td className="p-2">
                      <button
                        className="rounded border border-neutral-700 px-2 py-0.5 text-xs hover:bg-neutral-800"
                        onClick={() => openOnHandDetail(p)}
                        title="View per-location balance"
                      >
                        {total}
                      </button>
                    </td>
                    <td className="p-2">
                      <div className="flex justify-end gap-2">
                        <button
                          className="rounded border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800"
                          onClick={() => openEdit(p)}
                        >
                          Edit
                        </button>
                        <button
                          className="rounded border border-blue-600 px-2 py-1 text-xs text-blue-300 hover:bg-blue-900/20"
                          onClick={() => openReceive(p)}
                        >
                          Receive
                        </button>
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {/* Add Part */}
      <Modal
        open={addOpen}
        title="Add Part"
        onClose={() => setAddOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button
              className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
              onClick={() => setAddOpen(false)}
            >
              Cancel
            </button>
            <button
              className="rounded border border-orange-500 px-3 py-1.5 text-sm hover:bg-orange-500/10 disabled:opacity-60"
              onClick={createPart}
              disabled={!name.trim()}
            >
              Save Part
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <div className="sm:col-span-2">
            <TextField label="Name*" value={name} onChange={setName} placeholder="Part name" />
          </div>
          <TextField label="SKU" value={sku} onChange={setSku} placeholder="Optional" />
          <TextField label="Category" value={category} onChange={setCategory} placeholder="Optional" />
          <NumberField
            label="Price"
            value={price}
            onChange={(v) => setPrice(v === "" ? "" : v)}
          />
        </div>

        <div className="mt-4 rounded border border-neutral-800 bg-neutral-900 p-3">
          <div className="mb-2 text-sm font-semibold">Initial Stock (optional)</div>
          <div className="grid gap-3 sm:grid-cols-2">
            <SelectField
              label="Location"
              value={initLoc}
              onChange={setInitLoc}
              options={[
                { value: "", label: "‚Äî none ‚Äî" },
                ...locs.map((l) => ({
                  value: l.id,
                  label: `${l.code ?? "LOC"} ‚Äî ${l.name ?? ""}`,
                })),
              ]}
            />
            <NumberField
              label="Qty"
              value={initQty}
              min={0}
              step={1}
              onChange={(v) => setInitQty(v === "" ? "" : Math.max(0, v))}
            />
          </div>
        </div>
      </Modal>

      {/* Edit Part */}
      <Modal
        open={editOpen}
        title="Edit Part"
        onClose={() => setEditOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button
              className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
              onClick={() => setEditOpen(false)}
            >
              Cancel
            </button>
            <button
              className="rounded border border-orange-500 px-3 py-1.5 text-sm hover:bg-orange-500/10 disabled:opacity-60"
              onClick={saveEdit}
              disabled={!editName.trim()}
            >
              Save Changes
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <div className="sm:col-span-2">
            <TextField label="Name*" value={editName} onChange={setEditName} />
          </div>
          <TextField label="SKU" value={editSku} onChange={setEditSku} />
          <TextField label="Category" value={editCategory} onChange={setEditCategory} />
          <NumberField label="Price" value={editPrice} onChange={(v) => setEditPrice(v === "" ? "" : v)} />
        </div>
      </Modal>

      {/* Receive Stock */}
      <Modal
        open={recvOpen}
        title={recvPart ? `Receive ‚Äî ${recvPart.name}` : "Receive Stock"}
        onClose={() => setRecvOpen(false)}
        footer={
          <div className="flex justify-end gap-2">
            <button
              className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
              onClick={() => setRecvOpen(false)}
            >
              Cancel
            </button>
            <button
              className="rounded border border-blue-600 px-3 py-1.5 text-sm text-blue-300 hover:bg-blue-900/20 disabled:opacity-60"
              onClick={applyReceive}
              disabled={!recvPart?.id || !recvLoc || typeof recvQty !== "number" || recvQty <= 0}
            >
              Apply Receive
            </button>
          </div>
        }
      >
        <div className="grid gap-3 sm:grid-cols-2">
          <SelectField
            label="Location"
            value={recvLoc}
            onChange={setRecvLoc}
            options={locs.map((l) => ({
              value: l.id,
              label: `${l.code ?? "LOC"} ‚Äî ${l.name ?? ""}`,
            }))}
          />
          <NumberField
            label="Qty"
            value={recvQty}
            min={0}
            step={1}
            onChange={(v) => setRecvQty(v === "" ? "" : Math.max(0, v))}
          />
        </div>
      </Modal>

      {/* On-hand detail */}
      <Modal
        open={ohOpen}
        title={ohForPart ? `On hand ‚Äî ${ohForPart.name}` : "On hand"}
        onClose={() => setOhOpen(false)}
        widthClass="max-w-lg"
      >
        {ohLines.length === 0 ? (
          <div className="text-sm text-neutral-400">No movement found for this part.</div>
        ) : (
          <div className="rounded border border-neutral-800">
            <table className="w-full text-sm">
              <thead className="text-left text-neutral-400">
                <tr>
                  <th className="p-2">Location</th>
                  <th className="p-2">Qty</th>
                </tr>
              </thead>
              <tbody>
                {ohLines.map((l, i) => (
                  <tr key={i} className="border-t border-neutral-800">
                    <td className="p-2">{l.location}</td>
                    <td className="p-2">{l.qty}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </Modal>

      {/* CSV Import */}
      <Modal
        open={csvOpen}
        title="CSV Import"
        onClose={() => setCsvOpen(false)}
        widthClass="max-w-3xl"
        footer={
          <div className="flex w-full flex-wrap items-center justify-between gap-3">
            <div className="flex items-center gap-2">
              <SelectField
                label="Default receive location (for rows with qty)"
                value={csvDefaultLoc}
                onChange={setCsvDefaultLoc}
                options={[
                  { value: "", label: "‚Äî none ‚Äî" },
                  ...locs.map((l) => ({ value: l.id, label: `${l.code ?? "LOC"} ‚Äî ${l.name ?? ""}` })),
                ]}
              />
            </div>
            <div className="flex items-center gap-2">
              <button
                className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
                onClick={() => {
                  setCsvPreview(false);
                  setCsvText("");
                  setCsvRows([]);
                  setCsvOpen(false);
                }}
              >
                Close
              </button>
              <button
                className="rounded border border-blue-600 px-3 py-1.5 text-sm text-blue-300 hover:bg-blue-900/20 disabled:opacity-60"
                onClick={runCsvImport}
                disabled={!csvPreview || csvRows.length === 0}
              >
                Import
              </button>
            </div>
          </div>
        }
      >
        <div className="grid gap-3">
          <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm text-neutral-300">
            Expected headers (case-insensitive): <code>name, sku, category, price, qty</code>. Extra columns are ignored.
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <input
              type="file"
              accept=".csv,text/csv"
              onChange={(e) => {
                const f = e.target.files?.[0];
                if (f) void handleCsvFile(f);
              }}
              className="text-sm"
            />
            <button
              className="rounded border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800"
              onClick={() => {
                if (csvText.trim().length) parseAndPreviewCSV(csvText);
              }}
            >
              Parse text
            </button>
          </div>

          <textarea
            rows={8}
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-sm"
            placeholder={`Paste CSV here‚Ä¶ e.g.:
name,sku,category,price,qty
Oil Filter ‚Äì Ford,OF-FORD-01,Filters,9.95,10
Spark Plug ‚Äì Iridium,SP-IR-01,Ignition,9.95,24
`}
            value={csvText}
            onChange={(e) => setCsvText(e.target.value)}
          />

          {csvPreview && (
            <div className="rounded border border-neutral-800">
              <table className="w-full text-sm">
                <thead className="text-left text-neutral-400">
                  <tr>
                    <th className="p-2">Name</th>
                    <th className="p-2">SKU</th>
                    <th className="p-2">Category</th>
                    <th className="p-2">Price</th>
                    <th className="p-2">Qty</th>
                  </tr>
                </thead>
                <tbody>
                  {csvRows.map((r, i) => (
                    <tr key={i} className="border-t border-neutral-800">
                      <td className="p-2">{r.name}</td>
                      <td className="p-2">{r.sku ?? "‚Äî"}</td>
                      <td className="p-2">{r.category ?? "‚Äî"}</td>
                      <td className="p-2">{typeof r.price === "number" ? r.price.toFixed(2) : "‚Äî"}</td>
                      <td className="p-2">{typeof r.qty === "number" ? r.qty : "‚Äî"}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </Modal>
    </div>
  );
}

========================================
FILE: app/parts/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type PartRow = DB["public"]["Tables"]["parts"]["Row"];
type StockMoveRow = DB["public"]["Tables"]["stock_moves"]["Row"];
type RequestRow = DB["public"]["Tables"]["part_requests"]["Row"];

// ---------- UI helpers ----------

function Sparkline({
  points,
  width = 120,
  height = 28,
}: {
  points: number[];
  width?: number;
  height?: number;
}) {
  if (!points.length) {
    return (
      <svg width={width} height={height} aria-hidden>
        <line
          x1="0"
          x2={width}
          y1={height / 2}
          y2={height / 2}
          stroke="currentColor"
          opacity={0.2}
        />
      </svg>
    );
  }
  const min = Math.min(...points);
  const max = Math.max(...points);
  const range = max - min || 1;
  const stepX = width / Math.max(1, points.length - 1);
  const path = points
    .map((v, i) => {
      const x = i * stepX;
      const y = height - ((v - min) / range) * height;
      return `${i === 0 ? "M" : "L"} ${x.toFixed(2)} ${y.toFixed(2)}`;
    })
    .join(" ");
  return (
    <svg width={width} height={height} aria-hidden>
      <path d={path} fill="none" stroke="currentColor" />
    </svg>
  );
}

// shared card primitives (mirrors main dashboard look)
function OverviewCard({
  title,
  value,
  href,
}: {
  title: string;
  value: React.ReactNode;
  href?: string;
}) {
  const content = (
    <div className="group relative overflow-hidden rounded-xl border border-white/10 bg-white/[0.04] px-4 py-4 shadow-card backdrop-blur-md transition hover:border-accent hover:shadow-glow">
      <div className="pointer-events-none absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.12),transparent_60%)] opacity-0 transition-opacity group-hover:opacity-100" />
      <div className="relative">
        <p className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
          {title}
        </p>
        <div className="mt-2 text-2xl font-semibold text-white">{value}</div>
      </div>
    </div>
  );

  if (href) {
    return (
      <Link href={href} className="block">
        {content}
      </Link>
    );
  }
  return content;
}

function QuickButton({
  href,
  children,
  accent,
}: {
  href: string;
  children: React.ReactNode;
  accent?: boolean;
}) {
  return (
    <Link
      href={href}
      className={`inline-flex items-center gap-2 rounded-md border px-4 py-2 text-sm text-whitetypedefs shadow-sm backdrop-blur-md transition ${
        accent
          ? "border-orange-400/60 bg-white/[0.03] hover:bg-orange-500/10 hover:border-orange-400"
          : "border-neutral-700 bg-white/[0.02] hover:bg-neutral-800/80"
      }`}
    >
      {children}
    </Link>
  );
}

// ---------- Page ----------
export default function PartsDashboardPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [loading, setLoading] = useState(true);

  // KPIs
  const [skuTotal, setSkuTotal] = useState<number>(0);
  const [skuNewThis7d, setSkuNewThis7d] = useState<number>(0);

  const [moves7dCount, setMoves7dCount] = useState<number>(0);
  const [moves30Spark, setMoves30Spark] = useState<number[]>([]);

  const [openRequestsCount, setOpenRequestsCount] = useState<number | null>(
    null,
  );

  // Recent moves (list)
  const [recentMoves, setRecentMoves] = useState<
    Pick<
      StockMoveRow,
      "id" | "created_at" | "reason" | "qty_change" | "part_id"
    >[]
  >([]);

  useEffect(() => {
    (async () => {
      setLoading(true);

      const now = new Date();
      const d7Ago = new Date(now.getTime() - 7 * 24 * 3600 * 1000);
      const d30Ago = new Date(now.getTime() - 30 * 24 * 3600 * 1000);

      // -------- parts (for SKUs + 7d new) --------
      const { data: parts, error: perr } = await supabase
        .from("parts")
        .select("id, created_at");

      if (perr) {
        // eslint-disable-next-line no-console
        console.error("[parts] load failed:", perr);
      }
      const partsRows = (parts ?? []) as Pick<
        PartRow,
        "id" | "created_at"
      >[];

      setSkuTotal(partsRows.length);

      const createdInLast7 = partsRows.filter((p) => {
        const ts = p.created_at ? new Date(p.created_at) : null;
        return !!ts && ts >= d7Ago && ts < now;
      }).length;
      setSkuNewThis7d(createdInLast7);

      // -------- stock_moves (for 7d count + 30d sparkline + list) --------
      const { data: moves, error: merr } = await supabase
        .from("stock_moves")
        .select("id, part_id, qty_change, reason, created_at")
        .gte("created_at", d30Ago.toISOString())
        .order("created_at", { ascending: true });

      if (merr) {
        // eslint-disable-next-line no-console
        console.error("[stock_moves] load failed:", merr);
      }

      const mv = (moves ?? []) as Pick<
        StockMoveRow,
        "id" | "part_id" | "qty_change" | "reason" | "created_at"
      >[];

      // 7d moves count
      setMoves7dCount(
        mv.filter((m) => new Date(m.created_at) >= d7Ago).length,
      );

      // 30-day sparkline (daily net qty_change)
      const days = 30;
      const buckets = Array<number>(days).fill(0);
      for (const m of mv) {
        const dt = new Date(m.created_at);
        const idx = Math.min(
          days - 1,
          Math.max(
            0,
            Math.floor(
              (dt.getTime() - d30Ago.getTime()) / (24 * 3600 * 1000),
            ),
          ),
        );
        buckets[idx] += Number(m.qty_change ?? 0);
      }
      setMoves30Spark(buckets);

      // Recent list (latest 10, descending)
      const recent = [...mv]
        .sort(
          (a, b) =>
            new Date(b.created_at).getTime() -
            new Date(a.created_at).getTime(),
        )
        .slice(0, 10);
      setRecentMoves(recent);

      // -------- open parts requests count --------
      const {
        count: openCount,
        error: rerr,
      } = await supabase
        .from("part_requests")
        .select("id", { count: "exact", head: true })
        .in("status", ["requested", "quoted", "approved"] as RequestRow["status"][]);

      if (rerr) {
        // eslint-disable-next-line no-console
        console.error("[part_requests] count failed:", rerr);
        setOpenRequestsCount(0);
      } else {
        setOpenRequestsCount(openCount ?? 0);
      }

      setLoading(false);
    })();
  }, [supabase]);

  const skuTotalDisplay = loading ? "‚Ä¶" : skuTotal.toLocaleString();
  const newSkuDisplay = loading ? "‚Ä¶" : String(skuNewThis7d);
  const moves7dDisplay = loading ? "‚Ä¶" : moves7dCount.toLocaleString();
  const openReqDisplay =
    openRequestsCount === null || loading
      ? "‚Ä¶"
      : openRequestsCount.toLocaleString();

  return (
    <div className="relative space-y-8 p-6 text-white fade-in">
      {/* soft gradient background for this page */}
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(249,115,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.9),#020617_70%)]"
      />

      {/* welcome panel */}
      <section className="flex items-center justify-between gap-4 rounded-xl border border-white/10 bg-white/[0.03] px-5 py-4 shadow-card backdrop-blur-md">
        <div>
          <h1 className="text-2xl font-semibold text-white">
            Parts dashboard
          </h1>
          <p className="mt-1 text-sm text-neutral-400">
            Overview of your catalog, movement, and open requests.
          </p>
        </div>
      </section>

      {/* overview cards */}
      <section className="grid gap-4 md:grid-cols-4">
        <OverviewCard
          title="SKUs in catalog"
          value={skuTotalDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="New SKUs (7 days)"
          value={newSkuDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="Stock moves (7 days)"
          value={moves7dDisplay}
          href="/parts/inventory"
        />
        <OverviewCard
          title="Open parts requests"
          value={openReqDisplay}
          href="/parts/requests"
        />
      </section>

      {/* quick actions */}
      <section className="space-y-3">
        <h2 className="text-sm font-medium text-neutral-300">Quick actions</h2>
        <div className="flex flex-wrap gap-3">
          <QuickButton href="/parts/po" accent>
            Create PO
          </QuickButton>
          <QuickButton href="/parts/inventory">Inventory</QuickButton>
          <QuickButton href="/parts/receive">Scan to receive</QuickButton>
          <QuickButton href="/parts/requests">Requests</QuickButton>
          <QuickButton href="/parts/vendors">Vendors</QuickButton>
        </div>
      </section>

      {/* recent moves */}
      <section className="rounded-xl border border-white/10 bg-white/[0.03] px-5 py-4 shadow-card backdrop-blur-md">
        <div className="mb-2 flex items-center justify-between gap-4">
          <div>
            <h2 className="text-lg font-semibold">Recent stock moves</h2>
            <p className="text-xs text-neutral-400">
              Last 30 days of inventory activity.
            </p>
          </div>
          <Sparkline points={moves30Spark} />
        </div>

        {loading ? (
          <div className="text-sm text-neutral-400">Loading‚Ä¶</div>
        ) : recentMoves.length === 0 ? (
          <div className="text-sm text-neutral-400">No recent moves</div>
        ) : (
          <ul className="divide-y divide-neutral-800 text-sm">
            {recentMoves.map((m) => (
              <li
                key={m.id}
                className="flex items-center justify-between py-2"
              >
                <div className="min-w-0">
                  <div className="font-medium">
                    {String(m.reason ?? "move").replaceAll("_", " ")}
                  </div>
                  <div className="text-xs text-neutral-500">
                    {new Date(m.created_at as string).toLocaleString()}
                  </div>
                </div>
                <div className="pl-3 font-semibold">
                  {Number(m.qty_change ?? 0) >= 0 ? "+" : ""}
                  {Number(m.qty_change ?? 0)}
                </div>
              </li>
            ))}
          </ul>
        )}
      </section>
    </div>
  );
}

========================================
FILE: app/parts/po/[id]/receive/page.tsx
========================================
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { useParams } from "next/navigation";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { resolveScannedCode } from "@/features/parts/server/scanActions";

// Quagga shim/types
type QuaggaModule = typeof import("@ericblade/quagga2");
type QuaggaResult = { codeResult?: { code?: string | null } | null };
let Quagga: QuaggaModule["default"] | null = null;
if (typeof window !== "undefined") {
  void import("@ericblade/quagga2").then((m) => (Quagga = m.default));
}

type DB = Database;
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type POLine = DB["public"]["Tables"]["purchase_order_lines"]["Row"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];

export default function ReceivePOPage(): JSX.Element {
  const { id } = useParams<{ id: string }>();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [po, setPO] = useState<PurchaseOrder | null>(null);
  const [lines, setLines] = useState<POLine[]>([]);
  const [locs, setLocs] = useState<StockLoc[]>([]);
  const [selectedLoc, setSelectedLoc] = useState<string>("");

  const [qty, setQty] = useState<number>(1);
  const [lastScan, setLastScan] = useState<string>("");

  const videoRef = useRef<HTMLDivElement | null>(null);
  const [scanning, setScanning] = useState<boolean>(false);

  // load PO + lines + locations
  useEffect(() => {
    if (!id) return;
    (async () => {
      const { data: poRow } = await supabase
        .from("purchase_orders")
        .select("*")
        .eq("id", id)
        .maybeSingle();

      const poTyped = (poRow as PurchaseOrder | null) ?? null;
      setPO(poTyped);

      const [{ data: lineRows }, { data: locRows }] = await Promise.all([
        supabase
          .from("purchase_order_lines")
          .select("*")
          .eq("po_id", id)
          .order("created_at", { ascending: true }),
        poTyped?.shop_id
          ? supabase
              .from("stock_locations")
              .select("*")
              .eq("shop_id", poTyped.shop_id)
              .order("code")
          : Promise.resolve({ data: [] }),
      ]);

      const locsTyped = (locRows ?? []) as StockLoc[];
      setLines((lineRows ?? []) as POLine[]);
      setLocs(locsTyped);
      const main = locsTyped.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
      if (main) setSelectedLoc(main.id);
    })();
  }, [id, supabase]);

  // scanner
  const startScan = async () => {
    if (!Quagga || scanning || !videoRef.current) return;
    setScanning(true);
    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: videoRef.current,
          constraints: { facingMode: "environment" },
        },
        decoder: {
          readers: [
            "upc_reader",
            "upc_e_reader",
            "ean_reader",
            "ean_8_reader",
            "code_128_reader",
          ],
        },
        locate: true,
      },
      (err?: Error) => {
        if (err) {
          // eslint-disable-next-line no-console
          console.error(err);
          setScanning(false);
          return;
        }
        Quagga?.start();
      }
    );

    Quagga.onDetected(async (res: QuaggaResult) => {
      const code = res.codeResult?.code ?? "";
      if (!code || code === lastScan) return;
      setLastScan(code);

      const { part_id } = await resolveScannedCode({
        code,
        supplier_id: po?.supplier_id ?? null,
      });

      if (!part_id) {
        alert(`No part found for "${code}".`);
        return;
      }
      if (!selectedLoc) {
        alert("Select a location first.");
        return;
      }

      await fetch("/api/receive-scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          part_id,
          location_id: selectedLoc,
          qty,
          po_id: po?.id ?? null,
        }),
      });

      const locLabel =
        locs.find((l) => l.id === selectedLoc)?.code ?? "LOC";
      alert(`Received √ó${qty} to ${locLabel}`);
      window.dispatchEvent(new CustomEvent("parts:received"));
      window.setTimeout(() => setLastScan(""), 1000);
    });
  };

  const stopScan = () => {
    try {
      Quagga?.stop();
    } catch {
      /* ignore */
    }
    setScanning(false);
  };

  useEffect(() => {
    return () => stopScan();
  }, []);

  const remaining = (ln: POLine): number => {
    const ordered = Number(ln.qty ?? 0);
    const received = Number(ln.received_qty ?? 0);
    return Math.max(0, ordered - received);
  };

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Receive PO</h1>
        <Link
          href="/parts/po"
          className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
        >
          Back to POs
        </Link>
      </div>

      {po ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm">
          <div className="font-medium">
            {po.id.slice(0, 8)} ‚Ä¢ {po.status ?? "draft"}
          </div>
          <div className="text-neutral-400">
            Supplier: {po.supplier_id ?? "‚Äî"}
          </div>
        </div>
      ) : (
        <div className="text-neutral-400">Loading PO‚Ä¶</div>
      )}

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3 grid gap-3 sm:grid-cols-3">
        <div>
          <div className="text-xs text-neutral-400 mb-1">Location</div>
          <select
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
            value={selectedLoc}
            onChange={(e) => setSelectedLoc(e.target.value)}
          >
            {locs.map((l) => (
              <option key={l.id} value={l.id}>
                {l.code ?? "LOC"} ‚Äî {l.name ?? ""}
              </option>
            ))}
          </select>
        </div>
        <div>
          <div className="text-xs text-neutral-400 mb-1">Quantity</div>
          <input
            type="number"
            min={0.01}
            step="0.01"
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
            value={qty}
            onChange={(e) => setQty(Math.max(0, Number(e.target.value || 0)))}
          />
        </div>
      </div>

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
        <div className="mb-2 flex items-center gap-2">
          {!scanning ? (
            <button
              onClick={startScan}
              className="rounded border border-orange-500 px-3 py-1.5 text-sm text-orange-300 hover:bg-orange-900/20"
            >
              Start Scanner
            </button>
          ) : (
            <button
              onClick={stopScan}
              className="rounded border border-red-500 px-3 py-1.5 text-sm text-red-300 hover:bg-red-900/20"
            >
              Stop Scanner
            </button>
          )}
          <span className="text-xs text-neutral-400">
            Scan item barcodes to receive against this PO.
          </span>
        </div>
        <div
          ref={videoRef}
          className="aspect-video w-full overflow-hidden rounded border border-neutral-800 bg-black"
        />
      </div>

      <div className="rounded border border-neutral-800 bg-neutral-900">
        <div className="border-b border-neutral-800 p-2 text-sm font-semibold">
          Lines
        </div>
        {lines.length === 0 ? (
          <div className="p-3 text-neutral-400">No lines yet.</div>
        ) : (
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-neutral-400">
                <th className="p-2">Part</th>
                <th className="p-2">Ordered</th>
                <th className="p-2">Received</th>
                <th className="p-2">Remaining</th>
              </tr>
            </thead>
            <tbody>
  {lines.map((ln) => (
    <tr key={ln.id} className="border-t border-neutral-800">
      <td className="p-2">{ln.part_id ? ln.part_id.slice(0, 8) : "‚Äî"}</td>
      <td className="p-2">{Number(ln.qty ?? 0)}</td>
      <td className="p-2">{Number(ln.received_qty ?? 0)}</td>
      <td className="p-2">{remaining(ln)}</td>
    </tr>
  ))}
</tbody>
          </table>
        )}
      </div>
    </div>
  );
}

========================================
FILE: app/parts/po/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { v4 as uuidv4 } from "uuid";

type DB = Database;
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type Supplier = DB["public"]["Tables"]["suppliers"]["Row"];

export default function PurchaseOrdersPage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  const [shopId, setShopId] = useState<string>("");
  const [loading, setLoading] = useState(true);
  const [pos, setPOs] = useState<PurchaseOrder[]>([]);

  // New PO modal state
  const [open, setOpen] = useState(false);
  const [suppliers, setSuppliers] = useState<Supplier[]>([]);
  const [supplierId, setSupplierId] = useState<string>("");
  const [note, setNote] = useState<string>("");

  useEffect(() => {
    (async () => {
      setLoading(true);
      const { data: userRes } = await supabase.auth.getUser();
      const uid = userRes.user?.id ?? null;
      if (!uid) { setLoading(false); return; }

      const { data: prof } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .single();

      const sid = prof?.shop_id ?? "";
      setShopId(sid);

      if (sid) {
        const [poRes, supRes] = await Promise.all([
          supabase
            .from("purchase_orders")
            .select("*")
            .eq("shop_id", sid)
            .order("created_at", { ascending: false })
            .limit(100),
          supabase
            .from("suppliers")
            .select("*")
            .eq("shop_id", sid)
            .order("name", { ascending: true }),
        ]);
        setPOs((poRes.data as PurchaseOrder[]) ?? []);
        setSuppliers((supRes.data as Supplier[]) ?? []);
      }

      setLoading(false);
    })();
  }, [supabase]);

  const createPo = async () => {
    if (!shopId) return;
    const id = uuidv4();
    const insert = {
      id,
      shop_id: shopId,
      supplier_id: supplierId || null,
      status: "open" as PurchaseOrder["status"],
      notes: note || null,
    };
    const { error } = await supabase.from("purchase_orders").insert(insert);
    if (!error) {
      setOpen(false);
      setSupplierId("");
      setNote("");
      router.push(`/parts/po/${id}/receive`);
    } else {
      // keep UI minimal for now
      alert(error.message);
    }
  };

  return (
    <div className="p-6 space-y-4 text-white">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Purchase Orders</h1>
        <button
          className="font-header rounded border border-orange-500 px-3 py-1.5 text-sm hover:bg-orange-500/10 disabled:opacity-60"
          onClick={() => setOpen(true)}
          disabled={!shopId}
        >
          New PO
        </button>
      </div>

      {loading ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm text-neutral-400">
          Loading‚Ä¶
        </div>
      ) : pos.length === 0 ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-sm text-neutral-400">
          No purchase orders yet.
        </div>
      ) : (
        <div className="rounded border border-neutral-800 bg-neutral-900">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-left text-neutral-400">
                <th className="p-2">PO</th>
                <th className="p-2">Supplier</th>
                <th className="p-2">Status</th>
                <th className="p-2">Created</th>
                <th className="p-2"></th>
              </tr>
            </thead>
            <tbody>
              {pos.map((po) => (
                <tr key={po.id} className="border-t border-neutral-800">
                  <td className="p-2 font-mono">{po.id.slice(0, 8)}</td>
                  <td className="p-2">{po.supplier_id ?? "‚Äî"}</td>
                  <td className="p-2">{po.status}</td>
                  <td className="p-2">{po.created_at ? new Date(po.created_at).toLocaleString() : "‚Äî"}</td>
                  <td className="p-2">
                    <Link
                      href={`/parts/po/${po.id}/receive`}
                      className="rounded border border-neutral-700 px-2 py-1 hover:bg-neutral-800"
                    >
                      Receive
                    </Link>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}

      {/* New PO "modal" (lightweight inline panel to keep dependencies low) */}
      {open && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
          <div className="w-full max-w-md rounded border border-orange-500 bg-neutral-950 p-4">
            <div className="mb-3 flex items-center justify-between">
              <h2 className="text-lg font-semibold">New Purchase Order</h2>
              <button
                className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
                onClick={() => setOpen(false)}
              >
                ‚úï
              </button>
            </div>
            <div className="space-y-3">
              <div>
                <div className="mb-1 text-xs text-neutral-400">Supplier (optional)</div>
                <select
                  className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
                  value={supplierId}
                  onChange={(e) => setSupplierId(e.target.value)}
                >
                  <option value="">‚Äî none ‚Äî</option>
                  {suppliers.map((s) => (
                    <option key={s.id} value={s.id}>
                      {s.name ?? s.id.slice(0, 8)}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <div className="mb-1 text-xs text-neutral-400">Notes</div>
                <textarea
                  className="w-full rounded border border-neutral-700 bg-neutral-900 p-2"
                  rows={2}
                  value={note}
                  onChange={(e) => setNote(e.target.value)}
                  placeholder="Optional notes for this PO‚Ä¶"
                />
              </div>
              <div className="flex justify-end gap-2">
                <button
                  className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
                  onClick={() => setOpen(false)}
                >
                  Cancel
                </button>
                <button
                  className="rounded border border-orange-500 px-3 py-1.5 text-sm hover:bg-orange-500/10 disabled:opacity-60"
                  onClick={createPo}
                  disabled={!shopId}
                >
                  Create & Receive ‚Üí
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/parts/quoting/page.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { toast } from "sonner";
import { format } from "date-fns";
import dynamic from "next/dynamic";

import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";
import VoiceContextSetter from "@/features/shared/voice/VoiceContextSetter";
import VoiceButton from "@/features/shared/voice/VoiceButton";
import { requestQuoteSuggestion } from "@inspections/lib/inspection/aiQuote";

const PartsDrawer = dynamic(
  () => import("@/features/parts/components/PartsDrawer"),
  {
    ssr: false,
  }
);

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];

type QueueRow = WorkOrderLine & {
  work_order: WorkOrder | null;
  vehicle: Vehicle | null;
  customer: Customer | null;
};

type MenuUpsertResponse = {
  ok: boolean;
  menuItemId?: string;
  updated?: boolean;
  error?: string;
  detail?: string;
};

const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded border px-2 py-0.5 text-xs font-medium";
const BADGE: Record<string, string> = {
  awaiting: "bg-sky-900/20 border-sky-500/40 text-sky-300",
  awaiting_approval: "bg-blue-900/20 border-blue-500/40 text-blue-300",
  queued: "bg-indigo-900/20 border-indigo-500/40 text-indigo-300",
  in_progress: "bg-orange-900/20 border-orange-500/40 text-orange-300",
  on_hold: "bg-amber-900/20 border-amber-500/40 text-amber-300",
  completed: "bg-green-900/20 border-green-500/40 text-green-300",
};
const chip = (s: string | null | undefined): string => {
  const k = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_");
  return `${BASE_BADGE} ${BADGE[k] ?? BADGE.awaiting}`;
};

export default function QuotingQueuePage(): JSX.Element {
  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [rows, setRows] = useState<QueueRow[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [selectedId, setSelectedId] = useState<string | null>(null);
  const selected = useMemo(
    () => rows.find((r) => r.id === selectedId) ?? null,
    [rows, selectedId]
  );

  const [bulkQueue, setBulkQueue] = useState<string[]>([]);
  const bulkActive = bulkQueue.length > 0;

  const fetchQueue = useCallback(async () => {
    setLoading(true);
    setErr(null);
    try {
      const { data: lines, error: lerr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("approval_state", "pending")
        .order("created_at", { ascending: true });

      if (lerr) throw lerr;

      const wol = (lines ?? []) as WorkOrderLine[];
      if (wol.length === 0) {
        setRows([]);
        setLoading(false);
        return;
      }

      const woIds = [
        ...new Set(
          wol.map((l) => l.work_order_id).filter(Boolean) as string[]
        ),
      ];
      const { data: woRows } = await supabase
        .from("work_orders")
        .select("*")
        .in("id", woIds);

      const woById = new Map<string, WorkOrder>();
      (woRows ?? []).forEach((w) => woById.set(w.id, w as WorkOrder));

      const vehIds = [
        ...new Set(
          (woRows ?? [])
            .map((w) => (w as WorkOrder).vehicle_id)
            .filter(Boolean) as string[]
        ),
      ];
      const custIds = [
        ...new Set(
          (woRows ?? [])
            .map((w) => (w as WorkOrder).customer_id)
            .filter(Boolean) as string[]
        ),
      ];

      const [vehRes, custRes] = await Promise.all([
        vehIds.length
          ? supabase.from("vehicles").select("*").in("id", vehIds)
          : Promise.resolve({ data: [] } as const),
        custIds.length
          ? supabase.from("customers").select("*").in("id", custIds)
          : Promise.resolve({ data: [] } as const),
      ]);

      const vById = new Map<string, Vehicle>();
      (vehRes.data ?? []).forEach((v) =>
        vById.set((v as Vehicle).id, v as Vehicle)
      );

      const cById = new Map<string, Customer>();
      (custRes.data ?? []).forEach((c) =>
        cById.set((c as Customer).id, c as Customer)
      );

      const out: QueueRow[] = wol.map((l) => {
        const wo = l.work_order_id
          ? woById.get(l.work_order_id) ?? null
          : null;
        const vehicle = wo?.vehicle_id
          ? vById.get(wo.vehicle_id) ?? null
          : null;
        const customer = wo?.customer_id
          ? cById.get(wo.customer_id) ?? null
          : null;
        return { ...l, work_order: wo, vehicle, customer };
      });

      setRows(out);
    } catch (e) {
      const msg =
        (e as { message?: string })?.message ??
        "Failed to load quoting queue.";
      setErr(msg);
    } finally {
      setLoading(false);
    }
  }, [supabase]);

  useEffect(() => {
    void fetchQueue();
  }, [fetchQueue]);

  useEffect(() => {
    const ch = supabase
      .channel("quote-queue")
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: "approval_state=eq.pending",
        },
        () => void fetchQueue()
      )
      .subscribe();
    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        // ignore
      }
    };
  }, [supabase, fetchQueue]);

  const startBulk = useCallback(() => {
    if (!rows.length) return;
    const ids = rows.map((r) => r.id);
    setBulkQueue(ids);
    setSelectedId(ids[0] ?? null);
    toast.message(`Quoting ${ids.length} pending line(s)‚Ä¶`);
  }, [rows]);

  useEffect(() => {
    if (!selectedId) return;
    const evt = `parts-drawer:closed:${selectedId}`;
    const handler = () => {
      if (bulkActive) {
        const [, ...rest] = bulkQueue;
        setBulkQueue(rest);
        setSelectedId(rest[0] ?? null);
        if (rest.length === 0) void fetchQueue();
      } else {
        setSelectedId(null);
        void fetchQueue();
      }
    };
    window.addEventListener(evt, handler as EventListener);
    return () => window.removeEventListener(evt, handler as EventListener);
  }, [selectedId, bulkActive, bulkQueue, fetchQueue]);

  // ---- AI Apply: suggest + server inserts allocations + labor
  const aiApply = useCallback(
    async (row: QueueRow) => {
      if (!row.id) return;
      toast.loading("AI preparing parts & labor‚Ä¶", { id: `ai-${row.id}` });

      try {
        const suggestion = await requestQuoteSuggestion({
          item: row.description ?? "Job",
          notes: row.notes ?? "",
          section: "Quote Queue",
          status: "recommend",
          vehicle: row.vehicle ?? undefined,
        });

        if (!suggestion) {
          toast.error("AI returned no suggestion.", { id: `ai-${row.id}` });
          return;
        }

        const r = await fetch("/api/quotes/apply-ai", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderLineId: row.id, suggestion }),
        });

        const j = (await r.json()) as {
          ok?: boolean;
          labor_applied?: boolean;
          unmatched?: { name: string; qty: number }[];
          error?: string;
        };
        if (!r.ok || !j?.ok) {
          throw new Error(j?.error || "Apply AI failed");
        }

        if (j.unmatched && j.unmatched.length) {
          const list = j.unmatched
            .map((u) => `${u.qty}√ó ${u.name}`)
            .join(", ");
          toast.message(`Some parts need manual matching: ${list}`, {
            id: `ai-${row.id}`,
          });
        } else {
          toast.success("AI parts & labor applied", { id: `ai-${row.id}` });
        }
        await fetchQueue();
      } catch (e) {
        toast.error(
          (e as { message?: string })?.message ?? "AI apply failed",
          { id: `ai-${row.id}` }
        );
      }
    },
    [fetchQueue]
  );

  // ---- Mark as quoted (still pending approval) + grow Saved Menu
  const markQuoted = useCallback(
    async (row: QueueRow) => {
      if (!row.id) return;
      toast.loading("Marking as quoted‚Ä¶", { id: `quoted-${row.id}` });

      try {
        // Create/merge Saved Menu record for this line
        const r = await fetch("/api/menu-items/upsert-from-line", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderLineId: row.id }),
        });

        let body: MenuUpsertResponse | null = null;
        let raw: string | null = null;
        try {
          raw = await r.text();
          body = raw ? (JSON.parse(raw) as MenuUpsertResponse) : null;
        } catch {
          // non-JSON or empty body
        }

        if (!r.ok || !body?.ok) {
          console.error("Menu upsert failed", {
            status: r.status,
            body: body ?? raw,
          });

          const reason =
            body?.detail ||
            body?.error ||
            (r.ok ? "Unknown error" : `HTTP ${r.status}`);

          // This mirrors the "Quoted, but couldn‚Äôt save to menu items" vibe,
          // but also surfaces the detail so you know *why*.
          toast.warning(
            `Quoted, but couldn‚Äôt save to menu items. ${reason}`,
            { id: `quoted-${row.id}` }
          );
          return;
        }

        // Keep approval_state as pending, but mark status + notes as quoted
        const nextNotes = `${row.notes ?? ""}`.includes("[quoted]")
          ? row.notes
          : [row.notes ?? "", "[quoted]"].filter(Boolean).join(" ").trim();

        const { error: ue } = await supabase
          .from("work_order_lines")
          .update(
            {
              status: "quoted",
              notes: nextNotes,
            } as DB["public"]["Tables"]["work_order_lines"]["Update"]
          )
          .eq("id", row.id);

        if (ue) {
          console.warn("Could not set line to quoted:", ue.message);
          toast.success(
            "Saved Menu updated, but line status could not be set to quoted.",
            { id: `quoted-${row.id}` }
          );
        } else {
          toast.success(
            "Marked as quoted (awaiting approval). Saved Menu updated.",
            { id: `quoted-${row.id}` }
          );
        }

        await fetchQueue();
      } catch (e) {
        console.error("markQuoted failed:", e);
        toast.error(
          (e as { message?: string })?.message ??
            "Failed to mark as quoted",
          { id: `quoted-${row.id}` }
        );
      }
    },
    [supabase, fetchQueue]
  );

  return (
    <div className="p-4 sm:p-6 text-white">
      <VoiceContextSetter currentView="parts_quoting" />

      <div className="mb-4 flex items-center justify-between">
        <h1 className="text-2xl font-semibold">Quoting Queue</h1>
        <div className="flex items-center gap-2">
          <Link
            href="/parts/inventory"
            className="text-sm text-orange-400 hover:underline"
          >
            Open Inventory ‚Üí
          </Link>
          <button
            type="button"
            className="rounded bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-blue-500 disabled:opacity-50"
            onClick={startBulk}
            disabled={rows.length === 0}
          >
            Quote all pending ({rows.length})
          </button>
        </div>
      </div>

      {err && (
        <div className="mb-4 rounded border border-red-500/40 bg-red-500/10 p-3 text-red-300">
          {err}
        </div>
      )}

      <div className="grid grid-cols-1 gap-6 lg:grid-cols-[420px_1fr]">
        {/* LEFT: queue */}
        <div className="rounded border border-neutral-800 bg-neutral-900">
          <div className="border-b border-neutral-800 p-3 text-sm text-neutral-300">
            Pending approval lines
          </div>
          {loading ? (
            <div className="p-3 text-neutral-400">Loading‚Ä¶</div>
          ) : rows.length === 0 ? (
            <div className="p-3 text-neutral-400">
              Nothing awaiting quoting.
            </div>
          ) : (
            <ul className="divide-y divide-neutral-800">
              {rows.map((r) => (
                <li key={r.id} className="p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="truncate font-medium">
                        {r.description || r.complaint || "Untitled job"}
                      </div>
                      <div className="mt-0.5 text-xs text-neutral-400">
                        WO:{" "}
                        {r.work_order?.custom_id ||
                          r.work_order?.id?.slice(0, 8) ||
                          "‚Äî"}{" "}
                        ‚Ä¢{" "}
                        {r.vehicle
                          ? `${r.vehicle.year ?? ""} ${
                              r.vehicle.make ?? ""
                            } ${r.vehicle.model ?? ""}`.trim()
                          : "No vehicle"}{" "}
                        ‚Ä¢{" "}
                        {r.created_at
                          ? format(new Date(r.created_at), "PPp")
                          : "‚Äî"}
                      </div>
                      {r.notes && (
                        <div className="mt-1 truncate text-xs text-neutral-400">
                          Notes: {r.notes}
                        </div>
                      )}
                    </div>

                    <div className="flex shrink-0 items-center gap-2">
                      <span className={chip(r.status)}>
                        {(r.status ?? "awaiting").replaceAll("_", " ")}
                      </span>
                      <button
                        type="button"
                        className="rounded border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800"
                        onClick={() => void aiApply(r)}
                        title="AI: allocate parts + labor"
                      >
                        AI Apply
                      </button>
                      <button
                        type="button"
                        className="rounded border border-neutral-700 px-2 py-1 text-xs hover:bg-neutral-800"
                        onClick={() => setSelectedId(r.id)}
                        title="Open Parts Drawer"
                      >
                        Quote
                      </button>
                      <button
                        type="button"
                        className="rounded bg-emerald-600 px-2 py-1 text-xs font-semibold text-black hover:bg-emerald-500"
                        onClick={() => void markQuoted(r)}
                        title="Mark as quoted (keeps awaiting approval) and grow Saved Menu"
                      >
                        Mark Quoted
                      </button>
                    </div>
                  </div>
                </li>
              ))}
            </ul>
          )}
        </div>

        {/* RIGHT: details */}
        <div className="rounded border border-neutral-800 bg-neutral-900 p-4">
          <h2 className="mb-2 text-lg font-semibold">Details</h2>
          {selected ? (
            <div className="space-y-2 text-sm">
              <div className="text-neutral-400">Work Order</div>
              <div className="font-medium">
                {selected.work_order
                  ? selected.work_order.custom_id ||
                    selected.work_order.id?.slice(0, 8)
                  : "‚Äî"}
              </div>

              <div className="text-neutral-400">Vehicle</div>
              <div className="font-medium">
                {selected.vehicle
                  ? (
                      `${selected.vehicle.year ?? ""} ${
                        selected.vehicle.make ?? ""
                      } ${selected.vehicle.model ?? ""}`.trim() || "‚Äî"
                    )
                  : "‚Äî"}
              </div>

              <div className="text-neutral-400">Customer</div>
              <div className="font-medium">
                {selected.customer
                  ? (
                      [
                        selected.customer.first_name ?? "",
                        selected.customer.last_name ?? "",
                      ]
                        .filter(Boolean)
                        .join(" ") || "‚Äî"
                    )
                  : "‚Äî"}
              </div>

              <div className="text-neutral-400">Description</div>
              <div className="font-medium">
                {selected.description ?? "‚Äî"}
              </div>

              <div className="text-neutral-400">Notes</div>
              <div className="whitespace-pre-wrap font-medium">
                {selected.notes ?? "‚Äî"}
              </div>
            </div>
          ) : (
            <div className="text-neutral-400">
              Select a line on the left to see details.
            </div>
          )}
        </div>
      </div>

      {/* Parts drawer */}
      {selected && selected.work_order?.id && (
        <PartsDrawer
          open
          workOrderId={selected.work_order.id}
          workOrderLineId={selected.id}
          vehicleSummary={
            selected.vehicle
              ? {
                  year:
                    (selected.vehicle.year as string | number | null)
                      ?.toString() ?? null,
                  make: selected.vehicle.make ?? null,
                  model: selected.vehicle.model ?? null,
                }
              : null
          }
          jobDescription={selected.description ?? null}
          jobNotes={selected.notes ?? null}
          closeEventName={`parts-drawer:closed:${selected.id}`}
        />
      )}

      <VoiceButton />
    </div>
  );
}

========================================
FILE: app/parts/receive/page.tsx
========================================
"use client";

import { useEffect, useMemo, useRef, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { resolveScannedCode } from "@/features/parts/server/scanActions";

// Quagga (typed shim)
type QuaggaModule = typeof import("@ericblade/quagga2");
type QuaggaResult = { codeResult?: { code?: string | null } | null };
let Quagga: QuaggaModule["default"] | null = null;
if (typeof window !== "undefined") {
  void import("@ericblade/quagga2").then((m) => {
    Quagga = m.default;
  });
}

type DB = Database;
type PurchaseOrder = DB["public"]["Tables"]["purchase_orders"]["Row"];
type StockLoc = DB["public"]["Tables"]["stock_locations"]["Row"];

export default function ReceivePage(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [, setShopId] = useState<string>("");
  const [pos, setPOs] = useState<PurchaseOrder[]>([]);
  const [selectedPo, setSelectedPo] = useState<string>("");
  const [selectedLoc, setSelectedLoc] = useState<string>("");
  const [locs, setLocs] = useState<StockLoc[]>([]);
  const [lastScan, setLastScan] = useState<string>("");

  const videoRef = useRef<HTMLDivElement | null>(null);
  const [scanning, setScanning] = useState<boolean>(false);
  const [qty, setQty] = useState<number>(1);

  // bootstrap: shop, POs, locations
  useEffect(() => {
    (async () => {
      const { data: userRes } = await supabase.auth.getUser();
      const uid = userRes.user?.id;
      if (!uid) return;

      const { data: prof } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", uid)
        .single();

      const sid = prof?.shop_id ?? "";
      setShopId(sid);
      if (!sid) return;

      const [poRes, locRes] = await Promise.all([
        supabase
          .from("purchase_orders")
          .select("*")
          .eq("shop_id", sid)
          .order("created_at", { ascending: false })
          .limit(50),
        supabase
          .from("stock_locations")
          .select("*")
          .eq("shop_id", sid)
          .order("code"),
      ]);

      setPOs((poRes.data ?? []) as PurchaseOrder[]);
      const locRows = (locRes.data ?? []) as StockLoc[];
      setLocs(locRows);
      const main = locRows.find((l) => (l.code ?? "").toUpperCase() === "MAIN");
      if (main) setSelectedLoc(main.id);
    })();
  }, [supabase]);

  // start/stop camera
  const startScan = async () => {
    if (!Quagga || scanning || !videoRef.current) return;
    setScanning(true);

    Quagga.init(
      {
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: videoRef.current,
          constraints: { facingMode: "environment" },
        },
        decoder: {
          readers: [
            "upc_reader",
            "upc_e_reader",
            "ean_reader",
            "ean_8_reader",
            "code_128_reader",
          ],
        },
        locate: true,
      },
      (err?: Error) => {
        if (err) {
          // eslint-disable-next-line no-console
          console.error(err);
          setScanning(false);
          return;
        }
        Quagga?.start();
      }
    );

    Quagga.onDetected(async (res: QuaggaResult) => {
      const code = res.codeResult?.code ?? "";
      if (!code || code === lastScan) return;
      setLastScan(code);

      const supplierId =
        pos.find((p) => p.id === selectedPo)?.supplier_id ?? null;

      const { part_id } = await resolveScannedCode({
        code,
        supplier_id: supplierId,
      });

      if (!part_id) {
        alert(
          `No part found for "${code}". Map it in Parts ‚Üí Inventory ‚Üí Edit ‚Üí Barcodes.`
        );
        return;
      }

      if (!selectedLoc) {
        alert("Select a location first.");
        return;
      }

      await fetch("/api/receive-scan", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          part_id,
          location_id: selectedLoc,
          qty,
          po_id: selectedPo || null,
        }),
      });

      const locLabel =
        locs.find((l) => l.id === selectedLoc)?.code ?? "LOC";
      alert(`Received √ó${qty} to ${locLabel}`);
      window.dispatchEvent(new CustomEvent("parts:received"));
      window.setTimeout(() => setLastScan(""), 1000);
    });
  };

  const stopScan = () => {
    try {
      Quagga?.stop();
    } catch {
      /* ignore */
    }
    setScanning(false);
  };

  useEffect(() => {
    return () => stopScan();
  }, []);

  return (
    <div className="p-6 space-y-4">
      <h1 className="text-2xl font-bold text-white">Scan to Receive</h1>

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3 grid gap-3 sm:grid-cols-3">
        <div className="sm:col-span-1">
          <div className="text-xs text-neutral-400 mb-1">
            Purchase Order (optional)
          </div>
          <select
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={selectedPo}
            onChange={(e) => setSelectedPo(e.target.value)}
          >
            <option value="">‚Äî No PO ‚Äî</option>
            {pos.map((po) => (
              <option key={po.id} value={po.id}>
                {po.id.slice(0, 8)} ‚Ä¢ {po.status ?? "draft"}
              </option>
            ))}
          </select>
        </div>

        <div>
          <div className="text-xs text-neutral-400 mb-1">Location</div>
          <select
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={selectedLoc}
            onChange={(e) => setSelectedLoc(e.target.value)}
          >
            {locs.map((l) => (
              <option key={l.id} value={l.id}>
                {l.code ?? "LOC"} ‚Äî {l.name ?? ""}
              </option>
            ))}
          </select>
        </div>

        <div>
          <div className="text-xs text-neutral-400 mb-1">Quantity</div>
          <input
            type="number"
            min={0.01}
            step="0.01"
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
            value={qty}
            onChange={(e) => setQty(Math.max(0, Number(e.target.value || 0)))}
          />
        </div>
      </div>

      <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
        <div className="mb-2 flex items-center gap-2">
          {!scanning ? (
            <button
              onClick={startScan}
              className="rounded border border-orange-500 px-3 py-1.5 text-sm text-orange-300 hover:bg-orange-900/20"
            >
              Start Scanner
            </button>
          ) : (
            <button
              onClick={stopScan}
              className="rounded border border-red-500 px-3 py-1.5 text-sm text-red-300 hover:bg-red-900/20"
            >
              Stop Scanner
            </button>
          )}
          <span className="text-xs text-neutral-400">
            Use mobile camera to scan UPC/EAN/Code128.
          </span>
        </div>
        <div
          ref={videoRef}
          className="aspect-video w-full overflow-hidden rounded border border-neutral-800 bg-black"
        />
      </div>
    </div>
  );
}

========================================
FILE: app/parts/requests/[id]/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Request = DB["public"]["Tables"]["part_requests"]["Row"];
type Item = DB["public"]["Tables"]["part_request_items"]["Row"] & {
  // schema is catching up
  work_order_line_id?: string | null;
  markup_pct?: number | null;
  qty?: number | null;
};
type Status = Request["status"];
type Part = DB["public"]["Tables"]["parts"]["Row"];
type QuoteUpdate =
  DB["public"]["Tables"]["work_order_quote_lines"]["Update"];

const DEFAULT_MARKUP = 30; // %

type UpsertResponse = {
  ok: boolean;
  menuItemId?: string;
  updated?: boolean;
  error?: string;
  detail?: string;
};

export default function PartsRequestDetail() {
  const { id } = useParams<{ id: string }>();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  const [req, setReq] = useState<Request | null>(null);
  const [items, setItems] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [addingItem, setAddingItem] = useState(false);
  const [parts, setParts] = useState<Part[]>([]);
  const [markupPct, setMarkupPct] = useState<Record<string, number>>({});
  const [savedRows, setSavedRows] = useState<Record<string, boolean>>({});
  // per-line manual part inputs
  const [manualParts, setManualParts] = useState<
    Record<string, { name: string; sku: string }>
  >({});

  async function load() {
    setLoading(true);

    // header
    const { data: r, error: rErr } = await supabase
      .from("part_requests")
      .select("*")
      .eq("id", id)
      .maybeSingle();
    if (rErr) toast.error(rErr.message);
    setReq(r ?? null);

    // items
    const { data: its, error: itErr } = await supabase
      .from("part_request_items")
      .select("*")
      .eq("request_id", id);
    if (itErr) toast.error(itErr.message);
    const itemsList = (its ?? []) as Item[];
    setItems(itemsList);

    // inventory
    if (r?.shop_id) {
      const { data: ps } = await supabase
        .from("parts")
        .select("*")
        .eq("shop_id", r.shop_id)
        .order("name")
        .limit(500);
      setParts(ps ?? []);
    } else {
      setParts([]);
    }

    // markup init
    const m: Record<string, number> = {};
    for (const it of itemsList) {
      m[it.id] =
        typeof it.markup_pct === "number" && !Number.isNaN(it.markup_pct)
          ? it.markup_pct
          : DEFAULT_MARKUP;
    }
    setMarkupPct(m);

    // clear saved flags on fresh load
    setSavedRows({});

    setLoading(false);
  }

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [id]);

  function getLineIdFromItems(list: Item[]): string | null {
    for (const it of list) {
      if (it.work_order_line_id) return it.work_order_line_id;
    }
    return null;
  }

  async function addItem() {
    if (!req) {
      toast.error("Request not loaded yet.");
      return;
    }
    setAddingItem(true);
    try {
      const lineId = getLineIdFromItems(items);

      const insertPayload: DB["public"]["Tables"]["part_request_items"]["Insert"] =
        {
          request_id: req.id,
          work_order_line_id: lineId ?? null,
          description: "",
          qty: 1,
          quoted_price: 0,
          vendor: null,
        };

      const { data, error } = await supabase
        .from("part_request_items")
        .insert(insertPayload)
        .select("*")
        .maybeSingle<Item>();

      if (error) {
        toast.error(error.message);
        return;
      }
      if (!data) {
        toast.error("Could not create a new item.");
        return;
      }

      // append to local state so it feels instant
      setItems((prev) => [...prev, data]);
      setMarkupPct((prev) => ({
        ...prev,
        [data.id]: DEFAULT_MARKUP,
      }));
      setSavedRows((prev) => ({ ...prev, [data.id]: false }));
    } finally {
      setAddingItem(false);
    }
  }

  async function deleteLine(itemId: string) {
    const ok = window.confirm("Remove this item from the request?");
    if (!ok) return;

    const { error } = await supabase
      .from("part_request_items")
      .delete()
      .eq("id", itemId);

    if (error) {
      toast.error(error.message);
      return;
    }

    setItems((prev) => prev.filter((it) => it.id !== itemId));
    setMarkupPct((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });
    setSavedRows((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });
    setManualParts((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });

    toast.success("Item removed.");
  }

  async function setStatus(s: Status) {
    const { error } = await supabase.rpc("set_part_request_status", {
      p_request: id,
      p_status: s,
    });
    if (error) {
      toast.error(error.message);
      return;
    }

    if (s === "quoted") {
      const lineId = getLineIdFromItems(items);
      if (lineId) {
        // ‚úÖ mark line quoted and pending approval on the WO
        const { error: wolErr } = await supabase
          .from("work_order_lines")
          .update({
            status: "quoted",
            approval_state: "pending",
            hold_reason: "Parts quote ready ‚Äì awaiting customer approval",
          } as DB["public"]["Tables"]["work_order_lines"]["Update"])
          .eq("id", lineId);
        if (wolErr) {
          console.warn("could not set line to quoted:", wolErr.message);
        }

        // üîó sync pricing into work_order_quote_lines for this WO line
        if (req?.work_order_id) {
          let partsTotalForLine = 0;

          for (const it of items) {
            if (it.work_order_line_id !== lineId) continue;

            const cost =
              typeof it.quoted_price === "number" &&
              !Number.isNaN(it.quoted_price)
                ? it.quoted_price
                : 0;
            const m = markupPct[it.id] ?? DEFAULT_MARKUP;
            const unitSell = cost * (1 + m / 100);
            const qty =
              typeof it.qty === "number" && it.qty > 0
                ? Number(it.qty)
                : 0;

            partsTotalForLine += unitSell * qty;
          }

          const { error: quoteErr } = await supabase
            .from("work_order_quote_lines")
            .update({
              stage: "advisor_pending",
              parts_total: partsTotalForLine,
              grand_total: partsTotalForLine,
            } as QuoteUpdate)
            .match({
              work_order_id: req.work_order_id,
              work_order_line_id: lineId,
            });

          if (quoteErr) {
            console.warn(
              "could not sync work_order_quote_lines from parts quote:",
              quoteErr.message,
            );
          }
        }

        // save to menu items (grow Saved Menu)
        try {
          const res = await fetch("/api/menu-items/upsert-from-line", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ workOrderLineId: lineId }),
          });

          const j = (await res.json().catch(() => null)) as UpsertResponse | null;

          if (!res.ok || !j?.ok) {
            console.warn("menu save failed:", j);
            const msg =
              j?.detail ||
              j?.error ||
              "Quoted, but couldn‚Äôt save to menu items (see server logs / RLS).";
            toast.warning(msg);
          } else {
            const suffix = j.updated ? "updated" : "saved";
            toast.success(`Quoted and ${suffix} to menu items.`);
          }
        } catch (e) {
          console.warn("menu save error:", e);
          const msg =
            e instanceof Error
              ? `Quoted, but couldn‚Äôt save to menu items: ${e.message}`
              : "Quoted, but couldn‚Äôt save to menu items (network error).";
          toast.warning(msg);
        }
      } else {
        // no linked work_order_line_id ‚Üí can‚Äôt grow menu, just mark quoted
        toast.success("Parts request marked as quoted.");
      }
    } else {
      toast.success(`Parts request marked as ${s}.`);
    }

    await load();
  }

  async function saveLine(it: Item) {
    const qty =
      typeof it.qty === "number" && !Number.isNaN(it.qty) ? it.qty : null;
    if (!qty || qty <= 0) {
      toast.error("Enter a quantity greater than 0 before saving.");
      return;
    }

    const cost =
      typeof it.quoted_price === "number" && !Number.isNaN(it.quoted_price)
        ? it.quoted_price
        : 0;
    const m = markupPct[it.id] ?? DEFAULT_MARKUP;

    const { error } = await supabase
      .from("part_request_items")
      .update({
        vendor: it.vendor ?? null,
        quoted_price: cost,
        qty,
        markup_pct: m,
      })
      .eq("id", it.id);

    if (error) {
      toast.error(error.message);
      return;
    }

    setSavedRows((prev) => ({ ...prev, [it.id]: true }));
    toast.success("Line saved");
  }

  async function attachPartToItem(itemId: string, partId: string) {
    const p = parts.find((x) => x.id === partId);
    const desc = p?.name ?? "Part";

    const { error } = await supabase
      .from("part_request_items")
      .update({
        part_id: partId,
        description: desc,
      })
      .eq("id", itemId);

    if (error) {
      console.warn("attachPartToItem failed:", error.message);
      toast.error("Cannot attach part ‚Äî check RLS.");
    } else {
      // change ‚Üí unsave
      setSavedRows((prev) => ({ ...prev, [itemId]: false }));
      await load();
    }
  }

  // manual: create part in inventory, then attach
  async function createManualPartAndAttach(
    itemId: string,
    name: string,
    sku: string,
  ) {
    const item = items.find((x) => x.id === itemId);
    if (!item) return;
    if (!req?.shop_id) {
      toast.error("Cannot create part ‚Äî missing shop.");
      return;
    }
    if (!name.trim()) {
      toast.error("Enter a name for the part.");
      return;
    }

    // create part in inventory
    const { data: inserted, error } = await supabase
      .from("parts")
      .insert({
        shop_id: req.shop_id,
        name: name.trim(),
        sku: sku.trim() || null,
      })
      .select("*")
      .maybeSingle<Part>();

    if (error) {
      toast.error(error.message);
      return;
    }

    if (!inserted) {
      toast.error("Unable to create part.");
      return;
    }

    // attach to item
    const { error: attachErr } = await supabase
      .from("part_request_items")
      .update({
        part_id: inserted.id,
        description: inserted.name ?? name.trim(),
      })
      .eq("id", itemId);

    if (attachErr) {
      toast.error(attachErr.message);
      return;
    }

    toast.success("Part created and attached.");
    // clear manual fields for that line
    setManualParts((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });

    // reload so the new part shows up in the select too
    await load();
  }

  const grandTotals = (() => {
    let sum = 0;
    for (const it of items) {
      const cost =
        typeof it.quoted_price === "number" && !Number.isNaN(it.quoted_price)
          ? it.quoted_price
          : 0;
      const m = markupPct[it.id] ?? DEFAULT_MARKUP;
      const unitSell = cost * (1 + m / 100);
      const qty =
        typeof it.qty === "number" && it.qty > 0 ? Number(it.qty) : 0;
      sum += unitSell * qty;
    }
    return sum;
  })();

  return (
    <div className="space-y-4 p-6 text-white">
      <button
        className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
        onClick={() => router.back()}
      >
        ‚Üê Back
      </button>

      {loading || !req ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-neutral-400">
          Loading‚Ä¶
        </div>
      ) : (
        <>
          {/* header */}
          <div className="rounded border border-neutral-800 bg-neutral-900 p-4">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div className="text-xl font-semibold">
                  Request #{req.id.slice(0, 8)}
                </div>
                <div className="text-sm text-neutral-400">
                  WO: {req.work_order_id ?? "‚Äî"} ¬∑{" "}
                  {req.created_at
                    ? new Date(req.created_at).toLocaleString()
                    : "‚Äî"}
                </div>
              </div>
              <div className="flex flex-wrap items-center gap-2">
                <span className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs capitalize text-neutral-200">
                  Status: {req.status}
                </span>
                {req.status !== "approved" && (
                  <button
                    className="rounded border border-blue-600 px-3 py-1.5 text-sm text-blue-300 hover:bg-blue-900/20"
                    onClick={() => void setStatus("approved")}
                  >
                    Mark Approved
                  </button>
                )}
                {req.status !== "quoted" && (
                  <button
                    className="rounded border border-orange-500 px-3 py-1.5 text-sm text-orange-300 hover:bg-orange-500/10"
                    onClick={() => void setStatus("quoted")}
                  >
                    Mark Quoted
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* items + table */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <h2 className="text-sm font-semibold text-neutral-200">
                Items in this request
              </h2>
              <button
                type="button"
                className="inline-flex items-center rounded border border-neutral-600 bg-neutral-900 px-3 py-1.5 text-xs font-medium text-neutral-100 hover:bg-neutral-800 disabled:opacity-60"
                onClick={() => void addItem()}
                disabled={addingItem}
              >
                {addingItem ? "Adding‚Ä¶" : "Ôºã Add item"}
              </button>
            </div>

            <div className="overflow-hidden rounded border border-neutral-800">
              <table className="w-full text-sm">
                <thead className="bg-neutral-900 text-neutral-400">
                  <tr>
                    <th className="p-2 text-left">Inventory</th>
                    <th className="p-2 text-left">Description</th>
                    <th className="p-2 text-right">Qty</th>
                    <th className="p-2 text-left">Vendor</th>
                    <th className="p-2 text-right">Cost (unit)</th>
                    <th className="p-2 text-right">Markup %</th>
                    <th className="p-2 text-right">Sell (unit)</th>
                    <th className="p-2 text-right">Line total</th>
                    <th className="w-32 p-2" />
                  </tr>
                </thead>
                <tbody>
                  {items.map((it) => {
                    const cost =
                      typeof it.quoted_price === "number" &&
                      !Number.isNaN(it.quoted_price)
                        ? it.quoted_price
                        : 0;
                    const m = markupPct[it.id] ?? DEFAULT_MARKUP;
                    const qty =
                      typeof it.qty === "number" && it.qty > 0
                        ? it.qty
                        : null;
                    const unitSell = cost * (1 + m / 100);
                    const lineTotal = unitSell * (qty ?? 0);
                    const isSaved = savedRows[it.id] === true;

                    const manual = manualParts[it.id] || {
                      name: "",
                      sku: "",
                    };

                    return (
                      <tr
                        key={it.id}
                        className={`border-t border-neutral-800 ${
                          isSaved ? "bg-neutral-900/50 text-neutral-400" : ""
                        }`}
                      >
                        <td className="p-2 align-top">
                          <div className="flex flex-col gap-1">
                            <select
                              className="w-40 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                              value={it.part_id ?? ""}
                              onChange={(e) => {
                                setSavedRows((prev) => ({
                                  ...prev,
                                  [it.id]: false,
                                }));
                                void attachPartToItem(it.id, e.target.value);
                              }}
                              disabled={isSaved}
                            >
                              <option value="">‚Äî select ‚Äî</option>
                              {parts.map((p) => (
                                <option key={p.id} value={p.id as string}>
                                  {p.sku ? `${p.sku} ‚Äî ${p.name}` : p.name}
                                </option>
                              ))}
                            </select>

                            {/* manual entry */}
                            <div className="flex gap-1">
                              <input
                                className="flex-1 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                                placeholder="Manual part name"
                                value={manual.name}
                                onChange={(e) =>
                                  setManualParts((prev) => ({
                                    ...prev,
                                    [it.id]: {
                                      name: e.target.value,
                                      sku: prev[it.id]?.sku ?? "",
                                    },
                                  }))
                                }
                                disabled={isSaved}
                              />
                              <input
                                className="w-20 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                                placeholder="SKU"
                                value={manual.sku}
                                onChange={(e) =>
                                  setManualParts((prev) => ({
                                    ...prev,
                                    [it.id]: {
                                      name: prev[it.id]?.name ?? "",
                                      sku: e.target.value,
                                    },
                                  }))
                                }
                                disabled={isSaved}
                              />
                            </div>
                            <button
                              className="rounded border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-xs hover:bg-neutral-800 disabled:opacity-50"
                              onClick={() =>
                                void createManualPartAndAttach(
                                  it.id,
                                  manual.name,
                                  manual.sku,
                                )
                              }
                              disabled={isSaved}
                            >
                              Add & attach
                            </button>
                          </div>
                        </td>
                        <td className="p-2 align-top">
                          <input
                            className="w-full rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                            value={it.description ?? ""}
                            placeholder="Description"
                            onChange={(e) => {
                              const v = e.target.value;
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id
                                    ? ({ ...x, description: v } as Item)
                                    : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            min={1}
                            step={1}
                            className="w-16 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={qty ?? ""} // allow empty
                            onChange={(e) => {
                              const raw = e.target.value;
                              setItems((prev) => {
                                return prev.map((x) => {
                                  if (x.id !== it.id) return x;
                                  return {
                                    ...x,
                                    qty: raw === "" ? null : Number(raw),
                                  } as Item;
                                });
                              });
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 align-top">
                          <input
                            className="w-32 rounded border border-neutral-700 bg-neutral-900 p-1 disabled:opacity-50"
                            value={it.vendor ?? ""}
                            onChange={(e) => {
                              const v = e.target.value;
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id ? { ...x, vendor: v } : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            step={0.01}
                            className="w-24 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={cost === 0 ? "" : cost}
                            onChange={(e) => {
                              const raw = e.target.value;
                              const v = raw === "" ? null : Number(raw);
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id
                                    ? ({ ...x, quoted_price: v } as Item)
                                    : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            step={1}
                            className="w-20 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={m}
                            onChange={(e) => {
                              setMarkupPct((prev) => ({
                                ...prev,
                                [it.id]: Math.max(
                                  0,
                                  Number(e.target.value || DEFAULT_MARKUP),
                                ),
                              }));
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right tabular-nums align-top">
                          {unitSell.toFixed(2)}
                        </td>
                        <td className="p-2 text-right tabular-nums align-top">
                          {lineTotal.toFixed(2)}
                        </td>
                        <td className="p-2 align-top">
                          <div className="flex flex-col items-stretch gap-1">
                            <button
                              className={`rounded border px-2 py-1 text-xs ${
                                isSaved
                                  ? "cursor-default border-neutral-700 bg-neutral-800/60 text-neutral-300"
                                  : "border-neutral-700 hover:bg-neutral-800"
                              }`}
                              onClick={() => !isSaved && void saveLine(it)}
                              disabled={isSaved}
                            >
                              {isSaved ? "Saved" : "Save"}
                            </button>
                            <button
                              className="rounded border border-red-700 px-2 py-1 text-xs text-red-200 hover:bg-red-900/40"
                              onClick={() => void deleteLine(it.id as string)}
                            >
                              Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot>
                  <tr className="bg-neutral-900/50">
                    <td className="p-2 text-right" colSpan={7}>
                      <span className="text-sm text-neutral-300">
                        Total (with markup)
                      </span>
                    </td>
                    <td className="p-2 text-right tabular-nums font-semibold">
                      {grandTotals.toFixed(2)}
                    </td>
                    <td />
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

========================================
FILE: app/parts/requests/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Request = DB["public"]["Tables"]["part_requests"]["Row"];
type Item = DB["public"]["Tables"]["part_request_items"]["Row"];
type WorkOrderMeta = {
  id: string;
  custom_id: string | null;
};

const ALL_STATUSES: Request["status"][] = [
  "requested",
  "quoted",
  "approved",
  "fulfilled",
  "rejected",
  "cancelled",
];

// Status columns we actually want to show on THIS page
const VISIBLE_STATUSES: Request["status"][] = [
  "requested",
  "quoted",
  "approved",
];

function makeEmptyBuckets(): Record<
  Request["status"],
  (Request & { items: Item[] })[]
> {
  return {
    requested: [],
    quoted: [],
    approved: [],
    fulfilled: [],
    rejected: [],
    cancelled: [],
  };
}

export default function PartsRequestsPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [byStatus, setByStatus] = useState<
    Record<Request["status"], (Request & { items: Item[] })[]>
  >(makeEmptyBuckets());

  const [workOrdersById, setWorkOrdersById] = useState<
    Record<string, WorkOrderMeta>
  >({});

  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    void (async () => {
      setLoading(true);

      // 1) fetch all requests
      const { data: reqs, error } = await supabase
        .from("part_requests")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("load part_requests failed:", error.message);
        toast.error("Failed to load parts requests");
        setLoading(false);
        return;
      }

      const requestList = (reqs ?? []) as Request[];
      const requestIds = requestList.map((r) => r.id);

      // 2) fetch all items for these requests
      const itemsMap: Record<string, Item[]> = {};
      if (requestIds.length) {
        const { data: items } = await supabase
          .from("part_request_items")
          .select("*")
          .in("request_id", requestIds);

        for (const it of items ?? []) {
          (itemsMap[it.request_id] ||= []).push(it);
        }
      }

      // 3) fetch work order metadata for display (TU000001 instead of UUID)
      const woIds = Array.from(
        new Set(
          requestList
            .map((r) => r.work_order_id)
            .filter((id): id is string => typeof id === "string" && !!id),
        ),
      );

      const woMap: Record<string, WorkOrderMeta> = {};
      if (woIds.length) {
        const { data: workOrders, error: woError } = await supabase
          .from("work_orders")
          .select("id, custom_id")
          .in("id", woIds);

        if (woError) {
          console.error(
            "load work_orders for parts requests failed:",
            woError.message,
          );
        } else {
          for (const wo of workOrders ?? []) {
            woMap[wo.id] = {
              id: wo.id,
              custom_id: wo.custom_id ?? null,
            };
          }
        }
      }
      setWorkOrdersById(woMap);

      // 4) group by status
      const grouped = makeEmptyBuckets();

      for (const r of requestList) {
        const status = (r.status ?? "requested") as Request["status"];
        const bucket = grouped[status] ?? grouped.requested;
        bucket.push({ ...r, items: itemsMap[r.id] ?? [] });
      }

      setByStatus(grouped);
      setLoading(false);
    })();
  }, [supabase]);

  // Derived: apply search filter client-side
  const filteredByStatus = useMemo(() => {
    const q = search.trim().toLowerCase();
    if (!q) return byStatus;

    const filtered = makeEmptyBuckets();

    (ALL_STATUSES as Request["status"][]).forEach((status) => {
      const list = byStatus[status] ?? [];
      filtered[status] = list.filter((r) => {
        const woMeta = r.work_order_id
          ? workOrdersById[r.work_order_id]
          : undefined;

        // label used both for display and search
        const woLabel =
          woMeta?.custom_id ||
          woMeta?.id ||
          r.work_order_id || // fall back to raw FK if meta missing
          "";

        const inWorkOrder = woLabel.toLowerCase().includes(q);
        const inRequestId = r.id.toLowerCase().includes(q);
        const inItems = (r.items ?? []).some((it) =>
          (it.description ?? "").toLowerCase().includes(q),
        );

        return inWorkOrder || inRequestId || inItems;
      });
    });

    return filtered;
  }, [search, byStatus, workOrdersById]);

  const handleDelete = async (requestId: string) => {
    const confirmed = window.confirm(
      "Delete this parts request? This will also remove its items.",
    );
    if (!confirmed) return;

    // delete items first (in case cascade is not configured)
    const { error: itemsError } = await supabase
      .from("part_request_items")
      .delete()
      .eq("request_id", requestId);

    if (itemsError) {
      console.error(
        "delete part_request_items failed:",
        itemsError.message,
      );
      toast.error("Unable to delete request items.");
      return;
    }

    const { error } = await supabase
      .from("part_requests")
      .delete()
      .eq("id", requestId);

    if (error) {
      console.error("delete part_requests failed:", error.message);
      toast.error("Unable to delete parts request.");
      return;
    }

    // update local state
    setByStatus((prev) => {
      const next = makeEmptyBuckets();
      (ALL_STATUSES as Request["status"][]).forEach((status) => {
        next[status] = (prev[status] ?? []).filter(
          (r) => r.id !== requestId,
        );
      });
      return next;
    });

    toast.success("Parts request deleted.");
  };

  const totalVisibleCount = VISIBLE_STATUSES.reduce(
    (sum, status) => sum + (filteredByStatus[status]?.length ?? 0),
    0,
  );

  return (
    <div className="space-y-4 p-6 text-white">
      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold">Parts Requests</h1>
          <p className="mt-1 text-sm text-neutral-400">
            Active requests that still need quoting or approval. Completed
            requests move off this list.
          </p>
        </div>
        <Link
          href="/parts"
          className="inline-flex items-center rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
        >
          Parts Catalog
        </Link>
      </div>

      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <p className="text-xs text-neutral-500">
          Search by WO#, request id, or line description. Showing{" "}
          <span className="font-semibold text-neutral-200">
            {totalVisibleCount}
          </span>{" "}
          active request{totalVisibleCount === 1 ? "" : "s"}.
        </p>
        <div className="w-full md:w-80">
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search requests‚Ä¶"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
          />
        </div>
      </div>

      {loading ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-neutral-400">
          Loading‚Ä¶
        </div>
      ) : (
        <div className="grid gap-4 lg:grid-cols-3 xl:grid-cols-4">
          {VISIBLE_STATUSES.map((status) => {
            const list = filteredByStatus[status] ?? [];
            return (
              <div
                key={status}
                className="flex flex-col rounded border border-neutral-800 bg-neutral-900"
              >
                <div className="border-b border-neutral-800 px-3 py-2 text-sm capitalize text-neutral-300">
                  {status}
                </div>
                <div className="flex-1 space-y-3 p-3">
                  {list.length === 0 ? (
                    <div className="text-sm text-neutral-500">
                      No requests
                    </div>
                  ) : (
                    list.map((r) => {
                      const woMeta = r.work_order_id
                        ? workOrdersById[r.work_order_id]
                        : undefined;

                      // Prefer TU000001-style custom id; otherwise fall back
                      // to whatever FK we have, shortened.
                      const woDisplayId =
                        woMeta?.custom_id ||
                        (woMeta?.id ??
                          r.work_order_id ??
                          "")
                          .toString()
                          .slice(0, 8) || null;

                      return (
                        <div
                          key={r.id}
                          className="rounded border border-neutral-800 bg-neutral-950"
                        >
                          <Link
                            href={`/parts/requests/${r.id}`}
                            className="block p-3 hover:border-orange-500"
                          >
                            <div className="flex items-start justify-between gap-2">
                              <div>
                                <div className="text-sm font-semibold">
                                  WO: {woDisplayId ?? "‚Äî"}
                                </div>
                                <div className="text-xs text-neutral-400">
                                  {r.created_at
                                    ? new Date(
                                        r.created_at,
                                      ).toLocaleString()
                                    : "‚Äî"}
                                </div>
                              </div>
                            </div>

                            <ul className="mt-2 list-disc space-y-1 pl-5 text-sm">
                              {(r.items ?? []).slice(0, 4).map((it) => (
                                <li key={it.id}>
                                  {it.description} √ó {Number(it.qty)}
                                </li>
                              ))}
                              {(r.items ?? []).length > 4 && (
                                <li>
                                  + {(r.items ?? []).length - 4} more‚Ä¶
                                </li>
                              )}
                            </ul>
                          </Link>

                          <div className="flex items-center justify-end gap-2 border-t border-neutral-800 px-3 py-2">
                            <button
                              type="button"
                              onClick={() => void handleDelete(r.id)}
                              className="text-xs font-medium text-red-300 hover:text-red-200"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/pay/cancel/page.tsx
========================================
// app/pay/cancel/page.tsx
import Link from "next/link";

export default function PayCancelPage() {
  return (
    <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#050910,_#020308_60%,_#000)] px-4 py-10 text-neutral-100">
      <div className="mx-auto w-full max-w-2xl rounded-2xl border border-[var(--metal-border-soft)] bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.85)] backdrop-blur">
        <div className="mb-2 font-blackops text-[0.85rem] tracking-[0.26em] text-neutral-300">
          PROFixIQ Payments
        </div>

        <h1 className="text-2xl font-semibold text-neutral-100">Payment cancelled</h1>
        <p className="mt-2 text-sm text-neutral-300">
          No charge was completed. If you meant to pay, please try again from the invoice.
        </p>

        <div className="mt-6 flex flex-wrap gap-2">
          <Link
            href="/"
            className="rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-4 py-2 text-xs font-semibold uppercase tracking-[0.22em] text-black shadow-[0_0_20px_rgba(212,118,49,0.55)] hover:brightness-110"
          >
            Back to app
          </Link>

          <Link
            href="/support"
            className="rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-4 py-2 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5"
          >
            Contact support
          </Link>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/pay/success/page.tsx
========================================
// app/pay/success/page.tsx
import Stripe from "stripe";
import Link from "next/link";

type SearchParams = Record<string, string | string[] | undefined>;

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY ?? "", {
  apiVersion: "2024-04-10" as Stripe.LatestApiVersion,
});

function getStr(searchParams: SearchParams, key: string): string | null {
  const v = searchParams[key];
  if (typeof v === "string") return v;
  if (Array.isArray(v) && typeof v[0] === "string") return v[0];
  return null;
}

function fmtMoney(amountCents: number, currency: string): string {
  const cur = currency.toUpperCase();
  const dollars = (amountCents / 100).toFixed(2);
  return `${cur} $${dollars}`;
}

export default async function PaySuccessPage({
  searchParams,
}: {
  searchParams?: Promise<SearchParams>;
}) {
  const sp = (await searchParams) ?? {};
  const sessionId = getStr(sp, "session_id");

  let title = "Payment complete";
  let subtitle = "Thanks ‚Äî the payment was received.";
  let amountText: string | null = null;
  let shopId: string | null = null;
  let workOrderId: string | null = null;

  if (!process.env.STRIPE_SECRET_KEY) {
    title = "Payment status";
    subtitle = "Server is missing STRIPE_SECRET_KEY.";
  } else if (!sessionId) {
    title = "Payment status";
    subtitle = "Missing session_id.";
  } else {
    try {
      const session = await stripe.checkout.sessions.retrieve(sessionId);

      shopId = session.metadata?.shop_id ?? null;
      workOrderId = session.metadata?.work_order_id ?? null;

      const amountTotal =
        typeof session.amount_total === "number" ? session.amount_total : null;
      const currency =
        typeof session.currency === "string" ? session.currency : null;

      if (amountTotal !== null && currency) {
        amountText = fmtMoney(amountTotal, currency);
      }

      if (session.payment_status && session.payment_status !== "paid") {
        title = "Payment pending";
        subtitle =
          "We received the checkout session, but it is not marked paid yet.";
      }
    } catch {
      title = "Payment status";
      subtitle = "Could not verify the payment session.";
    }
  }

  return (
    <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#050910,_#020308_60%,_#000)] px-4 py-10 text-neutral-100">
      <div className="mx-auto w-full max-w-2xl rounded-2xl border border-[var(--metal-border-soft)] bg-black/35 p-6 shadow-[0_24px_80px_rgba(0,0,0,0.85)] backdrop-blur">
        <div className="mb-2 font-blackops text-[0.85rem] tracking-[0.26em] text-neutral-300">
          PROFIXIQ PAYMENTS
        </div>

        <h1 className="text-2xl font-semibold text-neutral-100">{title}</h1>
        <p className="mt-2 text-sm text-neutral-300">{subtitle}</p>

        <div className="mt-5 space-y-2 rounded-xl border border-[var(--metal-border-soft)] bg-black/40 p-4">
          {amountText ? (
            <div className="text-sm text-neutral-200">
              Amount:{" "}
              <span className="font-semibold text-neutral-50">
                {amountText}
              </span>
            </div>
          ) : null}

          {workOrderId ? (
            <div className="text-sm text-neutral-200">
              Work Order:{" "}
              <span className="font-mono text-neutral-50">{workOrderId}</span>
            </div>
          ) : null}

          {shopId ? (
            <div className="text-sm text-neutral-200">
              Shop: <span className="font-mono text-neutral-50">{shopId}</span>
            </div>
          ) : null}

          {sessionId ? (
            <div className="text-[11px] text-neutral-400">
              Session: <span className="font-mono">{sessionId}</span>
            </div>
          ) : null}
        </div>

        <div className="mt-6 flex flex-wrap gap-2">
          <Link
            href={workOrderId ? `/work-orders/${workOrderId}` : "/"}
            className="rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-4 py-2 text-xs font-semibold uppercase tracking-[0.22em] text-black shadow-[0_0_20px_rgba(212,118,49,0.55)] hover:brightness-110"
          >
            Return to app
          </Link>

          <Link
            href="/pay/cancel"
            className="rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-4 py-2 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5"
          >
            Need help
          </Link>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/dashboard/appointments/page.tsx
========================================
// app/dashboard/appointments/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast, Toaster } from "sonner";

import WeeklyCalendar from "./WeeklyCalendar";
import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";

type ShopRow = Database["public"]["Tables"]["shops"]["Row"];
type CustomerRow = Database["public"]["Tables"]["customers"]["Row"];

export type Booking = {
  id: string;
  shop_slug?: string | null;
  starts_at: string; // ISO
  ends_at: string; // ISO
  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;
  notes?: string | null;
  status?: string | null; // pending, confirmed, cancelled...
};

const isoDate = (d: Date) => d.toISOString().slice(0, 10);

function startOfToday(): Date {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
}

function cardClass() {
  return "rounded-2xl border border-neutral-800/70 bg-neutral-950/45 p-4 backdrop-blur-md";
}

function fieldClass() {
  return "mt-1 w-full rounded-md border border-neutral-800 bg-neutral-950/60 px-2 py-1 text-sm text-white outline-none focus:border-orange-500/60 focus:ring-1 focus:ring-orange-500/40";
}

function safeString(v: unknown): string {
  return typeof v === "string" ? v : "";
}

function customerLabel(c: CustomerRow): string {
  const rec = c as unknown as Record<string, unknown>;

  const first = safeString(rec["first_name"]);
  const last = safeString(rec["last_name"]);
  const full = safeString(rec["full_name"]) || safeString(rec["name"]);
  const name =
    full || `${first} ${last}`.trim() || safeString(rec["email"]) || "Customer";

  const phone = safeString(rec["phone"]) || safeString(rec["mobile"]);
  return phone ? `${name} (${phone})` : name;
}

function pillClass(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed")
    return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled")
    return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-orange-500/30 bg-orange-900/10 text-orange-200";
}

export default function PortalAppointmentsPage() {
  const supabase = createClientComponentClient<Database>();
  const search = useSearchParams();
  const router = useRouter();

  const [shops, setShops] = useState<ShopRow[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");

  const [customers, setCustomers] = useState<CustomerRow[]>([]);
  const [loadingCustomers, setLoadingCustomers] = useState(false);

  const [weekStart, setWeekStart] = useState<Date>(() => startOfToday());

  const [bookings, setBookings] = useState<Booking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  const [editing, setEditing] = useState<Booking | null>(null);
  const [creatingDate, setCreatingDate] = useState<string | null>(null);

  // load shops
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        toast.error("Unable to load shops.");
        return;
      }

      const rows = (data ?? []) as ShopRow[];
      setShops(rows);

      if (!shopSlug && rows.length > 0) {
        const first = rows[0].slug as string;
        setShopSlug(first);
        router.replace(`/dashboard/appointments?shop=${encodeURIComponent(first)}`);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const selectedShop = useMemo(
    () => shops.find((s) => (s.slug as string | null) === shopSlug) ?? null,
    [shops, shopSlug],
  );

  // load customers for selected shop
  useEffect(() => {
    if (!selectedShop) return;

    (async () => {
      setLoadingCustomers(true);
      try {
        const { data, error } = await supabase
          .from("customers")
          .select("*")
          .eq("shop_id", selectedShop.id)
          .order("last_name", { ascending: true })
          .order("first_name", { ascending: true });

        if (error) {
          console.error(error);
          toast.error("Unable to load customers.");
          setCustomers([]);
        } else {
          setCustomers((data ?? []) as CustomerRow[]);
        }
      } catch (e) {
        console.error(e);
        toast.error("Unable to load customers.");
        setCustomers([]);
      } finally {
        setLoadingCustomers(false);
      }
    })();
  }, [supabase, selectedShop]);

  const weekEnd = useMemo(() => {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + 6);
    return d;
  }, [weekStart]);

  // fetch bookings for week
  useEffect(() => {
    if (!shopSlug) return;
    (async () => {
      setLoadingBookings(true);
      try {
        const start = isoDate(weekStart);
        const end = isoDate(weekEnd);
        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
          { cache: "no-store" },
        );
        if (!res.ok) throw new Error("Failed to load appointments.");
        const j = (await res.json().catch(() => [])) as Booking[];
        setBookings(j ?? []);
      } catch (err: unknown) {
        console.error(err);
        toast.error("Failed to load appointments.");
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [shopSlug, weekStart, weekEnd]);

  async function handleCreate(form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) {
    if (!shopSlug) {
      toast.error("Select a shop first.");
      return;
    }

    try {
      const startIso = new Date(`${form.date}T${form.startsAt}`).toISOString();
      const endIso = new Date(`${form.date}T${form.endsAt}`).toISOString();

      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: form.notes,
          customerId: form.customerId ?? null,
          customerName: form.customerName,
          customerEmail: form.customerEmail,
          customerPhone: form.customerPhone,
        }),
      });

      const j = (await res
        .json()
        .catch(() => ({}))) as { booking?: Booking; error?: string };

      if (!res.ok || !j.booking) {
        throw new Error(j?.error || "Unable to create appointment.");
      }

      setBookings((prev) => [...prev, j.booking as Booking]);

      toast.success("Appointment created.");
      setCreatingDate(null);

      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Create failed";
      toast.error(message);
    }
  }

  async function handleUpdate(id: string, patch: Partial<Booking>) {
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(patch),
      });
      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Update failed");

      toast.success("Appointment updated.");
      setEditing(null);
      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Update failed";
      toast.error(message);
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("Delete this appointment?")) return;
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Delete failed.");
      toast.success("Appointment deleted.");
      setBookings((prev) => prev.filter((b) => b.id !== id));
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Delete failed";
      toast.error(message);
    }
  }

  // quick actions for requests
  async function approveBooking(b: Booking) {
    await handleUpdate(b.id, { status: "confirmed" });
  }

  async function declineBooking(b: Booking) {
    await handleUpdate(b.id, { status: "cancelled" });
  }

  const pending = useMemo(
    () => bookings.filter((b) => (b.status || "pending").toLowerCase() === "pending"),
    [bookings],
  );
  const confirmed = useMemo(
    () => bookings.filter((b) => (b.status || "").toLowerCase() === "confirmed"),
    [bookings],
  );
  const cancelled = useMemo(
    () => bookings.filter((b) => (b.status || "").toLowerCase() === "cancelled"),
    [bookings],
  );

  const totalForWeek = useMemo(() => bookings.length, [bookings]);

  return (
    <div className="space-y-6">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-500">Appointments</h1>
        <p className="text-sm text-neutral-400">
          Admin / manager view of customer bookings for the week.
        </p>
      </header>

      {/* Shop selector */}
      <div className={cardClass()}>
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex items-center gap-3">
            <div className="text-[0.7rem] uppercase tracking-[0.12em] text-neutral-400">
              Shop
            </div>
            <select
              value={shopSlug}
              onChange={(e) => {
                const slug = e.target.value;
                setShopSlug(slug);
                router.replace(`/dashboard/appointments?shop=${encodeURIComponent(slug)}`);
              }}
              className={fieldClass() + " min-w-[220px]"}
            >
              {shops.map((s) => (
                <option key={s.slug as string} value={s.slug as string}>
                  {s.name}
                </option>
              ))}
            </select>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <div className="rounded-xl border border-neutral-800/70 bg-neutral-950/50 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-neutral-500">
                This week
              </div>
              <div className="text-sm font-semibold text-neutral-100">
                {totalForWeek} booking{totalForWeek === 1 ? "" : "s"}
              </div>
            </div>

            <div className="rounded-xl border border-orange-500/20 bg-orange-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-orange-200/80">
                Requests
              </div>
              <div className="text-sm font-semibold text-orange-100">
                {pending.length}
              </div>
            </div>

            <div className="rounded-xl border border-emerald-500/20 bg-emerald-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-emerald-200/80">
                Confirmed
              </div>
              <div className="text-sm font-semibold text-emerald-100">
                {confirmed.length}
              </div>
            </div>

            <div className="rounded-xl border border-red-500/20 bg-red-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-red-200/80">
                Cancelled
              </div>
              <div className="text-sm font-semibold text-red-100">
                {cancelled.length}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* NEW: Requests panel */}
      <div className={cardClass()}>
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">
            Appointment requests (pending)
          </h2>
          {loadingBookings && (
            <span className="text-[0.75rem] text-neutral-400">Loading‚Ä¶</span>
          )}
        </div>

        {pending.length === 0 ? (
          <div className="rounded-xl border border-dashed border-neutral-800/70 bg-neutral-950/40 p-3 text-sm text-neutral-400">
            No pending requests for this week.
          </div>
        ) : (
          <ul className="divide-y divide-neutral-800/70">
            {pending
              .slice()
              .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at))
              .map((b) => (
                <li key={b.id} className="flex flex-wrap items-center gap-3 py-3 text-sm">
                  <div className="min-w-0 flex-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="font-medium text-neutral-50">
                        {b.customer_name || "Customer"}
                      </div>
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>
                    </div>

                    <div className="mt-0.5 text-[0.75rem] text-neutral-400">
                      {new Date(b.starts_at).toLocaleString()} ‚Äì{" "}
                      {new Date(b.ends_at).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </div>

                    <div className="mt-1 flex flex-wrap gap-x-3 gap-y-1 text-[0.75rem] text-neutral-500">
                      {b.customer_phone ? <span>{b.customer_phone}</span> : null}
                      {b.customer_email ? <span>{b.customer_email}</span> : null}
                    </div>

                    {b.notes ? (
                      <div className="mt-1 text-[0.75rem] text-neutral-500">
                        {b.notes}
                      </div>
                    ) : null}
                  </div>

                  <div className="flex items-center gap-2">
                    <Button
                      type="button"
                      size="xs"
                      className="font-semibold"
                      onClick={() => void approveBooking(b)}
                    >
                      Approve
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="outline"
                      className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                      onClick={() => void declineBooking(b)}
                    >
                      Decline
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="outline"
                      onClick={() => setEditing(b)}
                    >
                      Edit
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="ghost"
                      className="text-red-300 hover:bg-red-900/25"
                      onClick={() => void handleDelete(b.id)}
                    >
                      Delete
                    </Button>
                  </div>
                </li>
              ))}
          </ul>
        )}
      </div>

      {/* Calendar */}
      <div className={cardClass()}>
        <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
          <h2 className="text-sm font-semibold text-neutral-50">Weekly calendar</h2>
          <div className="flex items-center gap-2">
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() - 7);
                setWeekStart(d);
              }}
            >
              ‚Üê Prev
            </Button>
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => setWeekStart(startOfToday())}
            >
              Today
            </Button>
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + 7);
                setWeekStart(d);
              }}
            >
              Next ‚Üí
            </Button>
          </div>
        </div>

        <div className="overflow-x-auto pb-2">
          <WeeklyCalendar
            weekStart={weekStart}
            bookings={bookings}
            onSelectDay={(dayIso) => setCreatingDate(dayIso)}
            onSelectBooking={(b) => setEditing(b)}
            loading={loadingBookings}
          />
        </div>

        <p className="mt-3 text-[0.75rem] text-neutral-500">
          Click a day to create. Click an appointment to edit.
        </p>
      </div>

      {/* Create / Edit */}
      <div className={cardClass()}>
        {editing ? (
          <EditForm
            booking={editing}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onCancel={() => setEditing(null)}
            onSave={(patch) => void handleUpdate(editing.id, patch)}
          />
        ) : (
          <CreateForm
            defaultDate={creatingDate ?? isoDate(weekStart)}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onSubmit={handleCreate}
          />
        )}
      </div>

      {/* List */}
      <div className={cardClass()}>
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">
            Appointments this week ({bookings.length})
          </h2>
          {loadingBookings && (
            <span className="text-[0.75rem] text-neutral-400">Loading‚Ä¶</span>
          )}
        </div>

        {loadingBookings ? (
          <p className="text-sm text-neutral-400">Fetching appointments‚Ä¶</p>
        ) : bookings.length === 0 ? (
          <p className="text-sm text-neutral-400">No appointments for this week.</p>
        ) : (
          <ul className="divide-y divide-neutral-800/70">
            {bookings
              .slice()
              .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at))
              .map((b) => (
                <li key={b.id} className="flex flex-wrap items-center gap-3 py-3 text-sm">
                  <div className="min-w-0 flex-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="font-medium text-neutral-50">
                        {b.customer_name || "Customer"}
                      </div>
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>
                    </div>

                    <div className="text-[0.75rem] text-neutral-400">
                      {new Date(b.starts_at).toLocaleString()} ‚Äì{" "}
                      {new Date(b.ends_at).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </div>
                    {b.notes ? (
                      <div className="mt-1 text-[0.75rem] text-neutral-500">{b.notes}</div>
                    ) : null}
                  </div>

                  <div className="flex items-center gap-2">
                    {(b.status || "pending").toLowerCase() === "pending" ? (
                      <>
                        <Button type="button" size="xs" onClick={() => void approveBooking(b)}>
                          Approve
                        </Button>
                        <Button
                          type="button"
                          size="xs"
                          variant="outline"
                          className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                          onClick={() => void declineBooking(b)}
                        >
                          Decline
                        </Button>
                      </>
                    ) : null}

                    <Button type="button" size="xs" variant="outline" onClick={() => setEditing(b)}>
                      Edit
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="ghost"
                      className="text-red-300 hover:bg-red-900/25"
                      onClick={() => void handleDelete(b.id)}
                    >
                      Delete
                    </Button>
                  </div>
                </li>
              ))}
          </ul>
        )}
      </div>
    </div>
  );
}

async function refreshBookings(
  shopSlug: string,
  weekStart: Date,
  weekEnd: Date,
  setBookings: (b: Booking[]) => void,
) {
  const start = isoDate(weekStart);
  const end = isoDate(weekEnd);
  const res = await fetch(
    `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
    { cache: "no-store" },
  );
  const refreshed = (await res.json().catch(() => [])) as Booking[];
  setBookings(refreshed ?? []);
}

/* -------------------------------------------------------------------------- */
/* Forms                                                                      */
/* -------------------------------------------------------------------------- */

function CreateForm({
  defaultDate,
  customers,
  loadingCustomers,
  onSubmit,
}: {
  defaultDate: string;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onSubmit: (form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) => void;
}) {
  const [date, setDate] = useState(defaultDate);
  const [startsAt, setStartsAt] = useState("09:00");
  const [endsAt, setEndsAt] = useState("10:00");
  const [customerId, setCustomerId] = useState<string>("");
  const [customerName, setCustomerName] = useState("");
  const [customerEmail, setCustomerEmail] = useState("");
  const [customerPhone, setCustomerPhone] = useState("");
  const [notes, setNotes] = useState("");

  useEffect(() => {
    setDate(defaultDate);
  }, [defaultDate]);

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        onSubmit({
          date,
          startsAt,
          endsAt,
          customerId: customerId || undefined,
          customerName,
          customerEmail,
          customerPhone,
          notes,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Create appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading‚Ä¶" : "Select‚Ä¶"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input
          value={customerName}
          onChange={(e) => setCustomerName(e.target.value)}
          className={fieldClass()}
          placeholder="John Smith"
        />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <Button type="submit" size="sm" className="mt-1 font-semibold">
        Save appointment
      </Button>
    </form>
  );
}

function EditForm({
  booking,
  customers,
  loadingCustomers,
  onCancel,
  onSave,
}: {
  booking: Booking;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onCancel: () => void;
  onSave: (patch: Partial<Booking>) => void;
}) {
  const start = new Date(booking.starts_at);
  const end = new Date(booking.ends_at);

  const [date, setDate] = useState(booking.starts_at.slice(0, 10));
  const [startsAt, setStartsAt] = useState(start.toISOString().slice(11, 16));
  const [endsAt, setEndsAt] = useState(end.toISOString().slice(11, 16));

  const [customerId, setCustomerId] = useState<string>(booking.customer_id ?? "");
  const [customerName, setCustomerName] = useState(booking.customer_name ?? "");
  const [customerEmail, setCustomerEmail] = useState(booking.customer_email ?? "");
  const [customerPhone, setCustomerPhone] = useState(booking.customer_phone ?? "");
  const [notes, setNotes] = useState(booking.notes ?? "");
  const [status, setStatus] = useState(booking.status ?? "pending");

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        const starts_at = new Date(`${date}T${startsAt}`).toISOString();
        const ends_at = new Date(`${date}T${endsAt}`).toISOString();
        onSave({
          starts_at,
          ends_at,
          customer_id: customerId || null,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          notes,
          status,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Edit appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading‚Ä¶" : "Select‚Ä¶"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} className={fieldClass()} />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <label className="text-xs text-neutral-300">
        Status
        <select value={status} onChange={(e) => setStatus(e.target.value)} className={fieldClass()}>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </label>

      <div className="flex gap-2">
        <Button type="submit" size="sm" className="font-semibold">
          Save changes
        </Button>
        <Button type="button" size="sm" variant="outline" onClick={onCancel}>
          Cancel
        </Button>
      </div>
    </form>
  );
}

========================================
FILE: app/dashboard/appointments/WeeklyCalendar.tsx
========================================
// app/dashboard/appointments/WeeklyCalendar.tsx
"use client";

import { useMemo } from "react";
import type { Booking } from "./page";
import { Button } from "@shared/components/ui/Button";

type Props = {
  weekStart: Date;
  bookings: Booking[];
  onSelectDay: (iso: string) => void;
  onSelectBooking: (b: Booking) => void;
  loading?: boolean;
};

function pad2(n: number) {
  return n < 10 ? `0${n}` : `${n}`;
}

// Local date key (prevents UTC drift that can happen with toISOString())
function dayKeyLocal(d: Date) {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}

function timeLabel(startsAtIso: string, endsAtIso: string) {
  const start = new Date(startsAtIso);
  const end = new Date(endsAtIso);
  const s = start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const e = end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  return `${s} ‚Äì ${e}`;
}

function safeStr(v: unknown) {
  return typeof v === "string" ? v : "";
}

function displayCustomerName(b: Booking): string {
  // keep compatibility with any older/extra fields without ts-ignore
  const rec = b as unknown as Record<string, unknown>;
  const fromExtra =
    safeStr(rec["customer_full_name"]) ||
    safeStr(rec["customerName"]) ||
    safeStr(rec["name"]);

  return safeStr(b.customer_name) || fromExtra || "Customer";
}

function statusPill(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed") return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled") return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-orange-500/30 bg-orange-900/10 text-orange-200";
}

function bookingCardStyle(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "cancelled") {
    return "border-white/10 bg-black/35 text-neutral-300 hover:bg-black/40";
  }
  if (s === "confirmed") {
    return "border-emerald-400/25 bg-emerald-500/10 hover:bg-emerald-500/15";
  }
  // pending
  return "border-orange-400/30 bg-orange-500/10 hover:bg-orange-500/15";
}

export default function WeeklyCalendar({
  weekStart,
  bookings,
  onSelectDay,
  onSelectBooking,
  loading = false,
}: Props) {
  const days = useMemo(() => {
    return Array.from({ length: 7 }, (_, i) => {
      const d = new Date(weekStart);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + i);
      return d;
    });
  }, [weekStart]);

  const grouped = useMemo(() => {
    const map = new Map<string, Booking[]>();

    for (const b of bookings) {
      const d = new Date(b.starts_at);
      const k = dayKeyLocal(d);
      const arr = map.get(k) ?? [];
      arr.push(b);
      map.set(k, arr);
    }

    map.forEach((arr) => {
      arr.sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at));
    });

    return map;
  }, [bookings]);

  const todayKey = dayKeyLocal(new Date());

  return (
    <div className="grid grid-cols-1 gap-3 md:grid-cols-7">
      {days.map((d) => {
        const k = dayKeyLocal(d);
        const dayBookings = grouped.get(k) ?? [];
        const isToday = todayKey === k;

        const activeCount = dayBookings.filter(
          (b) => (b.status || "pending").toLowerCase() !== "cancelled",
        ).length;

        return (
          <div
            key={k}
            className="flex min-h-[160px] flex-col gap-2 rounded-2xl border border-white/10 bg-black/35 p-3 text-xs text-neutral-100 shadow-card backdrop-blur-md overflow-hidden"
          >
            {/* Day header */}
            <div className="flex items-center gap-2">
              <Button
                type="button"
                variant={isToday ? "default" : "outline"}
                size="sm"
                onClick={() => onSelectDay(k)}
                className="flex w-full items-center justify-between rounded-xl px-2 py-1 text-[0.75rem]"
              >
                <span className="font-medium">
                  {d.toLocaleDateString(undefined, {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                  })}
                </span>

                <span className="flex items-center gap-2">
                  {isToday ? (
                    <span className="rounded-full bg-black/15 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.12em]">
                      Today
                    </span>
                  ) : null}

                  <span className="rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.65rem] text-neutral-200">
                    {activeCount}
                  </span>
                </span>
              </Button>
            </div>

            {/* Appointments list */}
            <div className="flex-1 space-y-1.5">
              {loading && dayBookings.length === 0 ? (
                <div className="space-y-2">
                  <div className="h-9 w-full animate-pulse rounded-xl border border-white/10 bg-white/5" />
                  <div className="h-9 w-full animate-pulse rounded-xl border border-white/10 bg-white/5" />
                </div>
              ) : dayBookings.length === 0 ? (
                <div className="rounded-xl border border-dashed border-white/10 bg-black/25 px-2 py-2 text-[0.65rem] text-neutral-500">
                  No appointments
                </div>
              ) : (
                dayBookings.map((b) => {
                  const s = (b.status || "pending").toLowerCase();
                  const isCancelled = s === "cancelled";

                  return (
                    <Button
                      key={b.id}
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => onSelectBooking(b)}
                      className={
                        "flex w-full flex-col items-start gap-1 rounded-xl border px-2 py-2 text-left text-[0.7rem] " +
                        bookingCardStyle(b.status)
                      }
                    >
                      <div className="flex w-full items-center justify-between gap-2">
                        <div className={"truncate font-semibold " + (isCancelled ? "text-neutral-200/80 line-through" : "text-white")}>
                          {displayCustomerName(b)}
                        </div>

                        <div className="flex items-center gap-2">
                          <span
                            className={
                              "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.6rem] uppercase tracking-[0.14em] " +
                              statusPill(b.status)
                            }
                          >
                            {b.status || "pending"}
                          </span>

                          <span className={"whitespace-nowrap text-[0.6rem] " + (isCancelled ? "text-neutral-400" : "text-neutral-200")}>
                            {timeLabel(b.starts_at, b.ends_at)}
                          </span>
                        </div>
                      </div>

                      {b.notes ? (
                        <div className="line-clamp-2 text-[0.62rem] text-neutral-200/80">
                          {b.notes}
                        </div>
                      ) : null}
                    </Button>
                  );
                })
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}

========================================
FILE: app/portal/approvals/page.tsx
========================================
// app/portal/approvals/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { Toaster, toast } from "sonner";

const COPPER = "#C57A4A";

type ApprovalItem = {
  id: string;
  description: string | null;
  qty: number | null;
  vendor: string | null;
  quoted_price: number | null;
  markup_pct: number | null;
  approved: boolean | null;
  request_id: string | null;
};

type ApprovalLine = {
  id: string; // work_order_lines.id
  description: string | null;
  complaint: string | null;
  approval_state: string | null;
  status: string | null;
  hold_reason: string | null;
  work_order_id: string;
  created_at: string | null;

  // joined
  work_orders: {
    id: string;
    custom_id: string | null;
    created_at: string | null;
    customer_id: string | null;
  };

  part_request_items: ApprovalItem[];
};

type PartRequestHeader = {
  id: string;
  status: string | null;
  notes: string | null;
  created_at: string | null;
};

type ApprovalsPayload = {
  lines: ApprovalLine[];
  partRequestHeaders: PartRequestHeader[];
};

function cx(...parts: Array<string | false | null | undefined>) {
  return parts.filter(Boolean).join(" ");
}

function isRecord(v: unknown): v is Record<string, unknown> {
  return typeof v === "object" && v !== null;
}

function fmtMoney(n: number | null | undefined) {
  if (typeof n !== "number" || Number.isNaN(n)) return "‚Äî";
  return new Intl.NumberFormat(undefined, {
    style: "currency",
    currency: "CAD",
    maximumFractionDigits: 2,
  }).format(n);
}

function fmtDate(iso: string | null | undefined) {
  if (!iso) return "‚Äî";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString();
}

function statusLabel(s: string | null | undefined) {
  return (s ?? "pending").replaceAll("_", " ");
}

function badgeTone(kind: "pending" | "approved" | "mixed") {
  if (kind === "approved") return "border-emerald-400/40 bg-emerald-400/10 text-emerald-100";
  if (kind === "mixed") return "border-amber-400/40 bg-amber-400/10 text-amber-100";
  return "border-sky-400/40 bg-sky-400/10 text-sky-100";
}

async function readJson(res: Response): Promise<unknown> {
  const txt = await res.text();
  if (!txt) return null;
  try {
    return JSON.parse(txt) as unknown;
  } catch {
    return txt; // return raw text if not JSON
  }
}

function safePayload(v: unknown): ApprovalsPayload {
  if (!isRecord(v)) return { lines: [], partRequestHeaders: [] };

  const linesRaw = v.lines;
  const headersRaw = v.partRequestHeaders;

  const lines = Array.isArray(linesRaw) ? (linesRaw as ApprovalLine[]) : [];
  const partRequestHeaders = Array.isArray(headersRaw)
    ? (headersRaw as PartRequestHeader[])
    : [];

  return { lines, partRequestHeaders };
}

export default function PortalApprovalsPage() {
  const router = useRouter();

  const [lines, setLines] = useState<ApprovalLine[]>([]);
  const [headers, setHeaders] = useState<PartRequestHeader[]>([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [busyItemId, setBusyItemId] = useState<string | null>(null);

  const fetchApprovals = async (opts?: { silent?: boolean }) => {
    const silent = Boolean(opts?.silent);
    if (!silent) setLoading(true);
    else setRefreshing(true);

    setError(null);
    try {
      const res = await fetch("/api/portal/approvals", { method: "GET", cache: "no-store" });
      const parsed = await readJson(res);

      if (!res.ok) {
        const msg =
          (isRecord(parsed) && typeof parsed.error === "string" && parsed.error) ||
          (typeof parsed === "string" ? parsed : null) ||
          `Failed to load approvals (status ${res.status})`;

        setError(msg);
        setLines([]);
        setHeaders([]);
        return;
      }

      const payload = safePayload(parsed);
      setLines(payload.lines);
      setHeaders(payload.partRequestHeaders);
    } catch (e: unknown) {
      setError(e instanceof Error ? e.message : "Failed to load approvals");
      setLines([]);
      setHeaders([]);
    } finally {
      if (!silent) setLoading(false);
      else setRefreshing(false);
    }
  };

  useEffect(() => {
    void fetchApprovals();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const flattenedCount = useMemo(() => {
    let n = 0;
    lines.forEach((ln) => (n += Array.isArray(ln.part_request_items) ? ln.part_request_items.length : 0));
    return n;
  }, [lines]);

  const approveItem = async (itemId: string) => {
    if (!itemId || busyItemId) return;
    setBusyItemId(itemId);

    try {
      const res = await fetch("/api/portal/approvals/item/approve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
        body: JSON.stringify({ itemId }),
      });

      const parsed = await readJson(res);
      if (!res.ok) {
        const msg =
          (isRecord(parsed) && typeof parsed.error === "string" && parsed.error) ||
          (typeof parsed === "string" ? parsed : null) ||
          `Approve failed (${res.status})`;

        toast.error(msg);
        return;
      }

      toast.success("Approved");
      await fetchApprovals({ silent: true });
    } catch (e: unknown) {
      toast.error(e instanceof Error ? e.message : "Approve failed");
    } finally {
      setBusyItemId(null);
    }
  };

  const declineItem = async (itemId: string) => {
    if (!itemId || busyItemId) return;
    setBusyItemId(itemId);

    try {
      const res = await fetch("/api/portal/approvals/item/decline", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
        body: JSON.stringify({ itemId }),
      });

      const parsed = await readJson(res);
      if (!res.ok) {
        const msg =
          (isRecord(parsed) && typeof parsed.error === "string" && parsed.error) ||
          (typeof parsed === "string" ? parsed : null) ||
          `Decline failed (${res.status})`;

        toast.error(msg);
        return;
      }

      toast.success("Declined");
      await fetchApprovals({ silent: true });
    } catch (e: unknown) {
      toast.error(e instanceof Error ? e.message : "Decline failed");
    } finally {
      setBusyItemId(null);
    }
  };

  const lineSummary = (ln: ApprovalLine) => {
    const items = Array.isArray(ln.part_request_items) ? ln.part_request_items : [];
    if (items.length === 0) return { kind: "pending" as const, text: "No items" };

    const approvedCount = items.filter((it) => Boolean(it.approved)).length;
    if (approvedCount === 0) return { kind: "pending" as const, text: "Awaiting your approval" };
    if (approvedCount === items.length) return { kind: "approved" as const, text: "All items approved" };
    return { kind: "mixed" as const, text: `${approvedCount}/${items.length} approved` };
  };

  const shell =
    "rounded-3xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card sm:p-6";
  const glass =
    "rounded-2xl border border-white/10 bg-black/25 backdrop-blur-md shadow-card";
  const metalHeader =
    "rounded-2xl border border-white/10 bg-gradient-to-r from-slate-900/70 via-black/40 to-black/60 px-4 py-3";

  return (
    <div className="min-h-dvh app-metal-bg text-white">
      <Toaster position="top-center" />
      <div className="mx-auto w-full max-w-5xl px-3 py-4 md:px-6">
        <div className={shell}>
          <div className={cx(metalHeader, "flex items-start justify-between gap-3")}>
            <div className="min-w-0">
              <div className="font-blackops text-[0.9rem] tracking-[0.18em]" style={{ color: COPPER }}>
                APPROVALS
              </div>
              <div className="mt-1 text-xs text-neutral-300">
                Review and approve parts for jobs awaiting your confirmation.
              </div>
              <div className="mt-2 text-[0.7rem] text-neutral-400">
                When all items on a job are approved, the job automatically moves forward.
              </div>
            </div>

            <div className="flex shrink-0 flex-col items-end gap-2">
              <div className="flex items-center gap-2">
                <span className="rounded-full border border-white/12 bg-black/40 px-3 py-1 text-[0.7rem] text-neutral-200">
                  {lines.length} jobs
                </span>
                <span className="rounded-full border border-white/12 bg-black/40 px-3 py-1 text-[0.7rem] text-neutral-200">
                  {flattenedCount} items
                </span>
              </div>

              <div className="flex items-center gap-2">
                <button
                  type="button"
                  onClick={() => void fetchApprovals({ silent: true })}
                  disabled={loading || refreshing}
                  className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-[0.7rem] font-semibold text-neutral-100 transition hover:bg-black/70 active:scale-95 disabled:opacity-60"
                >
                  {refreshing ? "Refreshing‚Ä¶" : "Refresh"}
                </button>
                <button
                  type="button"
                  onClick={() => router.push("/portal")}
                  className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-[0.7rem] font-semibold text-neutral-100 transition hover:bg-black/70 active:scale-95"
                >
                  Home
                </button>
              </div>
            </div>
          </div>

          {error ? (
            <div className="mt-4 rounded-2xl border border-red-400/40 bg-red-500/10 p-4">
              <div className="text-sm font-semibold text-red-100">Error</div>
              <div className="mt-1 whitespace-pre-wrap text-xs text-red-200">{error}</div>
              <div className="mt-3 flex gap-2">
                <button
                  type="button"
                  onClick={() => void fetchApprovals()}
                  className="inline-flex items-center rounded-full border border-red-400/40 bg-black/40 px-4 py-2 text-xs font-semibold text-red-100 hover:bg-black/70"
                >
                  Try again
                </button>
              </div>
            </div>
          ) : null}

          {loading && !error ? (
            <div className="mt-4 grid gap-3">
              <div className="h-24 rounded-2xl border border-white/10 bg-black/25 animate-pulse" />
              <div className="h-24 rounded-2xl border border-white/10 bg-black/25 animate-pulse" />
              <div className="h-24 rounded-2xl border border-white/10 bg-black/25 animate-pulse" />
            </div>
          ) : null}

          {!loading && !error && lines.length === 0 ? (
            <div className="mt-4 rounded-2xl border border-white/10 bg-black/25 p-6 text-center">
              <div className="text-sm font-semibold text-neutral-100">Nothing to approve</div>
              <div className="mt-1 text-xs text-neutral-400">
                You don‚Äôt have any jobs waiting for approval right now.
              </div>
              <div className="mt-4 flex justify-center gap-2">
                <button
                  type="button"
                  onClick={() => router.push("/portal")}
                  className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-4 py-2 text-xs font-semibold text-neutral-100 hover:bg-black/70"
                >
                  Back to portal
                </button>
                <button
                  type="button"
                  onClick={() => void fetchApprovals({ silent: true })}
                  className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-4 py-2 text-xs font-semibold text-neutral-100 hover:bg-black/70"
                >
                  Refresh
                </button>
              </div>
            </div>
          ) : null}

          {!loading && !error && lines.length > 0 ? (
            <div className="mt-4 space-y-3">
              {lines.map((ln) => {
                const title = (ln.description ?? ln.complaint ?? "Job").trim();
                const summary = lineSummary(ln);
                const items = Array.isArray(ln.part_request_items) ? ln.part_request_items : [];

                return (
                  <div key={ln.id} className={glass}>
                    <div className="flex flex-wrap items-start justify-between gap-3 border-b border-white/10 px-4 py-4">
                      <div className="min-w-0">
                        <div className="flex flex-wrap items-center gap-2">
                          <div className="truncate text-sm font-semibold text-neutral-100">{title}</div>
                          <span
                            className={cx(
                              "inline-flex items-center rounded-full border px-3 py-1 text-[0.7rem] font-semibold uppercase tracking-[0.14em]",
                              badgeTone(summary.kind),
                            )}
                          >
                            {summary.text}
                          </span>
                        </div>

                        <div className="mt-1 flex flex-wrap items-center gap-2 text-[0.7rem] text-neutral-400">
                          <span className="rounded-full border border-white/10 bg-black/35 px-2 py-0.5">
                            Status: {statusLabel(ln.status)}
                          </span>
                          <span className="rounded-full border border-white/10 bg-black/35 px-2 py-0.5">
                            Approval: {statusLabel(ln.approval_state)}
                          </span>
                          {ln.hold_reason ? (
                            <span className="rounded-full border border-white/10 bg-black/35 px-2 py-0.5">
                              Hold: {ln.hold_reason}
                            </span>
                          ) : null}
                          <span className="rounded-full border border-white/10 bg-black/35 px-2 py-0.5">
                            Created: {fmtDate(ln.created_at)}
                          </span>
                        </div>
                      </div>

                      <div className="shrink-0 text-right">
                        <div className="text-[0.65rem] text-neutral-400 uppercase tracking-[0.18em]">
                          Work order
                        </div>
                        <div className="mt-1 rounded-full border border-white/12 bg-black/40 px-3 py-1 font-mono text-[0.7rem] text-neutral-100">
                          {ln.work_order_id}
                        </div>
                      </div>
                    </div>

                    <div className="px-4 py-4">
                      <div className="mb-2 flex items-center justify-between gap-2">
                        <div className="text-[0.75rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
                          Parts
                        </div>
                        <div className="text-[0.7rem] text-neutral-500">
                          Approve each item to move the job forward.
                        </div>
                      </div>

                      <div className="overflow-hidden rounded-2xl border border-white/10 bg-black/35">
                        <div className="grid grid-cols-12 gap-2 border-b border-white/10 bg-black/45 px-3 py-2 text-[0.65rem] uppercase tracking-[0.16em] text-neutral-400">
                          <div className="col-span-6">Description</div>
                          <div className="col-span-1 text-right">Qty</div>
                          <div className="col-span-2">Vendor</div>
                          <div className="col-span-2 text-right">Price</div>
                          <div className="col-span-1 text-right"> </div>
                        </div>

                        <div className="divide-y divide-white/5">
                          {items.length === 0 ? (
                            <div className="px-3 py-3 text-xs text-neutral-400">
                              No part items found for this job.
                            </div>
                          ) : (
                            items.map((it) => {
                              const approved = Boolean(it.approved);
                              const isBusy = busyItemId === it.id;

                              return (
                                <div key={it.id} className="grid grid-cols-12 gap-2 px-3 py-3">
                                  <div className="col-span-6 min-w-0">
                                    <div className="truncate text-sm text-neutral-100">
                                      {it.description ?? "‚Äî"}
                                    </div>
                                    <div className="mt-1 flex flex-wrap items-center gap-2 text-[0.7rem] text-neutral-400">
                                      <span className="rounded-full border border-white/10 bg-black/40 px-2 py-0.5">
                                        Markup:{" "}
                                        {typeof it.markup_pct === "number" ? `${it.markup_pct}%` : "‚Äî"}
                                      </span>
                                      <span
                                        className={cx(
                                          "rounded-full border px-2 py-0.5",
                                          approved
                                            ? "border-emerald-400/40 bg-emerald-400/10 text-emerald-100"
                                            : "border-white/10 bg-black/40 text-neutral-300",
                                        )}
                                      >
                                        {approved ? "Approved" : "Not approved"}
                                      </span>
                                    </div>
                                  </div>

                                  <div className="col-span-1 text-right text-sm text-neutral-100">
                                    {it.qty ?? 1}
                                  </div>

                                  <div className="col-span-2 text-sm text-neutral-200">
                                    {it.vendor ?? "‚Äî"}
                                  </div>

                                  <div className="col-span-2 text-right text-sm text-neutral-100">
                                    {fmtMoney(it.quoted_price)}
                                  </div>

                                  <div className="col-span-1 flex items-center justify-end gap-2">
                                    {!approved ? (
                                      <button
                                        type="button"
                                        onClick={() => void approveItem(it.id)}
                                        disabled={isBusy}
                                        className="inline-flex items-center rounded-full border border-white/12 bg-black/45 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.14em] text-neutral-100 transition hover:bg-black/70 active:scale-95 disabled:opacity-60"
                                        title="Approve item"
                                      >
                                        <span style={{ color: COPPER }}>
                                          {isBusy ? "..." : "Approve"}
                                        </span>
                                      </button>
                                    ) : (
                                      <button
                                        type="button"
                                        onClick={() => void declineItem(it.id)}
                                        disabled={isBusy}
                                        className="inline-flex items-center rounded-full border border-red-400/40 bg-red-500/10 px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.14em] text-red-100 transition hover:bg-red-500/20 active:scale-95 disabled:opacity-60"
                                        title="Undo approval"
                                      >
                                        {isBusy ? "..." : "Decline"}
                                      </button>
                                    )}
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </div>

                      <div className="mt-3 text-[0.7rem] text-neutral-500">
                        If every item on this job is approved, the job will automatically move to{" "}
                        <span className="text-neutral-300">Queued</span>.
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : null}

          {!loading && !error ? (
            <div className="mt-4 rounded-2xl border border-white/10 bg-black/25 p-4">
              <div className="text-xs text-neutral-400">
                If approvals never appear, confirm the portal user is linked by{" "}
                <span className="font-mono text-neutral-200">customers.user_id = auth.uid()</span>.
              </div>
            </div>
          ) : null}

          {/* headers currently unused, but kept in state if you want to display request status/notes */}
          {headers.length > 0 ? null : null}
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/auth/confirm/page.tsx
========================================
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const COPPER = "#C57A4A";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      if (cancelled) return;

      // ‚úÖ After confirm, land on the portal entry that matters for this flow
      router.replace(
        session?.user ? "/portal/customer-appointments" : "/portal/auth/sign-in",
      );
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md shadow-card">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Portal
        </div>

        <h1 className="mt-4 text-xl font-blackops uppercase tracking-[0.16em] text-neutral-200">
          Finishing sign in
        </h1>

        <p className="mt-2 text-sm text-neutral-400">
          One moment‚Ä¶ we‚Äôre completing your sign-in.
        </p>

        <div className="mt-5 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
          <div
            className="h-full w-1/2 animate-pulse rounded-full"
            style={{ backgroundColor: COPPER }}
          />
        </div>
      </div>
    </div>
  );
}


========================================
FILE: app/portal/auth/sign-in/page.tsx
========================================
// app/portal/auth/sign-in/page.tsx
"use client";

import { Suspense } from "react";
import PortalSignInForm from "./PortalSignInForm";

const COPPER = "#C57A4A";

function LoadingCard({ label }: { label: string }) {
  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Customer Portal
        </div>
        <div className="mt-4 text-sm text-neutral-300">{label}</div>
        <div className="mt-4 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
          <div
            className="h-full w-1/2 animate-pulse rounded-full"
            style={{ backgroundColor: COPPER }}
          />
        </div>
      </div>
    </div>
  );
}

export default function PortalSignInPage() {
  return (
    <Suspense fallback={<LoadingCard label="Loading sign in‚Ä¶" />}>
      <PortalSignInForm />
    </Suspense>
  );
}

========================================
FILE: app/portal/auth/sign-in/PortalSignInForm.tsx
========================================
// app/portal/auth/sign-in/page.tsx
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const COPPER = "#C57A4A";

export default function PortalSignInPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  const [email, setEmail] = useState<string>("");
  const [password, setPassword] = useState<string>("");
  const [error, setError] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const { data } = await supabase.auth.getUser();
      if (cancelled) return;
      if (data?.user) router.replace("/portal");
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  const goLanding = () => {
    const href = "/";
    router.replace(href);
    setTimeout(() => {
      if (typeof window !== "undefined" && window.location.pathname !== href) {
        window.location.assign(href);
      }
    }, 60);
  };

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    const { error: signInError } = await supabase.auth.signInWithPassword({
      email: email.trim(),
      password,
    });

    if (signInError) {
      setError(signInError.message || "Sign in failed.");
      setLoading(false);
      return;
    }

    router.replace("/portal");
  };

  return (
    <div
      className="
        min-h-screen px-4 text-foreground
        bg-background
        bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]
      "
    >
      <div className="mx-auto flex min-h-screen max-w-md flex-col items-center justify-center py-8">
        <div
          className="
            w-full rounded-3xl border
            border-[color:var(--metal-border-soft,#1f2937)]
            bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_60%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.98),#020617_82%)]
            shadow-[0_32px_80px_rgba(0,0,0,0.95)]
            px-6 py-7 sm:px-8 sm:py-9
          "
        >
          {/* Back to landing */}
          <div className="mb-4 flex items-center justify-between">
            <button
              type="button"
              onClick={goLanding}
              disabled={loading}
              className="
                inline-flex items-center gap-2 rounded-full border
                border-[color:var(--metal-border-soft,#1f2937)]
                bg-black/60 px-3 py-1.5 text-[11px]
                uppercase tracking-[0.2em] text-neutral-200
                hover:bg-black/70 hover:text-white
                disabled:cursor-not-allowed disabled:opacity-60
              "
            >
              <span aria-hidden className="text-base leading-none">
                ‚Üê
              </span>
              Back
            </button>

            <div className="text-[10px] text-neutral-500">Customer portal</div>
          </div>

          {/* Brand / title */}
          <div className="mb-6 space-y-2 text-center">
            <div
              className="
                inline-flex items-center gap-1 rounded-full border
                border-[color:var(--metal-border-soft,#1f2937)]
                bg-black/70
                px-3 py-1 text-[11px]
                uppercase tracking-[0.22em]
                text-neutral-300
              "
              style={{ color: COPPER }}
            >
              Customer Portal
            </div>

            <h1
              className="mt-2 text-3xl sm:text-4xl font-semibold text-white"
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              Sign in
            </h1>

            <p className="text-xs text-muted-foreground sm:text-sm">
              Use the email and password you created when you signed up.
            </p>
          </div>

          {/* Error */}
          {error ? (
            <div className="mb-3 rounded-lg border border-red-500/60 bg-red-950/70 px-3 py-2 text-xs text-red-100 shadow-[0_0_18px_rgba(127,29,29,0.5)]">
              {error}
            </div>
          ) : null}

          {/* Form */}
          <form onSubmit={handleSignIn} className="space-y-4">
            <div className="space-y-1 text-sm">
              <label className="block text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Email
              </label>
              <input
                type="email"
                autoComplete="email"
                placeholder="you@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="
                  w-full rounded-lg border
                  border-[color:var(--metal-border-soft,#1f2937)]
                  bg-black/70 px-3 py-2 text-sm text-white
                  placeholder:text-neutral-500
                  focus:outline-none focus:ring-2
                  focus:ring-[var(--accent-copper-soft)]
                  focus:border-[var(--accent-copper-soft)]
                "
                required
              />
            </div>

            <div className="space-y-1 text-sm">
              <label className="block text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
                Password
              </label>
              <input
                type="password"
                autoComplete="current-password"
                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="
                  w-full rounded-lg border
                  border-[color:var(--metal-border-soft,#1f2937)]
                  bg-black/70 px-3 py-2 text-sm text-white
                  placeholder:text-neutral-500
                  focus:outline-none focus:ring-2
                  focus:ring-[var(--accent-copper-soft)]
                  focus:border-[var(--accent-copper-soft)]
                "
                required
                minLength={6}
              />
            </div>

            <button
              type="submit"
              disabled={loading}
              className="
                mt-3 w-full rounded-full
                bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))]
                py-2.5 text-center text-sm
                font-semibold uppercase tracking-[0.22em] text-black
                shadow-[0_0_26px_rgba(212,118,49,0.9)]
                hover:brightness-110
                disabled:cursor-not-allowed disabled:opacity-60
              "
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              {loading ? "Signing in‚Ä¶" : "Sign in"}
            </button>
          </form>

          <div className="mt-5 flex items-center justify-between text-sm text-neutral-400">
            <span>Need an account?</span>
            <Link
              href="/portal/auth/sign-up"
              className="text-[11px] font-medium text-[var(--accent-copper-light)] hover:text-[var(--accent-copper)] hover:underline underline-offset-2"
            >
              Sign up
            </Link>
          </div>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/auth/sign-up/page.tsx
========================================
// app/portal/auth/sign-up/page.tsx
"use client";

import { Suspense } from "react";
import PortalSignUpForm from "./PortalSignUpForm";

const COPPER = "#C57A4A";

function LoadingCard({ label }: { label: string }) {
  return (
    <div
      className="
        min-h-screen px-4 text-foreground
        bg-background
        bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.14),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]
      "
    >
      <div className="mx-auto flex min-h-screen max-w-md flex-col items-center justify-center py-8">
        <div
          className="
            w-full rounded-3xl border
            border-[color:var(--metal-border-soft,#1f2937)]
            bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_60%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.98),#020617_82%)]
            shadow-[0_32px_80px_rgba(0,0,0,0.95)]
            px-6 py-7 sm:px-8 sm:py-9
          "
        >
          <div className="mb-6 space-y-2 text-center">
            <div
              className="
                inline-flex items-center gap-1 rounded-full border
                border-[color:var(--metal-border-soft,#1f2937)]
                bg-black/70
                px-3 py-1 text-[11px]
                uppercase tracking-[0.22em]
                text-neutral-300
              "
              style={{ color: COPPER }}
            >
              Customer Portal
            </div>

            <div
              className="mt-2 text-2xl sm:text-3xl font-semibold text-white"
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              Sign up
            </div>

            <div className="text-xs text-neutral-400">{label}</div>
          </div>

          <div className="mt-4 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
            <div
              className="h-full w-1/2 animate-pulse rounded-full"
              style={{ backgroundColor: COPPER }}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

export default function PortalSignUpPage() {
  return (
    <Suspense fallback={<LoadingCard label="Loading sign up‚Ä¶" />}>
      <PortalSignUpForm />
    </Suspense>
  );
}

========================================
FILE: app/portal/auth/sign-up/PortalSignUpForm.tsx
========================================
// app/portal/auth/sign-up/page.tsx
"use client";

import React, { useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import { Input } from "@shared/components/ui/input";
import { Button } from "@shared/components/ui/Button";

const COPPER = "#C57A4A";

export default function PortalSignUpForm() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  const [email, setEmail] = useState<string>("");
  const [password, setPassword] = useState<string>("");

  const [error, setError] = useState<string>("");
  const [notice, setNotice] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(false);

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");
    setNotice("");
    setLoading(true);

    try {
      const origin =
        typeof window !== "undefined"
          ? window.location.origin
          : process.env.NEXT_PUBLIC_SITE_URL;

      const safeOrigin = (origin ?? "").replace(/\/$/, "");
      const emailRedirectTo = `${safeOrigin}/portal/auth/confirm`;

      const { data, error: signUpError } = await supabase.auth.signUp({
        email: email.trim().toLowerCase(),
        password,
        options: { emailRedirectTo },
      });

      if (signUpError) {
        setError(signUpError.message);
      } else if (!data.session) {
        setNotice(
          "Check your email to confirm your account. After confirming, you‚Äôll land on your profile.",
        );
      } else {
        router.replace("/portal");
      }
    } catch (err: unknown) {
      const message =
        err instanceof Error
          ? err.message
          : "Unable to create your account right now.";
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <header className="space-y-2">
          <div
            className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
            style={{ color: COPPER }}
          >
            Customer Portal
          </div>

          <h1 className="text-2xl font-blackops" style={{ color: COPPER }}>
            Create account
          </h1>

          <p className="text-sm text-neutral-400">
            Access service history, bookings, and documents.
          </p>
        </header>

        <form onSubmit={handleSignUp} className="mt-5 space-y-4">
          <div>
            <label className="mb-1 block text-xs font-medium text-neutral-300">
              Email
            </label>
            <Input
              type="email"
              autoComplete="email"
              placeholder="you@example.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="border-white/10 bg-white/5 text-white placeholder:text-neutral-500"
              required
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium text-neutral-300">
              Password
            </label>
            <Input
              type="password"
              autoComplete="new-password"
              placeholder="At least 6 characters"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="border-white/10 bg-white/5 text-white placeholder:text-neutral-500"
              required
              minLength={6}
            />
          </div>

          {error ? (
            <p className="rounded-lg border border-red-500/40 bg-red-950/40 px-3 py-2 text-sm text-red-100">
              {error}
            </p>
          ) : null}

          {notice ? (
            <p className="rounded-lg border border-emerald-500/30 bg-emerald-950/25 px-3 py-2 text-sm text-emerald-100">
              {notice}
            </p>
          ) : null}

          <Button type="submit" disabled={loading} className="w-full font-semibold">
            {loading ? "Creating account‚Ä¶" : "Sign up"}
          </Button>
        </form>

        <div className="mt-5 flex items-center justify-between text-sm text-neutral-400">
          <span>Already have an account?</span>
          <Link href="/portal/auth/sign-in" className="font-semibold hover:underline" style={{ color: COPPER }}>
            Sign in
          </Link>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/booking/BookingPageClient.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import Calendar from "@shared/components/ui/Calendar";
import LinkButton from "@shared/components/ui/LinkButton";

type DB = Database;

type Slot = { start: string; end: string };
type AvailabilityResponse = { tz: string; slots: Slot[]; disabled?: boolean };

type ShopOption = Pick<
  DB["public"]["Tables"]["shops"]["Row"],
  "id" | "name" | "slug" | "accepts_online_booking"
>;

type HourRow = { weekday: number; open_time: string; close_time: string };

const WEEKDAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];



const pad = (n: number) => (n < 10 ? `0${n}` : `${n}`);
const toYMD = (d: Date) =>
  `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

const fmtTime = (iso: string, tz: string) =>
  new Intl.DateTimeFormat(undefined, {
    timeZone: tz,
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(iso));

export default function PortalBookingPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const search = useSearchParams();
  const router = useRouter();

  const [month, setMonth] = useState(() => new Date());
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(undefined);

  const [loading, setLoading] = useState(false);
  const [shops, setShops] = useState<ShopOption[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");
  const [tz, setTz] = useState<string>("UTC");
  const [slots, setSlots] = useState<Slot[]>([]);
  const [hours, setHours] = useState<HourRow[]>([]);

  // Keep state in sync if the URL changes
  useEffect(() => {
    const urlShop = search.get("shop") || "";
    setShopSlug((prev) => (prev === urlShop ? prev : urlShop));
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [search]);

  // Load shops that accept online booking
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        toast.error("Failed to load shops.");
        return;
      }

      const list = (data ?? []) as ShopOption[];
      setShops(list);

      const urlShop = search.get("shop") || "";
      if (!urlShop && list.length > 0) {
        const first = list[0].slug as string;
        setShopSlug(first);
        setSelectedDate(undefined);
        router.replace(`/portal/booking?shop=${encodeURIComponent(first)}`);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase]);

  // Visible month range
  const range = useMemo(() => {
    const y = month.getFullYear();
    const m = month.getMonth();
    const first = new Date(y, m, 1);
    const last = new Date(y, m + 1, 0);
    return { start: toYMD(first), end: toYMD(last) };
  }, [month]);

  // Fetch shop hours
  useEffect(() => {
    const shop = shops.find((s) => (s.slug as string) === shopSlug);
    if (!shop) return;

    (async () => {
      try {
        const res = await fetch(`/api/settings/hours?shopId=${shop.id}`, {
          cache: "no-store",
        });
        if (!res.ok) {
          setHours([]);
          return;
        }
        const j = await res.json();
        const raw: HourRow[] = Array.isArray(j?.hours) ? j.hours : [];

        const normalized = Array.from({ length: 7 }, (_, i) => {
          const found = raw.find((h) => h.weekday === i);
          const open = found?.open_time ?? "08:00";
          const close = found?.close_time ?? "17:00";
          return { weekday: i, open_time: open, close_time: close };
        });

        setHours(normalized);
      } catch {
        setHours([]);
      }
    })();
  }, [shops, shopSlug]);

  const closedWeekdays = useMemo(() => {
    const set = new Set<number>();
    hours.forEach((h) => {
      if (h.open_time === h.close_time) set.add(h.weekday);
    });
    return set;
  }, [hours]);

  const closedLabel = useMemo(() => {
    if (closedWeekdays.size === 0) return "";
    return Array.from(closedWeekdays)
      .sort()
      .map((d) => WEEKDAYS[d])
      .join(", ");
  }, [closedWeekdays]);

  // Fetch availability when shop/month changes
  useEffect(() => {
    if (!shopSlug) return;

    (async () => {
      setLoading(true);
      try {
        const res = await fetch(
          `/api/portal/availability?shop=${encodeURIComponent(
            shopSlug,
          )}&start=${range.start}&end=${range.end}&slotMins=30`,
          { cache: "no-store" },
        );

        if (!res.ok) throw new Error("Failed to load availability.");

        const data: AvailabilityResponse = await res.json();

        setTz(data.tz || "UTC");
        if (data.disabled) {
          toast.warning("This shop is not accepting online bookings.");
          setSlots([]);
        } else {
          setSlots(data.slots || []);
        }
      } catch (err) {
        console.error(err);
        toast.error("Failed to load availability.");
        setSlots([]);
      } finally {
        setLoading(false);
      }
    })();
  }, [shopSlug, range.start, range.end]);

  // Group slots by day
  const slotsByDay = useMemo(() => {
    const map = new Map<string, Slot[]>();
    (slots || []).forEach((s) => {
      const k = toYMD(new Date(s.start));
      const arr = map.get(k) ?? [];
      arr.push(s);
      map.set(k, arr);
    });
    map.forEach((arr) =>
      arr.sort((a, b) => +new Date(a.start) - +new Date(b.start)),
    );
    return map;
  }, [slots]);

  const daySlots = useMemo(() => {
    if (!selectedDate) return [];
    return slotsByDay.get(toYMD(selectedDate)) ?? [];
  }, [selectedDate, slotsByDay]);

  async function book(startIso: string, endIso: string) {
    try {
      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: "",
        }),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Booking failed");

      toast.success("Appointment requested! We‚Äôll email you when it‚Äôs confirmed.");
      setSlots((prev) => prev.filter((s) => s.start !== startIso));
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Could not book.";
      toast.error(msg);
    }
  }

  // ‚úÖ IMPORTANT: don‚Äôt disable everything while loading / before slots arrive
  const disabledDate = (d: Date) => {
    if (closedWeekdays.has(d.getDay())) return true;
    if (loading) return false;
    if (slotsByDay.size === 0) return false; // allow picking a day even if none available
    return !slotsByDay.has(toYMD(d));
  };

  const isSelectedClosed =
    selectedDate && closedWeekdays.has(selectedDate.getDay());

  return (
    <div className="mx-auto max-w-5xl px-3 py-6 text-white">
      <Toaster position="top-center" />

      <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Book an appointment
          </h1>
          <p className="mt-1 text-xs text-neutral-400">
            Choose a shop, then pick a date and time.
          </p>
        </div>

        <div className="flex flex-wrap items-center gap-2 rounded-2xl border border-white/10 bg-black/40 px-3 py-2 backdrop-blur-md">
          <label className="text-[0.7rem] uppercase tracking-[0.12em] text-neutral-400">
            Shop
          </label>
          <select
            value={shopSlug}
            onChange={(e) => {
              const slug = e.target.value;
              setShopSlug(slug);
              setSelectedDate(undefined);
              router.replace(`/portal/booking?shop=${encodeURIComponent(slug)}`);
            }}
            className="min-w-[200px] rounded-md border border-white/10 bg-black/60 px-2 py-1 text-sm text-white outline-none focus:border-white/20"
          >
            {shops.map((s) => (
              <option key={s.id} value={s.slug as string}>
                {s.name}
              </option>
            ))}
          </select>

          <LinkButton href="/portal/history" variant="outline" size="sm">
            View history
          </LinkButton>
        </div>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        <div className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card">
          <Calendar
            className="shadow-inner"
            month={month}
            onMonthChange={setMonth}
            /* ‚úÖ FIX: your Calendar wrapper likely wants selected/onSelect */
            value={selectedDate}
            onChange={setSelectedDate}
            disabled={disabledDate}
          />
        </div>

        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card">
          <h2 className="mb-1 font-semibold text-white">Available times</h2>
          <p className="mb-3 text-xs text-neutral-400">
            Times shown in <span className="font-medium">{tz}</span>.
            {closedLabel && (
              <span className="mt-1 block text-[0.7rem] text-neutral-500">
                Closed: {closedLabel}
              </span>
            )}
          </p>

          {!shopSlug ? (
            <p className="text-sm text-neutral-400">
              Select a shop to view availability.
            </p>
          ) : !selectedDate ? (
            <p className="text-sm text-neutral-400">
              Pick a date on the calendar to see times.
            </p>
          ) : loading ? (
            <p className="text-sm text-neutral-400">Loading‚Ä¶</p>
          ) : daySlots.length === 0 ? (
            isSelectedClosed ? (
              <p className="text-sm text-neutral-400">Shop is closed on this day.</p>
            ) : (
              <p className="text-sm text-neutral-400">
                No available slots for this date.
              </p>
            )
          ) : (
            <ul className="grid grid-cols-2 gap-2">
              {daySlots.map((s, i) => (
                <li key={i}>
                  <button
                    onClick={() => book(s.start, s.end)}
                    className="w-full rounded-lg border border-white/15 bg-black/40 px-3 py-2 text-sm text-neutral-100 transition hover:bg-white/5"
                    style={{
                      boxShadow: "inset 0 0 0 1px rgba(197,122,74,0.25)",
                    }}
                  >
                    {fmtTime(s.start, tz)} ‚Äì {fmtTime(s.end, tz)}
                  </button>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      <p className="mt-6 text-xs text-neutral-500">
        * Your request is pending until confirmed by the shop.
      </p>
    </div>
  );
}

========================================
FILE: app/portal/booking/confirmation/BookingConfirmationClient.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export default function BookingConfirmationClient() {
  const params = useSearchParams();
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const id = params.get("wo");
  const [data, setData] = useState<{
    id: string;
    status: string | null;
    scheduled_at: string | null;
  } | null>(null);

  useEffect(() => {
    if (!id) return;

    (async () => {
      const { data, error } = await supabase
        .from("work_orders")
        .select("id, status, scheduled_at")
        .eq("id", id)
        .single();

      if (error) {
        console.error(error);
        setData(null);
        return;
      }
      setData(data);
    })();
  }, [id, supabase]);

  return (
    <div className="mx-auto max-w-xl space-y-4 rounded-2xl border border-white/10 bg-black/30 p-5 text-white backdrop-blur-md shadow-card">
      <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
        Appointment confirmed
      </h1>

      {data ? (
        <div className="space-y-1 text-sm text-neutral-200">
          <div>
            <strong>Work Order:</strong> {data.id}
          </div>
          <div>
            <strong>Status:</strong> {data.status ?? "awaiting"}
          </div>
          <div>
            <strong>When:</strong>{" "}
            {data.scheduled_at
              ? new Date(data.scheduled_at).toLocaleString()
              : "Not set"}
          </div>
        </div>
      ) : (
        <p className="text-sm text-neutral-400">Loading‚Ä¶</p>
      )}

      <div className="flex flex-wrap gap-3 pt-2">
        <button
          className="rounded-lg border border-white/10 bg-black/40 px-4 py-2 text-sm font-semibold text-neutral-200 hover:bg-black/55"
          onClick={() => router.push("/portal")}
        >
          Go to portal
        </button>
        <button
          className="rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black"
          onClick={() => router.push("/portal/booking")}
        >
          Make another booking
        </button>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/booking/confirmation/page.tsx
========================================
// app/portal/booking/confirmation/page.tsx
import BookingConfirmationClient from "./BookingConfirmationClient";

export const dynamic = "force-dynamic";
// DO NOT export `revalidate` here unless it's a number or `false`.

export default function BookingConfirmationPage() {
  return (
    <div className="mx-auto max-w-3xl p-6">
      <BookingConfirmationClient />
    </div>
  );
}

========================================
FILE: app/portal/booking/page.tsx
========================================
import { Suspense } from "react";
import BookingPageClient from "./BookingPageClient";

export const dynamic = "force-dynamic";
export const revalidate = 0;

export default function Page() {
  return (
    <Suspense
      fallback={
        <div className="min-h-[60vh] grid place-items-center text-white">
          <p>Loading booking page‚Ä¶</p>
        </div>
      }
    >
      <BookingPageClient />
    </Suspense>
  );
}

========================================
FILE: app/portal/confirm/page.tsx
========================================
// app/portal/auth/confirm/page.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      if (cancelled) return;

      // ‚úÖ land on portal home
      router.replace(session?.user ? "/portal" : "/portal/auth/sign-in");
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  return (
    <div className="mx-auto flex max-w-md items-center justify-center rounded-2xl border border-white/10 bg-black/30 p-6 text-sm text-neutral-200 backdrop-blur-md shadow-card">
      Completing sign-in‚Ä¶
    </div>
  );
}

========================================
FILE: app/portal/customer-appointments/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import LinkButton from "@shared/components/ui/LinkButton";
import { Button } from "@shared/components/ui/Button";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type ShopRow = Pick<DB["public"]["Tables"]["shops"]["Row"], "id" | "slug">;

type PortalBooking = {
  id: string;
  shop_slug?: string | null;

  starts_at: string; // ISO
  ends_at: string; // ISO

  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;

  notes?: string | null;
  status?: string | null;
};


function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";
}

function pillClass(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed")
    return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled")
    return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-white/12 bg-white/5 text-neutral-200";
}

function fmtRange(startsAtIso: string, endsAtIso: string) {
  const start = new Date(startsAtIso);
  const end = new Date(endsAtIso);

  const date = start.toLocaleDateString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric",
  });

  const startTime = start.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });
  const endTime = end.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });

  return { date, time: `${startTime} ‚Äì ${endTime}` };
}

function isoDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

function addDays(base: Date, days: number) {
  const d = new Date(base);
  d.setDate(d.getDate() + days);
  return d;
}

export default function PortalCustomerAppointmentsPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();

  const [loading, setLoading] = useState(true);
  const [customer, setCustomer] = useState<CustomerRow | null>(null);

  const [shopSlug, setShopSlug] = useState<string>("");
  const [bookings, setBookings] = useState<PortalBooking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr || !user) {
        toast.error("Please sign in to view appointments.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cErr) {
        toast.error(cErr.message);
        setCustomer(null);
        setLoading(false);
        return;
      }

      setCustomer((c ?? null) as CustomerRow | null);
      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase, router]);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!customer?.shop_id) {
        setShopSlug("");
        return;
      }

      const { data, error } = await supabase
        .from("shops")
        .select("id,slug")
        .eq("id", customer.shop_id)
        .maybeSingle<ShopRow>();

      if (cancelled) return;

      if (error) {
        console.error(error);
        toast.error("Unable to load your shop.");
        setShopSlug("");
        return;
      }

      setShopSlug((data?.slug as string) || "");
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase, customer?.shop_id]);

  useEffect(() => {
    if (!customer?.id) return;
    if (!shopSlug) return;

    (async () => {
      setLoadingBookings(true);
      try {
        const now = new Date();
        const start = isoDate(addDays(now, -180));
        const end = isoDate(addDays(now, 365));

        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${encodeURIComponent(
            start,
          )}&end=${encodeURIComponent(end)}`,
          { cache: "no-store" },
        );

        if (!res.ok) throw new Error("Failed to load your appointments.");

        const j = (await res.json().catch(() => [])) as PortalBooking[];
        const all = Array.isArray(j) ? j : [];
        const mine = all.filter((b) => (b.customer_id ?? null) === customer.id);

        setBookings(mine);
      } catch (e) {
        console.error(e);
        toast.error("Failed to load appointments.");
        setBookings([]);
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [customer?.id, shopSlug]);

  const upcoming = useMemo(() => {
    const now = Date.now();
    return bookings
      .filter(
        (b) =>
          +new Date(b.ends_at) >= now &&
          (b.status || "pending").toLowerCase() !== "cancelled",
      )
      .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at));
  }, [bookings]);

  const past = useMemo(() => {
    const now = Date.now();
    return bookings
      .filter(
        (b) =>
          +new Date(b.ends_at) < now ||
          (b.status || "").toLowerCase() === "cancelled",
      )
      .sort((a, b) => +new Date(b.starts_at) - +new Date(a.starts_at));
  }, [bookings]);

  async function cancelBooking(id: string) {
    if (!confirm("Cancel this appointment?")) return;

    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "cancelled" }),
      });

      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Cancel failed");

      toast.success("Appointment cancelled.");
      setBookings((prev) =>
        prev.map((b) => (b.id === id ? { ...b, status: "cancelled" } : b)),
      );
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Cancel failed.";
      toast.error(msg);
    }
  }

  if (loading) {
    return (
      <div className="mx-auto max-w-xl">
        <div className={cardClass() + " text-sm text-neutral-200"}>
          Loading your portal‚Ä¶
        </div>
      </div>
    );
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3">
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            My appointments
          </h1>
          <p className="mt-2 text-sm text-neutral-400">
            We couldn‚Äôt find your customer profile yet.
          </p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">
              Go to profile
            </LinkButton>
            <LinkButton href="/portal/request/when" size="sm">
              Request service
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  if (!shopSlug) {
    return (
      <div className="mx-auto max-w-xl space-y-3">
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            My appointments
          </h1>
          <p className="mt-2 text-sm text-neutral-400">
            Your portal account isn‚Äôt linked to a shop yet.
          </p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">
              Go to profile
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto w-full max-w-xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
          My appointments
        </h1>
        <p className="text-xs text-neutral-400">
          Request service, then track your upcoming visits here.
        </p>
      </header>

      <div className="flex flex-wrap gap-2">
        <LinkButton href="/portal/request/when" size="sm">
          Request service
        </LinkButton>
        <LinkButton href="/portal/history" variant="outline" size="sm">
          View service history
        </LinkButton>
      </div>

      <section className={cardClass()}>
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-100">
            Upcoming ({upcoming.length})
          </h2>
          {loadingBookings ? (
            <span className="text-[0.75rem] text-neutral-400">Loading‚Ä¶</span>
          ) : null}
        </div>

        {loadingBookings ? (
          <p className="mt-3 text-sm text-neutral-400">Fetching your bookings‚Ä¶</p>
        ) : upcoming.length === 0 ? (
          <p className="mt-3 text-sm text-neutral-400">No upcoming appointments.</p>
        ) : (
          <ul className="mt-3 space-y-2">
            {upcoming.map((b) => {
              const { date, time } = fmtRange(b.starts_at, b.ends_at);
              return (
                <li
                  key={b.id}
                  className="rounded-xl border border-white/10 bg-black/35 p-3"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">
                        {date}
                      </div>
                      <div className="mt-0.5 text-xs text-neutral-300">{time}</div>

                      {b.notes ? (
                        <div className="mt-2 text-xs text-neutral-400">
                          {b.notes}
                        </div>
                      ) : null}
                    </div>

                    <div className="flex flex-col items-end gap-2">
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-1 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>

                      <Button
                        type="button"
                        size="xs"
                        variant="outline"
                        onClick={() => void cancelBooking(b.id)}
                        className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                      >
                        Cancel
                      </Button>
                    </div>
                  </div>
                </li>
              );
            })}
          </ul>
        )}
      </section>

      <section className={cardClass()}>
        <h2 className="text-sm font-semibold text-neutral-100">
          Past ({past.length})
        </h2>

        {loadingBookings ? (
          <p className="mt-3 text-sm text-neutral-400">Loading‚Ä¶</p>
        ) : past.length === 0 ? (
          <p className="mt-3 text-sm text-neutral-400">No past appointments.</p>
        ) : (
          <ul className="mt-3 space-y-2">
            {past.slice(0, 25).map((b) => {
              const { date, time } = fmtRange(b.starts_at, b.ends_at);
              return (
                <li
                  key={b.id}
                  className="rounded-xl border border-white/10 bg-black/25 p-3"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">
                        {date}
                      </div>
                      <div className="mt-0.5 text-xs text-neutral-400">{time}</div>
                    </div>

                    <span
                      className={
                        "inline-flex items-center rounded-full border px-2 py-1 text-[0.7rem] uppercase tracking-[0.14em] " +
                        pillClass(b.status)
                      }
                    >
                      {b.status || "pending"}
                    </span>
                  </div>

                  {b.notes ? (
                    <div className="mt-2 text-xs text-neutral-500">{b.notes}</div>
                  ) : null}
                </li>
              );
            })}
          </ul>
        )}
      </section>

      <p className="text-[0.75rem] text-neutral-500">
        Need to change a time? Cancel and submit a new request.
      </p>
    </div>
  );
}


========================================
FILE: app/portal/history/components/HistoryList.tsx
========================================
"use client";

import { useMemo, useState } from "react";
import type { HistoryItem } from "../types";

type Props = { items: HistoryItem[] };

const STATUS_LABELS: Record<string, string> = {
  awaiting: "Awaiting",
  scheduled: "Scheduled",
  in_progress: "In progress",
  completed: "Completed",
  on_hold: "On hold",
  cancelled: "Cancelled",
};

// Keep semantic colors, but align to glass + lighter borders.
const STATUS_CLASSES: Record<string, string> = {
  awaiting: "border border-amber-500/35 bg-amber-500/10 text-amber-200",
  scheduled: "border border-sky-500/35 bg-sky-500/10 text-sky-200",
  in_progress: "border border-orange-500/40 bg-orange-500/10 text-orange-200",
  completed: "border border-emerald-500/35 bg-emerald-500/10 text-emerald-200",
  on_hold: "border border-purple-500/35 bg-purple-500/10 text-purple-200",
  cancelled: "border border-red-500/35 bg-red-500/10 text-red-200",
};

export default function HistoryList({ items }: Props) {
  const [q, setQ] = useState("");
  const [status, setStatus] = useState("");

  const filtered = useMemo(() => {
    const needle = q.trim().toLowerCase();

    // newest ‚Üí oldest by service_date
    const sorted = [...items].sort((a, b) => {
      const ta = a.service_date ? Date.parse(a.service_date) : 0;
      const tb = b.service_date ? Date.parse(b.service_date) : 0;
      return tb - ta;
    });

    return sorted.filter((h) => {
      const statusOk = !status || h.work_order?.status === status;

      const hay = [
        h.description ?? "",
        h.notes ?? "",
        h.vehicle
          ? `${h.vehicle.year ?? ""} ${h.vehicle.make ?? ""} ${
              h.vehicle.model ?? ""
            } ${h.vehicle.vin ?? ""} ${h.vehicle.license_plate ?? ""}`
          : "",
        h.work_order
          ? `${h.work_order.id ?? ""} ${h.work_order.type ?? ""} ${
              h.work_order.status ?? ""
            }`
          : "",
      ]
        .join(" ")
        .toLowerCase();

      const qOk = !needle || hay.includes(needle);
      return statusOk && qOk;
    });
  }, [items, q, status]);

  if (!items.length) {
    return (
      <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-300 backdrop-blur-md shadow-card">
        No service history yet. Once this vehicle has been in for service,
        you‚Äôll see it here.
      </div>
    );
  }

  const hasFilters = Boolean(q || status);

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card">
        <div className="flex flex-wrap items-center gap-3">
          <div className="min-w-[200px] flex-1">
            <label className="mb-1 block text-[11px] uppercase tracking-[0.12em] text-neutral-400">
              Search
            </label>
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              placeholder="Search vehicle, work order, notes‚Ä¶"
            />
          </div>

          <div>
            <label className="mb-1 block text-[11px] uppercase tracking-[0.12em] text-neutral-400">
              Status
            </label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className="min-w-[170px] rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            >
              <option value="">All statuses</option>
              <option value="awaiting">Awaiting</option>
              <option value="scheduled">Scheduled</option>
              <option value="in_progress">In progress</option>
              <option value="completed">Completed</option>
              <option value="on_hold">On hold</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          {hasFilters && (
            <button
              className="ml-auto rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-200 hover:bg-black/55"
              onClick={() => {
                setQ("");
                setStatus("");
              }}
            >
              Clear filters
            </button>
          )}
        </div>

        <div className="mt-2 text-xs text-neutral-400">
          Showing{" "}
          <span className="font-semibold text-orange-300">
            {filtered.length}
          </span>{" "}
          of {items.length} visits
        </div>
      </div>

      {/* Empty-after-filter */}
      {filtered.length === 0 ? (
        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-300 backdrop-blur-md shadow-card">
          No service visits match your filters. Try clearing the search or
          choosing a different status.
        </div>
      ) : (
        <ul className="space-y-3">
          {filtered.map((h) => {
            const statusKey = h.work_order?.status ?? "";
            const statusLabel =
              STATUS_LABELS[statusKey] ?? (statusKey || "Unknown");
            const statusClass =
              STATUS_CLASSES[statusKey] ??
              "border border-white/10 bg-black/40 text-neutral-200";

            const title = h.vehicle
              ? `${h.vehicle.year ?? ""} ${h.vehicle.make ?? ""} ${
                  h.vehicle.model ?? ""
                }`.trim() || "Vehicle"
              : "Vehicle";

            return (
              <li
                key={h.id}
                className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card"
              >
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div className="text-xs text-neutral-400">
                    {formatDate(h.service_date)}
                  </div>

                  {h.work_order && (
                    <span
                      className={`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium ${statusClass}`}
                    >
                      {statusLabel}
                    </span>
                  )}
                </div>

                <div className="mt-1 text-sm font-semibold text-neutral-50">
                  {title}
                  {h.work_order && (
                    <span className="ml-1 text-xs font-normal text-neutral-400">
                      ¬∑ WO #{h.work_order.id}
                    </span>
                  )}
                </div>

                {h.vehicle && (
                  <div className="mt-0.5 text-xs text-neutral-400">
                    {h.vehicle.vin && (
                      <span className="mr-3">
                        VIN:{" "}
                        <span className="font-mono text-neutral-200">
                          {h.vehicle.vin}
                        </span>
                      </span>
                    )}
                    {h.vehicle.license_plate && (
                      <span>
                        Plate:{" "}
                        <span className="font-mono text-neutral-200">
                          {h.vehicle.license_plate}
                        </span>
                      </span>
                    )}
                  </div>
                )}

                {h.description && (
                  <div className="mt-2 text-sm text-neutral-200">
                    {h.description}
                  </div>
                )}

                {h.notes && (
                  <div className="mt-1 text-xs text-neutral-400">
                    {h.notes}
                  </div>
                )}
              </li>
            );
          })}
        </ul>
      )}
    </div>
  );
}

function formatDate(iso: string | null): string {
  if (!iso) return "‚Äî";
  try {
    return new Date(iso).toLocaleString(undefined, {
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    });
  } catch {
    return iso;
  }
}

========================================
FILE: app/portal/history/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

// app/portal/history/page.tsx
import { cookies } from "next/headers";
import Link from "next/link";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import HistoryList from "./components/HistoryList";


function cardClass() {
  return "rounded-3xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function copperButtonClass() {
  return "inline-flex items-center justify-center rounded-xl border px-3 py-2 text-xs font-semibold transition active:scale-[0.99]";
}

function errorCardClass() {
  return "rounded-3xl border border-red-500/35 bg-red-900/20 p-4 text-sm text-red-100 backdrop-blur-md shadow-card";
}

export default async function HistoryPage() {
  const supabase = createServerComponentClient<Database>({ cookies });

  const {
    data: { user },
    error: userErr,
  } = await supabase.auth.getUser();

  if (userErr) console.error("Error getting user:", userErr);

  if (!user) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Service history
          </h1>
          <p className="text-xs text-neutral-400">
            Sign in to view your previous visits.
          </p>
        </header>

        <div className={cardClass()}>
          <p className="text-sm text-neutral-200">
            You need to be signed in to view your service history.
          </p>

          <Link
            href="/portal/auth/sign-in"
            className={copperButtonClass() + " mt-3"}
            style={{
              borderColor: "rgba(197,122,74,0.55)",
              color: "rgba(245,225,205,0.95)",
              background: "rgba(197,122,74,0.10)",
            }}
          >
            Go to sign in
          </Link>
        </div>
      </div>
    );
  }

  // Find the customer row linked to this auth user
  const { data: customer, error: custErr } = await supabase
    .from("customers")
    .select("id")
    .eq("user_id", user.id)
    .maybeSingle();

  if (custErr) {
    console.error("Error loading customer:", custErr);
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Service history
          </h1>
        </header>

        <div className={errorCardClass()}>
          Failed to load your customer profile. Please try again later.
        </div>
      </div>
    );
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Service history
          </h1>
          <p className="text-xs text-neutral-400">
            Complete your profile so we can connect your visits.
          </p>
        </header>

        <div className={cardClass()}>
          <p className="text-sm text-neutral-200">
            We couldn‚Äôt find a customer profile linked to your account yet.
            Complete your profile so we can connect your visits.
          </p>

          <Link
            href="/portal/profile"
            className={copperButtonClass() + " mt-3"}
            style={{
              borderColor: "rgba(197,122,74,0.55)",
              color: "rgba(245,225,205,0.95)",
              background: "rgba(197,122,74,0.10)",
            }}
          >
            Go to profile
          </Link>
        </div>
      </div>
    );
  }

  // Fetch history records joined with vehicle + work order
  const { data: history, error } = await supabase
    .from("history")
    .select(
      `
      *,
      vehicle:vehicles(id, year, make, model, vin, license_plate),
      work_order:work_orders(id, status, type)
    `,
    )
    .eq("customer_id", customer.id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading history:", error);
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Service history
          </h1>
        </header>

        <div className={errorCardClass()}>Failed to load history.</div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-3xl space-y-4 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
          Service history
        </h1>
        <p className="text-xs text-neutral-400">
          Past visits, notes, and work orders linked to your vehicles.
        </p>

        <div
          className="mt-3 h-px w-full"
          style={{
            background:
              "linear-gradient(90deg, rgba(197,122,74,0.0), rgba(197,122,74,0.35), rgba(197,122,74,0.0))",
          }}
        />
      </header>

      <div className={cardClass()}>
        <HistoryList items={history || []} />
      </div>
    </div>
  );
}

========================================
FILE: app/portal/layout.tsx
========================================
// app/portal/layout.tsx
import type { ReactNode } from "react";
import PortalShell from "@/features/portal/components/PortalShell";

export default function PortalLayout({ children }: { children: ReactNode }) {
  return <PortalShell>{children}</PortalShell>;
}

========================================
FILE: app/portal/page.tsx
========================================
// app/portal/page.tsx
"use client";

import Link from "next/link";
import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const COPPER = "#C57A4A";

type Customer = Database["public"]["Tables"]["customers"]["Row"];
type BookingRow = Database["public"]["Tables"]["bookings"]["Row"];
type WorkOrderRow = Database["public"]["Tables"]["work_orders"]["Row"];

function StatCard({
  title,
  value,
  sub,
}: {
  title: string;
  value: string;
  sub?: string;
}) {
  return (
    <div className="rounded-2xl border border-white/12 bg-black/25 p-4 backdrop-blur-md shadow-card shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)]">
      <div className="text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
        {title}
      </div>
      <div className="mt-2 text-2xl font-blackops" style={{ color: COPPER }}>
        {value}
      </div>
      {sub ? <div className="mt-1 text-xs text-neutral-500">{sub}</div> : null}
    </div>
  );
}

function formatWhen(iso: string) {
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "‚Äî";
  return d.toLocaleString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
  });
}

function formatWoRef(wo: Pick<WorkOrderRow, "id" | "status"> | null) {
  if (!wo) return "‚Äî";
  const short = wo.id?.slice(0, 8) ?? "‚Äî";
  return `#${short}`;
}

export default function PortalHomePage() {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);

  const [loading, setLoading] = useState(true);
  const [, setCustomer] = useState<Customer | null>(null);

  const [vehiclesCount, setVehiclesCount] = useState<number | null>(null);
  const [nextBookingAt, setNextBookingAt] = useState<string | null>(null);
  const [activeWo, setActiveWo] = useState<Pick<
    WorkOrderRow,
    "id" | "status" | "created_at"
  > | null>(null);

  useEffect(() => {
    let mounted = true;

    (async () => {
      setLoading(true);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (!mounted) return;

      if (userErr || !user) {
        setCustomer(null);
        setVehiclesCount(null);
        setNextBookingAt(null);
        setActiveWo(null);
        setLoading(false);
        return;
      }

      const { data: cust, error: custErr } = await supabase
        .from("customers")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();

      if (!mounted) return;

      if (custErr || !cust) {
        setCustomer(null);
        setVehiclesCount(null);
        setNextBookingAt(null);
        setActiveWo(null);
        setLoading(false);
        return;
      }

      setCustomer(cust as Customer);

      // Vehicles count
      const { count: vCount } = await supabase
        .from("vehicles")
        .select("id", { count: "exact", head: true })
        .eq("customer_id", cust.id);

      // Upcoming booking (next)
      const nowIso = new Date().toISOString();
      const { data: booking } = await supabase
        .from("bookings")
        .select("starts_at")
        .eq("customer_id", cust.id)
        .gte("starts_at", nowIso)
        .order("starts_at", { ascending: true })
        .limit(1)
        .maybeSingle();

      const b = booking as Pick<BookingRow, "starts_at"> | null;

      // Active request (work order)
      const ACTIVE_STATUSES: WorkOrderRow["status"][] = [
        "awaiting_approval",
        "queued",
        "planned",
        "in_progress",
      ];

      const { data: wo } = await supabase
        .from("work_orders")
        .select("id, status, created_at")
        .eq("customer_id", cust.id)
        .in("status", ACTIVE_STATUSES as string[])
        .order("created_at", { ascending: false })
        .limit(1)
        .maybeSingle();

      const w = wo as Pick<WorkOrderRow, "id" | "status" | "created_at"> | null;

      if (!mounted) return;
      setVehiclesCount(typeof vCount === "number" ? vCount : null);
      setNextBookingAt(b?.starts_at ?? null);
      setActiveWo(w ?? null);
      setLoading(false);
    })();

    return () => {
      mounted = false;
    };
  }, [supabase]);

  const upcomingValue = loading
    ? "‚Ä¶"
    : nextBookingAt
      ? formatWhen(nextBookingAt)
      : "‚Äî";

  const vehiclesValue = loading
    ? "‚Ä¶"
    : vehiclesCount == null
      ? "‚Äî"
      : String(vehiclesCount);

  const activeReqValue = loading ? "‚Ä¶" : formatWoRef(activeWo);

  return (
    <div className="space-y-6 text-white">
      <div>
        <h1 className="text-2xl font-blackops" style={{ color: COPPER }}>
          Home
        </h1>
        <p className="mt-1 text-sm text-neutral-400">
          Quick overview ‚Äî request service, track appointments, and manage vehicles.
        </p>
      </div>

      {/* ‚úÖ removed Last visit, added Active request */}
      <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
        <StatCard title="Upcoming" value={upcomingValue} sub="Next appointment" />
        <StatCard title="Vehicles" value={vehiclesValue} sub="Saved to your account" />
        <StatCard
          title="Active request"
          value={activeReqValue}
          sub={activeWo?.status ? `Status: ${activeWo.status}` : "No open requests"}
        />
      </div>

      <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <Link
          href="/portal/request/when"
          className="rounded-2xl border border-white/12 bg-black/25 p-4 text-sm font-semibold text-neutral-100 backdrop-blur-md shadow-card shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] transition hover:bg-black/35"
        >
          <div className="flex items-center justify-between">
            <span>Request service</span>
            <span className="h-2 w-2 rounded-full" style={{ backgroundColor: COPPER }} />
          </div>
          <div className="mt-1 text-xs font-normal text-neutral-400">
            Pick a time, add lines, submit for approval.
          </div>
        </Link>

        <Link
          href="/portal/vehicles"
          className="rounded-2xl border border-white/12 bg-black/25 p-4 text-sm font-semibold text-neutral-100 backdrop-blur-md shadow-card shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)] transition hover:bg-black/35"
        >
          <div className="flex items-center justify-between">
            <span>Manage vehicles</span>
            <span className="h-2 w-2 rounded-full" style={{ backgroundColor: COPPER }} />
          </div>
          <div className="mt-1 text-xs font-normal text-neutral-400">
            Add VIN, plate, mileage, and details.
          </div>
        </Link>
      </div>

      <div className="rounded-2xl border border-white/12 bg-black/25 p-4 backdrop-blur-md shadow-card shadow-[inset_0_0_0_1px_rgba(255,255,255,0.04)]">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">Recent activity</h2>
          <Link
            href="/portal/customer-appointments"
            className="text-xs text-neutral-300 underline underline-offset-2 hover:text-neutral-100"
            style={{ textDecorationColor: "rgba(197,122,74,0.65)" }}
          >
            View appointments
          </Link>
        </div>

        <div className="mt-3 rounded-xl border border-dashed border-white/10 bg-black/20 p-3 text-sm text-neutral-400">
          No activity yet. After you submit a request, updates will appear here.
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/parts/page.tsx
========================================
import PortalShell from "@/features/portal/components/PortalShell";
import Link from "next/link";

const muted = "text-neutral-400";
const glass =
  "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";

export default function PortalPartsPage() {
  return (
    <PortalShell
      title="Customer Portal"
      subtitle="Parts approvals, requested parts, and statuses"
    >
      <div className="space-y-4">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">
            Parts
          </div>
          <h1 className="font-header text-3xl text-orange-400">Parts & Approvals</h1>
          <p className={`mt-1 text-sm ${muted}`}>
            If your shop requests parts approval, you‚Äôll see them here.
          </p>
        </div>

        <div className={glass}>
          <div className="text-sm font-semibold text-neutral-100">What you can do here</div>
          <ul className={`mt-2 list-disc pl-5 text-sm ${muted} space-y-1`}>
            <li>Review requested parts from the shop</li>
            <li>Approve or decline before ordering</li>
            <li>Track status (requested ‚Üí approved ‚Üí ordered ‚Üí installed)</li>
          </ul>

          <div className="mt-4 flex flex-wrap gap-2">
            <Link
              href="/portal/request/when"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              Start a new request
            </Link>
            <Link
              href="/portal/history"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              View history
            </Link>
          </div>
        </div>

        <div className={`${glass} ${muted} text-sm`}>
          Next step: wire this page to your parts-request table/view once we confirm the exact
          schema you‚Äôre using for portal approvals.
        </div>
      </div>
    </PortalShell>
  );
}


========================================
FILE: app/portal/profile/page.tsx
========================================
// app/portal/profile/page.tsx (or wherever your PortalProfilePage lives)
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];

type CustomerForm = {
  first_name: string;
  last_name: string;
  phone: string;
  email: string; // auth-owned (read-only)
  street: string;
  city: string;
  province: string;
  postal_code: string;
};

const emptyForm: CustomerForm = {
  first_name: "",
  last_name: "",
  phone: "",
  email: "",
  street: "",
  city: "",
  province: "",
  postal_code: "",
};

function cardClass() {
  return "rounded-3xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-xl border border-white/10 bg-black/35 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-white/20 focus:ring-1 focus:ring-white/10";
}

function readOnlyClass() {
  return "w-full rounded-xl border border-white/10 bg-black/20 px-3 py-2 text-sm text-neutral-300 outline-none placeholder:text-neutral-600";
}

function subtleButtonClass() {
  return "inline-flex items-center justify-center rounded-xl border px-4 py-2 text-sm font-semibold transition disabled:opacity-60 active:scale-[0.99]";
}

export default function PortalProfilePage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [form, setForm] = useState<CustomerForm>(emptyForm);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);
      setError(null);
      setSaved(false);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr) {
        setError(userErr.message);
        setLoading(false);
        return;
      }
      if (!user) {
        setError("You must be signed in.");
        setLoading(false);
        return;
      }

      const authEmail = user.email ?? "";

      const { data: customer, error: fetchErr } = await supabase
        .from("customers")
        .select("first_name,last_name,phone,street,city,province,postal_code")
        .eq("user_id", user.id)
        .maybeSingle<CustomerRow>();

      if (cancelled) return;

      if (fetchErr) {
        setError(fetchErr.message);
        setLoading(false);
        return;
      }

      setForm({
        first_name: (customer?.first_name as string | null) ?? "",
        last_name: (customer?.last_name as string | null) ?? "",
        phone: (customer?.phone as string | null) ?? "",
        email: authEmail,
        street: (customer?.street as string | null) ?? "",
        city: (customer?.city as string | null) ?? "",
        province: (customer?.province as string | null) ?? "",
        postal_code: (customer?.postal_code as string | null) ?? "",
      });

      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase]);

  const onSave = async () => {
    if (saving) return;

    setSaving(true);
    setError(null);
    setSaved(false);

    const {
      data: { user },
      error: userErr,
    } = await supabase.auth.getUser();

    if (userErr || !user) {
      setError(userErr?.message || "You must be signed in.");
      setSaving(false);
      return;
    }

    const toNull = (s: string) => (s.trim() === "" ? null : s.trim());

    const { error: upsertErr } = await supabase
      .from("customers")
      .upsert(
        {
          user_id: user.id,
          first_name: toNull(form.first_name),
          last_name: toNull(form.last_name),
          phone: toNull(form.phone),
          street: toNull(form.street),
          city: toNull(form.city),
          province: toNull(form.province),
          postal_code: toNull(form.postal_code),
        },
        { onConflict: "user_id" },
      );

    if (upsertErr) setError(upsertErr.message);
    else setSaved(true);

    setSaving(false);
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-xl">
        <div className={cardClass() + " text-sm text-neutral-200"}>
          Loading your profile‚Ä¶
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-xl space-y-5 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
          My profile
        </h1>
        <p className="text-xs text-neutral-400">
          Keep your contact details up to date so your shop can reach you easily.
        </p>

        <div
          className="mt-3 h-px w-full"
          style={{
            background:
              "linear-gradient(90deg, rgba(197,122,74,0.0), rgba(197,122,74,0.35), rgba(197,122,74,0.0))",
          }}
        />
      </header>

      <div className={cardClass() + " space-y-4 sm:p-6"}>
        {error ? (
          <div className="rounded-2xl border border-red-500/35 bg-red-900/20 px-3 py-2 text-sm text-red-100">
            {error}
          </div>
        ) : null}

        {saved ? (
          <div className="rounded-2xl border border-emerald-500/35 bg-emerald-900/15 px-3 py-2 text-sm text-emerald-100">
            Saved!
          </div>
        ) : null}

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <input
            className={inputClass()}
            placeholder="First name"
            value={form.first_name}
            onChange={(e) => setForm((p) => ({ ...p, first_name: e.target.value }))}
          />
          <input
            className={inputClass()}
            placeholder="Last name"
            value={form.last_name}
            onChange={(e) => setForm((p) => ({ ...p, last_name: e.target.value }))}
          />
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <input
            className={inputClass()}
            placeholder="Phone"
            value={form.phone}
            onChange={(e) => setForm((p) => ({ ...p, phone: e.target.value }))}
          />

          <div className="space-y-1">
            <input readOnly className={readOnlyClass()} placeholder="Email" value={form.email} />
            <p className="text-[11px] text-neutral-500">Email is tied to your sign-in.</p>
          </div>
        </div>

        <div className="space-y-3">
          <input
            className={inputClass()}
            placeholder="Street address"
            value={form.street}
            onChange={(e) => setForm((p) => ({ ...p, street: e.target.value }))}
          />

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
            <input
              className={inputClass()}
              placeholder="City"
              value={form.city}
              onChange={(e) => setForm((p) => ({ ...p, city: e.target.value }))}
            />
            <input
              className={inputClass()}
              placeholder="Province/State"
              value={form.province}
              onChange={(e) => setForm((p) => ({ ...p, province: e.target.value }))}
            />
            <input
              className={inputClass()}
              placeholder="Postal/ZIP code"
              value={form.postal_code}
              onChange={(e) => setForm((p) => ({ ...p, postal_code: e.target.value }))}
            />
          </div>
        </div>

        <button
          className={subtleButtonClass() + " mt-1"}
          style={{
            borderColor: "rgba(197,122,74,0.55)",
            color: "rgba(245,225,205,0.95)",
            background: "rgba(197,122,74,0.10)",
          }}
          onClick={onSave}
          disabled={saving}
        >
          {saving ? "Saving‚Ä¶" : "Save"}
        </button>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/request/build/page.tsx
========================================
// app/portal/request/build/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";
import LinkButton from "@shared/components/ui/LinkButton";

import SignaturePad, { openSignaturePad } from "@/features/shared/signaturePad/controller";
import LegalTerms from "@/features/shared/components/LegalTerms";
import { uploadSignatureImage } from "@/features/shared/lib/utils/uploadSignature";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type QuoteLineRow = DB["public"]["Tables"]["work_order_quote_lines"]["Row"];
type MenuItemRow = DB["public"]["Tables"]["menu_items"]["Row"];

const COPPER = "#C57A4A";

function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none focus:border-white/20";
}

function sectionTitle(s: string) {
  return (
    <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">
      {s}
    </div>
  );
}

async function postJson<TResp>(
  url: string,
  body: unknown,
): Promise<{ ok: true; data: TResp } | { ok: false; error: string; status: number }> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const j = (await res.json().catch(() => ({}))) as { error?: string } & Record<string, unknown>;

  if (!res.ok)
    return {
      ok: false,
      error: (typeof j?.error === "string" && j.error) || "Request failed",
      status: res.status,
    };

  return { ok: true, data: j as unknown as TResp };
}

function fmtMoney(n: number | null | undefined) {
  if (typeof n !== "number" || !Number.isFinite(n)) return "‚Äî";
  return n.toLocaleString(undefined, { style: "currency", currency: "CAD" });
}

function ymm(v: VehicleRow | null) {
  if (!v) return "";
  return [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim();
}

function safeTrim(s: unknown) {
  return typeof s === "string" ? s.trim() : "";
}

function rec(row: unknown): Record<string, unknown> {
  return (row && typeof row === "object" ? (row as Record<string, unknown>) : {}) as Record<
    string,
    unknown
  >;
}

function getOptString(row: unknown, key: string): string | null {
  const v = rec(row)[key];
  return typeof v === "string" ? v : null;
}

function getOptNumber(row: unknown, key: string): number | null {
  const v = rec(row)[key];
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

function menuTitle(m: MenuItemRow): string {
  const name = getOptString(m, "name");
  const title = getOptString(m, "title");
  return (name || title || m.description || "Menu item").toString();
}

function lineTitle(l: WorkOrderLineRow): string {
  const desc = getOptString(l, "description");
  return (desc || l.complaint || "Line").toString();
}

function cx(...parts: Array<string | false | null | undefined>) {
  return parts.filter(Boolean).join(" ");
}

function modalShell(open: boolean) {
  return cx(
    "fixed inset-0 z-[80] flex items-end justify-center p-3 sm:items-center",
    open ? "" : "pointer-events-none opacity-0",
  );
}

function modalBackdrop(open: boolean) {
  return cx(
    "absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity",
    open ? "opacity-100" : "opacity-0",
  );
}

function modalCard(open: boolean) {
  return cx(
    "relative w-full max-w-2xl rounded-3xl border border-white/10 bg-black/70 p-4 shadow-[0_0_40px_rgba(0,0,0,0.85)] backdrop-blur-md transition-transform",
    open ? "translate-y-0" : "translate-y-6",
  );
}

export default function PortalRequestBuildPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();
  const sp = useSearchParams();

  const workOrderId = sp.get("wo") ?? "";

  // ‚úÖ Option B: carry bookingId from when page (NOT startsAt)
  const bookingId = sp.get("booking") ?? sp.get("bookingId") ?? "";

  const [loading, setLoading] = useState(true);
  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [wo, setWo] = useState<WorkOrderRow | null>(null);
  const [vehicle, setVehicle] = useState<VehicleRow | null>(null);

  const [menuItems, setMenuItems] = useState<MenuItemRow[]>([]);
  const [menuSearch, setMenuSearch] = useState("");

  const [lines, setLines] = useState<WorkOrderLineRow[]>([]);
  const [quoteLines, setQuoteLines] = useState<QuoteLineRow[]>([]);
  const [refreshing, setRefreshing] = useState(false);

  const [customDesc, setCustomDesc] = useState("");
  const [customNotes, setCustomNotes] = useState("");

  const [qoDesc, setQoDesc] = useState("");
  const [qoNotes, setQoNotes] = useState("");
  const [qoQty, setQoQty] = useState("1");

  const [submitting, setSubmitting] = useState(false);

  // NEW: Review & Sign
  const [reviewOpen, setReviewOpen] = useState(false);
  const [agreed, setAgreed] = useState(false);
  const [sigUrl, setSigUrl] = useState<string | null>(null);
  const [reviewBusy, setReviewBusy] = useState(false);

  const filteredMenu = useMemo(() => {
    const q = menuSearch.trim().toLowerCase();
    if (!q) return menuItems.slice(0, 40);

    return menuItems
      .filter((m) => {
        const hay = [menuTitle(m), m.description ?? "", m.category ?? "", m.service_key ?? ""]
          .join(" ")
          .toLowerCase();

        return hay.includes(q);
      })
      .slice(0, 40);
  }, [menuItems, menuSearch]);

  async function loadAll() {
    if (!workOrderId) {
      toast.error("Missing work order id.");
      router.replace("/portal/request/when");
      return;
    }

    setRefreshing(true);

    try {
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr || !user) {
        toast.error("Please sign in.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cErr) throw new Error(cErr.message);

      const cust = (c ?? null) as CustomerRow | null;
      if (!cust?.id) {
        toast.error("Customer profile not found.");
        router.replace("/portal/profile");
        return;
      }
      setCustomer(cust);

      const { data: w, error: wErr } = await supabase
        .from("work_orders")
        .select("*")
        .eq("id", workOrderId)
        .eq("customer_id", cust.id)
        .maybeSingle();

      if (wErr) throw new Error(wErr.message);
      if (!w) {
        toast.error("Work order not found.");
        router.replace("/portal/request/when");
        return;
      }
      setWo(w as WorkOrderRow);

      if (w.vehicle_id) {
        const { data: v, error: vErr } = await supabase
          .from("vehicles")
          .select("id,customer_id,shop_id,year,make,model,vin,license_plate,mileage,color,created_at")
          .eq("id", w.vehicle_id)
          .maybeSingle();

        if (!vErr && v) setVehicle(v as unknown as VehicleRow);
      } else {
        setVehicle(null);
      }

      const { data: l, error: lErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("work_order_id", w.id)
        .order("created_at", { ascending: true });

      if (lErr) throw new Error(lErr.message);
      setLines((l ?? []) as unknown as WorkOrderLineRow[]);

      const { data: ql, error: qlErr } = await supabase
        .from("work_order_quote_lines")
        .select("*")
        .eq("work_order_id", w.id)
        .order("created_at", { ascending: true });

      if (qlErr) throw new Error(qlErr.message);
      setQuoteLines((ql ?? []) as unknown as QuoteLineRow[]);

      if (cust.shop_id) {
        const { data: mi, error: miErr } = await supabase
          .from("menu_items")
          .select("*")
          .eq("shop_id", cust.shop_id)
          .eq("is_active", true)
          .order("category", { ascending: true })
          .limit(500);

        if (miErr) throw new Error(miErr.message);

        const all = (mi ?? []) as unknown as MenuItemRow[];

        const vy = (vehicle?.year ?? null) as number | null;
        const vm = safeTrim(vehicle?.make ?? null);
        const vmo = safeTrim(vehicle?.model ?? null);

        const filtered = all.filter((m) => {
          const my = getOptNumber(m, "vehicle_year");
          const mm = safeTrim(getOptString(m, "vehicle_make"));
          const mmo = safeTrim(getOptString(m, "vehicle_model"));

          const hasAnyVehicleKey = my != null || !!mm || !!mmo;
          if (!hasAnyVehicleKey) return true;

          const yearOk = my == null || (vy != null && my === vy);
          const makeOk = !mm || (vm && mm.toLowerCase() === vm.toLowerCase());
          const modelOk = !mmo || (vmo && mmo.toLowerCase() === vmo.toLowerCase());

          return yearOk && makeOk && modelOk;
        });

        setMenuItems(filtered);
      } else {
        setMenuItems([]);
      }
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to load request.";
      toast.error(msg);
    } finally {
      setRefreshing(false);
      setLoading(false);
    }
  }

  useEffect(() => {
    void loadAll();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [workOrderId]);

  async function addMenuLine(menuItemId: string) {
    if (!wo?.id) return;

    const r = await postJson<{ line?: unknown }>("/api/portal/request/add-menu-line", {
      workOrderId: wo.id,
      menuItemId,
    });

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Added menu item.");
    await loadAll();
  }

  async function addCustomLine() {
    if (!wo?.id) return;

    const desc = customDesc.trim();
    if (!desc) {
      toast.error("Enter a description for the custom line.");
      return;
    }

    const r = await postJson<{ line?: unknown }>("/api/portal/request/add-custom-line", {
      workOrderId: wo.id,
      description: desc,
      notes: customNotes.trim() || null,
    });

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Added custom line.");
    setCustomDesc("");
    setCustomNotes("");
    await loadAll();
  }

  async function addQuoteOnly() {
    if (!wo?.id) return;

    const desc = qoDesc.trim();
    if (!desc) {
      toast.error("Enter a description for the quote request.");
      return;
    }

    const qtyN = Number(qoQty);
    const qty = Number.isFinite(qtyN) ? Math.max(1, Math.min(99, Math.trunc(qtyN))) : 1;

    const r = await postJson<{ quoteLine?: unknown }>("/api/portal/request/add-quote-only", {
      workOrderId: wo.id,
      description: desc,
      notes: qoNotes.trim() || null,
      qty,
    });

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Sent to quote queue.");
    setQoDesc("");
    setQoNotes("");
    setQoQty("1");
    await loadAll();
  }

  // NEW: open the review gate instead of submitting immediately
  function beginSubmit() {
    if (!wo?.id || submitting) return;

    if (!bookingId) {
      toast.error("Missing booking. Please go back and pick a time again.");
      router.replace("/portal/request/when");
      return;
    }

    // reset per-open state
    setAgreed(false);
    setSigUrl(null);
    setReviewOpen(true);
  }

  async function finalizeSubmit(opts: { requireSignature?: boolean }) {
    if (!wo?.id || submitting || reviewBusy) return;

    if (!bookingId) {
      toast.error("Missing booking. Please go back and pick a time again.");
      router.replace("/portal/request/when");
      return;
    }

    if (!agreed) {
      toast.error("Please agree to the terms before submitting.");
      return;
    }

    setReviewBusy(true);
    setSubmitting(true);

    try {
      const uploadedSigUrl: string | null = sigUrl;

      if (!uploadedSigUrl && opts.requireSignature) {
        toast.error("Signature required.");
        return;
      }

      const r = await postJson<{
        ok?: boolean;
        bookingId?: string;
        workOrderId?: string;
      }>("/api/portal/request/submit", {
        workOrderId: wo.id,
        bookingId,
        customerAgreedAt: new Date().toISOString(),
        customerSignatureUrl: uploadedSigUrl,
      });

      if (!r.ok) {
        toast.error(r.error);
        return;
      }

      toast.success("Submitted.");
      setReviewOpen(false);
      router.replace("/portal/customer-appointments");
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Submit failed.";
      toast.error(msg);
    } finally {
      setSubmitting(false);
      setReviewBusy(false);
    }
  }

  async function captureSignature() {
    if (!wo?.id || reviewBusy) return;
    setReviewBusy(true);
    try {
      const base64: string | null = await openSignaturePad({
        shopName: "",
      });

      if (!base64) return;

      const uploaded = await uploadSignatureImage(base64, wo.id);
      setSigUrl(uploaded);
      toast.success("Signature saved.");
    } catch (e: unknown) {
      toast.error(e instanceof Error ? e.message : "Failed to save signature");
    } finally {
      setReviewBusy(false);
    }
  }

  if (loading) {
    return <div className={cardClass() + " mx-auto max-w-3xl text-sm text-neutral-200"}>Loading‚Ä¶</div>;
  }

  if (!wo?.id || !customer?.id) {
    return (
      <div className="mx-auto max-w-3xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Build request
          </h1>
          <p className="mt-2 text-sm text-neutral-400">This request is missing or expired.</p>
          <div className="mt-4">
            <LinkButton href="/portal/request/when" size="sm">
              Start again
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  const name =
    [customer.first_name ?? "", customer.last_name ?? ""].filter(Boolean).join(" ").trim() ||
    "Customer";

  return (
    <div className="mx-auto w-full max-w-3xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div>
            <div
              className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
              style={{ color: COPPER }}
            >
              Request
            </div>
            <h1 className="mt-2 text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
              Build your request
            </h1>
            <p className="mt-1 text-xs text-neutral-400">
              {name} ‚Ä¢ {vehicle ? ymm(vehicle) : "Vehicle not set"} ‚Ä¢ WO{" "}
              <span className="font-mono text-neutral-300">{wo.id.slice(0, 8)}‚Ä¶</span>
            </p>
          </div>

          <div className="flex gap-2">
            <Button type="button" variant="outline" onClick={() => void loadAll()} disabled={refreshing}>
              {refreshing ? "Refreshing‚Ä¶" : "Refresh"}
            </Button>
            <LinkButton href="/portal/request/when" variant="outline" size="sm">
              Back
            </LinkButton>
          </div>
        </div>
      </header>

      <section className={cardClass()}>
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-100">Current draft</h2>
          <div className="text-[0.75rem] text-neutral-500">
            Lines: {lines.length} ‚Ä¢ Quote requests: {quoteLines.length}
          </div>
        </div>

        {lines.length === 0 && quoteLines.length === 0 ? (
          <div className="mt-3 rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
            Nothing added yet. Add menu items, custom lines, or quote requests below.
          </div>
        ) : (
          <div className="mt-3 space-y-2">
            {lines.map((l) => {
              const title = lineTitle(l);
              const status = (l.status ?? "pending").toString();
              const est = getOptNumber(l, "price_estimate");

              return (
                <div key={l.id} className="rounded-xl border border-white/10 bg-black/35 p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-0.5 text-xs text-neutral-400">
                        Status: <span className="text-neutral-300">{status}</span>
                        {l.menu_item_id ? (
                          <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                            menu
                          </span>
                        ) : (
                          <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                            custom
                          </span>
                        )}
                      </div>

                      {typeof l.notes === "string" && l.notes.trim().length > 0 ? (
                        <div className="mt-2 text-xs text-neutral-400">{l.notes}</div>
                      ) : null}
                    </div>

                    <div className="text-right text-xs text-neutral-400">Est: {fmtMoney(est)}</div>
                  </div>
                </div>
              );
            })}

            {quoteLines.map((q) => {
              const title = (q.description ?? "Quote request").toString();
              const stage = (q.stage ?? "advisor_pending").toString();
              const qty = typeof q.qty === "number" && Number.isFinite(q.qty) ? q.qty : 1;

              return (
                <div key={q.id} className="rounded-xl border border-white/10 bg-black/25 p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-0.5 text-xs text-neutral-400">
                        Stage: <span className="text-neutral-300">{stage}</span> ‚Ä¢ Qty{" "}
                        <span className="text-neutral-300">{qty}</span>
                        <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                          quote
                        </span>
                      </div>

                      {typeof q.notes === "string" && q.notes.trim().length > 0 ? (
                        <div className="mt-2 text-xs text-neutral-500">{q.notes}</div>
                      ) : null}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      <section className={cardClass() + " space-y-3"}>
        <div className="flex items-end justify-between gap-3">
          <div>
            {sectionTitle("Add menu items")}
            <div className="mt-1 text-xs text-neutral-500">Fixed pricing lines your shop already offers.</div>
          </div>
          <div className="w-full max-w-sm">
            <input
              className={inputClass()}
              placeholder="Search menu‚Ä¶"
              value={menuSearch}
              onChange={(e) => setMenuSearch(e.target.value)}
            />
          </div>
        </div>

        {filteredMenu.length === 0 ? (
          <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
            No menu items found.
          </div>
        ) : (
          <div className="grid grid-cols-1 gap-2 sm:grid-cols-2">
            {filteredMenu.map((m) => {
              const title = menuTitle(m);
              const hrs = (m.base_labor_hours ?? m.labor_hours ?? null) as number | null;
              const price = (m.total_price ?? m.base_price ?? null) as number | null;

              return (
                <button
                  key={m.id}
                  type="button"
                  onClick={() => void addMenuLine(m.id)}
                  className="rounded-xl border border-white/10 bg-black/35 p-3 text-left transition hover:bg-black/45 active:scale-[0.99]"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-1 text-xs text-neutral-400">
                        {m.category ? <span>{String(m.category)}</span> : <span>Menu</span>}
                        {hrs != null ? <span className="ml-2">‚Ä¢ {hrs}h</span> : null}
                      </div>
                    </div>
                    <div className="text-xs text-neutral-300">{fmtMoney(price)}</div>
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </section>

      <section className={cardClass() + " space-y-3"}>
        {sectionTitle("Add custom line")}
        <div className="text-xs text-neutral-500">
          For concerns you already know. We‚Äôll estimate labor and route parts quoting as needed.
        </div>

        <input
          className={inputClass()}
          placeholder="Example: Replace rear differential input u-joint"
          value={customDesc}
          onChange={(e) => setCustomDesc(e.target.value)}
        />
        <textarea
          className={inputClass() + " min-h-[92px] resize-none"}
          placeholder="Optional notes (symptoms, urgency, noises, etc.)"
          value={customNotes}
          onChange={(e) => setCustomNotes(e.target.value)}
        />

        <div className="flex gap-2">
          <Button type="button" onClick={() => void addCustomLine()}>
            Add custom line
          </Button>
        </div>
      </section>

      <section className={cardClass() + " space-y-3"}>
        {sectionTitle("Quote-only request")}
        <div className="text-xs text-neutral-500">
          Request pricing without committing to a work order line yet. Parts will be priced and returned to your portal.
        </div>

        <div className="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_120px]">
          <input
            className={inputClass()}
            placeholder="Example: Replace tires (quote only)"
            value={qoDesc}
            onChange={(e) => setQoDesc(e.target.value)}
          />
          <input
            className={inputClass()}
            inputMode="numeric"
            placeholder="Qty"
            value={qoQty}
            onChange={(e) => setQoQty(e.target.value)}
          />
        </div>

        <textarea
          className={inputClass() + " min-h-[92px] resize-none"}
          placeholder="Optional notes (size, brand preference, etc.)"
          value={qoNotes}
          onChange={(e) => setQoNotes(e.target.value)}
        />

        <div className="flex gap-2">
          <Button type="button" onClick={() => void addQuoteOnly()} variant="outline">
            Send quote request
          </Button>
        </div>
      </section>

      <section className={cardClass()}>
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div className="text-sm font-semibold text-neutral-100">Submit request</div>
            <div className="mt-1 text-xs text-neutral-500">
              Submitting will finalize your draft and keep the reserved booking.
            </div>
          </div>

          <Button type="button" onClick={beginSubmit} disabled={submitting}>
            {submitting ? "Submitting‚Ä¶" : "Submit request"}
          </Button>
        </div>
      </section>

      <div className="pb-2 text-[0.75rem] text-neutral-500">
        Tip: Menu items are pre-priced. Custom and quote-only lines can trigger parts pricing and AI assistance.
      </div>

      {/* Review & Sign modal */}
      <div className={modalShell(reviewOpen)} aria-hidden={!reviewOpen}>
        <div className={modalBackdrop(reviewOpen)} onClick={() => setReviewOpen(false)} />
        <div className={modalCard(reviewOpen)} role="dialog" aria-modal="true">
          <div className="flex items-start justify-between gap-3">
            <div className="min-w-0">
              <div
                className="font-blackops text-[0.9rem] uppercase tracking-[0.18em]"
                style={{ color: COPPER }}
              >
                Review &amp; sign
              </div>
              <div className="mt-1 text-xs text-neutral-300">
                Confirm your request details and agree to terms before submitting.
              </div>
            </div>

            <button
              type="button"
              onClick={() => setReviewOpen(false)}
              className="rounded-full border border-white/10 bg-black/40 px-3 py-1 text-xs text-neutral-200 hover:bg-black/70"
            >
              Close
            </button>
          </div>

          <div className="mt-4 grid gap-3">
            <div className="rounded-2xl border border-white/10 bg-black/35 p-3">
              <div className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
                Summary
              </div>
              <div className="mt-2 text-sm text-neutral-100">
                {name} ‚Ä¢ {vehicle ? ymm(vehicle) : "Vehicle not set"}
              </div>
              <div className="mt-1 text-xs text-neutral-400">
                WO <span className="font-mono text-neutral-300">{wo.id}</span> ‚Ä¢ Lines {lines.length} ‚Ä¢ Quote requests{" "}
                {quoteLines.length}
              </div>
              <div className="mt-2 text-xs text-neutral-500">
                Booking reservation is held while you submit this request.
              </div>
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/25 p-3 text-xs text-neutral-300">
              <div className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
                Disclaimers
              </div>
              <ul className="mt-2 list-disc space-y-1 pl-4 text-neutral-300">
                <li>Prices and estimates are subject to change after inspection and diagnosis.</li>
                <li>This is a request and is not confirmed until the shop approves the appointment.</li>
                <li>Parts availability and additional findings may affect timing and total cost.</li>
              </ul>
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/25 p-3">
              <LegalTerms onAgreeChange={setAgreed} defaultOpen />
            </div>

            <div className="rounded-2xl border border-white/10 bg-black/25 p-3">
              <div className="flex items-center justify-between gap-2">
                <div className="text-xs text-neutral-300">
                  Signature{" "}
                  <span className="text-neutral-500">(recommended)</span>
                </div>
                <div className="text-[0.7rem] text-neutral-500">
                  {sigUrl ? (
                    <span className="text-emerald-200">Saved</span>
                  ) : (
                    <span className="text-neutral-400">Not provided</span>
                  )}
                </div>
              </div>

              <div className="mt-3 flex flex-wrap items-center gap-2">
                <Button type="button" variant="outline" onClick={() => void captureSignature()} disabled={reviewBusy}>
                  {reviewBusy ? "Working‚Ä¶" : sigUrl ? "Re-sign" : "Add signature"}
                </Button>

                <Button
                  type="button"
                  onClick={() => void finalizeSubmit({ requireSignature: false })}
                  disabled={submitting || reviewBusy || !agreed}
                >
                  {submitting ? "Submitting‚Ä¶" : "Agree & Submit request"}
                </Button>

                <span className="text-[0.7rem] text-neutral-500">
                  Staff will review and approve the appointment.
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Mount once for openSignaturePad */}
      <SignaturePad />
    </div>
  );
}

========================================
FILE: app/portal/requests/page.tsx
========================================
// app/portal/parts/requests/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import PortalShell from "@/features/portal/components/PortalShell";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

// Extend locally in case your generated types haven't caught up yet.
type RequestRow = DB["public"]["Tables"]["part_requests"]["Row"] & {
  customer_id?: string | null;
  portal_user_id?: string | null;
};

type ItemRow = DB["public"]["Tables"]["part_request_items"]["Row"];

const glass =
  "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";
const muted = "text-neutral-400";

export default function PortalPartsRequestsPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(true);
  const [requests, setRequests] = useState<
    Array<RequestRow & { items: ItemRow[] }>
  >([]);

  useEffect(() => {
    void (async () => {
      setLoading(true);

      const { data: auth } = await supabase.auth.getUser();
      const userId = auth?.user?.id ?? null;

      // If portal auth isn't wired yet, just show empty state.
      if (!userId) {
        setRequests([]);
        setLoading(false);
        return;
      }

      // Fetch requests that look like "belong to this portal user".
      // We try a couple likely columns without relying on them existing in types.
      const { data: reqs, error } = await supabase
        .from("part_requests")
        .select("*")
        .or(`customer_id.eq.${userId},portal_user_id.eq.${userId}`)
        .order("created_at", { ascending: false });

      if (error) {
        console.warn("portal parts requests load failed:", error.message);
        setRequests([]);
        setLoading(false);
        return;
      }

      const list = (reqs ?? []) as RequestRow[];
      const ids = list.map((r) => r.id);

      const itemsMap: Record<string, ItemRow[]> = {};
      if (ids.length) {
        const { data: items } = await supabase
          .from("part_request_items")
          .select("*")
          .in("request_id", ids);

        for (const it of items ?? []) {
          (itemsMap[it.request_id] ||= []).push(it);
        }
      }

      setRequests(list.map((r) => ({ ...r, items: itemsMap[r.id] ?? [] })));
      setLoading(false);
    })();
  }, [supabase]);

  return (
    <PortalShell
      title="Customer Portal"
      subtitle="Review parts requested by your shop and track approvals"
    >
      <div className="space-y-4">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">
            Parts Requests
          </div>
          <h1 className="font-header text-3xl text-orange-400">
            Requests & Approvals
          </h1>
          <p className={`mt-1 text-sm ${muted}`}>
            If your shop needs your approval before ordering parts, you‚Äôll see
            the requests here.
          </p>
        </div>

        {loading ? (
          <div className={`${glass} ${muted} text-sm`}>Loading‚Ä¶</div>
        ) : requests.length === 0 ? (
          <div className={`${glass} ${muted} text-sm`}>
            No parts requests found yet.
            <div className="mt-3 flex flex-wrap gap-2">
              <Link
                href="/portal/parts"
                className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
              >
                Back to Parts
              </Link>
              <Link
                href="/portal/history"
                className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
              >
                View history
              </Link>
            </div>
          </div>
        ) : (
          <div className="grid gap-3 md:grid-cols-2">
            {requests.map((r) => (
              <div key={r.id} className={glass}>
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-sm font-semibold text-neutral-100">
                      Request #{r.id.slice(0, 8)}
                    </div>
                    <div className={`mt-0.5 text-xs ${muted}`}>
                      Status:{" "}
                      <span className="capitalize text-neutral-200">
                        {String(r.status ?? "requested")}
                      </span>
                    </div>
                  </div>

                  <Link
                    href={`/portal/parts`}
                    className="rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
                  >
                    Parts
                  </Link>
                </div>

                <ul className={`mt-3 list-disc pl-5 text-sm ${muted} space-y-1`}>
                  {(r.items ?? []).slice(0, 4).map((it) => (
                    <li key={it.id}>
                      {it.description} √ó {Number((it as ItemRow).qty)}
                    </li>
                  ))}
                  {(r.items ?? []).length > 4 && (
                    <li>+ {(r.items ?? []).length - 4} more‚Ä¶</li>
                  )}
                </ul>

                <div className="mt-4 flex flex-wrap gap-2">
                  {/* If/when you add a portal detail page, change this link */}
                  <Link
                    href="/portal/history"
                    className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
                  >
                    View history
                  </Link>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </PortalShell>
  );
}

========================================
FILE: app/portal/request/when/page.tsx
========================================
// app/portal/request/when/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";
import LinkButton from "@shared/components/ui/LinkButton";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];
type ShopRow = Pick<DB["public"]["Tables"]["shops"]["Row"], "id" | "slug" | "timezone">;
type ShopHoursRow = DB["public"]["Tables"]["shop_hours"]["Row"];

type VisitType = "waiter" | "drop_off";

const COPPER = "#C57A4A";

function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none focus:border-white/20";
}

function pillClass(active: boolean) {
  return active
    ? "border-white/15 bg-white/10 text-neutral-50"
    : "border-white/10 bg-black/30 text-neutral-200 hover:bg-black/45";
}

function toIsoDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

function addDays(base: Date, days: number) {
  const d = new Date(base);
  d.setDate(d.getDate() + days);
  return d;
}

function rec(row: unknown): Record<string, unknown> {
  return (row && typeof row === "object" ? (row as Record<string, unknown>) : {}) as Record<
    string,
    unknown
  >;
}

function normalizeWeekdayToJs(dowRaw: number): number | null {
  if (!Number.isFinite(dowRaw)) return null;
  if (dowRaw >= 0 && dowRaw <= 6) return dowRaw;
  if (dowRaw >= 1 && dowRaw <= 7) return null;
  return null;
}

function getWeekdayCandidates(h: ShopHoursRow): number[] {
  const r = rec(h);

  const raw =
    (typeof r.weekday === "number" ? r.weekday : null) ??
    (typeof r.day_of_week === "number" ? r.day_of_week : null) ??
    (typeof r.dow === "number" ? r.dow : null);

  if (typeof raw !== "number" || !Number.isFinite(raw)) return [];

  const direct = normalizeWeekdayToJs(raw);
  if (direct != null) return [direct];

  if (raw >= 1 && raw <= 7) {
    const mon1 = raw % 7; // Mon=1..Sun=7 => Sun becomes 0
    const sun1 = raw - 1; // Sun=1..Sat=7
    return Array.from(new Set([mon1, sun1])).filter((n) => n >= 0 && n <= 6);
  }

  return [];
}

function getOpen(h: ShopHoursRow): string | null {
  const r = rec(h);
  const v =
    (typeof r.open_time === "string" ? r.open_time : null) ??
    (typeof r.open === "string" ? r.open : null);
  return typeof v === "string" ? v : null;
}

function getClose(h: ShopHoursRow): string | null {
  const r = rec(h);
  const v =
    (typeof r.close_time === "string" ? r.close_time : null) ??
    (typeof r.close === "string" ? r.close : null);
  return typeof v === "string" ? v : null;
}

function isClosedRow(h: ShopHoursRow): boolean {
  const r = rec(h);
  const closed =
    (typeof r.is_closed === "boolean" ? r.is_closed : false) ||
    (typeof r.closed === "boolean" ? r.closed : false) ||
    (typeof r.is_open === "boolean" ? !r.is_open : false);

  return !!closed;
}

function parseHmToMinutes(hm: string): number | null {
  const cleaned = hm.trim().split(/[^\d:]/)[0] ?? "";
  const parts = cleaned.split(":").map((x) => x.trim());
  if (parts.length < 2) return null;

  const hh = Number(parts[0]);
  const mm = Number(parts[1]);
  if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;

  return hh * 60 + mm;
}

function minutesToLabel(mins: number) {
  const hh = Math.floor(mins / 60);
  const mm = mins % 60;
  const h12 = ((hh + 11) % 12) + 1;
  const ampm = hh >= 12 ? "PM" : "AM";
  const mmStr = mm.toString().padStart(2, "0");
  return `${h12}:${mmStr} ${ampm}`;
}

type Slot = {
  startsAtIso: string;
  label: string;
};

async function postJson<TResp>(
  url: string,
  body: unknown,
): Promise<{ ok: true; data: TResp } | { ok: false; error: string; status: number }> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const j = (await res.json().catch(() => ({}))) as { error?: string } & Record<string, unknown>;

  if (!res.ok) {
    return {
      ok: false,
      error: (typeof j?.error === "string" && j.error) || "Request failed",
      status: res.status,
    };
  }

  return { ok: true, data: j as unknown as TResp };
}

function mergeRanges(ranges: Array<[number, number]>): Array<[number, number]> {
  const sorted = ranges
    .filter(([a, b]) => Number.isFinite(a) && Number.isFinite(b) && b > a)
    .sort((x, y) => x[0] - y[0]);

  const out: Array<[number, number]> = [];
  for (const [s, e] of sorted) {
    const last = out[out.length - 1];
    if (!last) out.push([s, e]);
    else if (s <= last[1]) last[1] = Math.max(last[1], e);
    else out.push([s, e]);
  }
  return out;
}

export default function PortalRequestWhenPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();

  const [loading, setLoading] = useState(true);

  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [shop, setShop] = useState<ShopRow | null>(null);
  const [vehicles, setVehicles] = useState<VehicleRow[]>([]);
  const [shopHours, setShopHours] = useState<ShopHoursRow[]>([]);

  const [vehicleId, setVehicleId] = useState<string>("");
  const [date, setDate] = useState<string>(() => toIsoDate(new Date()));
  const [visitType, setVisitType] = useState<VisitType>("drop_off");
  const [selectedSlotIso, setSelectedSlotIso] = useState<string>("");

  const [starting, setStarting] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr || !user) {
        toast.error("Please sign in to request service.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cancelled) return;

      if (cErr) {
        toast.error(cErr.message);
        setCustomer(null);
        setLoading(false);
        return;
      }

      const cust = (c ?? null) as CustomerRow | null;
      setCustomer(cust);

      if (!cust?.shop_id) {
        setShop(null);
        setVehicles([]);
        setShopHours([]);
        setLoading(false);
        return;
      }

      const { data: s, error: sErr } = await supabase
        .from("shops")
        .select("id,slug,timezone")
        .eq("id", cust.shop_id)
        .maybeSingle();

      if (cancelled) return;

      if (sErr || !s) {
        toast.error("Unable to load your shop.");
        setShop(null);
        setVehicles([]);
        setShopHours([]);
        setLoading(false);
        return;
      }

      setShop(s as ShopRow);

      const { data: v, error: vErr } = await supabase
        .from("vehicles")
        .select("id,customer_id,shop_id,year,make,model,vin,license_plate,mileage,color,created_at")
        .eq("customer_id", cust.id)
        .order("created_at", { ascending: false });

      if (cancelled) return;

      if (vErr) {
        toast.error(vErr.message);
        setVehicles([]);
      } else {
        const vv = (v ?? []) as unknown as VehicleRow[];
        setVehicles(vv);
        if (!vehicleId && vv[0]?.id) setVehicleId(vv[0].id);
      }

      const { data: h, error: hErr } = await supabase.from("shop_hours").select("*").eq("shop_id", s.id);

      if (cancelled) return;

      if (hErr) {
        toast.error("Unable to load shop hours.");
        setShopHours([]);
      } else {
        setShopHours((h ?? []) as ShopHoursRow[]);
      }

      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase, router]);

  const dateOptions = useMemo(() => {
    const base = new Date();
    const days = Array.from({ length: 21 }).map((_, i) => addDays(base, i));
    return days.map((d) => {
      const iso = toIsoDate(d);
      const label = d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
      return { iso, label };
    });
  }, []);

  const slots: Slot[] = useMemo(() => {
    if (!date) return [];
    if (!shopHours.length) return [];

    const d = new Date(`${date}T00:00:00`);
    const jsDay = d.getDay();

    const candidateRows = shopHours.filter((h) => {
      if (isClosedRow(h)) return false;
      const cands = getWeekdayCandidates(h);
      return cands.includes(jsDay);
    });

    if (!candidateRows.length) return [];

    const ranges: Array<[number, number]> = [];

    for (const row of candidateRows) {
      const open = getOpen(row);
      const close = getClose(row);
      if (!open || !close) continue;

      const openM = parseHmToMinutes(open);
      const closeM = parseHmToMinutes(close);
      if (openM == null || closeM == null) continue;
      if (closeM <= openM) continue;

      ranges.push([openM, closeM]);
    }

    const merged = mergeRanges(ranges);
    if (!merged.length) return [];

    const startOfDay = new Date(`${date}T00:00:00.000`);
    const out: Slot[] = [];

    for (const [openM, closeM] of merged) {
      for (let m = openM; m + 60 <= closeM; m += 60) {
        const slotStart = new Date(startOfDay);
        slotStart.setMinutes(m, 0, 0);

        out.push({
          startsAtIso: slotStart.toISOString(),
          label: minutesToLabel(m),
        });
      }
    }

    return out;
  }, [date, shopHours]);

  useEffect(() => {
    setSelectedSlotIso("");
  }, [date]);

  const canStart = Boolean(customer?.id && shop?.id && vehicleId && selectedSlotIso);

  async function onStart() {
    if (!canStart || starting) return;

    setStarting(true);
    try {
      const payload = { vehicleId, startsAt: selectedSlotIso, visitType };

      const r = await postJson<{ workOrderId?: string; bookingId?: string }>(
        "/api/portal/request/start",
        payload,
      );

      if (!r.ok) {
        toast.error(r.error);
        return;
      }

      const wo = r.data.workOrderId ?? "";
      const booking = r.data.bookingId ?? "";

      if (!wo || !booking) {
        toast.error("Start failed: missing work order id or booking id.");
        return;
      }

      // ‚úÖ Option B: carry bookingId into build page (NOT startsAt)
      router.push(
        `/portal/request/build?wo=${encodeURIComponent(wo)}&booking=${encodeURIComponent(booking)}`,
      );
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Start failed.";
      toast.error(msg);
    } finally {
      setStarting(false);
    }
  }

  if (loading) {
    return <div className={cardClass() + " mx-auto max-w-xl text-sm text-neutral-200"}>Loading‚Ä¶</div>;
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Request service</h1>
          <p className="mt-2 text-sm text-neutral-400">We couldn‚Äôt find your customer profile yet.</p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">Go to profile</LinkButton>
            <LinkButton href="/portal/vehicles" size="sm">Add a vehicle</LinkButton>
          </div>
        </div>
      </div>
    );
  }

  if (!shop?.id) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Request service</h1>
          <p className="mt-2 text-sm text-neutral-400">Your portal account isn‚Äôt linked to a shop yet.</p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">Go to profile</LinkButton>
            <LinkButton href="/portal/customer-appointments" size="sm">My appointments</LinkButton>
          </div>
        </div>
      </div>
    );
  }

  const customerName =
    [customer.first_name ?? "", customer.last_name ?? ""].filter(Boolean).join(" ").trim() || "Customer";

  return (
    <div className="mx-auto w-full max-w-xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Request
        </div>
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Pick a time</h1>
        <p className="text-xs text-neutral-400">
          {customerName} ‚Ä¢ Shop: <span className="text-neutral-300">{shop.slug}</span>
        </p>
      </header>

      <section className={cardClass() + " space-y-4"}>
        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Vehicle</div>

          {vehicles.length === 0 ? (
            <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
              No vehicles found. Add one first.
              <div className="mt-3">
                <LinkButton href="/portal/vehicles" size="sm">Add vehicle</LinkButton>
              </div>
            </div>
          ) : (
            <select className={inputClass()} value={vehicleId} onChange={(e) => setVehicleId(e.target.value)}>
              {vehicles.map((v) => {
                const label = [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim() || "Vehicle";
                const vin = v.vin ? ` ‚Ä¢ VIN ${String(v.vin).slice(-6)}` : "";
                return (
                  <option key={v.id} value={v.id}>
                    {label}
                    {vin}
                  </option>
                );
              })}
            </select>
          )}
        </div>

        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Date</div>
          <select className={inputClass()} value={date} onChange={(e) => setDate(e.target.value)}>
            {dateOptions.map((d) => (
              <option key={d.iso} value={d.iso}>
                {d.label}
              </option>
            ))}
          </select>
        </div>

        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Time</div>
            <div className="text-[0.75rem] text-neutral-500">1-hour slots</div>
          </div>

          {slots.length === 0 ? (
            <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
              No hours available for this day.
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-2 sm:grid-cols-3">
              {slots.map((s) => {
                const active = selectedSlotIso === s.startsAtIso;
                return (
                  <button
                    key={s.startsAtIso}
                    type="button"
                    onClick={() => setSelectedSlotIso(s.startsAtIso)}
                    className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(active)}
                  >
                    {s.label}
                  </button>
                );
              })}
            </div>
          )}
        </div>

        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Visit type</div>
          <div className="grid grid-cols-2 gap-2">
            <button
              type="button"
              className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(visitType === "waiter")}
              onClick={() => setVisitType("waiter")}
            >
              Waiter
              <div className="mt-1 text-[0.75rem] text-neutral-400">You plan to wait at the shop.</div>
            </button>
            <button
              type="button"
              className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(visitType === "drop_off")}
              onClick={() => setVisitType("drop_off")}
            >
              Drop off
              <div className="mt-1 text-[0.75rem] text-neutral-400">Leave the vehicle for service.</div>
            </button>
          </div>
        </div>

        <div className="flex flex-wrap gap-2 pt-1">
          <Button
            type="button"
            onClick={() => void onStart()}
            disabled={!canStart || starting || vehicles.length === 0}
            className="min-w-[180px]"
          >
            {starting ? "Starting‚Ä¶" : "Next: build request"}
          </Button>

          <LinkButton href="/portal/customer-appointments" variant="outline" size="sm">
            Back
          </LinkButton>
        </div>

        <p className="text-[0.75rem] text-neutral-500">
          Next you‚Äôll build your service request (menu items, custom lines, and quote-only requests).
        </p>
      </section>
    </div>
  );
}

========================================
FILE: app/portal/settings/page.tsx
========================================
// app/portal/settings/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import LinkButton from "@shared/components/ui/LinkButton";

type Customer = Database["public"]["Tables"]["customers"]["Row"];
type SettingsRow = Database["public"]["Tables"]["customer_settings"]["Row"];
type SettingsInsert = Database["public"]["Tables"]["customer_settings"]["Insert"];

const COPPER = "#C57A4A";

function cardClass() {
  return "rounded-3xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputWrapClass() {
  return "w-full rounded-xl border border-white/10 bg-black/35 p-2 text-sm text-white outline-none focus:border-white/20 focus:ring-1 focus:ring-white/10";
}

function copperButtonStyle(): React.CSSProperties {
  return {
    borderColor: "rgba(197,122,74,0.55)",
    color: "rgba(245,225,205,0.95)",
    background: "rgba(197,122,74,0.10)",
  };
}

export default function PortalSettingsPage() {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);

  const [form, setForm] = useState<SettingsRow>({
    customer_id: "",
    comm_email_enabled: true,
    comm_sms_enabled: false,
    marketing_opt_in: false,
    preferred_contact: "email",
    units: "imperial",
    language: "en",
    timezone: "UTC",
    updated_at: new Date().toISOString(),
  });

  const tzOptions = useMemo(
    () => [
      "UTC",
      "America/New_York",
      "America/Chicago",
      "America/Denver",
      "America/Los_Angeles",
      "America/Phoenix",
      "Europe/London",
      "Europe/Paris",
      "Asia/Tokyo",
      "Australia/Sydney",
    ],
    [],
  );

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);
      setError(null);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr || !user) {
        setError("You must be signed in to view settings.");
        setLoading(false);
        return;
      }

      const { data: cust, error: custErr } = await supabase
        .from("customers")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (cancelled) return;

      if (custErr || !cust) {
        setError(
          "We couldn't find your customer profile. Please complete your profile first.",
        );
        setLoading(false);
        return;
      }

      setCustomer(cust);

      const { data: existing, error: settingsErr } = await supabase
        .from("customer_settings")
        .select("*")
        .eq("customer_id", cust.id)
        .maybeSingle();

      if (cancelled) return;

      if (settingsErr) {
        setError(settingsErr.message);
        setLoading(false);
        return;
      }

      if (existing) {
        setForm(existing);
      } else {
        const defaults: SettingsInsert = {
          customer_id: cust.id,
          comm_email_enabled: true,
          comm_sms_enabled: false,
          marketing_opt_in: false,
          preferred_contact: "email",
          units: "imperial",
          language: "en",
          timezone: "UTC",
        };

        const { error: seedErr } = await supabase
          .from("customer_settings")
          .upsert(defaults, { onConflict: "customer_id" });

        if (seedErr) {
          setError(seedErr.message);
          setLoading(false);
          return;
        }

        setForm({
          ...(defaults as SettingsRow),
          updated_at: new Date().toISOString(),
        });
      }

      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase]);

  const update = <K extends keyof SettingsRow>(key: K, value: SettingsRow[K]) =>
    setForm((f) => ({ ...f, [key]: value }));

  const onSave = async () => {
    if (!customer) {
      toast.error("Customer profile not loaded yet.");
      return;
    }

    setSaving(true);
    setError(null);

    try {
      const payload: SettingsInsert = {
        customer_id: customer.id,
        comm_email_enabled: form.comm_email_enabled,
        comm_sms_enabled: form.comm_sms_enabled,
        marketing_opt_in: form.marketing_opt_in,
        preferred_contact: form.preferred_contact ?? "email",
        units: form.units ?? "imperial",
        language: form.language ?? "en",
        timezone: form.timezone ?? "UTC",
      };

      const { error: upsertErr } = await supabase
        .from("customer_settings")
        .upsert(payload, { onConflict: "customer_id" });

      if (upsertErr) {
        setError(upsertErr.message);
        toast.error(upsertErr.message || "Failed to save settings");
        return;
      }

      update("updated_at", new Date().toISOString() as SettingsRow["updated_at"]);
      toast.success("Settings saved");
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to save settings";
      setError(msg);
      toast.error(msg);
    } finally {
      setSaving(false);
    }
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-2xl">
        <Toaster position="top-center" />
        <div className={cardClass() + " text-sm text-neutral-200"}>
          Loading your settings‚Ä¶
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="mx-auto max-w-2xl space-y-4 text-white">
        <Toaster position="top-center" />
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Settings
          </h1>
        </header>

        <div className="space-y-3 rounded-3xl border border-red-500/35 bg-red-900/20 p-4 text-sm backdrop-blur-md shadow-card">
          <p className="text-red-100">{error}</p>
          <LinkButton href="/portal" variant="outline" size="sm">
            Go to profile
          </LinkButton>
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-2xl space-y-6 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
          Settings
        </h1>
        <p className="text-xs text-neutral-400">
          Choose how we contact you and how information is displayed.
        </p>

        <div
          className="mt-3 h-px w-full"
          style={{
            background:
              "linear-gradient(90deg, rgba(197,122,74,0.0), rgba(197,122,74,0.35), rgba(197,122,74,0.0))",
          }}
        />
      </header>

      <section className={cardClass() + " space-y-3 sm:p-5"}>
        <h2 className="text-sm font-semibold text-neutral-50">Communication</h2>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4"
            style={{ accentColor: COPPER }}
            checked={!!form.comm_email_enabled}
            onChange={(e) => update("comm_email_enabled", e.target.checked)}
          />
          <span>Email notifications</span>
        </label>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4"
            style={{ accentColor: COPPER }}
            checked={!!form.comm_sms_enabled}
            onChange={(e) => update("comm_sms_enabled", e.target.checked)}
          />
          <span>SMS notifications</span>
        </label>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4"
            style={{ accentColor: COPPER }}
            checked={!!form.marketing_opt_in}
            onChange={(e) => update("marketing_opt_in", e.target.checked)}
          />
          <span>Receive service tips &amp; updates</span>
        </label>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs text-neutral-400">
              Preferred contact
            </label>
            <select
              className={inputWrapClass()}
              value={form.preferred_contact ?? "email"}
              onChange={(e) =>
                update(
                  "preferred_contact",
                  e.target.value as SettingsRow["preferred_contact"],
                )
              }
            >
              <option value="email">Email</option>
              <option value="sms">SMS</option>
              <option value="phone">Phone</option>
            </select>
          </div>
        </div>
      </section>

      <section className={cardClass() + " space-y-3 sm:p-5"}>
        <h2 className="text-sm font-semibold text-neutral-50">Display</h2>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs text-neutral-400">Units</label>
            <select
              className={inputWrapClass()}
              value={form.units ?? "imperial"}
              onChange={(e) => update("units", e.target.value as SettingsRow["units"])}
            >
              <option value="imperial">Imperial (mi, ¬∞F)</option>
              <option value="metric">Metric (km, ¬∞C)</option>
            </select>
          </div>

          <div>
            <label className="mb-1 block text-xs text-neutral-400">
              Language
            </label>
            <select
              className={inputWrapClass()}
              value={form.language ?? "en"}
              onChange={(e) => update("language", e.target.value)}
            >
              <option value="en">English</option>
            </select>
          </div>

          <div className="sm:col-span-2">
            <label className="mb-1 block text-xs text-neutral-400">
              Timezone
            </label>
            <select
              className={inputWrapClass()}
              value={form.timezone ?? "UTC"}
              onChange={(e) => update("timezone", e.target.value)}
            >
              {tzOptions.map((tz) => (
                <option key={tz} value={tz}>
                  {tz}
                </option>
              ))}
            </select>
          </div>
        </div>
      </section>

      <div className="flex flex-wrap items-center gap-3">
        <button
          onClick={onSave}
          disabled={saving}
          className="inline-flex items-center justify-center rounded-xl border px-4 py-2 text-sm font-semibold transition disabled:opacity-60 active:scale-[0.99]"
          style={copperButtonStyle()}
        >
          {saving ? "Saving‚Ä¶" : "Save settings"}
        </button>

        <span className="text-xs text-neutral-400">
          Last updated:{" "}
          {form.updated_at ? new Date(form.updated_at).toLocaleString() : "‚Äî"}
        </span>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/shop/[slug]/PageClient.tsx
========================================
// app/portal/shop/[slug]/PageClient.tsx
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

import ShareBox from "./ShareBox";
import ReviewsList from "@shared/components/reviews/ReviewsList";
import ReviewForm from "@shared/components/reviews/ReviewForm";

type Props = {
  slug: string;
  /** Pass from server if you already looked it up; otherwise we‚Äôll fetch by slug. */
  shopId?: string;
};

export default function ShopSharePage({ slug, shopId: shopIdProp }: Props) {
  const supabase = createClientComponentClient<Database>();
  const [shopId, setShopId] = useState<string>(shopIdProp ?? "");
  const [loadingShopId, setLoadingShopId] = useState(!shopIdProp);

  useEffect(() => {
    if (shopIdProp) return; // already provided by server
    (async () => {
      setLoadingShopId(true);
      const { data } = await supabase
        .from("shops")
        .select("id")
        .eq("slug", slug)
        .maybeSingle();
      if (data?.id) setShopId(data.id);
      setLoadingShopId(false);
    })();
  }, [slug, shopIdProp, supabase]);

  /** Build a base URL that works in all environments */
  const base =
    typeof process !== "undefined" && process.env.NEXT_PUBLIC_BASE_URL
      ? process.env.NEXT_PUBLIC_BASE_URL
      : typeof window !== "undefined" && window.location?.origin
      ? window.location.origin
      : "https://example.com";

  const bookingUrl = `${base}/portal/booking?shop=${encodeURIComponent(slug)}`;
  const qrSrc = `/api/portal/qr?shop=${encodeURIComponent(slug)}`;

  return (
    <div className="mx-auto max-w-3xl space-y-8 py-6">
      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-400">
          Share your booking link
        </h1>
        <p className="text-sm text-neutral-400">
          Copy your booking link, download a QR code, and manage reviews for this
          shop.
        </p>
      </header>

      <ShareBox slug={slug} bookingUrl={bookingUrl} qrSrc={qrSrc} />

      {/* Reviews */}
      <section className="space-y-4">
        <div className="flex items-center justify-between gap-2">
          <h2 className="text-lg font-semibold text-neutral-50">
            Customer reviews
          </h2>
          {loadingShopId && (
            <span className="text-xs text-neutral-500">Loading shop‚Ä¶</span>
          )}
        </div>

        {shopId ? (
          <>
            <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 p-4">
              <ReviewsList shopId={shopId} />
            </div>
            <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 p-4">
              <ReviewForm shopId={shopId} />
            </div>
          </>
        ) : !loadingShopId ? (
          <div className="rounded-xl border border-red-700/40 bg-red-900/30 p-3 text-sm text-red-100">
            We couldn‚Äôt resolve this shop. Check that the share link uses a valid
            slug.
          </div>
        ) : null}
      </section>
    </div>
  );
}

========================================
FILE: app/portal/shop/[slug]/page.tsx
========================================
// app/portal/shop/[slug]/page.tsx
import type { Metadata } from "next";
import PublicProfileClient from "./ShopPublicProfileView";

export const dynamic = "force-dynamic";
export const revalidate = 0;

type PageProps = {
  params: Promise<{ slug: string }>;
};

export async function generateMetadata(
  props: PageProps
): Promise<Metadata> {
  const { slug } = await props.params;
  return {
    title: `Shop ‚Ä¢ ${slug} | ProFixIQ`,
  };
}

export default async function Page(props: PageProps) {
  const { slug } = await props.params;
  return <PublicProfileClient slug={slug} />;
}

========================================
FILE: app/portal/shop/[slug]/ShareBox.tsx
========================================
// app/portal/shop/[slug]/ShareBox.tsx
"use client";

import { useState } from "react";
import LinkButton from "@shared/components/ui/LinkButton";
import { toast } from "sonner";

export default function ShareBox({
  slug,
  bookingUrl,
  qrSrc,
}: {
  slug: string;
  bookingUrl: string;
  qrSrc: string;
}) {
  const [copying, setCopying] = useState(false);
  const [downloading, setDownloading] = useState(false);

  async function copyLink() {
    try {
      setCopying(true);
      await navigator.clipboard.writeText(bookingUrl);
      toast.success("Booking link copied!");
    } catch {
      toast.error("Couldn‚Äôt copy link");
    } finally {
      setCopying(false);
    }
  }

  async function downloadQR() {
    try {
      setDownloading(true);
      const res = await fetch(qrSrc, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch QR");
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `profixiq-booking-${slug}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast.success("QR code downloaded");
    } catch {
      toast.error("Couldn‚Äôt download QR");
    } finally {
      setDownloading(false);
    }
  }

  return (
    <div className="space-y-6 rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4 sm:p-5">
      {/* Booking link */}
      <div className="space-y-2">
        <label className="block text-xs font-medium uppercase tracking-[0.12em] text-neutral-400">
          Booking link
        </label>
        <div className="flex flex-col gap-2 sm:flex-row">
          <input
            readOnly
            value={bookingUrl}
            className="flex-1 rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white outline-none focus:border-orange-400 focus:ring-1 focus:ring-orange-500"
          />
          <button
            onClick={copyLink}
            disabled={copying}
            className="rounded-lg border border-orange-600 px-3 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
          >
            {copying ? "Copying‚Ä¶" : "Copy link"}
          </button>
        </div>
      </div>

      {/* QR + actions */}
      <div className="grid grid-cols-1 items-start gap-4 sm:grid-cols-[auto,1fr]">
        {/* eslint-disable-next-line @next/next/no-img-element */}
        <img
          src={qrSrc}
          alt="Booking QR code"
          className="h-44 w-44 rounded-lg border border-neutral-800 bg-black p-2"
        />

        <div className="space-y-3 text-sm text-neutral-300">
          <p>
            Print this QR and place it at your counter. Customers can scan it to
            open your booking page for{" "}
            <span className="font-mono text-orange-400">@{slug}</span>.
          </p>

          <div className="flex flex-wrap gap-2">
            <LinkButton
              href={`/portal/booking?shop=${encodeURIComponent(slug)}`}
              className="rounded-lg border border-orange-600 bg-orange-600 px-3 py-2 text-sm font-semibold text-black transition hover:bg-orange-500"
            >
              Open booking page
            </LinkButton>

            <button
              onClick={downloadQR}
              disabled={downloading}
              className="rounded-lg border border-orange-600 px-3 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
            >
              {downloading ? "Downloading‚Ä¶" : "Download QR"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/shop/[slug]/ShopPublicProfileView.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import Link from "next/link";

type DB = Database;
type ShopsRow = DB["public"]["Tables"]["shops"]["Row"];

type Props = { slug: string };

type PublicFields = Pick<
  ShopsRow,
  | "name"
  | "phone_number"
  | "email"
  | "address"
  | "city"
  | "province"
  | "postal_code"
  | "images"
  | "geo_lat"
  | "geo_lng"
> & {
  description?: string | null;
  website?: string | null;
};

const emptyPublic: PublicFields = {
  name: "",
  phone_number: null,
  email: null,
  address: null,
  city: null,
  province: null,
  postal_code: null,
  images: null,
  geo_lat: null,
  geo_lng: null,
  description: null,
  website: null,
};

export default function PublicProfileClient({ slug }: Props) {
  const supabase = createClientComponentClient<DB>();
  const [data, setData] = useState<PublicFields>(emptyPublic);
  const [loading, setLoading] = useState(true);
  const [notFound, setNotFound] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const { data: row, error } = await supabase
        .from("shops")
        .select(
          [
            "name",
            "phone_number",
            "email",
            "address",
            "city",
            "province",
            "postal_code",
            "images",
            "geo_lat",
            "geo_lng",
            // Uncomment if these exist in your DB:
            // "description",
            // "website",
          ].join(","),
        )
        .eq("slug", slug)
        .maybeSingle<ShopsRow>();

      if (cancelled) return;

      if (error || !row) {
        setNotFound(true);
        setLoading(false);
        return;
      }

      const next: PublicFields = {
        name: row.name ?? "",
        phone_number: row.phone_number ?? null,
        email: row.email ?? null,
        address: row.address ?? null,
        city: row.city ?? null,
        province: row.province ?? null,
        postal_code: row.postal_code ?? null,
        images: row.images ?? null,
        geo_lat: row.geo_lat ?? null,
        geo_lng: row.geo_lng ?? null,
        // description: row.description ?? null, // if column exists
        // website: row.website ?? null,         // if column exists
      };

      setData(next);
      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [slug, supabase]);

  // Defensive: ensure we always have an array
  const images: string[] = Array.isArray(data.images)
    ? (data.images as string[])
    : [];
  const hero = images[0] ?? null;
  const gallery = images.slice(1);

  if (loading) {
    return (
      <div className="mx-auto max-w-4xl p-6 text-sm text-neutral-400">
        Loading shop‚Ä¶
      </div>
    );
  }

  if (notFound) {
    return (
      <div className="mx-auto max-w-4xl px-4 py-8 space-y-2">
        <h1 className="text-2xl font-blackops text-orange-400">
          Shop not found
        </h1>
        <p className="text-sm text-neutral-400">
          We couldn‚Äôt find a shop with slug{" "}
          <span className="font-mono">{slug}</span>.
        </p>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-5xl space-y-8 px-4 py-8">
      {/* Hero */}
      {hero && (
        <div className="overflow-hidden rounded-2xl border border-neutral-800">
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img
            src={hero}
            alt={`${data.name} hero`}
            className="h-64 w-full object-cover"
          />
        </div>
      )}

      {/* Header */}
      <header className="space-y-1">
        <h1 className="text-3xl font-blackops text-orange-400">
          {data.name}
        </h1>
        {data.description ? (
          <p className="text-sm text-neutral-300">{data.description}</p>
        ) : null}
      </header>

      {/* Contact / Basics */}
      <section className="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div className="rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4">
          <h2 className="mb-2 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
            Contact
          </h2>
          <ul className="space-y-1 text-sm text-neutral-100">
            {data.phone_number ? <li>üìû {data.phone_number}</li> : null}
            {data.email ? <li>‚úâÔ∏è {data.email}</li> : null}
            {data.website ? (
              <li>
                üåê{" "}
                <a
                  href={data.website}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-orange-400 underline underline-offset-2"
                >
                  {data.website}
                </a>
              </li>
            ) : null}
          </ul>
        </div>

        <div className="rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4 md:col-span-2">
          <h2 className="mb-2 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
            Location
          </h2>
          <p className="text-sm text-neutral-100">
            {[data.address, data.city, data.province, data.postal_code]
              .filter(Boolean)
              .join(", ")}
          </p>

          {data.geo_lat !== null && data.geo_lng !== null ? (
            <p className="mt-2 text-sm">
              <a
                className="text-orange-400 underline underline-offset-2"
                href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                  `${data.geo_lat},${data.geo_lng}`,
                )}`}
                target="_blank"
                rel="noopener noreferrer"
              >
                Open in Google Maps
              </a>
            </p>
          ) : null}
        </div>
      </section>

      {/* Gallery */}
      {gallery.length > 0 && (
        <section className="space-y-3">
          <h2 className="text-sm font-semibold text-neutral-50">Gallery</h2>
          <div className="grid grid-cols-2 gap-3 sm:grid-cols-3">
            {gallery.map((url) => (
              // eslint-disable-next-line @next/next/no-img-element
              <img
                key={url}
                src={url}
                alt="Shop photo"
                className="h-40 w-full rounded-lg border border-neutral-800 object-cover"
              />
            ))}
          </div>
        </section>
      )}

      {/* Primary CTA to book */}
      <div className="pt-2">
        <Link
          href={`/portal/booking?shop=${encodeURIComponent(slug)}`}
          className="inline-flex items-center rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black"
        >
          Book an appointment
        </Link>
      </div>
    </div>
  );
}

========================================
FILE: app/portal/vehicles/page.tsx
========================================
// app/portal/vehicles/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

/** Minimal shapes (keep lint happy, no `any`, no big supabase types) */
type VehicleRow = {
  id: string;
  customer_id: string | null;
  year: number | null;
  make: string | null;
  model: string | null;
  vin: string | null;
  license_plate: string | null;
  mileage: string | null;
  color: string | null;
  created_at?: string | null;
};

type CustomerRow = {
  id: string;
  user_id: string;
  first_name?: string | null;
  last_name?: string | null;
};

type VehicleForm = {
  year: string; // keep as string in UI
  make: string;
  model: string;
  vin: string;
  license_plate: string;
  mileage: string;
  color: string;
};


function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-white/20 focus:ring-1 focus:ring-white/10";
}

function copperButtonStyle(): React.CSSProperties {
  return {
    borderColor: "rgba(197,122,74,0.55)",
    color: "rgba(255,255,255,0.92)",
    background: "rgba(197,122,74,0.10)",
    boxShadow: "inset 0 0 0 1px rgba(197,122,74,0.20)",
  };
}

function copperButtonHoverStyle(): React.CSSProperties {
  return {
    background: "rgba(197,122,74,0.18)",
  };
}

function neutralButtonStyle(): React.CSSProperties {
  return {
    borderColor: "rgba(255,255,255,0.14)",
    background: "rgba(0,0,0,0.35)",
    color: "rgba(255,255,255,0.85)",
  };
}

function dangerButtonStyle(): React.CSSProperties {
  return {
    borderColor: "rgba(248,113,113,0.55)",
    background: "rgba(127,29,29,0.20)",
    color: "rgba(254,226,226,0.92)",
  };
}

export default function PortalVehiclesPage() {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);

  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [vehicles, setVehicles] = useState<VehicleRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [editingId, setEditingId] = useState<string | null>(null);
  const [form, setForm] = useState<VehicleForm>({
    year: "",
    make: "",
    model: "",
    vin: "",
    license_plate: "",
    mileage: "",
    color: "",
  });

  const isEdit = useMemo(() => Boolean(editingId), [editingId]);

  useEffect(() => {
    let mounted = true;

    (async () => {
      setLoading(true);
      setError(null);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (!mounted) return;

      if (userErr || !user) {
        setError("You must be signed in.");
        setLoading(false);
        return;
      }

      const { data: cust, error: custErr } = await supabase
        .from("customers")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();

      if (custErr) setError(custErr.message);

      if (cust) {
        const typed = cust as unknown as CustomerRow;
        setCustomer(typed);

        const { data: v, error: vehErr } = await supabase
          .from("vehicles")
          .select("*")
          .eq("customer_id", typed.id)
          .order("created_at", { ascending: false });

        if (vehErr) setError(vehErr.message);
        setVehicles((v as unknown as VehicleRow[]) ?? []);
      } else {
        setCustomer(null);
        setVehicles([]);
      }

      setLoading(false);
    })();

    return () => {
      mounted = false;
    };
  }, [supabase]);

  const resetForm = () => {
    setEditingId(null);
    setForm({
      year: "",
      make: "",
      model: "",
      vin: "",
      license_plate: "",
      mileage: "",
      color: "",
    });
  };

  const startEdit = (v: VehicleRow) => {
    setEditingId(v.id);
    setForm({
      year: v.year != null ? String(v.year) : "",
      make: v.make ?? "",
      model: v.model ?? "",
      vin: v.vin ?? "",
      license_plate: v.license_plate ?? "",
      mileage: v.mileage ?? "",
      color: v.color ?? "",
    });
    if (typeof window !== "undefined") {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  };

  const toNull = (s: string): string | null => (s.trim() === "" ? null : s.trim());

  const toYear = (s: string): number | null => {
    const n = Number(s);
    if (!Number.isFinite(n)) return null;
    const i = Math.trunc(n);
    return i > 0 ? i : null;
  };

  const onSave = async () => {
    if (!customer?.id) {
      setError("Create your profile first.");
      return;
    }
    setSaving(true);
    setError(null);

    if (!form.make.trim() || !form.model.trim()) {
      setError("Make and model are required.");
      setSaving(false);
      return;
    }

    const payload = {
      customer_id: customer.id,
      year: toYear(form.year),
      make: form.make.trim(),
      model: form.model.trim(),
      vin: toNull(form.vin),
      license_plate: toNull(form.license_plate),
      mileage: toNull(form.mileage),
      color: toNull(form.color),
    };

    if (isEdit && editingId) {
      const { data: updated, error: upErr } = await supabase
        .from("vehicles")
        .update(payload)
        .eq("id", editingId)
        .select()
        .maybeSingle();

      if (upErr) setError(upErr.message);
      if (updated) {
        const u = updated as unknown as VehicleRow;
        setVehicles((prev) => prev.map((x) => (x.id === u.id ? u : x)));
        resetForm();
      }
    } else {
      const { data: inserted, error: insErr } = await supabase
        .from("vehicles")
        .insert(payload)
        .select()
        .maybeSingle();

      if (insErr) setError(insErr.message);
      if (inserted) {
        const i = inserted as unknown as VehicleRow;
        setVehicles((prev) => [i, ...prev]);
        resetForm();
      }
    }

    setSaving(false);
  };

  const onDelete = async (id: string) => {
    if (typeof window !== "undefined" && !window.confirm("Delete this vehicle?")) return;

    const { error: delErr } = await supabase.from("vehicles").delete().eq("id", id);

    if (delErr) {
      setError(delErr.message);
    } else {
      setVehicles((prev) => prev.filter((v) => v.id !== id));
      if (editingId === id) resetForm();
    }
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-3xl">
        <div className={cardClass() + " text-sm text-neutral-200"}>
          Loading your vehicles‚Ä¶
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-3xl space-y-6 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
          My vehicles
        </h1>
        <p className="text-xs text-neutral-400">
          Save your vehicles so booking and service history stays organized.
        </p>
      </header>

      {error && (
        <div className="rounded-2xl border border-red-500/35 bg-red-900/20 px-3 py-2 text-sm text-red-100 backdrop-blur-md shadow-card">
          {error}
        </div>
      )}

      <section className={cardClass() + " space-y-4 sm:p-6"}>
        <div className="flex items-center justify-between gap-2">
          <h2 className="text-sm font-semibold text-neutral-50">
            {isEdit ? "Edit vehicle" : "Add vehicle"}
          </h2>
          {isEdit && (
            <span className="text-xs text-neutral-500">
              Editing <span className="font-mono">{editingId?.slice(0, 8)}‚Ä¶</span>
            </span>
          )}
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <input
            className={inputClass()}
            placeholder="Year"
            value={form.year}
            onChange={(e) => setForm({ ...form, year: e.target.value })}
          />
          <input
            className={inputClass()}
            placeholder="Make *"
            value={form.make}
            onChange={(e) => setForm({ ...form, make: e.target.value })}
          />
          <input
            className={inputClass()}
            placeholder="Model *"
            value={form.model}
            onChange={(e) => setForm({ ...form, model: e.target.value })}
          />
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <input
            className={inputClass()}
            placeholder="VIN"
            value={form.vin}
            onChange={(e) => setForm({ ...form, vin: e.target.value })}
          />
          <input
            className={inputClass()}
            placeholder="License plate"
            value={form.license_plate}
            onChange={(e) => setForm({ ...form, license_plate: e.target.value })}
          />
          <input
            className={inputClass()}
            placeholder="Mileage"
            value={form.mileage}
            onChange={(e) => setForm({ ...form, mileage: e.target.value })}
          />
        </div>

        <input
          className={inputClass()}
          placeholder="Color"
          value={form.color}
          onChange={(e) => setForm({ ...form, color: e.target.value })}
        />

        <div className="flex flex-wrap gap-3">
          <button
            onClick={onSave}
            disabled={saving}
            className="inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-semibold transition disabled:opacity-60"
            style={copperButtonStyle()}
            onMouseEnter={(e) => Object.assign(e.currentTarget.style, copperButtonHoverStyle())}
            onMouseLeave={(e) => Object.assign(e.currentTarget.style, copperButtonStyle())}
          >
            {saving ? "Saving‚Ä¶" : isEdit ? "Save changes" : "Add vehicle"}
          </button>

          {isEdit && (
            <button
              onClick={resetForm}
              disabled={saving}
              className="inline-flex items-center justify-center rounded-lg border px-4 py-2 text-sm font-semibold transition hover:bg-white/5 disabled:opacity-60"
              style={neutralButtonStyle()}
            >
              Cancel
            </button>
          )}
        </div>

        <p className="text-xs text-neutral-500">Fields marked with * are required.</p>
      </section>

      <section className="space-y-3">
        {vehicles.length === 0 ? (
          <div className={cardClass() + " border-dashed text-sm text-neutral-400"}>
            No vehicles yet. Add your first vehicle above so you can book appointments faster and
            see service history.
          </div>
        ) : (
          vehicles.map((v) => {
            const title =
              [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim() ||
              "Vehicle";

            return (
              <div
                key={v.id}
                className="flex flex-col justify-between gap-3 rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card sm:flex-row sm:items-center"
              >
                <div className="min-w-0">
                  <div className="text-sm font-semibold text-neutral-50">{title}</div>
                  <div className="mt-0.5 text-xs text-neutral-400">
                    VIN <span className="font-mono">{v.vin || "‚Äî"}</span> ‚Ä¢ Plate{" "}
                    <span className="font-mono">{v.license_plate || "‚Äî"}</span> ‚Ä¢ Mileage{" "}
                    <span className="font-mono">{v.mileage || "‚Äî"}</span>
                    {v.color && (
                      <>
                        {" "}
                        ‚Ä¢ Color <span className="font-mono">{v.color}</span>
                      </>
                    )}
                  </div>
                </div>

                <div className="flex gap-2">
                  <button
                    className="inline-flex items-center justify-center rounded-lg border px-3 py-2 text-sm font-semibold transition hover:bg-white/5"
                    style={neutralButtonStyle()}
                    onClick={() => startEdit(v)}
                  >
                    Edit
                  </button>
                  <button
                    className="inline-flex items-center justify-center rounded-lg border px-3 py-2 text-sm font-semibold transition hover:bg-red-900/30"
                    style={dangerButtonStyle()}
                    onClick={() => onDelete(v.id)}
                  >
                    Delete
                  </button>
                </div>
              </div>
            );
          })
        )}
      </section>

      <p className="text-[0.75rem] text-neutral-500">
        Tip: keep VIN and plate saved so your shop can match records faster.
      </p>
    </div>
  );
}

========================================
FILE: app/providers.tsx
========================================
"use client";

import { useMemo } from "react";
import { SessionContextProvider } from "@supabase/auth-helpers-react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Session } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

export default function Providers({
  children,
  initialSession,
}: {
  children: React.ReactNode;
  initialSession: Session | null;
}) {
  const supabase = useMemo(() => createClientComponentClient<Database>(), []);
  return (
    <SessionContextProvider supabaseClient={supabase} initialSession={initialSession}>
      {children}
    </SessionContextProvider>
  );
}

========================================
FILE: app/sign-in/page.tsx
========================================
"use client";

import { Suspense } from "react";
import AuthPage from "@/features/auth/components/SignIn";

export default function SignInPage() {
  return (
    <Suspense fallback={<div className="min-h-[60vh] grid place-items-center">Loading‚Ä¶</div>}>
      <AuthPage />
    </Suspense>
  );
}

========================================
FILE: app/signup/page.tsx
========================================
"use client";


// app/signup/page.tsx
import { Suspense } from "react";
import SignUpClient from "@/features/auth/app/signup/SignUpClient";

export default function SignupPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-[60vh] grid place-items-center text-white">
          <div className="text-center">
            <h1 className="text-xl font-semibold">Loading sign-up‚Ä¶</h1>
            <p className="text-sm text-neutral-400">One moment.</p>
          </div>
        </div>
      }
    >
      <SignUpClient />
    </Suspense>
  );
}

========================================
FILE: app/tech/performance/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import type { TimeRange } from "@shared/lib/stats/getShopStats";
import {
  getTechLeaderboard,
  type TechLeaderboardRow,
} from "@shared/lib/stats/getTechLeaderboard";
import { formatCurrency } from "@shared/lib/formatters";
import { Button } from "@shared/components/ui/Button";
import PageShell from "@/features/shared/components/PageShell";

type DB = Database;
type Range = TimeRange;
type ProfileRow = DB["public"]["Tables"]["profiles"]["Row"];

const RANGE_LABELS: Record<Range, string> = {
  weekly: "Last 7 days",
  monthly: "Last 30 days",
  quarterly: "Last 90 days",
  yearly: "Last 12 months",
};

type Badge =
  | { label: "Gold"; emoji: "ü•á"; description: string }
  | { label: "Silver"; emoji: "ü•à"; description: string }
  | { label: "Bronze"; emoji: "ü•â"; description: string }
  | { label: "Building"; emoji: "‚öôÔ∏è"; description: string };

function badgeForEfficiency(efficiencyPct: number): Badge {
  if (efficiencyPct >= 180) {
    return {
      label: "Gold",
      emoji: "ü•á",
      description: "Elite efficiency ‚Äì top-tier tech performance.",
    };
  }
  if (efficiencyPct >= 130) {
    return {
      label: "Silver",
      emoji: "ü•à",
      description: "Strong efficiency ‚Äì consistently profitable work.",
    };
  }
  if (efficiencyPct >= 90) {
    return {
      label: "Bronze",
      emoji: "ü•â",
      description: "Solid efficiency ‚Äì good baseline productivity.",
    };
  }
  return {
    label: "Building",
    emoji: "‚öôÔ∏è",
    description: "Room to grow ‚Äì focus on billed vs clocked time.",
  };
}

/* ------------------------------------------------------------------------- */
/* Sparkline                                                                 */
/* ------------------------------------------------------------------------- */

type SparkPoint = {
  label: string;
  value: number;
};

const TREND_RANGES: Range[] = ["weekly", "monthly", "quarterly", "yearly"];

/* ------------------------------------------------------------------------- */
/* Theme tokens (burnt copper / metallic / glass)                            */
/* ------------------------------------------------------------------------- */

const T = {
  border: "border-[color:var(--metal-border-soft,#1f2937)]",
  borderStrong: "border-[color:var(--metal-border,#111827)]",
  copper: "text-[color:var(--accent-copper,#c56a2f)]",
  copperSoft: "text-[color:var(--accent-copper-soft,#e7a36c)]",
  copperBorder: "border-[color:var(--accent-copper-soft,#e7a36c)]/60",
  glass:
    "bg-[linear-gradient(180deg,rgba(255,255,255,0.06),rgba(255,255,255,0.02))] backdrop-blur-md",
  panel:
    "bg-black/45 shadow-[0_18px_40px_rgba(0,0,0,0.85)]",
  panelStrong:
    "bg-black/55 shadow-[0_24px_60px_rgba(0,0,0,0.95)]",
};

export default function TechPerformancePage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [range, setRange] = useState<Range>("monthly");

  const [profile, setProfile] = useState<ProfileRow | null>(null);
  const [shopId, setShopId] = useState<string | null>(null);
  const [techId, setTechId] = useState<string | null>(null);

  const [row, setRow] = useState<TechLeaderboardRow | null>(null);
  const [rank, setRank] = useState<number | null>(null);
  const [totalTechs, setTotalTechs] = useState<number | null>(null);

  const [shopAverage, setShopAverage] = useState<TechLeaderboardRow | null>(
    null,
  );

  const [trendPoints, setTrendPoints] = useState<SparkPoint[] | null>(null);
  const [trendLoading, setTrendLoading] = useState(false);

  const [start, setStart] = useState<string | null>(null);
  const [end, setEnd] = useState<string | null>(null);

  const [loadingProfile, setLoadingProfile] = useState(false);
  const [loadingStats, setLoadingStats] = useState(false);
  const [error, setError] = useState<string | null>(null);

  /* ---------------------------------------------------------------------- */
  /* Load current tech profile + shop                                       */
  /* ---------------------------------------------------------------------- */

  useEffect(() => {
    (async () => {
      setLoadingProfile(true);
      setError(null);
      try {
        const {
          data: { user },
          error: userErr,
        } = await supabase.auth.getUser();

        if (userErr || !user) {
          setError("You must be signed in to view your performance.");
          return;
        }

        const { data: prof, error: profErr } = await supabase
          .from("profiles")
          .select("*")
          .eq("id", user.id)
          .maybeSingle<ProfileRow>();

        if (profErr) {
          setError(profErr.message);
          return;
        }

        if (!prof) {
          setError("Profile not found for your account.");
          return;
        }

        if (!prof.shop_id) {
          setError("No shop linked to your profile yet.");
          return;
        }

        setProfile(prof);
        setShopId(prof.shop_id);
        setTechId(prof.id);
      } catch (e) {
        const msg = e instanceof Error ? e.message : "Failed to load your profile.";
        setError(msg);
      } finally {
        setLoadingProfile(false);
      }
    })();
  }, [supabase]);

  /* ---------------------------------------------------------------------- */
  /* Load leaderboard row for this tech + shop average                      */
  /* ---------------------------------------------------------------------- */

  useEffect(() => {
    if (!shopId || !techId) return;

    (async () => {
      setLoadingStats(true);
      setError(null);
      try {
        const result = await getTechLeaderboard(shopId, range);

        setStart(result.start);
        setEnd(result.end);

        const allRows = result.rows ?? [];
        setTotalTechs(allRows.length);

        const idx = allRows.findIndex((r) => r.techId === techId);
        if (idx === -1) {
          setRow({
            techId,
            name: profile?.full_name || "Your performance",
            role: profile?.role ?? null,
            jobs: 0,
            revenue: 0,
            laborCost: 0,
            profit: 0,
            billedHours: 0,
            clockedHours: 0,
            revenuePerHour: 0,
            efficiencyPct: 0,
          });
          setRank(null);
        } else {
          setRow(allRows[idx]);
          setRank(idx + 1);
        }

        if (allRows.length > 0) {
          setShopAverage(averageRow(allRows));
        } else {
          setShopAverage(null);
        }
      } catch (e) {
        const msg = e instanceof Error ? e.message : "Failed to load tech stats.";
        setError(msg);
        setRow(null);
        setRank(null);
        setTotalTechs(null);
        setShopAverage(null);
      } finally {
        setLoadingStats(false);
      }
    })();
  }, [shopId, techId, profile?.full_name, profile?.role, range]);

  /* ---------------------------------------------------------------------- */
  /* Efficiency trend sparkline                                             */
  /* ---------------------------------------------------------------------- */

  useEffect(() => {
    if (!shopId || !techId) return;

    (async () => {
      setTrendLoading(true);
      try {
        const results = await Promise.all(TREND_RANGES.map((r) => getTechLeaderboard(shopId, r)));

        const points: SparkPoint[] = results.map((result, idx) => {
          const rows = result.rows ?? [];
          const my = rows.find((r) => r.techId === techId) ?? null;
          return {
            label: TREND_RANGES[idx][0].toUpperCase(),
            value: my ? my.efficiencyPct : 0,
          };
        });

        setTrendPoints(points);
      } catch (e) {
        // eslint-disable-next-line no-console
        console.error("[TechPerformance] trend load failed", e);
        setTrendPoints(null);
      } finally {
        setTrendLoading(false);
      }
    })();
  }, [shopId, techId]);

  const dateRangeLabel =
    start && end
      ? `${new Date(start).toLocaleDateString()} ‚Äì ${new Date(end).toLocaleDateString()}`
      : RANGE_LABELS[range];

  const name = profile?.full_name || "Your performance";
  const roleLabel = profile?.role ?? "mechanic";

  const hasData = !!row;
  const badge = badgeForEfficiency(row?.efficiencyPct ?? 0);

  const efficiencyDelta =
    row && shopAverage ? row.efficiencyPct - shopAverage.efficiencyPct : null;

  return (
    <PageShell
      title="Tech Performance"
      description="Your jobs, hours and efficiency for this shop and time range."
    >
      <div className="mx-auto max-w-5xl space-y-6 text-foreground">
        {/* Range + meta controls ------------------------------------------------ */}
        <div
          className={[
            "flex flex-wrap items-center gap-3 rounded-2xl border px-4 py-3",
            T.border,
            T.panel,
            T.glass,
          ].join(" ")}
        >
          <div className="space-y-1">
            <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
              Time range
            </div>

            <div className="flex flex-wrap gap-2">
              {(["weekly", "monthly", "quarterly", "yearly"] as Range[]).map((r) => {
                const isActive = range === r;
                return (
                  <Button
                    key={r}
                    type="button"
                    size="sm"
                    variant={isActive ? "default" : "outline"}
                    className={
                      isActive
                        ? [
                            "text-black",
                            "border-[color:var(--accent-copper,#c56a2f)]",
                            "bg-[color:var(--accent-copper,#c56a2f)]",
                            "shadow-[0_0_22px_rgba(197,106,47,0.35)]",
                          ].join(" ")
                        : [
                            "text-xs",
                            T.border,
                            "bg-black/25",
                            "hover:bg-black/35",
                          ].join(" ")
                    }
                    onClick={() => setRange(r)}
                  >
                    {r.charAt(0).toUpperCase() + r.slice(1)}
                  </Button>
                );
              })}
            </div>

            <div className="text-[0.7rem] text-neutral-400">{dateRangeLabel}</div>
          </div>

          <div className="ml-auto flex flex-col items-end gap-1 text-right text-[0.7rem] text-neutral-400">
            {rank && totalTechs ? (
              <div>
                <span className={`font-semibold ${T.copperSoft}`}>Rank {rank}</span>{" "}
                <span className="text-neutral-400">
                  of {totalTechs} tech{totalTechs > 1 ? "s" : ""}
                </span>
              </div>
            ) : (
              <div className="text-neutral-500">No ranked data yet for this range.</div>
            )}
            <div className="text-neutral-500">Role: {roleLabel}</div>
          </div>
        </div>

        {/* Error / loading ------------------------------------------------------ */}
        {error && (
          <div className="rounded-xl border border-red-500/30 bg-red-950/35 px-4 py-3 text-sm text-red-100">
            {error}
          </div>
        )}

        {(loadingProfile || loadingStats) && (
          <div className={["rounded-2xl border px-4 py-6 text-sm text-neutral-400", T.border, T.panel, T.glass].join(" ")}>
            Loading your performance‚Ä¶
          </div>
        )}

        {/* Main content --------------------------------------------------------- */}
        {!loadingProfile && !loadingStats && hasData && row && (
          <>
            {/* Hero card */}
            <section className="grid gap-4 md:grid-cols-[2fr,1.3fr]">
              <div
                className={[
                  "rounded-2xl border px-5 py-4 text-white",
                  T.border,
                  T.panelStrong,
                  "bg-[radial-gradient(1200px_600px_at_25%_0%,rgba(197,106,47,0.12),transparent_55%),linear-gradient(180deg,rgba(0,0,0,0.65),rgba(0,0,0,0.45))]",
                  "backdrop-blur-md",
                ].join(" ")}
              >
                <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                  <div>
                    <div className="text-[0.7rem] uppercase tracking-[0.25em] text-neutral-500">
                      ProFixIQ Tech Suite
                    </div>
                    <h1 className="mt-1 text-2xl font-semibold leading-tight">
                      <span className="text-neutral-100">Welcome back, </span>
                      <span className={T.copper}>{name}</span>
                    </h1>
                    <p className="mt-2 text-sm text-neutral-300">
                      This panel is your personal scoreboard ‚Äì revenue, hours and
                      efficiency for the selected range.
                    </p>
                  </div>

                  <div className="mt-2 flex flex-col items-end gap-2 md:mt-0">
                    <span className="text-[0.65rem] uppercase tracking-[0.22em] text-neutral-400">
                      Efficiency badge
                    </span>
                    <div
                      className={[
                        "inline-flex items-center gap-2 rounded-full border bg-black/40 px-3 py-1.5 text-xs",
                        T.copperBorder,
                        "shadow-[0_0_24px_rgba(197,106,47,0.35)]",
                        "backdrop-blur-md",
                      ].join(" ")}
                    >
                      <span className="text-lg">{badge.emoji}</span>
                      <div className="flex flex-col">
                        <span className={["text-[0.7rem] font-semibold uppercase tracking-[0.18em]", T.copperSoft].join(" ")}>
                          {badge.label} ‚Ä¢ {row.efficiencyPct.toFixed(1)}%
                        </span>
                        <span className="text-[0.7rem] text-neutral-300">
                          {badge.description}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Quick links */}
              <div className="space-y-3">
                <QuickLinkCard
                  title="My jobs"
                  body="Open your active work and track time punches."
                  href="/tech/queue"
                  cta="Open tech queue"
                />
                <QuickLinkCard
                  title="Shop reports"
                  body="View owner dashboards for full shop performance."
                  href="/dashboard/owner/reports"
                  cta="Open reports"
                />
              </div>
            </section>

            {/* Stat cards */}
            <section className="grid gap-4 md:grid-cols-3">
              <StatCard
                label="Revenue"
                value={formatCurrency(row.revenue)}
                helper="Total invoiced for jobs you were the tech on."
                accent="money"
              />
              <StatCard
                label="Profit after labor"
                value={formatCurrency(row.profit)}
                helper="Revenue minus labor cost recorded on invoices."
                accent="profit"
              />
              <StatCard
                label="Jobs completed"
                value={row.jobs.toString()}
                helper="Invoices counted in this time range."
              />
              <StatCard
                label="Clocked hours"
                value={row.clockedHours.toFixed(1) + " h"}
                helper="From your payroll timecards in this range."
              />
              <StatCard
                label="Revenue per hour"
                value={formatCurrency(row.revenuePerHour) + "/h"}
                helper="Revenue divided by clocked hours."
              />
              <StatCard
                label="Labor cost"
                value={formatCurrency(row.laborCost)}
                helper="Labor cost on invoices for your jobs."
              />
            </section>

            {/* Shop average comparison */}
            {shopAverage && (
              <section
                className={[
                  "space-y-2 rounded-2xl border px-4 py-3",
                  T.border,
                  T.panel,
                  T.glass,
                ].join(" ")}
              >
                <div className="flex items-center justify-between gap-2">
                  <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
                    Shop average (this range)
                  </div>
                  {efficiencyDelta !== null && (
                    <div className="text-[0.7rem] text-neutral-300">
                      You are{" "}
                      <span className={efficiencyDelta >= 0 ? "text-emerald-300" : "text-red-300"}>
                        {efficiencyDelta >= 0 ? "+" : ""}
                        {efficiencyDelta.toFixed(1)} pts
                      </span>{" "}
                      {efficiencyDelta >= 0 ? "above" : "below"} shop efficiency.
                    </div>
                  )}
                </div>

                <div className="grid grid-cols-2 gap-x-6 gap-y-1 text-[0.75rem] text-neutral-300">
                  <Row label="Jobs" value={shopAverage.jobs.toFixed(1)} />
                  <Row label="Revenue" value={formatCurrency(shopAverage.revenue)} />
                  <Row label="Clocked hours" value={`${shopAverage.clockedHours.toFixed(1)} h`} />
                  <Row label="Billed hours" value={`${shopAverage.billedHours.toFixed(1)} h`} />
                  <Row label="Rev / hour" value={formatCurrency(shopAverage.revenuePerHour)} />
                  <Row label="Efficiency" value={`${shopAverage.efficiencyPct.toFixed(1)}%`} />
                </div>
              </section>
            )}

            {/* Efficiency trend sparkline */}
            {trendPoints && trendPoints.length > 0 && (
              <section
                className={[
                  "space-y-2 rounded-2xl border px-4 py-3",
                  T.border,
                  "bg-black/40",
                  T.glass,
                ].join(" ")}
              >
                <div className="flex items-center justify-between">
                  <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
                    Efficiency trend
                  </div>
                  <div className="text-[0.7rem] text-neutral-500">
                    Weekly ‚Üí Monthly ‚Üí Quarterly ‚Üí Yearly
                  </div>
                </div>
                <Sparkline points={trendPoints} loading={trendLoading} />
              </section>
            )}

            {/* Ratio strip */}
            <section
              className={[
                "rounded-2xl border px-4 py-4 text-sm text-neutral-100",
                T.border,
                "bg-[linear-gradient(90deg,rgba(0,0,0,0.55),rgba(20,20,20,0.45),rgba(0,0,0,0.55))]",
                "shadow-[0_18px_40px_rgba(0,0,0,0.85)]",
                "backdrop-blur-md",
              ].join(" ")}
            >
              <div className="flex flex-wrap items-center justify-between gap-3">
                <div>
                  <div className="text-[0.7rem] uppercase tracking-[0.2em] text-neutral-400">
                    Snapshot
                  </div>
                  <p className="mt-1 text-[0.8rem] text-neutral-300">
                    You&apos;re generating{" "}
                    <span className={["font-semibold", T.copperSoft].join(" ")}>
                      {formatCurrency(row.revenuePerHour)}/h
                    </span>{" "}
                    from{" "}
                    <span className="font-semibold">{row.clockedHours.toFixed(1)} clocked hours</span>{" "}
                    and{" "}
                    <span className="font-semibold">
                      {row.jobs} job{row.jobs === 1 ? "" : "s"}
                    </span>{" "}
                    in this range.
                  </p>
                </div>
                <div className="flex flex-col items-end text-right text-[0.75rem] text-neutral-300">
                  <span>
                    Revenue / labor:{" "}
                    <span className="font-semibold text-emerald-300">
                      {row.laborCost > 0 ? (row.revenue / row.laborCost).toFixed(1) + "√ó" : "‚Äì"}
                    </span>
                  </span>
                  <span className="text-neutral-500">Target: 2.5√ó+ over time.</span>
                </div>
              </div>
            </section>
          </>
        )}

        {!loadingProfile && !loadingStats && !hasData && !error && (
          <div className={["rounded-2xl border px-4 py-6 text-sm text-neutral-400", T.border, T.panel, T.glass].join(" ")}>
            No technician data found for this range yet. Once you have invoices
            and timecards in this period, your performance view will populate
            automatically.
          </div>
        )}
      </div>
    </PageShell>
  );
}

/* ------------------------------------------------------------------------- */
/* Helpers & subcomponents                                                   */
/* ------------------------------------------------------------------------- */

function averageRow(rows: TechLeaderboardRow[]): TechLeaderboardRow {
  if (rows.length === 0) {
    return {
      techId: "shop-avg",
      name: "Shop average",
      role: null,
      jobs: 0,
      revenue: 0,
      laborCost: 0,
      profit: 0,
      billedHours: 0,
      clockedHours: 0,
      revenuePerHour: 0,
      efficiencyPct: 0,
    };
  }

  const sum = rows.reduce(
    (acc, r) => {
      acc.jobs += r.jobs;
      acc.revenue += r.revenue;
      acc.laborCost += r.laborCost;
      acc.profit += r.profit;
      acc.billedHours += r.billedHours;
      acc.clockedHours += r.clockedHours;
      acc.revenuePerHour += r.revenuePerHour;
      acc.efficiencyPct += r.efficiencyPct;
      return acc;
    },
    {
      techId: "sum",
      name: "sum",
      role: null as string | null,
      jobs: 0,
      revenue: 0,
      laborCost: 0,
      profit: 0,
      billedHours: 0,
      clockedHours: 0,
      revenuePerHour: 0,
      efficiencyPct: 0,
    },
  );

  const n = rows.length;

  return {
    techId: "shop-avg",
    name: "Shop average",
    role: null,
    jobs: sum.jobs / n,
    revenue: sum.revenue / n,
    laborCost: sum.laborCost / n,
    profit: sum.profit / n,
    billedHours: sum.billedHours / n,
    clockedHours: sum.clockedHours / n,
    revenuePerHour: sum.revenuePerHour / n,
    efficiencyPct: sum.efficiencyPct / n,
  };
}

function StatCard({
  label,
  value,
  helper,
  accent,
}: {
  label: string;
  value: string;
  helper?: string;
  accent?: "money" | "profit";
}) {
  let accentClass = "text-neutral-100";
  if (accent === "money") accentClass = "text-emerald-300";
  if (accent === "profit") accentClass = "text-[color:var(--accent-copper-soft,#e7a36c)]";

  return (
    <div
      className={[
        "rounded-2xl border px-4 py-3",
        "bg-black/40 backdrop-blur-md",
        "shadow-[0_18px_40px_rgba(0,0,0,0.8)]",
        "border-[color:var(--metal-border-soft,#1f2937)]",
      ].join(" ")}
    >
      <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
        {label}
      </div>
      <div className={`mt-1 text-xl font-semibold ${accentClass}`}>{value}</div>
      {helper ? (
        <p className="mt-1 text-[0.75rem] text-neutral-500">{helper}</p>
      ) : null}
    </div>
  );
}

function QuickLinkCard({
  title,
  body,
  href,
  cta,
}: {
  title: string;
  body: string;
  href: string;
  cta: string;
}) {
  return (
    <a
      href={href}
      className={[
        "block rounded-2xl border px-4 py-3 text-sm text-neutral-100 transition",
        "border-[color:var(--metal-border-soft,#1f2937)]",
        "bg-black/40 backdrop-blur-md",
        "shadow-[0_14px_30px_rgba(0,0,0,0.75)]",
        "hover:bg-black/55",
        "hover:border-[color:var(--accent-copper-soft,#e7a36c)]/60",
      ].join(" ")}
    >
      <div className="flex items-center justify-between gap-3">
        <div>
          <div className="text-[0.65rem] uppercase tracking-[0.18em] text-neutral-400">
            {title}
          </div>
          <div className="mt-1 text-xs text-neutral-200">{body}</div>
        </div>
        <span className="text-[0.75rem] text-[color:var(--accent-copper-soft,#e7a36c)]">
          {cta} ‚Üí
        </span>
      </div>
    </a>
  );
}

function Row({ label, value }: { label: string; value: string }) {
  return (
    <>
      <div className="text-neutral-400">{label}</div>
      <div className="text-right text-neutral-100">{value}</div>
    </>
  );
}

function Sparkline({
  points,
  loading,
}: {
  points: SparkPoint[];
  loading?: boolean;
}) {
  if (loading) {
    return (
      <div className="h-10 w-full animate-pulse rounded-md bg-gradient-to-r from-slate-700/30 to-slate-900/60" />
    );
  }

  if (!points.length) {
    return <div className="text-[0.7rem] text-neutral-500">Not enough data to show a trend yet.</div>;
  }

  const values = points.map((p) => p.value);
  const max = Math.max(...values, 0);
  const min = Math.min(...values, 0);
  const span = max - min || 1;

  const coords = values.map((v, idx) => {
    const x = points.length === 1 ? 50 : (idx / (points.length - 1)) * 100;
    const y = 100 - ((v - min) / span) * 100;
    return { x, y };
  });

  const pathD = coords
    .map((p, idx) => `${idx === 0 ? "M" : "L"} ${p.x},${p.y}`)
    .join(" ");

  return (
    <div className="space-y-1">
      <svg
        viewBox="0 0 100 100"
        className="h-10 w-full text-[color:var(--accent-copper-soft,#e7a36c)]"
        preserveAspectRatio="none"
      >
        <path
          d={pathD}
          fill="none"
          stroke="currentColor"
          strokeWidth={2}
          strokeLinecap="round"
          strokeLinejoin="round"
        />
      </svg>
      <div className="flex justify-between text-[0.6rem] text-neutral-500">
        {points.map((p) => (
          <span key={p.label}>{p.label}</span>
        ))}
      </div>
    </div>
  );
}

========================================
FILE: app/tech/queue/page.tsx
========================================
// app/tech/queue/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Line = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Profile = DB["public"]["Tables"]["profiles"]["Row"];

type RollupStatus = "awaiting" | "in_progress" | "on_hold" | "completed";

const STATUS_LABELS: Record<RollupStatus, string> = {
  awaiting: "Awaiting",
  in_progress: "In progress",
  on_hold: "On hold",
  completed: "Completed",
};

// match the styling from your working queue page
const STATUS_STYLES: Record<RollupStatus, string> = {
  awaiting:
    "border-slate-700 bg-neutral-900/80 hover:border-orange-400 data-[active=true]:border-green-500 data-[active=true]:bg-green-500/10",
  in_progress:
    "border-amber-700 bg-neutral-900/80 hover:border-orange-400 data-[active=true]:border-green-500 data-[active=true]:bg-green-500/10",
  on_hold:
    "border-purple-700 bg-neutral-900/80 hover:border-orange-400 data-[active=true]:border-green-500 data-[active=true]:bg-green-500/10",
  completed:
    "border-emerald-700 bg-neutral-900/80 hover:border-orange-400 data-[active=true]:border-green-500 data-[active=true]:bg-green-500/10",
};

function toBucket(status: string | null | undefined): RollupStatus {
  const s = (status ?? "").toLowerCase();
  if (s === "in_progress") return "in_progress";
  if (s === "on_hold") return "on_hold";
  if (s === "completed") return "completed";
  return "awaiting";
}

export default function TechQueuePage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();

  const [userId, setUserId] = useState<string | null>(null);
  const [profile, setProfile] = useState<Profile | null>(null);

  // just the lines assigned to this tech
  const [lines, setLines] = useState<Line[]>([]);
  // we also want the WOs so we can link to them nicely
  const [workOrderMap, setWorkOrderMap] = useState<Record<string, { id: string; custom_id: string | null }>>(
    {},
  );

  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);
  const [activeFilter, setActiveFilter] = useState<RollupStatus | null>(null);

  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);

      // 1) auth
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();
      if (userErr || !user) {
        setErr("You must be signed in.");
        setLoading(false);
        return;
      }
      setUserId(user.id);

      // 2) profile
      const { data: prof, error: profErr } = await supabase
        .from("profiles")
        .select("*")
        .eq("id", user.id)
        .maybeSingle();

      if (profErr) {
        setErr(profErr.message);
        setLoading(false);
        return;
      }
      if (!prof?.shop_id) {
        setErr("No shop linked to your profile yet.");
        setLoading(false);
        return;
      }
      setProfile(prof);

      // 3) fetch work-order lines for this shop AND assigned to me
      //    (we could also filter by last 30 days, but for tech lines this is probably ok)
      const { data: techLines, error: linesErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("assigned_to", user.id)
        .order("created_at", { ascending: false });

      if (linesErr) {
        setErr(linesErr.message);
        setLoading(false);
        return;
      }

      const assignedLines = techLines ?? [];
      setLines(assignedLines);

      // 4) fetch the work_order rows for those line IDs (to show custom_id)
      const woIds = Array.from(
        new Set(
          assignedLines
            .map((l) => l.work_order_id)
            .filter((id): id is string => Boolean(id)),
        ),
      );

      if (woIds.length > 0) {
        const { data: wos } = await supabase
          .from("work_orders")
          .select("id, custom_id")
          .in("id", woIds);

        const map: Record<string, { id: string; custom_id: string | null }> = {};
        (wos ?? []).forEach((wo) => {
          map[wo.id] = { id: wo.id, custom_id: wo.custom_id };
        });
        setWorkOrderMap(map);
      } else {
        setWorkOrderMap({});
      }

      setLoading(false);
    })();
  }, [supabase]);

  // counts per bucket
  const counts = useMemo(() => {
    const base: Record<RollupStatus, number> = {
      awaiting: 0,
      in_progress: 0,
      on_hold: 0,
      completed: 0,
    };
    for (const line of lines) {
      base[toBucket(line.status)] += 1;
    }
    return base;
  }, [lines]);

  // filtered list
  const filteredLines = useMemo(() => {
    if (activeFilter == null) return lines;
    return lines.filter((l) => toBucket(l.status) === activeFilter);
  }, [lines, activeFilter]);

  if (loading) {
    return <div className="p-6 text-white">Loading assigned jobs‚Ä¶</div>;
  }

  if (err) {
    return <div className="p-6 text-red-200">{err}</div>;
  }

  return (
    <div className="p-6 text-white">
      <h1 className="mb-4 text-2xl font-blackops text-orange-400">
        Your Assigned Jobs
      </h1>

      {/* DEBUG header like other page */}
      <div className="mb-4 rounded border border-neutral-800 bg-neutral-900 p-3 text-sm">
        <div className="mb-1 font-semibold text-orange-400">Debug</div>
        <div className="grid gap-2 sm:grid-cols-2">
          <div className="space-y-1">
            <div>
              <span className="text-neutral-400">User:</span> {userId}
            </div>
            <div>
              <span className="text-neutral-400">Role:</span>{" "}
              {profile?.role ?? "‚Äî"}
            </div>
            <div>
              <span className="text-neutral-400">Shop:</span>{" "}
              {profile?.shop_id ?? "‚Äî"}
            </div>
          </div>
          <div className="space-y-1">
            <div>
              <span className="text-neutral-400">Assigned lines:</span>{" "}
              {lines.length}
            </div>
          </div>
        </div>
      </div>

      {/* FILTER BUTTONS (no routing) */}
      <div className="mb-6 grid gap-3 md:grid-cols-4">
        {(["awaiting", "in_progress", "on_hold", "completed"] as RollupStatus[]).map(
          (s) => {
            const isActive = activeFilter === s;
            return (
              <button
                key={s}
                type="button"
                onClick={() => setActiveFilter(isActive ? null : s)}
                className={`rounded p-3 text-left transition ${STATUS_STYLES[s]}`}
                data-active={isActive ? "true" : "false"}
              >
                <div className="text-xs uppercase tracking-wide text-neutral-400">
                  {STATUS_LABELS[s]}
                </div>
                <div className="mt-1 text-2xl font-semibold">{counts[s]}</div>
                {isActive && (
                  <div className="mt-1 text-[10px] text-orange-200">
                    Showing {STATUS_LABELS[s].toLowerCase()}
                  </div>
                )}
              </button>
            );
          },
        )}
      </div>

      {/* LIST OF LINES */}
      <div className="space-y-2">
        {filteredLines.map((line) => {
          const bucket = toBucket(line.status);
          const wo = line.work_order_id
            ? workOrderMap[line.work_order_id]
            : null;
          const slug = wo?.custom_id ?? wo?.id ?? line.work_order_id ?? "";

          return (
            <div
              key={line.id}
              className="rounded border border-neutral-800 bg-neutral-900 p-3 flex items-center justify-between gap-3"
            >
              <div className="min-w-0">
                <div className="text-sm font-medium truncate">
                  {wo?.custom_id
                    ? wo.custom_id
                    : line.work_order_id
                    ? `WO #${line.work_order_id.slice(0, 8)}`
                    : "Work order line"}
                </div>
                <div className="text-[10px] text-neutral-400">
                  Line #{line.id.slice(0, 8)}
                </div>
              </div>
              <div className="flex items-center gap-2">
                {slug && (
                  <button
                    onClick={() =>
                      router.push(`/work-orders/${slug}?mode=tech`)
                    }
                    className="rounded bg-neutral-800 px-3 py-1 text-xs hover:border-orange-500 border border-transparent"
                  >
                    View
                  </button>
                )}
                <span className="rounded border border-neutral-700 px-2 py-1 text-xs capitalize">
                  {STATUS_LABELS[bucket]}
                </span>
              </div>
            </div>
          );
        })}

        {filteredLines.length === 0 && (
          <div className="rounded border border-neutral-800 bg-neutral-900 p-4 text-sm text-neutral-400">
            No jobs in this bucket.
          </div>
        )}
      </div>

      {/* optional: show one line so we can see missing fields */}
      {lines.length > 0 && (
        <div className="mt-6 rounded border border-neutral-900 bg-neutral-950 p-3 text-xs text-neutral-400 overflow-auto">
          <div className="mb-1 text-neutral-200 font-semibold">
            Debug: first line object
          </div>
          <pre className="whitespace-pre-wrap break-all">
            {JSON.stringify(lines[0], null, 2)}
          </pre>
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/test-inspection/page.tsx
========================================
"use client";

import masterInspectionList from "@inspections/lib/inspection/masterInspectionList";
import InspectionGroupList from "@inspections/components/InspectionGroupList";

export default function TestInspectionPage() {
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold text-white mb-4">
        Inspection Categories
      </h1>
      <InspectionGroupList categories={masterInspectionList} />
    </div>
  );
}


========================================
FILE: app/thank-you/page.tsx
========================================
"use client";

import Link from "next/link";

export default function ThankYouPage() {
  return (
    <div className="p-6 text-center">
      <h1 className="text-2xl font-bold text-green-600 mb-4">
        ‚úÖ Booking Confirmed
      </h1>
      <p className="mb-6 text-gray-700">
        Your appointment request has been submitted successfully.
      </p>
      <Link href="/" className="bg-accent text-white px-4 py-2 rounded shadow">
        Return to Home
      </Link>
    </div>
  );
}


========================================
FILE: app/vehicle/VinCaptureModal.tsx
========================================
"use client";

import { 
  useCallback,
  useEffect,
  useMemo,
  useRef,
  useState,
} from "react";
import { useRouter } from "next/navigation";

import ModalShell from "@/features/shared/components/ModalShell";
import VinCaptureModalContent from "@/features/vehicles/components/VinCaptureModal";
import { decodeVin } from "@/features/shared/lib/vin/decodeVin";
import { useWorkOrderDraft } from "app/work-orders/state/useWorkOrderDraft";

// Optional: tame TS around experimental BarcodeDetector
declare global {
  interface Window {
    BarcodeDetector?: new (opts?: { formats?: string[] }) => {
      detect: (source: CanvasImageSource) => Promise<Array<{ rawValue?: string }>>;
    };
  }
}

export type VinDecodedDetail = {
  vin: string;
  year: string | null;
  make: string | null;
  model: string | null;
  trim: string | null;
  engine?: string | null;

  // extra fields from /api/vin
  engineDisplacementL?: string | null;
  engineCylinders?: string | null;
  fuelType?: string | null;
  transmission?: string | null;
  driveType?: string | null;
  bodyClass?: string | null;
};

type Props = {
  userId: string;
  onDecoded?: (data: VinDecodedDetail) => void;
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
  children?: React.ReactNode;
  /** server route that upserts (defaults to /api/vin) */
  action?: string;
  triggerClassName?: string;
};

type DecodeVinResponse = Awaited<ReturnType<typeof decodeVin>>;

type DecodeVinResponseExtended = DecodeVinResponse & {
  engineDisplacementL?: string | null;
  engineCylinders?: string | null;
  fuelType?: string | null;
  transmission?: string | null;
  driveType?: string | null;
  bodyClass?: string | null;
};

function isLikelyVin(s: string) {
  const vin = s.replace(/[^A-Z0-9]/gi, "").toUpperCase();
  return vin.length === 17 && !/[IOQ]/.test(vin);
}

/** Scanner pane used in scanSlot */
function ScannerPane({
  onFoundVin,
  isBusy,
}: {
  userId: string;
  onFoundVin: (vin: string) => void;
  isBusy: boolean;
}) {
  const videoRef = useRef<HTMLVideoElement | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [active, setActive] = useState(false);
  const lockedRef = useRef(false);

  useEffect(() => {
    let stream: MediaStream | null = null;
    let raf = 0;
    let detector:
      | InstanceType<NonNullable<typeof window.BarcodeDetector>>
      | null = null;

    const start = async () => {
      setError(null);
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false,
        });
        if (!videoRef.current) return;
        videoRef.current.srcObject = stream;
        await videoRef.current.play();
        setActive(true);

        if (window.BarcodeDetector) {
          detector = new window.BarcodeDetector({
            formats: ["code_39", "code_128", "pdf417", "data_matrix"],
          });

          const scan = async () => {
            if (!videoRef.current || lockedRef.current) return;
            try {
              const bitmap = await createImageBitmap(videoRef.current);
              const codes = await detector!.detect(bitmap);
              if (codes?.length) {
                for (const c of codes) {
                  const raw = String(c.rawValue ?? "");
                  const cleaned = raw.replace(/[^A-Z0-9]/gi, "").toUpperCase();
                  if (isLikelyVin(cleaned)) {
                    lockedRef.current = true;
                    onFoundVin(cleaned);
                    return;
                  }
                }
              }
            } catch {
              /* ignore transient decode errors */
            }
            raf = requestAnimationFrame(scan);
          };
          raf = requestAnimationFrame(scan);
        } else {
          setError(
            "Live barcode detection not supported in this browser. Use photo upload below.",
          );
        }
      } catch {
        setError("Camera unavailable. Use photo upload below.");
      }
    };

    start();

    return () => {
      cancelAnimationFrame(raf);
      setActive(false);
      try {
        stream?.getTracks()?.forEach((t) => t.stop());
      } catch {
        /* no-op */
      }
    };
  }, [onFoundVin]);

  return (
    <div
      className={`space-y-3 ${
        isBusy ? "ring-2 ring-orange-500 rounded-md animate-pulse" : ""
      }`}
    >
      {isBusy && (
        <div className="flex items-center gap-2 rounded border border-orange-500/60 bg-neutral-950 px-3 py-2">
          <span className="inline-block h-4 w-4 rounded-full border-2 border-orange-500 border-t-transparent animate-spin" />
          <span className="text-xs text-orange-300">
            Decoding VIN‚Ä¶ this can take a moment
          </span>
        </div>
      )}

      <div className="rounded border border-neutral-800 bg-neutral-950 p-2">
        <video
          ref={videoRef}
          className="aspect-video w-full rounded bg-black"
          playsInline
          muted
          autoPlay
        />
      </div>

      {error ? (
        <div className="text-xs text-amber-300">{error}</div>
      ) : (
        <div className="text-xs text-neutral-400">
          {active
            ? "Point the camera at the VIN barcode / label‚Ä¶"
            : "Initializing camera‚Ä¶"}
        </div>
      )}

      {/* Photo upload ‚Üí OCR route */}
      <div className="rounded border border-neutral-800 bg-neutral-950 p-3">
        <div className="mb-2 text-sm text-neutral-200">
          Or upload a photo of the VIN label
        </div>
        <input
          type="file"
          accept="image/*"
          disabled={isBusy}
          className="block w-full text-xs text-neutral-300 file:mr-3 file:rounded file:border-0 file:bg-orange-500 file:px-3 file:py-1.5 file:text-sm file:font-semibold file:text-black hover:file:bg-orange-400 disabled:opacity-60"
          onChange={async (e) => {
            if (isBusy) return;
            const file = e.target.files?.[0];
            if (!file) return;

            try {
              const formData = new FormData();
              formData.append("image", file);

              const res = await fetch("/api/vin/extract-from-image", {
                method: "POST",
                body: formData,
              });

              if (!res.ok) {
                alert("Could not read VIN from image. Please try again.");
                e.target.value = "";
                return;
              }

              const data = (await res.json()) as { vin?: string | null };
              const vin = data?.vin?.toString().toUpperCase() ?? "";
              if (!vin || !isLikelyVin(vin)) {
                alert(
                  "No clear VIN found in the photo. Please retake or type it manually.",
                );
                e.target.value = "";
                return;
              }

              onFoundVin(vin);
            } catch (err) {
              console.error(err);
              alert(
                "Error reading VIN from image. Please try again or enter it manually.",
              );
            } finally {
              e.target.value = "";
            }
          }}
        />
        <div className="mt-2 text-[11px] text-neutral-500">
          Tip: Take a close, well-lit photo of the VIN sticker on the door frame or
          dash.
        </div>
      </div>

      <div className="text-[11px] text-neutral-500">
        We will decode with NHTSA and store it to your account.
      </div>
    </div>
  );
}

export default function VinCaptureModal({
  userId,
  onDecoded,
  open,
  onOpenChange,
  children,
  action = "/api/vin",
  triggerClassName,
}: Props) {
  const [internalOpen, setInternalOpen] = useState(false);
  const [isDecoding, setIsDecoding] = useState(false);

  const isControlled = typeof open === "boolean";
  const isOpen = isControlled ? (open as boolean) : internalOpen;

  const setOpen = useCallback(
    (val: boolean) => {
      if (isControlled) onOpenChange?.(val);
      else setInternalOpen(val);
    },
    [isControlled, onOpenChange],
  );

  const router = useRouter();
  const setVehicleDraft = useWorkOrderDraft((s) => s.setVehicle);

  // Lock body scroll when modal is open
  useEffect(() => {
    if (!isOpen) return;
    const original = document.body.style.overflow;
    document.body.style.overflow = "hidden";
    return () => {
      document.body.style.overflow = original;
    };
  }, [isOpen]);

  // Keep latest onDecoded
  const onDecodedRef = useRef<Props["onDecoded"]>(onDecoded);
  useEffect(() => {
    onDecodedRef.current = onDecoded;
  }, [onDecoded]);

  // Listen for result events (if server form posts and emits later)
  useEffect(() => {
    const handler = (evt: Event) => {
      const ce = evt as CustomEvent<VinDecodedDetail>;
      const detail = ce?.detail;
      if (detail?.vin) {
        onDecodedRef.current?.(detail);
        setOpen(false);
      }
    };
    window.addEventListener("vin:decoded", handler as EventListener);
    return () =>
      window.removeEventListener("vin:decoded", handler as EventListener);
  }, [setOpen]);

  const handleFoundVin = useCallback(
    async (vin: string) => {
      if (isDecoding) return; // prevent double fires
      setIsDecoding(true);
      try {
        const resp = await decodeVin(vin, userId);
        if (resp?.error) {
          alert(resp.error);
          return;
        }

        const extended = resp as DecodeVinResponseExtended;

        // hydrate shared draft
        setVehicleDraft({
          vin,
          year: resp.year ?? null,
          make: resp.make ?? null,
          model: resp.model ?? null,
          trim: resp.trim ?? null,
          engine: resp.engine ?? null,
        });

        const detail: VinDecodedDetail = {
          vin,
          year: resp.year ?? null,
          make: resp.make ?? null,
          model: resp.model ?? null,
          trim: resp.trim ?? null,
          engine: resp.engine ?? null,
          engineDisplacementL: extended.engineDisplacementL ?? null,
          engineCylinders: extended.engineCylinders ?? null,
          fuelType: extended.fuelType ?? null,
          transmission: extended.transmission ?? null,
          driveType: extended.driveType ?? null,
          bodyClass: extended.bodyClass ?? null,
        };

        onDecodedRef.current?.(detail);

        // fire-and-forget recalls fetch
        try {
          void fetch("/api/recalls/fetch", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              vin,
              year: resp.year ?? undefined,
              make: resp.make ?? undefined,
              model: resp.model ?? undefined,
              user_id: userId,
            }),
            keepalive: true,
          });
        } catch {
          /* non-blocking */
        }

        setOpen(false);
        router.push("/work-orders/create?source=vin");
      } finally {
        setIsDecoding(false);
      }
    },
    [userId, setVehicleDraft, router, setOpen, isDecoding],
  );

  const defaultTrigger = useMemo(
    () => (
      <button
        type="button"
        onClick={() => setOpen(true)}
        className={
          triggerClassName ??
          "rounded border border-orange-400 bg-neutral-950 px-3 py-1.5 text-sm font-semibold text-white hover:bg-neutral-900"
        }
        title="Open VIN capture"
      >
        Add by VIN / Scan
      </button>
    ),
    [setOpen, triggerClassName],
  );

  return (
    <>
      {children ? (
        <span
          onClick={() => setOpen(true)}
          role="button"
          style={{ cursor: "pointer" }}
        >
          {children}
        </span>
      ) : (
        defaultTrigger
      )}

      <ModalShell
        isOpen={isOpen}
        onClose={() => setOpen(false)}
        title="Add Vehicle by VIN"
        size="md"
        hideFooter={true}
      >
        <VinCaptureModalContent
          action={action}
          userId={userId}
          scanSlot={
            <ScannerPane
              userId={userId}
              onFoundVin={handleFoundVin}
              isBusy={isDecoding}
            />
          }
        />
      </ModalShell>
    </>
  );
}

========================================
FILE: app/work-orders/approval-webhook/route.ts
========================================
// app/work-orders/approval-webhook/route.ts
import { NextRequest, NextResponse } from "next/server";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Json = Record<string, unknown>;

type Body = {
  workOrderId?: string;
  approvedLineIds?: string[];
  declinedLineIds?: string[];
  declineUnchecked?: boolean;
  approverId?: string | null;    // reserved for later use
  signatureUrl?: string | null;
};

const isString = (v: unknown): v is string => typeof v === "string";
const strArray = (v: unknown): string[] =>
  Array.isArray(v) ? v.filter(isString) : [];

export async function POST(req: NextRequest) {
  const supabase = createRouteHandlerClient<DB>({ cookies });

  // --- read & validate body ---
  let body: Body;
  try {
    body = (await req.json()) as Body;
  } catch {
    return NextResponse.json(
      { error: "Invalid JSON body" } satisfies Json,
      { status: 400 }
    );
  }

  const workOrderId = isString(body.workOrderId) ? body.workOrderId : "";
  const approvedLineIds = strArray(body.approvedLineIds);
  const declinedLineIds = strArray(body.declinedLineIds);
  const declineUnchecked = body.declineUnchecked ?? true;
  const signatureUrl = isString(body.signatureUrl) ? body.signatureUrl : null;

  if (!workOrderId) {
    return NextResponse.json(
      { error: "Missing workOrderId" } satisfies Json,
      { status: 400 }
    );
  }

  try {
    // 1) Mark approved items
    if (approvedLineIds.length > 0) {
      const { error } = await supabase
        .from("work_order_lines")
        .update({ approval_state: "approved" })
        .in("id", approvedLineIds)
        .eq("work_order_id", workOrderId);
      if (error) throw new Error(error.message);
    }

    // 2) Mark declined items (only if asked to decline unchecked)
    if (declineUnchecked && declinedLineIds.length > 0) {
      const { error } = await supabase
        .from("work_order_lines")
        .update({ approval_state: "declined" })
        .in("id", declinedLineIds)
        .eq("work_order_id", workOrderId);
      if (error) throw new Error(error.message);
    }

    // 3) Store signature + approval timestamp on the WO
    //    Also reflect the decision at the WO level so Quote Review hides it
    const { error: woErr } = await supabase
      .from("work_orders")
      .update({
        customer_approval_at: new Date().toISOString(),
        customer_approval_signature_path: signatureUrl,
        // ensure this WO drops out of quote-review and shows in normal flow
        approval_state: "approved",
        status: "queued",
      })
      .eq("id", workOrderId);
    if (woErr) throw new Error(woErr.message);

    return NextResponse.json(
      {
        success: true,
        workOrderId,
        approvedLineIds,
        declinedLineIds,
      } satisfies Json,
      { status: 200 }
    );
  } catch (e) {
    const msg = e instanceof Error ? e.message : "Internal error";
    return NextResponse.json({ error: msg } satisfies Json, { status: 500 });
  }
}

========================================
FILE: app/work-orders/components/WorkOrderPreviewTrigger.tsx
========================================
"use client";

import { useEffect, useRef, type ReactNode } from "react";

type Props = {
  open: boolean;
  onOpenChange?: (open: boolean) => void;
  children: ReactNode; // preview content
};

export function WorkOrderPreviewTrigger({ open, onOpenChange, children }: Props) {
  const dialogRef = useRef<HTMLDialogElement | null>(null);

  useEffect(() => {
    const dlg = dialogRef.current;
    if (!dlg) return;
    if (open && !dlg.open) { try { dlg.showModal(); } catch {} }
    else if (!open && dlg.open) { dlg.close(); }
  }, [open]);

  useEffect(() => {
    const dlg = dialogRef.current;
    if (!dlg) return;
    const onClick = (e: MouseEvent) => {
      const rect = dlg.getBoundingClientRect();
      const inside =
        e.clientX >= rect.left && e.clientX <= rect.right &&
        e.clientY >= rect.top && e.clientY <= rect.bottom;
      if (!inside) onOpenChange?.(false);
    };
    dlg.addEventListener("click", onClick);
    return () => dlg.removeEventListener("click", onClick);
  }, [onOpenChange]);

  return (
    <dialog
      ref={dialogRef}
      onClose={() => onOpenChange?.(false)}
      className="backdrop:bg-black/60 rounded-lg border shadow-xl"
      style={{
        borderColor: "#f97316",        // orange border
        backgroundColor: "#0a0a0a",    // neutral-950
        maxWidth: "48rem",
        width: "calc(100% - 2rem)",
        margin: "auto",
      }}
    >
      <div className="p-5 border-b" style={{ borderColor: "rgb(38 38 38)" }}>
        <h2 className="text-2xl text-orange-400" style={{ fontFamily: "'Black Ops One', system-ui, sans-serif" }}>
          Work Order Preview
        </h2>
      </div>

      <div className="p-5 overflow-y-auto max-h-[70vh]" style={{ fontFamily: "'Roboto', system-ui, sans-serif" }}>
        {children}
      </div>

      <div className="p-4 border-t flex justify-end" style={{ borderColor: "rgb(38 38 38)" }}>
        <button
          onClick={() => onOpenChange?.(false)}
          className="px-3 py-2 text-sm font-semibold rounded border"
          style={{
            borderColor: "#f97316",
            backgroundColor: "#ea580c",
            color: "white",
            fontFamily: "'Black Ops One', system-ui, sans-serif",
          }}
        >
          Close
        </button>
      </div>
    </dialog>
  );
}

========================================
FILE: app/work-orders/components/WorkOrderPreview.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database, Tables } from "@shared/types/types/supabase";

type Props = { woId: string | null };

type WO = Pick<
  Tables<"work_orders">,
  | "id" | "status" | "type" | "created_at" | "updated_at" | "notes"
  | "customer_id" | "vehicle_id"
  | "invoice_total" | "labor_total" | "parts_total"
  | "quote_url" | "invoice_url"
>;

type Customer = Pick<Tables<"customers">, "name" | "email" | "phone" | "first_name" | "last_name">;
type Vehicle  = Pick<Tables<"vehicles">, "year" | "make" | "model" | "license_plate" | "vin" | "color" | "mileage" | "unit_number">;

type WOLine = Pick<
  Tables<"work_order_lines">,
  | "id" | "description" | "job_type" | "labor_time" | "notes"
  | "complaint" | "cause" | "correction" | "status"
  | "created_at" | "updated_at"
>;

export function WorkOrderPreview({ woId }: Props) {
  const supabase = createClientComponentClient<Database>();
  const [wo, setWO] = useState<WO | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);
  const [vehicle, setVehicle] = useState<Vehicle | null>(null);
  const [lines, setLines] = useState<WOLine[]>([]);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(true);

  useEffect(() => {
    let active = true;
    async function load() {
      if (!woId) {
        setWO(null);
        setCustomer(null);
        setVehicle(null);
        setLines([]);
        setLoading(false);
        return;
      }
      setLoading(true);
      setError(null);
      try {
        const { data: woData, error: woErr } = await supabase
          .from("work_orders")
          .select("id,status,type,created_at,updated_at,notes,customer_id,vehicle_id,invoice_total,labor_total,parts_total,quote_url,invoice_url")
          .eq("id", woId)
          .single<WO>();
        if (woErr || !woData) throw new Error(woErr?.message || "Work order not found");
        if (!active) return;
        setWO(woData);

        if (woData.customer_id) {
          const { data: c } = await supabase
            .from("customers")
            .select("name,email,phone,first_name,last_name")
            .eq("id", woData.customer_id)
            .single<Customer>();
          if (!active) return;
          setCustomer(c ?? null);
        } else {
          setCustomer(null);
        }

        if (woData.vehicle_id) {
          const { data: v } = await supabase
            .from("vehicles")
            .select("year,make,model,license_plate,vin,color,mileage,unit_number")
            .eq("id", woData.vehicle_id)
            .single<Vehicle>();
          if (!active) return;
          setVehicle(v ?? null);
        } else {
          setVehicle(null);
        }

        const { data: linesRaw } = await supabase
          .from("work_order_lines")
          .select("id,description,job_type,labor_time,notes,complaint,cause,correction,status,created_at,updated_at")
          .eq("work_order_id", woId)
          .order("created_at", { ascending: true })
          .returns<WOLine[]>();

        if (!active) return;
        setLines(linesRaw ?? []);
      } catch (e) {
        if (!active) return;
        setError(e instanceof Error ? e.message : String(e));
      } finally {
        if (active) setLoading(false);
      }
    }
    load();
    return () => { active = false; };
  }, [supabase, woId]);

  if (!woId) {
    return <div className="text-neutral-400 text-sm">No work order id provided yet.</div>;
  }

  if (loading) {
    return (
      <div className="rounded-lg border bg-neutral-950 p-5 text-neutral-300" style={{ borderColor: "#f97316" }}>
        Loading work order‚Ä¶
      </div>
    );
  }

  if (error || !wo) {
    return (
      <div className="text-red-400 text-sm">
        Failed to load work order{error ? `: ${error}` : ""}.
      </div>
    );
  }

  const customerName =
    customer?.name ??
    ([customer?.first_name, customer?.last_name].filter(Boolean).join(" ") || "‚Äî");

  const vehicleLabel = [vehicle?.year, vehicle?.make, vehicle?.model].filter(Boolean).join(" ");
  const plateOrVin = vehicle?.license_plate ?? vehicle?.vin ?? "‚Äî";

  return (
    <div className="rounded-lg border bg-neutral-950 p-5 shadow-xl" style={{ borderColor: "#f97316" }}>
      <div className="flex items-start justify-between gap-4">
        <h3 className="text-xl text-orange-400" style={{ fontFamily: "'Black Ops One', system-ui, sans-serif" }}>
          Work Order #{String(wo.id).slice(0, 8)}
        </h3>
        <span className="text-[11px] px-2 py-1 rounded bg-neutral-900 text-neutral-300 border border-neutral-800">
          {wo.status ?? "unknown"}
        </span>
      </div>

      <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm" style={{ fontFamily: "'Roboto', system-ui, sans-serif" }}>
        <section className="space-y-1">
          <div className="text-neutral-400">Customer</div>
          <div className="text-neutral-100">{customerName}</div>
          <div className="text-neutral-300">{customer?.email || "‚Äî"}</div>
          <div className="text-neutral-300">{customer?.phone || "‚Äî"}</div>
        </section>

        <section className="space-y-1">
          <div className="text-neutral-400">Vehicle</div>
          <div className="text-neutral-100">{vehicleLabel || "‚Äî"}</div>
          <div className="text-neutral-300">Plate/VIN: {plateOrVin}</div>
          <div className="text-neutral-300">
            Color: {vehicle?.color || "‚Äî"} ¬∑ Mileage: {vehicle?.mileage ?? "‚Äî"} ¬∑ Unit: {vehicle?.unit_number || "‚Äî"}
          </div>
        </section>
      </div>

      <div className="mt-5 border-t border-neutral-800 pt-4">
        <div className="text-sm text-neutral-400 mb-2" style={{ fontFamily: "'Roboto', system-ui, sans-serif" }}>
          Lines
        </div>
        {lines.length === 0 ? (
          <div className="text-neutral-500 text-sm">No lines yet.</div>
        ) : (
          <ul className="space-y-3">
            {lines.map((l) => (
              <li key={l.id} className="rounded border border-neutral-800 bg-neutral-900 p-3">
                <div className="flex items-center justify-between">
                  <div className="text-neutral-100">{l.description || "(no description)"}</div>
                  <span className="text-[11px] px-2 py-0.5 rounded bg-neutral-950 text-neutral-300 border border-neutral-800">
                    {l.job_type || "‚Äî"}
                  </span>
                </div>
                <div className="mt-1 text-xs text-neutral-400">
                  Labor time: {l.labor_time ?? 0} ¬∑ Status: {l.status || "‚Äî"}
                </div>
                {(l.complaint || l.cause || l.correction) && (
                  <div className="mt-2 grid grid-cols-1 md:grid-cols-3 gap-2 text-xs">
                    <div className="bg-neutral-950/60 rounded p-2 border border-neutral-800">
                      <div className="text-neutral-400 mb-1">Complaint</div>
                      <div className="text-neutral-200">{l.complaint || "‚Äî"}</div>
                    </div>
                    <div className="bg-neutral-950/60 rounded p-2 border border-neutral-800">
                      <div className="text-neutral-400 mb-1">Cause</div>
                      <div className="text-neutral-200">{l.cause || "‚Äî"}</div>
                    </div>
                    <div className="bg-neutral-950/60 rounded p-2 border border-neutral-800">
                      <div className="text-neutral-400 mb-1">Correction</div>
                      <div className="text-neutral-200">{l.correction || "‚Äî"}</div>
                    </div>
                  </div>
                )}
                {l.notes && <div className="mt-2 text-xs text-neutral-300">Notes: {l.notes}</div>}
              </li>
            ))}
          </ul>
        )}
      </div>

      <div className="mt-5 border-t border-neutral-800 pt-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
          <div className="text-neutral-400">Parts Total</div>
          <div className="text-neutral-100">${(wo.parts_total ?? 0).toFixed(2)}</div>
        </div>
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
          <div className="text-neutral-400">Labor Total</div>
          <div className="text-neutral-100">${(wo.labor_total ?? 0).toFixed(2)}</div>
        </div>
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3">
          <div className="text-neutral-400">Invoice Total</div>
          <div className="text-neutral-100">${(wo.invoice_total ?? 0).toFixed(2)}</div>
        </div>
      </div>

      {(wo.quote_url || wo.invoice_url) && (
        <div className="mt-4 flex gap-2">
          {wo.quote_url && (
            <a href={wo.quote_url} target="_blank" rel="noreferrer" className="text-xs underline text-orange-400 hover:text-orange-300">
              Open Quote
            </a>
          )}
          {wo.invoice_url && (
            <a href={wo.invoice_url} target="_blank" rel="noreferrer" className="text-xs underline text-orange-400 hover:text-orange-300">
              Open Invoice
            </a>
          )}
        </div>
      )}

      {wo.notes && (
        <div className="mt-4 text-sm text-neutral-200">
          <div className="text-neutral-400 mb-1">Notes</div>
          <p className="whitespace-pre-wrap">{wo.notes}</p>
        </div>
      )}
    </div>
  );
}

========================================
FILE: app/work-orders/confirm/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];

export default function ApprovalConfirmPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();
  const search = useSearchParams();
  const woId = search.get("woId");

  const [wo, setWo] = useState<WorkOrder | null>(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  useEffect(() => {
    let redirectTimer: ReturnType<typeof setTimeout> | undefined;
    let closeTimer: ReturnType<typeof setTimeout> | undefined;

    (async () => {
      if (!woId) {
        setErr("Missing work order id.");
        setLoading(false);
        return;
      }

      const { data, error } = await supabase
        .from("work_orders")
        .select("id, custom_id, shop_id, status")
        .eq("id", woId)
        .maybeSingle();

      if (error) setErr(error.message);
      setWo((data as WorkOrder | null) ?? null);
      setLoading(false);

      if (data?.id) {
        const href = `/work-orders/${data.custom_id ?? data.id}?mode=view`;

        // Redirect back ‚Üí then auto-close window
        redirectTimer = setTimeout(() => {
          router.replace(href);

          // Try to close after redirect (allowed if popup/tab was opened by app)
          closeTimer = setTimeout(() => {
            try {
              window.close();
            } catch {
              /* ignore browser restrictions */
            }
          }, 500);
        }, 1500);
      }
    })();

    return () => {
      if (redirectTimer) clearTimeout(redirectTimer);
      if (closeTimer) clearTimeout(closeTimer);
    };
  }, [woId, supabase, router]);

  /* ---------------------------------------------------------------------- */
  /*                                UI STATES                               */
  /* ---------------------------------------------------------------------- */

  if (loading) {
    return (
      <div className="mx-auto max-w-2xl p-6 text-white">
        <div className="mb-4 h-8 w-48 animate-pulse rounded-lg bg-black/30 backdrop-blur-sm border border-white/10" />
        <div className="h-24 animate-pulse rounded-lg bg-black/30 backdrop-blur-sm border border-white/10" />
      </div>
    );
  }

  if (err || !wo) {
    return (
      <div className="mx-auto max-w-2xl p-6 text-red-400">
        {err ?? "Work order not found."}
      </div>
    );
  }

  const viewHref = `/work-orders/${wo.custom_id ?? wo.id}?mode=view`;

  /* ---------------------------------------------------------------------- */
  /*                           THEMED CONFIRMATION UI                       */
  /* ---------------------------------------------------------------------- */

  return (
    <div className="mx-auto max-w-xl p-6 text-white">
      <div className="
        rounded-2xl border border-green-500/40 
        bg-green-500/10 
        backdrop-blur-lg 
        shadow-xl shadow-black/40 
        p-6
      ">
        <div className="text-xl font-blackops text-green-300 tracking-wide">
          Approval Received ‚úì
        </div>

        <div className="mt-2 text-sm text-neutral-300">
          This work order is now marked{" "}
          <span className="font-semibold text-green-200">
            {(wo.status ?? "queued").replaceAll("_", " ")}
          </span>.
        </div>

        <div className="mt-5 flex gap-3">
          <Link
            href={viewHref}
            className="
              rounded-full 
              bg-orange-500 
              px-5 
              py-2 
              font-semibold 
              text-black 
              shadow 
              shadow-orange-900/40
              hover:bg-orange-400
              transition
            "
          >
            View Work Order
          </Link>

          <Link
            href="/work-orders"
            className="
              rounded-full 
              border border-white/10 
              bg-white/5 
              px-5 
              py-2 
              text-white 
              shadow-sm 
              hover:bg-white/10
              transition
              backdrop-blur-sm
            "
          >
            Back to List
          </Link>
        </div>

        <div className="mt-4 text-xs text-neutral-400">
          Redirecting and closing window‚Ä¶
        </div>
      </div>
    </div>
  );
}

========================================
FILE: app/work-orders/create/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/work-orders/app/work-orders/create/page";

========================================
FILE: app/work-orders/editor/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/work-orders/app/work-orders/editor/page";

========================================
FILE: app/work-orders/history/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

import WorkOrdersHistoryClient from "./WorkOrdersHistoryClient";

export default function Page() {
  return <WorkOrdersHistoryClient />;
}


========================================
FILE: app/work-orders/history/WorkOrdersHistoryClient.tsx
========================================
"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import Link from "next/link";
import { format } from "date-fns";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type Row = WorkOrder & {
  customers: Pick<
    Customer,
    "first_name" | "last_name" | "email" | "phone"
  > | null;
  vehicles: Pick<
    Vehicle,
    "year" | "make" | "model" | "license_plate" | "vin"
  > | null;
};

export default function WorkOrdersHistoryClient(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [shopId, setShopId] = useState<string | null>(null);
  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  const [q, setQ] = useState("");
  const [from, setFrom] = useState<string>("");
  const [to, setTo] = useState<string>("");

  // ---- Load current user's shop ----
  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr || !user) {
        setErr("You must be signed in to view work order history.");
        setLoading(false);
        return;
      }

      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("id", user.id)
        .maybeSingle();

      if (profErr) {
        setErr(profErr.message);
        setLoading(false);
        return;
      }

      if (!profile?.shop_id) {
        setErr("No shop is linked to your profile yet.");
        setLoading(false);
        return;
      }

      setShopId(profile.shop_id);
      setLoading(false);
    })();
  }, [supabase]);

  // ---- Load completed work orders for this shop ----
  const load = useCallback(async () => {
    if (!shopId) return;

    setLoading(true);
    setErr(null);

    let query = supabase
      .from("work_orders")
      .select(
        `
        *,
        customers:customers(first_name,last_name,email,phone),
        vehicles:vehicles(year,make,model,license_plate,vin)
      `,
      )
      .eq("shop_id", shopId)
      .eq("status", "completed")
      .order("updated_at", { ascending: false })
      .limit(300);

    if (from) {
      query = query.gte(
        "updated_at",
        new Date(from + "T00:00:00Z").toISOString(),
      );
    }
    if (to) {
      const toEnd = new Date(to);
      toEnd.setHours(23, 59, 59, 999);
      query = query.lte("updated_at", toEnd.toISOString());
    }

    const { data, error } = await query;

    if (error) {
      setErr(error.message);
      setRows([]);
      setLoading(false);
      return;
    }

    const list = (data ?? []) as Row[];

    const qlc = q.trim().toLowerCase();
    const filtered = qlc
      ? list.filter((r) => {
          const name = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
            .filter(Boolean)
            .join(" ")
            .toLowerCase();
          const plate = r.vehicles?.license_plate?.toLowerCase() ?? "";
          const vin = r.vehicles?.vin?.toLowerCase() ?? "";
          const ymm = [
            r.vehicles?.year ?? "",
            r.vehicles?.make ?? "",
            r.vehicles?.model ?? "",
          ]
            .join(" ")
            .toLowerCase();
          const cid = (r.custom_id ?? "").toLowerCase();
          return (
            r.id.toLowerCase().includes(qlc) ||
            cid.includes(qlc) ||
            name.includes(qlc) ||
            plate.includes(qlc) ||
            vin.includes(qlc) ||
            ymm.includes(qlc)
          );
        })
      : list;

    setRows(filtered);
    setLoading(false);
  }, [supabase, shopId, from, to, q]);

  // Initial load + reload when filters change via Apply button
  useEffect(() => {
    if (!shopId) return;
    void load();
  }, [load, shopId]);

  function exportCSV() {
    const header = [
      "WO ID",
      "Custom ID",
      "Updated",
      "Customer",
      "Email",
      "Phone",
      "Vehicle",
      "Plate",
      "VIN",
      "Invoice URL",
    ];
    const lines = rows.map((r) => {
      const customer = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
        .filter(Boolean)
        .join(" ");
      const vehicle = r.vehicles
        ? `${r.vehicles.year ?? ""} ${r.vehicles.make ?? ""} ${
            r.vehicles.model ?? ""
          }`.trim()
        : "";
      const updated = r.updated_at
        ? format(new Date(r.updated_at), "yyyy-MM-dd HH:mm")
        : "";
      return [
        r.id,
        r.custom_id ?? "",
        updated,
        customer,
        r.customers?.email ?? "",
        r.customers?.phone ?? "",
        vehicle,
        r.vehicles?.license_plate ?? "",
        r.vehicles?.vin ?? "",
        r.invoice_url ?? r.quote_url ?? "",
      ]
        .map((x) => `"${String(x ?? "").replace(/"/g, '""')}"`)
        .join(",");
    });

    const blob = new Blob([header.join(",") + "\n" + lines.join("\n")], {
      type: "text/csv;charset=utf-8",
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `work-order-history-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="min-h-[calc(100vh-4rem)] bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),#020617_82%)] px-4 py-6 text-white">
      <div className="mx-auto max-w-6xl rounded-2xl border border-[var(--metal-border-soft)] bg-[radial-gradient(circle_at_top,_#050910,_#020308_65%,_#000)] px-4 py-5 shadow-[0_24px_80px_rgba(0,0,0,0.95)] sm:px-6 sm:py-6">
        {/* Header */}
        <div className="mb-5 flex flex-wrap items-center gap-3">
          <div className="space-y-1">
            <div className="inline-flex items-center gap-2 rounded-full border border-white/10 bg-black/70 px-3 py-1">
              <span className="text-[0.7rem] font-blackops uppercase tracking-[0.22em] text-neutral-200">
                Work Order History
              </span>
            </div>
            <p className="text-xs text-neutral-400">
              Completed work orders for your shop. Search, filter by date, export
              for reporting.
            </p>
          </div>

          <div className="ml-auto text-right text-xs text-neutral-400">
            <div>
              <span className="font-mono text-sm font-semibold text-orange-400">
                {rows.length.toString().padStart(2, "0")}
              </span>{" "}
              <span className="uppercase tracking-[0.14em] text-neutral-500">
                Completed
              </span>
            </div>
            {from || to ? (
              <div className="mt-0.5 font-mono text-[11px] text-neutral-500">
                Range: {from || "‚Ä¶"} ‚Üí {to || "‚Ä¶"}
              </div>
            ) : (
              <div className="mt-0.5 text-[11px] text-neutral-500">
                Showing last {rows.length} records loaded
              </div>
            )}
          </div>
        </div>

        {/* Filters bar */}
        <div className="mb-5 rounded-2xl border border-[var(--metal-border-soft)] bg-black/60 p-3 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-4">
          <div className="flex flex-wrap items-end gap-3">
            <div className="min-w-[220px] flex-1">
              <label className="mb-1 block text-[11px] font-medium uppercase tracking-[0.18em] text-neutral-400">
                Search
              </label>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                onKeyDown={(e) => e.key === "Enter" && load()}
                placeholder="ID, custom ID, name, VIN, plate, YMM‚Ä¶"
                className="w-full rounded-lg border border-neutral-800 bg-black/70 px-3 py-1.5 text-sm text-neutral-100 outline-none ring-0 transition-colors focus:border-orange-400 focus:ring-1 focus:ring-orange-500/70"
              />
            </div>

            <div>
              <label className="mb-1 block text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                From
              </label>
              <input
                type="date"
                value={from}
                onChange={(e) => setFrom(e.target.value)}
                className="rounded-lg border border-neutral-800 bg-black/70 px-3 py-1.5 text-sm text-neutral-100 outline-none ring-0 focus:border-orange-400 focus:ring-1 focus:ring-orange-500/70"
                aria-label="From date"
              />
            </div>
            <div>
              <label className="mb-1 block text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                To
              </label>
              <input
                type="date"
                value={to}
                onChange={(e) => setTo(e.target.value)}
                className="rounded-lg border border-neutral-800 bg-black/70 px-3 py-1.5 text-sm text-neutral-100 outline-none ring-0 focus:border-orange-400 focus:ring-1 focus:ring-orange-500/70"
                aria-label="To date"
              />
            </div>

            <div className="flex flex-wrap gap-2">
              <button
                type="button"
                onClick={load}
                className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1.5 text-xs font-medium uppercase tracking-[0.16em] text-neutral-100 hover:border-orange-400 hover:bg-black/80"
              >
                Apply
              </button>
              <button
                type="button"
                onClick={() => window.print()}
                className="rounded-full border border-neutral-700 bg-black/70 px-3 py-1.5 text-xs font-medium uppercase tracking-[0.16em] text-neutral-200 hover:bg-neutral-900"
              >
                Print
              </button>
              <button
                type="button"
                onClick={exportCSV}
                className="rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-3 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] text-black shadow-[0_0_18px_rgba(212,118,49,0.7)] hover:brightness-110"
              >
                Export CSV
              </button>
            </div>
          </div>
        </div>

        {/* Error */}
        {err && (
          <div className="mb-4 rounded-xl border border-red-500/60 bg-red-950/80 px-4 py-2 text-sm text-red-100">
            {err}
          </div>
        )}

        {/* Content */}
        {loading ? (
          <div className="rounded-2xl border border-dashed border-[var(--metal-border-soft)] bg-black/60 p-6 text-sm text-neutral-400">
            Loading completed work orders‚Ä¶
          </div>
        ) : rows.length === 0 ? (
          <div className="rounded-2xl border border-dashed border-[var(--metal-border-soft)] bg-black/60 p-6 text-sm text-neutral-400">
            No completed work orders found for this shop and date range.
          </div>
        ) : (
          <div className="grid gap-2">
            {rows.map((r) => {
              const updated = r.updated_at
                ? format(new Date(r.updated_at), "PPpp")
                : "‚Äî";
              const customer = r.customers
                ? [r.customers.first_name ?? "", r.customers.last_name ?? ""]
                    .filter(Boolean)
                    .join(" ")
                : "‚Äî";
              const vehicle = r.vehicles
                ? `${r.vehicles.year ?? ""} ${r.vehicles.make ?? ""} ${
                    r.vehicles.model ?? ""
                  }`.trim()
                : "‚Äî";
              const plate = r.vehicles?.license_plate
                ? `(${r.vehicles.license_plate})`
                : "";
              const vin = r.vehicles?.vin ? `VIN: ${r.vehicles.vin}` : "";

              return (
                <div
                  key={r.id}
                  className="flex flex-col gap-2 rounded-2xl border border-[var(--metal-border-soft)] bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.24),_#020617_75%)]/90 p-3 shadow-[0_14px_38px_rgba(0,0,0,0.9)] sm:flex-row sm:items-center"
                >
                  <div className="min-w-0 flex-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <Link
                        href={`/work-orders/${r.id}`}
                        className="font-mono text-sm text-orange-300 underline decoration-transparent underline-offset-2 hover:decoration-orange-400"
                      >
                        {r.custom_id ? r.custom_id : `#${r.id.slice(0, 8)}`}
                      </Link>
                      {r.custom_id && (
                        <span className="rounded-full border border-white/10 bg-black/60 px-2 py-0.5 text-[10px] font-mono text-neutral-400">
                          #{r.id.slice(0, 6)}
                        </span>
                      )}
                      <span className="inline-flex items-center rounded-full border border-emerald-400/60 bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-[0.16em] text-emerald-300">
                        Completed
                      </span>
                      <span className="text-[11px] text-neutral-400">
                        {updated}
                      </span>
                    </div>
                    <div className="mt-1 truncate text-sm text-neutral-300">
                      {customer} ‚Ä¢ {vehicle} {plate} {vin && `‚Ä¢ ${vin}`}
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    {r.invoice_url ? (
                      <a
                        href={r.invoice_url}
                        target="_blank"
                        rel="noreferrer"
                        className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[11px] font-medium uppercase tracking-[0.16em] text-neutral-100 hover:border-orange-400 hover:bg-black/80"
                      >
                        Open Invoice
                      </a>
                    ) : r.quote_url ? (
                      <a
                        href={r.quote_url}
                        target="_blank"
                        rel="noreferrer"
                        className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[11px] font-medium uppercase tracking-[0.16em] text-neutral-100 hover:border-orange-400 hover:bg-black/80"
                      >
                        Open Quote
                      </a>
                    ) : (
                      <span className="text-[11px] text-neutral-500">
                        No invoice
                      </span>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

========================================
FILE: app/work-orders/[id]/approve/page.tsx
========================================
//app/work-orders/[id]/approve/page.tsx

"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import SignaturePad, {
  openSignaturePad,
} from "@/features/shared/signaturePad/controller";
import LegalTerms from "@/features/shared/components/LegalTerms";
import { uploadSignatureImage } from "@/features/shared/lib/utils/uploadSignature";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Line = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Shop = DB["public"]["Tables"]["shops"]["Row"];

/* ------------------------------ helpers ---------------------------------- */
const getStr = (obj: unknown, key: string): string | null => {
  if (obj && typeof obj === "object") {
    const v = (obj as Record<string, unknown>)[key];
    if (typeof v === "string") return v.trim() || null;
  }
  return null;
};

const getNum = (obj: unknown, key: string): number | null => {
  if (obj && typeof obj === "object") {
    const v = (obj as Record<string, unknown>)[key];
    if (typeof v === "number" && Number.isFinite(v)) return v;
    if (typeof v === "string") {
      const n = Number(v);
      if (Number.isFinite(n)) return n;
    }
  }
  return null;
};
/* ------------------------------------------------------------------------- */

export default function ApproveWorkOrderPage() {
  const params = useParams<{ id: string }>();
  const id = Array.isArray(params?.id) ? params.id[0] : params?.id;
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [wo, setWo] = useState<WorkOrder | null>(null);
  const [shop, setShop] = useState<Shop | null>(null);
  const [lines, setLines] = useState<Line[]>([]);
  const [loading, setLoading] = useState<boolean>(true);
  const [err, setErr] = useState<string | null>(null);

  const [approved, setApproved] = useState<Set<string>>(new Set());
  const [submitting, setSubmitting] = useState<boolean>(false);
  const [savedSigUrl, setSavedSigUrl] = useState<string | null>(null);
  const [agreed, setAgreed] = useState<boolean>(false);

  useEffect(() => {
    (async () => {
      if (!id) return;
      setLoading(true);
      setErr(null);
      try {
        const [
          { data: woRow, error: woErr },
          { data: lineRows, error: liErr },
        ] = await Promise.all([
          supabase.from("work_orders").select("*").eq("id", id).maybeSingle(),
          supabase
            .from("work_order_lines")
            .select("*")
            .eq("work_order_id", id)
            .neq("status", "completed")
            .order("created_at", { ascending: true }),
        ]);

        if (woErr) throw woErr;
        if (liErr) throw liErr;

        setWo((woRow as WorkOrder | null) ?? null);
        setLines((lineRows as Line[] | null) ?? []);
        setApproved(new Set(((lineRows as Line[] | null) ?? []).map((l) => l.id)));

        if (woRow?.shop_id) {
          const { data: shopRow, error: sErr } = await supabase
            .from("shops")
            .select("*")
            .eq("id", woRow.shop_id)
            .maybeSingle();
          if (sErr) throw sErr;
          setShop((shopRow as Shop | null) ?? null);
        } else {
          setShop(null);
        }
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load work order.";
        setErr(msg);
      } finally {
        setLoading(false);
      }
    })();
  }, [id, supabase]);

  const toggle = (lineId: string) =>
    setApproved((prev) => {
      const next = new Set(prev);
      if (next.has(lineId)) next.delete(lineId);
      else next.add(lineId);
      return next;
    });

  /* ---- Pricing helpers (mirrors Quote Review) --------------------------- */
  const hourlyRate: number =
    getNum(wo, "hourly_rate") ?? getNum(shop, "hourly_rate") ?? 120;

  const currencyCode = (getStr(shop, "currency") ?? "USD").toUpperCase();
  const fmt = useMemo(
    () =>
      new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: currencyCode,
      }),
    [currencyCode],
  );

  const approvedLines = lines.filter((l) => approved.has(l.id));
  const hours = approvedLines.reduce<number>(
    (sum, l) =>
      sum + (typeof l.labor_time === "number" ? l.labor_time : 0),
    0,
  );
  const laborTotal = hours * hourlyRate;

  const partsTotal = approvedLines.reduce<number>(
    (sum, l) => sum + (getNum(l, "parts_total") ?? 0),
    0,
  );
  const grandTotal = laborTotal + partsTotal;

  const totals = { hours: hours.toFixed(1) };
  /* ---------------------------------------------------------------------- */

  async function handleSubmit(signatureDataUrl?: string) {
    if (!id) return;
    setSubmitting(true);
    try {
      let signatureUrl: string | null = savedSigUrl;
      if (signatureDataUrl) {
        const uploaded = await uploadSignatureImage(signatureDataUrl, id);
        signatureUrl = uploaded;
        setSavedSigUrl(uploaded);
      }

      const approvedLineIds: string[] = Array.from(approved);
      const declinedLineIds: string[] = lines
        .map((l) => l.id)
        .filter((x) => !approved.has(x));

      const res = await fetch("/work-orders/approval-webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId: id,
          shopId: wo?.shop_id ?? null,
          customerId: wo?.customer_id ?? null,
          approvedLineIds,
          declinedLineIds,
          declineUnchecked: true,
          approverId: null,
          signatureUrl,
        }),
      });

      const j = (await res.json().catch(() => null)) as { error?: string } | null;
      if (!res.ok) {
        throw new Error(j?.error ?? "Failed to submit approval");
      }

      router.replace(`/work-orders/confirm?woId=${id}`);
    } catch (e) {
      setErr(e instanceof Error ? e.message : "Approval failed");
    } finally {
      setSubmitting(false);
    }
  }

  /* -------------------------- Loading / not found ------------------------ */

  if (loading) {
    return (
      <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#020617,_#000)] px-4 py-8 text-white">
        <div className="mx-auto max-w-3xl space-y-4">
          <div className="h-8 w-48 animate-pulse rounded-lg bg-neutral-800/60" />
          <div className="h-24 animate-pulse rounded-2xl bg-neutral-900/70" />
        </div>
      </div>
    );
  }

  if (!wo) {
    return (
      <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#020617,_#000)] px-4 py-8 text-red-400">
        <div className="mx-auto max-w-2xl rounded-2xl border border-red-500/50 bg-red-950/60 p-4 text-sm">
          Work order not found.
        </div>
      </div>
    );
  }

  /* ------------------------------- UI ------------------------------------ */

  return (
    <div className="min-h-screen bg-[radial-gradient(circle_at_top,_#0b1120,_#000)] px-4 py-8 text-white">
      <div className="mx-auto max-w-3xl space-y-6">
        {/* Header card */}
        <section className="metal-panel metal-panel--card rounded-2xl border border-white/10 bg-black/40 px-4 py-4 text-white shadow-[0_0_40px_rgba(0,0,0,0.85)] backdrop-blur-md">
          <div className="flex items-start justify-between gap-3">
            <div className="space-y-1">
              <h1 className="text-lg font-blackops tracking-[0.18em] text-[var(--accent-copper-light)]">
                {shop?.name
                  ? `${shop.name} ‚Äî Approval`
                  : "Customer Approval"}
              </h1>
              <p className="text-xs text-neutral-300">
                Review the work and sign to approve the selected items.
              </p>
              <p className="text-[0.7rem] font-mono text-neutral-400">
                WO{" "}
                <span className="text-[var(--accent-copper-soft)]">
                  {wo.custom_id ?? `#${wo.id.slice(0, 8)}`}
                </span>
              </p>
            </div>
            <div className="rounded-full border border-white/15 bg-black/60 px-3 py-1 text-[0.7rem] text-neutral-200">
              <span className="text-neutral-400">Estimate Total</span>
              <div className="text-sm font-semibold text-[var(--accent-copper-light)]">
                {fmt.format(grandTotal)}
              </div>
            </div>
          </div>

          {err && (
            <div className="mt-3 rounded-xl border border-red-500/60 bg-red-950/70 px-3 py-2 text-xs text-red-100">
              {err}
            </div>
          )}
        </section>

        {/* Items card */}
        <section className="glass-card rounded-2xl border border-white/10 bg-black/40 px-4 py-4 shadow-[0_0_30px_rgba(0,0,0,0.7)] backdrop-blur-md">
          <div className="mb-3 flex items-center justify-between gap-2">
            <div>
              <h2 className="text-sm font-semibold text-white">
                Items to approve
              </h2>
              <p className="text-[0.7rem] text-neutral-400">
                Check the work you authorize. Unchecked items will be declined.
              </p>
            </div>
            <div className="rounded-full border border-white/10 bg-black/50 px-2.5 py-1 text-[0.7rem] text-neutral-300">
              Approved labor:{" "}
              <span className="font-semibold text-[var(--accent-copper-light)]">
                {totals.hours}h
              </span>
            </div>
          </div>

          <div className="overflow-hidden rounded-xl border border-white/5 bg-black/40">
            {lines.length === 0 ? (
              <div className="p-3 text-sm text-neutral-400">
                No items to approve.
              </div>
            ) : (
              <div className="divide-y divide-white/5">
                {lines.map((l) => (
                  <label
                    key={l.id}
                    className="flex cursor-pointer items-start gap-3 px-3 py-3 hover:bg-white/5"
                  >
                    <input
                      type="checkbox"
                      className="mt-1 h-4 w-4 rounded border-neutral-500 bg-black/80 text-[var(--accent-copper)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper)]"
                      checked={approved.has(l.id)}
                      onChange={() => toggle(l.id)}
                    />
                    <div className="min-w-0">
                      <div className="truncate text-sm font-medium text-white">
                        {l.description || l.complaint || "Untitled item"}
                      </div>
                      <div className="mt-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-400">
                        {(l.job_type ?? "job")
                          .toString()
                          .replaceAll("_", " ")}{" "}
                        ‚Ä¢{" "}
                        {typeof l.labor_time === "number"
                          ? `${l.labor_time.toFixed(1)}h`
                          : "‚Äî"}
                      </div>
                      {(l.cause || l.correction) && (
                        <div className="mt-1 text-[0.7rem] text-neutral-400">
                          {l.cause && (
                            <>
                              <span className="font-semibold text-neutral-300">
                                Cause:
                              </span>{" "}
                              {l.cause}{" "}
                            </>
                          )}
                          {l.correction && (
                            <>
                              <span className="mx-1 text-neutral-600">|</span>
                              <span className="font-semibold text-neutral-300">
                                Correction:
                              </span>{" "}
                              {l.correction}
                            </>
                          )}
                        </div>
                      )}
                    </div>
                  </label>
                ))}
              </div>
            )}
          </div>

          <div className="mt-3 flex items-center justify-between text-[0.75rem] text-neutral-300">
            <span>
              You can uncheck any work you do{" "}
              <span className="font-semibold text-neutral-100">not</span> want
              performed.
            </span>
          </div>
        </section>

        {/* Totals card */}
        <section className="glass-card rounded-2xl border border-white/10 bg-gradient-to-b from-black/60 via-black/40 to-black/70 px-4 py-4 shadow-[0_0_30px_rgba(0,0,0,0.7)] backdrop-blur-md">
          <div className="mb-3 flex items-center justify-between gap-2">
            <h2 className="text-sm font-semibold text-white">Totals</h2>
            <span className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
              Summary
            </span>
          </div>

          <div className="space-y-2 text-sm text-neutral-200">
            <div className="flex items-center justify-between">
              <span>
                Labor ({hours.toFixed(1)}h @ {fmt.format(hourlyRate)}/hr)
              </span>
              <span className="font-medium text-neutral-50">
                {fmt.format(laborTotal)}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span>Parts</span>
              <span className="font-medium text-neutral-50">
                {fmt.format(partsTotal)}
              </span>
            </div>
            <div className="mt-2 flex items-center justify-between border-t border-white/10 pt-2">
              <span className="text-sm font-semibold text-white">Total</span>
              <span className="text-base font-semibold text-[var(--accent-copper-light)]">
                {fmt.format(grandTotal)}
              </span>
            </div>
          </div>
        </section>

        {/* Terms */}
        <div className="glass-card rounded-2xl border border-white/10 bg-black/40 px-4 py-4 backdrop-blur-md">
          <LegalTerms onAgreeChange={setAgreed} defaultOpen />
        </div>

        {/* Actions */}
        <div className="flex flex-wrap items-center gap-3">
          <button
            className="rounded-full bg-[var(--accent-copper)] px-5 py-2.5 text-sm font-semibold text-black shadow-[0_0_30px_rgba(0,0,0,0.9)] transition hover:bg-[var(--accent-copper-light)] disabled:cursor-not-allowed disabled:opacity-60"
            onClick={async () => {
              const base64: string | null = await openSignaturePad({
                shopName: shop?.name || "",
              });
              if (base64) await handleSubmit(base64);
            }}
            disabled={submitting || !agreed}
            title={
              !agreed
                ? "Please agree to the Terms & Conditions"
                : "Sign & Submit"
            }
          >
            {submitting ? "Submitting‚Ä¶" : "Sign & Approve Work"}
          </button>

          <button
            className="rounded-full border border-white/20 px-4 py-2 text-sm font-medium text-neutral-100 transition hover:bg-white/5 disabled:cursor-not-allowed disabled:opacity-60"
            onClick={() => void handleSubmit()}
            disabled={submitting || !agreed}
          >
            Approve without Signature
          </button>

          <span className="text-[0.7rem] text-neutral-500">
            Your approval will be linked to this work order record.
          </span>
        </div>

        {/* Mount the modal host once */}
        <SignaturePad />
      </div>
    </div>
  );
}

========================================
FILE: app/work-orders/[id]/Client.tsx
========================================
//app/work-orders/[id]/Client.tsx

"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { useParams } from "next/navigation";
import { format } from "date-fns";
import { toast } from "sonner";
import dynamic from "next/dynamic";

import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

import PreviousPageButton from "@shared/components/ui/PreviousPageButton";
import VehiclePhotoUploader from "@parts/components/VehiclePhotoUploader";
import VehiclePhotoGallery from "@parts/components/VehiclePhotoGallery";
import FocusedJobModal from "@/features/work-orders/components/workorders/FocusedJobModal";
import VoiceContextSetter from "@/features/shared/voice/VoiceContextSetter";
import VoiceButton from "@/features/shared/voice/VoiceButton";
import { useTabState } from "@/features/shared/hooks/useTabState";
import PartsDrawer from "@/features/parts/components/PartsDrawer";
import AssignTechModal from "@/features/work-orders/components/workorders/extras/AssignTechModal";
import { JobCard } from "@/features/work-orders/components/JobCard";
import { WorkOrderSuggestionsPanel } from "@/features/work-orders/components/WorkOrderSuggestionsPanel";
import { useWorkOrderActions } from "@/features/work-orders/hooks/useWorkOrderActions";

// inspection modal
const InspectionModal = dynamic(
  () => import("@/features/inspections/components/InspectionModal"),
  { ssr: false },
);

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrderQuoteLine =
  DB["public"]["Tables"]["work_order_quote_lines"]["Row"];
type WorkOrderQuoteLineWithLineId = WorkOrderQuoteLine & {
  work_order_line_id?: string | null;
};
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Profile = DB["public"]["Tables"]["profiles"]["Row"];
type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };
type LineTechRow =
  DB["public"]["Tables"]["work_order_line_technicians"]["Row"];

type WorkOrderLineWithInspectionMeta = WorkOrderLine & {
  // real DB column
  inspection_template_id?: string | null;

  // older / alternate fields we may have used in earlier iterations
  inspection_template?: string | null;
  inspectionTemplate?: string | null;
  template?: string | null;
  metadata?: {
    inspection_template?: string | null;
    template?: string | null;
  } | null;
  metadata2?: {
    inspection_template?: string | null;
    template?: string | null;
  } | null;
};

const looksLikeUuid = (s: string) => s.includes("-") && s.length >= 36;

function splitCustomId(raw: string): { prefix: string; n: number | null } {
  const m = raw.toUpperCase().match(/^([A-Z]+)\s*0*?(\d+)?$/);
  if (!m) return { prefix: raw.toUpperCase(), n: null };
  const n = m[2] ? parseInt(m[2], 10) : null;
  return { prefix: m[1], n: Number.isFinite(n!) ? n : null };
}

/** Normalize ‚Äúwhere is the inspection template id stored for this line?‚Äù */
function extractInspectionTemplateId(
  ln: WorkOrderLineWithInspectionMeta,
): string | null {
  return (
    ln.inspection_template_id ??
    ln.inspection_template ??
    ln.inspectionTemplate ??
    ln.template ??
    ln.metadata?.inspection_template ??
    ln.metadata?.template ??
    ln.metadata2?.inspection_template ??
    ln.metadata2?.template ??
    null
  );
}

// ----------------- Inspection template helpers -----------------

type TemplateSectionItem = { item: string; unit?: string | null };
type TemplateSection = { title: string; items: TemplateSectionItem[] };

const HYD_ITEM_RE = /^(LF|RF|LR|RR)\s+/i;
const AIR_ITEM_RE =
  /^(Steer\s*\d*|Drive\s*\d+|Tag|Trailer\s*\d+)\s+(Left|Right)\s+/i;

function looksLikeCornerTitle(title: string | undefined | null): boolean {
  if (!title) return false;
  const t = title.toLowerCase();
  return (
    t.includes("corner grid") ||
    t.includes("tires & brakes") ||
    t.includes("tires and brakes") ||
    t.includes("air brake") ||
    t.includes("hydraulic brake")
  );
}

function stripExistingCornerGrids(sections: TemplateSection[]): TemplateSection[] {
  return sections.filter((s) => {
    if (looksLikeCornerTitle(s.title)) return false;

    const items = s.items ?? [];
    const looksHyd = items.some((it) => HYD_ITEM_RE.test(it.item || ""));
    const looksAir = items.some((it) => AIR_ITEM_RE.test(it.item || ""));
    return !(looksHyd || looksAir);
  });
}

function buildHydraulicCornerSection(): TemplateSection {
  const metrics: Array<{ label: string; unit: string | null }> = [
    { label: "Tire Pressure", unit: "psi" },
    { label: "Tire Tread", unit: "mm" },
    { label: "Brake Pad", unit: "mm" },
    { label: "Rotor", unit: "mm" },
    { label: "Rotor Condition", unit: null },
    { label: "Rotor Thickness", unit: "mm" },
    { label: "Wheel Torque", unit: "ft¬∑lb" },
  ];
  const corners = ["LF", "RF", "LR", "RR"];
  const items: TemplateSectionItem[] = [];
  for (const c of corners) {
    for (const m of metrics) {
      items.push({ item: `${c} ${m.label}`, unit: m.unit });
    }
  }
  return { title: "Corner Grid (Hydraulic)", items };
}

function buildAirCornerSection(): TemplateSection {
  const steer: TemplateSectionItem[] = [
    { item: "Steer 1 Left Tire Pressure", unit: "psi" },
    { item: "Steer 1 Right Tire Pressure", unit: "psi" },
    { item: "Steer 1 Left Tread Depth", unit: "mm" },
    { item: "Steer 1 Right Tread Depth", unit: "mm" },
    { item: "Steer 1 Left Lining/Shoe", unit: "mm" },
    { item: "Steer 1 Right Lining/Shoe", unit: "mm" },
    { item: "Steer 1 Left Drum/Rotor", unit: "mm" },
    { item: "Steer 1 Right Drum/Rotor", unit: "mm" },
    { item: "Steer 1 Left Push Rod Travel", unit: "in" },
    { item: "Steer 1 Right Push Rod Travel", unit: "in" },
  ];

  const drive: TemplateSectionItem[] = [
    { item: "Drive 1 Left Tire Pressure", unit: "psi" },
    { item: "Drive 1 Right Tire Pressure", unit: "psi" },
    { item: "Drive 1 Left Tread Depth (Outer)", unit: "mm" },
    { item: "Drive 1 Left Tread Depth (Inner)", unit: "mm" },
    { item: "Drive 1 Right Tread Depth (Outer)", unit: "mm" },
    { item: "Drive 1 Right Tread Depth (Inner)", unit: "mm" },
    { item: "Drive 1 Left Lining/Shoe", unit: "mm" },
    { item: "Drive 1 Right Lining/Shoe", unit: "mm" },
    { item: "Drive 1 Left Drum/Rotor", unit: "mm" },
    { item: "Drive 1 Right Drum/Rotor", unit: "mm" },
    { item: "Drive 1 Left Push Rod Travel", unit: "in" },
    { item: "Drive 1 Right Push Rod Travel", unit: "in" },
  ];

  return { title: "Corner Grid (Air)", items: [...steer, ...drive] };
}

function prepareSectionsWithCornerGrid(
  sections: TemplateSection[],
  vehicleType: string | null | undefined,
  gridParam: string | null,
): TemplateSection[] {
  const s = Array.isArray(sections) ? sections : [];

  const hasCornerByTitle = s.some((sec) => looksLikeCornerTitle(sec.title));
  if (hasCornerByTitle) {
    return s;
  }

  const withoutGrids = stripExistingCornerGrids(s);
  const gridMode = (gridParam || "").toLowerCase(); // air | hyd | none | ""

  if (gridMode === "none") return withoutGrids;

  let injectAir: boolean;
  if (gridMode === "air" || gridMode === "hyd") {
    injectAir = gridMode === "air";
  } else {
    const vt = (vehicleType || "").toLowerCase();
    injectAir = vt === "truck" || vt === "bus" || vt === "trailer";
  }

  const injected = injectAir
    ? buildAirCornerSection()
    : buildHydraulicCornerSection();

  return [injected, ...withoutGrids];
}

/* ---------------------------- Badges ---------------------------- */

type KnownStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded border px-2 py-0.5 text-xs font-medium";

const BADGE: Record<KnownStatus, string> = {
  awaiting_approval: "bg-blue-900/20 border-blue-500/40 text-blue-300",
  awaiting: "bg-sky-900/20 border-sky-500/40 text-sky-300",
  queued: "bg-indigo-900/20 border-indigo-500/40 text-indigo-300",
  in_progress: "bg-orange-900/20 border-orange-500/40 text-orange-300",
  on_hold: "bg-amber-900/20 border-amber-500/40 text-amber-300",
  planned: "bg-purple-900/20 border-purple-500/40 text-purple-300",
  new: "bg-neutral-800 border-neutral-600 text-neutral-200",
  completed: "bg-green-900/20 border-green-500/40 text-green-300",
  ready_to_invoice: "bg-emerald-900/20 border-emerald-500/40 text-emerald-300",
  invoiced: "bg-teal-900/20 border-teal-500/40 text-teal-300",
};

const chip = (s: string | null | undefined): string => {
  const key = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_") as KnownStatus;
  return `${BASE_BADGE} ${BADGE[key] ?? BADGE.awaiting}`;
};

// roles allowed to assign jobs
const ASSIGN_ROLES = new Set(["owner", "admin", "manager", "advisor"]);

// roles allowed to approve / decline
const APPROVAL_ROLES = new Set([
  "owner",
  "admin",
  "manager",
  "advisor",
  "lead_hand",
  "lead",
  "leadhand",
]);

/* ------------------------------------------------------------------------- */

export default function WorkOrderIdClient(): JSX.Element {
  const params = useParams();
  const routeId = (params?.id as string) || "";

  const [wo, setWo] = useTabState<WorkOrder | null>("wo:id:wo", null);
  const [lines, setLines] = useTabState<WorkOrderLine[]>("wo:id:lines", []);
  const [quoteLines, setQuoteLines] = useTabState<WorkOrderQuoteLine[]>(
    "wo:id:quoteLines",
    [],
  );
  const [vehicle, setVehicle] = useTabState<Vehicle | null>("wo:id:veh", null);
  const [customer, setCustomer] = useTabState<Customer | null>("wo:id:cust", null);

  const [allocsByLine, setAllocsByLine] = useState<Record<string, AllocationRow[]>>({});
  const [loading, setLoading] = useState<boolean>(false);
  const [viewError, setViewError] = useState<string | null>(null);

  const [currentUserId, setCurrentUserId] = useTabState<string | null>("wo:id:uid", null);
  const [, setUserId] = useTabState<string | null>("wo:id:effectiveUid", null);
  const [currentUserRole, setCurrentUserRole] = useState<string | null>(null);

  const [showDetails, setShowDetails] = useTabState<boolean>("wo:showDetails", true);
  const [focusedJobId, setFocusedJobId] = useState<string | null>(null);
  const [focusedOpen, setFocusedOpen] = useState(false);
  const [warnedMissing, setWarnedMissing] = useState(false);

  // parts
  const [partsLineId, setPartsLineId] = useState<string | null>(null);
  const [bulkQueue, setBulkQueue] = useState<string[]>([]);
  const [bulkActive, setBulkActive] = useState<boolean>(false);

  // inspection
  const [inspectionOpen, setInspectionOpen] = useState(false);
  const [inspectionSrc, setInspectionSrc] = useState<string | null>(null);

  // assign mechanic
  const [assignOpen, setAssignOpen] = useState(false);
  const [assignLineId, setAssignLineId] = useState<string | null>(null);
  const [assignables, setAssignables] = useState<
    Array<Pick<Profile, "id" | "full_name" | "role">>
  >([]);

  // per-line technicians
  const [lineTechsByLine, setLineTechsByLine] = useState<Record<string, string[]>>({});

  /* ---------------------- AUTH + assignables ---------------------- */
  useEffect(() => {
    let mounted = true;

    const waitForSession = async () => {
      let {
        data: { session },
      } = await supabase.auth.getSession();

      if (!session) {
        for (let i = 0; i < 8; i++) {
          await new Promise((r) => setTimeout(r, 150 * (i + 1)));
          const res = await supabase.auth.getSession();
          session = res.data.session;
          if (session) break;
        }
      }

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!mounted) return;

      const uid = user?.id ?? null;
      setCurrentUserId(uid);
      setUserId(uid);

      if (uid) {
        const { data: prof } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", uid)
          .maybeSingle();
        setCurrentUserRole(prof?.role ?? null);
      }

      try {
        const res = await fetch("/api/assignables");
        const json = (await res.json().catch(() => null)) as
          | { data?: Array<Pick<Profile, "id" | "full_name" | "role">> }
          | null;
        if (res.ok && Array.isArray(json?.data)) {
          setAssignables(json.data);
        }
      } catch {
        // ignore
      }

      if (!uid) setLoading(false);
    };

    void waitForSession();

    const { data: sub } = supabase.auth.onAuthStateChange((_evt, s) => {
      if (s?.user) void waitForSession();
      else {
        setCurrentUserId(null);
        setUserId(null);
        setLoading(false);
      }
    });

    return () => {
      mounted = false;
      sub?.subscription?.unsubscribe?.();
    };
  }, [routeId, setCurrentUserId, setUserId]);

  /* ---------------------- FETCH ---------------------- */
  const fetchAll = useCallback(
    async (retry = 0) => {
      if (!routeId) return;
      setLoading(true);
      setViewError(null);

      try {
        let woRow: WorkOrder | null = null;

        // by UUID
        if (looksLikeUuid(routeId)) {
          const { data, error } = await supabase
            .from("work_orders")
            .select("*")
            .eq("id", routeId)
            .maybeSingle();
          if (!error) woRow = (data as WorkOrder | null) ?? null;
        }

        // by custom_id
        if (!woRow) {
          const eqRes = await supabase
            .from("work_orders")
            .select("*")
            .eq("custom_id", routeId)
            .maybeSingle();
          woRow = (eqRes.data as WorkOrder | null) ?? null;

          if (!woRow) {
            const ilikeRes = await supabase
              .from("work_orders")
              .select("*")
              .ilike("custom_id", routeId.toUpperCase())
              .maybeSingle();
            woRow = (ilikeRes.data as WorkOrder | null) ?? null;
          }

          if (!woRow) {
            const { prefix, n } = splitCustomId(routeId);
            if (n !== null) {
              const { data: cands } = await supabase
                .from("work_orders")
                .select("*")
                .ilike("custom_id", `${prefix}%`)
                .limit(50);
              const wanted = `${prefix}${n}`;
              const match = (cands ?? []).find(
                (r) =>
                  (r.custom_id ?? "")
                    .toUpperCase()
                    .replace(/^([A-Z]+)0+/, "$1") === wanted,
              );
              if (match) woRow = match as WorkOrder;
            }
          }
        }

        if (!woRow) {
          if (retry < 2) {
            await new Promise((r) => setTimeout(r, 200 * Math.pow(2, retry)));
            return fetchAll(retry + 1);
          }
          setViewError("Work order not visible / not found.");
          setWo(null);
          setLines([]);
          setQuoteLines([]);
          setVehicle(null);
          setCustomer(null);
          setAllocsByLine({});
          setLineTechsByLine({});
          setLoading(false);
          return;
        }

        setWo(woRow);

        if (!warnedMissing && (!woRow.vehicle_id || !woRow.customer_id)) {
          toast.error(
            "This work order is missing vehicle and/or customer. Open the Create form to set them.",
          );
          setWarnedMissing(true);
        }

        const [linesRes, quoteRes, vehRes, custRes] = await Promise.all([
          supabase
            .from("work_order_lines")
            .select("*")
            .eq("work_order_id", woRow.id)
            .order("created_at", { ascending: true }),
          supabase
            .from("work_order_quote_lines")
            .select("*")
            .eq("work_order_id", woRow.id)
            .order("created_at", { ascending: true }),
          woRow.vehicle_id
            ? supabase
                .from("vehicles")
                .select("*")
                .eq("id", woRow.vehicle_id)
                .maybeSingle()
            : Promise.resolve({ data: null, error: null } as const),
          woRow.customer_id
            ? supabase
                .from("customers")
                .select("*")
                .eq("id", woRow.customer_id)
                .maybeSingle()
            : Promise.resolve({ data: null, error: null } as const),
        ]);

        if (linesRes.error) throw linesRes.error;
        const lineRows = (linesRes.data ?? []) as WorkOrderLine[];
        setLines(lineRows);

        if (quoteRes.error) throw quoteRes.error;
        const quoteRows = (quoteRes.data ?? []) as WorkOrderQuoteLine[];
        setQuoteLines(quoteRows);

        if (vehRes?.error) throw vehRes.error;
        setVehicle((vehRes?.data as Vehicle | null) ?? null);

        if (custRes?.error) throw custRes.error;
        setCustomer((custRes?.data as Customer | null) ?? null);

        // allocations + line techs
        if (lineRows.length) {
          const [allocsQuery, lineTechsQuery] = await Promise.all([
            supabase
              .from("work_order_part_allocations")
              .select("*, parts(name)")
              .in(
                "work_order_line_id",
                lineRows.map((l) => l.id),
              ),
            supabase
              .from("work_order_line_technicians")
              .select("work_order_line_id, technician_id")
              .in(
                "work_order_line_id",
                lineRows.map((l) => l.id),
              ),
          ]);

          const byLine: Record<string, AllocationRow[]> = {};
          (allocsQuery.data ?? []).forEach((a) => {
            const row = a as AllocationRow;
            const key = row.work_order_line_id;
            if (!byLine[key]) byLine[key] = [];
            byLine[key].push(row);
          });
          setAllocsByLine(byLine);

          const techMap: Record<string, string[]> = {};
          (lineTechsQuery.data as LineTechRow[] | null)?.forEach((lt) => {
            const lnId = lt.work_order_line_id;
            const techId = lt.technician_id;
            if (!techMap[lnId]) techMap[lnId] = [];
            if (!techMap[lnId].includes(techId)) {
              techMap[lnId].push(techId);
            }
          });
          setLineTechsByLine(techMap);
        } else {
          setAllocsByLine({});
          setLineTechsByLine({});
        }
      } catch (e: unknown) {
        const msg =
          e instanceof Error ? e.message : "Failed to load work order.";
        setViewError(msg);
        // eslint-disable-next-line no-console
        console.error("[WO id page] load error:", e);
      } finally {
        setLoading(false);
      }
    },
    [
      routeId,
      warnedMissing,
      setWo,
      setLines,
      setQuoteLines,
      setVehicle,
      setCustomer,
    ],
  );

  useEffect(() => {
    if (!routeId || !currentUserId) return;
    void fetchAll();
  }, [fetchAll, routeId, currentUserId]);

  /* ---------------------- REALTIME ---------------------- */
  useEffect(() => {
    if (!wo?.id) return;

    const ch = supabase
      .channel(`wo:${wo.id}`)
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_orders", filter: `id=eq.${wo.id}` },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_part_allocations",
        },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_line_technicians",
        },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_quote_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => fetchAll(),
      )
      .subscribe();

    const local = () => fetchAll();
    window.addEventListener("wo:parts-used", local);

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        //
      }
      window.removeEventListener("wo:parts-used", local);
    };
  }, [wo?.id, fetchAll]);

  // ---------- listen for inspection finish ----------
  useEffect(() => {
    interface InspectionCompletedEventDetail {
      workOrderLineId?: string;
      cause?: string;
      correction?: string;
    }

    const handler = (ev: CustomEvent<InspectionCompletedEventDetail>) => {
      const d = ev.detail || {};
      const lineId = d.workOrderLineId;
      if (!lineId) return;

      setFocusedJobId(lineId);
      setFocusedOpen(true);

      window.dispatchEvent(
        new CustomEvent("wo:prefill-cause-correction", {
          detail: {
            lineId,
            cause: d.cause ?? "",
            correction: d.correction ?? "",
          },
        }),
      );
    };

    window.addEventListener("inspection:completed", handler as EventListener);
    return () => {
      window.removeEventListener("inspection:completed", handler as EventListener);
    };
  }, []);

  // üîÅ refresh this page when a parts request is submitted from the focused modal
  useEffect(() => {
    const handler = () => {
      void fetchAll();
    };
    window.addEventListener("parts-request:submitted", handler);
    return () => window.removeEventListener("parts-request:submitted", handler);
  }, [fetchAll]);

  /* ----------------------- Derived data ----------------------- */

  // simple map of active quote-lines per work_order_line
  const activeQuotesByLine = useMemo(() => {
    const m: Record<string, WorkOrderQuoteLine[]> = {};

    (quoteLines as WorkOrderQuoteLineWithLineId[]).forEach((q) => {
      const status = (q.status ?? "").toLowerCase();
      if (status === "converted" || status === "declined") return;

      const lineId = q.work_order_line_id ?? null;
      if (!lineId) return;

      if (!m[lineId]) m[lineId] = [];
      m[lineId].push(q);
    });

    return m;
  }, [quoteLines]);

  // lines that are already quoted & waiting on customer
  const approvalPending = useMemo(
    () => lines.filter((l) => (l.approval_state ?? null) === "pending"),
    [lines],
  );

  // lines that still need to be sent to parts for quoting
  const linesNeedingQuote = useMemo(
    () =>
      lines.filter((l) => {
        const approval = l.approval_state ?? null;
        const status = l.status ?? "awaiting";

        // skip items already in an approval state
        if (approval === "pending" || approval === "approved" || approval === "declined") {
          return false;
        }

        // skip completed / invoiced stuff
        if (
          status === "completed" ||
          status === "ready_to_invoice" ||
          status === "invoiced"
        ) {
          return false;
        }

        // skip if already on hold specifically for parts / quote
        const hold = (l.hold_reason ?? "").toLowerCase();
        if (
          status === "on_hold" &&
          (hold.includes("part") || hold.includes("quote"))
        ) {
          return false;
        }

        return true;
      }),
    [lines],
  );

  const activeJobLines = useMemo(
    () => lines.filter((l) => (l.approval_state ?? null) !== "pending"),
    [lines],
  );

  // Quote lines that are still in play (not converted/declined)
  const approvalPendingQuotes = useMemo(
    () =>
      quoteLines.filter((q) => {
        const status = (q.status ?? "").toLowerCase();
        return status !== "converted" && status !== "declined";
      }),
    [quoteLines],
  );

  const hasAnyApprovalItems =
    approvalPending.length > 0 || approvalPendingQuotes.length > 0;

  const sortedLines = useMemo(() => {
    const pr: Record<string, number> = {
      diagnosis: 1,
      inspection: 2,
      maintenance: 3,
      repair: 4,
    };
    return [...activeJobLines].sort((a, b) => {
      const pa = pr[String(a.job_type ?? "repair")] ?? 999;
      const pb = pr[String(b.job_type ?? "repair")] ?? 999;
      if (pa !== pb) return pa - pb;
      const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
      const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
      return ta - tb;
    });
  }, [activeJobLines]);

  const createdAt = wo?.created_at ? new Date(wo.created_at) : null;
  const createdAtText =
    createdAt && !Number.isNaN(createdAt.getTime())
      ? format(createdAt, "PPpp")
      : "‚Äî";

  const canAssign = currentUserRole ? ASSIGN_ROLES.has(currentUserRole) : false;
  const canApprove = currentUserRole ? APPROVAL_ROLES.has(currentUserRole) : false;

  const assignablesById = useMemo(() => {
    const m: Record<string, { full_name: string | null; role: string | null }> =
      {};
    assignables.forEach((a) => {
      m[a.id] = { full_name: a.full_name, role: a.role };
    });
    return m;
  }, [assignables]);

  type WorkOrderWaiterFlags = {
    is_waiter?: boolean | null;
    waiter?: boolean | null;
    customer_waiting?: boolean | null;
  };

  const waiterFlagSource: (WorkOrder & WorkOrderWaiterFlags) | null = wo
    ? (wo as WorkOrder & WorkOrderWaiterFlags)
    : null;

  const isWaiter =
    !!(
      waiterFlagSource &&
      (waiterFlagSource.is_waiter ||
        waiterFlagSource.waiter ||
        waiterFlagSource.customer_waiting)
    );

  /* ----------------------- line actions ----------------------- */

  // hook for parts-quoting actions
  const { sendAllPendingToParts } = useWorkOrderActions({
    // we want the bulk-quote button to operate on lines that *need* quoting,
    // so feed those into the hook
    approvalPending: linesNeedingQuote,
    setPartsLineId,
    setBulkQueue,
    setBulkActive,
  });

  const approveLine = useCallback(
    async (lineId: string) => {
      if (!lineId) return;

      // When approving a line that was on parts hold:
      // - mark approval_state approved
      // - move status to queued (ready to start)
      // - clear hold + punch timestamps so tech gets a fresh Start button
      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        approval_state: "approved",
        status: "queued",
        hold_reason: null,
        punched_in_at: null,
        punched_out_at: null,
      };

      const { data, error } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", lineId)
        .select("work_order_id")
        .maybeSingle();

      if (error) {
        toast.error(error.message);
        return;
      }

      const workOrderId =
        (data as Pick<WorkOrderLine, "work_order_id"> | null)?.work_order_id ??
        wo?.id ??
        null;

      if (workOrderId) {
        // If the work order was previously marked in_progress while waiting for parts,
        // move it back to queued to match the fact that no line is currently running.
        const { error: woErr } = await supabase
          .from("work_orders")
          .update({ status: "queued" } as DB["public"]["Tables"]["work_orders"]["Update"])
          .eq("id", workOrderId);

        if (woErr) {
          // eslint-disable-next-line no-console
          console.error(
            "[approveLine] failed to update work order status",
            woErr,
          );
        }
      }

      toast.success("Line approved");
      void fetchAll();
    },
    [fetchAll, wo?.id],
  );

  const declineLine = useCallback(
    async (lineId: string) => {
      if (!lineId) return;
      const { error } = await supabase
        .from("work_order_lines")
        .update({
          approval_state: "declined",
          status: "awaiting",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", lineId);
      if (error) return toast.error(error.message);
      toast.success("Line declined");
      void fetchAll();
    },
    [fetchAll],
  );

  const approveQuoteLine = useCallback(
    async (quoteId: string) => {
      if (!quoteId) return;
      try {
        const res = await fetch(`/api/work-orders/quotes/${quoteId}/authorize`, {
          method: "POST",
        });
        const j = (await res.json().catch(() => null)) as
          | { ok?: boolean; error?: string }
          | null;

        if (!res.ok || j?.error) {
          throw new Error(j?.error || "Failed to authorize quote");
        }

        toast.success("Quote authorized");
        void fetchAll();
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to authorize quote";
        toast.error(msg);
      }
    },
    [fetchAll],
  );

  const declineQuoteLine = useCallback(
    async (quoteId: string) => {
      if (!quoteId) return;
      const { error } = await supabase
        .from("work_order_quote_lines")
        .update({ status: "declined" })
        .eq("id", quoteId);
      if (error) {
        toast.error(error.message);
        return;
      }
      toast.success("Quote declined");
      void fetchAll();
    },
    [fetchAll],
  );

  // üîç open inspection ‚Äì fetch template, inject corner grid, stage to session, then open generic fill screen
  const openInspectionForLine = useCallback(
    async (ln: WorkOrderLine) => {
      if (!ln?.id) return;

      const anyLine = ln as WorkOrderLineWithInspectionMeta;
      const templateId = extractInspectionTemplateId(anyLine);

      if (!templateId) {
        toast.error(
          "This job line doesn't have an inspection template attached yet. Build or attach a custom inspection first.",
        );
        return;
      }

      // 1) Load the inspection template for this line
      const { data, error } = await supabase
        .from("inspection_templates")
        .select("template_name, sections, vehicle_type")
        .eq("id", templateId)
        .maybeSingle();

      if (error || !data) {
        toast.error("Unable to load inspection template.");
        return;
      }

      const rawSections = (data.sections ?? []) as TemplateSection[];
      const vehicleType = String(data.vehicle_type ?? "");
      const sections = prepareSectionsWithCornerGrid(
        rawSections,
        vehicleType,
        null, // no explicit ?grid override from here
      );

      const title = data.template_name ?? "Inspection";

      // 2) Stage into sessionStorage so GenericInspectionScreen can boot in the modal
      if (typeof window !== "undefined") {
        const paramsObj: Record<string, string> = {};

        if (wo?.id) paramsObj.workOrderId = wo.id;
        paramsObj.workOrderLineId = ln.id;
        paramsObj.view = "mobile";
        paramsObj.embed = "1";
        if (ln.description) paramsObj.seed = String(ln.description);

        // prefill customer / vehicle into params if available
        if (customer) {
          if (customer.first_name) paramsObj.first_name = customer.first_name;
          if (customer.last_name) paramsObj.last_name = customer.last_name;
          if (customer.phone) paramsObj.phone = customer.phone;
          if (customer.email) paramsObj.email = customer.email;
          if (customer.address) paramsObj.address = customer.address;
          if (customer.city) paramsObj.city = customer.city;
          if (customer.province) paramsObj.province = customer.province;
          if (customer.postal_code)
            paramsObj.postal_code = customer.postal_code;
        }

        if (vehicle) {
          if (vehicle.year != null)
            paramsObj.year = String(vehicle.year as string | number);
          if (vehicle.make) paramsObj.make = vehicle.make;
          if (vehicle.model) paramsObj.model = vehicle.model;
          if (vehicle.vin) paramsObj.vin = vehicle.vin;
          if (vehicle.license_plate)
            paramsObj.license_plate = vehicle.license_plate;
          if (vehicle.mileage != null)
            paramsObj.mileage = String(vehicle.mileage);
          if (vehicle.color) paramsObj.color = vehicle.color;
          if (vehicle.unit_number)
            paramsObj.unit_number = vehicle.unit_number;
          if (vehicle.engine_hours != null)
            paramsObj.engine_hours = String(vehicle.engine_hours);
        }

        sessionStorage.setItem("inspection:sections", JSON.stringify(sections));
        sessionStorage.setItem("inspection:title", title);
        sessionStorage.setItem("inspection:vehicleType", vehicleType);
        sessionStorage.setItem("inspection:template", "generic");
        sessionStorage.setItem("inspection:params", JSON.stringify(paramsObj));

        // Legacy keys for older flows
        sessionStorage.setItem(
          "customInspection:sections",
          JSON.stringify(sections),
        );
        sessionStorage.setItem("customInspection:title", title);
        sessionStorage.setItem(
          "customInspection:includeOil",
          JSON.stringify(false),
        );
      }

      // 3) Set src for the modal (mainly for debugging / template label)
      const sp = new URLSearchParams();
      sp.set("template", "generic");
      if (wo?.id) sp.set("workOrderId", wo.id);
      sp.set("workOrderLineId", ln.id);
      sp.set("embed", "1");
      sp.set("view", "mobile");
      if (ln.description) sp.set("seed", String(ln.description));

      const url = `/inspections/fill?${sp.toString()}`;

      setInspectionSrc(url);
      setInspectionOpen(true);
      toast.success("Inspection opened");
    },
    [wo?.id, customer, vehicle],
  );

  // parts drawer close / bulk
  useEffect(() => {
    if (!partsLineId) return;

    const evtName = `parts-drawer:closed:${partsLineId}`;

    const handler = () => {
      if (bulkActive && bulkQueue.length > 0) {
        const [, ...rest] = bulkQueue;
        setBulkQueue(rest);
        setPartsLineId(rest[0] ?? null);
        if (rest.length === 0) {
          setBulkActive(false);
          void fetchAll();
        }
      } else {
        setPartsLineId(null);
        void fetchAll();
      }
    };

    window.addEventListener(evtName, handler as EventListener);
    return () =>
      window.removeEventListener(evtName, handler as EventListener);
  }, [partsLineId, bulkActive, bulkQueue, fetchAll]);

  /* -------------------------- UI -------------------------- */
  if (!routeId)
    return <div className="p-6 text-red-500">Missing work order id.</div>;

  const Skeleton = ({ className = "" }: { className?: string }) => (
    <div className={`animate-pulse rounded-lg bg-muted ${className}`} />
  );

  return (
    <div className="w-full bg-background px-3 py-6 text-foreground sm:px-6 lg:px-10 xl:px-16">
      <VoiceContextSetter
        currentView="work_order_page"
        workOrderId={wo?.id}
        vehicleId={vehicle?.id}
        customerId={customer?.id}
        lineId={null}
      />

      <div className="mb-4 flex items-center justify-between gap-2">
        {/* Back now goes to previous page, with /work-orders as internal fallback */}
        <PreviousPageButton />
        {/* Internal ID pill removed */}
      </div>

      {!currentUserId && (
        <div className="mb-4 rounded-xl border border-amber-500/30 bg-amber-900/10 p-3 text-sm text-amber-100">
          You appear signed out on this tab. If actions fail, open{" "}
          <Link href="/sign-in" className="underline hover:text-white">
            Sign In
          </Link>{" "}
          and return here.
        </div>
      )}

      {viewError && (
        <div className="mb-4 whitespace-pre-wrap rounded-xl border border-red-500/40 bg-red-950/60 p-3 text-sm text-red-200">
          {viewError}
        </div>
      )}

      {loading ? (
        <div className="mt-6 grid gap-4">
          <Skeleton className="h-24" />
          <Skeleton className="h-40" />
          <Skeleton className="h-56" />
        </div>
      ) : !wo ? (
        <div className="mt-6 text-sm text-red-400">Work order not found.</div>
      ) : (
        <div className="space-y-6">
          {/* Header ‚Äì simplified, thinner border, full-width */}
          <div className="rounded-xl border border-white/18 bg-card/90 p-4 shadow-sm">
            <div className="flex flex-wrap items-center justify-between gap-3">
              <div className="space-y-1">
                <h1 className="text-xl font-semibold text-foreground sm:text-2xl">
                  Work Order{" "}
                  <span className="text-orange-400">
                    {wo.custom_id || `#${wo.id.slice(0, 8)}`}
                  </span>
                </h1>
                <p className="text-xs text-muted-foreground">
                  Created {createdAtText}
                </p>
              </div>

              <div className="flex items-center gap-3">
                <span className={chip(wo.status)}>
                  {(wo.status ?? "awaiting").replaceAll("_", " ")}
                </span>
                {isWaiter && (
                  <span
                    className="
                      inline-flex items-center whitespace-nowrap
                      rounded-full border border-red-500
                      bg-red-500/10
                      px-4 py-1.5
                      text-xs sm:text-sm font-semibold uppercase tracking-[0.16em]
                      text-red-200
                      shadow-[0_0_18px_rgba(248,113,113,0.9)]
                    "
                  >
                    Waiter
                  </span>
                )}
              </div>
            </div>
          </div>

          {/* Vehicle & Customer ‚Äì styled like the photo block */}
          <div className="rounded-xl border border-white/18 bg-card/90 p-4">
            <div className="flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold text-foreground sm:text-base">
                Vehicle &amp; Customer
              </h2>
              <button
                type="button"
                className="text-xs font-medium text-orange-400 hover:text-orange-300 hover:underline"
                onClick={() => setShowDetails((v) => !v)}
                aria-expanded={showDetails}
              >
                {showDetails ? "Hide details" : "Show details"}
              </button>
            </div>

            {showDetails && (
              <div className="mt-3 grid gap-4 sm:grid-cols-2">
                {/* Vehicle */}
                <div className="rounded-lg border border-white/12 bg-muted/70 p-3">
                  <h3 className="mb-1 text-xs font-semibold uppercase tracking-wide text-muted-foreground">
                    Vehicle
                  </h3>
                  {vehicle ? (
                    <>
                      <p className="text-sm font-medium text-foreground">
                        {(vehicle.year ?? "").toString()} {vehicle.make ?? ""}{" "}
                        {vehicle.model ?? ""}
                      </p>
                      <p className="mt-1 text-xs text-muted-foreground">
                        VIN:{" "}
                        <span className="font-mono">
                          {vehicle.vin ?? "‚Äî"}
                        </span>
                        <br />
                        Plate:{" "}
                        {vehicle.license_plate ?? (
                          <span className="text-muted-foreground">‚Äî</span>
                        )}
                        <br />
                        Mileage:{" "}
                        {vehicle.mileage
                          ? vehicle.mileage
                          : wo?.odometer_km != null
                          ? `${wo.odometer_km} km`
                          : "‚Äî"}
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-muted-foreground">
                      No vehicle linked yet.
                    </p>
                  )}
                </div>

                {/* Customer */}
                <div className="rounded-lg border border-white/12 bg-muted/70 p-3">
                  <h3 className="mb-1 text-xs font-semibold uppercase tracking-wide text-muted-foreground">
                    Customer
                  </h3>
                  {customer ? (
                    <>
                      <p className="text-sm font-medium text-foreground">
                        {[customer.first_name ?? "", customer.last_name ?? ""]
                          .filter(Boolean)
                          .join(" ") || "‚Äî"}
                      </p>
                      <p className="mt-1 text-xs text-muted-foreground">
                        {customer.phone ?? "‚Äî"}{" "}
                        {customer.email ? (
                          <>
                            <span className="mx-1 text-muted-foreground">‚Ä¢</span>
                            {customer.email}
                          </>
                        ) : null}
                      </p>
                      {customer.id && (
                        <Link
                          href={`/customers/${customer.id}`}
                          className="mt-2 inline-flex text-[11px] font-medium text-orange-400 hover:text-orange-300 hover:underline"
                          title="Open customer profile"
                        >
                          View customer profile ‚Üí
                        </Link>
                      )}
                    </>
                  ) : (
                    <p className="text-sm text-muted-foreground">
                      No customer linked yet.
                    </p>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Awaiting Customer Approval */}
          <div className="rounded-xl border border-white/18 bg-card/90 p-4">
            <div className="mb-3 flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold text-blue-200 sm:text-base">
                Awaiting customer approval
              </h2>
            </div>

            {!hasAnyApprovalItems ? (
              <p className="text-xs text-muted-foreground">
                No lines waiting for approval.
              </p>
            ) : (
              <>
                {approvalPending.length > 0 && (
                  <div className="space-y-2">
                    {approvalPending.map((ln, idx) => {
                      const isAwaitingPartsBase =
                        (ln.status === "on_hold" &&
                          (ln.hold_reason ?? "")
                            .toLowerCase()
                            .includes("part")) ||
                        (ln.hold_reason ?? "")
                          .toLowerCase()
                          .includes("quote");

                      const hasQuotedParts =
                        (activeQuotesByLine[ln.id] ?? []).length > 0;

                      const partsLabel = hasQuotedParts
                        ? "Quoted, awaiting approval"
                        : "Awaiting parts quote";

                      return (
                        <div
                          key={ln.id}
                          className="rounded-lg border border-white/12 bg-muted/70 p-3"
                        >
                          <div className="flex items-start justify-between gap-3">
                            <div className="min-w-0">
                              <div className="truncate text-sm font-medium text-foreground">
                                {idx + 1}.{" "}
                                {ln.description ||
                                  ln.complaint ||
                                  "Untitled job"}
                              </div>
                              <div className="mt-0.5 text-[11px] text-muted-foreground">
                                {String(ln.job_type ?? "job").replaceAll(
                                  "_",
                                  " ",
                                )}{" "}
                                ‚Ä¢{" "}
                                {typeof ln.labor_time === "number"
                                  ? `${ln.labor_time}h`
                                  : "‚Äî"}{" "}
                                ‚Ä¢ Status:{" "}
                                {(ln.status ?? "awaiting").replaceAll(
                                  "_",
                                  " ",
                                )}{" "}
                                ‚Ä¢ Approval:{" "}
                                {(ln.approval_state ?? "pending").replaceAll(
                                  "_",
                                  " ",
                                )}
                              </div>

                              {/* flag lines that are on hold for parts */}
                              {isAwaitingPartsBase && (
                                <div className="mt-1 inline-flex items-center rounded-full border border-blue-500/50 bg-blue-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-blue-200">
                                  {partsLabel}
                                </div>
                              )}

                              {ln.notes && (
                                <div className="mt-1 text-[11px] text-muted-foreground">
                                  Notes: {ln.notes}
                                </div>
                              )}
                            </div>

                            {canApprove && (
                              <div className="flex shrink-0 flex-wrap items-center gap-2">
                                <button
                                  type="button"
                                  className="rounded-md border border-green-700 px-2 py-1 text-[11px] font-medium text-green-200 hover:bg-green-900/25"
                                  onClick={() => approveLine(ln.id)}
                                >
                                  Approve
                                </button>
                                <button
                                  type="button"
                                  className="rounded-md border border-red-700 px-2 py-1 text-[11px] font-medium text-red-200 hover:bg-red-900/30"
                                  onClick={() => declineLine(ln.id)}
                                >
                                  Decline
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {approvalPendingQuotes.length > 0 && (
                  <div
                    className={
                      approvalPending.length > 0 ? "mt-4 space-y-2" : "space-y-2"
                    }
                  >
                    <div className="text-[11px] font-semibold uppercase tracking-wide text-blue-300">
                      Quote suggestions
                    </div>
                    {approvalPendingQuotes.map((q, idx) => (
                      <div
                        key={q.id}
                        className="rounded-lg border border-white/12 bg-muted/70 p-3"
                      >
                        <div className="flex items-start justify-between gap-3">
                          <div className="min-w-0">
                            <div className="truncate text-sm font-medium text-foreground">
                              {idx + 1}. {q.description || "Quoted item"}
                            </div>
                            <div className="mt-0.5 text-[11px] text-muted-foreground">
                              {String(q.job_type ?? "job").replaceAll(
                                "_",
                                " ",
                              )}{" "}
                              ‚Ä¢{" "}
                              {typeof q.est_labor_hours === "number"
                                ? `${q.est_labor_hours}h`
                                : "‚Äî"}{" "}
                              ‚Ä¢ Status:{" "}
                              {(q.status ?? "pending_parts").replaceAll(
                                "_",
                                " ",
                              )}
                            </div>
                            {q.notes && (
                              <div className="mt-1 text-[11px] text-muted-foreground">
                                Notes: {q.notes}
                              </div>
                            )}
                          </div>

                          {canApprove && (
                            <div className="flex shrink-0 flex-wrap items-center gap-2">
                              <button
                                type="button"
                                className="rounded-md border border-green-700 px-2 py-1 text-[11px] font-medium text-green-200 hover:bg-green-900/25"
                                onClick={() => approveQuoteLine(q.id)}
                              >
                                Approve
                              </button>
                              <button
                                type="button"
                                className="rounded-md border border-red-700 px-2 py-1 text-[11px] font-medium text-red-200 hover:bg-red-900/30"
                                onClick={() => declineQuoteLine(q.id)}
                              >
                                Decline
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </div>

          {/* Jobs list ‚Äì full width; JobCard handles its own status pills */}
          <div className="rounded-xl border border-white/18 bg-card/90 p-4">
            <div className="mb-3 flex items-center justify-between gap-2">
              <div>
                <h2 className="text-sm font-semibold text-foreground sm:text-base">
                  Jobs in this work order
                </h2>
                <p className="text-[11px] text-muted-foreground">
                  Tap a job to open the focused panel with full controls.
                </p>
              </div>

              {linesNeedingQuote.length > 0 && (
                <button
                  type="button"
                  className="rounded-md bg-blue-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-blue-500 disabled:opacity-60"
                  onClick={sendAllPendingToParts}
                  disabled={bulkActive}
                  title="Send all jobs to parts for quoting"
                >
                  Quote all lines
                </button>
              )}
            </div>

            {sortedLines.length === 0 ? (
              <p className="text-sm text-muted-foreground">No lines yet.</p>
            ) : (
              <div className="space-y-2">
                {sortedLines.map((ln, idx) => {
                  const punchedIn =
                    !!ln.punched_in_at && !ln.punched_out_at;

                  const partsForLine = allocsByLine[ln.id] ?? [];

                  const lineTechIds = lineTechsByLine[ln.id] ?? [];
                  const primaryId =
                    typeof ln.assigned_to === "string"
                      ? (ln.assigned_to as string)
                      : null;

                  const orderedTechIds: string[] = [];
                  if (primaryId) orderedTechIds.push(primaryId);
                  lineTechIds.forEach((tid) => {
                    if (!orderedTechIds.includes(tid)) {
                      orderedTechIds.push(tid);
                    }
                  });

                  const technicians = orderedTechIds.map((tid) => {
                    const info = assignablesById[tid];
                    return {
                      id: tid,
                      full_name: info?.full_name ?? null,
                      role: info?.role ?? null,
                    };
                  });

                  return (
                    <JobCard
                      key={ln.id}
                      index={idx}
                      line={ln}
                      parts={partsForLine}
                      technicians={technicians}
                      canAssign={canAssign}
                      isPunchedIn={punchedIn}
                      onOpen={() => {
                        setFocusedJobId(ln.id);
                        setFocusedOpen(true);
                      }}
                      onAssign={
                        canAssign
                          ? () => {
                              setAssignLineId(ln.id);
                              setAssignOpen(true);
                            }
                          : undefined
                      }
                      onOpenInspection={
                        ln.job_type === "inspection"
                          ? () => {
                              void openInspectionForLine(ln);
                            }
                          : undefined
                      }
                      onAddPart={() => {
                        setPartsLineId(ln.id);
                      }}
                    />
                  );
                })}
              </div>
            )}
          </div>

          {/* Suggested maintenance / quick add ‚Äì full-width card */}
          <div className="rounded-xl border border-white/18 bg-card/90 p-4 text-sm text-muted-foreground">
            <WorkOrderSuggestionsPanel
              workOrderId={wo.id}
              vehicleId={vehicle?.id ?? null}
              odometerKm={wo.odometer_km ?? null}
              onAdded={fetchAll}
            />
          </div>

          <div className="rounded-xl border border-white/18 bg-card/90 p-4 text-sm text-muted-foreground">
            <p>
              Select a job card above to open the focused job panel with full editing,
              punch and inspection controls.
            </p>
          </div>
        </div>
      )}

      {/* Vehicle photos */}
      {vehicle?.id && (
        <div className="mt-8 space-y-4">
          <h2 className="text-lg font-semibold text-foreground sm:text-xl">
            Vehicle photos
          </h2>
          <VehiclePhotoUploader vehicleId={vehicle.id} />
          <VehiclePhotoGallery
            vehicleId={vehicle.id}
            currentUserId={currentUserId || "anon"}
          />
        </div>
      )}

      {/* Focused job modal */}
      {focusedOpen && focusedJobId && (
        <FocusedJobModal
          isOpen={focusedOpen}
          onClose={() => setFocusedOpen(false)}
          workOrderLineId={focusedJobId}
          onChanged={fetchAll}
          mode="tech"
        />
      )}

      {/* Parts Drawer */}
      {partsLineId && wo?.id && (
        <PartsDrawer
          open={!!partsLineId}
          workOrderId={wo.id}
          workOrderLineId={partsLineId}
          vehicleSummary={
            vehicle
              ? {
                  year: (
                    vehicle.year as string | number | null
                  )?.toString() ?? null,
                  make: vehicle.make ?? null,
                  model: vehicle.model ?? null,
                }
              : null
          }
          jobDescription={
            lines.find((l) => l.id === partsLineId)?.description ??
            lines.find((l) => l.id === partsLineId)?.complaint ??
            null
          }
          jobNotes={
            lines.find((l) => l.id === partsLineId)?.notes ?? null
          }
          closeEventName={`parts-drawer:closed:${partsLineId}`}
        />
      )}

      {/* Inspection modal */}
      {inspectionOpen && inspectionSrc && (
        <InspectionModal
          open={inspectionOpen}
          src={inspectionSrc}
          title="Inspection"
          onClose={() => setInspectionOpen(false)}
        />
      )}

      {/* Assign mechanic modal */}
      {assignOpen && assignLineId && (
        <AssignTechModal
          isOpen={assignOpen}
          onClose={() => setAssignOpen(false)}
          workOrderLineId={assignLineId}
          mechanics={assignables}
          onAssigned={async () => {
            await fetchAll();
          }}
        />
      )}

      <VoiceButton />
    </div>
  );
}

========================================
FILE: app/work-orders/[id]/error.tsx
========================================
"use client";
export default function Error({ error, reset }: { error: unknown; reset: () => void }) {
  console.error("[wo/[id]] error boundary:", error);
  return (
    <div className="p-6">
      <h1 className="text-lg font-semibold text-red-400">Something went wrong</h1>
      <p className="mt-2 text-sm text-white/70">This page failed to load.</p>
      <button
        onClick={() => reset()}
        className="mt-4 rounded bg-orange-500 px-3 py-1.5 text-sm font-semibold text-black hover:bg-orange-400"
      >
        Try again
      </button>
    </div>
  );
}


========================================
FILE: app/work-orders/[id]/loading.tsx
========================================
export default function Loading() {
  return (
    <div className="p-6">
      <div className="h-6 w-40 animate-pulse rounded bg-neutral-800/60" />
      <div className="mt-4 grid gap-3">
        <div className="h-24 animate-pulse rounded bg-neutral-800/60" />
        <div className="h-24 animate-pulse rounded bg-neutral-800/60" />
      </div>
    </div>
  );
}


========================================
FILE: app/work-orders/[id]/page.tsx
========================================
// app/work-orders/[id]/page.tsx
import WorkOrderIdClient from "./Client";
export const dynamic = "force-dynamic";
export const revalidate = 0;

export default function Page() {
  return <WorkOrderIdClient />;
}

========================================
FILE: app/work-orders/page.tsx
========================================
// app/work-orders/page.tsx
export const dynamic = "force-dynamic";
export const revalidate = 0;

import { cookies } from "next/headers";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import type { Role } from "@shared/components/RoleHubTiles/tiles";
import { TILES } from "@shared/components/RoleHubTiles/tiles";
import Link from "next/link";
import PageShell from "@/features/shared/components/PageShell";

type DB = Database;

async function getUserRole(): Promise<Role | null> {
  const supabase = createServerComponentClient<DB>({ cookies });
  const {
    data: { user },
  } = await supabase.auth.getUser();
  if (!user) return null;

  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .maybeSingle();

  return (profile?.role as Role | null) ?? null;
}

export default async function WorkOrdersHome() {
  const role = await getUserRole();

  // only show tiles that are work_orders scope and role-allowed
  const workOrderTiles = TILES.filter((tile) => {
    const forWorkOrders = tile.scopes.includes("work_orders") || tile.scopes.includes("all");
    const roleAllowed = role ? tile.roles.includes(role) : false;
    return forWorkOrders && roleAllowed;
  });

  return (
    <PageShell
      title="Work Orders"
      description="Create, view, and manage jobs, quotes, and invoices."
    >
      {workOrderTiles.length === 0 ? (
        <div className="rounded border border-neutral-800 bg-neutral-950/60 p-4 text-sm text-neutral-300">
          No work-order actions available for your role.
        </div>
      ) : (
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {workOrderTiles.map((tile) => (
            <Link
              key={tile.href}
              href={tile.href}
              className="group rounded-lg border border-neutral-800 bg-neutral-950/60 px-4 py-4 transition hover:border-orange-400 hover:bg-neutral-900"
            >
              <div className="flex items-center justify-between gap-2">
                <h2 className="text-base font-semibold text-neutral-100">{tile.title}</h2>
                <span className="text-xs text-neutral-500 group-hover:text-orange-300">
                  {tile.cta ?? "‚Üí"}
                </span>
              </div>
              {tile.subtitle ? (
                <p className="mt-1 text-sm text-neutral-400">{tile.subtitle}</p>
              ) : null}
            </Link>
          ))}
        </div>
      )}
    </PageShell>
  );
}

========================================
FILE: app/work-orders/queue/page.tsx
========================================
// app/work-orders/queue/page.tsx
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/work-orders/app/work-orders/queue/page";

========================================
FILE: app/work-orders/quote-review/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/work-orders/app/work-orders/quote-review/page";


========================================
FILE: app/work-orders/state/useCustomerVehicleDraft.ts
========================================
"use client";

import { create } from "zustand";
import { persist, createJSONStorage } from "zustand/middleware";

export type SessionCustomer = {
  first_name: string | null;
  last_name: string | null;
  phone: string | null;
  email: string | null;
  address: string | null;
  city: string | null;
  province: string | null;
  postal_code: string | null;
};

export type SessionVehicle = {
  year: string | null;
  make: string | null;
  model: string | null;
  vin: string | null;
  license_plate: string | null;
  mileage: string | null;
  color: string | null;
  unit_number: string | null;
  engine_hours: string | null;
};

type DraftState = {
  customer: SessionCustomer;
  vehicle: SessionVehicle;
  setCustomerField: <K extends keyof SessionCustomer>(k: K, v: SessionCustomer[K]) => void;
  setVehicleField: <K extends keyof SessionVehicle>(k: K, v: SessionVehicle[K]) => void;
  bulkSet: (p: Partial<{ customer: Partial<SessionCustomer>; vehicle: Partial<SessionVehicle> }>) => void;
  reset: () => void;
};

const emptyCustomer: SessionCustomer = {
  first_name: null,
  last_name: null,
  phone: null,
  email: null,
  address: null,
  city: null,
  province: null,
  postal_code: null,
};

const emptyVehicle: SessionVehicle = {
  year: null,
  make: null,
  model: null,
  vin: null,
  license_plate: null,
  mileage: null,
  color: null,
  unit_number: null,
  engine_hours: null,
};

export const useCustomerVehicleDraft = create<DraftState>()(
  persist(
    (set) => ({
      customer: emptyCustomer,
      vehicle: emptyVehicle,
      setCustomerField: (k, v) => set((s) => ({ customer: { ...s.customer, [k]: v } })),
      setVehicleField: (k, v) => set((s) => ({ vehicle: { ...s.vehicle, [k]: v } })),
      bulkSet: (p) =>
        set((s) => ({
          customer: { ...s.customer, ...(p.customer ?? {}) },
          vehicle: { ...s.vehicle, ...(p.vehicle ?? {}) },
        })),
      reset: () => set({ customer: emptyCustomer, vehicle: emptyVehicle }),
    }),
    {
      name: "cv_draft_v1",
      storage: createJSONStorage(() => sessionStorage), // survives route changes in the same tab
      version: 1,
    }
  )
);

========================================
FILE: app/work-orders/state/useWorkOrderDraft.ts
========================================
"use client";
import { create } from "zustand";

type VehicleDraft = {
  vin?: string | null;
  year?: string | null;
  make?: string | null;
  model?: string | null;
  trim?: string | null;
  engine?: string | null;
  plate?: string | null;
};

type CustomerDraft = {
  first_name?: string | null;
  last_name?: string | null;
  phone?: string | null;
  email?: string | null;
};

type DraftState = {
  vehicle: VehicleDraft;
  customer: CustomerDraft;
  setVehicle: (v: Partial<VehicleDraft>) => void;
  setCustomer: (c: Partial<CustomerDraft>) => void;
  reset: () => void;
};

export const useWorkOrderDraft = create<DraftState>((set) => ({
  vehicle: {},
  customer: {},
  setVehicle: (v) =>
    set((state) => ({
      vehicle: { ...state.vehicle, ...v },
    })),
  setCustomer: (c) =>
    set((state) => ({
      customer: { ...state.customer, ...c },
    })),
  reset: () => set({ vehicle: {}, customer: {} }),
}));

========================================
FILE: app/work-orders/view/page.tsx
========================================
export const dynamic = "force-dynamic";
export const revalidate = 0;

export { default } from "@/features/work-orders/app/work-orders/view/page";


========================================
FILE: features/work-orders/api/fromInspection/from-inspection.ts
========================================
import type { NextApiRequest, NextApiResponse } from "next";
import { createPagesServerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

interface InspectionItem {
  name: string;
  status: string;
  recommend?: string;
  notes?: string;
}

interface InspectionSection {
  items: InspectionItem[];
}

interface InspectionResult {
  result: {
    sections: InspectionSection[];
  };
}

interface JobLine {
  work_order_id: string;
  job_type: string;
  name: string;
  status: string;
  labor_time?: number;
  notes?: string;
  recommendation?: string;
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse,
) {
  try {
    const { inspectionId, workOrderId, vehicleId } = req.body;

    if (!inspectionId || !workOrderId || !vehicleId) {
      return res.status(400).json({ error: "Missing required fields" });
    }

    // Create Supabase client bound to this request/response (keeps user session)
    const supabase = createPagesServerClient<Database>({ req, res });

    const inspectionRes = await fetch(
      `${process.env.NEXT_PUBLIC_BASE_URL}/api/inspections/${inspectionId}`,
    );
    if (!inspectionRes.ok) {
      return res.status(500).json({ error: "Failed to fetch inspection data" });
    }

    const inspection: InspectionResult = await inspectionRes.json();

    const jobsToInsert: JobLine[] = [];

    inspection.result.sections.forEach((section) => {
      section.items.forEach((item) => {
        if (item.status === "fail" || item.recommend) {
          jobsToInsert.push({
            work_order_id: workOrderId,
            job_type: "inspection-fail",
            name: item.name,
            recommendation: item.recommend || undefined,
            notes: item.notes || undefined,
            status: "not_started",
            labor_time: 0,
          });
        }
      });
    });

    if (jobsToInsert.length === 0) {
      return res
        .status(200)
        .json({ message: "No failed or recommended items found" });
    }

    const { error: insertError } = await supabase
      .from("work_order_lines")
      .insert(jobsToInsert);

    if (insertError) {
      console.error("Insert error:", insertError);
      return res.status(500).json({ error: "Failed to insert job lines" });
    }

    return res
      .status(200)
      .json({ success: true, inserted: jobsToInsert.length });
  } catch (err) {
    console.error("Handler error:", err);
    return res.status(500).json({ error: "Unexpected server error" });
  }
}

========================================
FILE: features/work-orders/api/fromInspection/route.ts
========================================
import { NextRequest, NextResponse } from "next/server";
import { insertPrioritizedJobsFromInspection } from "@work-orders/lib/work-orders/insertPrioritizedJobsFromInspection";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";
import type { Database } from "@shared/types/types/supabase";

type Body = {
  inspectionId: string;
  workOrderId: string;
  vehicleId: string;
};

export async function POST(req: NextRequest) {
  try {
    const { inspectionId, workOrderId, vehicleId } = (await req.json()) as Body;

    if (!inspectionId || !workOrderId || !vehicleId) {
      return NextResponse.json(
        { error: "Missing required fields" },
        { status: 400 },
      );
    }

    const supabase = createRouteHandlerClient<Database>({ cookies });

    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    await insertPrioritizedJobsFromInspection(
      inspectionId,
      workOrderId,
      vehicleId,
      user.id,
    );

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("Failed to insert jobs from inspection:", error);
    return NextResponse.json(
      { error: "Internal server error" },
      { status: 500 },
    );
  }
}

========================================
FILE: features/work-orders/api/update-status/create/route.ts
========================================
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
);

// Generate a unique readable WO number like WO-20250716-1234
function generateWorkOrderNumber(): string {
  const date = new Date();
  const yyyymmdd = date.toISOString().slice(0, 10).replace(/-/g, "");
  const random = Math.floor(1000 + Math.random() * 9000);
  return `WO-${yyyymmdd}-${random}`;
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const {
      customer_id,
      vehicle_id,
      inspection_id,
      type = "maintenance",
      complaint,
      appointment,
      shop_id,
    } = body;

    // ‚úÖ Validate required fields
    if (!customer_id || !vehicle_id || !type || !shop_id) {
      return NextResponse.json(
        { error: "Missing required fields" },
        { status: 400 },
      );
    }

    // ‚úÖ Validate type field
    const validTypes = ["inspection", "maintenance", "diagnosis"];
    if (!validTypes.includes(type)) {
      return NextResponse.json(
        {
          error: `Invalid work order type. Must be one of: ${validTypes.join(", ")}`,
        },
        { status: 400 },
      );
    }

    const workOrderNumber = generateWorkOrderNumber();

    const { data, error } = await supabase
      .from("work_orders")
      .insert({
        vehicle_id,
        inspection_id: inspection_id ?? null,
        customer_id,
        status: "queued",
        type,
        complaint: complaint ?? null,
        appointment: appointment ?? null,
        created_at: new Date().toISOString(),
        location: null,
        shop_id,
        number: workOrderNumber,
      })
      .select()
      .single();

    if (error) {
      console.error("‚ùå Supabase insert error:", error);
      return NextResponse.json(
        { error: "Failed to insert work order" },
        { status: 500 },
      );
    }

    console.log("‚úÖ Work order created:", data);

    return NextResponse.json({ success: true, workOrder: data });
  } catch (err) {
    console.error("‚ùå Unexpected error creating work order:", err);
    return NextResponse.json(
      { error: "Unexpected server error" },
      { status: 500 },
    );
  }
}


========================================
FILE: features/work-orders/api/update-status/[id]/route.ts
========================================
// app/api/workOrders/update-status/[id]/route.ts
// app/api/workOrders/update-status/[id]/route.ts

export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
);

export async function GET(request: NextRequest) {
  const url = new URL(request.url);
  const id = url.pathname.split("/").pop();

  if (!id) {
    return NextResponse.json({ error: "Missing ID" }, { status: 400 });
  }

  const { data, error } = await supabase
    .from("work_orders")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    console.error("Failed to fetch work order:", error);
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }

  return NextResponse.json(data);
}


========================================
FILE: features/work-orders/api/update-status/list/route.ts
========================================
export const runtime = "nodejs";

import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
);

export async function GET(_req: NextRequest) {
  try {
    const { data, error } = await supabase
      .from("work_orders")
      .select("*")
      .order("appointment", { ascending: true });

    if (error) throw error;

    return NextResponse.json({ orders: data });
  } catch (err) {
    console.error("Error fetching work orders:", err);
    return NextResponse.json(
      { error: "Failed to fetch work orders." },
      { status: 500 },
    );
  }
}


========================================
FILE: features/work-orders/api/update-status/route.ts
========================================
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
);

type Command = "punch-in" | "complete";

type QuoteLineItem = {
  name: string;
  description?: string;
  labor_time?: number;
  part_name?: string;
  part_price?: number;
  parts_cost?: number;
  total_price?: number;
};

interface RequestBody {
  workOrderId: string;
  command: Command;
  quote?: QuoteLineItem[];
  summary?: string;
}

export async function POST(req: NextRequest) {
  try {
    const body: RequestBody = await req.json();
    const { workOrderId, command, quote, summary } = body;

    if (!workOrderId || !command) {
      return NextResponse.json(
        { error: "Missing workOrderId or command" },
        { status: 400 },
      );
    }

    let updateFields: Partial<
      Database["public"]["Tables"]["work_orders"]["Update"]
    > = {};

    if (command === "punch-in") {
      updateFields = {
        status: "in_progress",
      };
    } else if (command === "complete") {
      updateFields = {
        status: "completed",
      };

      if (quote && summary) {
        updateFields.quote = {
          summary,
          items: quote,
        } as any; // keep if `quote` column is jsonb; remove `as any` if typed
      }
    } else {
      return NextResponse.json({ error: "Unknown command" }, { status: 400 });
    }

    const { error } = await supabase
      .from("work_orders")
      .update(updateFields)
      .eq("id", workOrderId);

    if (error) throw error;

    return NextResponse.json({ success: true, updated: updateFields });
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : String(err);
    console.error("Work order update failed:", message);
    return NextResponse.json({ error: "Update failed" }, { status: 500 });
  }
}

========================================
FILE: features/work-orders/app/work-orders/create/page.tsx
========================================
// features/work-orders/app/work-orders/create/page.tsx
"use client";

/**
 * Create Work Order (Front Desk)
 * ---------------------------------------------------------------------------
 * Integrated with VIN scanner + draft store.
 */

import {
  useCallback,
  useEffect,
  useMemo,
  useState,
} from "react";
import dynamic from "next/dynamic";
import { useRouter, useSearchParams } from "next/navigation";
import { v4 as uuidv4 } from "uuid";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { useTabState } from "@/features/shared/hooks/useTabState";
import { toast } from "sonner";

import VinCaptureModal from "app/vehicle/VinCaptureModal";
import { useWorkOrderDraft } from "app/work-orders/state/useWorkOrderDraft";
import { useCustomerVehicleDraft } from "app/work-orders/state/useCustomerVehicleDraft";

// UI
import CustomerVehicleForm from "@/features/inspections/components/inspection/CustomerVehicleForm";
import { MenuQuickAdd } from "@work-orders/components/MenuQuickAdd";
import { NewWorkOrderLineForm } from "@work-orders/components/NewWorkOrderLineForm";
import { AiSuggestModal } from "@work-orders/components/AiSuggestModal";

// üî¢ shared custom-id generator
import { generateWorkOrderCustomId } from "@/features/work-orders/lib/generateCustomId";

// Session types
import type {
  SessionCustomer,
  SessionVehicle,
} from "@/features/inspections/lib/inspection/types";

// üëá inspection modal, client-only
const InspectionModal = dynamic(
  () => import("@/features/inspections/components/InspectionModal"),
  { ssr: false },
);

/* =============================================================================
   Types & helpers
============================================================================= */
type DB = Database;
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderInsert = DB["public"]["Tables"]["work_orders"]["Insert"];
type LineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrderLine = LineRow;
type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];

type WOType = "inspection" | "maintenance" | "diagnosis";
type UploadSummary = { uploaded: number; failed: number };

// Extended line type so we can read template metadata safely
type WorkOrderLineWithInspectionMeta = LineRow & {
  inspection_template?: string | null;
  inspectionTemplate?: string | null;
  template?: string | null;
  inspection_template_id?: string | null;
  metadata?:
    | {
        inspection_template_id?: string | null;
        inspection_template?: string | null;
        template?: string | null;
        [key: string]: unknown;
      }
    | null;
};

const getStrField = (obj: unknown, key: string): string | null => {
  if (obj && typeof obj === "object") {
    const v = (obj as Record<string, unknown>)[key];
    if (typeof v === "string") return v.trim() || null;
    if (typeof v === "number") return String(v);
    if (v == null) return null;
  }
  return null;
};

const getMetaString = (meta: unknown, key: string): string | null => {
  if (!meta || typeof meta !== "object") return null;
  const v = (meta as Record<string, unknown>)[key];
  if (typeof v !== "string") return null;
  const t = v.trim();
  return t.length ? t : null;
};

const strOrNull = (v: string | null | undefined) => {
  const t = (v ?? "").trim();
  return t ? t : null;
};
const numOrNull = (v: string | number | null | undefined) => {
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  if (!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
};

/** Normalize ‚Äúwhere is the inspection template id stored for this line?‚Äù */
function extractInspectionTemplateId(
  ln: WorkOrderLineWithInspectionMeta,
): string | null {
  return (
    ln.inspection_template_id ??
    ln.inspection_template ??
    ln.inspectionTemplate ??
    ln.template ??
    getMetaString(ln.metadata, "inspection_template_id") ??
    getMetaString(ln.metadata, "inspection_template") ??
    getMetaString(ln.metadata, "template") ??
    null
  );
}

export default function CreateWorkOrderPage() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  useEffect(() => {
    (window as unknown as Record<string, unknown>)._sb = supabase;
  }, [supabase]);

  // Prefill ids from URL
  const [prefillVehicleId, setPrefillVehicleId] = useTabState<string | null>(
    "prefillVehicleId",
    null,
  );
  const [prefillCustomerId, setPrefillCustomerId] = useTabState<string | null>(
    "prefillCustomerId",
    null,
  );

  // Keep state (not shown in UI now)
  const [, setSourceFlags] = useTabState("__create_sources", {
    queryVehicle: false,
    queryCustomer: false,
    autoWO: false,
  } as {
    queryVehicle: boolean;
    queryCustomer: boolean;
    autoWO: boolean;
  });

  // Session-shaped state
  const defaultCustomer: SessionCustomer = {
    first_name: null,
    last_name: null,
    phone: null,
    email: null,
    address: null,
    city: null,
    province: null,
    postal_code: null,
  };
  const defaultVehicle: SessionVehicle = {
    year: null,
    make: null,
    model: null,
    vin: null,
    license_plate: null,
    mileage: null,
    color: null,
    unit_number: null,
    engine_hours: null,
  };

  const [customer, setCustomer] = useTabState<SessionCustomer>(
    "__cv_customer",
    defaultCustomer,
  );
  const [vehicle, setVehicle] = useTabState<SessionVehicle>(
    "__cv_vehicle",
    defaultVehicle,
  );

  // CV draft (session persisted)
  const cvDraft = useCustomerVehicleDraft();

  // Hydrate from CV draft on first load (only fill empty fields)
  useEffect(() => {
    const d = cvDraft;
    if (!d) return;

    const hasDraftCust = Object.values(d.customer || {}).some(Boolean);
    const hasDraftVeh = Object.values(d.vehicle || {}).some(Boolean);

    if (hasDraftCust) {
      setCustomer((prev) => ({
        ...prev,
        ...Object.fromEntries(
          Object.entries(d.customer).map(([k, v]) => [
            k as keyof SessionCustomer,
            (prev as any)[k] ?? v ?? null,
          ]),
        ),
      }));
    }
    if (hasDraftVeh) {
      setVehicle((prev) => ({
        ...prev,
        vin: d.vehicle.vin ?? prev.vin,
        year: d.vehicle.year ?? prev.year,
        make: d.vehicle.make ?? prev.make,
        model: d.vehicle.model ?? prev.model,
        license_plate:
          // support both new `license_plate` and legacy `plate` fields
          (d.vehicle as any).license_plate ??
          (d.vehicle as any).plate ??
          prev.license_plate,
      }));
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // once

  const onCustomerChange = (
    field: keyof SessionCustomer | "business_name",
    value: string | null,
  ) => {
    if (field === "business_name") {
      // store extra field alongside SessionCustomer shape
      setCustomer((c) => ({ ...(c as any), business_name: value } as any));
      cvDraft.setCustomerField(field as any, value);
    } else {
      setCustomer((c) => ({ ...c, [field]: value }));
      cvDraft.setCustomerField(field as any, value);
    }
  };

  const onVehicleChange = (
    field: keyof SessionVehicle,
    value: string | null,
  ) => {
    setVehicle((v) => ({ ...v, [field]: value }));
    cvDraft.setVehicleField(field as any, value);
  };

  // Captured ids
  const [customerId, setCustomerId] = useTabState<string | null>(
    "customerId",
    null,
  );
  const [vehicleId, setVehicleId] = useTabState<string | null>(
    "vehicleId",
    null,
  );

  // Work order + lines
  const [wo, setWo] = useTabState<WorkOrderRow | null>("__create_wo", null);
  const [lines, setLines] = useTabState<LineRow[]>("__create_lines", []);

  // ‚úÖ inspection modal state
  const [inspectionOpen, setInspectionOpen] = useState(false);
  const [inspectionSrc, setInspectionSrc] = useState<string | null>(null);

  // ‚úÖ AI suggest modal state
  const [aiSuggestOpen, setAiSuggestOpen] = useState(false);

  // Defaults / notes
  const [type, setType] = useTabState<WOType>("type", "maintenance");
  const [notes, setNotes] = useTabState("notes", "");
  // üëá work order priority (1 urgent ‚Üí 4 low). default 3 = normal
  const [priority, setPriority] = useTabState<number>("priority", 3);
  // üëá waiter flag (customer waiting on-site)
  const [isWaiter, setIsWaiter] = useTabState<boolean>("is_waiter", false);

  // Uploads
  const [photoFiles, setPhotoFiles] = useState<File[]>([]);
  const [docFiles, setDocFiles] = useState<File[]>([]);
  const [uploadSummary, setUploadSummary] = useState<UploadSummary | null>(
    null,
  );

  // UI state
  const [loading, setLoading] = useTabState("loading", false);
  const [error, setError] = useTabState("error", "");
  const [inviteNotice, setInviteNotice] =
    useTabState<string>("inviteNotice", "");
  const [sendInvite, setSendInvite] = useTabState<boolean>("sendInvite", false);

  // Current user id (for VIN modal)
  const [currentUserId, setCurrentUserId] = useState<string | null>(null);

  // read profile.shop_id early so autocomplete is scoped before WO exists
  const [currentShopId, setCurrentShopId] = useState<string | null>(null);
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user?.id) return;

      let shop: string | null = null;
      const byUserId = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (byUserId.data?.shop_id) {
        shop = byUserId.data.shop_id;
      } else {
        const byId = await supabase
          .from("profiles")
          .select("shop_id")
          .eq("id", user.id)
          .maybeSingle();
        shop = byId.data?.shop_id ?? null;
      }

      setCurrentShopId(shop);
    })();
  }, [supabase]);

  // VIN / OCR draft hydration
  const draft = useWorkOrderDraft();
  useEffect(() => {
    const hasVeh = Object.values(draft.vehicle || {}).some((v) => v);
    const hasCust = Object.values(draft.customer || {}).some((v) => v);

    if (hasVeh) {
      setVehicle((prev) => ({
        ...prev,
        vin: draft.vehicle.vin ?? prev.vin,
        year: draft.vehicle.year ?? prev.year,
        make: draft.vehicle.make ?? prev.make,
        model: draft.vehicle.model ?? prev.model,
        license_plate:
          (draft.vehicle as any).license_plate ??
          (draft.vehicle as any).plate ??
          prev.license_plate,
      }));
    }
    if (hasCust) {
      setCustomer((prev) => ({
        ...prev,
        first_name: draft.customer.first_name ?? prev.first_name,
        last_name: draft.customer.last_name ?? prev.last_name,
        phone: draft.customer.phone ?? prev.phone,
        email: draft.customer.email ?? prev.email,
      }));
    }

    if (hasVeh || hasCust) {
      setSourceFlags((s) => ({
        ...s,
        queryVehicle: s.queryVehicle || hasVeh,
        queryCustomer: s.queryCustomer || hasCust,
      }));
      draft.reset();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // keep waiter state in sync with an existing WO (editing case)
  useEffect(() => {
    if (!wo) return;
    const flag = (wo as any).is_waiter ?? false;
    setIsWaiter(Boolean(flag));
  }, [wo, setIsWaiter]);

  // get current user id (for VIN modal)
  useEffect((): void => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      setCurrentUserId(user?.id ?? null);
    })();
  }, [supabase]);

  async function getOrLinkShopId(userId: string): Promise<string | null> {
    // 1) try to read the profile we actually have (id = auth user id)
    const { data: profileById, error: profErr } = await supabase
      .from("profiles")
      .select("shop_id")
      .eq("id", userId)
      .maybeSingle();

    if (profErr) throw profErr;
    if (profileById?.shop_id) {
      return profileById.shop_id;
    }

    // 2) no shop on profile ‚Üí see if this user owns a shop
    const { data: ownedShop, error: shopErr } = await supabase
      .from("shops")
      .select("id")
      .eq("owner_id", userId)
      .maybeSingle();

    if (shopErr) throw shopErr;
    if (!ownedShop?.id) {
      // nothing to link
      return null;
    }

    // 3) write it back to profile so future calls are fast
    const { error: updErr } = await supabase
      .from("profiles")
      .update({ shop_id: ownedShop.id })
      .eq("id", userId);

    if (updErr) throw updErr;

    return ownedShop.id;
  }

  const buildCustomerInsert = (c: SessionCustomer, shopId: string | null) => ({
    business_name: strOrNull((c as any).business_name ?? null),
    first_name: strOrNull(c.first_name),
    last_name: strOrNull(c.last_name),
    phone: strOrNull(c.phone),
    email: strOrNull(c.email),
    address: strOrNull(c.address),
    city: strOrNull(c.city),
    province: strOrNull(c.province),
    postal_code: strOrNull(c.postal_code),
    shop_id: shopId,
  });

  const buildVehicleInsert = (
    v: SessionVehicle,
    customerId: string,
    shopId: string | null,
  ) => ({
    customer_id: customerId,
    vin: strOrNull(v.vin),
    year: numOrNull(v.year),
    make: strOrNull(v.make),
    model: strOrNull(v.model),
    license_plate: strOrNull(v.license_plate),
    mileage: strOrNull(v.mileage),
    unit_number: strOrNull(v.unit_number),
    color: strOrNull(v.color),
    engine_hours: numOrNull(v.engine_hours),
    shop_id: shopId,
  });

  // helper to hydrate customer state from DB row (including business_name when present)
  const hydrateCustomerFromRow = (row: any): SessionCustomer => {
    const base: any = {
      first_name: row.first_name ?? null,
      last_name: row.last_name ?? null,
      phone: getStrField(row, "phone"),
      email: row.email ?? null,
      address: getStrField(row, "address"),
      city: getStrField(row, "city"),
      province: getStrField(row, "province"),
      postal_code: getStrField(row, "postal_code"),
    };
    if (row.business_name) {
      base.business_name = row.business_name;
    }
    return base as SessionCustomer;
  };

  // Read query params (prefill)
  useEffect(() => {
    const v = searchParams.get("vehicleId");
    const c = searchParams.get("customerId");
    if (v) {
      setPrefillVehicleId(v);
      setSourceFlags((s) => ({ ...s, queryVehicle: true }));
    }
    if (c) {
      setPrefillCustomerId(c);
      setSourceFlags((s) => ({ ...s, queryCustomer: true }));
    }
  }, [searchParams, setPrefillVehicleId, setPrefillCustomerId, setSourceFlags]);

  // Prefill from DB ‚Üí session shapes
  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        if (prefillCustomerId) {
          const { data } = await supabase
            .from("customers")
            .select("*")
            .eq("id", prefillCustomerId)
            .single();
          if (!cancelled && data) {
            setCustomer(hydrateCustomerFromRow(data));
            setCustomerId(data.id);
          }
        }
        if (prefillVehicleId) {
          const { data } = await supabase
            .from("vehicles")
            .select(
              "id, vin, year, make, model, license_plate, mileage, unit_number, color, engine_hours, customer_id",
            )
            .eq("id", prefillVehicleId)
            .single();
          if (!cancelled && data) {
            setVehicle({
              vin: data.vin ?? null,
              year: data.year != null ? String(data.year) : null,
              make: data.make ?? null,
              model: data.model ?? null,
              license_plate: data.license_plate ?? null,
              mileage: getStrField(data, "mileage"),
              unit_number: getStrField(data, "unit_number"),
              color: getStrField(data, "color"),
              engine_hours:
                data.engine_hours != null ? String(data.engine_hours) : null,
            });
            setVehicleId(data.id);

            if (!customerId && data.customer_id) {
              const { data: cust } = await supabase
                .from("customers")
                .select("*")
                .eq("id", data.customer_id)
                .maybeSingle();
              if (cust) {
                setCustomer(hydrateCustomerFromRow(cust));
                setCustomerId(cust.id);
              }
            }
          }
        }
      } catch {
        // noop
      }
    })();
    return () => {
      cancelled = true;
    };
  }, [
    prefillCustomerId,
    prefillVehicleId,
    supabase,
    setCustomer,
    setVehicle,
    setCustomerId,
    setVehicleId,
    customerId,
  ]);

  // Ensure / create: Customer & Vehicle
  async function ensureCustomer(shopId: string): Promise<CustomerRow> {
    if (customerId) {
      const { data } = await supabase
        .from("customers")
        .select("*")
        .eq("id", customerId)
        .single();
      if (data) return data;
    }

    let q = supabase.from("customers").select("*").eq("shop_id", shopId).limit(1);
    if (customer.phone) q = q.ilike("phone", customer.phone);
    else if (customer.email) q = q.ilike("email", customer.email);
    const { data: found } = await q;
    if (found?.length) {
      setCustomerId(found[0].id);
      return found[0];
    }

    const { data: inserted, error: insErr } = await supabase
      .from("customers")
      .insert(buildCustomerInsert(customer, shopId))
      .select("*")
      .single();
    if (insErr || !inserted)
      throw new Error(insErr?.message ?? "Failed to create customer");
    setCustomerId(inserted.id);
    return inserted;
  }

  async function ensureVehicleRow(
    cust: CustomerRow,
    shopId: string | null,
  ): Promise<VehicleRow> {
    if (vehicleId) {
      const { data } = await supabase
        .from("vehicles")
        .select("*")
        .eq("id", vehicleId)
        .single();
      if (data) return data;
    }
    const orParts = [
      vehicle.vin ? `vin.eq.${vehicle.vin}` : "",
      vehicle.license_plate ? `license_plate.eq.${vehicle.license_plate}` : "",
    ].filter(Boolean);
    if (orParts.length) {
      const { data: maybe } = await supabase
        .from("vehicles")
        .select("*")
        .eq("customer_id", cust.id)
        .or(orParts.join(","));
      if (maybe?.length) {
        setVehicleId(maybe[0].id);
        return maybe[0] as VehicleRow;
      }
    }

    const { data: inserted, error: insErr } = await supabase
      .from("vehicles")
      .insert(buildVehicleInsert(vehicle, cust.id, shopId))
      .select("*")
      .single();
    if (insErr || !inserted)
      throw new Error(insErr?.message ?? "Failed to create vehicle");
    setVehicleId(inserted.id);
    return inserted as VehicleRow;
  }

  // Save & Continue (creates/links WO right away)
  const [savingCv, setSavingCv] = useState(false);
  const fetchLines = useCallback(async () => {
    if (!wo?.id) return;
    const { data } = await supabase
      .from("work_order_lines")
      .select("*")
      .eq("work_order_id", wo.id)
      .order("created_at", { ascending: true });
    setLines(data ?? []);
  }, [supabase, wo?.id, setLines]);

  const handleSaveCustomerVehicle = useCallback(async () => {
    if (savingCv) return;
    setSavingCv(true);
    setError("");

    try {
      if (!customer.first_name && !customer.phone && !customer.email) {
        throw new Error(
          "Please enter at least a name, phone, or email for the customer.",
        );
      }

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user?.id) throw new Error("Not signed in.");
      const shopId = await getOrLinkShopId(user.id);
      if (!shopId) throw new Error("Your profile isn‚Äôt linked to a shop yet.");

      const cust = await ensureCustomer(shopId);
      const veh = await ensureVehicleRow(cust, shopId);

      cvDraft.bulkSet({
        customer: {
          first_name: cust.first_name ?? null,
          last_name: cust.last_name ?? null,
          phone: customer.phone ?? null,
          email: cust.email ?? null,
          address: customer.address ?? null,
          city: customer.city ?? null,
          province: customer.province ?? null,
          postal_code: customer.postal_code ?? null,
          // business_name is optional, lives in draft as any if supported
          ...(cust as any).business_name
            ? { business_name: (cust as any).business_name }
            : {},
        } as any,
        vehicle: {
          vin: veh.vin ?? null,
          year: veh.year != null ? String(veh.year) : null,
          make: veh.make ?? null,
          model: veh.model ?? null,
          license_plate: veh.license_plate ?? null,
          mileage: (veh.mileage as string | null) ?? vehicle.mileage ?? null,
          unit_number: vehicle.unit_number ?? null,
          color: veh.color ?? null,
          engine_hours: vehicle.engine_hours ?? null,
        },
      });

      if (wo?.id) {
        if (wo.customer_id !== cust.id || wo.vehicle_id !== veh.id) {
          const { data: updated, error: updErr } = await supabase
            .from("work_orders")
            .update({
              customer_id: cust.id,
              vehicle_id: veh.id,
              // keep existing waiter flag when editing
              ...(typeof (wo as any).is_waiter !== "undefined"
                ? { is_waiter: (wo as any).is_waiter }
                : {}),
            } as any)
            .eq("id", wo.id)
            .select("*")
            .single();
          if (updErr) throw updErr;
          setWo(updated);
        }
        await fetchLines();
        return;
      }

      // üîë Only here do we create a new work order now
      const customId = await generateWorkOrderCustomId(supabase, cust.id);
      const newId = uuidv4();

      const insertPayload: WorkOrderInsert = {
        id: newId,
        custom_id: customId ?? null,
        vehicle_id: veh.id,
        customer_id: cust.id,
        notes: strOrNull(notes),
        user_id: user.id,
        shop_id: shopId,
        status: "awaiting_approval",
        priority: priority,
      };

      // waiter flag ‚Äì stored on work_orders.is_waiter (typed via any)
      (insertPayload as any).is_waiter = isWaiter;

      const { data: inserted, error: insertWOError } = await supabase
        .from("work_orders")
        .insert(insertPayload as any)
        .select("*")
        .single();
      if (insertWOError || !inserted)
        throw new Error(insertWOError?.message || "Failed to create work order.");

      setWo(inserted);
      await fetchLines();
    } catch (e) {
      const msg =
        e instanceof Error ? e.message : "Failed to save customer/vehicle.";
      setError(msg);
    } finally {
      setSavingCv(false);
    }
  }, [
    savingCv,
    supabase,
    wo?.id,
    notes,
    customer,
    fetchLines,
    cvDraft,
    vehicle,
    priority,
    isWaiter,
    wo,
  ]);

  // Clear form
  const handleClearForm = useCallback(() => {
    setCustomer(defaultCustomer as any); // clears known fields; extra ones like business_name drop to undefined
    setVehicle(defaultVehicle);
    setCustomerId(null);
    setVehicleId(null);
    setPrefillCustomerId(null);
    setPrefillVehicleId(null);
    setPhotoFiles([]);
    setDocFiles([]);
    setUploadSummary(null);
    setInviteNotice("");
    setSendInvite(false);
    setIsWaiter(false);
    cvDraft.reset();
  }, [
    setCustomer,
    setVehicle,
    setCustomerId,
    setVehicleId,
    setPrefillCustomerId,
    setPrefillVehicleId,
    setPhotoFiles,
    setDocFiles,
    setUploadSummary,
    setInviteNotice,
    setSendInvite,
    setIsWaiter,
    cvDraft,
  ]);

  // Upload helpers
  async function uploadVehicleFiles(vId: string): Promise<UploadSummary> {
    let uploaded = 0,
      failed = 0;
    const {
      data: { user },
    } = await supabase.auth.getUser();
    const uploader = user?.id ?? null;
    const currentShopIdForMedia = wo?.shop_id ?? null;

    const upOne = async (
      bucket: "vehicle-photos" | "vehicle-docs",
      f: File,
      mediaType: "photo" | "document",
    ) => {
      const key = `veh_${vId}/${Date.now()}_${f.name}`;
      const up = await supabase.storage.from(bucket).upload(key, f, {
        upsert: false,
      });
      if (up.error) {
        failed += 1;
        return;
      }
      const { error: rowErr } = await supabase.from("vehicle_media").insert({
        vehicle_id: vId,
        type: mediaType,
        storage_path: key,
        uploaded_by: uploader,
        shop_id: currentShopIdForMedia,
      });
      if (rowErr) failed += 1;
      else uploaded += 1;
    };

    for (const f of photoFiles) await upOne("vehicle-photos", f, "photo");
    for (const f of docFiles) await upOne("vehicle-docs", f, "document");
    return { uploaded, failed };
  }

  const handleDeleteLine = useCallback(
    async (lineId: string) => {
      if (!wo?.id) return;

      const ok = confirm("Delete this line?");
      if (!ok) return;

      try {
        const q = supabase
          .from("work_order_lines")
          .delete()
          .eq("id", lineId)
          .eq("work_order_id", wo.id);

        if (wo.shop_id) (q as any).eq("shop_id", wo.shop_id);

        const { data: deleted, error } = await (q as any)
          .select("id")
          .maybeSingle();

        if (error) {
          alert(error.message || "Delete failed");
          return;
        }
        if (!deleted) {
          alert(
            "Could not delete the line (no matching row). Check permissions/policies.",
          );
          return;
        }

        setLines((prev) => prev.filter((l) => l.id !== lineId));
        await fetchLines();
      } catch (err) {
        const msg = err instanceof Error ? err.message : "Delete failed";
        alert(msg);
      }
    },
    [supabase, wo?.id, wo?.shop_id, fetchLines, setLines],
  );

  // üîç open inspection ‚Äì reuse generic /inspections/run loader so corner grids & sections match Templates page
  const openInspectionForLine = useCallback(
    async (ln: WorkOrderLine) => {
      if (!ln?.id) return;

      const anyLine = ln as WorkOrderLineWithInspectionMeta;
      const templateId = extractInspectionTemplateId(anyLine);

      if (!templateId) {
        toast.error(
          "This job line doesn't have an inspection template attached yet. Build or attach a custom inspection first.",
        );
        return;
      }

      const sp = new URLSearchParams();

      if (wo?.id) sp.set("workOrderId", wo.id);
      sp.set("workOrderLineId", ln.id);
      sp.set("templateId", templateId);
      sp.set("embed", "1"); // so GenericInspectionScreen knows it's in a modal
      sp.set("view", "mobile"); // mobile voice controls

      if (ln.description) {
        sp.set("seed", String(ln.description));
      }

      const url = `/inspections/run?${sp.toString()}`;

      setInspectionSrc(url);
      setInspectionOpen(true);
      toast.success("Inspection opened");
    },
    [wo?.id],
  );

  // Submit ‚Üí Review & Sign
  async function handleSubmit(e: React.FormEvent<HTMLFormElement>) {
    e.preventDefault();
    if (loading) return;
    setLoading(true);
    setError("");
    setInviteNotice("");
    setUploadSummary(null);

    try {
      // Make sure customer & vehicle (and WO) are persisted first
      await handleSaveCustomerVehicle();

      const woId = wo?.id;
      if (!woId) throw new Error("Could not create work order.");

      const { data: latest, error: latestErr } = await supabase
        .from("work_orders")
        .select("id, custom_id, customer_id, vehicle_id, is_waiter")
        .eq("id", woId)
        .maybeSingle();

      if (latestErr) throw latestErr;
      if (!latest?.customer_id || !latest?.vehicle_id) {
        throw new Error("Please link a customer and vehicle first.");
      }

      if (vehicleId && (photoFiles.length || docFiles.length)) {
        const summary = await uploadVehicleFiles(vehicleId);
        setUploadSummary(summary);
      }

      if (sendInvite && customer.email) {
        try {
          const origin =
            typeof window !== "undefined"
              ? window.location.origin
              : (process.env.NEXT_PUBLIC_SITE_URL || "").replace(/\/$/, "");
          const portalUrl = `${
            origin || "https://profixiq.com"
          }/portal/auth/sign-up?email=${encodeURIComponent(customer.email)}`;
          const { error: fnErr } = await supabase.functions.invoke(
            "send-portal-invite",
            {
              body: {
                email: customer.email,
                customer_id: latest.customer_id,
                portal_url: portalUrl,
              },
            },
          );
          if (fnErr)
            setInviteNotice(
              "Work order created. Failed to send invite email (logged).",
            );
          else
            setInviteNotice(
              "Work order created. Invite email queued to the customer.",
            );
        } catch {
          setInviteNotice(
            "Work order created. Failed to send invite email (caught).",
          );
        }
      }

      router.push(`/work-orders/${latest.id}/approve`);
    } catch (ex) {
      const message =
        ex instanceof Error ? ex.message : "Failed to create work order.";
      setError(message);
    } finally {
      setLoading(false);
    }
  }

  // Realtime line refresh
  useEffect(() => {
    if (!wo?.id) return;
    void fetchLines();
    const ch = supabase
      .channel(`create-wo:${wo.id}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => fetchLines(),
      )
      .subscribe();
    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        /* noop */
      }
    };
  }, [supabase, wo?.id, fetchLines]);

  useEffect(() => {
    const h = () => {
      void fetchLines();
    };
    window.addEventListener("wo:line-added", h);
    return () => window.removeEventListener("wo:line-added", h);
  }, [fetchLines]);

  // Vehicle label for AI modal context
  const vehicleLabel =
    (vehicle.year || vehicle.make || vehicle.model)
      ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${
          vehicle.model ?? ""
        }`.trim()
      : vehicle.license_plate
      ? `Plate ${vehicle.license_plate}`
      : null;

  /* UI */
  return (
    <div className="relative min-h-[calc(100vh-4rem)] px-4 py-6 text-white">
      {/* radial wash similar to Service Menu page */}
      <div
        aria-hidden
        className="pointer-events-none absolute inset-0 -z-10 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)]"
      />

      <div className="mx-auto max-w-6xl space-y-6">
        {/* Header card ‚Äì matches Menu header vibe */}
        <section className="metal-card mb-2 flex items-center justify-between gap-4 rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-gradient-to-r from-black/85 via-slate-950/95 to-black/85 px-5 py-4 shadow-[0_22px_45px_rgba(0,0,0,0.9)] backdrop-blur-xl">
          <div>
            <h1
              className="text-2xl font-semibold text-white"
              style={{ fontFamily: "var(--font-blackops), system-ui" }}
            >
              Create Work Order
            </h1>
            <p className="mt-1 text-sm text-neutral-400">
              Link a customer and vehicle, add jobs and inspections, then send
              to approval and signature.
            </p>
            {wo?.custom_id && (
              <p className="mt-1 text-xs text-neutral-500">
                Current WO:{" "}
                <span className="font-mono text-orange-300">
                  {wo.custom_id}
                </span>
              </p>
            )}
          </div>
          <button
            type="button"
            onClick={() => router.back()}
            className="rounded-full border border-[color:var(--metal-border-soft,#1f2937)] bg-black/70 px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] text-neutral-200 shadow-[0_10px_24px_rgba(0,0,0,0.85)] hover:bg:white/5"
          >
            Back to list
          </button>
        </section>

        {/* Main metal card with form */}
        <section className="metal-card rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-black/65 px-4 py-5 shadow-[0_24px_80px_rgba(0,0,0,0.95)] backdrop-blur-xl sm:px-6 sm:py-6">
          {error && (
            <div className="mb-4 rounded-lg border border-red-500/60 bg-red-950/70 px-4 py-2 text-sm text-red-100">
              {error}
            </div>
          )}

          {uploadSummary && (
            <div className="mb-4 rounded-lg border border-neutral-700 bg-black/60 px-4 py-2 text-sm text-neutral-100">
              Uploaded {uploadSummary.uploaded} file(s)
              {uploadSummary.failed ? `, ${uploadSummary.failed} failed` : ""}.
            </div>
          )}
          {inviteNotice && (
            <div className="mb-4 rounded-lg border border-neutral-700 bg-black/60 px-4 py-2 text-sm text-neutral-100">
              {inviteNotice}
            </div>
          )}

          <form onSubmit={handleSubmit} className="space-y-6">
            {/* Customer & Vehicle */}
            <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
              <h2 className="mb-3 text-xs font-semibold uppercase tracking-[0.2em] text-neutral-400">
                Customer &amp; Vehicle
              </h2>

              <CustomerVehicleForm
                customer={customer}
                vehicle={vehicle}
                saving={savingCv}
                workOrderExists={!!wo?.id}
                shopId={wo?.shop_id ?? currentShopId}
                handlers={{
                  onCustomerChange,
                  onVehicleChange,
                  onCustomerSelected: (id: string) => setCustomerId(id),
                  onVehicleSelected: (id: string) => setVehicleId(id),
                }}
              />

              {/* Local buttons row */}
              <div className="mt-3 flex flex-wrap items-center gap-2">
                <button
                  type="button"
                  onClick={handleSaveCustomerVehicle}
                  disabled={savingCv || loading}
                  className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1.5 text-xs sm:text-sm font-medium uppercase tracking-[0.16em] text-neutral-100 hover:border-orange-500 hover:bg-black/80 disabled:opacity-60"
                >
                  {savingCv ? "Saving‚Ä¶" : "Save & Continue"}
                </button>

                <button
                  type="button"
                  onClick={handleClearForm}
                  className="rounded-full border border-red-600/70 bg-black/70 px-3 py-1.5 text-xs sm:text-sm font-medium uppercase tracking-[0.16em] text-red-200 hover:bg-red-900/30"
                >
                  Clear form
                </button>

                <VinCaptureModal
                  userId={currentUserId ?? "anon"}
                  action="/api/vin"
                  onDecoded={(d) => {
                    // 1) push into transient VIN draft store
                    draft.setVehicle({
                      vin: d.vin,
                      year: d.year ?? null,
                      make: d.make ?? null,
                      model: d.model ?? null,
                      engine: d.engine ?? null,
                      fuel_type: d.fuelType ?? null,
                      drivetrain: d.driveType ?? null,
                      transmission: d.transmission ?? null,
                    } as any);

                    // 2) hydrate the visible form state
                    setVehicle((prev) =>
                      ({
                        ...prev,
                        vin: d.vin || prev.vin,
                        year: d.year ?? prev.year,
                        make: d.make ?? prev.make,
                        model: d.model ?? prev.model,
                        engine:
                          d.engine ??
                          (prev as any).engine ??
                          null,
                        fuel_type:
                          d.fuelType ??
                          (prev as any).fuel_type ??
                          null,
                        drivetrain:
                          d.driveType ??
                          (prev as any).drivetrain ??
                          null,
                        transmission:
                          d.transmission ??
                          (prev as any).transmission ??
                          null,
                      } as any),
                    );

                    // 3) persist into CV draft
                    cvDraft.bulkSet({
                      vehicle: {
                        vin: d.vin ?? null,
                        year: d.year ?? null,
                        make: d.make ?? null,
                        model: d.model ?? null,
                        engine: d.engine ?? null,
                        fuel_type: d.fuelType ?? null,
                        drivetrain: d.driveType ?? null,
                        transmission: d.transmission ?? null,
                      } as any,
                    });
                  }}
                >
                  <span className="cursor-pointer rounded-full border border-orange-500/80 bg-black/70 px-3 py-1.5 text-xs text-orange-300 hover:bg-orange-500/10 sm:text-sm">
                    Add by VIN / Scan
                  </span>
                </VinCaptureModal>
              </div>

              <label className="mt-3 flex items-center gap-2 text-xs text-neutral-300">
                <input
                  id="send-invite"
                  type="checkbox"
                  checked={sendInvite}
                  onChange={(e) => setSendInvite(e.target.checked)}
                  className="h-4 w-4 rounded border-neutral-700 bg-neutral-900"
                  disabled={loading}
                />
                Email a customer portal sign-up link
              </label>
            </section>

            {/* Uploads */}
            <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
              <h2 className="mb-3 text-sm font-semibold text-neutral-100">
                Uploads
              </h2>
              <div className="grid gap-3 md:grid-cols-2">
                <div>
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Vehicle Photos
                  </label>
                  <input
                    type="file"
                    accept="image/*"
                    multiple
                    onChange={(e) =>
                      setPhotoFiles(Array.from(e.target.files ?? []))
                    }
                    className="input"
                    disabled={loading}
                  />
                </div>
                <div>
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Documents (PDF/JPG/PNG)
                  </label>
                  <input
                    type="file"
                    accept="application/pdf,image/*"
                    multiple
                    onChange={(e) =>
                      setDocFiles(Array.from(e.target.files ?? []))
                    }
                    className="input"
                    disabled={loading}
                  />
                </div>
              </div>
            </section>

            {/* Quick add from menu */}
            {wo?.id && (
              <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
                <h2 className="mb-3 text-sm font-semibold text-orange-300">
                  Quick add from menu
                </h2>
                <MenuQuickAdd workOrderId={wo.id} />
              </section>
            )}

            {/* Manual add line */}
            {wo?.id && (
              <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
                <h2 className="mb-3 text-sm font-semibold text-neutral-100">
                  Add Job Line
                </h2>
                <NewWorkOrderLineForm
                  workOrderId={wo.id}
                  vehicleId={vehicleId}
                  defaultJobType={type}
                  shopId={wo.shop_id ?? null}
                  onCreated={fetchLines}
                />
              </section>
            )}

            {/* Current Lines */}
            <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
              <div className="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <h2 className="text-sm font-semibold text-neutral-100">
                  Current lines
                </h2>
                {wo?.id && (
                  <button
                    type="button"
                    onClick={() => setAiSuggestOpen(true)}
                    className="inline-flex items-center rounded-full border border-blue-600 bg-black/70 px-3 py-1.5 text-xs sm:text-sm text-blue-300 hover:bg-blue-900/30"
                  >
                    AI: Suggest jobs
                  </button>
                )}
              </div>
              {!wo?.id || lines.length === 0 ? (
                <p className="text-sm text-neutral-400">No lines yet.</p>
              ) : (
                <div className="space-y-2">
                  {lines.map((ln) => (
                    <div
                      key={ln.id}
                      className="flex flex-col gap-3 rounded-xl border border-neutral-800 bg-neutral-950/80 p-3 sm:flex-row sm:items-start sm:justify-between"
                    >
                      <div className="min-w-0">
                        <div className="truncate font-medium">
                          {ln.description || ln.complaint || "Untitled job"}
                        </div>
                        <div className="text-xs text-neutral-400">
                          {String(ln.job_type ?? "job").replaceAll("_", " ")} ‚Ä¢{" "}
                          {typeof ln.labor_time === "number"
                            ? `${ln.labor_time}h`
                            : "‚Äî"}{" "}
                          ‚Ä¢ {(ln.status ?? "awaiting").replaceAll("_", " ")}
                        </div>
                        {(ln.complaint || ln.cause || ln.correction) && (
                          <div className="mt-1 text-xs text-neutral-500">
                            {ln.complaint ? `Cmpl: ${ln.complaint}  ` : ""}
                            {ln.cause ? `| Cause: ${ln.cause}  ` : ""}
                            {ln.correction ? `| Corr: ${ln.correction}` : ""}
                          </div>
                        )}
                      </div>
                      <div className="flex gap-2">
                        {ln.job_type === "inspection" && (
                          <button
                            type="button"
                            onClick={() => openInspectionForLine(ln)}
                            className="rounded border border-orange-500 px-2 py-1 text-xs text-orange-200 hover:bg-orange-500/10"
                          >
                            Open inspection
                          </button>
                        )}
                        <button
                          type="button"
                          onClick={() => handleDeleteLine(ln.id)}
                          className="rounded border border-red-600 px-2 py-1 text-xs text-red-300 hover:bg-red-900/20"
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </section>

            {/* Work Order defaults / options */}
            <section className="rounded-2xl border border-[var(--metal-border-soft)] bg-black/55 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.9)] sm:p-5">
              <h2 className="mb-3 text-sm font-semibold text-neutral-100">
                Work order options
              </h2>
              <div className="grid gap-3 md:grid-cols-3">
                <div>
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Default job type
                  </label>
                  <select
                    value={type}
                    onChange={(e) => setType(e.target.value as WOType)}
                    className="input"
                    disabled={loading}
                  >
                    <option value="maintenance">Maintenance</option>
                    <option value="diagnosis">Diagnosis</option>
                    <option value="inspection">Inspection</option>
                  </select>
                  <p className="mt-1 text-[11px] text-neutral-500">
                    Sets the default for new lines you add on this work order.
                  </p>
                </div>
                <div>
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Priority
                  </label>
                  <select
                    value={priority}
                    onChange={(e) => setPriority(Number(e.target.value))}
                    className="input"
                    disabled={loading}
                  >
                    <option value={1}>Urgent</option>
                    <option value={2}>High</option>
                    <option value={3}>Normal</option>
                    <option value={4}>Low</option>
                  </select>
                  <p className="mt-1 text-[11px] text-neutral-500">
                    Used to highlight urgent jobs in queues and dashboards.
                  </p>
                </div>
                <div>
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Customer waiting (waiter)
                  </label>
                  <select
                    value={isWaiter ? "waiter" : "dropoff"}
                    onChange={(e) => setIsWaiter(e.target.value === "waiter")}
                    className="input"
                    disabled={loading}
                  >
                    <option value="dropoff">Drop-off / not waiting</option>
                    <option value="waiter">Customer waiting (waiter)</option>
                  </select>
                  <p className="mt-1 text-[11px] text-neutral-500">
                    When set to waiter, the work order will show a{" "}
                    <span className="font-semibold">WAITING</span> status
                    badge.
                  </p>
                </div>
                <div className="md:col-span-3">
                  <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
                    Notes
                  </label>
                  <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    className="input"
                    rows={3}
                    placeholder="Optional notes for technician"
                    disabled={loading}
                  />
                </div>
              </div>
            </section>

            {/* Submit */}
            <div className="flex flex-wrap items-center gap-3">
              <button
                type="submit"
                disabled={loading}
                className="rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-5 py-2 text-sm font-semibold uppercase tracking-[0.2em] text-black shadow-[0_0_24px_rgba(212,118,49,0.7)] hover:brightness-110 disabled:opacity-60"
              >
                {loading ? "Creating..." : "Approve & Sign"}
              </button>
              <button
                type="button"
                onClick={() => router.push("/work-orders")}
                className="text-sm text-neutral-400 hover:text:white"
                disabled={loading}
              >
                Cancel
              </button>
            </div>
          </form>

          {/* üëá inspection modal lives here */}
          {inspectionOpen && inspectionSrc && (
            <InspectionModal
              open={inspectionOpen}
              src={inspectionSrc}
              title="Inspection"
              onClose={() => setInspectionOpen(false)}
            />
          )}

          {/* üëá AI Suggest modal lives here */}
          {wo?.id && (
            <AiSuggestModal
              open={aiSuggestOpen}
              onClose={() => setAiSuggestOpen(false)}
              workOrderId={wo.id}
              vehicleId={vehicleId}
              vehicleLabel={vehicleLabel}
              onAdded={() => {
                void fetchLines();
              }}
            />
          )}
        </section>
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/app/work-orders/editor/page.tsx
========================================
// features/work-orders/app/work-orders/editor/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type MenuItem = DB["public"]["Tables"]["menu_items"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];

type LineDraft = {
  complaint: string;
  cause?: string;
  correction?: string;
  labor_time?: number;
  tools?: string;
  status?:
    | "unassigned"
    | "assigned"
    | "awaiting"
    | "in_progress"
    | "on_hold"
    | "completed";
  hold_reason?: "parts" | "authorization" | "diagnosis_pending" | "other" | "";
  job_type?: "maintenance" | "diagnosis" | "inspection";
};

export default function WorkOrderEditorPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [menuItems, setMenuItems] = useState<MenuItem[]>([]);
  const [query, setQuery] = useState("");
  const [filtered, setFiltered] = useState<MenuItem[]>([]);

  // drafts composed in the editor
  const [lines, setLines] = useState<LineDraft[]>([
    { complaint: "", status: "awaiting", job_type: "maintenance" },
  ]);

  // pick a work order to save into
  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);
  const [selectedWOId, setSelectedWOId] = useState<string>("");

  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string>("");
  const [ok, setOk] = useState<string>("");

  // Load recent WOs for the user‚Äôs shop + menu items for the user
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!user?.id) return;

      // Pull recent WOs for the user‚Äôs shop
      const { data: prof } = await supabase
        .from("profiles")
        .select("shop_id")
        .eq("id", user.id)
        .maybeSingle();

      if (prof?.shop_id) {
        const since = new Date();
        since.setDate(since.getDate() - 60);

        const { data: wos } = await supabase
          .from("work_orders")
          .select("*")
          .eq("shop_id", prof.shop_id)
          .gte("created_at", since.toISOString())
          .order("created_at", { ascending: false });

        setWorkOrders(wos ?? []);
      }

      // User‚Äôs menu items
      const { data: items } = await supabase
        .from("menu_items")
        .select("*")
        .eq("user_id", user.id)
        .order("created_at", { ascending: false });

      setMenuItems(items ?? []);
    })();
  }, [supabase]);

  useEffect(() => {
    const q = query.trim().toLowerCase();
    if (q.length > 1) {
      setFiltered(
        menuItems.filter((mi) =>
          (mi.name ?? mi.complaint ?? "").toLowerCase().includes(q),
        ),
      );
    } else {
      setFiltered([]);
    }
  }, [query, menuItems]);

  function updateLine(i: number, patch: Partial<LineDraft>) {
    setLines((prev) => {
      const copy = [...prev];
      copy[i] = { ...copy[i], ...patch };
      return copy;
    });
  }

  function addEmptyLine() {
    setLines((prev) => [
      ...prev,
      { complaint: "", status: "awaiting", job_type: "maintenance" },
    ]);
  }

  function removeLine(i: number) {
    setLines((prev) => prev.filter((_, idx) => idx !== i));
  }

  function addFromMenu(mi: MenuItem) {
    setLines((prev) => [
      ...prev,
      {
        complaint: mi.complaint ?? mi.name ?? "",
        cause: mi.cause ?? undefined,
        correction: mi.correction ?? undefined,
        labor_time: mi.labor_time ?? undefined,
        tools: mi.tools ?? undefined,
        status: "awaiting",
        job_type: "maintenance",
      },
    ]);
    setQuery("");
    setFiltered([]);
  }

  async function saveToWorkOrder() {
    setError("");
    setOk("");

    if (!selectedWOId) {
      setError("Please select a work order to save into.");
      return;
    }

    // fetch the WO to pick up vehicle_id
    const { data: wo } = await supabase
      .from("work_orders")
      .select("id, vehicle_id")
      .eq("id", selectedWOId)
      .maybeSingle();

    if (!wo) {
      setError("Selected work order not found.");
      return;
    }

    const {
      data: { user },
    } = await supabase.auth.getUser();
    const userId = user?.id ?? null;

    const payload = lines
      .filter((l) => (l.complaint || l.correction || l.cause || l.tools || l.labor_time))
      .map((l) => ({
        work_order_id: wo.id,
        vehicle_id: wo.vehicle_id ?? null,
        user_id: userId,
        complaint: l.complaint || null,
        cause: l.cause || null,
        correction: l.correction || null,
        tools: l.tools || null,
        labor_time: typeof l.labor_time === "number" ? l.labor_time : null,
        status: (l.status ?? "awaiting") as DB["public"]["Tables"]["work_order_lines"]["Row"]["status"],
        hold_reason: (l.hold_reason ?? null) as DB["public"]["Tables"]["work_order_lines"]["Row"]["hold_reason"],
        job_type: (l.job_type ?? null) as DB["public"]["Tables"]["work_order_lines"]["Row"]["job_type"],
      }));

    if (payload.length === 0) {
      setError("Add at least one non-empty line.");
      return;
    }

    setSaving(true);
    const { error: insErr } = await supabase.from("work_order_lines").insert(payload);
    setSaving(false);

    if (insErr) {
      setError(insErr.message);
      return;
    }
    setOk(`Saved ${payload.length} line(s) to WO ${selectedWOId.slice(0, 8)}.`);
  }

  return (
    <div className="mx-auto max-w-4xl p-6 text-white">
      <h1 className="text-2xl font-bold mb-4">Work Order Editor</h1>

      {/* Pick a target WO */}
      <div className="rounded border border-neutral-800 bg-neutral-900 p-4 mb-6">
        <label className="block text-sm text-neutral-300 mb-1">Save to Work Order</label>
        <select
          value={selectedWOId}
          onChange={(e) => setSelectedWOId(e.target.value)}
          className="w-full rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
        >
          <option value="">‚Äî Select a recent Work Order ‚Äî</option>
          {workOrders.map((wo) => (
            <option key={wo.id} value={wo.id}>
              {wo.id.slice(0, 8)} ‚Ä¢ {wo.type ?? "wo"} ‚Ä¢ {new Date(wo.created_at!).toLocaleString()}
            </option>
          ))}
        </select>
        <p className="mt-2 text-xs text-neutral-400">
          Tip: Create a new work order first from ‚ÄúCreate Work Order‚Äù, then compose lines here and save into it.
        </p>
      </div>

      {/* Quick menu suggestions */}
      <div className="rounded border border-neutral-800 bg-neutral-900 p-4 mb-6">
        <label className="block text-sm text-neutral-300 mb-1">Quick Add from Menu</label>
        <input
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          placeholder="Search your saved menu items"
          className="w-full rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
        />
        {filtered.length > 0 && (
          <ul className="mt-2 max-h-48 overflow-auto rounded border border-neutral-800 bg-neutral-950">
            {filtered.map((mi) => (
              <li
                key={mi.id}
                className="px-3 py-2 text-sm hover:bg-neutral-800 cursor-pointer"
                onClick={() => addFromMenu(mi)}
              >
                {(mi.name ?? mi.complaint ?? "Untitled")}{" "}
                {typeof mi.labor_time === "number" ? `‚Ä¢ ${mi.labor_time}h` : ""}
              </li>
            ))}
          </ul>
        )}
      </div>

      {/* Line editor */}
      <div className="space-y-4">
        {lines.map((ln, idx) => (
          <div key={idx} className="rounded border border-neutral-800 bg-neutral-900 p-4">
            <div className="grid gap-2 sm:grid-cols-2">
              <input
                value={ln.complaint}
                onChange={(e) => updateLine(idx, { complaint: e.target.value })}
                placeholder="Complaint"
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              />
              <input
                value={ln.cause ?? ""}
                onChange={(e) => updateLine(idx, { cause: e.target.value })}
                placeholder="Cause"
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              />
              <input
                value={ln.correction ?? ""}
                onChange={(e) => updateLine(idx, { correction: e.target.value })}
                placeholder="Correction"
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              />
              <input
                value={ln.tools ?? ""}
                onChange={(e) => updateLine(idx, { tools: e.target.value })}
                placeholder="Tools"
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              />
              <input
                inputMode="decimal"
                value={ln.labor_time ?? ""}
                onChange={(e) => {
                  const v = e.target.value;
                  updateLine(idx, { labor_time: v === "" ? undefined : Number(v) });
                }}
                placeholder="Labor time (hrs)"
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              />
              <select
                value={ln.job_type ?? "maintenance"}
                onChange={(e) => updateLine(idx, { job_type: e.target.value as LineDraft["job_type"] })}
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              >
                <option value="maintenance">Maintenance</option>
                <option value="diagnosis">Diagnosis</option>
                <option value="inspection">Inspection</option>
              </select>
              <select
                value={ln.status ?? "awaiting"}
                onChange={(e) =>
                  updateLine(idx, { status: e.target.value as NonNullable<LineDraft["status"]> })
                }
                className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
              >
                <option value="unassigned">Unassigned</option>
                <option value="assigned">Assigned</option>
                <option value="awaiting">Awaiting</option>
                <option value="in_progress">In Progress</option>
                <option value="on_hold">On Hold</option>
                <option value="completed">Completed</option>
              </select>
              {ln.status === "on_hold" && (
                <select
                  value={ln.hold_reason ?? ""}
                  onChange={(e) =>
                    updateLine(idx, {
                      hold_reason: (e.target.value || undefined) as LineDraft["hold_reason"],
                    })
                  }
                  className="rounded bg-neutral-800 border border-neutral-700 p-2 text-white"
                >
                  <option value="">Select hold reason</option>
                  <option value="parts">Parts Hold</option>
                  <option value="authorization">Awaiting Authorization</option>
                  <option value="diagnosis_pending">Waiting Diagnosis</option>
                  <option value="other">Other</option>
                </select>
              )}
            </div>

            <div className="mt-3 flex gap-2">
              <button
                type="button"
                onClick={() => removeLine(idx)}
                className="text-sm text-red-400 hover:underline"
              >
                Remove line
              </button>
            </div>
          </div>
        ))}

        <button
          type="button"
          onClick={addEmptyLine}
          className="rounded bg-neutral-800 border border-neutral-700 px-3 py-2 text-sm hover:bg-neutral-700"
        >
          + Add another line
        </button>
      </div>

      {/* Save */}
      <div className="mt-6">
        {error && <div className="mb-2 rounded bg-red-100 px-3 py-2 text-red-700">{error}</div>}
        {ok && <div className="mb-2 rounded bg-green-100 px-3 py-2 text-green-800">{ok}</div>}

        <button
          onClick={saveToWorkOrder}
          disabled={saving}
          className="rounded bg-orange-500 px-4 py-2 font-semibold text-black hover:bg-orange-600 disabled:opacity-60"
        >
          {saving ? "Saving‚Ä¶" : "Save lines to selected Work Order"}
        </button>
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/app/work-orders/insertPrioritizedJobs.ts
========================================
// app/work-orders/insertPrioritizedJobs.ts

import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";
import { cookies } from "next/headers";

import { v4 as uuidv4 } from "uuid";
import { type Database } from "@shared/types/types/supabase";

type WorkOrderLineInsert =
  Database["public"]["Tables"]["work_order_lines"]["Insert"];

type JobInput = {
  complaint: string;
  job_type: "diagnosis" | "inspection-fail" | "maintenance" | "repair";
  cause?: string;
};

export async function insertPrioritizedJobs(
  workOrderId: string,
  vehicleId: string,
  jobs: JobInput[],
) {
  const supabase = createServerComponentClient<Database>({ cookies });

  const priority = {
    diagnosis: 1,
    "inspection-fail": 2,
    maintenance: 3,
    repair: 4,
  };

  const prioritized = [...jobs].sort((a, b) => {
    return priority[a.job_type] - priority[b.job_type];
  });

  const jobLines: WorkOrderLineInsert[] = prioritized.map((job) => ({
    id: uuidv4(),
    work_order_id: workOrderId,
    vehicle_id: vehicleId,
    complaint: job.complaint,
    cause: job.cause ?? null,
    job_type: job.job_type,
    status: "awaiting",
    punched_in_at: null,
    punched_out_at: null,
    hold_reason: null,
    assigned_tech_id: null,
    assigned_to: null,
  }));

  const { error } = await supabase.from("work_order_lines").insert(jobLines);

  return { error };
}


========================================
FILE: features/work-orders/app/work-orders/page.tsx
========================================
// app/work-orders/page.tsx
"use client";

import Link from "next/link";

export const revalidate = 0;

type TileProps = {
  href: string;
  title: string;
  subtitle?: string;
  cta?: string;
};

function Tile(props: TileProps) {
  return (
    <Link
      href={props.href}
      className="block rounded-lg border border-white/10 bg-neutral-900 p-4 transition
                 hover:-translate-y-0.5 hover:border-orange-500 hover:shadow-lg hover:shadow-orange-500/10"
      aria-label={props.title}
    >
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold text-white">{props.title}</h2>
        {props.cta ? (
          <span className="rounded bg-orange-500 px-3 py-1 text-sm font-semibold text-black">
            {props.cta}
          </span>
        ) : null}
      </div>
      {props.subtitle ? (
        <p className="mt-1 text-sm text-white/70">{props.subtitle}</p>
      ) : null}
    </Link>
  );
}

export default function WorkOrdersHome() {
  return (
    <div className="mx-auto max-w-3xl px-4 py-8 text-white">
      <h1 className="mb-6 text-3xl font-bold text-orange-400">Work Orders</h1>

      <div className="grid grid-cols-1 gap-4">
        <Tile
          href="/work-orders/create"
          title="Create Work Order"
          subtitle="Start a new job for a vehicle"
          cta="+"
        />
        <Tile
          href="/work-orders/queue"
          title="Job Queue"
          subtitle="See active, paused, and in-progress jobs"
        />
        <Tile
          href="/work-orders/editor"
          title="Work Order Editor"
          subtitle="Compose job lines from menu items or free-type"
        />
        <Tile
          href="/work-orders/quote-review"
          title="Quote Review"
          subtitle="Review and send estimates"
        />
        <Tile
          href="/work-orders/view"
          title="View Work Orders"
          subtitle="Browse and manage all work orders"
        />
        <Tile
          href="/customers"
          title="Customer Profiles"
          subtitle="Browse customers, history, and vehicles"
        />
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/app/work-orders/queue/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import Link from "next/link";
import PageShell from "@/features/shared/components/PageShell";

type DB = Database;
type Line = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WO = DB["public"]["Tables"]["work_orders"]["Row"];

type RollupStatus = "awaiting" | "in_progress" | "on_hold" | "completed";

const STATUS_LABELS: Record<RollupStatus, string> = {
  awaiting: "Awaiting",
  in_progress: "In progress",
  on_hold: "On hold",
  completed: "Completed",
};

const STATUS_STYLES: Record<RollupStatus, string> = {
  awaiting:
    "border-neutral-800 bg-neutral-950/70 hover:border-orange-400 data-[active=true]:border-orange-400 data-[active=true]:bg-orange-500/10",
  in_progress:
    "border-neutral-800 bg-neutral-950/70 hover:border-orange-400 data-[active=true]:border-orange-400 data-[active=true]:bg-orange-500/10",
  on_hold:
    "border-neutral-800 bg-neutral-950/70 hover:border-orange-400 data-[active=true]:border-orange-400 data-[active=true]:bg-orange-500/10",
  completed:
    "border-neutral-800 bg-neutral-950/70 hover:border-orange-400 data-[active=true]:border-orange-400 data-[active=true]:bg-orange-500/10",
};

function rollupStatus(lines: Line[]): RollupStatus {
  const s = new Set(
    (lines ?? []).map((l) => (l.status ?? "awaiting") as RollupStatus),
  );

  if (s.has("in_progress")) return "in_progress";
  if (s.has("on_hold")) return "on_hold";
  if (lines.length && lines.every((l) => (l.status ?? "") === "completed"))
    return "completed";
  return "awaiting";
}

function countLineStatuses(lines: Line[]) {
  let awaiting = 0;
  let in_progress = 0;
  let on_hold = 0;
  let completed = 0;

  for (const l of lines ?? []) {
    const s = (l.status ?? "awaiting") as RollupStatus;
    if (s === "awaiting") awaiting += 1;
    else if (s === "in_progress") in_progress += 1;
    else if (s === "on_hold") on_hold += 1;
    else if (s === "completed") completed += 1;
  }

  return { awaiting, in_progress, on_hold, completed };
}

// allow for legacy waiter flags on the work_orders row
type WorkOrderWaiterFlags = {
  is_waiter?: boolean | null;
  waiter?: boolean | null;
  customer_waiting?: boolean | null;
};

export default function QueuePage() {
  const supabase = createClientComponentClient<DB>();

  // auth / profile
  const [userId, setUserId] = useState<string | null>(null);
  const [role, setRole] = useState<string | null>(null);
  const [shopId, setShopId] = useState<string | null>(null);

  // data
  const [workOrders, setWorkOrders] = useState<WO[]>([]);
  const [linesByWo, setLinesByWo] = useState<Record<string, Line[]>>({});

  // ui state
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);
  const [activeFilter, setActiveFilter] = useState<RollupStatus | null>(null);
  const [showMineOnly, setShowMineOnly] = useState(false);
  const [showDebug, setShowDebug] = useState(false);

  /* -------------------------------------------------------------------------
   * Load auth + profile + recent work orders + lines
   * ---------------------------------------------------------------------- */
  useEffect(() => {
    (async () => {
      setLoading(true);
      setErr(null);

      // 1) auth
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr || !user) {
        setErr("You must be signed in.");
        setLoading(false);
        return;
      }

      setUserId(user.id);

      // 2) profile ‚Üí shop + role
      const { data: profile, error: profErr } = await supabase
        .from("profiles")
        .select("shop_id, role")
        .eq("id", user.id)
        .maybeSingle();

      if (profErr) {
        setErr(profErr.message);
        setLoading(false);
        return;
      }

      if (!profile?.shop_id) {
        setErr("No shop linked to your profile yet.");
        setLoading(false);
        return;
      }

      setRole(profile.role ?? null);
      setShopId(profile.shop_id);

      // 3) recent work orders (last 30 days, excluding awaiting_approval)
      const since = new Date();
      since.setDate(since.getDate() - 30);

      const { data: wos, error: woErr } = await supabase
        .from("work_orders")
        .select("*")
        .eq("shop_id", profile.shop_id)
        .neq("status", "awaiting_approval")
        .gte("created_at", since.toISOString())
        .order("created_at", { ascending: false });

      if (woErr) {
        setErr(woErr.message);
        setLoading(false);
        return;
      }

      if (!wos?.length) {
        setWorkOrders([]);
        setLinesByWo({});
        setLoading(false);
        return;
      }

      // 4) lines for those WOs
      const ids = wos.map((w) => w.id);
      const { data: lines, error: lnErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .in("work_order_id", ids);

      if (lnErr) {
        setErr(lnErr.message);
        setLoading(false);
        return;
      }

      const map: Record<string, Line[]> = {};
      (lines ?? []).forEach((l) => {
        if (!l.work_order_id) return;
        if (!map[l.work_order_id]) map[l.work_order_id] = [];
        map[l.work_order_id].push(l);
      });

      // 5) tech visibility
      const isTech =
        profile.role === "tech" ||
        profile.role === "mechanic" ||
        profile.role === "technician";

      const visibleWos: WO[] = isTech
        ? wos.filter((wo) =>
            (map[wo.id] ?? []).some((l) => l.assigned_to === user.id),
          )
        : wos;

      setWorkOrders(visibleWos);
      setLinesByWo(map);
      setLoading(false);
    })();
  }, [supabase]);

  const statuses: RollupStatus[] = [
    "awaiting",
    "in_progress",
    "on_hold",
    "completed",
  ];

  /* -------------------------------------------------------------------------
   * Overall counts per status
   * ---------------------------------------------------------------------- */
  const counts = useMemo(() => {
    const base = {
      awaiting: 0,
      in_progress: 0,
      on_hold: 0,
      completed: 0,
    } satisfies Record<RollupStatus, number>;

    for (const wo of workOrders) {
      const lines = linesByWo[wo.id] ?? [];
      const r = rollupStatus(lines);
      base[r] += 1;
    }
    return base;
  }, [workOrders, linesByWo]);

  /* -------------------------------------------------------------------------
   * Filtered work orders for the main list
   * ---------------------------------------------------------------------- */
  const filteredWos = useMemo(() => {
    let pool = workOrders;

    if (activeFilter != null) {
      pool = pool.filter(
        (wo) => rollupStatus(linesByWo[wo.id] ?? []) === activeFilter,
      );
    }

    if (showMineOnly && userId) {
      pool = pool.filter((wo) =>
        (linesByWo[wo.id] ?? []).some((l) => l.assigned_to === userId),
      );
    }

    return pool;
  }, [activeFilter, showMineOnly, userId, workOrders, linesByWo]);

  /* -------------------------------------------------------------------------
   * Render states
   * ---------------------------------------------------------------------- */
  if (loading) {
    return (
      <PageShell
        title="Job Queue"
        description="Live job queue for technicians, grouped by work order."
      >
        <div className="rounded-xl border border-neutral-800 bg-neutral-950/60 px-4 py-6 text-sm text-neutral-300">
          Loading queue‚Ä¶
        </div>
      </PageShell>
    );
  }

  if (err) {
    return (
      <PageShell
        title="Job Queue"
        description="Live job queue for technicians, grouped by work order."
      >
        <div className="rounded-xl border border-red-500/40 bg-red-900/20 px-4 py-6 text-sm text-red-200">
          {err}
        </div>
      </PageShell>
    );
  }

  /* -------------------------------------------------------------------------
   * Main UI
   * ---------------------------------------------------------------------- */
  return (
    <PageShell
      title="Job Queue"
      description="Live view of active work orders for your shop. This is separate from the shop appointments calendar."
    >
      <div className="space-y-6">
        {/* Header row / top summary */}
        <div className="flex flex-wrap items-center gap-3">
          <div className="rounded-lg border border-neutral-800 bg-neutral-950/70 px-3 py-2 text-xs text-neutral-300">
            <div className="text-[10px] uppercase tracking-wide text-neutral-500">
              Active work orders (last 30 days)
            </div>
            <div className="mt-1 text-lg font-semibold text-white">
              {workOrders.length}
            </div>
          </div>

          <div className="flex items-center gap-3 rounded-lg border border-neutral-800 bg-neutral-950/70 px-3 py-2 text-xs text-neutral-300">
            <label className="inline-flex cursor-pointer items-center gap-2">
              <input
                type="checkbox"
                checked={showMineOnly}
                onChange={(e) => setShowMineOnly(e.target.checked)}
                className="h-4 w-4 rounded border-neutral-700 bg-neutral-900 text-orange-500"
              />
              <span>
                Show only jobs assigned to{" "}
                <span className="font-medium">me</span>
              </span>
            </label>
          </div>

          <button
            type="button"
            onClick={() => setShowDebug((v) => !v)}
            className="ml-auto rounded border border-neutral-700 bg-neutral-950 px-3 py-1.5 text-[11px] text-neutral-300 hover:border-orange-400 hover:text-orange-300"
          >
            {showDebug ? "Hide debug" : "Show debug"}
          </button>
        </div>

        {/* Optional debug block */}
        {showDebug && (
          <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 px-4 py-3 text-xs text-neutral-300">
            <div className="mb-1 text-[11px] font-semibold uppercase tracking-wide text-orange-400">
              Debug
            </div>
            <div className="grid gap-2 sm:grid-cols-2">
              <div className="space-y-1">
                <div>
                  <span className="text-neutral-500">User:</span>{" "}
                  <span className="font-mono text-neutral-200">
                    {userId ?? "‚Äî"}
                  </span>
                </div>
                <div>
                  <span className="text-neutral-500">Role:</span>{" "}
                  {role ?? "‚Äî"}
                </div>
                <div>
                  <span className="text-neutral-500">Shop:</span>{" "}
                  {shopId ?? "‚Äî"}
                </div>
              </div>
              <div className="space-y-1">
                <div>
                  <span className="text-neutral-500">Visible WOs:</span>{" "}
                  {workOrders.length}
                </div>
                <div>
                  <span className="text-neutral-500">Active filter:</span>{" "}
                  {activeFilter ? STATUS_LABELS[activeFilter] : "All"}
                </div>
                <div>
                  <span className="text-neutral-500">Mine only:</span>{" "}
                  {showMineOnly ? "Yes" : "No"}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Status buckets */}
        <div className="grid gap-3 md:grid-cols-4">
          {statuses.map((s) => {
            const isActive = activeFilter === s;
            return (
              <button
                key={s}
                type="button"
                onClick={() => setActiveFilter(isActive ? null : s)}
                className={`rounded-xl border px-3 py-3 text-left text-sm text-neutral-100 transition ${STATUS_STYLES[s]}`}
                data-active={isActive ? "true" : "false"}
              >
                <div className="text-[10px] uppercase tracking-wide text-neutral-400">
                  {STATUS_LABELS[s]}
                </div>
                <div className="mt-1 text-2xl font-semibold">
                  {counts[s] ?? 0}
                </div>
                {isActive && (
                  <div className="mt-1 text-[10px] text-orange-400">
                    Showing {STATUS_LABELS[s].toLowerCase()} work orders
                  </div>
                )}
              </button>
            );
          })}
        </div>

        {/* Work order list */}
        <div className="space-y-2">
          {filteredWos.map((wo) => {
            const lines = linesByWo[wo.id] ?? [];
            const status = rollupStatus(lines);
            const bucketCounts = countLineStatuses(lines);

            const slug = wo.custom_id ?? wo.id;
            const createdLabel = wo.created_at
              ? new Date(wo.created_at).toLocaleString()
              : "‚Äî";

            const waiterSource = wo as WO & WorkOrderWaiterFlags;
            const isWaiter =
              !!(
                waiterSource &&
                (waiterSource.is_waiter ||
                  waiterSource.waiter ||
                  waiterSource.customer_waiting)
              );

            return (
              <Link
                key={wo.id}
                href={`/work-orders/${slug}?mode=tech`}
                className="block rounded-lg border border-neutral-800 bg-neutral-950/70 px-3 py-3 text-sm text-neutral-100 transition hover:border-orange-500 hover:bg-neutral-900"
              >
                <div className="flex items-center justify-between gap-3">
                  <div className="min-w-0">
                    <div className="truncate font-medium text-white">
                      {wo.custom_id ? wo.custom_id : `#${wo.id.slice(0, 8)}`}
                    </div>
                    {wo.custom_id && (
                      <div className="text-[10px] text-neutral-500">
                        #{wo.id.slice(0, 8)}
                      </div>
                    )}
                    <div className="mt-1 text-[11px] text-neutral-400">
                      Created: {createdLabel}
                    </div>
                    <div className="mt-1 text-[11px] text-neutral-400">
                      {bucketCounts.awaiting} awaiting ¬∑{" "}
                      {bucketCounts.in_progress} in progress ¬∑{" "}
                      {bucketCounts.on_hold} on hold ¬∑{" "}
                      {bucketCounts.completed} completed
                    </div>
                  </div>

                  <div className="flex flex-col items-end gap-2">
                    <span className="rounded-full border border-neutral-700 px-2.5 py-1 text-[11px] capitalize text-neutral-300">
                      {status.replace("_", " ")}
                    </span>

                    {isWaiter && (
                      <span className="inline-flex items-center whitespace-nowrap rounded-full border border-red-500 bg-red-500/10 px-3.5 py-1.5 text-[11px] font-semibold uppercase tracking-[0.18em] text-red-200 shadow-[0_0_18px_rgba(248,113,113,0.9)]">
                        Waiter
                      </span>
                    )}
                  </div>
                </div>
              </Link>
            );
          })}

          {filteredWos.length === 0 && (
            <div className="rounded-lg border border-neutral-800 bg-neutral-950/70 p-4 text-sm text-neutral-400">
              No work orders in this bucket.
            </div>
          )}
        </div>

        {/* Tiny footer hint */}
        <div className="pt-2 text-[11px] text-neutral-500">
          Manage customer & vehicle details, inspections, labor, and parts from
          the individual work order page. This view is focused on{" "}
          <span className="font-medium text-neutral-300">
            technician job flow
          </span>
          , not the shop appointments calendar.
        </div>
      </div>
    </PageShell>
  );
}

========================================
FILE: features/work-orders/app/work-orders/quote-review/page.tsx
========================================
"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import SignaturePad, {
  openSignaturePad,
} from "@/features/shared/signaturePad/controller";
import { formatCurrency } from "@/features/shared/lib/formatCurrency";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Line = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Shop = DB["public"]["Tables"]["shops"]["Row"];
type QuoteLine = DB["public"]["Tables"]["work_order_quote_lines"]["Row"];

const SIGNATURE_BUCKET = "signatures";

/* ----------------------------- helpers ----------------------------- */

function dataUrlToBlob(dataUrl: string): Blob {
  const [header, b64] = dataUrl.split(",");
  const mime = /data:(.*?);base64/.exec(header)?.[1] ?? "image/png";
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return new Blob([bytes], { type: mime });
}

const fmt = (n: number) => {
  try {
    return formatCurrency(n);
  } catch {
    return `$${n.toFixed(2)}`;
  }
};

/* ----------------------- approvals list (cards) ----------------------- */

function ApprovalsList() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [rows, setRows] = useState<WorkOrderWithMeta[]>([]);
  const [loading, setLoading] = useState(true);

  type WorkOrderWithMeta = WorkOrder & {
    shops?: Pick<Shop, "name"> | null;
    labor_hours?: number | null;
  };

  const load = async () => {
    setLoading(true);

    // Only show awaiting_approval here
    const { data: wo } = await supabase
      .from("work_orders")
      .select(`*, shops!inner(name)`)
      .eq("status", "awaiting_approval")
      .order("created_at", { ascending: false });

    let withMeta: WorkOrderWithMeta[] = (wo ?? []) as any;

    if (withMeta.length) {
      const woIds = withMeta.map((w) => w.id);
      const { data: lines } = await supabase
        .from("work_order_lines")
        .select("work_order_id, labor_time")
        .in("work_order_id", woIds);

      const hoursByWO = new Map<string, number>();
      (lines ?? []).forEach((l) => {
        const cur = hoursByWO.get(l.work_order_id) ?? 0;
        hoursByWO.set(
          l.work_order_id,
          cur + (typeof l.labor_time === "number" ? l.labor_time : 0),
        );
      });

      withMeta = withMeta.map((w) => ({
        ...w,
        labor_hours: hoursByWO.get(w.id) ?? 0,
      }));
    }

    setRows(withMeta);
    setLoading(false);
  };

  useEffect(() => {
    void load();

    // Realtime: if any WO flips status, refresh the list
    const ch = supabase
      .channel("qr:work_orders")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_orders" },
        () => void load(),
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        /* ignore */
      }
    };
  }, [supabase]);

  if (loading)
    return <div className="mt-6 text-muted-foreground">Loading‚Ä¶</div>;
  if (rows.length === 0)
    return (
      <div className="mt-6 text-muted-foreground">
        No work orders waiting for approval.
      </div>
    );

  return (
    <div className="mt-4 rounded-lg border border-border bg-card">
      <div className="border-b border-border px-4 py-2 font-semibold">
        Awaiting Approval
      </div>

      <div className="divide-y divide-border">
        {rows.map((w) => (
          <div
            key={w.id}
            className="flex items-center justify-between gap-3 px-4 py-3"
          >
            <div className="min-w-0">
              <div className="truncate font-medium">
                {w.custom_id ? `#${w.custom_id}` : `#${w.id.slice(0, 8)}`}
              </div>
              <div className="text-xs text-muted-foreground">
                {w.shops?.name ? `${w.shops.name} ‚Ä¢ ` : ""}
                {(w.status ?? "").replaceAll("_", " ")}
                {typeof w.labor_hours === "number"
                  ? ` ‚Ä¢ ${w.labor_hours.toFixed(1)}h`
                  : ""}
              </div>
            </div>
            <div className="flex shrink-0 gap-2">
              <a
                href={`/work-orders/${w.id}/approve`}
                className="rounded border border-orange-500 px-3 py-1 text-sm text-orange-500 hover:bg-orange-500/10"
                title="Open customer-facing approval workflow"
              >
                Review &amp; Sign
              </a>
              <a
                href={`/work-orders/${w.id}`}
                className="rounded border border-border px-3 py-1 text-sm hover:bg-muted"
                title="Open this work order"
              >
                Open WO
              </a>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

/* ---------------------- single WO review + sign ---------------------- */

function SingleQuoteReview({ woId }: { woId: string }) {
  const router = useRouter();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [wo, setWo] = useState<WorkOrder | null>(null);
  const [shop, setShop] = useState<Shop | null>(null);
  const [lines, setLines] = useState<Line[]>([]);
  const [loading, setLoading] = useState(true);

  const [quoteLines, setQuoteLines] = useState<QuoteLine[]>([]);
  const [quoteLoading, setQuoteLoading] = useState(true);

  // Load WO + lines
  useEffect(() => {
    if (!woId) return;
    (async () => {
      setLoading(true);

      const { data: woRow } = await supabase
        .from("work_orders")
        .select("*")
        .eq("id", woId)
        .maybeSingle();
      setWo(woRow ?? null);

      if (woRow?.shop_id) {
        const { data: shopRow } = await supabase
          .from("shops")
          .select("*")
          .eq("id", woRow.shop_id)
          .maybeSingle();
        setShop(shopRow ?? null);
      }

      const { data: lineRows } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("work_order_id", woId)
        .order("created_at", { ascending: true });
      setLines(lineRows ?? []);

      setLoading(false);
    })();
  }, [woId, supabase]);

  // Load quote lines
  async function reloadQuotes() {
    if (!woId) return;
    setQuoteLoading(true);
    const { data: qRows, error: qErr } = await supabase
      .from("work_order_quote_lines")
      .select("*")
      .eq("work_order_id", woId)
      .order("created_at", { ascending: true });

    if (qErr) {
      setQuoteLines([]);
    } else {
      setQuoteLines((qRows ?? []) as QuoteLine[]);
    }
    setQuoteLoading(false);
  }

  useEffect(() => {
    void reloadQuotes();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [woId, supabase]);

  const laborRate = 120;
  const totalLaborHours = lines.reduce(
    (sum, l) => sum + (typeof l.labor_time === "number" ? l.labor_time : 0),
    0,
  );
  const laborTotal = totalLaborHours * laborRate;
  const partsTotal = 0;
  const grandTotal = laborTotal + partsTotal;

  const advisorPendingQuotes = quoteLines.filter(
    (q) => ((q as any).stage as string | null) === "advisor_pending",
  );
  const customerPendingQuotes = quoteLines.filter(
    (q) => ((q as any).stage as string | null) === "customer_pending",
  );
  const decidedQuotes = quoteLines.filter((q) =>
    ["customer_approved", "customer_declined"].includes(
      (((q as any).stage as string | null) ?? "") as string,
    ),
  );

  /* ----------------------- quote actions ----------------------- */

  async function sendQuotesToCustomer(linesToSend: QuoteLine[]) {
    if (!linesToSend.length) return;

    const groupId =
      typeof crypto !== "undefined" && "randomUUID" in crypto
        ? crypto.randomUUID()
        : `${Date.now()}-${Math.random().toString(16).slice(2)}`;

    const { error } = await supabase
      .from("work_order_quote_lines")
      .update({
        
        stage: "customer_pending",
        
        group_id: groupId,
        
        sent_to_customer_at: new Date().toISOString() as any,
      })
      .in(
        "id",
        linesToSend.map((q) => q.id),
      );

    if (error) {
      alert(error.message);
      return;
    }

    // TODO: trigger customer portal notification / email using groupId
    alert("Quote sent to customer.");
    await reloadQuotes();
  }

  async function approveQuoteLine(q: QuoteLine) {
    const { error } = await supabase
      .from("work_order_quote_lines")
      .update({
        
        stage: "customer_approved",
        
        approved_at: new Date().toISOString() as any,
      })
      .eq("id", q.id);

    if (error) {
      alert(error.message);
      return;
    }

    // Later you can also convert this line into a real work_order_line here.
    await reloadQuotes();
  }

  async function declineQuoteLine(q: QuoteLine) {
    const { error } = await supabase
      .from("work_order_quote_lines")
      .update({
        
        stage: "customer_declined",
        
        declined_at: new Date().toISOString() as any,
      })
      .eq("id", q.id);

    if (error) {
      alert(error.message);
      return;
    }

    await reloadQuotes();
  }

  /* --------------------- signature + status --------------------- */

  async function handleSignatureSave(base64: string) {
    if (!woId) return;
    try {
      const blob = dataUrlToBlob(base64);
      const filename = `wo/${wo?.shop_id ?? "unknown"}/${woId}/${Date.now()}.png`;

      const { error: upErr } = await supabase.storage
        .from(SIGNATURE_BUCKET)
        .upload(filename, blob, { contentType: "image/png", upsert: false });
      if (upErr) throw upErr;

      const { error: updErr } = await supabase
        .from("work_orders")
        .update({
          // @ts-ignore pending schema fields in types
          customer_approval_signature_path: filename,
          // @ts-ignore pending schema fields in types
          customer_approval_at: new Date().toISOString() as any,
          status: "queued" as any, // moves it out of Quote Review
        })
        .eq("id", woId);
      if (updErr) throw updErr;

      alert("Work order approved and signed!");
      router.push("/work-orders/create?from=review&new=1");
    } catch (err: unknown) {
      const msg =
        err instanceof Error ? err.message : "Failed to save signature";
      alert(msg);
    }
  }

  async function markAwaitingApproval() {
    if (!woId) return;
    try {
      const { error } = await supabase
        .from("work_orders")
        .update({
          status: "awaiting_approval" as any,
          // @ts-ignore pending schema fields in types
          customer_approval_signature_path: null,
          // @ts-ignore pending schema fields in types
          customer_approval_at: null,
        })
        .eq("id", woId);
      if (error) throw error;
      alert("Saved. This work order is now awaiting customer approval.");
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to update status.";
      alert(msg);
    }
  }

  function copyApprovalLink() {
    if (!woId) return;
    const origin =
      typeof window !== "undefined"
        ? window.location.origin
        : (process.env.NEXT_PUBLIC_SITE_URL || "").replace(/\/$/, "");
    const url = `${origin || ""}/work-orders/${woId}/approve`;
    navigator.clipboard
      .writeText(url)
      .then(() => alert("Approval link copied to clipboard."))
      .catch(() => alert(url));
  }

  if (loading)
    return <div className="mt-6 text-muted-foreground">Loading‚Ä¶</div>;
  if (!wo)
    return (
      <div className="mt-6 text-destructive">Work order not found.</div>
    );

  return (
    <>
      <div className="mt-2 text-sm text-muted-foreground">
        <div>Work Order ID: {wo.id}</div>
        <div>Status: {(wo.status ?? "").replaceAll("_", " ") || "‚Äî"}</div>
        {shop?.name && <div>Shop: {shop.name}</div>}
      </div>

      {/* Quote lines / advisor flow */}
      <div className="mt-6 rounded-lg border border-border bg-card">
        <div className="flex items-center justify-between border-b border-border px-4 py-2">
          <div className="font-semibold">Quote lines</div>
          {advisorPendingQuotes.length > 0 && (
            <button
              onClick={() => void sendQuotesToCustomer(advisorPendingQuotes)}
              className="rounded border border-orange-500 px-3 py-1 text-sm text-orange-500 hover:bg-orange-500/10"
            >
              Send to customer
            </button>
          )}
        </div>

        {quoteLoading ? (
          <div className="px-4 py-3 text-sm text-muted-foreground">
            Loading quotes‚Ä¶
          </div>
        ) : quoteLines.length === 0 ? (
          <div className="px-4 py-3 text-sm text-muted-foreground">
            No quote lines for this work order yet.
          </div>
        ) : (
          <div className="divide-y divide-border">
            {/* Advisor pending */}
            {advisorPendingQuotes.length > 0 && (
              <div className="bg-slate-950/60">
                <div className="px-4 pt-3 text-xs font-semibold uppercase tracking-wide text-blue-300">
                  Awaiting advisor review
                </div>
                {advisorPendingQuotes.map((q) => (
                  <div key={q.id} className="px-4 py-3 text-sm">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div className="truncate font-medium">
                          {(q as any).description || "Untitled quote line"}
                        </div>
                        {(q as any).notes && (
                          <div className="mt-0.5 text-xs text-muted-foreground">
                            {(q as any).notes}
                          </div>
                        )}
                      </div>
                      <div className="flex shrink-0 gap-2">
                        <button
                          onClick={() => void approveQuoteLine(q)}
                          className="rounded border border-green-600 px-2 py-1 text-xs text-green-200 hover:bg-green-900/30"
                        >
                          Approve now
                        </button>
                        <button
                          onClick={() => void declineQuoteLine(q)}
                          className="rounded border border-red-600 px-2 py-1 text-xs text-red-200 hover:bg-red-900/40"
                        >
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Customer pending */}
            {customerPendingQuotes.length > 0 && (
              <div>
                <div className="px-4 pt-3 text-xs font-semibold uppercase tracking-wide text-amber-300">
                  Sent to customer
                </div>
                {customerPendingQuotes.map((q) => (
                  <div key={q.id} className="px-4 py-3 text-sm">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div className="truncate font-medium">
                          {(q as any).description || "Untitled quote line"}
                        </div>
                        <div className="mt-0.5 text-xs text-muted-foreground">
                          Waiting on customer response
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* History */}
            {decidedQuotes.length > 0 && (
              <div className="bg-neutral-950/60">
                <div className="px-4 pt-3 text-xs font-semibold uppercase tracking-wide text-neutral-400">
                  Customer decisions
                </div>
                {decidedQuotes.map((q) => (
                  <div key={q.id} className="px-4 py-3 text-sm">
                    <div className="flex items-start justify-between gap-3">
                      <div className="min-w-0">
                        <div className="truncate font-medium">
                          {(q as any).description || "Untitled quote line"}
                        </div>
                        <div className="mt-0.5 text-xs text-muted-foreground">
                          {((q as any).stage as string) === "customer_approved"
                            ? "Approved"
                            : "Declined"}
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>

      {/* Existing line items + totals */}
      <div className="mt-6 rounded-lg border border-border bg-card">
        <div className="border-b border-border px-4 py-2 font-semibold">
          Line Items
        </div>
        <div className="divide-y divide-border">
          {lines.length === 0 ? (
            <div className="px-4 py-3 text-muted-foreground">
              No items yet.
            </div>
          ) : (
            lines.map((l) => (
              <div key={l.id} className="px-4 py-3">
                <div className="flex items-center justify-between">
                  <div className="min-w-0">
                    <div className="truncate font-medium">
                      {l.description || l.complaint || "Untitled job"}
                    </div>
                    <div className="text-xs text-muted-foreground">
                      {String(l.job_type ?? "job").replaceAll("_", " ")} ‚Ä¢{" "}
                      {typeof l.labor_time === "number"
                        ? `${l.labor_time}h`
                        : "‚Äî"}{" "}
                      ‚Ä¢ {(l.status ?? "awaiting").replaceAll("_", " ")}
                    </div>
                  </div>
                  <div className="text-right text-sm">
                    {typeof l.labor_time === "number"
                      ? fmt(l.labor_time * laborRate)
                      : "‚Äî"}
                  </div>
                </div>
              </div>
            ))
          )}
        </div>

        <div className="px-4 py-3 text-sm">
          <div className="flex items-center justify-between">
            <span>
              Labor ({totalLaborHours.toFixed(1)}h @ {fmt(laborRate)}/hr)
            </span>
            <span className="font-medium">{fmt(laborTotal)}</span>
          </div>
          <div className="mt-1 flex items-center justify-between">
            <span>Parts</span>
            <span className="font-medium">{fmt(partsTotal)}</span>
          </div>
          <div className="mt-2 flex items-center justify-between border-t border-border pt-2">
            <span className="font-semibold">Total</span>
            <span className="font-bold text-orange-500">
              {fmt(grandTotal)}
            </span>
          </div>
        </div>
      </div>

      <div className="mt-6 flex flex-wrap gap-2">
        <button
          onClick={async () => {
            const base64 = await openSignaturePad({
              shopName: shop?.name || "",
            });
            if (!base64) return;
            await handleSignatureSave(base64);
          }}
          className="rounded bg-green-600 px-4 py-2 font-semibold text-white hover:bg-green-700"
        >
          Approve &amp; Sign
        </button>

        <button
          onClick={markAwaitingApproval}
          className="rounded border border-border px-4 py-2 hover:bg-muted"
          title="Save this work order as awaiting customer approval"
        >
          Save for Customer Approval
        </button>

        <button
          onClick={copyApprovalLink}
          className="rounded border border-border px-4 py-2 hover:bg-muted"
          title="Copy link to the customer-facing approval page"
        >
          Copy Approval Link
        </button>

        <a
          href={`/work-orders/${woId}`}
          className="rounded border border-border px-4 py-2 hover:bg-muted"
        >
          Back to Work Order
        </a>
      </div>
    </>
  );
}

/* ------------------------------ page ------------------------------ */

export default function QuoteReviewPage() {
  const woId = useSearchParams().get("woId");
  const router = useRouter();

  return (
    <div className="min-h-screen bg-background px-4 py-6 text-foreground">
      <div className="mx-auto max-w-5xl">
        <div className="mb-4">
          <button
            onClick={() => router.back()}
            className="text-sm text-orange-500 hover:underline"
          >
            ‚Üê Back
          </button>
        </div>

        <h1 className="text-2xl font-semibold">Quote Review</h1>

        {!woId ? (
          <>
            <p className="mt-1 text-muted-foreground">
              Work orders waiting for customer approval
            </p>
            <ApprovalsList />
            <SignaturePad />
          </>
        ) : (
          <>
            <SingleQuoteReview woId={woId} />
            <SignaturePad />
          </>
        )}
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/app/work-orders/view/page.tsx
========================================
// app/work-orders/view/page.tsx
"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { format } from "date-fns";
import { toast } from "sonner";

import { WorkOrderAssignedSummary } from "@/features/work-orders/components/WorkOrderAssignedSummary";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Profile = DB["public"]["Tables"]["profiles"]["Row"];

type Row = WorkOrder & {
  customers: Pick<Customer, "first_name" | "last_name" | "phone" | "email"> | null;
  vehicles: Pick<Vehicle, "year" | "make" | "model" | "license_plate"> | null;
};

/* --------------------------- Status badges --------------------------- */
type StatusKey =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

const BADGE_BASE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-2.5 py-0.5 text-[0.7rem] font-medium tracking-[0.08em] uppercase";

const STATUS_BADGE: Record<StatusKey, string> = {
  awaiting_approval:
    "bg-blue-500/10 border-blue-400/60 text-blue-100",
  awaiting:
    "bg-sky-500/10 border-sky-400/60 text-sky-100",
  queued:
    "bg-indigo-500/10 border-indigo-400/60 text-indigo-100",
  in_progress:
    "bg-[var(--accent-copper)]/15 border-[var(--accent-copper-light)]/70 text-[var(--accent-copper-light)]",
  on_hold:
    "bg-amber-500/10 border-amber-400/70 text-amber-100",
  planned:
    "bg-purple-500/10 border-purple-400/70 text-purple-100",
  new:
    "bg-neutral-900/80 border-neutral-500/80 text-neutral-100",
  completed:
    "bg-green-500/10 border-green-400/70 text-green-100",
  ready_to_invoice:
    "bg-emerald-500/10 border-emerald-400/70 text-emerald-100",
  invoiced:
    "bg-teal-500/10 border-teal-400/70 text-teal-100",
};

const chip = (s: string | null | undefined) => {
  const key = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_") as StatusKey;
  const cls = STATUS_BADGE[key] ?? STATUS_BADGE.awaiting;
  return `${BADGE_BASE} ${cls}`;
};

/** ‚ÄúNormal flow‚Äù = tech/active; hides AA, completed, billing states */
const NORMAL_FLOW_STATUSES: StatusKey[] = [
  "awaiting",
  "queued",
  "in_progress",
  "on_hold",
  "planned",
  "new",
];

// roles that can assign techs from this view
const ASSIGN_ROLES = new Set(["owner", "admin", "manager", "advisor"]);

/* --------------------------- Themed input styles --------------------------- */
const INPUT_DARK =
  "w-full rounded-full border border-white/15 bg-black/40 px-3 py-1.5 text-xs sm:text-sm text-neutral-100 placeholder:text-neutral-500 " +
  "shadow-[0_0_18px_rgba(0,0,0,0.8)] backdrop-blur focus:border-[var(--accent-copper)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper)]";
const SELECT_DARK =
  "w-full rounded-full border border-white/15 bg-black/40 px-3 py-1.5 text-xs sm:text-sm text-neutral-100 " +
  "shadow-[0_0_18px_rgba(0,0,0,0.8)] backdrop-blur focus:border-[var(--accent-copper)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper)]";
const BUTTON_MUTED =
  "rounded-full border border-white/15 bg-white/5 px-3 py-1.5 text-xs sm:text-sm text-neutral-100 shadow-[0_0_14px_rgba(0,0,0,0.7)] " +
  "transition hover:border-[var(--accent-copper-light)] hover:bg-[var(--accent-copper)]/15 hover:text-white active:opacity-80";

export default function WorkOrdersView(): JSX.Element {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [rows, setRows] = useState<Row[]>([]);
  const [loading, setLoading] = useState(true);
  const [q, setQ] = useState("");
  const [status, setStatus] = useState<string>("");
  const [err, setErr] = useState<string | null>(null);

  // assigning
  const [assigningFor, setAssigningFor] = useState<string | null>(null);
  const [techs, setTechs] = useState<
    Array<Pick<Profile, "id" | "full_name" | "role">>
  >([]);
  const [selectedTechId, setSelectedTechId] = useState<string>("");

  const [currentRole, setCurrentRole] = useState<string | null>(null);

  // üîÅ version counter to force assigned summary to refetch
  const [, setAssignVersion] = useState(0);

  // load current user role + mechanics once
  useEffect(() => {
    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (user?.id) {
        const { data: prof } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", user.id)
          .maybeSingle();
        setCurrentRole(prof?.role ?? null);
      }

      try {
        const res = await fetch("/api/assignables");
        const json = await res.json();
        if (res.ok) {
          setTechs(json.data ?? []);
        } else {
          console.warn("Failed to load mechanics:", json.error);
        }
      } catch (e) {
        console.warn("Failed to load mechanics:", e);
      }
    })();
  }, [supabase]);

  const canAssign = currentRole ? ASSIGN_ROLES.has(currentRole) : false;

  const load = useCallback(async () => {
    setLoading(true);
    setErr(null);

    // 1) get work orders
    let query = supabase
      .from("work_orders")
      .select(
        `
        *,
        customers:customers(first_name,last_name,phone,email),
        vehicles:vehicles(year,make,model,license_plate)
      `,
      )
      .order("created_at", { ascending: false })
      .limit(100);

    if (status === "") {
      query = query.in("status", NORMAL_FLOW_STATUSES as unknown as string[]);
    } else {
      query = query.eq("status", status);
    }

    const { data, error } = await query;
    if (error) {
      setErr(error.message);
      setRows([]);
      setLoading(false);
      return;
    }

    const workOrders = data as Row[];

    // 2) client-side filter by search
    const qlc = q.trim().toLowerCase();
    const filtered =
      qlc.length === 0
        ? workOrders
        : workOrders.filter((r) => {
            const name = [r.customers?.first_name ?? "", r.customers?.last_name ?? ""]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();
            const plate = r.vehicles?.license_plate?.toLowerCase() ?? "";
            const ymm = [
              r.vehicles?.year ?? "",
              r.vehicles?.make ?? "",
              r.vehicles?.model ?? "",
            ]
              .join(" ")
              .toLowerCase();
            const cid = (r.custom_id ?? "").toLowerCase();
            return (
              r.id.toLowerCase().includes(qlc) ||
              cid.includes(qlc) ||
              name.includes(qlc) ||
              plate.includes(qlc) ||
              ymm.includes(qlc)
            );
          });

    setRows(filtered);
    setLoading(false);
  }, [q, status, supabase]);

  useEffect(() => {
    void load();
  }, [load]);

  // realtime refresh
  useEffect(() => {
    const ch = supabase
      .channel("work_orders:list")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_orders" },
        () => {
          setTimeout(() => void load(), 60);
        },
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        /* ignore */
      }
    };
  }, [supabase, load]);

  const handleDelete = useCallback(
    async (id: string) => {
      if (!confirm("Delete this work order? This cannot be undone.")) return;

      const prev = rows;
      setRows((r) => r.filter((x) => x.id !== id));

      const { error: lineErr } = await supabase
        .from("work_order_lines")
        .delete()
        .eq("work_order_id", id);
      if (lineErr) {
        alert("Failed to delete job lines: " + lineErr.message);
        setRows(prev);
        return;
      }

      const { error } = await supabase.from("work_orders").delete().eq("id", id);
      if (error) {
        alert("Failed to delete: " + error.message);
        setRows(prev);
      }
    },
    [rows, supabase],
  );

  const handleAssignAll = useCallback(
    async (woId: string) => {
      if (!selectedTechId) {
        alert("Choose a mechanic first.");
        return;
      }

      try {
        const res = await fetch("/api/work-orders/assign-all", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            work_order_id: woId,
            tech_id: selectedTechId,
            only_unassigned: true,
          }),
        });
        const json = await res.json();
        if (!res.ok) {
          alert(json.error || "Failed to assign.");
          return;
        }
        setAssigningFor(null);
        await load();
        // üîÅ tell summary pills to reload assignment info
        setAssignVersion((v) => v + 1);
        toast.success("Work order assigned to mechanic.");
      } catch (e) {
        const msg = e instanceof Error ? e.message : "Failed to assign.";
        alert(msg);
      }
    },
    [selectedTechId, load],
  );

  const total = rows.length;
  const activeCount = useMemo(
    () =>
      rows.filter((r) =>
        NORMAL_FLOW_STATUSES.includes(
          (r.status ?? "awaiting").toLowerCase().replaceAll(" ", "_") as StatusKey,
        ),
      ).length,
    [rows],
  );
  const awaitingApprovalCount = useMemo(
    () =>
      rows.filter(
        (r) => (r.status ?? "").toLowerCase() === "awaiting_approval",
      ).length,
    [rows],
  );

  return (
    <div className="mx-auto max-w-6xl bg-background px-4 py-6 text-foreground space-y-6">
      {/* Header card */}
      <section className="metal-panel metal-panel--card rounded-2xl border border-white/10 px-4 py-4 shadow-card">
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <h1 className="text-lg font-blackops tracking-[0.18em] text-[var(--accent-copper-light)]">
              Work Orders
            </h1>
            <p className="mt-1 text-[0.75rem] text-neutral-300">
              Live view of active jobs, their status, and technician assignments.
            </p>
          </div>

          <div className="flex items-center gap-3">
            <Link
              href="/work-orders/create"
              className="inline-flex items-center justify-center rounded-full bg-[var(--accent-copper)] px-3.5 py-1.5 text-sm font-semibold text-black shadow-[0_0_26px_rgba(0,0,0,0.9)] transition hover:opacity-90"
            >
              <span className="mr-1.5 text-base leading-none">+</span>
              New work order
            </Link>
          </div>
        </div>
      </section>

      {/* Filters + stats strip */}
      <section className="flex flex-col gap-3 rounded-2xl border border-white/10 bg-black/35 p-3 text-xs shadow-[0_0_40px_rgba(0,0,0,0.8)] backdrop-blur-md sm:flex-row sm:items-center sm:justify-between">
        <div className="flex flex-1 flex-col gap-2 sm:flex-row sm:items-center">
          <div className="min-w-[220px] flex-1">
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && void load()}
              placeholder="Search id, custom id, customer, plate, YMM‚Ä¶"
              className={INPUT_DARK}
            />
          </div>
          <div className="flex items-center gap-2">
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className={SELECT_DARK + " min-w-[200px]"}
              aria-label="Filter by status"
            >
              <option value="">Active (normal flow)</option>
              <option value="awaiting_approval">Awaiting approval</option>
              <option value="awaiting">Awaiting</option>
              <option value="queued">Queued</option>
              <option value="in_progress">In progress</option>
              <option value="on_hold">On hold</option>
              <option value="planned">Planned</option>
              <option value="new">New</option>
              <option value="completed">Completed</option>
              <option value="ready_to_invoice">Ready to invoice</option>
              <option value="invoiced">Invoiced</option>
            </select>
            <button
              onClick={() => {
                void load();
                setAssignVersion((v) => v + 1);
              }}
              className={BUTTON_MUTED}
            >
              Refresh
            </button>
          </div>
        </div>

        <div className="flex items-center gap-4 text-[0.7rem] text-neutral-300">
          <div className="flex flex-col">
            <span className="uppercase tracking-[0.13em] text-neutral-500">
              Total
            </span>
            <span className="text-sm font-semibold text-white">{total}</span>
          </div>
          <div className="h-7 w-px bg-white/10" />
          <div className="flex flex-col">
            <span className="uppercase tracking-[0.13em] text-neutral-500">
              Active
            </span>
            <span className="text-sm font-semibold text-sky-200">
              {activeCount}
            </span>
          </div>
          <div className="h-7 w-px bg-white/10" />
          <div className="flex flex-col">
            <span className="uppercase tracking-[0.13em] text-neutral-500">
              Awaiting approval
            </span>
            <span className="text-sm font-semibold text-blue-200">
              {awaitingApprovalCount}
            </span>
          </div>
        </div>
      </section>

      {err && (
        <div className="rounded-xl border border-red-500/50 bg-red-950/60 px-3 py-2 text-xs text-red-100">
          {err}
        </div>
      )}

      {loading ? (
        <div className="rounded-2xl border border-white/10 bg-black/40 p-4 text-sm text-neutral-300 shadow-[0_0_40px_rgba(0,0,0,0.7)]">
          Loading work orders‚Ä¶
        </div>
      ) : rows.length === 0 ? (
        <div className="rounded-2xl border border-dashed border-white/20 bg-black/40 p-6 text-sm text-neutral-400 shadow-[0_0_40px_rgba(0,0,0,0.6)]">
          No work orders match your current filters.
        </div>
      ) : (
        <section className="overflow-hidden rounded-2xl border border-white/12 bg-black/30 shadow-[0_0_50px_rgba(0,0,0,0.9)] backdrop-blur">
          <div className="hidden border-b border-white/8 bg-black/45 px-4 py-2 text-[0.7rem] uppercase tracking-[0.12em] text-neutral-500 sm:grid sm:grid-cols-[110px,1.6fr,1.1fr,auto] sm:gap-3">
            <div>Date</div>
            <div>Work order / customer / vehicle</div>
            <div>Assigned to</div>
            <div className="text-right">Actions</div>
          </div>

          <div className="divide-y divide-white/8">
            {rows.map((r) => {
              const href = `/work-orders/${r.custom_id ?? r.id}?mode=view`;
              const isAssigning = assigningFor === r.id;

              const customerName = r.customers
                ? [r.customers.first_name ?? "", r.customers.last_name ?? ""]
                    .filter(Boolean)
                    .join(" ")
                : "";

              const vehicleLabel = r.vehicles
                ? `${r.vehicles.year ?? ""} ${r.vehicles.make ?? ""} ${
                    r.vehicles.model ?? ""
                  }`.trim()
                : "";

              const plate = r.vehicles?.license_plate ?? "";

              return (
                <div
                  key={r.id}
                  className="flex flex-col gap-3 bg-gradient-to-br from-black/60 to-black/40 px-3 py-3 text-sm sm:grid sm:grid-cols-[110px,1.6fr,1.1fr,auto] sm:items-center sm:gap-3 hover:bg-black/70"
                >
                  {/* Date */}
                  <div className="text-[0.7rem] text-neutral-400">
                    {r.created_at ? format(new Date(r.created_at), "PP") : "‚Äî"}
                  </div>

                  {/* Main: id, status, customer + vehicle */}
                  <div className="min-w-0 space-y-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <Link
                        href={href}
                        className="text-sm font-semibold text-white underline decoration-neutral-600/50 underline-offset-2 hover:decoration-[var(--accent-copper-light)]"
                      >
                        {r.custom_id ? r.custom_id : `#${r.id.slice(0, 8)}`}
                      </Link>
                      {r.custom_id && (
                        <span className="rounded-full border border-white/15 bg-black/60 px-1.5 py-0.5 text-[0.65rem] font-mono text-neutral-400">
                          #{r.id.slice(0, 6)}
                        </span>
                      )}
                      <span className={chip(r.status)}>
                        {(r.status ?? "awaiting").replaceAll("_", " ")}
                      </span>
                    </div>

                    <div className="truncate text-[0.8rem] text-neutral-300">
                      {customerName || "No customer"}{" "}
                      <span className="mx-1 text-neutral-600">‚Ä¢</span>
                      {vehicleLabel || "No vehicle"}
                      {plate ? (
                        <span className="ml-1 text-neutral-400">
                          ({plate})
                        </span>
                      ) : null}
                    </div>
                  </div>

                  {/* Assigned to */}
                  <div className="text-[0.75rem] text-neutral-300">
                    <WorkOrderAssignedSummary workOrderId={r.id} />
                  </div>

                  {/* Actions */}
                  <div className="flex flex-wrap items-center justify-end gap-2">
                    <Link
                      href={href}
                      className="rounded-full border border-white/15 bg-white/5 px-2.5 py-1 text-xs text-neutral-100 transition hover:border-[var(--accent-copper-light)] hover:bg-[var(--accent-copper)]/20"
                    >
                      Open
                    </Link>
                    <button
                      onClick={() => void handleDelete(r.id)}
                      className="rounded-full border border-red-500/60 bg-red-500/10 px-2.5 py-1 text-xs text-red-200 transition hover:bg-red-500/20"
                    >
                      Delete
                    </button>
                    {canAssign && (
                      <>
                        {!isAssigning ? (
                          <button
                            onClick={() => {
                              setAssigningFor(r.id);
                            }}
                            className="rounded-full border border-sky-500/60 bg-sky-500/10 px-2.5 py-1 text-xs text-sky-100 transition hover:bg-sky-500/25"
                          >
                            Assign
                          </button>
                        ) : (
                          <div className="flex items-center gap-1">
                            <select
                              value={selectedTechId}
                              onChange={(e) => setSelectedTechId(e.target.value)}
                              className={
                                SELECT_DARK +
                                " h-8 min-w-[150px] px-2 py-1 text-[0.7rem]"
                              }
                            >
                              <option value="">Pick mechanic‚Ä¶</option>
                              {techs.map((t) => (
                                <option key={t.id} value={t.id}>
                                  {t.full_name ?? "(no name)"}{" "}
                                  {t.role ? `(${t.role})` : ""}
                                </option>
                              ))}
                            </select>
                            <button
                              onClick={() => void handleAssignAll(r.id)}
                              className="rounded-full bg-[var(--accent-copper)] px-2 py-1 text-[0.7rem] font-semibold text-black shadow-[0_0_18px_rgba(0,0,0,0.9)] hover:opacity-90"
                            >
                              Apply
                            </button>
                            <button
                              onClick={() => setAssigningFor(null)}
                              className="rounded-full border border-white/15 bg_WHITE/5 px-2 py-1 text-[0.7rem] text-neutral-200 hover:bg-white/10"
                            >
                              ‚úï
                            </button>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </section>
      )}
    </div>
  );
}

========================================
FILE: features/work-orders/components/ActiveJobWidget.tsx
========================================
// features/work-orders/components/ActiveJobWidget.tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import Link from "next/link";
import { format } from "date-fns";
import { toast } from "sonner";

import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];

type ActiveJobState = {
  line: WorkOrderLine | null;
  workOrder: WorkOrder | null;
  vehicle: Vehicle | null;
};

export function ActiveJobWidget(): JSX.Element {
  const [loading, setLoading] = useState(true);
  const [state, setState] = useState<ActiveJobState>({
    line: null,
    workOrder: null,
    vehicle: null,
  });
  const [error, setError] = useState<string | null>(null);

  const loadActiveJob = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr) throw userErr;

      if (!user) {
        setState({ line: null, workOrder: null, vehicle: null });
        setLoading(false);
        return;
      }

      // üîç Find the current user's active punched-in line
      const { data: line, error: lineErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("assigned_to", user.id)
        .not("punched_in_at", "is", null)
        .is("punched_out_at", null)
        .order("punched_in_at", { ascending: false })
        .maybeSingle<WorkOrderLine>();

      if (lineErr) throw lineErr;

      if (!line) {
        setState({ line: null, workOrder: null, vehicle: null });
        setLoading(false);
        return;
      }

      let workOrder: WorkOrder | null = null;
      let vehicle: Vehicle | null = null;

      if (line.work_order_id) {
        const { data: wo, error: woErr } = await supabase
          .from("work_orders")
          .select("*")
          .eq("id", line.work_order_id)
          .maybeSingle<WorkOrder>();
        if (woErr) throw woErr;
        workOrder = wo ?? null;

        if (workOrder?.vehicle_id) {
          const { data: veh, error: vehErr } = await supabase
            .from("vehicles")
            .select("*")
            .eq("id", workOrder.vehicle_id)
            .maybeSingle<Vehicle>();
          if (vehErr) throw vehErr;
          vehicle = veh ?? null;
        }
      }

      setState({ line, workOrder, vehicle });
    } catch (e) {
      console.error("[ActiveJobWidget] load error", e);
      const msg =
        (e as { message?: string })?.message ?? "Failed to load active job.";
      setError(msg);
    } finally {
      setLoading(false);
    }
  }, []);

  // initial load
  useEffect(() => {
    void loadActiveJob();
  }, [loadActiveJob]);

  // refresh whenever job punch fires its global event
  useEffect(() => {
    const handler = () => void loadActiveJob();
    window.addEventListener("wol:refresh", handler);
    return () => window.removeEventListener("wol:refresh", handler);
  }, [loadActiveJob]);

  const { line, workOrder, vehicle } = state;

  const startedAt =
    line?.punched_in_at != null
      ? format(new Date(line.punched_in_at), "PPpp")
      : null;

  const href =
    workOrder && line
      ? `/work-orders/${workOrder.custom_id || workOrder.id}?focus=${line.id}`
      : "#";

  // --- UI states ---

  if (loading) {
    return (
      <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 px-4 py-3 text-xs text-neutral-400">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-500">
          Active job
        </div>
        <div className="mt-2 h-4 w-40 animate-pulse rounded-full bg-neutral-800" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="rounded-xl border border-red-700/60 bg-red-950/60 px-4 py-3 text-xs text-red-100">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-red-300">
          Active job
        </div>
        <div className="mt-1">{error}</div>
      </div>
    );
  }

  if (!line || !workOrder) {
    return (
      <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 px-4 py-3 text-xs text-neutral-400">
        <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-500">
          Active job
        </div>
        <div className="mt-1 text-neutral-300">
          No active job. Punch into a job to start tracking time.
        </div>
      </div>
    );
  }

  return (
    <Link
      href={href}
      onClick={() => {
        if (!workOrder || !line) {
          toast.error("Active job link is not available.");
        }
      }}
      className="group block rounded-xl border border-emerald-500/60 bg-neutral-950/90 px-4 py-3 text-xs text-neutral-200 shadow-[0_0_20px_rgba(16,185,129,0.45)] transition hover:border-emerald-400 hover:shadow-[0_0_26px_rgba(16,185,129,0.75)]"
    >
      <div className="mb-1 flex items-center justify-between gap-2">
        <div className="text-[11px] font-semibold uppercase tracking-[0.2em] text-emerald-300">
          ‚óè Active job
        </div>
        <div className="text-[10px] text-neutral-500">
          Tap to open work order
        </div>
      </div>

      <div className="text-sm font-medium text-neutral-50">
        WO {workOrder.custom_id || workOrder.id.slice(0, 8)}
      </div>
      <div className="mt-0.5 truncate text-[13px] text-neutral-200">
        {line.line_no ? `#${line.line_no} ` : ""}
        {line.description || line.complaint || "Job"}
      </div>

      {vehicle && (
        <div className="mt-0.5 truncate text-[11px] text-neutral-400">
          {vehicle.year ?? ""} {vehicle.make ?? ""} {vehicle.model ?? ""}{" "}
          {vehicle.license_plate ? `‚Ä¢ ${vehicle.license_plate}` : ""}
        </div>
      )}

      {startedAt && (
        <div className="mt-1 text-[11px] text-emerald-200">
          Started <span className="font-mono">{startedAt}</span>
        </div>
      )}
    </Link>
  );
}

========================================
FILE: features/work-orders/components/AiSuggestModal.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";

type JobType = "diagnosis" | "repair" | "maintenance" | "tech-suggested";

type RawSuggestion = {
  name: string;
  laborHours: number;
  jobType: JobType;
  notes: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

type UiSuggestion = RawSuggestion & { id: string; selected: boolean };

type AiSuggestModalProps = {
  open: boolean;
  onClose: () => void;
  workOrderId: string;
  vehicleId?: string | null;
  vehicleLabel?: string | null;
  initialComplaint?: string | null;
  onAdded?: (count: number) => void;
};

export function AiSuggestModal(props: AiSuggestModalProps) {
  const {
    open,
    onClose,
    workOrderId,
    vehicleId,
    vehicleLabel,
    initialComplaint,
    onAdded,
  } = props;

  const [complaint, setComplaint] = useState(initialComplaint ?? "");
  const [step, setStep] = useState<"input" | "results">("input");
  const [loading, setLoading] = useState(false);
  const [suggestions, setSuggestions] = useState<UiSuggestion[]>([]);

  // Reset state when modal opens
  useEffect(() => {
    if (!open) return;
    setComplaint(initialComplaint ?? "");
    setStep("input");
    setSuggestions([]);
    setLoading(false);
  }, [open, initialComplaint]);

  if (!open) return null;

  const handleGetSuggestions = async () => {
    if (!workOrderId) {
      toast.error("Create and save the work order first.");
      return;
    }

    setLoading(true);
    try {
      const body: Record<string, unknown> = { workOrderId };

      // We let the backend derive the complaint from first line + vehicle
      if (vehicleId) {
        body.vehicleId = {
          id: vehicleId,
          year: null,
          make: null,
          model: null,
        };
      }

      const res = await fetch("/api/work-orders/suggest-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const json = (await res.json()) as
        | { suggestions?: RawSuggestion[]; error?: string }
        | undefined;

      if (!res.ok || !json?.suggestions) {
        throw new Error(json?.error || "AI suggestions failed");
      }

      const ui: UiSuggestion[] = json.suggestions.map((s, idx) => ({
        ...s,
        id: `${idx}`,
        selected: true,
      }));

      if (ui.length === 0) {
        toast.info("No specific suggestions. Try adding a complaint first.");
      }

      setSuggestions(ui);
      setStep("results");
    } catch (err) {
      const msg =
        err instanceof Error ? err.message : "Could not get AI suggestions.";
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const handleAddSelected = async () => {
    const selected = suggestions.filter((s) => s.selected);
    if (selected.length === 0) {
      toast.info("Select at least one job to add.");
      return;
    }

    setLoading(true);
    try {
      const items = selected.map((s) => ({
        description: s.name,
        serviceCode: undefined,
        jobType: s.jobType,
        laborHours: s.laborHours,
        notes: s.notes,
        aiComplaint: s.aiComplaint ?? (complaint || undefined),
        aiCause: s.aiCause,
        aiCorrection: s.aiCorrection,
      }));

      const res = await fetch("/api/work-orders/add-suggested-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          items,
        }),
      });

      const json = (await res.json()) as
        | { ok?: boolean; inserted?: number; error?: string }
        | undefined;

      if (!res.ok || !json?.ok) {
        throw new Error(json?.error || "Failed to add suggested lines.");
      }

      const count = json.inserted ?? selected.length;
      toast.success(`Added ${count} AI suggested job${count === 1 ? "" : "s"}.`);

      onAdded?.(count);

      // let the create page know something changed
      window.dispatchEvent(new CustomEvent("wo:line-added"));

      onClose();
    } catch (err) {
      const msg =
        err instanceof Error
          ? err.message
          : "Could not add suggested lines to work order.";
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const handleToggle = (id: string) => {
    setSuggestions((prev) =>
      prev.map((s) => (s.id === id ? { ...s, selected: !s.selected } : s)),
    );
  };

  const btnLabel =
    step === "input"
      ? loading
        ? "Thinking‚Ä¶"
        : "Suggest Jobs"
      : loading
      ? "Adding‚Ä¶"
      : "Add Selected";

  const handlePrimary = async () => {
    if (step === "input") {
      await handleGetSuggestions();
    } else {
      await handleAddSelected();
    }
  };

  return (
    <ModalShell
      isOpen={open}
      onClose={onClose}
      title="AI: Suggest Services"
      size="md"
      onSubmit={handlePrimary}
      submitText={btnLabel}
      footerLeft={
        step === "results" ? (
          <button
            type="button"
            onClick={() => {
              setStep("input");
              setSuggestions([]);
            }}
            className="text-xs text-neutral-400 hover:text-neutral-200"
          >
            Start over
          </button>
        ) : null
      }
    >
      <div className="space-y-3">
        <div>
          <p className="text-xs text-neutral-400">
            Describe the concern. We‚Äôll suggest jobs and add them as
            <span className="font-semibold text-neutral-200">
              {" "}
              quote lines (awaiting approval)
            </span>
            .
          </p>
          {vehicleLabel && (
            <p className="mt-1 text-xs text-neutral-500">
              Using context for:{" "}
              <span className="font-mono text-neutral-100">
                {vehicleLabel}
              </span>
            </p>
          )}
        </div>

        {/* Complaint input (always visible; feeds aiComplaint if LLM doesn‚Äôt supply its own) */}
        <div>
          <label className="mb-1 block text-xs uppercase tracking-wide text-neutral-400">
            Customer concern
          </label>
          <textarea
            rows={3}
            value={complaint}
            onChange={(e) => setComplaint(e.target.value)}
            placeholder="Example: Customer reports vibration at highway speeds, no dash lights on. Recently replaced front tires."
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
          />
        </div>

        {step === "results" && (
          <div className="max-h-56 space-y-2 overflow-y-auto rounded border border-neutral-800 bg-neutral-950 p-2">
            {suggestions.length === 0 ? (
              <p className="text-xs text-neutral-500">
                No suggestions yet. Try adjusting the complaint text.
              </p>
            ) : (
              suggestions.map((s) => (
                <button
                  key={s.id}
                  type="button"
                  onClick={() => handleToggle(s.id)}
                  className={`flex w-full items-start gap-2 rounded px-2 py-1.5 text-left text-xs ${
                    s.selected
                      ? "border border-orange-500/80 bg-orange-500/10"
                      : "border border-neutral-800 bg-neutral-950"
                  }`}
                >
                  <input
                    type="checkbox"
                    checked={s.selected}
                    onChange={() => handleToggle(s.id)}
                    className="mt-0.5 h-3.5 w-3.5 rounded border-neutral-600 bg-neutral-900"
                  />
                  <div className="flex-1">
                    <div className="flex flex-wrap items-center gap-1">
                      <span className="font-medium text-neutral-100">
                        {s.name}
                      </span>
                      <span className="rounded-full border border-neutral-600 px-1.5 py-0.5 text-[10px] uppercase tracking-wide text-neutral-300">
                        {s.jobType.replace("-", " ")}
                      </span>
                      <span className="text-[10px] text-neutral-400">
                        ~{s.laborHours}h
                      </span>
                    </div>
                    {s.notes && (
                      <p className="mt-0.5 text-[11px] text-neutral-400">
                        {s.notes}
                      </p>
                    )}
                  </div>
                </button>
              ))
            )}
          </div>
        )}
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/JobCard.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import type { Database } from "@shared/types/types/supabase";
import { UsePartButton } from "@work-orders/components/UsePartButton";
import { PartsUsedList } from "@work-orders/components/PartsUsedList";

type DB = Database;

export type WorkOrderLine =
  DB["public"]["Tables"]["work_order_lines"]["Row"];

export type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

export type TechnicianInfo = {
  id: string;
  full_name: string | null;
  role: string | null;
};

export type JobCardPricing = {
  partsTotal?: number | null;
  laborTotal?: number | null;
  lineTotal?: number | null;
  currency?: string; // e.g. "CAD", "USD"
};

export type JobCardProps = {
  index: number;
  line: WorkOrderLine;
  parts: AllocationRow[];
  technicians: TechnicianInfo[];
  canAssign?: boolean;
  isPunchedIn?: boolean;
  onOpen: () => void;
  onAssign?: () => void;
  onOpenInspection?: () => void;
  onAddPart?: () => void;
  /** Optional pricing info ‚Äì we‚Äôll wire this from the page later */
  pricing?: JobCardPricing;
};

/* ---------------------------- Status visuals ---------------------------- */

type KnownStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

/** Status pill styling (matches WO header pills, but beefed up + glow) */
const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-3 py-1 text-[11px] sm:text-xs font-semibold tracking-wide shadow-[0_0_16px_rgba(251,191,36,0.35)]";

const BADGE: Record<KnownStatus, string> = {
  awaiting_approval:
    "bg-blue-900/40 border-blue-400/70 text-blue-100",
  awaiting:
    "bg-sky-900/40 border-sky-400/70 text-sky-100",
  queued:
    "bg-indigo-900/40 border-indigo-400/70 text-indigo-100",
  in_progress:
    "bg-orange-900/40 border-orange-400/80 text-orange-100",
  on_hold:
    "bg-amber-900/40 border-amber-400/80 text-amber-100",
  planned:
    "bg-purple-900/40 border-purple-400/80 text-purple-100",
  new:
    "bg-neutral-900/70 border-neutral-500/80 text-neutral-100",
  completed:
    "bg-emerald-900/40 border-emerald-400/80 text-emerald-100",
  ready_to_invoice:
    "bg-emerald-900/40 border-emerald-400/80 text-emerald-100",
  invoiced:
    "bg-teal-900/40 border-teal-400/80 text-teal-100",
};

const statusChip = (s: string | null | undefined): string => {
  const key = (s ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;
  return `${BASE_BADGE} ${BADGE[key] ?? BADGE.awaiting}`;
};

/**
 * Card border / background styles ‚Äì kept in sync with the mobile WO client
 */
const CARD_SURFACE: Record<
  KnownStatus,
  { border: string; surface: string; ring: string }
> = {
  awaiting_approval: {
    border: "border-sky-500/50",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.10),rgba(15,23,42,0.98))]",
    ring: "ring-sky-400/70",
  },
  awaiting: {
    border: "border-slate-600/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.12),rgba(15,23,42,0.98))]",
    ring: "ring-slate-300/80",
  },
  queued: {
    border: "border-indigo-500/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(129,140,248,0.12),rgba(15,23,42,0.98))]",
    ring: "ring-indigo-400/80",
  },
  in_progress: {
    border: "border-[color:var(--accent-copper-soft)]",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.20),rgba(15,23,42,0.98))]",
    ring: "ring-[color:var(--accent-copper-soft)]/80",
  },
  on_hold: {
    border: "border-amber-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(251,191,36,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-amber-300/80",
  },
  planned: {
    border: "border-purple-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(192,132,252,0.16),rgba(15,23,42,0.98))]",
    ring: "ring-purple-300/80",
  },
  new: {
    border: "border-neutral-600/80",
    surface: "bg-neutral-950/90",
    ring: "ring-neutral-400/80",
  },
  completed: {
    border: "border-teal-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-teal-300/80",
  },
  ready_to_invoice: {
    border: "border-emerald-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-emerald-300/80",
  },
  invoiced: {
    border: "border-teal-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-teal-300/80",
  },
};

export function JobCard({
  index,
  line,
  parts,
  technicians,
  canAssign,
  isPunchedIn,
  onOpen,
  onAssign,
  onOpenInspection,
  onAddPart,
  pricing,
}: JobCardProps): JSX.Element {
  const statusKey = (line.status ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;

  const surfaceCfg = CARD_SURFACE[statusKey] ?? CARD_SURFACE.awaiting;

  const [partsOpen, setPartsOpen] = useState(false);

  const isCompletedLike = () => {
    const s = (line.status ?? "").toLowerCase();
    return s === "completed" || s === "ready_to_invoice" || s === "invoiced";
  };

  // Completed / invoiced jobs start collapsed
  const [collapsed, setCollapsed] = useState<boolean>(isCompletedLike());

  // If status changes (e.g. job finished), update collapsed state
  useEffect(() => {
    setCollapsed(isCompletedLike());
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [line.status]);

  const jobLabel =
    line.description || line.complaint || "Untitled job";

  const laborText =
    typeof line.labor_time === "number"
      ? `${line.labor_time}h`
      : "‚Äî";

  const jobTypeText = String(line.job_type ?? "job").replaceAll(
    "_",
    " ",
  );
  const statusText = String(line.status ?? "awaiting").replaceAll(
    "_",
    " ",
  );

  const showPricingRow =
    pricing &&
    (pricing.partsTotal != null ||
      pricing.laborTotal != null ||
      pricing.lineTotal != null);

  const currency =
    pricing?.currency && pricing.currency.trim().length > 0
      ? pricing.currency
      : undefined;

  const formatMoney = (v: number | null | undefined): string => {
    if (v == null || Number.isNaN(v)) return "‚Äî";
    const n = Number(v);
    return `${currency ?? "$"}${n.toFixed(2)}`;
  };

  const partsCount = parts.length;
  const partsSummary =
    partsCount === 0
      ? "No parts yet"
      : `${partsCount} part${partsCount === 1 ? "" : "s"}`;

  const handleCardClick = () => {
    // Only open the focused modal; do NOT toggle collapsed here
    onOpen();
  };

  const toggleCollapsed = (e: React.MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();
    setCollapsed((c) => !c);
  };

  return (
    <div
      className={`group cursor-pointer rounded-xl border ${surfaceCfg.border} ${surfaceCfg.surface} p-3 transition
        shadow-[0_18px_45px_rgba(0,0,0,0.85)]
        hover:shadow-[0_22px_55px_rgba(0,0,0,0.95)]
        ${isPunchedIn ? `ring-2 ${surfaceCfg.ring}` : "ring-0"}
      `}
      title="Open focused job"
      onClick={handleCardClick}
    >
      <div className="flex items-start justify-between gap-3">
        {/* LEFT CONTENT */}
        <div className="min-w-0 space-y-1.5">
          {/* Top row: title + controls */}
          <div className="flex flex-wrap items-center gap-2">
            {/* Left side: title + assign + inspection */}
            <div className="flex min-w-0 flex-1 flex-wrap items-center gap-2">
              <div className="truncate text-sm font-medium text-white">
                {index + 1}. {jobLabel}
              </div>

              {canAssign && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onAssign?.();
                  }}
                  className="rounded-md border border-sky-500/70 px-2 py-0.5 text-[11px] font-medium text-sky-200 hover:bg-sky-900/25"
                  title="Assign mechanic to this line"
                >
                  Assign mechanic
                </button>
              )}

              {line.job_type === "inspection" && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onOpenInspection?.();
                  }}
                  className={`rounded-md border px-2 py-0.5 text-[11px] font-medium ${
                    isCompletedLike()
                      ? "border-teal-400 text-teal-200"
                      : "border-orange-400 text-orange-200 hover:bg-orange-500/10"
                  }`}
                >
                  {isCompletedLike()
                    ? "View inspection"
                    : "Open inspection"}
                </button>
              )}
            </div>

            {/* Right side: expand icon + status pill + add-part button */}
            <div className="ml-auto flex items-center gap-2">
              {/* Expand / collapse icon */}
              <button
                type="button"
                onClick={toggleCollapsed}
                className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-neutral-700/80 bg-black/50 text-[11px] text-neutral-200 shadow-[0_0_14px_rgba(15,23,42,0.9)] hover:border-[color:var(--accent-copper-soft,#fdba74)] hover:text-white hover:bg-black/80"
                title={collapsed ? "Expand job details" : "Collapse job details"}
              >
                <span
                  className={`inline-block transform text-[11px] transition-transform ${
                    collapsed ? "" : "rotate-90"
                  }`}
                >
                  ‚ñ∂
                </span>
              </button>

              {/* Status pill */}
              <span className={statusChip(line.status)}>
                {statusText}
              </span>

              {/* Desktop add-part button */}
              <button
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  onAddPart?.();
                }}
                className="hidden rounded-md border border-neutral-600 px-2 py-1 text-[11px] font-medium text-neutral-100 hover:border-orange-500 hover:text-orange-100 sm:inline-flex"
                title="Add / use part on this job"
              >
                Add part
              </button>

              {/* keep existing UsePartButton behavior for safety (esp. mobile) */}
              <div className="sm:hidden">
                <UsePartButton
                  workOrderLineId={line.id}
                  onApplied={() =>
                    window.dispatchEvent(
                      new CustomEvent("wo:parts-used"),
                    )
                  }
                  label="Add part"
                />
              </div>
            </div>
          </div>

          {/* Meta line */}
          <div className="text-[11px] text-neutral-300">
            {jobTypeText} ‚Ä¢ {laborText} ‚Ä¢ Status: {statusText}
          </div>

          {/* Completed jobs: small ‚Äútap to expand‚Äù hint */}
          {isCompletedLike() && (
            <div className="text-[10px] text-teal-200/80">
              {collapsed
                ? "Completed job ‚Äì use the chevron to view details."
                : "Completed job ‚Äì use the chevron to collapse details."}
            </div>
          )}

          {/* Everything below here can be collapsed */}
          {!collapsed && (
            <>
              {/* Technician chips */}
              {technicians.length > 0 && (
                <div className="mt-0.5 flex flex-wrap gap-1">
                  {technicians.map((tech) => (
                    <span
                      key={tech.id}
                      className="inline-flex items-center gap-1 rounded-full bg-sky-900/40 px-2 py-0.5 text-[10px] text-sky-100"
                    >
                      <span className="h-1.5 w-1.5 rounded-full bg-sky-300" />
                      {tech.full_name ?? "Mechanic"}
                    </span>
                  ))}
                </div>
              )}

              {/* Complaint / cause / correction */}
              {(line.complaint || line.cause || line.correction) && (
                <div className="mt-0.5 flex flex-wrap items-center gap-2 text-[11px] text-neutral-300">
                  {line.complaint && <span>Cmpl: {line.complaint}</span>}
                  {line.cause && <span>| Cause: {line.cause}</span>}
                  {line.correction && (
                    <span>| Corr: {line.correction}</span>
                  )}
                </div>
              )}

              {/* Parts accordion */}
              <div className="mt-2 rounded-lg border border-neutral-800 bg-neutral-950/80">
                <button
                  type="button"
                  className="flex w-full items-center justify-between gap-2 px-2 py-1.5 text-left"
                  onClick={(e) => {
                    e.stopPropagation();
                    setPartsOpen((open) => !open);
                  }}
                >
                  <div className="flex flex-col">
                    <span className="text-[11px] font-semibold uppercase tracking-wide text-neutral-300">
                      Parts used
                    </span>
                    <span className="text-[10px] text-neutral-500">
                      {partsSummary}
                    </span>
                  </div>

                  <div className="flex items-center gap-2">
                    {/* small inline add-part on mobile + tablet */}
                    <button
                      type="button"
                      onClick={(e) => {
                        e.stopPropagation();
                        onAddPart?.();
                      }}
                      className="inline-flex items-center rounded-md border border-neutral-700 px-2 py-0.5 text-[11px] font-medium text-neutral-200 hover:border-orange-500 hover:text-orange-100 sm:hidden"
                    >
                      Add part
                    </button>

                    <span
                      className={`text-[10px] text-neutral-400 transition-transform ${
                        partsOpen ? "rotate-90" : ""
                      }`}
                    >
                      ‚ñ∂
                    </span>
                  </div>
                </button>

                {partsOpen && (
                  <div
                    className="border-t border-neutral-800 px-2 pb-2 pt-1.5"
                    onClick={(e) => e.stopPropagation()}
                  >
                    <PartsUsedList allocations={parts} />
                  </div>
                )}
              </div>

              {/* Pricing summary row (optional, only if provided) */}
              {showPricingRow && (
                <div className="mt-2 flex flex-wrap items-center justify-end gap-3 text-[11px] text-neutral-300">
                  {pricing?.partsTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Parts</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.partsTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.laborTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Labor</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.laborTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.lineTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Line total</span>
                      <span className="font-semibold text-[color:var(--accent-copper-light)]">
                        {formatMoney(pricing.lineTotal)}
                      </span>
                    </span>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/components/JobPunchButton.tsx
========================================
// shared/components/JobPunchButton.tsx
"use client";

import { useMemo, useState } from "react";
import { toast } from "sonner";
import { Button } from "@shared/components/ui/Button";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type Props = {
  lineId: string;
  punchedInAt?: string | null;
  punchedOutAt?: string | null;
  status?: string | null;
  onUpdated?: () => void | Promise<void>;
  onFinishRequested?: () => void;
  disabled?: boolean;
};

type DB = Database;

export default function JobPunchButton({
  lineId,
  punchedInAt,
  punchedOutAt,
  status,
  onUpdated,
  onFinishRequested,
  disabled = false,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);
  const [busy, setBusy] = useState(false);
  const [flash, setFlash] = useState<"started" | "finished" | null>(null);

  const normalizedStatus = (status ?? "").toLowerCase();
  const isOnHold = normalizedStatus === "on_hold";

  const isStarted = !!punchedInAt && !punchedOutAt && !isOnHold;
  const effectiveDisabled = disabled || isOnHold;

  const showFlash = (kind: typeof flash) => {
    setFlash(kind);
    window.setTimeout(() => setFlash(null), 1200);
  };

  const start = async () => {
    if (busy || effectiveDisabled) return;
    setBusy(true);
    try {
      // Uses your RPC (enforces one active job, assignment, etc.)
      const { error: punchErr } = await supabase.rpc("punch_in", {
        line_id: lineId,
      });

      if (punchErr) {
        if (punchErr.code === "23505") {
          toast.error("You already have another active job. Finish it first.");
        } else if (punchErr.code === "28000") {
          toast.error("Job is not assigned to you.");
        } else {
          toast.error(punchErr.message ?? "Start failed");
        }
        return;
      }

      const nowIso = new Date().toISOString();

      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        status: "in_progress",
        punched_out_at: null,
      };

      if (!punchedInAt) update.punched_in_at = nowIso;

      const { error: lineErr } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", lineId);

      if (lineErr) {
        toast.error(lineErr.message ?? "Failed to update job status");
        return;
      }

      toast.success("Started job");
      showFlash("started");

      window.dispatchEvent(new CustomEvent("wol:refresh"));
      await onUpdated?.();
    } catch (e) {
      toast.error(e instanceof Error ? e.message : "Start failed");
    } finally {
      setBusy(false);
    }
  };

  const handlePrimary = () => {
    if (busy || effectiveDisabled) return;

    if (isStarted) {
      onFinishRequested?.();
      showFlash("finished");
      return;
    }

    void start();
  };

  const label = busy
    ? "Saving‚Ä¶"
    : isStarted
    ? "Finish job"
    : isOnHold
    ? "On hold"
    : "Start job";

  return (
    <div className="relative w-full">
      <Button
        type="button"
        onClick={handlePrimary}
        disabled={busy || effectiveDisabled}
        isLoading={busy}
        variant={isStarted ? "outline" : "copper"}
        size="md"
        className="inline-flex w-full items-center justify-center text-center text-sm font-blackops tracking-[0.16em] uppercase"
        aria-pressed={isStarted}
        aria-busy={busy}
      >
        {label}
      </Button>

      {flash && (
        <div
          className={`pointer-events-none absolute inset-x-0 -top-3 mx-auto w-fit rounded px-2 py-1 text-xs font-semibold shadow-md
            ${
              flash === "started"
                ? "bg-emerald-700/80 text-emerald-100"
                : "bg-[rgba(184,115,51,0.9)] text-black shadow-[0_0_15px_rgba(184,115,51,0.9)]"
            }`}
        >
          {flash === "started" ? "‚úì Started" : "‚úì Finish requested"}
        </div>
      )}

      {isOnHold && !busy && (
        <div className="mt-1 text-center text-[10px] text-amber-300">
          Job is on hold ‚Äî release hold to start again.
        </div>
      )}
    </div>
  );
}

========================================
FILE: features/work-orders/components/manager/ManagerJobDashboard.tsx
========================================
// features/dashboard/app/dashboard/manager/page.tsx
import { Suspense } from "react";
import { redirect } from "next/navigation";
import { createServerSupabaseRSC } from "@shared/lib/supabase/server";
import ManagerJobDashboard from "@work-orders/components/manager/ManagerJobDashboard";

export const metadata = { title: "Manager Dashboard" };

export default async function ManagerDashboardPage() {
  const supabase = await createServerSupabaseRSC();

  const {
    data: { user },
  } = await supabase.auth.getUser();

  if (!user) {
    redirect("/auth"); // change to your sign-in route if different
  }

  // Basic role guard ‚Äì adjust allowed roles as needed
  const { data: profile } = await supabase
    .from("profiles")
    .select("role")
    .eq("id", user.id)
    .single();

  const allowedRoles = new Set(["manager", "advisor", "owner", "admin"]);
  if (!profile || !allowedRoles.has(profile.role ?? "")) {
    redirect("/dashboard");
  }

  return (
    <Suspense fallback={<div className="p-4 text-neutral-400">Loading Manager Dashboard‚Ä¶</div>}>
      <ManagerJobDashboard />
    </Suspense>
  );
}

========================================
FILE: features/work-orders/components/MenuQuickAdd.tsx
========================================
"use client";

import { useEffect, useMemo, useRef, useState, useCallback } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database, TablesInsert } from "@shared/types/types/supabase";
import { AiSuggestModal } from "@work-orders/components/AiSuggestModal";

type DB = Database;
type WorkOrderLineInsert = TablesInsert<"work_order_lines">;

type JobType = "maintenance" | "repair" | "diagnosis" | "inspection";

type PackageItem = {
  description: string;
  jobType?: JobType;
  laborHours?: number | null;
  notes?: string | null;
};

type PackageDef = {
  id: string;
  name: string;
  summary: string;
  jobType: "inspection" | "maintenance";
  estLaborHours: number | null;
  items: PackageItem[];
};

type MenuItemRow = DB["public"]["Tables"]["menu_items"]["Row"];

// DB table has labor_hours, so add it if your generated type is missing it
type TemplateRow = DB["public"]["Tables"]["inspection_templates"]["Row"] & {
  labor_hours?: number | null;
};

type VehicleLite = {
  id?: string | null;
  year?: string | number | null;
  make?: string | null;
  model?: string | null;
  vin?: string | null;
  license_plate?: string | null;
};

type CustomerLite = {
  id?: string | null;
  first_name?: string | null;
  last_name?: string | null;
  phone?: string | null;
  email?: string | null;
};

type PartToAllocate = {
  sku?: string | null;
  name?: string | null;
  qty: number;
};

type AddMenuParams =
  | {
      kind?: "normal";
      name: string;
      jobType: JobType;
      laborHours?: number | null;
      notes?: string | null;
      source?: "single" | "package" | "menu_item" | "ai" | "inspection";
      returnLineId?: boolean;
      partsToAllocate?: PartToAllocate[];
    }
  | {
      kind: "template";
      template: TemplateRow;
      name?: string;
      laborHours?: number | null;
    };

export function MenuQuickAdd({ workOrderId }: { workOrderId: string }) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  // curated packages
  const packages: PackageDef[] = [
    {
      id: "oil-gas",
      name: "Oil Change ‚Äì Gasoline",
      jobType: "maintenance",
      estLaborHours: 0.8,
      summary: "Oil & filter, fluids, tire pressures, quick leak check.",
      items: [],
    },
    {
      id: "insp-gas",
      name: "Multi-Point Inspection ‚Äì Gas",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "Brakes, tires, suspension, battery, lights, codes scan.",
      items: [],
    },
    {
      id: "maintenance-50",
      name: "Maintenance 50",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "50-point inspection checklist.",
      items: [],
    },
    {
      id: "maintenance-50-air",
      name: "Maintenance 50 ‚Äì Air",
      jobType: "inspection",
      estLaborHours: 1.0,
      summary: "50-point inspection checklist (air systems focus).",
      items: [],
    },
  ];

  const [addingId, setAddingId] = useState<string | null>(null);
  const [vehicle, setVehicle] = useState<VehicleLite | null>(null);
  const [, setCustomer] = useState<CustomerLite | null>(null);
  const [woLineCount, setWoLineCount] = useState<number | null>(null);

  // saved menu items
  const [menuItems, setMenuItems] = useState<MenuItemRow[]>([]);
  const [menuLoading, setMenuLoading] = useState(false);

  // inspection templates
  const [templates, setTemplates] = useState<TemplateRow[]>([]);
  const [templatesLoading, setTemplatesLoading] = useState(false);

  // shop context
  const [shopId, setShopId] = useState<string | null>(null);
  const shopReady = !!shopId;
  const vehicleId = vehicle?.id ?? null;

  // AI modal (new, using shared AiSuggestModal)
  const [aiOpen, setAiOpen] = useState(false);

  const lastSetShopId = useRef<string | null>(null);
  async function ensureShopContext(id: string | null) {
    if (!id) return;
    if (lastSetShopId.current === id) return;
    const { error } = await supabase.rpc("set_current_shop_id", {
      p_shop_id: id,
    });
    if (!error) {
      lastSetShopId.current = id;
    } else {
      throw error;
    }
  }

  // bootstrap WO + related (shop, vehicle, customer, line count)
  useEffect(() => {
    (async () => {
      const { data: wo } = await supabase
        .from("work_orders")
        .select("id, vehicle_id, customer_id, shop_id")
        .eq("id", workOrderId)
        .maybeSingle();

      setShopId(wo?.shop_id ?? null);

      if (wo?.vehicle_id) {
        const { data: v } = await supabase
          .from("vehicles")
          .select("id, year, make, model, vin, license_plate")
          .eq("id", wo.vehicle_id)
          .maybeSingle();
        if (v) setVehicle(v as VehicleLite);
      } else {
        setVehicle(null);
      }

      if (wo?.customer_id) {
        const { data: c } = await supabase
          .from("customers")
          .select("id, first_name, last_name, phone, email")
          .eq("id", wo.customer_id)
          .maybeSingle();
        if (c) setCustomer(c as CustomerLite);
      } else {
        setCustomer(null);
      }

      const { count } = await supabase
        .from("work_order_lines")
        .select("*", { count: "exact", head: true })
        .eq("work_order_id", workOrderId);
      setWoLineCount(typeof count === "number" ? count : null);
    })();
  }, [supabase, workOrderId]);

  // load saved menu items ‚Äì prefer matches for this vehicle‚Äôs YMM
  const loadMenuItems = useCallback(async () => {
    if (!shopId) return;

    setMenuLoading(true);
    try {
      const vYear =
        typeof vehicle?.year === "number"
          ? vehicle.year
          : typeof vehicle?.year === "string"
          ? parseInt(vehicle.year, 10)
          : null;

      const vMake =
        typeof vehicle?.make === "string" && vehicle.make.trim().length
          ? vehicle.make.trim()
          : null;

      const vModel =
        typeof vehicle?.model === "string" && vehicle.model.trim().length
          ? vehicle.model.trim()
          : null;

      let preferred: MenuItemRow[] = [];
      let others: MenuItemRow[] = [];

      if (vYear || vMake || vModel) {
        // 1) items that match this vehicle‚Äôs YMM
        let q = supabase
          .from("menu_items")
          .select("*")
          .eq("shop_id", shopId)
          .eq("is_active", true)
          .order("created_at", { ascending: false });

        if (vYear) q = q.eq("vehicle_year", vYear);
        if (vMake) q = q.ilike("vehicle_make", vMake);
        if (vModel) q = q.ilike("vehicle_model", vModel);

        const { data: exact, error: exactErr } = await q.limit(20);
        if (exactErr) throw exactErr;
        preferred = (exact ?? []) as MenuItemRow[];

        const excludeIds = preferred.map((mi) => mi.id);
        // 2) recent active items for this shop, excluding the ones already in preferred
        let fbQuery = supabase
          .from("menu_items")
          .select("*")
          .eq("shop_id", shopId)
          .eq("is_active", true)
          .order("created_at", { ascending: false })
          .limit(30);

        if (excludeIds.length) {
          fbQuery = fbQuery.not("id", "in", `(${excludeIds.join(",")})`);
        }

        const { data: fb, error: fbErr } = await fbQuery;
        if (fbErr) throw fbErr;
        others = (fb ?? []) as MenuItemRow[];
      } else {
        // No vehicle context yet: just recent active menu items for this shop
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .eq("shop_id", shopId)
          .eq("is_active", true)
          .order("created_at", { ascending: false })
          .limit(20);
        if (error) throw error;
        preferred = (data ?? []) as MenuItemRow[];
        others = [];
      }

      setMenuItems([...preferred, ...others]);
    } catch {
      // ignore; soft fail
    } finally {
      setMenuLoading(false);
    }
  }, [supabase, shopId, vehicle]);

  // load inspection templates (owner + public + same-shop via RLS)
  const loadTemplates = useCallback(async () => {
    if (!shopId) return;

    setTemplatesLoading(true);
    try {
      // Make sure current_shop_id is set so shop-wide RLS kicks in
      await ensureShopContext(shopId);

      const [{ data: auth }, { data, error }] = await Promise.all([
        supabase.auth.getUser(),
        supabase
          .from("inspection_templates")
          .select("*")
          .order("created_at", { ascending: false }),
      ]);

      if (error) throw error;

      const uid = auth?.user?.id ?? null;
      const rows = (data ?? []) as TemplateRow[];

      // Sort: mine ‚Üí same-shop ‚Üí public ‚Üí rest
      const score = (t: TemplateRow): number => {
        if (uid && t.user_id === uid) return 0;
        if (t.shop_id && t.shop_id === shopId) return 1;
        if (t.is_public) return 2;
        return 3;
      };

      rows.sort((a, b) => score(a) - score(b));
      setTemplates(rows);
    } catch {
      // ignore; soft fail ‚Äì user just sees "No templates yet"
      setTemplates([]);
    } finally {
      setTemplatesLoading(false);
    }
  }, [supabase, shopId]);

  // initial loads
  useEffect(() => {
    if (shopId) {
      void loadMenuItems();
      void loadTemplates();
    }
  }, [shopId, loadMenuItems, loadTemplates]);

  // ============================================================
  // add line (menu or template)
  // ============================================================
  async function addMenuItem(params: AddMenuParams): Promise<string | null> {
    if (!shopReady) return null;

    setAddingId(params.kind === "template" ? params.template.id : params.name);
    try {
      await ensureShopContext(shopId);

      // template-backed line
      if (params.kind === "template") {
        const line: WorkOrderLineInsert & {
          inspection_template_id?: string | null;
        } = {
          work_order_id: workOrderId,
          vehicle_id: vehicleId,
          description:
            params.name ?? params.template.template_name ?? "Inspection",
          job_type: "inspection",
          labor_time:
            params.laborHours ??
            (typeof params.template.labor_hours === "number"
              ? params.template.labor_hours
              : null),
          status: "awaiting",
          priority: 3,
          notes: params.template.description ?? null,
          shop_id: shopId!,
          inspection_template_id: params.template.id,
        };

        const { data, error } = await supabase
          .from("work_order_lines")
          .insert(line)
          .select("id")
          .single();

        if (error) throw error;

        window.dispatchEvent(new CustomEvent("wo:line-added"));
        toast.success("Inspection added");
        return data?.id ?? null;
      }

      // normal branch
      const line: WorkOrderLineInsert = {
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        description: params.name,
        job_type: params.jobType,
        labor_time: params.laborHours ?? null,
        status: "awaiting",
        priority: 3,
        notes: params.notes ?? null,
        shop_id: shopId!,
      };

      const { data, error } = await supabase
        .from("work_order_lines")
        .insert(line)
        .select("id")
        .single();

      if (error) throw error;

      if (params.partsToAllocate && params.partsToAllocate.length && data?.id) {
        await autoAllocateExplicitParts(params.partsToAllocate, data.id);
      }

      window.dispatchEvent(new CustomEvent("wo:line-added"));
      toast.success(
        params.source === "ai"
          ? "AI suggestion added"
          : params.source === "menu_item"
          ? "Menu item added"
          : "Job added",
      );

      return params.returnLineId ? (data?.id ?? null) : null;
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to add job.";
      lastSetShopId.current = null;
      toast.error(msg);
      return null;
    } finally {
      setAddingId(null);
    }
  }

  // ---------- allocation helpers ----------
  type MenuItemPartRow = {
    id: string;
    name: string | null;
    sku: string | null;
    quantity: number | null;
    unit_cost: number | null;
  };

  async function findPartIdForShop({
    sku,
    name,
    shop,
  }: {
    sku?: string | null;
    name?: string | null;
    shop: string;
  }): Promise<string | null> {
    if (sku) {
      const bySku = await supabase
        .from("parts")
        .select("id")
        .eq("shop_id", shop)
        .eq("sku", sku)
        .limit(1)
        .maybeSingle();
      if (!bySku.error && bySku.data?.id) return bySku.data.id;
    }
    if (name) {
      const byName = await supabase
        .from("parts")
        .select("id")
        .eq("shop_id", shop)
        .ilike("name", name)
        .limit(1)
        .maybeSingle();
      if (byName.data?.id) return byName.data.id;
    }
    return null;
  }

  async function pickDefaultLocationId(
    partId: string,
    shop: string,
  ): Promise<string | null> {
    const withStock = await supabase
      .from("part_stock")
      .select("location_id, qty")
      .eq("part_id", partId)
      .order("qty", { ascending: false })
      .limit(1);

    if (!withStock.error && withStock.data?.length) {
      return withStock.data[0].location_id as unknown as string;
    }

    const anyLoc = await supabase
      .from("stock_locations")
      .select("id")
      .eq("shop_id", shop)
      .order("created_at", { ascending: true })
      .limit(1)
      .maybeSingle();

    return anyLoc.data?.id ?? null;
  }

  async function autoAllocateMenuParts(
    menuItemId: string,
    workOrderLineId: string,
  ) {
    if (!shopId) return;

    const { data: rows, error } = await supabase
      .from("menu_item_parts")
      .select("id, name, sku, quantity, unit_cost")
      .eq("menu_item_id", menuItemId);

    if (error) {
      toast.message("Added job, but couldn't read menu parts.");
      return;
    }

    const mParts = (rows ?? []) as MenuItemPartRow[];
    const allocations: {
      work_order_line_id: string;
      part_id: string;
      location_id: string;
      qty: number;
    }[] = [];

    for (const p of mParts) {
      const qty =
        typeof p.quantity === "number" && p.quantity > 0 ? p.quantity : 0;
      if (!qty) continue;

      const partId = await findPartIdForShop({
        sku: p.sku ?? undefined,
        name: p.name ?? undefined,
        shop: shopId,
      });
      if (!partId) {
        toast.message(
          `Skipped "${p.name ?? p.sku ?? "part"}" (not in Parts).`,
        );
        continue;
      }
      const locId = await pickDefaultLocationId(partId, shopId);
      if (!locId) {
        toast.message(
          `Skipped "${p.name ?? p.sku ?? "part"}" (no stock location).`,
        );
        continue;
      }
      allocations.push({
        work_order_line_id: workOrderLineId,
        part_id: partId,
        location_id: locId,
        qty,
      });
    }

    if (!allocations.length) return;

    const { error: allocErr } = await supabase
      .from("work_order_part_allocations")
      .insert(allocations);
    if (allocErr) {
      toast.warning("Job added, but parts couldn't be allocated.");
    } else {
      window.dispatchEvent(new CustomEvent("wo:parts-used"));
      toast.success(
        `Allocated ${allocations.length} part${
          allocations.length > 1 ? "s" : ""
        }`,
      );
    }
  }

  async function autoAllocateExplicitParts(
    list: PartToAllocate[],
    workOrderLineId: string,
  ) {
    if (!shopId || !list.length) return;

    const allocations: {
      work_order_line_id: string;
      part_id: string;
      location_id: string;
      qty: number;
    }[] = [];

    for (const raw of list) {
      const qty = typeof raw.qty === "number" && raw.qty > 0 ? raw.qty : 0;
      if (!qty) continue;

      const partId = await findPartIdForShop({
        sku: raw.sku ?? undefined,
        name: raw.name ?? undefined,
        shop: shopId,
      });
      if (!partId) continue;

      const locId = await pickDefaultLocationId(partId, shopId);
      if (!locId) continue;

      allocations.push({
        work_order_line_id: workOrderLineId,
        part_id: partId,
        location_id: locId,
        qty,
      });
    }

    if (!allocations.length) return;
    const { error } = await supabase
      .from("work_order_part_allocations")
      .insert(allocations);
    if (!error) window.dispatchEvent(new CustomEvent("wo:parts-used"));
  }

  // tiny wrappers
  async function addPackage(pkg: PackageDef) {
    await addMenuItem({
      kind: "normal",
      name: pkg.name,
      jobType: pkg.jobType === "inspection" ? "inspection" : "maintenance",
      laborHours: pkg.estLaborHours ?? null,
      notes: pkg.summary,
      source: "package",
    });
  }

  async function addSavedMenuItem(mi: MenuItemRow) {
    const lineId = await addMenuItem({
      kind: "normal",
      name: mi.name ?? "Service",
      jobType: "maintenance",
      laborHours:
        typeof mi.labor_time === "number"
          ? mi.labor_time
          : // fallback in case you add labor_hours to menu_items later
          typeof (mi as any).labor_hours === "number"
          ? (mi as any).labor_hours
          : null,
      notes: mi.description ?? null,
      source: "menu_item",
      returnLineId: true,
    });
    if (lineId && mi.id) {
      await autoAllocateMenuParts(mi.id, lineId);
    }
  }

  async function addTemplateAsLine(t: TemplateRow) {
    await addMenuItem({
      kind: "template",
      template: t,
    });
  }

  const vehicleLabel =
    vehicle && (vehicle.year || vehicle.make || vehicle.model)
      ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${
          vehicle.model ?? ""
        }`.trim()
      : vehicle?.license_plate
      ? `Plate ${vehicle.license_plate}`
      : null;

  return (
    <div className="space-y-5 text-white">
      {/* Header / context */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 px-3 py-3 sm:px-4 sm:py-3">
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="space-y-1">
            <div className="flex items-center gap-2">
              <h3 className="text-sm font-semibold text-orange-400">
                Quick Add Jobs
              </h3>
              <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] font-mono text-neutral-300">
                WO {workOrderId.slice(0, 8)}‚Ä¶
              </span>
            </div>
            {vehicleLabel && (
              <p className="text-[11px] text-neutral-400">
                Vehicle:&nbsp;
                <span className="font-medium text-neutral-200">
                  {vehicleLabel}
                </span>
              </p>
            )}
            {!vehicleLabel && (
              <p className="text-[11px] text-neutral-500">
                Add lines now ‚Äî you can update vehicle details later.
              </p>
            )}
          </div>

          <div className="flex flex-wrap items-center justify-end gap-2">
            <button
              type="button"
              onClick={() =>
                router.push(`/work-orders/quote-review?woId=${workOrderId}`)
              }
              className="rounded-md border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-xs sm:text-sm text-neutral-100 hover:border-orange-500 hover:bg-neutral-800"
            >
              Review quote
              {typeof woLineCount === "number" && woLineCount > 0
                ? ` (${woLineCount})`
                : ""}
            </button>
            <button
              type="button"
              onClick={() => setAiOpen(true)}
              className="rounded-md border border-blue-600 bg-neutral-950 px-3 py-1.5 text-xs sm:text-sm text-blue-300 hover:bg-blue-900/30"
              title="Describe work and let AI suggest service lines"
            >
              AI Suggest
            </button>
          </div>
        </div>
      </div>

      {/* Packages */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">
            Packages
          </h4>
          <p className="text-[10px] text-neutral-500">
            Common services with pre-set labor & notes.
          </p>
        </div>
        <div className="grid gap-2 sm:grid-cols-2">
          {packages.map((p) => (
            <button
              type="button"
              key={p.id}
              onClick={() => addPackage(p)}
              disabled={addingId === p.id || !shopReady}
              className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
              title={p.summary}
            >
              <div className="flex items-center justify-between gap-2">
                <span className="font-medium text-neutral-50">{p.name}</span>
                <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] uppercase tracking-wide text-neutral-300">
                  {p.jobType}
                </span>
              </div>
              <div className="mt-1 text-xs text-neutral-400">
                {p.estLaborHours != null
                  ? `~${p.estLaborHours.toFixed(1)}h`
                  : "Labor TBD"}
              </div>
              <div className="mt-1 line-clamp-2 text-[11px] text-neutral-500">
                {p.summary}
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Inspection templates */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">
            Inspection Templates
          </h4>
          <p className="text-[10px] text-neutral-500">
            Saved/standard inspections you can attach as jobs.
          </p>
        </div>
        <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {templatesLoading && (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">
              Loading templates‚Ä¶
            </div>
          )}
          {!templatesLoading &&
            (templates.length ? (
              templates.slice(0, 9).map((t) => (
                <button
                  key={t.id}
                  type="button"
                  onClick={() => addTemplateAsLine(t)}
                  disabled={addingId === t.id || !shopReady}
                  className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
                  title={t.description ?? undefined}
                >
                  <span className="font-medium text-neutral-50">
                    {t.template_name ?? "Inspection"}
                  </span>
                  <div className="mt-1 text-xs text-neutral-400">
                    inspection ‚Ä¢{" "}
                    {typeof t.labor_hours === "number"
                      ? `${t.labor_hours.toFixed(1)}h`
                      : "Labor TBD"}
                  </div>
                  {t.description && (
                    <div className="mt-1 line-clamp-2 text-[11px] text-neutral-500">
                      {t.description}
                    </div>
                  )}
                </button>
              ))
            ) : (
              <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">
                No templates yet.
              </div>
            ))}
        </div>
      </div>

      {/* From My Menu (vehicle-matched first) */}
      <div className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3 sm:p-4">
        <div className="mb-2 flex items-center justify-between gap-2">
          <h4 className="text-xs font-semibold uppercase tracking-wide text-neutral-300">
            From My Menu
          </h4>
        <p className="text-[10px] text-neutral-500">
            Saved services ‚Äî best matches for this vehicle are shown first.
          </p>
        </div>
        <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
          {menuLoading && (
            <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">
              Loading menu items‚Ä¶
            </div>
          )}
          {!menuLoading &&
            (menuItems.length ? (
              menuItems.slice(0, 9).map((mi) => (
                <button
                  type="button"
                  key={mi.id}
                  onClick={() => addSavedMenuItem(mi)}
                  disabled={addingId === (mi.name ?? "") || !shopReady}
                  className="flex flex-col rounded-md border border-neutral-800 bg-neutral-950 p-3 text-left text-sm hover:border-orange-500/70 hover:bg-neutral-900 disabled:opacity-60"
                  title={mi.description ?? undefined}
                >
                  <span className="font-medium text-neutral-50">
                    {mi.name}
                  </span>
                  <div className="mt-1 text-xs text-neutral-400">
                    {typeof mi.labor_time === "number"
                      ? `${mi.labor_time.toFixed(1)}h`
                      : typeof (mi as any).labor_hours === "number"
                      ? `${(mi as any).labor_hours.toFixed(1)}h`
                      : "Labor TBD"}{" "}
                    ‚Ä¢{" "}
                    {typeof mi.total_price === "number"
                      ? `$${mi.total_price.toFixed(0)}`
                      : "No price"}
                  </div>
                  {mi.vehicle_year || mi.vehicle_make || mi.vehicle_model ? (
                    <div className="mt-1 text-[10px] text-neutral-500">
                      {[
                        mi.vehicle_year ?? "",
                        mi.vehicle_make ?? "",
                        mi.vehicle_model ?? "",
                      ]
                        .filter(Boolean)
                        .join(" ")}
                    </div>
                  ) : null}
                  {mi.description && (
                    <div className="mt-1 line-clamp-2 text-[11px] text-neutral-500">
                      {mi.description}
                    </div>
                  )}
                </button>
              ))
            ) : (
              <div className="col-span-full w-full py-2 text-center text-sm text-neutral-400">
                No saved menu items yet.
              </div>
            ))}
        </div>
      </div>

      {/* New shared AI Suggest modal */}
      <AiSuggestModal
        open={aiOpen}
        onClose={() => setAiOpen(false)}
        workOrderId={workOrderId}
        vehicleId={vehicleId ?? null}
        vehicleLabel={vehicleLabel ?? null}
        onAdded={(count) => {
          setWoLineCount((prev) =>
            typeof prev === "number" ? prev + count : prev,
          );
        }}
      />
    </div>
  );
}

export default MenuQuickAdd;

========================================
FILE: features/work-orders/components/NewLineFormIsland.tsx
========================================
"use client";

import { useRouter } from "next/navigation";
import { NewWorkOrderLineForm } from "./NewWorkOrderLineForm";

type Props = {
  workOrderId: string;
  vehicleId: string | null;
  defaultJobType: "inspection" | "maintenance" | "diagnosis" | null;
};

export default function NewLineFormIsland(props: Props) {
  const router = useRouter();
  return <NewWorkOrderLineForm {...props} onCreated={() => router.refresh()} />;
}


========================================
FILE: features/work-orders/components/NewWorkOrderLineForm.tsx
========================================
"use client";

import { useRef, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type InsertLine = DB["public"]["Tables"]["work_order_lines"]["Insert"];

// Keep in sync with your DB check constraint
type WOJobType = "diagnosis" | "inspection" | "maintenance" | "repair";

const ALLOWED_STATUS = [
  "awaiting",
  "in_progress",
  "on_hold",
  "paused",
  "completed",
] as const;
type AllowedStatus = (typeof ALLOWED_STATUS)[number];

export function NewWorkOrderLineForm(props: {
  workOrderId: string;
  vehicleId: string | null;
  defaultJobType: WOJobType | null;
  shopId?: string | null; // satisfies RLS
  onCreated?: () => void;
}) {
  const { workOrderId, vehicleId, defaultJobType, shopId, onCreated } = props;
  const supabase = createClientComponentClient<DB>();

  const [complaint, setComplaint] = useState("");
  const [cause, setCause] = useState("");
  const [correction, setCorrection] = useState("");
  const [labor, setLabor] = useState<string>("");
  const [status, setStatus] = useState<InsertLine["status"]>("awaiting");
  const [jobType, setJobType] = useState<WOJobType | null>(defaultJobType ?? null);
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  const lastSetShopId = useRef<string | null>(null);

  const canSave = complaint.trim().length > 0 && !!workOrderId;

  function normalizeJobType(t: WOJobType | null): InsertLine["job_type"] {
    const allowed: WOJobType[] = ["diagnosis", "inspection", "maintenance", "repair"];
    return (t && (allowed as string[]).includes(t)) ? (t as InsertLine["job_type"]) : null;
  }

  function normalizeStatus(s: InsertLine["status"] | null | undefined): AllowedStatus {
    const v = (s ?? "awaiting") as string;
    return (ALLOWED_STATUS as readonly string[]).includes(v) ? (v as AllowedStatus) : "awaiting";
  }

  async function ensureShopContext() {
    if (!shopId) return;
    if (lastSetShopId.current === shopId) return;
    const { error } = await supabase.rpc("set_current_shop_id", { p_shop_id: shopId });
    if (!error) lastSetShopId.current = shopId;
    else throw error;
  }

  async function addLine() {
    if (!canSave) return;
    setBusy(true);
    setErr(null);

    try {
      await ensureShopContext();

      const { data: { user } } = await supabase.auth.getUser();

      const payload: InsertLine = {
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        user_id: user?.id ?? null,
        complaint: complaint || null,
        cause: cause || null,
        correction: correction || null,
        labor_time: labor ? Number(labor) : null,
        status: normalizeStatus(status),
        job_type: normalizeJobType(jobType),
        shop_id: shopId ?? null,
      };

      const { error } = await supabase.from("work_order_lines").insert(payload);
      if (error) {
        if (/(job_type).*check/i.test(error.message)) {
          setErr("This job type isn‚Äôt allowed by the database. Pick another type.");
        } else if (/status.*check/i.test(error.message)) {
          setErr("This status isn‚Äôt allowed by the database. Try a different status.");
        } else if (/row-level security/i.test(error.message) || /current_shop_id/i.test(error.message)) {
          setErr("Shop mismatch: your session isn‚Äôt scoped to this shop. Try again.");
          lastSetShopId.current = null;
        } else {
          setErr(error.message);
        }
        return;
      }

      setComplaint("");
      setCause("");
      setCorrection("");
      setLabor("");
      setStatus("awaiting");
      setJobType(defaultJobType ?? null);
      onCreated?.();

      window.dispatchEvent(new CustomEvent("wo:line-added"));
    } catch (e: unknown) {
      const msg = (e as Error)?.message ?? "Failed to add line.";
      setErr(msg);
      lastSetShopId.current = null;
    } finally {
      setBusy(false);
    }
  }

  return (
    <div className="rounded-lg border border-neutral-800 bg-neutral-950 p-4 sm:p-5 text-sm text-white space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between gap-2">
        <div>
          <h3 className="text-sm font-semibold text-neutral-100">
            Add job line
          </h3>
          <p className="text-[11px] text-neutral-400">
            Complaint is required. Cause / correction can be filled in later.
          </p>
        </div>
        <div className="rounded-full border border-neutral-700 bg-neutral-900 px-3 py-1 text-[10px] text-neutral-300">
          Linked to WO: <span className="font-mono">{workOrderId.slice(0, 8)}‚Ä¶</span>
        </div>
      </div>

      {/* Fields */}
      <div className="grid gap-3 sm:grid-cols-2">
        {/* Complaint */}
        <div className="sm:col-span-2 space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Complaint <span className="text-red-400">*</span>
          </label>
          <textarea
            value={complaint}
            onChange={(e) => setComplaint(e.target.value)}
            className="w-full min-h-[60px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="Describe the issue / customer concern"
          />
        </div>

        {/* Cause */}
        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">Cause</label>
          <textarea
            value={cause}
            onChange={(e) => setCause(e.target.value)}
            className="w-full min-h-[48px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="Root cause (optional)"
          />
        </div>

        {/* Correction */}
        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Correction
          </label>
          <textarea
            value={correction}
            onChange={(e) => setCorrection(e.target.value)}
            className="w-full min-h-[48px] rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="What to do / repair plan (optional)"
          />
        </div>

        {/* Labor */}
        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Labor (hrs)
          </label>
          <input
            inputMode="decimal"
            value={labor}
            onChange={(e) => setLabor(e.target.value)}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
            placeholder="0.0"
          />
          <p className="text-[10px] text-neutral-500">
            Flat-rate or estimated hours. Leave blank if unknown.
          </p>
        </div>

        {/* Status */}
        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Status
          </label>
          <select
            value={normalizeStatus(status)}
            onChange={(e) => setStatus(e.target.value as InsertLine["status"])}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
          >
            <option value="awaiting">Awaiting</option>
            <option value="in_progress">In progress</option>
            <option value="on_hold">On hold</option>
            <option value="paused">Paused</option>
            <option value="completed">Completed</option>
          </select>
          <p className="text-[10px] text-neutral-500">
            Defaults to <span className="italic">Awaiting</span> if not changed.
          </p>
        </div>

        {/* Job type */}
        <div className="space-y-1">
          <label className="mb-0.5 block text-xs text-neutral-300">
            Job type
          </label>
          <select
            value={jobType ?? ""}
            onChange={(e) =>
              setJobType((e.target.value || null) as WOJobType | null)
            }
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-orange-500 focus:outline-none"
          >
            <option value="">Unspecified</option>
            <option value="diagnosis">Diagnosis</option>
            <option value="inspection">Inspection</option>
            <option value="maintenance">Maintenance</option>
            <option value="repair">Repair</option>
          </select>
          <p className="text-[10px] text-neutral-500">
            Used for reporting and technician queues.
          </p>
        </div>
      </div>

      {/* Error */}
      {err && (
        <div className="rounded-md border border-red-500/60 bg-red-500/10 px-3 py-2 text-xs text-red-200">
          {err}
        </div>
      )}

      {/* Actions */}
      <div className="flex items-center justify-end gap-2 pt-1">
        <button
          disabled={!canSave || busy}
          onClick={addLine}
          className="btn btn-orange px-4 py-1.5 text-xs font-semibold disabled:opacity-60"
        >
          {busy ? "Adding‚Ä¶" : "Add line to work order"}
        </button>
      </div>
    </div>
  );
}

export default NewWorkOrderLineForm;

========================================
FILE: features/work-orders/components/PartsUsedList.tsx
========================================
"use client";


import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

export type PartsUsedListProps = {
  allocations: AllocationRow[];
};

export function PartsUsedList({
  allocations,
}: PartsUsedListProps): JSX.Element {
  if (!allocations.length) {
    return (
      <div className="text-[11px] text-neutral-500">
        No parts used yet.
      </div>
    );
  }

  return (
    <ul className="mt-1 divide-y divide-neutral-800 rounded border border-neutral-800 text-sm">
      {allocations.map((a) => {
        const partName = a.parts?.name ?? "Part";
        const locShort = a.location_id
          ? String(a.location_id).slice(0, 6)
          : "-";

        const unitCost =
          typeof a.unit_cost === "number" ? a.unit_cost : null;
        const qty = typeof a.qty === "number" ? a.qty : null;
        const lineCost =
          unitCost != null && qty != null ? unitCost * qty : null;

        return (
          <li
            key={a.id}
            className="flex items-center justify-between bg-neutral-900/70 p-2"
          >
            <div className="min-w-0">
              <div className="truncate text-sm text-white">
                {partName}
              </div>
              <div className="text-[11px] text-neutral-500">
                loc {locShort}
                {unitCost != null && (
                  <span className="ml-2">
                    @{unitCost.toFixed(2)}
                  </span>
                )}
              </div>
            </div>
            <div className="pl-3 text-right text-sm font-semibold text-neutral-100">
              {qty != null ? <span>√ó {qty}</span> : null}
              {lineCost != null && (
                <div className="text-[11px] text-neutral-300">
                  ${lineCost.toFixed(2)}
                </div>
              )}
            </div>
          </li>
        );
      })}
    </ul>
  );
}

========================================
FILE: features/work-orders/components/QuickActions.tsx
========================================

import { useRouter } from "next/router";

export default function QuickActions() {
  const router = useRouter();

  const actions = [
    { label: "üì∏ Diagnose from Photo", path: "/diagnose" },
    { label: "üîç Run DTC Diagnosis", path: "/dtc-lookup" },
    { label: "üßæ View Work Orders", path: "/work-orders" },
    { label: "üìã Start Inspection", path: "/inspections" },
    { label: "üöò Add Vehicle", path: "/vehicles" },
  ];

  return (
    <div className="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-8">
      {actions.map((action) => (
        <button
          key={action.path}
          onClick={() => router.push(action.path)}
          className="bg-surface text-accent shadow-card rounded-lg p-4 hover:shadow-lg transition"
        >
          {action.label}
        </button>
      ))}
    </div>
  );
}


========================================
FILE: features/work-orders/components/RecentWorkOrders.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { supabaseBrowser } from "@/features/shared/lib/supabase/client";

type WorkOrder = {
  id: string;
  vehicle_make: string | null;
  vehicle_model: string | null;
  status: string;
  created_at: string;
};

export default function RecentWorkOrders() {
  const [workOrders, setWorkOrders] = useState<WorkOrder[]>([]);
  const router = useRouter();

  useEffect(() => {
    const fetchWorkOrders = async () => {
      const supabase = supabaseBrowser;

      const { data, error } = await supabase
        .from("work_orders")
        .select("id, vehicle_make, vehicle_model, status, created_at")
        .order("created_at", { ascending: false })
        .limit(3);

      if (!error && data) setWorkOrders(data as WorkOrder[]);
      else if (error) console.error("RecentWorkOrders error:", error.message);
    };

    fetchWorkOrders();
  }, []);

  return (
    <div className="bg-surface text-accent p-6 rounded-md shadow-card mb-8">
      <h2 className="text-lg font-semibold mb-4">Recent Work Orders</h2>
      {workOrders.length === 0 ? (
        <p className="text-muted text-sm">No recent work orders found.</p>
      ) : (
        <ul className="space-y-3">
          {workOrders.map((order) => (
            <li
              key={order.id}
              className="cursor-pointer hover:bg-muted/10 p-3 rounded transition"
              onClick={() => router.push(`/work-orders/${order.id}`)}
            >
              <div className="font-medium">
                {order.vehicle_make} {order.vehicle_model}
              </div>
              <div className="text-sm text-muted">Status: {order.status}</div>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

========================================
FILE: features/work-orders/components/SuggestedQuickAdd.tsx
========================================
// features/work-orders/components/SuggestedQuickAdd.tsx
"use client";

import { useEffect, useState } from "react";

type Suggestion = {
  name: string;
  laborHours: number | null;
  jobType: "diagnosis" | "repair" | "maintenance" | "tech-suggested";
  notes: string;
  aiComplaint?: string;
  aiCause?: string;
  aiCorrection?: string;
};

function asSuggestions(input: unknown): Suggestion[] {
  if (!Array.isArray(input)) return [];
  return input.map((raw: any) => {
    const name =
      typeof raw?.name === "string" && raw.name.trim()
        ? raw.name.trim()
        : "Suggested item";
    const hours = Number(raw?.laborHours);
    const jobType =
      raw?.jobType === "diagnosis" ||
      raw?.jobType === "repair" ||
      raw?.jobType === "maintenance" ||
      raw?.jobType === "tech-suggested"
        ? raw.jobType
        : "maintenance";
    const notes = typeof raw?.notes === "string" ? raw.notes : "";
    return {
      name,
      laborHours: Number.isFinite(hours) ? hours : null,
      jobType,
      notes,
      aiComplaint:
        typeof raw?.aiComplaint === "string" ? raw.aiComplaint : undefined,
      aiCause: typeof raw?.aiCause === "string" ? raw.aiCause : undefined,
      aiCorrection:
        typeof raw?.aiCorrection === "string" ? raw.aiCorrection : undefined,
    };
  });
}

export default function SuggestedQuickAdd(props: {
  jobId: string;
  workOrderId: string;
  vehicleId?: string | null;
  onAdded?: () => void | Promise<void>;
}) {
  const { jobId, workOrderId, vehicleId, onAdded } = props;

  const [loading, setLoading] = useState(false);
  const [adding, setAdding] = useState<string | null>(null);
  const [items, setItems] = useState<Suggestion[]>([]);
  const [error, setError] = useState<string | null>(null);

  async function fetchSuggestions() {
    setLoading(true);
    setError(null);
    try {
      const body: any = { jobId };
      if (vehicleId) {
        // simple string for now ‚Äì your API already accepts VehicleLite | string | null
        body.vehicleId = vehicleId;
      }

      const res = await fetch("/api/work-orders/suggest-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Failed to load suggestions");
      setItems(asSuggestions(j?.suggestions));
    } catch (e) {
      setError(
        e instanceof Error ? e.message : "Failed to load suggestions",
      );
      setItems([]);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (jobId) void fetchSuggestions();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [jobId]);

  async function addQuote(s: Suggestion) {
    setAdding(s.name);
    try {
      const res = await fetch("/api/work-orders/quotes/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          items: [
            {
              description: s.name,
              jobType: s.jobType,
              estLaborHours: s.laborHours ?? 0,
              notes: s.notes,
              aiComplaint: s.aiComplaint,
              aiCause: s.aiCause,
              aiCorrection: s.aiCorrection,
            },
          ],
        }),
      });
      if (!res.ok) {
        const j = await res.json().catch(() => ({}));
        throw new Error(j?.error || "Failed to add quote line");
      }

      await onAdded?.();
    } catch (e) {
      alert(e instanceof Error ? e.message : "Failed to add quote line");
    } finally {
      setAdding(null);
    }
  }

  return (
    <div className="rounded border border-neutral-800 bg-neutral-950 p-3">
      <div className="flex items-center justify-between">
        <h3 className="font-semibold text-orange-400">AI Suggestions</h3>
        <button
          onClick={fetchSuggestions}
          disabled={loading}
          className="text-xs px-2 py-1 rounded border border-neutral-700 hover:bg-neutral-800 disabled:opacity-60"
        >
          {loading ? "Thinking‚Ä¶" : "Regenerate"}
        </button>
      </div>

      {error && <p className="mt-2 text-xs text-red-400">{error}</p>}

      <div className="mt-3 grid gap-2 sm:grid-cols-2">
        {items.map((s) => (
          <button
            key={s.name}
            onClick={() => addQuote(s)}
            disabled={adding === s.name}
            className="text-left border border-neutral-800 bg-neutral-900 hover:bg-neutral-800 rounded p-3 disabled:opacity-60"
          >
            <div className="font-medium">{s.name}</div>
            <div className="text-xs text-neutral-400">
              {s.jobType} ‚Ä¢{" "}
              {typeof s.laborHours === "number"
                ? s.laborHours.toFixed(1)
                : "‚Äî"}
              h
            </div>
            {s.notes && (
              <div className="text-xs text-neutral-500 mt-1">{s.notes}</div>
            )}
          </button>
        ))}

        {!loading && items.length === 0 && (
          <div className="text-xs text-neutral-400">No suggestions yet.</div>
        )}
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/components/TechJobScreen.tsx
========================================
// features/work-orders/components/workorders/TechJobScreen.tsx
"use client";

import { useCallback, useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import JobQueueCard from "@shared/components/JobQueueCard";

// Use the raw DB row for work_order_lines
type JobLine = Database["public"]["Tables"]["work_order_lines"]["Row"];

export default function TechJobScreen() {
  const supabase = createClientComponentClient<Database>();
  const [jobs, setJobs] = useState<JobLine[]>([]);
  const [activeJobId, setActiveJobId] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const fetchJobs = useCallback(async () => {
    setLoading(true);
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) {
      setJobs([]);
      setLoading(false);
      return;
    }

    // Pull the queue directly with the DB row type
    const { data } = await supabase
      .from("work_order_lines")
      .select("*")
      .or(`assigned_to.eq.${user.id},assigned_to.is.null`)
      .in("status", ["awaiting", "in_progress", "on_hold"])
      .order("created_at", { ascending: true });

    setJobs((data ?? []) as JobLine[]);
    setLoading(false);
  }, [supabase]);

  useEffect(() => {
    void fetchJobs();

    const channel = supabase
      .channel("job-updates")
      .on(
        "postgres_changes",
        { event: "*", schema: "public", table: "work_order_lines" },
        () => void fetchJobs()
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [fetchJobs, supabase]);

  const handlePunchIn = async (job: JobLine) => {
    const {
      data: { user },
    } = await supabase.auth.getUser();
    if (!user) return;

    setActiveJobId(job.id ?? null);

    await supabase
      .from("work_order_lines")
      .update({ status: "in_progress", assigned_to: user.id })
      .eq("id", job.id as string);

    void fetchJobs();
  };

  const handlePunchOut = async (job: JobLine) => {
    setActiveJobId(null);

    await supabase
      .from("work_order_lines")
      .update({ status: "awaiting" })
      .eq("id", job.id as string);

    void fetchJobs();
  };

  const renderJobCard = (job: JobLine) => (
    <JobQueueCard
      key={job.id as string}
      job={job}
      isActive={activeJobId === job.id}
      onPunchIn={handlePunchIn}
      onPunchOut={handlePunchOut}
    />
  );

  const activeJob = jobs.find((j) => j.id === activeJobId) ?? null;
  const readyJobs = jobs.filter((j) => j.status === "awaiting" && j.id !== activeJobId);
  const onHoldJobs = jobs.filter((j) => j.status === "on_hold");

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-xl font-bold text-accent">Technician Job Queue</h1>

      {loading && <p className="text-sm text-neutral-500">Loading jobs‚Ä¶</p>}

      {activeJob ? (
        <section>
          <h2 className="text-lg font-semibold mb-2">Current Job</h2>
          {renderJobCard(activeJob)}
        </section>
      ) : (
        <section>
          <h2 className="text-lg font-semibold mb-2">Available Jobs</h2>
          {readyJobs.length > 0 ? readyJobs.map(renderJobCard) : <p>No jobs available.</p>}
        </section>
      )}

      {onHoldJobs.length > 0 && (
        <section>
          <h2 className="text-lg font-semibold mb-2">On Hold</h2>
          {onHoldJobs.map(renderJobCard)}
        </section>
      )}
    </div>
  );
}

========================================
FILE: features/work-orders/components/TechPanel.tsx
========================================
"use client";

import type { Database } from "@shared/types/types/supabase";

type DB = Database;
export type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
export type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
export type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
export type Customer = DB["public"]["Tables"]["customers"]["Row"];

export default function TechPanel({
  workOrder,
  vehicle,
  customer,
  lines,
}: {
  workOrder: WorkOrder;
  vehicle: Vehicle | null;
  customer: Customer | null;
  lines: WorkOrderLine[];
}) {
  const vehicleText = vehicle
    ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${vehicle.model ?? ""}${
        vehicle.license_plate ? ` (${vehicle.license_plate})` : ""
      }`.trim()
    : "‚Äî";

  const customerText = customer
    ? [customer.first_name ?? "", customer.last_name ?? ""]
        .filter(Boolean)
        .join(" ")
        .trim() || "‚Äî"
    : "‚Äî";

  return (
    <div className="rounded border border-neutral-800 bg-neutral-900 p-4">
      <div className="mb-2 font-semibold text-orange-400">Tech Panel</div>
      <p className="text-sm text-neutral-300">
        Work on{" "}
        <strong>{workOrder.custom_id || workOrder.id.slice(0, 8)}</strong>.{" "}
        Vehicle: {vehicleText} ¬∑ Customer: {customerText}.
      </p>
      <p className="mt-2 text-sm text-neutral-400">Jobs: {lines.length}</p>

      <div className="mt-3">
        <button
          onClick={() => window.location.reload()}
          className="rounded border border-neutral-700 px-3 py-1.5 text-sm hover:border-orange-500"
        >
          Refresh
        </button>
      </div>

      <div className="mt-4 text-xs text-neutral-500">
        Placeholder: wire your existing tech UI (punch, cause/correction, add
        job/quote, AI suggestions, photos) here.
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/components/UsePartButton.tsx
========================================
"use client";

import { useState, useTransition } from "react";
import { consumePart } from "@work-orders/lib/parts/consumePart";
import { PartPicker, type PickedPart } from "@parts/components/PartPicker";

export function UsePartButton({
  workOrderLineId,
  onApplied,
  label = "Use Part",
}: {
  workOrderLineId: string;
  onApplied?: () => void;
  label?: string;
}) {
  const [open, setOpen] = useState(false);
  const [pending, start] = useTransition();
  const [err, setErr] = useState<string | null>(null);

  const handlePick = (sel: PickedPart) => {
    setErr(null);
    start(async () => {
      try {
        await consumePart({
          work_order_line_id: workOrderLineId,
          part_id: sel.part_id,
          qty: sel.qty,
          location_id: sel.location_id,
          unit_cost: sel.unit_cost ?? null,
          availability: sel.availability ?? null,
        });
        onApplied?.();
      } catch (e: any) {
        const m = e?.message || String(e) || "Failed to use part";
        setErr(m.replace(/^.*error:\s*/i, ""));
      }
    });
  };

  return (
    <>
      <button
        onClick={(e) => {
          e.stopPropagation();
          setOpen(true);
        }}
        className="px-3 py-2 rounded-xl bg-neutral-900 text-white disabled:opacity-60"
        disabled={pending}
        title="Use/consume a part on this job line"
      >
        {pending ? "Applying‚Ä¶" : label}
      </button>
      {err && <span className="ml-2 text-xs text-red-500">{err}</span>}
      <PartPicker
        open={open}
        onClose={() => setOpen(false)}
        onPick={handlePick}
      />
    </>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderAssignedSummary.tsx
========================================
// src/features/work-orders/components/WorkOrderAssignedSummary.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Props = {
  workOrderId: string;
};

type AssignmentRow = {
  technician_id: string | null;
  full_name: string | null;
  role: string | null;
  has_active: boolean | null;
};

export function WorkOrderAssignedSummary({ workOrderId }: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [loading, setLoading] = useState(true);
  const [rows, setRows] = useState<AssignmentRow[]>([]);

  useEffect(() => {
    if (!workOrderId) return;

    let cancelled = false;

    const load = async () => {
      setLoading(true);
      try {
        const { data, error } = await supabase.rpc(
          "get_work_order_assignments",
          { p_work_order_id: workOrderId },
        );

        if (error) {
          // eslint-disable-next-line no-console
          console.error("[WorkOrderAssignedSummary] rpc error:", error);
          if (!cancelled) {
            setRows([]);
          }
          return;
        }

        if (!cancelled) {
          setRows((data as AssignmentRow[] | null) ?? []);
        }
      } catch (e) {
        // eslint-disable-next-line no-console
        console.error("[WorkOrderAssignedSummary] unexpected error:", e);
        if (!cancelled) setRows([]);
      } finally {
        if (!cancelled) setLoading(false);
      }
    };

    void load();

    return () => {
      cancelled = true;
    };
  }, [supabase, workOrderId]);

  // ---------- derived values ----------

  const hasActive = useMemo(
    () => rows.some((r) => !!r.has_active),
    [rows],
  );

  const firstTechLabel = useMemo(() => {
    if (!rows.length) return null;
    const first = rows[0];
    const full = first.full_name || "Assigned tech";
    const firstName = full.split(" ")[0] || full;
    return firstName;
  }, [rows]);

  const extraCount = rows.length > 1 ? rows.length - 1 : 0;

  // ---------- Render states ----------

  if (loading) {
    return (
      <span className="inline-flex animate-pulse items-center rounded-full border border-neutral-700 bg-neutral-900/70 px-2.5 py-0.5 text-[0.7rem] text-neutral-400">
        Loading‚Ä¶
      </span>
    );
  }

  if (!rows.length || !firstTechLabel) {
    return (
      <span className="inline-flex items-center rounded-full border border-neutral-700 bg-neutral-950/80 px-2.5 py-0.5 text-[0.7rem] text-neutral-400">
        Unassigned
      </span>
    );
  }

  const base =
    "inline-flex items-center gap-1 rounded-full border px-2.5 py-0.5 text-[0.7rem] font-medium";
  const activeCls =
    "border-emerald-400/80 bg-emerald-500/15 text-emerald-100 shadow-[0_0_18px_rgba(16,185,129,0.8)]";
  const assignedCls =
    "border-amber-400/80 bg-amber-500/15 text-amber-50";

  return (
    <span
      className={`${base} ${hasActive ? activeCls : assignedCls}`}
      title={
        hasActive
          ? "At least one job line is currently punched in."
          : "Jobs assigned to technician(s) on this work order."
      }
    >
      {hasActive && (
        <span className="relative mr-0.5 inline-flex h-2 w-2 items-center justify-center">
          <span className="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400/60" />
          <span className="relative inline-flex h-1.5 w-1.5 rounded-full bg-emerald-300" />
        </span>
      )}
      <span>{firstTechLabel}</span>
      {extraCount > 0 && (
        <span className="text-[0.65rem] text-neutral-100/80">
          +{extraCount} more
        </span>
      )}
    </span>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderCard.tsx
========================================
"use client";

import { format } from "date-fns";
import Link from "next/link";
import type { Database } from "@shared/types/types/supabase";

type WorkOrderLine = Database["public"]["Tables"]["work_order_lines"]["Row"] & {
  vehicle?: {
    year?: number | null;
    make?: string | null;
    model?: string | null;
  } | null;
  assigned_to?: {
    full_name?: string | null;
  } | null;
};

// restrict keys so indexing is safe
type StatusKey = "awaiting" | "in_progress" | "on_hold" | "completed";

const statusStyles: Record<StatusKey, { tag: string; bar: string }> = {
  awaiting:   { tag: "bg-blue-100 text-blue-800",   bar: "bg-blue-500"   },
  in_progress:{ tag: "bg-orange-100 text-orange-800", bar: "bg-orange-500" },
  on_hold:    { tag: "bg-yellow-100 text-yellow-800", bar: "bg-yellow-500" },
  completed:  { tag: "bg-green-100 text-green-800",  bar: "bg-green-500"  },
};

interface WorkOrderCardProps {
  job: WorkOrderLine;
}

export default function WorkOrderCard({ job }: WorkOrderCardProps) {
  const {
    status,
    created_at,
    vehicle,
    assigned_to,
    complaint,
    work_order_id,
  } = job;

  const vehicleInfo =
    [vehicle?.year, vehicle?.make, vehicle?.model].filter(Boolean).join(" ") ||
    "Unknown vehicle";

  // coalesce nullable status to a known key (and guard)
  const safeStatus = (status ?? "awaiting") as StatusKey;
  const styles = statusStyles[safeStatus] ?? {
    tag: "bg-gray-100 text-gray-800",
    bar: "bg-gray-400",
  };

  const created = created_at ? new Date(created_at) : null;

  return (
    <Link href={`/work-orders/view/${work_order_id ?? ""}`} className="block">
      <div className="flex border rounded overflow-hidden shadow-sm mb-3 bg-white dark:bg-gray-900 hover:shadow-md transition-shadow duration-200">
        <div className={`w-1 ${styles.bar}`} />
        <div className="flex-1 p-4">
          <div className="flex justify-between items-center mb-2">
            <span className={`text-xs font-medium px-2 py-1 rounded ${styles.tag}`}>
              {safeStatus.replace("_", " ")}
            </span>
            <span className="text-xs text-gray-500 dark:text-gray-400">
              {created ? format(created, "PPp") : "‚Äî"}
            </span>
          </div>
          <p className="text-sm font-semibold">{vehicleInfo}</p>
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Complaint: {complaint ?? "N/A"}
          </p>
          <p className="text-sm text-gray-700 dark:text-gray-300">
            Assigned: {assigned_to?.full_name ?? "Unassigned"}
          </p>
        </div>
      </div>
    </Link>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderEditorPage.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { supabaseBrowser } from "@/features/shared/lib/supabase/client";
import useVehicleInfo from "@shared/hooks/useVehicleInfo";
import { useUser } from "@auth/hooks/useUser";
import WorkOrderLineEditor from "@work-orders/components/WorkOrderLineEditor";

type MenuItem = {
  id: string;
  complaint: string | null;
  cause?: string | null;
  correction?: string | null;
  labor_time?: number | null;
  tools?: string | null;
};

type WorkOrderLine = {
  id?: string;
  complaint: string;
  cause?: string;
  correction?: string;
  labor_time?: number;
  tools?: string;
  status?: "unassigned" | "assigned" | "in_progress" | "on_hold" | "completed" | "awaiting";
  hold_reason?: "parts" | "authorization" | "diagnosis_pending" | "other" | "";
};

export default function WorkOrderEditorPage() {
  const supabase = supabaseBrowser;
  const { vehicleInfo } = useVehicleInfo();
  const { user } = useUser();

  const [menuItems, setMenuItems] = useState<MenuItem[]>([]);
  const [lines, setLines] = useState<WorkOrderLine[]>([]);
  const [query, setQuery] = useState("");
  const [filtered, setFiltered] = useState<MenuItem[]>([]);

  useEffect(() => {
    const fetchMenuItems = async () => {
      if (user && vehicleInfo?.id) {
        const { data, error } = await supabase
          .from("menu_items")
          .select("*")
          .eq("vehicle_id", vehicleInfo.id);

        if (!error && data) setMenuItems(data as unknown as MenuItem[]);
      }
    };
    void fetchMenuItems();
  }, [user, vehicleInfo?.id, supabase]);

  useEffect(() => {
    if (query.trim().length > 1) {
      const q = query.toLowerCase();
      setFiltered(menuItems.filter((item) => (item.complaint ?? "").toLowerCase().includes(q)));
    } else {
      setFiltered([]);
    }
  }, [query, menuItems]);

  const handleSuggestionClick = (item: MenuItem) => {
    setLines((prev) => [
      ...prev,
      {
        complaint: item.complaint ?? "",
        cause: item.cause ?? "",
        correction: item.correction ?? "",
        labor_time: item.labor_time ?? 0,
        tools: item.tools ?? "",
        status: "awaiting",
      },
    ]);
    setQuery("");
    setFiltered([]);
  };

  return (
    <div className="p-4">
      <h1 className="text-xl font-bold mb-2">Create Work Order</h1>

      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="Enter complaint (e.g. B for brakes)"
        className="w-full px-3 py-2 border rounded shadow mb-2"
      />

      {filtered.length > 0 && (
        <ul className="bg-white border shadow rounded mb-4 max-h-40 overflow-y-auto">
          {filtered.map((item) => (
            <li
              key={item.id}
              onClick={() => handleSuggestionClick(item)}
              className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
            >
              {(item.complaint ?? "Untitled")} ‚Äî {item.labor_time ?? 0} hr
            </li>
          ))}
        </ul>
      )}

      <div className="space-y-3">
        {lines.map((line, index) => (
          <WorkOrderLineEditor
            key={`${line.id ?? "new"}-${index}`}
            line={line}
            onUpdate$={(updatedLine: WorkOrderLine) => {
              const updated = [...lines];
              updated[index] = updatedLine;
              setLines(updated);
            }}
            onDelete$={() => {
              const updated = [...lines];
              updated.splice(index, 1);
              setLines(updated);
            }}
          />
        ))}
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderInvoiceDownloadButton.tsx
========================================
"use client";

import { useRef, useEffect } from "react";
import { BlobProvider } from "@react-pdf/renderer";
import { WorkOrderInvoicePDF } from "./WorkOrderInvoicePDF";
import type { RepairLine } from "@ai/lib/parseRepairOutput";

type Props = {
  workOrderId: string;
  lines: RepairLine[];
  summary?: string;
  vehicleInfo?: {
    year?: string;
    make?: string;
    model?: string;
    vin?: string;
  };
  customerInfo?: {
    name?: string;
    phone?: string;
    email?: string;
  };
  autoTrigger?: boolean;
};

export function WorkOrderInvoiceDownloadButton({
  workOrderId,
  lines,
  summary,
  vehicleInfo,
  customerInfo,
  autoTrigger = false,
}: Props) {
  const linkRef = useRef<HTMLAnchorElement>(null);
  const fileName = `Invoice_WorkOrder_${workOrderId}.pdf`;

  useEffect(() => {
    if (autoTrigger && linkRef.current) {
      const t = setTimeout(() => linkRef.current?.click(), 500);
      return () => clearTimeout(t);
    }
  }, [autoTrigger]);

  return (
    <BlobProvider
      document={
        <WorkOrderInvoicePDF
          workOrderId={workOrderId}
          lines={lines}
          summary={summary}
          vehicleInfo={vehicleInfo}
          customerInfo={customerInfo}
        />
      }
    >
      {({ url, loading, error }) => {
        if (loading) {
          return (
            <button className="px-4 py-2 bg-gray-400 text-white rounded">
              Generating‚Ä¶
            </button>
          );
        }

        if (error) {
          return (
            <span className="text-red-600">
              Failed to generate PDF: {String(error)}
            </span>
          );
        }

        // No URL yet (should be rare if not loading)
        if (!url) {
          return (
            <button className="px-4 py-2 bg-gray-400 text-white rounded" disabled>
              Preparing‚Ä¶
            </button>
          );
        }

        if (autoTrigger) {
          return (
            <>
              <a
                ref={linkRef}
                href={url}
                download={fileName}
                style={{ display: "none" }}
              >
                Download
              </a>
              <button className="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800">
                Download Invoice PDF
              </button>
            </>
          );
        }

        return (
          <a
            href={url}
            download={fileName}
            className="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800"
          >
            Download Invoice PDF
          </a>
        );
      }}
    </BlobProvider>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderInvoicePDF.tsx
========================================
"use client";

import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Font,
  Image,
} from "@react-pdf/renderer";

import type { RepairLine } from "@ai/lib/parseRepairOutput";

type VehicleInfo = {
  year?: string;
  make?: string;
  model?: string;
  vin?: string;
};

type CustomerInfo = {
  name?: string;
  phone?: string;
  email?: string;
};

type Props = {
  workOrderId: string;
  vehicleInfo?: VehicleInfo;
  customerInfo?: CustomerInfo;
  lines: RepairLine[];
  summary?: string;
  signatureImage?: string;
};

// Use built-in fonts reliably (remote font URLs can fail in PDFs).
// We'll rely on default Helvetica and bold weight usage.
Font.register({
  family: "Helvetica",
  fonts: [
    { src: undefined as unknown as string }, // react-pdf requires registration shape; default font still works
  ],
});

const styles = StyleSheet.create({
  page: {
    paddingTop: 28,
    paddingBottom: 28,
    paddingHorizontal: 32,
    fontSize: 11,
    fontFamily: "Helvetica",
    lineHeight: 1.4,
    color: "#0a0a0a",
  },

  header: {
    marginBottom: 14,
    paddingBottom: 10,
    borderBottomWidth: 1,
    borderBottomColor: "#ddd",
    borderBottomStyle: "solid",
  },

  title: {
    fontSize: 18,
    fontWeight: 700,
    textAlign: "center",
  },

  subtitle: {
    marginTop: 4,
    fontSize: 10,
    textAlign: "center",
    color: "#444",
  },

  grid2: {
    flexDirection: "row",
    gap: 12,
    marginTop: 10,
  },

  box: {
    flexGrow: 1,
    borderWidth: 1,
    borderColor: "#e1e1e1",
    borderStyle: "solid",
    borderRadius: 6,
    padding: 10,
  },

  boxTitle: {
    fontSize: 10,
    fontWeight: 700,
    marginBottom: 6,
    color: "#111",
  },

  row: {
    flexDirection: "row",
    justifyContent: "space-between",
    gap: 10,
    marginBottom: 2,
  },

  label: {
    fontSize: 10,
    color: "#333",
  },

  value: {
    fontSize: 10,
    color: "#111",
    maxWidth: 260,
  },

  section: {
    marginTop: 12,
  },

  sectionTitle: {
    fontSize: 11,
    fontWeight: 700,
    marginBottom: 6,
  },

  paragraph: {
    fontSize: 10,
    color: "#222",
  },

  lineItem: {
    borderWidth: 1,
    borderColor: "#efefef",
    borderStyle: "solid",
    borderRadius: 6,
    padding: 10,
    marginBottom: 8,
  },

  bullet: {
    fontSize: 10,
    marginBottom: 2,
    color: "#111",
  },

  subText: {
    fontSize: 9.5,
    color: "#333",
  },

  signatureWrap: {
    marginTop: 18,
    borderTopWidth: 1,
    borderTopColor: "#e1e1e1",
    borderTopStyle: "solid",
    paddingTop: 10,
    alignItems: "center",
  },

  signatureLabel: {
    fontSize: 10,
    marginBottom: 6,
    color: "#111",
    fontWeight: 700,
  },

  signatureImage: {
    width: 220,
    height: 90,
    borderWidth: 1,
    borderColor: "#cfcfcf",
    borderStyle: "solid",
    borderRadius: 6,
    objectFit: "contain",
  },

  footer: {
    position: "absolute",
    left: 32,
    right: 32,
    bottom: 18,
    borderTopWidth: 1,
    borderTopColor: "#e8e8e8",
    borderTopStyle: "solid",
    paddingTop: 8,
    flexDirection: "row",
    justifyContent: "space-between",
  },

  footerText: {
    fontSize: 9,
    color: "#666",
  },
});

function safeStr(v: unknown): string {
  if (typeof v === "string") return v;
  if (typeof v === "number") return String(v);
  return "";
}

function fmtVehicle(v?: VehicleInfo): string {
  const year = safeStr(v?.year).trim();
  const make = safeStr(v?.make).trim();
  const model = safeStr(v?.model).trim();
  const parts = [year, make, model].filter((p) => p.length > 0);
  return parts.length > 0 ? parts.join(" ") : "‚Äî";
}

function fmtVin(v?: VehicleInfo): string {
  const vin = safeStr(v?.vin).trim();
  return vin.length > 0 ? vin : "‚Äî";
}

export function WorkOrderInvoicePDF({
  workOrderId,
  vehicleInfo,
  customerInfo,
  lines,
  summary,
  signatureImage,
}: Props): JSX.Element {
  const customerName = safeStr(customerInfo?.name).trim() || "‚Äî";
  const customerPhone = safeStr(customerInfo?.phone).trim() || "‚Äî";
  const customerEmail = safeStr(customerInfo?.email).trim() || "‚Äî";

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Header */}
        <View style={styles.header}>
          <Text style={styles.title}>Invoice</Text>
          <Text style={styles.subtitle}>Work Order #{workOrderId}</Text>

          <View style={styles.grid2}>
            <View style={styles.box}>
              <Text style={styles.boxTitle}>Customer</Text>
              <View style={styles.row}>
                <Text style={styles.label}>Name</Text>
                <Text style={styles.value}>{customerName}</Text>
              </View>
              <View style={styles.row}>
                <Text style={styles.label}>Phone</Text>
                <Text style={styles.value}>{customerPhone}</Text>
              </View>
              <View style={styles.row}>
                <Text style={styles.label}>Email</Text>
                <Text style={styles.value}>{customerEmail}</Text>
              </View>
            </View>

            <View style={styles.box}>
              <Text style={styles.boxTitle}>Vehicle</Text>
              <View style={styles.row}>
                <Text style={styles.label}>Vehicle</Text>
                <Text style={styles.value}>{fmtVehicle(vehicleInfo)}</Text>
              </View>
              <View style={styles.row}>
                <Text style={styles.label}>VIN</Text>
                <Text style={styles.value}>{fmtVin(vehicleInfo)}</Text>
              </View>
            </View>
          </View>
        </View>

        {/* Summary */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Repair Summary</Text>
          <Text style={styles.paragraph}>
            {typeof summary === "string" && summary.trim().length > 0
              ? summary.trim()
              : "‚Äî"}
          </Text>
        </View>

        {/* Lines */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>Work Performed</Text>

          {(lines ?? []).length === 0 ? (
            <Text style={styles.paragraph}>‚Äî</Text>
          ) : (
            (lines ?? []).map((line, idx) => {
              const complaint = safeStr(line.complaint).trim() || "‚Äî";
              const cause = safeStr(line.cause).trim() || "‚Äî";
              const correction = safeStr(line.correction).trim() || "‚Äî";
              const laborTime = safeStr(line.labor_time).trim() || "‚Äî";

              return (
                <View key={`line-${idx}`} style={styles.lineItem}>
                  <Text style={styles.bullet}>‚Ä¢ Complaint: {complaint}</Text>
                  <Text style={styles.subText}>Cause: {cause}</Text>
                  <Text style={styles.subText}>Correction: {correction}</Text>
                  <Text style={styles.subText}>Labor Time: {laborTime} hrs</Text>
                </View>
              );
            })
          )}
        </View>

        {/* Signature */}
        {typeof signatureImage === "string" &&
          signatureImage.trim().length > 0 && (
            <View style={styles.signatureWrap}>
              <Text style={styles.signatureLabel}>Customer Signature</Text>
              <Image src={signatureImage} style={styles.signatureImage} />
            </View>
          )}

        {/* Footer */}
        <View style={styles.footer} fixed>
          <Text style={styles.footerText}>ProFixIQ</Text>
          <Text style={styles.footerText}>
            Generated {new Date().toLocaleDateString()}
          </Text>
        </View>
      </Page>
    </Document>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderLineEditor.tsx
========================================
"use client";

import { useState, useEffect } from "react";

export type WorkOrderLine = {
  id?: string;
  complaint: string;
  cause?: string;
  correction?: string;
  labor_time?: number;
  status?: "unassigned" | "assigned" | "in_progress" | "on_hold" | "completed" | "awaiting";
  hold_reason?: "parts" | "authorization" | "diagnosis_pending" | "other" | "";
  tools?: string;
};

export type WorkOrderLineEditorProps = {
  line: WorkOrderLine;
  /** Rename per Next.js serializable-props rule */
  onUpdate$?: (line: WorkOrderLine) => void;
  onDelete$?: () => void;
};

export default function WorkOrderLineEditor({
  line,
  onUpdate$,
  onDelete$,
}: WorkOrderLineEditorProps) {
  const [localLine, setLocalLine] = useState<WorkOrderLine>(line);

  useEffect(() => {
    onUpdate$?.(localLine);
  }, [localLine, onUpdate$]);

  return (
    <div className="bg-white border rounded-lg p-4 mb-4 shadow-sm">
      <label className="block text-sm font-semibold mb-1 text-gray-700">Complaint</label>
      <input
        value={localLine.complaint}
        onChange={(e) => setLocalLine({ ...localLine, complaint: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Cause</label>
      <input
        value={localLine.cause || ""}
        onChange={(e) => setLocalLine({ ...localLine, cause: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Correction</label>
      <input
        value={localLine.correction || ""}
        onChange={(e) => setLocalLine({ ...localLine, correction: e.target.value })}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Labor Time (hrs)</label>
      <input
        type="number"
        value={localLine.labor_time ?? ""}
        onChange={(e) => {
          const num = e.target.value === "" ? undefined : Number(e.target.value);
          setLocalLine({ ...localLine, labor_time: Number.isFinite(num as number) ? (num as number) : undefined });
        }}
        className="w-full border rounded px-2 py-1 mb-3"
      />

      <label className="block text-sm font-semibold mb-1 text-gray-700">Status</label>
      <select
        value={localLine.status || "unassigned"}
        onChange={(e) => setLocalLine({ ...localLine, status: e.target.value as WorkOrderLine["status"] })}
        className="w-full border rounded px-2 py-1 mb-3"
      >
        <option value="unassigned">Unassigned</option>
        <option value="assigned">Assigned</option>
        <option value="awaiting">Awaiting</option>
        <option value="in_progress">In Progress</option>
        <option value="on_hold">On Hold</option>
        <option value="completed">Completed</option>
      </select>

      {localLine.status === "on_hold" && (
        <>
          <label className="block text-sm font-semibold mb-1 text-gray-700">Hold Reason</label>
          <select
            value={localLine.hold_reason || ""}
            onChange={(e) =>
              setLocalLine({ ...localLine, hold_reason: e.target.value as WorkOrderLine["hold_reason"] })
            }
            className="w-full border rounded px-2 py-1 mb-3"
          >
            <option value="">Select Reason</option>
            <option value="parts">Parts Hold</option>
            <option value="authorization">Awaiting Authorization</option>
            <option value="diagnosis_pending">Waiting Diagnosis</option>
            <option value="other">Other</option>
          </select>
        </>
      )}

      {onDelete$ && (
        <button onClick={onDelete$} className="mt-2 text-sm text-red-600 hover:underline">
          Delete Line
        </button>
      )}
    </div>
  );
}


========================================
FILE: features/work-orders/components/WorkOrderPDF.tsx
========================================
import { Document, Page, Text, View, StyleSheet } from "@react-pdf/renderer";
import { RepairLine } from "@ai/lib/parseRepairOutput";

type Props = {
  vehicleId: string;
  workOrderId: string;
  vehicleInfo?: { year?: string; make?: string; model?: string; vin?: string };
  customerInfo?: { name?: string; phone?: string; email?: string };
  lines: RepairLine[];
  summary?: string;
};

export function WorkOrderPDF({
  workOrderId,
  vehicleInfo,
  customerInfo,
  lines,
  summary,
}: Props) {
  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* Shop Branding */}
        <View style={styles.header}>
          <Text style={styles.logo}>ProFixIQ</Text>
          <Text style={styles.subtitle}>Mobile Repair & Diagnostics</Text>
          <Text>üìû (555) 123-4567 | ‚úâ support@profixiq.com</Text>
          <Text style={styles.invoiceTitle}>Work Order #{workOrderId}</Text>
        </View>

        {/* Customer + Vehicle Info */}
        <View style={styles.infoSection}>
          <View>
            <Text style={styles.label}>Customer Info:</Text>
            <Text>{customerInfo?.name}</Text>
            <Text>{customerInfo?.phone}</Text>
            <Text>{customerInfo?.email}</Text>
          </View>

          <View>
            <Text style={styles.label}>Vehicle Info:</Text>
            <Text>
              {vehicleInfo?.year} {vehicleInfo?.make} {vehicleInfo?.model}
            </Text>
            <Text>VIN: {vehicleInfo?.vin}</Text>
          </View>
        </View>

        {/* Repair Lines */}
        <View style={styles.lineTable}>
          {lines.map((line, idx) => (
            <View key={idx} style={styles.lineRow}>
              <Text style={styles.lineLabel}>Complaint:</Text>
              <Text>{line.complaint}</Text>
              <Text style={styles.lineLabel}>Correction:</Text>
              <Text>{line.correction}</Text>
            </View>
          ))}
        </View>

        {/* Repair Summary */}
        {summary && (
          <View style={styles.section}>
            <Text style={styles.label}>Repair Summary:</Text>
            <Text>{summary}</Text>
          </View>
        )}
      </Page>
    </Document>
  );
}

const styles = StyleSheet.create({
  page: { padding: 30, fontSize: 12 },
  header: {
    textAlign: "center",
    marginBottom: 20,
  },
  logo: {
    fontSize: 24,
    fontWeight: "bold",
    color: "#1E40AF",
  },
  subtitle: {
    fontSize: 12,
    marginBottom: 4,
  },
  invoiceTitle: {
    fontSize: 14,
    marginTop: 10,
    fontWeight: "bold",
    textDecoration: "underline",
  },
  infoSection: {
    flexDirection: "row",
    justifyContent: "space-between",
    marginBottom: 20,
  },
  label: { fontWeight: "bold", marginTop: 4 },
  section: { marginVertical: 10 },
  lineTable: { marginTop: 10 },
  lineRow: { marginBottom: 8 },
  lineLabel: { fontWeight: "bold" },
});


========================================
FILE: features/work-orders/components/workorders/AddJobModal.tsx
========================================
"use client";

import { useMemo, useRef, useState } from "react";
import { v4 as uuidv4 } from "uuid";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import ModalShell from "@/features/shared/components/ModalShell";

type Props = {
  isOpen: boolean;
  onClose: () => void;
  workOrderId: string;
  vehicleId: string | null;
  techId: string;
  onJobAdded?: () => void;
  shopId?: string | null;
};

export default function AddJobModal(props: Props) {
  const {
    isOpen,
    onClose,
    workOrderId,
    vehicleId,
    techId,
    onJobAdded,
    shopId,
  } = props;

  const supabase = useMemo(() => createBrowserSupabase(), []);
  const lastSetShopId = useRef<string | null>(null);

  const [jobName, setJobName] = useState("");
  const [notes, setNotes] = useState("");
  const [labor, setLabor] = useState("");
  const [parts, setParts] = useState("");
  const [urgency, setUrgency] = useState<"low" | "medium" | "high">("medium");
  const [submitting, setSubmitting] = useState(false);
  const [err, setErr] = useState<string | null>(null);

  async function ensureShopContext(id: string | null) {
    if (!id) return;
    if (lastSetShopId.current === id) return;
    const { error } = await supabase.rpc("set_current_shop_id", {
      p_shop_id: id,
    });
    if (error) throw error;
    lastSetShopId.current = id;
  }

  const handleSubmit = async () => {
    if (!jobName.trim()) {
      setErr("Job name is required.");
      return;
    }

    setSubmitting(true);
    setErr(null);

    try {
      // resolve shop_id
      let useShopId = shopId ?? null;
      if (!useShopId) {
        const { data: wo, error: woErr } = await supabase
          .from("work_orders")
          .select("shop_id")
          .eq("id", workOrderId)
          .maybeSingle();

        if (woErr) throw woErr;
        useShopId = (wo?.shop_id as string | null) ?? null;
      }
      if (!useShopId)
        throw new Error("Couldn‚Äôt resolve shop for this work order");

      await ensureShopContext(useShopId);

      // get current user for user_id if your RLS expects it
      const {
        data: { user },
      } = await supabase.auth.getUser();

      const payload = {
        id: uuidv4(),
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        complaint: jobName.trim(),
        cause: null,
        correction: notes.trim() || null,
        labor_time: labor ? Number(labor) : null,
        parts: parts.trim() || null,
        status: "awaiting" as const,
        job_type: "repair" as const,
        shop_id: useShopId,
        ...(user?.id ? { user_id: user.id } : {}),
        ...(techId && techId !== "system" ? { assigned_to: techId } : {}),
        ...(urgency ? { urgency } : {}),
      };

      const { error } = await supabase.from("work_order_lines").insert(payload);
      if (error) {
        // handle common RLS / check errors a bit nicer
        if (/row-level security/i.test(error.message)) {
          setErr(
            "Access denied (RLS). Check that your session is scoped to this shop.",
          );
          lastSetShopId.current = null;
        } else if (/status.*check/i.test(error.message)) {
          setErr("This status isn‚Äôt allowed by the database.");
        } else if (/job_type.*check/i.test(error.message)) {
          setErr("This job type isn‚Äôt allowed by the database.");
        } else {
          setErr(error.message);
        }
        return;
      }

      onJobAdded?.();
      onClose();

      // reset fields
      setJobName("");
      setNotes("");
      setLabor("");
      setParts("");
      setUrgency("medium");
      setErr(null);
    } catch (e: any) {
      setErr(e?.message ?? "Failed to add job.");
      lastSetShopId.current = null;
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="Add New Job Line"
      onSubmit={handleSubmit}
      submitText={submitting ? "Adding‚Ä¶" : "Add Job"}
      size="sm"
    >
      <div className="space-y-4">
        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Job name
          </label>
          <input
            type="text"
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="e.g. Replace serpentine belt"
            value={jobName}
            onChange={(e) => setJobName(e.target.value)}
          />
        </div>

        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Notes / correction
          </label>
          <textarea
            rows={3}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="Optional notes, concerns, or correction details‚Ä¶"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
          />
        </div>

        <div className="grid gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
              Labor hours
            </label>
            <input
              type="number"
              step="0.1"
              className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
              placeholder="e.g. 1.5"
              value={labor}
              onChange={(e) => setLabor(e.target.value)}
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
              Urgency
            </label>
            <select
              className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
              value={urgency}
              onChange={(e) =>
                setUrgency(e.target.value as "low" | "medium" | "high")
              }
            >
              <option value="low">Low urgency</option>
              <option value="medium">Medium urgency</option>
              <option value="high">High urgency</option>
            </select>
          </div>
        </div>

        <div>
          <label className="mb-1 block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Parts required
          </label>
          <textarea
            rows={2}
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            placeholder="Comma-separated list or short notes (e.g. rear pads, serp belt, brake cleaner)"
            value={parts}
            onChange={(e) => setParts(e.target.value)}
          />
        </div>

        {err && (
          <div className="rounded-md border border-red-500/50 bg-red-950/40 px-3 py-2 text-xs text-red-100">
            {err}
          </div>
        )}
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/AiAssistantModal.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { createPortal } from "react-dom";
import TechAssistant from "@/features/shared/components/TechAssistant";

type AiAssistantModalProps = {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId?: string;
  defaultVehicle?: {
    year?: string;
    make?: string;
    model?: string;
  };
};

export default function AiAssistantModal({
  isOpen,
  onClose,
  workOrderLineId,
  defaultVehicle,
}: AiAssistantModalProps) {
  // Ensure we only portal once we're mounted in the browser
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  if (!isOpen || !mounted) return null;

  return createPortal(
    <div className="fixed inset-0 z-[200] flex items-start justify-center overflow-y-auto pt-10 pb-10">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/75 backdrop-blur-sm"
        onClick={onClose}
        aria-hidden="true"
      />

      {/* Panel wrapper */}
      <div className="relative z-[210] mx-4 w-full max-w-3xl">
        <div className="overflow-hidden rounded-2xl border border-[color:var(--metal-border-soft,#1f2937)] bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.18),transparent_55%),radial-gradient(circle_at_bottom,_rgba(15,23,42,0.96),#020617_78%)] shadow-[0_32px_80px_rgba(0,0,0,0.95)]">
          {/* Header */}
          <div className="flex items-start justify-between border-b border-white/10 px-5 py-3">
            <div>
              <h2
                className="text-xs font-semibold uppercase tracking-[0.24em] text-neutral-300"
                style={{ fontFamily: "var(--font-blackops), system-ui" }}
              >
                AI / Tech Assistant
              </h2>
              <p className="mt-1 text-[11px] text-neutral-400">
                Scoped to this job and vehicle where possible.
              </p>
            </div>
            <button
              type="button"
              onClick={onClose}
              className="ml-3 inline-flex h-7 w-7 items-center justify-center rounded-full border border-white/20 bg-black/60 text-xs text-neutral-200 hover:bg-white/10"
              aria-label="Close AI assistant"
            >
              ‚úï
            </button>
          </div>

          {/* Body ‚Äì TechAssistant handles its own inner scroll for messages */}
          <div className="px-5 py-4">
            <div className="rounded-2xl border border-white/12 bg-black/70 p-3 shadow-[0_18px_45px_rgba(0,0,0,0.9)]">
              <TechAssistant
                defaultVehicle={defaultVehicle}
                workOrderLineId={workOrderLineId}
              />
            </div>
          </div>
        </div>
      </div>
    </div>,
    document.body,
  );
}

========================================
FILE: features/work-orders/components/workorders/CauseCorrectionModal.tsx
========================================
"use client";

import { useEffect, useRef, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface CauseCorrectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  jobId: string;
  /** Complete job ‚Äì usually updates cause, correction, status, punched_out_at, etc. */
  onSubmit: (cause: string, correction: string) => Promise<void>;
  /** Optional: save cause/correction without completing the job */
  onSaveDraft?: (cause: string, correction: string) => Promise<void>;
  initialCause?: string;
  initialCorrection?: string;
}

export default function CauseCorrectionModal({
  isOpen,
  onClose,
  jobId,
  onSubmit,
  onSaveDraft,
  initialCause = "",
  initialCorrection = "",
}: CauseCorrectionModalProps) {
  const [cause, setCause] = useState(initialCause);
  const [correction, setCorrection] = useState(initialCorrection);
  const [submitting, setSubmitting] = useState(false);
  const [savingDraft, setSavingDraft] = useState(false);
  const causeRef = useRef<HTMLTextAreaElement | null>(null);

  useEffect(() => {
    if (isOpen) {
      setCause(initialCause);
      setCorrection(initialCorrection);
      setTimeout(() => causeRef.current?.focus(), 50);
    }
  }, [isOpen, initialCause, initialCorrection]);

  const handleSubmit = async () => {
    if (submitting || savingDraft) return;
    setSubmitting(true);
    try {
      await onSubmit(cause.trim(), correction.trim());
      onClose();
    } finally {
      setSubmitting(false);
    }
  };

  const handleSaveDraft = async () => {
    if (!onSaveDraft || submitting || savingDraft) return;
    setSavingDraft(true);
    try {
      await onSaveDraft(cause.trim(), correction.trim());
      // keep modal open so they can continue / complete later
    } finally {
      setSavingDraft(false);
    }
  };

  const busy = submitting || savingDraft;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="COMPLETE JOB"
      size="md"
      hideFooter
    >
      {/* üîπ Make inner content scrollable, not the whole screen */}
      <div
        className="max-h-[70vh] space-y-4 overflow-y-auto pr-1"
        style={{ WebkitOverflowScrolling: "touch" }}
      >
        {/* Job meta */}
        <div className="flex items-center justify-between text-[0.7rem] text-neutral-400">
          <div className="flex flex-col gap-0.5">
            <span className="font-semibold uppercase tracking-[0.18em]">
              Job ID
            </span>
            <span className="font-mono text-[0.7rem] text-neutral-200">
              {jobId}
            </span>
          </div>
          <span className="rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-3 py-1 text-[0.65rem] uppercase tracking-[0.18em] text-neutral-300">
            Cause / Correction
          </span>
        </div>

        {/* Cause */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Cause
          </label>
          <textarea
            ref={causeRef}
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={cause}
            onChange={(e) => setCause(e.target.value)}
            placeholder="What caused the issue?"
          />
        </div>

        {/* Correction */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Correction
          </label>
          <textarea
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={correction}
            onChange={(e) => setCorrection(e.target.value)}
            placeholder="Describe what was done to correct the issue‚Ä¶"
            onKeyDown={(e) => {
              if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
                e.preventDefault();
                void handleSubmit();
              }
            }}
          />
          <p className="mt-1 text-[0.7rem] text-neutral-500">
            Press{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              Ctrl
            </kbd>{" "}
            /{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              ‚åò
            </kbd>{" "}
            +{" "}
            <kbd className="rounded border border-neutral-700 bg-black/60 px-1 text-[0.65rem]">
              Enter
            </kbd>{" "}
            to complete the job.
          </p>
        </div>

        {/* Footer actions (custom, since we need two primary actions) */}
        <div className="mt-2 flex flex-col gap-2 border-t border-[var(--metal-border-soft)] pt-3 sm:flex-row sm:items-center sm:justify-between">
          <button
            type="button"
            onClick={onClose}
            disabled={busy}
            className="inline-flex items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/60 px-4 py-1.5 text-xs font-medium uppercase tracking-[0.18em] text-neutral-200 hover:bg-white/5 disabled:opacity-60"
          >
            Cancel
          </button>

          <div className="flex flex-1 flex-col gap-2 sm:flex-row sm:justify-end">
            {onSaveDraft && (
              <button
                type="button"
                onClick={() => void handleSaveDraft()}
                disabled={busy}
                className="inline-flex flex-1 items-center justify-center rounded-full border border-[var(--accent-copper-soft)]/70 bg-black/50 px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.18em] text-[var(--accent-copper-soft)] shadow-[0_0_12px_rgba(212,118,49,0.35)] hover:bg-[var(--accent-copper-faint)] disabled:opacity-60 sm:flex-none sm:px-5"
              >
                {savingDraft ? "Saving‚Ä¶" : "Save story only"}
              </button>
            )}

            <button
              type="button"
              onClick={() => void handleSubmit()}
              disabled={busy}
              className="inline-flex flex-1 items-center justify-center rounded-full bg-[linear-gradient(to_right,var(--accent-copper-soft),var(--accent-copper))] px-4 py-1.5 text-xs font-semibold uppercase tracking-[0.22em] text-black shadow-[0_0_20px_rgba(212,118,49,0.7)] hover:brightness-110 disabled:opacity-60 sm:flex-none sm:px-6"
            >
              {submitting ? "Completing‚Ä¶" : "Complete job"}
            </button>
          </div>
        </div>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/DtcSuggestionPopup.tsx
========================================
// features/work-orders/components/workorders/extras/DtcSuggestionModal.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

type Props = {
  isOpen: boolean;
  onClose: () => void;
  jobId: string;
  vehicle?: {
    year?: string | null;
    make?: string | null;
    model?: string | null;
  } | null;
};

type DtcSuggestionResponse = {
  cause: string;
  correction: string;
  laborTime: number | null;
};

export default function DtcSuggestionModal({
  isOpen,
  onClose,
  jobId,
  vehicle,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [cause, setCause] = useState("");
  const [correction, setCorrection] = useState("");
  const [laborTime, setLaborTime] = useState<string>("");
  const [generating, setGenerating] = useState(false);
  const [saving, setSaving] = useState(false);
  const [hasGenerated, setHasGenerated] = useState(false);

  // When modal opens, ask backend to generate suggestions from complaint line
  useEffect(() => {
    if (!isOpen || !jobId) return;

    const run = async () => {
      setGenerating(true);
      try {
        const res = await fetch("/api/work-orders/dtc-suggest", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ jobId }),
        });

        const json = (await res.json()) as
          | { suggestion?: DtcSuggestionResponse; error?: string }
          | undefined;

        if (!res.ok || !json?.suggestion) {
          throw new Error(json?.error || "AI could not generate suggestions.");
        }

        const { cause, correction, laborTime } = json.suggestion;

        setCause(cause ?? "");
        setCorrection(correction ?? "");
        setLaborTime(
          laborTime != null && !Number.isNaN(laborTime)
            ? laborTime.toString()
            : "",
        );
        setHasGenerated(true);
      } catch (err) {
        console.error("[DtcSuggestionModal] generate failed", err);
        setHasGenerated(false);
        toast.error(
          err instanceof Error
            ? err.message
            : "Could not generate DTC suggestions.",
        );
      } finally {
        setGenerating(false);
      }
    };

    void run();
  }, [isOpen, jobId]);

  const handleSave = async () => {
    const trimmedCause = cause.trim();
    const trimmedCorrection = correction.trim();
    const trimmedLabor = laborTime.trim();

    if (!trimmedCause || !trimmedCorrection) {
      toast.error("Cause and correction are required.");
      return;
    }

    const parsedLabor =
      trimmedLabor === "" ? null : Number.parseFloat(trimmedLabor);
    if (trimmedLabor !== "" && Number.isNaN(parsedLabor)) {
      toast.error("Labor time must be a valid number.");
      return;
    }

    setSaving(true);
    try {
      const updates: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        cause: trimmedCause,
        correction: trimmedCorrection,
        labor_time: parsedLabor,
      };

      const { error } = await supabase
        .from("work_order_lines")
        .update(updates)
        .eq("id", jobId);

      if (error) throw error;

      toast.success("AI cause / correction applied to this job.");
      onClose();
      // focused job modal will pick this up via refresh / realtime
    } catch (err: any) {
      console.error("[DtcSuggestionModal] save failed", err);
      toast.error(err?.message ?? "Error saving DTC suggestions.");
    } finally {
      setSaving(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="AI DTC Cause / Correction"
      onSubmit={handleSave}
      submitText={saving ? "Saving‚Ä¶" : "Apply to Job"}
      size="md"
    >
      <div className="space-y-3">
        {vehicle && (
          <p className="text-xs text-neutral-400">
            Using complaint + context for{" "}
            <span className="font-mono text-neutral-100">
              {vehicle.year ?? ""} {vehicle.make ?? ""} {vehicle.model ?? ""}
            </span>
          </p>
        )}

        {generating && (
          <div className="rounded border border-amber-500/40 bg-amber-500/5 px-3 py-2 text-xs text-amber-100">
            Thinking through codes and complaint‚Ä¶
          </div>
        )}

        {!generating && !hasGenerated && (
          <div className="rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-xs text-neutral-300">
            No AI suggestion yet. You can fill in cause, correction and labor
            manually and apply.
          </div>
        )}

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Cause
          </label>
          <textarea
            rows={2}
            value={cause}
            onChange={(e) => setCause(e.target.value)}
            placeholder="AI-generated root cause will appear here‚Ä¶"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Correction
          </label>
          <textarea
            rows={3}
            value={correction}
            onChange={(e) => setCorrection(e.target.value)}
            placeholder="AI-generated correction steps & specs will appear here‚Ä¶"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <div>
          <label className="mb-1 block text-xs uppercase tracking-[0.16em] text-neutral-400">
            Labor time (hours)
          </label>
          <input
            type="number"
            min={0}
            step={0.1}
            value={laborTime}
            onChange={(e) => setLaborTime(e.target.value)}
            placeholder="e.g. 1.5"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
          />
        </div>

        <p className="mt-1 text-[11px] text-neutral-500">
          This will overwrite the job&apos;s existing{" "}
          <span className="font-semibold text-neutral-100">cause</span>,{" "}
          <span className="font-semibold text-neutral-100">correction</span> and{" "}
          <span className="font-semibold text-neutral-100">labor time</span>.
        </p>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/AssignTechModal.tsx
========================================
// features/work-orders/components/workorders/AssignTechModal.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";
import ModalShell from "@/features/shared/components/ModalShell";
import { toast } from "sonner";

interface Assignable {
  id: string;
  full_name: string | null;
  role: string | null;
}

interface Props {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId: string;
  // name we originally used
  initialMechanics?: Assignable[];
  // name your page is currently passing
  mechanics?: Assignable[];
  onAssigned?: (techId: string) => void | Promise<void>;
}

export default function AssignTechModal({
  isOpen,
  onClose,
  workOrderLineId,
  initialMechanics,
  mechanics,
  onAssigned,
}: Props) {
  const supabase = useMemo(() => createBrowserSupabase(), []);
  const [users, setUsers] = useState<Assignable[]>(() => {
    return mechanics ?? initialMechanics ?? [];
  });
  const [techId, setTechId] = useState<string>("");
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    if (!isOpen) return;

    const pref = mechanics ?? initialMechanics;
    if (pref && pref.length) {
      setUsers(pref);
      return;
    }

    (async () => {
      try {
        const res = await fetch("/api/assignables");
        const json = await res.json();
        if (res.ok && Array.isArray(json.data)) {
          setUsers(json.data);
        } else {
          const { data } = await supabase
            .from("profiles")
            .select("id, full_name, role")
            .in("role", ["mechanic", "tech", "foreman", "lead_hand"])
            .order("full_name", { ascending: true });
          setUsers((data as Assignable[]) ?? []);
        }
      } catch {
        // ignore, leave users as-is
      }
    })();
  }, [isOpen, mechanics, initialMechanics, supabase]);

  const submit = async () => {
    if (!techId || submitting) {
      onClose();
      return;
    }

    setSubmitting(true);
    try {
      const res = await fetch("/api/work-orders/assign-line", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          work_order_line_id: workOrderLineId,
          tech_id: techId,
        }),
      });

      if (!res.ok) {
        await supabase
          .from("work_order_lines")
          .update({ assigned_to: techId })
          .eq("id", workOrderLineId);
      }

      toast.success("Mechanic assigned.");
      await onAssigned?.(techId);
      onClose();
    } catch {
      toast.error("Failed to assign mechanic.");
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Assign mechanic"
      submitText={submitting ? "Assigning‚Ä¶" : "Assign"}
      size="sm"
    >
      <label className="block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Choose mechanic
        </span>
        <select
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          value={techId}
          onChange={(e) => setTechId(e.target.value)}
        >
          <option value="">Select‚Ä¶</option>
          {users.map((u) => (
            <option key={u.id} value={u.id}>
              {u.full_name ?? "(no name)"} {u.role ? `(${u.role})` : ""}
            </option>
          ))}
        </select>
      </label>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/CostEstimateModal.tsx
========================================
// features/work-orders/components/workorders/CostEstimateModal.tsx
"use client";

import { useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  defaultLaborHours?: number | null;
  defaultPrice?: number | null;
  onApply: (laborHours: number | null, price: number | null) => void | Promise<void>;
}

export default function CostEstimateModal({
  isOpen,
  onClose,
  defaultLaborHours = null,
  defaultPrice = null,
  onApply,
}: Props) {
  const [labor, setLabor] = useState<string>(
    typeof defaultLaborHours === "number" ? String(defaultLaborHours) : "",
  );
  const [price, setPrice] = useState<string>(
    typeof defaultPrice === "number" ? String(defaultPrice) : "",
  );
  const [submitting, setSubmitting] = useState(false);

  const submit = async () => {
    if (submitting) return;
    setSubmitting(true);
    try {
      const lh = labor.trim() ? Number(labor) : null;
      const pr = price.trim() ? Number(price) : null;
      await onApply(lh, pr);
      onClose();
    } finally {
      setSubmitting(false);
    }
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Cost / Estimate"
      submitText={submitting ? "Saving‚Ä¶" : "Save"}
      size="sm"
    >
      <div className="grid gap-3 sm:grid-cols-2">
        <label className="block text-sm">
          <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
            Labor (hrs)
          </span>
          <input
            type="number"
            step="0.1"
            min="0"
            value={labor}
            onChange={(e) => setLabor(e.target.value)}
            className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
            placeholder="e.g. 1.5"
          />
        </label>
        <label className="block text-sm">
          <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
            Price ($)
          </span>
          <input
            type="number"
            step="1"
            min="0"
            value={price}
            onChange={(e) => setPrice(e.target.value)}
            className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
            placeholder="e.g. 250"
          />
        </label>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/CustomerContactModal.tsx
========================================
// features/work-orders/components/workorders/CustomerContactModal.tsx
"use client";

import { useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  customerName?: string | null;
  customerEmail?: string | null;
  customerPhone?: string | null;
  onSendEmail?: (subject: string, body: string) => void | Promise<void>;
  onSendSms?: (message: string) => void | Promise<void>;
}

export default function CustomerContactModal({
  isOpen,
  onClose,
  customerName,
  customerEmail,
  customerPhone,
  onSendEmail,
  onSendSms,
}: Props) {
  const [subject, setSubject] = useState("");
  const [body, setBody] = useState("");
  const [sms, setSms] = useState("");
  const [sendingSms, setSendingSms] = useState(false);
  const [sendingEmail, setSendingEmail] = useState(false);

  const canSendEmail = !!onSendEmail && (subject.trim() || body.trim());
  const canSendSms = !!onSendSms && sms.trim().length > 0;

  const handleSendSms = async () => {
    if (!onSendSms || !canSendSms) return;
    setSendingSms(true);
    try {
      await onSendSms(sms.trim());
      setSms("");
    } finally {
      setSendingSms(false);
    }
  };

  const handleSendEmail = onSendEmail
    ? async () => {
        if (!canSendEmail) return;
        setSendingEmail(true);
        try {
          await onSendEmail(subject.trim(), body.trim());
          setSubject("");
          setBody("");
          onClose();
        } finally {
          setSendingEmail(false);
        }
      }
    : undefined;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="Contact Customer"
      size="md"
      footerLeft={
        onSendSms ? (
          <button
            type="button"
            onClick={() => void handleSendSms()}
            className="rounded border border-emerald-500/70 bg-emerald-500/10 px-3 py-1.5 text-sm font-semibold text-emerald-100 hover:bg-emerald-500/20 disabled:opacity-60"
            disabled={!canSendSms || sendingSms}
          >
            {sendingSms ? "Sending SMS‚Ä¶" : "Send SMS"}{" "}
            {customerPhone ? `(${customerPhone})` : ""}
          </button>
        ) : null
      }
      onSubmit={handleSendEmail}
      submitText={sendingEmail ? "Sending‚Ä¶" : "Send Email"}
    >
      <div className="mb-3 text-sm text-muted-foreground">
        {customerName ? (
          <span className="font-medium text-foreground">{customerName}</span>
        ) : null}{" "}
        {customerEmail ? <span>‚Ä¢ {customerEmail}</span> : null}
        {customerPhone ? <span> ‚Ä¢ {customerPhone}</span> : null}
      </div>

      <label className="block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Subject
        </span>
        <input
          type="text"
          value={subject}
          onChange={(e) => setSubject(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Subject line‚Ä¶"
        />
      </label>

      <label className="mt-3 block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          Email Body
        </span>
        <textarea
          rows={6}
          value={body}
          onChange={(e) => setBody(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Write your email to the customer‚Ä¶"
        />
      </label>

      <label className="mt-4 block text-sm">
        <span className="mb-1 block text-xs font-medium uppercase tracking-wide text-muted-foreground">
          SMS
        </span>
        <textarea
          rows={3}
          value={sms}
          onChange={(e) => setSms(e.target.value)}
          className="w-full rounded border border-border/60 bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground dark:border-neutral-700 dark:bg-neutral-900 dark:text-white"
          placeholder="Quick text message‚Ä¶"
        />
      </label>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/PhotoCaptureModal.tsx
========================================
"use client";

import { useRef, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  onCapture: (file: File) => void | Promise<void>;
}

export default function PhotoCaptureModal(props: any) {
  const { isOpen, onClose, onCapture } = props as Props;
  const [file, setFile] = useState<File | null>(null);
  const inputRef = useRef<HTMLInputElement | null>(null);

  const submit = async () => {
    if (!file) return onClose();
    await onCapture(file);
    onClose();
    setFile(null);
    if (inputRef.current) inputRef.current.value = "";
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Attach Photo"
      submitText="Upload"
      size="sm"
    >
      <div className="space-y-2">
        <label className="block text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
          Job photo
        </label>
        <input
          ref={inputRef}
          type="file"
          accept="image/*"
          capture="environment"
          onChange={(e) => setFile(e.target.files?.[0] ?? null)}
          className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white file:mr-3 file:rounded-md file:border-0 file:bg-neutral-800 file:px-3 file:py-1.5 file:text-xs file:font-semibold file:text-neutral-100 hover:file:bg-neutral-700 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
        />
        <p className="mt-1 text-[11px] text-neutral-500">
          On mobile, this will open the camera. On desktop, you can pick an
          existing image file.
        </p>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/StatusPickerModal.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

type WorkflowStatus =
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "completed"
  | "assigned"
  | "unassigned";

type ApprovalPick =
  | "approval:pending"
  | "approval:approved"
  | "approval:declined";
type StatusPick = `status:${WorkflowStatus}`;
type PickerValue = StatusPick | ApprovalPick;

const WORKFLOW_OPTIONS: WorkflowStatus[] = [
  "awaiting",
  "queued",
  "in_progress",
  "on_hold",
  "completed",
  "assigned",
  "unassigned",
];

const APPROVAL_OPTIONS: ApprovalPick[] = [
  "approval:pending",
  "approval:approved",
  "approval:declined",
];

export default function StatusPickerModal(props: {
  isOpen: boolean;
  onClose: () => void;
  current?: WorkflowStatus;
  onChange: (next: PickerValue) => Promise<void> | void;
}) {
  const { isOpen, onClose, current = "awaiting", onChange } = props;

  const [value, setValue] = useState<PickerValue>(`status:${current}`);

  // Reset to current workflow status whenever the modal opens or current changes
  useEffect(() => {
    if (isOpen) {
      setValue(`status:${current}`);
    }
  }, [isOpen, current]);

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="Change Status"
      size="sm"
      onSubmit={async () => {
        await onChange(value);
        onClose();
      }}
      submitText="Apply"
    >
      <div className="flex flex-col gap-4">
        {/* Workflow */}
        <div className="space-y-2">
          <div className="text-center text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Workflow Status
          </div>
          <select
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            value={
              value.startsWith("status:")
                ? (value as StatusPick)
                : (`status:${current}` as StatusPick)
            }
            onChange={(e) => setValue(e.target.value as StatusPick)}
          >
            {WORKFLOW_OPTIONS.map((s) => {
              const v: StatusPick = `status:${s}`;
              return (
                <option key={v} value={v}>
                  {s.replaceAll("_", " ")}
                </option>
              );
            })}
          </select>
        </div>

        {/* Divider-ish helper */}
        <div className="text-center text-[10px] uppercase tracking-[0.18em] text-neutral-600">
          or adjust approval
        </div>

        {/* Approval */}
        <div className="space-y-2">
          <div className="text-center text-xs font-medium uppercase tracking-[0.16em] text-neutral-400">
            Approval State
          </div>
          <select
            className="w-full rounded-md border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-1 focus:ring-[var(--accent-copper-light)]"
            value={
              value.startsWith("approval:")
                ? (value as ApprovalPick)
                : ("approval:pending" as ApprovalPick)
            }
            onChange={(e) => setValue(e.target.value as ApprovalPick)}
          >
            {APPROVAL_OPTIONS.map((v) => (
              <option key={v} value={v}>
                {v.replace("approval:", "").replaceAll("_", " ")}
              </option>
            ))}
          </select>
        </div>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/extras/TimeAdjustModal.tsx
========================================
"use client";

import { useState } from "react";
import { format } from "date-fns";
import ModalShell from "@/features/shared/components/ModalShell";

interface Props {
  isOpen: boolean;
  onClose: () => void;
  punchedInAt?: string | null;
  punchedOutAt?: string | null;
  onApply: (punchedInAt: string | null, punchedOutAt: string | null) => void | Promise<void>;
}

export default function TimeAdjustModal(props: any) {
  const { isOpen, onClose, punchedInAt, punchedOutAt, onApply } = props as Props;
  const [inAt, setInAt] = useState<string | "">(
    punchedInAt ? format(new Date(punchedInAt), "yyyy-MM-dd'T'HH:mm") : ""
  );
  const [outAt, setOutAt] = useState<string | "">(
    punchedOutAt ? format(new Date(punchedOutAt), "yyyy-MM-dd'T'HH:mm") : ""
  );

  const submit = async () => {
    const inVal = inAt ? new Date(inAt).toISOString() : null;
    const outVal = outAt ? new Date(outAt).toISOString() : null;
    await onApply(inVal, outVal);
    onClose();
  };

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      onSubmit={submit}
      title="Adjust Time"
      submitText="Save"
      size="sm"
    >
      <div className="grid gap-3">
        <label className="block text-sm">
          <span className="mb-1 block text-neutral-400">Punch In</span>
          <input
            type="datetime-local"
            value={inAt}
            onChange={(e) => setInAt(e.target.value)}
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
          />
        </label>

        <label className="block text-sm">
          <span className="mb-1 block text-neutral-400">Punch Out</span>
          <input
            type="datetime-local"
            value={outAt}
            onChange={(e) => setOutAt(e.target.value)}
            className="w-full rounded border border-neutral-700 bg-neutral-900 p-2 text-white"
          />
        </label>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/workorders/FocusedJobModal.tsx
========================================
"use client";

import { useEffect, useMemo, useState, useCallback } from "react";
import { Dialog } from "@headlessui/react";
import { format } from "date-fns";
import { toast } from "sonner";
import { v4 as uuidv4 } from "uuid";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";

//import DtcSuggestionModal from "@/features/work-orders/components/workorders/DtcSuggestionPopup";

// existing modals
import CauseCorrectionModal from "@work-orders/components/workorders/CauseCorrectionModal";
import PartsRequestModal from "@/features/work-orders/components/workorders/PartsRequestModal";

// extras
import HoldModal from "@/features/work-orders/components/workorders/HoldModal";
import PhotoCaptureModal from "@/features/work-orders/components/workorders/extras/PhotoCaptureModal";
import AddJobModal from "@work-orders/components/workorders/AddJobModal";

// üî∏ AI assistant modal
import AIAssistantModal from "@work-orders/components/workorders/AiAssistantModal";

// chat
import NewChatModal from "@/features/ai/components/chat/NewChatModal";
import SuggestedQuickAdd from "@work-orders/components/SuggestedQuickAdd";

// punch
import JobPunchButton from "@/features/work-orders/components/JobPunchButton";

import type { RealtimePostgresChangesPayload } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type Mode = "tech" | "view";

const statusTextColor: Record<string, string> = {
  in_progress: "text-sky-200",
  awaiting: "text-slate-200",
  queued: "text-indigo-200",
  on_hold: "text-amber-200",
  completed: "text-emerald-200",
  paused: "text-amber-200",
  assigned: "text-sky-200",
  unassigned: "text-neutral-200",
  awaiting_approval: "text-blue-200",
  declined: "text-red-200",
};

const chip = (s: string | null) =>
  statusTextColor[(s ?? "awaiting").toLowerCase().replaceAll(" ", "_")] ??
  "text-neutral-200";

const btnBase =
  "rounded-md border text-sm px-3 py-2 transition-colors text-left";
const btnNeutral =
  btnBase +
  " border-white/15 bg-black/40 text-neutral-100 hover:bg-white/5";
const btnWarn =
  btnBase +
  " border-amber-400/80 bg-amber-500/10 text-amber-100 hover:bg-amber-500/20";
const btnDanger =
  btnBase +
  " border-red-500/80 bg-red-500/10 text-red-100 hover:bg-red-500/20";
const btnInfo =
  btnBase +
  " border-sky-500/80 bg-sky-500/10 text-sky-100 hover:bg-sky-500/20";
const btnAccent =
  btnBase +
  " border-[var(--accent-copper-light)] bg-[var(--accent-copper-faint)] text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper-soft)]";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];

type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

type WorkflowStatus =
  | "awaiting"
  | "awaiting_approval"
  | "declined"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "paused"
  | "completed"
  | "assigned"
  | "unassigned";

export default function FocusedJobModal(props: {
  isOpen: boolean;
  onClose: () => void;
  workOrderLineId: string;
  onChanged?: () => void | Promise<void>;
  mode?: Mode;
}) {
  const { isOpen, onClose, workOrderLineId, onChanged, mode = "tech" } = props;

  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [busy, setBusy] = useState(false);
  const [line, setLine] = useState<WorkOrderLine | null>(null);
  const [workOrder, setWorkOrder] = useState<WorkOrder | null>(null);
  const [vehicle, setVehicle] = useState<Vehicle | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);

  const [techNotes, setTechNotes] = useState("");
  const [savingNotes, setSavingNotes] = useState(false);

  // sub-modals
  const [openComplete, setOpenComplete] = useState(false);
  const [openParts, setOpenParts] = useState(false);
  const [openHold, setOpenHold] = useState(false);
  const [openPhoto, setOpenPhoto] = useState(false);
  const [openChat, setOpenChat] = useState(false);
  const [openAddJob, setOpenAddJob] = useState(false);
  const [openAi, setOpenAi] = useState(false);
  const [_openDtc, setOpenDtc] = useState(false);

  // prefill
  const [prefillCause, setPrefillCause] = useState("");
  const [prefillCorrection, setPrefillCorrection] = useState("");

  // parts used
  const [allocs, setAllocs] = useState<AllocationRow[]>([]);
  const [allocsLoading, setAllocsLoading] = useState(false);

  const showErr = (prefix: string, err?: { message?: string } | null) => {
    toast.error(`${prefix}: ${err?.message ?? "Something went wrong."}`);
    console.error(prefix, err);
  };

  const closeAllSubModals = () => {
    setOpenComplete(false);
    setOpenParts(false);
    setOpenHold(false);
    setOpenPhoto(false);
    setOpenChat(false);
    setOpenAddJob(false);
    setOpenAi(false);
    //setOpenDtc(false); // üîπ ensure DTC modal also closes
  };

  useEffect(() => {
    if (!isOpen) {
      closeAllSubModals();
    }
  }, [isOpen]);

  // initial load
  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;
    (async () => {
      setBusy(true);
      try {
        const { data: l, error: le } = await supabase
          .from("work_order_lines")
          .select("*")
          .eq("id", workOrderLineId)
          .maybeSingle<WorkOrderLine>();
        if (le) throw le;
        setLine(l ?? null);
        setTechNotes(l?.notes ?? "");

        if (l?.work_order_id) {
          const { data: wo, error: we } = await supabase
            .from("work_orders")
            .select("*")
            .eq("id", l.work_order_id)
            .maybeSingle<WorkOrder>();
          if (we) throw we;
          setWorkOrder(wo ?? null);

          if (wo?.vehicle_id) {
            const { data: v, error: ve } = await supabase
              .from("vehicles")
              .select("*")
              .eq("id", wo.vehicle_id)
              .maybeSingle<Vehicle>();
            if (ve) throw ve;
            setVehicle(v ?? null);
          } else {
            setVehicle(null);
          }

          if (wo?.customer_id) {
            const { data: c, error: ce } = await supabase
              .from("customers")
              .select("*")
              .eq("id", wo.customer_id)
              .maybeSingle<Customer>();
            if (ce) throw ce;
            setCustomer(c ?? null);
          } else {
            setCustomer(null);
          }
        }
      } catch (e) {
        const err = e as { message?: string };
        toast.error(err?.message ?? "Failed to load job");
      } finally {
        setBusy(false);
      }
    })();
  }, [isOpen, workOrderLineId, supabase]);

  // realtime line
  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;
    const ch = supabase
      .channel(`wol-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `id=eq.${workOrderLineId}`,
        },
        (payload: RealtimePostgresChangesPayload<WorkOrderLine>) => {
          const next = payload.new;
          if (next && typeof (next as Partial<WorkOrderLine>).id === "string") {
            setLine(next as WorkOrderLine);
          }
        },
      )
      .subscribe();
    return () => {
      void supabase.removeChannel(ch);
    };
  }, [isOpen, workOrderLineId, supabase]);

  const loadAllocations = useCallback(async () => {
    if (!workOrderLineId) return;
    setAllocsLoading(true);
    try {
      const { data, error } = await supabase
        .from("work_order_part_allocations")
        .select("*, parts(name)")
        .eq("work_order_line_id", workOrderLineId)
        .order("created_at", { ascending: true });
      if (error) throw error;
      setAllocs((data as AllocationRow[]) ?? []);
    } catch (e) {
      console.warn("[FocusedJob] load allocations failed", e);
    } finally {
      setAllocsLoading(false);
    }
  }, [supabase, workOrderLineId]);

  useEffect(() => {
    if (!isOpen) return;
    void loadAllocations();
  }, [isOpen, loadAllocations]);

  useEffect(() => {
    if (!isOpen || !workOrderLineId) return;

    const ch = supabase
      .channel(`wol-parts-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_part_allocations",
          filter: `work_order_line_id=eq.${workOrderLineId}`,
        },
        () => void loadAllocations(),
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        //
      }
    };
  }, [isOpen, workOrderLineId, supabase, loadAllocations]);

  const refresh = useCallback(
    async () => {
      const { data: l } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("id", workOrderLineId)
        .maybeSingle<WorkOrderLine>();
      setLine(l ?? null);
      setTechNotes(l?.notes ?? "");
      await onChanged?.();
      await loadAllocations();
    },
    [supabase, workOrderLineId, onChanged, loadAllocations],
  );

  useEffect(() => {
    const handler = () => void refresh();
    window.addEventListener("wol:refresh", handler);
    return () => window.removeEventListener("wol:refresh", handler);
  }, [refresh]);

  // parts request events
  useEffect(() => {
    const handleClose = () => setOpenParts(false);
    const handleSubmitted = async () => {
      setOpenParts(false);
      await refresh();
    };

    window.addEventListener("parts-request:close", handleClose);
    window.addEventListener("parts-request:submitted", handleSubmitted);
    return () => {
      window.removeEventListener("parts-request:close", handleClose);
      window.removeEventListener("parts-request:submitted", handleSubmitted);
    };
  }, [refresh]);

  // inspection done ‚Üí open complete
  useEffect(() => {
    const onInspectionDone = (evt: Event) => {
      const e = evt as CustomEvent<{
        workOrderLineId?: string;
        cause?: string;
        correction?: string;
      }>;
      const detail = e.detail || {};
      if (!detail.workOrderLineId) return;
      if (detail.workOrderLineId !== workOrderLineId) return;

      closeAllSubModals();
      setPrefillCause(detail.cause ?? "");
      setPrefillCorrection(detail.correction ?? "");
      setOpenComplete(true);
    };

    window.addEventListener("inspection:completed", onInspectionDone);
    return () =>
      window.removeEventListener("inspection:completed", onInspectionDone);
  }, [workOrderLineId]);

  const applyHold = async (reason: string, notes?: string) => {
    if (busy) return;
    if (!line) return;

    setBusy(true);
    try {
      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        hold_reason: reason || "On hold",
        status: "on_hold",
        // keep any existing notes unless overridden
        notes: notes ?? line.notes ?? null,
      };

      // üîπ If the job is actively running, "punch off" when putting it on hold
      if (line.punched_in_at && !line.punched_out_at) {
        update.punched_out_at = new Date().toISOString();
      }

      const { error } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", workOrderLineId);

      if (error) return showErr("Apply hold failed", error);

      toast.success("Hold applied");
      await refresh();
    } finally {
      setBusy(false);
    }
  };

  const releaseHold = async () => {
    if (busy) return;
    setBusy(true);
    try {
      const { error } = await supabase
        .from("work_order_lines")
        .update({
          hold_reason: null,
          status: "awaiting",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", workOrderLineId);
      if (error) return showErr("Remove hold failed", error);
      toast.success("Hold removed");
      await refresh();
    } finally {
      setBusy(false);
    }
  };

  const uploadPhoto = async (file: File) => {
    if (!workOrderLineId || !workOrder?.id) return;
    const path = `wo/${workOrder.id}/lines/${workOrderLineId}/${uuidv4()}_${file.name}`;
    const { error } = await supabase.storage
      .from("job-photos")
      .upload(path, file, {
        contentType: file.type || "image/jpeg",
        upsert: true,
      });
    if (error) return showErr("Photo upload failed", error);
    toast.success("Photo attached");
  };

  const saveNotes = async () => {
    setSavingNotes(true);
    const { error } = await supabase
      .from("work_order_lines")
      .update({
        notes: techNotes,
      } as DB["public"]["Tables"]["work_order_lines"]["Update"])
      .eq("id", workOrderLineId);
    setSavingNotes(false);
    if (error) return showErr("Update notes failed", error);
    toast.success("Notes saved");
    await refresh();
  };

  const startAt = line?.punched_in_at ?? null;
  const finishAt = line?.punched_out_at ?? null;

  const titleText =
    `${line?.line_no ? `#${line.line_no} ` : ""}` +
    (line?.description || line?.complaint || "Focused Job") +
    (line?.job_type ? ` ‚Äî ${String(line.job_type).replaceAll("_", " ")}` : "");

  const createdStart = startAt ? format(new Date(startAt), "PPpp") : "‚Äî";
  const createdFinish = finishAt ? format(new Date(finishAt), "PPpp") : "‚Äî";

  return (
    <>
      <Dialog
        open={isOpen}
        onClose={() => {
          closeAllSubModals();
          onClose();
        }}
        className="fixed inset-0 z-[100] flex items-center justify-center"
      >
        {/* backdrop */}
        <div
          className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm"
          aria-hidden="true"
        />

        {/* panel wrapper */}
        <div
          className="relative z-[110] mx-4 my-6 w-full max-w-5xl"
          onClick={(e) => e.stopPropagation()}
        >
          {/* üîπ Outer panel: only scroll when AI is *not* open */}
          <div
            className={`rounded-lg border border-white/15 bg-neutral-950/95 p-5 text-foreground shadow-xl ${
              openAi ? "" : "max-h-[75vh] overflow-y-auto"
            }`}
          >
            {/* header */}
            <div className="mb-3 flex items-start justify-between gap-3">
              <div className="text-lg font-semibold tracking-tight">
                <span className={chip(line?.status ?? null)}>{titleText}</span>
                {workOrder ? (
                  <span className="ml-2 text-xs font-normal text-neutral-400">
                    WO #{workOrder.custom_id || workOrder.id?.slice(0, 8)}
                  </span>
                ) : null}
                {line?.status === "awaiting_approval" && (
                  <span className="ml-2 rounded border border-blue-500/80 px-2 py-0.5 text-[0.65rem] text-blue-100">
                    Awaiting approval
                  </span>
                )}
                {line?.status === "declined" && (
                  <span className="ml-2 rounded border border-red-500/80 px-2 py-0.5 text-[0.65rem] text-red-100">
                    Declined
                  </span>
                )}
              </div>

              <div className="flex items-center gap-2">
                {workOrder?.id && (
                  <button
                    type="button"
                    className="rounded-md border border-[var(--accent-copper-light)] bg-[var(--accent-copper-soft)] px-3 py-1.5 text-xs font-semibold text-black shadow-[0_0_12px_rgba(248,113,22,0.35)] hover:bg-[var(--accent-copper-light)]"
                    onClick={() => {
                      closeAllSubModals();
                      setOpenAddJob(true);
                    }}
                    disabled={busy}
                  >
                    + Job
                  </button>
                )}
                <button
                  type="button"
                  onClick={() => {
                    closeAllSubModals();
                    onClose();
                  }}
                  className="rounded-md border border-white/15 bg-black/40 px-2 py-1 text-xs text-neutral-200 hover:bg-white/5"
                  title="Close"
                >
                  ‚úï
                </button>
              </div>
            </div>

            {/* body */}
            {busy && !line ? (
              <div className="grid gap-3">
                <div className="h-6 w-40 animate-pulse rounded-full bg-white/5" />
                <div className="h-24 animate-pulse rounded-2xl bg-white/5" />
              </div>
            ) : !line ? (
              <div className="text-sm text-neutral-300">No job found.</div>
            ) : (
              <div className="space-y-4">
                {/* meta info */}
                <div className="grid gap-2 sm:grid-cols-2">
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Status
                    </div>
                    <div
                      className={`mt-1 text-sm font-semibold ${chip(
                        line.status ?? null,
                      )}`}
                    >
                      {String(line.status || "awaiting").replaceAll("_", " ")}
                    </div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Start
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {createdStart}
                    </div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Finish
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {createdFinish}
                    </div>
                  </div>
                  <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Hold Reason
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {line.hold_reason ?? "‚Äî"}
                    </div>
                  </div>
                </div>

                {/* vehicle & customer */}
                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3 text-sm">
                  <div className="grid gap-3 sm:grid-cols-2">
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Vehicle
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {vehicle
                          ? `${vehicle.year ?? ""} ${
                              vehicle.make ?? ""
                            } ${vehicle.model ?? ""}`
                              .trim()
                              .replace(/\s+/g, " ") || "‚Äî"
                          : "‚Äî"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        VIN: {vehicle?.vin ?? "‚Äî"} ‚Ä¢ Plate:{" "}
                        {vehicle?.license_plate ?? "‚Äî"}
                      </div>
                    </div>
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Customer
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {customer
                          ? [customer.first_name ?? "", customer.last_name ?? ""]
                              .filter(Boolean)
                              .join(" ") || "‚Äî"
                          : "‚Äî"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        {customer?.phone ?? "‚Äî"}{" "}
                        {customer?.email ? `‚Ä¢ ${customer.email}` : ""}
                      </div>
                    </div>
                  </div>
                </div>

                {/* punch ‚Äì hidden once job is completed, same as mobile */}
                {mode === "tech" && line && line.status !== "completed" && (
                  <div className="glass-card relative z-[5] rounded-2xl border border-white/10 bg-black/40 p-3">
                    <JobPunchButton
                      lineId={line.id}
                      punchedInAt={line.punched_in_at}
                      punchedOutAt={line.punched_out_at}
                      status={line.status as WorkflowStatus}
                      onFinishRequested={() => {
                        closeAllSubModals();
                        setPrefillCause(line.cause ?? "");
                        setPrefillCorrection(line.correction ?? "");
                        setOpenComplete(true);
                      }}
                      onUpdated={refresh}
                      disabled={
                        busy ||
                        line.status === "awaiting_approval" ||
                        line.status === "declined" ||
                        (!!line.approval_state &&
                          line.approval_state !== "approved")
                      }
                    />
                    {(line.status === "awaiting_approval" ||
                      (line.approval_state &&
                        line.approval_state !== "approved") ||
                      line.status === "declined") && (
                      <div className="mt-2 text-[11px] text-amber-300">
                        {line.status === "awaiting_approval"
                          ? "Awaiting approval ‚Äî punching disabled"
                          : line.status === "declined"
                            ? "Declined ‚Äî punching disabled"
                            : "Not approved ‚Äî punching disabled"}
                      </div>
                    )}
                  </div>
                )}

                {/* controls */}
                <div className="grid gap-2 sm:grid-cols-2 lg:grid-cols-3">
                  {mode === "tech" ? (
                    <>
                      <button
                        type="button"
                        className={btnAccent}
                        onClick={() => {
                          closeAllSubModals();
                          setPrefillCause(line?.cause ?? "");
                          setPrefillCorrection(line?.correction ?? "");
                          setOpenComplete(true);
                        }}
                        disabled={busy}
                      >
                        Complete (Cause / Correction)
                      </button>

                      <button
                        type="button"
                        className={btnDanger}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenParts(true);
                        }}
                        disabled={busy}
                      >
                        Request Parts
                      </button>

                      <button
                        type="button"
                        className={btnWarn}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenHold(true);
                        }}
                        disabled={busy}
                      >
                        {line.status === "on_hold" ? "On Hold" : "Hold"}
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenPhoto(true);
                        }}
                        disabled={busy}
                      >
                        Add Photo
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>

                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>

                      {/* üîπ DTC Assist button lives with the other controls */}
                      {/*
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenDtc(true);
                        }}
                        disabled={busy}
                      >
                        DTC Assist (AI)
                      </button>
                      */}
                    </>
                  ) : (
                    <>
                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenDtc(true);
                        }}
                        disabled={busy}
                      >
                        DTC Assist (AI)
                      </button>
                    </>
                  )}
                </div>

                {/* parts used */}
                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <div className="mb-2 text-sm font-medium text-neutral-100">
                    Parts used
                  </div>

                  {allocsLoading ? (
                    <div className="text-sm text-neutral-300">Loading‚Ä¶</div>
                  ) : allocs.length === 0 ? (
                    <div className="text-sm text-neutral-300">
                      No parts used yet.
                    </div>
                  ) : (
                    <div className="overflow-hidden rounded-xl border border-white/10 bg-black/40">
                      <div className="grid grid-cols-12 bg-white/5 px-3 py-2 text-[11px] uppercase tracking-[0.16em] text-neutral-400">
                        <div className="col-span-7">Part</div>
                        <div className="col-span-3">Location</div>
                        <div className="col-span-2 text-right">Qty</div>
                      </div>
                      <ul className="max-h-56 overflow-auto divide-y divide-white/5">
                        {allocs.map((a) => (
                          <li
                            key={a.id}
                            className="grid grid-cols-12 items-center px-3 py-2 text-sm"
                          >
                            <div className="col-span-7 truncate text-neutral-100">
                              {a.parts?.name ?? "Part"}
                            </div>
                            <div className="col-span-3 truncate text-neutral-400">
                              {a.location_id
                                ? `loc ${String(a.location_id).slice(0, 6)}‚Ä¶`
                                : "‚Äî"}
                            </div>
                            <div className="col-span-2 text-right font-semibold text-neutral-100">
                              {a.qty}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                {/* tech notes */}
                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <label className="mb-1 block text-sm font-medium text-neutral-100">
                    Tech Notes
                  </label>
                  <textarea
                    rows={4}
                    value={techNotes}
                    onChange={(e) => setTechNotes(e.target.value)}
                    onBlur={saveNotes}
                    disabled={savingNotes}
                    className="w-full rounded-md border border-white/15 bg-black/40 px-3 py-2 text-sm text-white placeholder:text-neutral-400 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
                    placeholder="Add notes for this job‚Ä¶"
                  />
                </div>

                {/* AI suggestions */}
                <div className="glass-card rounded-2xl border border-white/10 bg-black/40 p-3">
                  <h3 className="mb-2 text-sm font-medium text-neutral-100">
                    AI Suggested Repairs
                  </h3>
                  {line && workOrder ? (
                    <SuggestedQuickAdd
                      jobId={line.id}
                      workOrderId={workOrder.id}
                      vehicleId={vehicle?.id ?? null}
                      onAdded={async () => {
                        toast.success("Suggested line added");
                        await refresh();
                      }}
                    />
                  ) : (
                    <div className="text-sm text-neutral-300">
                      Vehicle/work order details required.
                    </div>
                  )}
                </div>

                <div className="text-xs text-neutral-400">
                  Job ID: {line.id}
                  {typeof line.labor_time === "number"
                    ? ` ‚Ä¢ Labor: ${line.labor_time.toFixed(1)}h`
                    : ""}
                  {line.hold_reason ? ` ‚Ä¢ Hold: ${line.hold_reason}` : ""}
                  {line.approval_state
                    ? ` ‚Ä¢ Approval: ${line.approval_state}`
                    : ""}
                </div>
              </div>
            )}
          </div>
        </div>
      </Dialog>

      {/* sub-modals */}
      {openComplete && line && (
        <CauseCorrectionModal
          isOpen={openComplete}
          onClose={() => setOpenComplete(false)}
          jobId={line.id}
          initialCause={prefillCause}
          initialCorrection={prefillCorrection}
          // ‚úÖ COMPLETE job ‚Äì sets status + punched_out_at
          onSubmit={async (cause: string, correction: string) => {
            const { error } = await supabase
              .from("work_order_lines")
              .update({
                cause,
                correction,
                punched_out_at: new Date().toISOString(),
                status: "completed",
              } as DB["public"]["Tables"]["work_order_lines"]["Update"])
              .eq("id", line.id);

            if (error) return showErr("Complete job failed", error);
            toast.success("Job completed");
            setOpenComplete(false);
            await refresh();
          }}
          // ‚úÖ SAVE STORY ONLY ‚Äì no status change, no finish
          onSaveDraft={async (cause: string, correction: string) => {
            const { error } = await supabase
              .from("work_order_lines")
              .update({
                cause,
                correction,
              } as DB["public"]["Tables"]["work_order_lines"]["Update"])
              .eq("id", line.id);

            if (error) return showErr("Save story failed", error);
            toast.success("Story saved");
            await refresh();
            // modal stays open so tech can keep editing or complete later
          }}
        />
      )}

      {openParts && workOrder?.id && line && (
        <PartsRequestModal
          isOpen={openParts}
          workOrderId={workOrder.id}
          jobId={line.id}
          requestNote={line.description ?? ""}
        />
      )}

      {openHold && line && (
        <HoldModal
          isOpen={openHold}
          onClose={() => setOpenHold(false)}
          onApply={applyHold}
          onRelease={line.hold_reason ? releaseHold : undefined}
          canRelease={!!line.hold_reason}
          defaultReason={line.hold_reason || "Awaiting parts"}
        />
      )}

      {openPhoto && (
        <PhotoCaptureModal
          isOpen={openPhoto}
          onClose={() => setOpenPhoto(false)}
          onCapture={uploadPhoto}
        />
      )}

      {openChat && (
        <NewChatModal
          isOpen={openChat}
          onClose={() => setOpenChat(false)}
          created_by="system"
          onCreated={() => setOpenChat(false)}
          context_type="work_order_line"
          context_id={line?.id ?? null}
        />
      )}

      {openAi && (
        <AIAssistantModal
          isOpen={openAi}
          onClose={() => setOpenAi(false)}
          workOrderLineId={line?.id ?? undefined}
          defaultVehicle={
            vehicle
              ? {
                  year: vehicle.year ? String(vehicle.year) : undefined,
                  make: vehicle.make ?? undefined,
                  model: vehicle.model ?? undefined,
                }
              : undefined
          }
        />
      )}

      {/* DTC Suggest modal disabled for now
      {openDtc && line && (
        <DtcSuggestionModal
          isOpen={openDtc}
          onClose={() => setOpenDtc(false)}
          jobId={line.id}
          vehicle={
            vehicle
              ? {
                  year: vehicle.year ? String(vehicle.year) : "",
                  make: vehicle.make ?? "",
                  model: vehicle.model ?? "",
                }
              : {
                  year: "",
                  make: "",
                  model: "",
                }
          }
        />
      )}
        */}

      {openAddJob && workOrder?.id && (
        <AddJobModal
          isOpen={openAddJob}
          onClose={() => setOpenAddJob(false)}
          workOrderId={workOrder.id}
          vehicleId={vehicle?.id ?? null}
          techId={line?.assigned_to || "system"}
          shopId={workOrder?.shop_id ?? null}
          onJobAdded={async () => {
            await refresh();
            setOpenAddJob(false);
          }}
        />
      )}
    </>
  );
}

========================================
FILE: features/work-orders/components/workorders/HoldModal.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import ModalShell from "@/features/shared/components/ModalShell";

const HOLD_REASONS = [
  "Awaiting customer authorization",
  "Awaiting parts",
  "Need additional info",
  "Hold for assistance",
  "Foreman hold",
  "Lead hand hold",
] as const;

type HoldReason = (typeof HOLD_REASONS)[number];

interface HoldModalProps {
  isOpen: boolean;
  onClose: () => void;
  onApply: (
    reason: string,
    notes?: string,
    holdUntil?: string | null,
  ) => Promise<void> | void;
  onRelease?: () => Promise<void> | void;
  canRelease?: boolean;
  defaultReason?: string;
  defaultNotes?: string;
  defaultHoldUntil?: string | null;
}

export default function HoldModal({
  isOpen,
  onClose,
  onApply,
  onRelease,
  canRelease = false,
  defaultReason = "Awaiting parts",
  defaultNotes = "",
  defaultHoldUntil = null,
}: HoldModalProps) {
  const [reason, setReason] = useState<string>(defaultReason);
  const [notes, setNotes] = useState<string>(defaultNotes);

  const [autoRelease, setAutoRelease] = useState<boolean>(false);
  const [releaseAfterMinutes, setReleaseAfterMinutes] = useState<number>(60);
  const [releaseAt, setReleaseAt] = useState<string>("");

  const [holdPlacedAt, setHoldPlacedAt] = useState<string>("");

  useEffect(() => {
    if (!isOpen) return;

    setReason(defaultReason);
    setNotes(defaultNotes);
    setHoldPlacedAt(new Date().toLocaleString());

    if (defaultHoldUntil) {
      setAutoRelease(true);
      const dt = new Date(defaultHoldUntil);
      if (!Number.isNaN(dt.getTime())) {
        setReleaseAt(toLocalDatetime(dt));
      } else {
        setReleaseAt("");
      }
    } else {
      setAutoRelease(false);
      setReleaseAfterMinutes(60);
      setReleaseAt("");
    }
  }, [isOpen, defaultReason, defaultNotes, defaultHoldUntil]);

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={onClose}
      title="PLACE / UPDATE HOLD"
      size="sm"
      footerLeft={
        canRelease ? (
          <button
            type="button"
            className="inline-flex items-center gap-1 rounded-full border border-red-500/80 bg-red-500/10 px-3 py-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-red-100 hover:bg-red-500/20"
            onClick={() => Promise.resolve(onRelease?.()).then(onClose)}
          >
            <span>‚óè</span>
            <span>Release hold</span>
          </button>
        ) : null
      }
      onSubmit={async () => {
        let holdUntil: string | null = null;

        if (autoRelease) {
          if (releaseAt) {
            const d = new Date(releaseAt);
            if (!Number.isNaN(d.getTime())) {
              holdUntil = d.toISOString();
            }
          } else if (releaseAfterMinutes > 0) {
            const d = new Date();
            d.setMinutes(d.getMinutes() + releaseAfterMinutes);
            holdUntil = d.toISOString();
          }
        }

        await onApply(reason, notes, holdUntil);
        onClose();
      }}
      submitText="Apply Hold"
    >
      <div className="space-y-4">
        <p className="text-[0.8rem] text-neutral-300">
          Park this job with a clear reason so advisors and techs know why it&apos;s
          on hold.
        </p>

        {/* Reason */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-400">
            Reason
          </label>
          <div className="relative">
            <select
              className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/70 px-3 py-2 text-sm text-neutral-100 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            >
              {HOLD_REASONS.map((r) => (
                <option key={r} value={r}>
                  {r}
                </option>
              ))}
              {!HOLD_REASONS.includes(reason as HoldReason) && (
                <option value={reason}>{reason}</option>
              )}
            </select>
            <div className="pointer-events-none absolute inset-y-0 right-3 flex items-center text-xs text-neutral-500">
              ‚ñº
            </div>
          </div>
        </div>

        {/* Notes */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-400">
            Notes
          </label>
          <textarea
            rows={3}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/70 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={notes}
            onChange={(e) => setNotes(e.target.value)}
            placeholder="Optional notes for this hold‚Ä¶"
          />
        </div>

        {/* Auto-release card */}
        <div className="rounded-xl border border-[var(--metal-border-soft)] bg-black/50 px-3 py-3 shadow-[0_12px_30px_rgba(0,0,0,0.75)]">
          <div className="mb-2 flex items-center justify-between text-[0.7rem] text-neutral-400">
            <span>
              Hold placed at:{" "}
              <span className="text-neutral-100">{holdPlacedAt || "‚Äî"}</span>
            </span>
          </div>

          <label className="inline-flex items-center gap-2 text-[0.7rem] text-neutral-100">
            <input
              type="checkbox"
              checked={autoRelease}
              onChange={(e) => setAutoRelease(e.target.checked)}
              className="h-4 w-4 rounded border-[var(--metal-border-soft)] bg-black text-[var(--accent-copper-soft)] focus:ring-[var(--accent-copper-soft)]"
            />
            Auto-release this hold
          </label>

          {autoRelease && (
            <div className="mt-3 space-y-3 text-[0.75rem]">
              <div className="flex flex-wrap items-center gap-2">
                <label className="text-neutral-400">
                  After (minutes)
                </label>
                <input
                  type="number"
                  min={5}
                  step={5}
                  value={releaseAfterMinutes}
                  onChange={(e) =>
                    setReleaseAfterMinutes(Number(e.target.value) || 0)
                  }
                  className="w-24 rounded-md border border-[var(--metal-border-soft)] bg-black/70 px-2 py-1 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/70"
                  disabled={releaseAt !== ""}
                />
                <span className="text-[0.65rem] text-neutral-500">
                  Leave empty if using a specific date/time.
                </span>
              </div>

              <div>
                <label className="mb-1 block text-[0.7rem] text-neutral-400">
                  Or release at date / time
                </label>
                <input
                  type="datetime-local"
                  value={releaseAt}
                  onChange={(e) => setReleaseAt(e.target.value)}
                  className="w-full rounded-md border border-[var(--metal-border-soft)] bg-black/70 px-2 py-1 text-sm text-neutral-100 outline-none focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/70"
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </ModalShell>
  );
}

function toLocalDatetime(d: Date): string {
  const pad = (n: number) => n.toString().padStart(2, "0");
  const year = d.getFullYear();
  const month = pad(d.getMonth() + 1);
  const day = pad(d.getDate());
  const hour = pad(d.getHours());
  const minute = pad(d.getMinutes());
  return `${year}-${month}-${day}T${hour}:${minute}`;
}

========================================
FILE: features/work-orders/components/workorders/PartsRequestModal.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import { toast } from "sonner";
import ModalShell from "@/features/shared/components/ModalShell";

type Item = { id: string; description: string; qty: number };

type Props = {
  isOpen: boolean;
  workOrderId: string;
  jobId: string;
  requestNote?: string | null;
  closeEventName?: string;
  submittedEventName?: string;
};

type SubmittedDetail = {
  requestId: string;
  workOrderId: string;
  jobId: string;
};

export default function PartsRequestModal({
  isOpen,
  workOrderId,
  jobId,
  requestNote = "",
  closeEventName = "parts-request:close",
  submittedEventName = "parts-request:submitted",
}: Props) {
  const [headerNotes, setHeaderNotes] = useState(requestNote ?? "");
  const [rows, setRows] = useState<Item[]>([
    { id: crypto.randomUUID(), description: "", qty: 1 },
  ]);
  const [submitting, setSubmitting] = useState(false);

  useEffect(() => {
    if (!isOpen) return;
    setHeaderNotes(requestNote ?? "");
    setRows([{ id: crypto.randomUUID(), description: "", qty: 1 }]);
  }, [isOpen, requestNote]);

  const addRow = () =>
    setRows((r) => [...r, { id: crypto.randomUUID(), description: "", qty: 1 }]);

  const removeRow = (id: string) =>
    setRows((r) => (r.length > 1 ? r.filter((x) => x.id !== id) : r));

  const setCell = (id: string, patch: Partial<Item>) =>
    setRows((r) => r.map((x) => (x.id === id ? { ...x, ...patch } : x)));

  const validItems = rows
    .map((r) => ({
      description: r.description.trim(),
      qty: Number(r.qty) || 1,
    }))
    .filter((i) => i.description && i.qty > 0);

  const emit = (name: string, detail?: unknown) => {
    if (typeof window !== "undefined") {
      window.dispatchEvent(new CustomEvent(name, detail ? { detail } : undefined));
    }
  };

  async function submit() {
    if (submitting) return;

    if (!workOrderId || !jobId) {
      toast.error("Missing work order or job id.");
      return;
    }

    if (validItems.length === 0) {
      toast.error("Add at least one line.");
      return;
    }

    setSubmitting(true);

    try {
      const res = await fetch("/api/parts/requests/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          jobId,
          notes: headerNotes || undefined,
          items: validItems,
        }),
      });

      const raw = await res.text();
      let json: { requestId?: string; error?: string } | null = null;
      try {
        json = raw ? (JSON.parse(raw) as { requestId?: string; error?: string }) : null;
      } catch {
        /* ignore */
      }

      if (!res.ok || !json?.requestId) {
        const msg = json?.error || raw || `Request failed with status ${res.status}`;
        toast.error(`Parts request failed: ${msg}`);
        return;
      }

      toast.success("Parts request sent.");

      const detail: SubmittedDetail = {
        requestId: json.requestId,
        workOrderId,
        jobId,
      };

      emit(submittedEventName, detail);
      emit(closeEventName);
    } catch (err) {
      toast.error(err instanceof Error ? err.message : "Unable to submit request");
    } finally {
      setSubmitting(false);
    }
  }

  if (!isOpen) return null;

  return (
    <ModalShell
      isOpen={isOpen}
      onClose={() => emit(closeEventName)}
      title="REQUEST PARTS"
      size="lg"
      onSubmit={submit}
      submitText={submitting ? "Submitting‚Ä¶" : "Submit to Parts"}
    >
      <div className="space-y-4">
        {/* Header meta */}
        <div className="flex flex-col gap-1 text-[0.7rem] text-neutral-400 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex flex-wrap items-center gap-2">
            <span className="font-semibold uppercase tracking-[0.18em] text-neutral-300">
              Work order
            </span>
            <span className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 font-mono text-[0.7rem] text-neutral-100">
              {workOrderId}
            </span>
          </div>
          <div className="flex flex-wrap items-center gap-2">
            <span className="font-semibold uppercase tracking-[0.18em] text-neutral-300">
              Job
            </span>
            <span className="rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 font-mono text-[0.7rem] text-neutral-100">
              {jobId}
            </span>
          </div>
        </div>

        {/* Note to parts */}
        <div className="space-y-1">
          <label className="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-neutral-300">
            Note to parts (optional)
          </label>
          <textarea
            rows={2}
            className="w-full rounded-lg border border-[var(--metal-border-soft)] bg-black/75 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-2 focus:ring-[var(--accent-copper-soft)]/60"
            value={headerNotes}
            onChange={(e) => setHeaderNotes(e.target.value)}
            placeholder="Anything they should know before filling this request‚Ä¶"
          />
        </div>

        {/* Items grid */}
        <div className="overflow-hidden rounded-2xl border border-[var(--metal-border-soft)] bg-black/60 shadow-[0_18px_40px_rgba(0,0,0,0.85)]">
          {/* Header row */}
          <div className="grid grid-cols-12 bg-gradient-to-r from-slate-900/90 via-slate-950 to-black px-3 py-2 text-[0.7rem] uppercase tracking-[0.16em] text-neutral-400">
            <div className="col-span-8">Description*</div>
            <div className="col-span-3 text-right">Qty*</div>
            <div className="col-span-1 text-center"> </div>
          </div>

          {/* Rows */}
          <div className="max-h-64 overflow-auto bg-black/70">
            {rows.map((r) => (
              <div
                key={r.id}
                className="grid grid-cols-12 gap-2 border-t border-white/5 px-3 py-2"
              >
                <input
                  className="col-span-8 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.description}
                  onChange={(e) => setCell(r.id, { description: e.target.value })}
                  placeholder="e.g. rear pads, serp belt‚Ä¶"
                />
                <input
                  type="number"
                  min={1}
                  step={1}
                  className="col-span-3 rounded-md border border-[var(--metal-border-soft)] bg-black/80 px-2 py-1 text-right text-sm text-neutral-100 outline-none transition focus:border-[var(--accent-copper-soft)] focus:ring-1 focus:ring-[var(--accent-copper-soft)]/60"
                  value={r.qty}
                  onChange={(e) =>
                    setCell(r.id, { qty: Math.max(1, Number(e.target.value) || 1) })
                  }
                />
                <div className="col-span-1 flex items-center justify-center">
                  <button
                    className="inline-flex h-7 w-7 items-center justify-center rounded-full border border-[var(--metal-border-soft)] bg-black/70 text-[0.7rem] text-neutral-300 transition hover:bg-red-500/20 hover:text-red-200 disabled:opacity-40 disabled:hover:bg-black/70 disabled:hover:text-neutral-300"
                    onClick={() => removeRow(r.id)}
                    disabled={rows.length <= 1}
                    title={rows.length <= 1 ? "At least one row is required" : "Remove row"}
                    type="button"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Add row footer */}
          <div className="border-t border-white/5 bg-black/80 px-3 py-2">
            <button
              className="inline-flex items-center gap-1 rounded-full border border-[var(--metal-border-soft)] bg-black/70 px-3 py-1 text-[0.7rem] font-medium uppercase tracking-[0.16em] text-neutral-100 transition hover:border-[var(--accent-copper-soft)] hover:bg-[var(--accent-copper-faint)] hover:text-[var(--accent-copper-soft)]"
              onClick={addRow}
              type="button"
            >
              <span>+</span>
              <span>Add item</span>
            </button>
          </div>
        </div>

        <p className="text-[0.7rem] text-neutral-500">
          Only lines with a description and quantity &gt; 0 will be sent.
        </p>
      </div>
    </ModalShell>
  );
}

========================================
FILE: features/work-orders/components/WorkOrderSuggestionsPanel.tsx
========================================
"use client";

import { useCallback, useEffect, useMemo, useState } from "react";
import { toast } from "sonner";

type JobType = "diagnosis" | "repair" | "maintenance" | "tech-suggested";

type RawSuggestion = any;

type Suggestion = {
  serviceCode: string | null;
  label: string;
  jobType: JobType;
  laborHours: number | null;
  notes: string;
  isCritical: boolean;
  distanceKmNormal: number | null;
  timeMonthsNormal: number | null;
};

type Props = {
  workOrderId: string;
  vehicleId: string | null;
  odometerKm: number | null;
  onAdded?: () => void | Promise<void>;
};

function normalizeSuggestions(input: unknown): Suggestion[] {
  if (!Array.isArray(input)) return [];

  const validJobTypes: JobType[] = [
    "diagnosis",
    "repair",
    "maintenance",
    "tech-suggested",
  ];

  return input.map((raw: RawSuggestion): Suggestion => {
    const serviceCodeRaw =
      typeof raw?.serviceCode === "string" && raw.serviceCode.trim()
        ? raw.serviceCode.trim().toUpperCase()
        : null;

    const labelRaw =
      typeof raw?.label === "string" && raw.label.trim()
        ? raw.label.trim()
        : typeof raw?.name === "string" && raw.name.trim()
        ? raw.name.trim()
        : "Maintenance item";

    const jobTypeRaw =
      typeof raw?.jobType === "string" ? raw.jobType.trim().toLowerCase() : "";
    const jobType: JobType = validJobTypes.includes(jobTypeRaw as JobType)
      ? (jobTypeRaw as JobType)
      : "maintenance";

    const hoursRaw =
      typeof raw?.default_labor_hours === "number"
        ? raw.default_labor_hours
        : typeof raw?.laborHours === "number"
        ? raw.laborHours
        : typeof raw?.typicalHours === "number"
        ? raw.typicalHours
        : null;

    const notesRaw =
      typeof raw?.default_notes === "string"
        ? raw.default_notes
        : typeof raw?.notes === "string"
        ? raw.notes
        : "";

    const isCritical =
      typeof raw?.is_critical === "boolean"
        ? raw.is_critical
        : typeof raw?.isCritical === "boolean"
        ? raw.isCritical
        : false;

    const numOrNull = (v: unknown): number | null =>
      typeof v === "number" && Number.isFinite(v) ? v : null;

    return {
      serviceCode: serviceCodeRaw,
      label: labelRaw,
      jobType,
      laborHours: numOrNull(hoursRaw),
      notes: notesRaw,
      isCritical,
      distanceKmNormal: numOrNull(
        raw?.distance_km_normal ?? raw?.distanceKmNormal,
      ),
      timeMonthsNormal: numOrNull(
        raw?.time_months_normal ?? raw?.timeMonthsNormal,
      ),
    };
  });
}

export function WorkOrderSuggestionsPanel({
  workOrderId,
  vehicleId,
  odometerKm,
  onAdded,
}: Props) {
  const [loading, setLoading] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [items, setItems] = useState<Suggestion[]>([]);
  const [addingKey, setAddingKey] = useState<string | null>(null);

  const effectiveOdo = useMemo(() => {
    if (typeof odometerKm === "number" && Number.isFinite(odometerKm)) {
      return odometerKm;
    }
    return null;
  }, [odometerKm]);

  const fetchSuggestions = useCallback(
    async (opts?: { isRefresh?: boolean }) => {
      const isRefresh = opts?.isRefresh ?? false;
      if (!workOrderId) return;

      if (isRefresh) {
        setRefreshing(true);
      } else {
        setLoading(true);
      }
      setError(null);

      try {
        const res = await fetch("/api/maintenance/suggestions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ workOrderId }),
        });

        const json = await res.json().catch(() => ({} as any));

        if (!res.ok) {
          throw new Error(json?.error || "Failed to load suggestions");
        }

        const suggestions = normalizeSuggestions(json?.suggestions);
        setItems(suggestions);
      } catch (e) {
        const msg =
          e instanceof Error ? e.message : "Failed to load suggestions";
        setError(msg);
        setItems([]);
      } finally {
        setLoading(false);
        setRefreshing(false);
      }
    },
    [workOrderId],
  );

  useEffect(() => {
    if (workOrderId) {
      void fetchSuggestions();
    }
  }, [workOrderId, fetchSuggestions]);

  // üîÅ now uses add-suggested-lines, which can also fan out to parts
  async function addSuggestedJob(s: Suggestion) {
    if (!workOrderId) return;

    const key = s.serviceCode || s.label;
    setAddingKey(key);

    try {
      const res = await fetch("/api/work-orders/add-suggested-lines", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          workOrderId,
          vehicleId: vehicleId ?? null,
          odometerKm: effectiveOdo ?? null,
          items: [
            {
              description: s.label,
              serviceCode: s.serviceCode ?? undefined,
              jobType: s.jobType,
              laborHours: s.laborHours ?? null,
              notes: s.notes || undefined,
              // aiComplaint / aiCause / aiCorrection not used for these
            },
          ],
        }),
      });

      const json = await res.json().catch(() => ({} as any));

      if (!res.ok || json?.error) {
        throw new Error(json?.error || "Failed to add maintenance job");
      }

      // Your add-suggested-lines route is responsible for:
      // - creating work_order_lines
      // - marking them as awaiting parts / on_hold
      // - creating part_requests (if you wired that in there)
      toast.success("Maintenance job added and queued for parts quote");
      await onAdded?.();
    } catch (e) {
      const msg =
        e instanceof Error ? e.message : "Failed to add maintenance job";
      toast.error(msg);
    } finally {
      setAddingKey(null);
    }
  }

  const hasItems = items.length > 0;

  return (
    <div className="rounded-xl border border-border bg-card/95 p-4 text-sm text-neutral-200">
      <div className="mb-2 flex items-center justify-between gap-2">
        <div>
          <h2 className="text-sm font-semibold text-orange-300">
            Maintenance suggestions
          </h2>
          <p className="text-[11px] text-neutral-500">
            Based on this vehicle&apos;s profile and mileage, add items as jobs
            and send them for parts quoting.
          </p>
        </div>
        <button
          type="button"
          onClick={() => fetchSuggestions({ isRefresh: true })}
          disabled={loading || refreshing}
          className="rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1 text-[11px] text-neutral-200 hover:bg-neutral-800 disabled:opacity-60"
        >
          {refreshing ? "Refreshing‚Ä¶" : "Refresh"}
        </button>
      </div>

      {effectiveOdo !== null && (
        <div className="mb-2 text-[11px] text-neutral-400">
          Odometer:&nbsp;
          <span className="font-mono text-neutral-200">
            {effectiveOdo.toLocaleString()} km
          </span>
        </div>
      )}

      {loading && !hasItems && !error && (
        <div className="mt-2 text-xs text-neutral-400">Loading‚Ä¶</div>
      )}

      {error && (
        <div className="mt-2 rounded border border-red-500/40 bg-red-950/60 p-2 text-xs text-red-200">
          {error}
        </div>
      )}

      {!loading && !error && !hasItems && (
        <div className="mt-2 text-xs text-neutral-400">
          No maintenance suggestions recorded for this work order yet.
        </div>
      )}

      {hasItems && (
        <div className="mt-3 space-y-2">
          {items.map((s) => {
            const key = s.serviceCode || s.label;
            const dueBits: string[] = [];

            if (s.distanceKmNormal != null) {
              dueBits.push(`${s.distanceKmNormal.toLocaleString()} km`);
            }
            if (s.timeMonthsNormal != null) {
              dueBits.push(`${s.timeMonthsNormal} months`);
            }

            return (
              <div
                key={key}
                className="rounded-lg border border-neutral-800 bg-neutral-950/80 p-3"
              >
                <div className="flex items-start justify-between gap-3">
                  <div className="min-w-0">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="truncate font-medium text-neutral-50">
                        {s.label}
                      </div>
                      {s.serviceCode && (
                        <span className="rounded-full border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-[10px] font-mono uppercase tracking-wide text-neutral-300">
                          {s.serviceCode}
                        </span>
                      )}
                      {s.isCritical && (
                        <span className="rounded-full border border-red-700/70 bg-red-900/40 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-red-200">
                          Critical
                        </span>
                      )}
                    </div>
                    <div className="mt-0.5 text-[11px] text-neutral-400">
                      {s.jobType} ‚Ä¢{" "}
                      {typeof s.laborHours === "number"
                        ? `${s.laborHours.toFixed(1)}h`
                        : "Labor TBD"}
                      {dueBits.length > 0 && (
                        <> ‚Ä¢ Due around: {dueBits.join(" or ")}</>
                      )}
                    </div>
                    {s.notes && (
                      <div className="mt-1 text-[11px] text-neutral-400">
                        {s.notes}
                      </div>
                    )}
                  </div>
                  <div className="flex shrink-0 flex-col items-end gap-1">
                    <button
                      type="button"
                      onClick={() => void addSuggestedJob(s)}
                      disabled={addingKey === key}
                      className="rounded-md border border-blue-600 px-3 py-1 text-[11px] font-medium text-blue-200 hover:bg-blue-900/25 disabled:opacity-60"
                    >
                      {addingKey === key ? "Adding‚Ä¶" : "Add & send to parts"}
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

========================================
FILE: features/work-orders/hooks/useWorkOrderActions.ts
========================================
// features/work-orders/hooks/useWorkOrderActions.ts
"use client";

import { useCallback } from "react";
import { toast } from "sonner";
import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];

type UseWorkOrderActionsArgs = {
  approvalPending: WorkOrderLine[];
  setPartsLineId: (id: string | null) => void;
  setBulkQueue: (ids: string[]) => void;
  setBulkActive: (active: boolean) => void;
};

export function useWorkOrderActions({
  approvalPending,
  setPartsLineId,
  setBulkQueue,
  setBulkActive,
}: UseWorkOrderActionsArgs) {
  /**
   * Send a single line to parts for quoting.
   */
  const sendToParts = useCallback(
    async (lineId: string) => {
      if (!lineId) return;

      const { error } = await supabase
        .from("work_order_lines")
        .update({
          status: "on_hold",
          hold_reason: "Awaiting parts quote",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", lineId);

      if (error) {
        toast.error(error.message);
        return;
      }

      setPartsLineId(lineId);
      toast.success("Sent to parts for quoting");
    },
    [setPartsLineId],
  );

  /**
   * Bulk-send all approval-pending lines to parts.
   * Puts the parts drawer into ‚Äúbulk‚Äù mode using the queue.
   */
  const sendAllPendingToParts = useCallback(
    async () => {
      if (!approvalPending.length) return;

      const ids = approvalPending.map((l) => l.id);

      const { error } = await supabase
        .from("work_order_lines")
        .update({
          status: "on_hold",
          hold_reason: "Awaiting parts quote",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .in("id", ids);

      if (error) {
        toast.error(error.message);
        return;
      }

      setBulkQueue(ids);
      setBulkActive(true);
      setPartsLineId(ids[0] ?? null);

      toast.success("Queued all pending lines for parts quoting");
    },
    [approvalPending, setBulkQueue, setBulkActive, setPartsLineId],
  );

  return {
    sendToParts,
    sendAllPendingToParts,
  };
}

========================================
FILE: features/work-orders/hooks/useWorkOrderCreateDraft.ts
========================================
// features/work-orders/hooks/useWorkOrderCreateDraft.ts
"use client";
import { useTabState } from "@/features/shared/hooks/useTabState";

export type CreateDraftV1 = {
  _version: 1;
  vehicle: { year: string; make: string; model: string; vin?: string };
  customer: { first_name: string; last_name: string; phone?: string; email?: string };
  notes: string;
  linesDraft: Array<{ desc: string; qty: number }>;
};

const initialDraft: CreateDraftV1 = {
  _version: 1,
  vehicle: { year: "", make: "", model: "", vin: "" },
  customer: { first_name: "", last_name: "", phone: "", email: "" },
  notes: "",
  linesDraft: [],
};

export function useWorkOrderCreateDraft() {
  const [draft, setDraft] = useTabState<CreateDraftV1>("workorders:create:draft", initialDraft);

  function resetDraft() {
    setDraft(initialDraft);
  }

  return { draft, setDraft, resetDraft };
}

========================================
FILE: features/work-orders/hooks/useWorkOrderMode.ts
========================================
"use client";

import { useMemo } from "react";
import { useSearchParams } from "next/navigation";

export type Role = "owner" | "admin" | "manager" | "advisor" | "tech" | "customer" | "guest";

/**
 * Decide which UI mode to show for a work order:
 * - Query param wins: ?mode=tech or ?mode=view
 * - Otherwise default by role: tech -> "tech", everyone else -> "view"
 */
export function useWorkOrderMode(role: Role | null): "tech" | "view" {
  const sp = useSearchParams();
  return useMemo(() => {
    const qp = (sp.get("mode") || "").toLowerCase();
    if (qp === "tech" || qp === "view") return qp as "tech" | "view";
    return role === "tech" ? "tech" : "view";
  }, [role, sp]);
}


========================================
FILE: features/work-orders/hooks/useWorkOrderViewState.ts
========================================
// features/work-orders/hooks/useWorkOrderViewState.ts
"use client";
import { useTabState } from "@/features/shared/hooks/useTabState";

export type ViewStateV1 = {
  _version: 1;
  ui: {
    showAddForm: boolean;
    activeLineId: string | null;
    filters: { status?: string | null };
    sort: "priority" | "created_at" | "status";
  };
};

const initialState: ViewStateV1 = {
  _version: 1,
  ui: {
    showAddForm: false,
    activeLineId: null,
    filters: { status: null },
    sort: "priority",
  },
};

export function useWorkOrderViewState() {
  const [state, setState] = useTabState<ViewStateV1>("workorders:id:view", initialState);

  function resetViewState() {
    setState(initialState);
  }

  return { state, setState, resetViewState };
}

========================================
FILE: features/work-orders/lib/capabilities.ts
========================================
export function capabilities(role: string | null) {
  const r = (role || "").toLowerCase();
  const staff = ["owner", "admin", "manager", "advisor", "tech"];
  return {
    canView: true,
    canEditWoMeta: ["owner", "admin", "manager", "advisor"].includes(r),
    canTechOps: ["tech", "manager"].includes(r),
    canAddJobs: staff.includes(r),
    canGenerateQuote: staff.includes(r),
  } as const;
}


========================================
FILE: features/work-orders/lib/generateCustomId.ts
========================================
import type { SupabaseClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export async function generateWorkOrderCustomId(
  supabase: SupabaseClient<DB>,
  customerId: string | null,
): Promise<string | null> {
  if (!customerId) return null;

  // 1) load customer for initials
  const { data: customer, error } = await supabase
    .from("customers")
    .select("first_name, last_name")
    .eq("id", customerId)
    .maybeSingle();

  if (error || !customer) {
    // eslint-disable-next-line no-console
    console.error("[generateWorkOrderCustomId] customer load failed:", error);
    return null;
  }

  const firstInitial =
    (customer.first_name?.trim()[0] ?? "X").toUpperCase();
  const lastInitial =
    (customer.last_name?.trim()[0] ?? "X").toUpperCase();
  const prefix = `${firstInitial}${lastInitial}`;

  // 2) find the highest existing number for this prefix
  const { data: rows, error: werr } = await supabase
    .from("work_orders")
    .select("custom_id")
    .ilike("custom_id", `${prefix}%`)
    .order("custom_id", { ascending: false })
    .limit(1);

  let nextNumber = 1;
  if (!werr && rows && rows.length > 0) {
    const last = rows[0]?.custom_id ?? "";
    const m = last.match(/(\d+)$/);
    if (m) {
      const n = parseInt(m[1], 10);
      if (Number.isFinite(n)) nextNumber = n + 1;
    }
  }

  const numberPart = String(nextNumber).padStart(6, "0"); // -> 000001
  return `${prefix}${numberPart}`; // e.g. TU000001
}

========================================
FILE: features/work-orders/lib/getNextJob.ts
========================================
 // features/work-orders/lib/getNextJob.ts
import { createServerSupabaseRSC } from "@shared/lib/supabase/server";

type NextLine = {
  id: string;
  work_order_id: string | null;
  created_at: string;
  status:
    | "ready"
    | "active"
    | "paused"
    | "on_hold"
    | "completed"
    | "queued"
    | "awaiting"
    | "in_progress";
  priority?: number | null;
};

export async function getNextAvailableLine(
  technicianId: string
): Promise<NextLine | null> {
  const supabase = await createServerSupabaseRSC();

  // 0) what shop is this tech in?
  const { data: prof } = await supabase
    .from("profiles")
    .select("shop_id")
    .eq("id", technicianId)
    .single();

  const shopId = prof?.shop_id;
  if (!shopId) {
    // if the tech has no shop, we can't safely scope ‚Äî bail
    return null;
  }

  // 1) resume this tech's own job first
  {
    const { data: resume } = await supabase
      .from("work_order_lines")
      .select("id, work_order_id, created_at, status, priority")
      .eq("assigned_to", technicianId)
      .in("status", ["in_progress", "paused", "awaiting"])
      .order("priority", { ascending: true, nullsFirst: false })
      .order("created_at", { ascending: true })
      .limit(1);

    if (resume && resume.length > 0) {
      return resume[0] as NextLine;
    }
  }

  // helper that tries to find one queued+unassigned line
  async function tryFindQueued(
    allowNullShop: boolean
  ): Promise<
    | {
        id: string;
        work_order_id: string | null;
        created_at: string;
        status: string;
        priority: number | null;
      }
    | null
  > {
    let query = supabase
      .from("work_order_lines")
      .select(
        `
        id,
        work_order_id,
        created_at,
        status,
        priority,
        work_orders!inner ( id, shop_id )
      `
      )
      .eq("status", "queued")
      .is("assigned_to", null)
      .order("priority", { ascending: true, nullsFirst: false })
      .order("created_at", { ascending: true })
      .limit(1);

    // normal path: only lines whose WO belongs to this shop
    if (!allowNullShop) {
      query = query.eq("work_orders.shop_id", shopId);
    } else {
      // fallback: pick queued/unassigned where the WO has no shop yet
      query = query.is("work_orders.shop_id", null);
    }

    const { data, error } = await query;
    if (error) {
      console.warn("getNextAvailableLine: queued lookup failed:", error.message);
      return null;
    }
    return (data && data[0]) || null;
  }

  // 2) preferred: queued, unassigned, same shop
  let candidate = await tryFindQueued(false);

  // 3) fallback: queued, unassigned, WO has no shop_id yet
  if (!candidate) {
    candidate = await tryFindQueued(true);
  }

  if (!candidate) {
    return null;
  }

  // 4) claim it conditionally (race-safe)
  const { data: claimed, error: claimErr } = await supabase
    .from("work_order_lines")
    .update({ assigned_to: technicianId, status: "awaiting" })
    .eq("id", candidate.id)
    .is("assigned_to", null)
    .select("id, work_order_id, created_at, status, priority")
    .single();

  if (claimErr || !claimed) {
    return null;
  }

  // 5) also reflect in the multi-tech table (best-effort)
  const { error: linkErr } = await supabase
    .from("work_order_line_technicians")
    .upsert(
      [
        {
          work_order_line_id: claimed.id,
          technician_id: technicianId,
        },
      ],
      {
        onConflict: "work_order_line_id,technician_id",
      }
    );

  if (linkErr) {
    // not fatal, we already claimed the line
    console.warn(
      "getNextAvailableLine: failed to upsert line technician:",
      linkErr.message
    );
  }

  return claimed as NextLine;
}

========================================
FILE: features/work-orders/lib/parts/consumePart.ts
========================================
"use server";

import { cookies } from "next/headers";
import { revalidatePath } from "next/cache";
import { createServerActionClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import { ensureMainLocation } from "@parts/lib/locations";

type DB = Database;

export type ConsumePartInput = {
  work_order_line_id: string;
  part_id: string;
  qty: number; // positive number means "consume qty"
  location_id?: string; // optional; defaults to MAIN for the WO's shop
  unit_cost?: number | null; // optional override from UI
  availability?: string | null; // accepted but not stored yet
};

export async function consumePart(input: ConsumePartInput) {
  const supabase = createServerActionClient<DB>({ cookies });

  if (!input.qty || input.qty <= 0) {
    throw new Error("Quantity must be greater than 0");
  }

  // 1) Look up WO + shop_id from the line (single source of truth)
  const { data: woLine, error: wlErr } = await supabase
    .from("work_order_lines")
    .select("id, work_order_id, work_orders!inner(id, shop_id)")
    .eq("id", input.work_order_line_id)
    .single();

  if (wlErr) throw wlErr;

  const workOrderId = woLine.work_order_id as string;

  // Supabase typed join object can be awkward; keep it safe without `any`
  const joined = woLine as unknown as {
    work_orders: { shop_id: string };
  };
  const shopId = joined.work_orders.shop_id;

  // 2) Determine location_id (default MAIN)
  let locationId = input.location_id;
  if (!locationId) {
    const loc = await ensureMainLocation(shopId);
    locationId = loc.id as string;
  }

  // 3) Determine effective unit_cost:
  //    - prefer explicit value from picker
  //    - otherwise fall back to parts.default_cost
  let effectiveUnitCost: number | null = null;

  if (typeof input.unit_cost === "number" && Number.isFinite(input.unit_cost)) {
    effectiveUnitCost = input.unit_cost;
  } else {
    const { data: part, error: partErr } = await supabase
      .from("parts")
      .select("default_cost")
      .eq("id", input.part_id)
      .single();

    if (partErr) throw partErr;

    const dc = part?.default_cost;
    effectiveUnitCost =
      dc !== null && dc !== undefined && Number.isFinite(Number(dc))
        ? Number(dc)
        : null;
  }

  // 4) Create allocation row FIRST (and include work_order_id for schemas that require it)
  const { data: alloc, error: aErr } = await supabase
    .from("work_order_part_allocations")
    .insert({
      work_order_id: workOrderId,
      work_order_line_id: input.work_order_line_id,
      part_id: input.part_id,
      location_id: locationId,
      qty: Math.abs(input.qty),
      unit_cost: effectiveUnitCost,
    })
    .select("id")
    .single();

  if (aErr) throw aErr;

  // 5) Create stock move (consume = negative)
  const { data: moveId, error: mErr } = await supabase.rpc("apply_stock_move", {
    p_part: input.part_id,
    p_loc: locationId,
    p_qty: -Math.abs(input.qty),
    p_reason: "consume",
    p_ref_kind: "work_order",
    p_ref_id: workOrderId,
  });

  if (mErr) throw mErr;

  // 6) Link stock move back to allocation
  const { error: linkErr } = await supabase
    .from("work_order_part_allocations")
    .update({ stock_move_id: moveId as string })
    .eq("id", alloc.id);

  if (linkErr) throw linkErr;

  // 7) Revalidate the WO page
  revalidatePath(`/work-orders/${workOrderId}`);

  return { allocationId: alloc.id as string, moveId: moveId as string };
}


========================================
FILE: features/work-orders/lib/saveWorkOrderLines.ts
========================================
// features/work-orders/lib/saveWorkOrderLines.ts
import { createClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

const supabase = createClient<Database>(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
);

type InsertLine = Database["public"]["Tables"]["work_order_lines"]["Insert"];

export async function saveWorkOrderLines(
  lines: Array<{
    complaint: string;
    cause?: string;
    correction?: string;
    tools?: string;
    labor_time?: number;
    job_type?: string | null;
    status?: InsertLine["status"];
  }>,
  userId: string,
  vehicleId: string,
  workOrderId: string,
) {
  const payload: InsertLine[] = lines.map((l) => ({
    user_id: userId,
    vehicle_id: vehicleId,
    work_order_id: workOrderId,
    complaint: l.complaint ?? null,
    cause: l.cause ?? null,
    correction: l.correction ?? null,
    tools: l.tools ?? null,
    labor_time: l.labor_time ?? null,
    status: l.status ?? "awaiting",
    job_type: l.job_type ?? null,
  }));

  const { data, error } = await supabase.from("work_order_lines").insert(payload).select("*");
  if (error) throw new Error(error.message);
  return data;
}

========================================
FILE: features/work-orders/lib/updateLineStatus.ts
========================================
// features/work-orders/lib/updateLineStatusIfPartsReceived.ts
import { createServerSupabaseRSC } from "@shared/lib/supabase/server";
import type { Database } from "@shared/types/types/supabase";

type WOLRow = Database["public"]["Tables"]["work_order_lines"]["Row"];
type WOLUpdate = Database["public"]["Tables"]["work_order_lines"]["Update"];

export async function updateLineStatusIfPartsReceived(lineId: string) {
  const supabase = await createServerSupabaseRSC();

  const { data: line } = await supabase
    .from("work_order_lines")
    .select("id, parts_required, parts_received, status, hold_reason")
    .eq("id", lineId)
    .single<WOLRow>();

  if (!line) return;

  const required = Array.isArray(line.parts_required) ? (line.parts_required as string[]) : [];
  const received = Array.isArray(line.parts_received) ? (line.parts_received as string[]) : [];

  const allReceived = required.length > 0 && required.every((p) => received.includes(p));

  if (allReceived && line.status === "on_hold") {
    const update: WOLUpdate = { status: "awaiting", hold_reason: null };
    await supabase.from("work_order_lines").update(update).eq("id", lineId);
  }
}

========================================
FILE: features/work-orders/lib/work-orders/commandProcessor.ts
========================================
export type WorkOrderCommand =
  | { type: "start_job"; jobId: string }
  | { type: "complete_job"; jobId: string }
  | { type: "put_on_hold"; jobId: string; reason: string }
  | { type: "assign_tech"; jobId: string; techName: string }
  | { type: "update_complaint"; jobId: string; complaint: string };

export function parseWorkOrderCommand(input: string): WorkOrderCommand | null {
  const lower = input.toLowerCase();

  if (lower.includes("start job")) {
    const jobId = extractJobId(lower);
    return jobId ? { type: "start_job", jobId } : null;
  }

  if (lower.includes("complete job")) {
    const jobId = extractJobId(lower);
    return jobId ? { type: "complete_job", jobId } : null;
  }

  if (lower.includes("hold") && lower.includes("because")) {
    const [_, idPart] = lower.split("job ");
    const [jobId, reason] = idPart?.split(" because ") ?? [];
    return jobId && reason
      ? { type: "put_on_hold", jobId: jobId.trim(), reason: reason.trim() }
      : null;
  }

  if (lower.includes("assign") && lower.includes("to")) {
    const match = lower.match(/assign job (\w+) to (\w+)/);
    if (match) {
      const [, jobId, techName] = match;
      return { type: "assign_tech", jobId, techName };
    }
  }

  if (lower.includes("complaint")) {
    const match = lower.match(/job (\w+) complaint (.+)/);
    if (match) {
      const [, jobId, complaint] = match;
      return { type: "update_complaint", jobId, complaint };
    }
  }

  return null;
}

function extractJobId(text: string): string | null {
  const match = text.match(/job (\w+)/);
  return match?.[1] ?? null;
}


========================================
FILE: features/work-orders/lib/work-orders/fetchJobs.ts
========================================
import { createBrowserSupabase } from "@shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

// Joined row coming back from the query
type WorkOrderLineWithJoins =
  Database["public"]["Tables"]["work_order_lines"]["Row"] & {
    vehicles?: { year: number | null; make: string | null; model: string | null } | null;
    profiles?: { full_name: string | null } | null;
  };

// Public shape you want to return to callers
export type JobLine = {
  id: string;
  status: string | null;
  complaint: string | null;
  punched_in_at: string | null;
  punched_out_at: string | null;
  hold_reason: string | null;
  created_at: string | null;
  vehicle?: { year: number | null; make: string | null; model: string | null };
  assigned_to?: { full_name: string | null };
};

export async function fetchAllJobLines(): Promise<JobLine[]> {
  const supabase = createBrowserSupabase();

  const { data, error } = await supabase
    .from("work_order_lines")
    .select(`
      id,
      status,
      complaint,
      punched_in_at,
      punched_out_at,
      hold_reason,
      created_at,
      vehicles:vehicle_id ( year, make, model ),
      profiles:assigned_to ( full_name )
    `)
    .order("created_at", { ascending: true });

  if (error || !data) {
    console.error("‚ùå Error fetching job lines:", error);
    return [];
  }

  const rows = data as unknown as WorkOrderLineWithJoins[];

  return rows.map((row): JobLine => ({
    id: row.id,
    status: row.status,
    complaint: row.complaint,
    punched_in_at: row.punched_in_at,
    punched_out_at: row.punched_out_at,
    hold_reason: row.hold_reason,
    created_at: row.created_at,
    vehicle: row.vehicles
      ? { year: row.vehicles.year, make: row.vehicles.make, model: row.vehicles.model }
      : undefined,
    assigned_to: row.profiles ? { full_name: row.profiles.full_name } : undefined,
  }));
}

========================================
FILE: features/work-orders/lib/work-orders/generateQuotePdf.ts
========================================
import { PDFDocument, rgb, StandardFonts } from "pdf-lib";
import type {
  QuoteLine,
  QuoteLineItem,
} from "@inspections/lib/inspection/types";

/**
 * Normalizes either QuoteLine or QuoteLineItem into a common shape
 * so the PDF renderer doesn't care which one you pass.
 */
function toUnified(line: QuoteLine | QuoteLineItem) {
  // Heuristic: QuoteLine has "parts" or "laborTime"
  const isQuoteLine =
    (line as QuoteLine).parts !== undefined ||
    (line as QuoteLine).laborTime !== undefined;

  if (isQuoteLine) {
    const q = line as QuoteLine;
    const first = q.parts?.[0];
    const laborHours = q.laborTime ?? 0;
    const laborRate = q.laborRate ?? 0;
    const laborPrice = laborRate * laborHours;

    return {
      name: q.item ?? q.inspectionItem ?? "",
      description: q.description ?? "",
      status: (q.status ?? "ok") as "ok" | "fail" | "na" | "recommend",
      notes: q.notes ?? "",
      partName: first?.name ?? "",
      partPrice:
        typeof first?.price === "number"
          ? first!.price
          : Number(first?.price ?? 0),
      laborHours,
      laborPrice,
    };
  }

  // Otherwise treat as QuoteLineItem
  const qi = line as QuoteLineItem;
  const numericPartPrice =
    typeof qi.part?.price === "number"
      ? qi.part?.price
      : typeof qi.partPrice === "number"
        ? qi.partPrice
        : Number(qi.partPrice ?? 0);

  return {
    name: qi.name ?? (qi.item ?? ""),
    description: qi.description ?? "",
    status: qi.status,
    notes: qi.notes ?? "",
    partName: qi.part?.name ?? qi.partName ?? "",
    partPrice: numericPartPrice ?? 0,
    laborHours: qi.laborHours ?? 0,
    laborPrice: qi.price ?? 0,
  };
}

export async function generateQuotePDFBytes(
  quoteLines: ReadonlyArray<QuoteLine | QuoteLineItem>,
  summaryText: string,
): Promise<Uint8Array> {
  const pdfDoc = await PDFDocument.create();
  let page = pdfDoc.addPage();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontSize = 12;

  const drawText = (text: string, x = 50, dy = fontSize + 6) => {
    const { height } = page.getSize();
    // track y on the page
    if ((drawText as any)._y === undefined) (drawText as any)._y = height - 40;
    let y = (drawText as any)._y as number;

    page.drawText(text, { x, y, size: fontSize, font, color: rgb(0, 0, 0) });
    y -= dy;

    // Start new page if we‚Äôre near the bottom
    if (y < 60) {
      page = pdfDoc.addPage();
      y = page.getSize().height - 40;
    }
    (drawText as any)._y = y;
  };

  // Summary
  drawText("Inspection Summary:");
  for (const line of (summaryText || "").split("\n")) {
    drawText(line);
  }

  // Spacer + header
  drawText("", 50, 20);
  drawText("Quote Items:");

  // Items
  for (const raw of quoteLines) {
    const u = toUnified(raw);

    drawText(`‚Ä¢ ${u.name || "(unnamed item)"}`);
    if (u.description) drawText(`   ${u.description}`);

    const priceStr =
      typeof u.partPrice === "number" ? u.partPrice.toFixed(2) : "0.00";
    drawText(`   Part: ${u.partName || "‚Äî"} - $${priceStr}`);

    drawText(
      `   Labor: ${u.laborHours ?? 0} hrs - $${(u.laborPrice ?? 0).toFixed(2)}`,
    );

    drawText(`   Status: ${u.status}`);
    if (u.notes) drawText(`   Notes: ${u.notes}`);

    // Extra gap between items
    drawText("", 50, 10);
  }

  return pdfDoc.save(); // Uint8Array
}

/** Back-compat alias so existing imports `{ generateQuotePDF }` still compile */
export const generateQuotePDF = generateQuotePDFBytes;

========================================
FILE: features/work-orders/lib/work-orders/getQueuedJobsForTech.ts
========================================
// features/work-orders/lib/work-orders/getQueuedJobsForTech.ts
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type JobLine = Database["public"]["Tables"]["work_order_lines"]["Row"];

/**
 * Fetch queue for a tech as raw DB rows (JobLine[]).
 * - Filters to visible queue statuses
 * - If techId provided: include jobs assigned to that tech OR unassigned
 * - Ordered by parent work order priority first, then oldest ‚Üí newest
 */
export async function getQueuedJobsForTech(techId?: string): Promise<JobLine[]> {
  const supabase = createClientComponentClient<Database>();

  // join work_orders so we can sort by work order priority
  let query = supabase
    .from("work_order_lines")
    .select(
      `
        *,
        work_orders!inner (
          id,
          priority
        )
      `
    )
    .in("status", ["queued", "awaiting", "in_progress", "on_hold"])
    // highest priority WOs first (1 = highest)
    .order("work_orders(priority)", { ascending: true, nullsFirst: false })
    // then oldest job within that
    .order("created_at", { ascending: true });

  if (techId) {
    // show jobs assigned to this tech OR unassigned
    query = query.or(`assigned_to.eq.${techId},assigned_to.is.null`);
  }

  const { data, error } = await query;
  if (error || !data) {
    console.error("getQueuedJobsForTech error:", error?.message);
    return [];
  }

  // we only declared JobLine, so just return the line shape ‚Äî the extra joined
  // work_orders data will be ignored by the caller
  return data as JobLine[];
}

========================================
FILE: features/work-orders/lib/work-orders/handleWorkOrderCommand.ts
========================================
import type { Database } from "@shared/types/types/supabase";

type WorkOrderLine = Database["public"]["Tables"]["work_order_lines"]["Row"];
type UpdateLineFn = (line: WorkOrderLine) => void;

/* ---------- Commands ---------- */

export type Command =
  | { action: "set"; field: keyof WorkOrderLine; value: WorkOrderLine[keyof WorkOrderLine] }
  | { action: "hold"; value?: string | null }
  | { action: "clear"; field: keyof WorkOrderLine }
  | { action: "complete" };

export type RawCommand =
  | { set: { field: keyof WorkOrderLine; value: WorkOrderLine[keyof WorkOrderLine] } }
  | { hold: string | null | undefined }
  | { clear: keyof WorkOrderLine }
  | { complete: true }
  | Partial<{ action: Command["action"]; field: keyof WorkOrderLine; value: unknown }>;

/* ---------- Type guards (no any) ---------- */

function has<K extends PropertyKey>(obj: unknown, key: K): obj is Record<K, unknown> {
  return typeof obj === "object" && obj !== null && key in obj;
}

function isActionCmd(input: unknown): input is Partial<Command> & { action: Command["action"] } {
  return has(input, "action") && typeof (input as { action: unknown }).action === "string";
}

/* ---------- Normalizer (no any) ---------- */

function normalizeCommand(input: Command | RawCommand | null | undefined): Command | null {
  if (!input) return null;

  if (isActionCmd(input)) {
    switch (input.action) {
      case "set":
        if (has(input, "field")) {
          const field = input.field as keyof WorkOrderLine;
          const value = (has(input, "value") ? input.value : null) as WorkOrderLine[keyof WorkOrderLine];
          return { action: "set", field, value };
        }
        break;
      case "hold":
        return { action: "hold", value: (has(input, "value") ? (input as { value?: unknown }).value : null) as string | null | undefined };
      case "clear":
        if (has(input, "field")) {
          const field = input.field as keyof WorkOrderLine;
          return { action: "clear", field };
        }
        break;
      case "complete":
        return { action: "complete" };
    }
  }

  // raw shapes
  if (has(input, "set") && typeof input.set === "object" && input.set !== null) {
    const s = input.set as { field: keyof WorkOrderLine; value: WorkOrderLine[keyof WorkOrderLine] };
    return { action: "set", field: s.field, value: s.value };
  }
  if (has(input, "hold")) {
    const v = (input as { hold: string | null | undefined }).hold;
    return { action: "hold", value: v };
  }
  if (has(input, "clear")) {
    const field = (input as { clear: keyof WorkOrderLine }).clear;
    return { action: "clear", field };
  }
  if (has(input, "complete")) {
    return { action: "complete" };
  }

  return null;
}

/* ---------- Safe assignment helpers (no any) ---------- */

function setField<K extends keyof WorkOrderLine>(
  target: WorkOrderLine,
  key: K,
  value: WorkOrderLine[K]
) {
  // Indexing with a generic key is safe; no any needed
  target[key] = value;
}

function clearField<K extends keyof WorkOrderLine>(target: WorkOrderLine, key: K) {
  // Some columns may not be nullable at the type level; use unknown‚ÜíK to avoid any
  target[key] = (null as unknown) as WorkOrderLine[K];
}

/* ---------- Public API ---------- */

export function handleWorkOrderCommand(
  input: Command | RawCommand,
  line: WorkOrderLine,
  updateLine: UpdateLineFn
): string {
  const command = normalizeCommand(input);
  if (!command) return "Unrecognized command";

  const updated: WorkOrderLine = { ...line };

  switch (command.action) {
    case "set": {
      setField(updated, command.field, command.value);
      updateLine(updated);
      return `Set ${String(command.field)}.`;
    }

    case "hold": {
      updated.status = "on_hold";
      const reason = command.value ?? null;
      updated.hold_reason = reason as WorkOrderLine["hold_reason"];
      updateLine(updated);
      return `Marked on hold${reason ? `: ${reason}` : ""}.`;
    }

    case "clear": {
      clearField(updated, command.field);
      updateLine(updated);
      return `Cleared ${String(command.field)}.`;
    }

    case "complete": {
      updated.status = "completed";
      updateLine(updated);
      return "Marked completed.";
    }
  }
}


========================================
FILE: features/work-orders/lib/work-orders/insertPrioritizedJobsFromInspection.ts
========================================
// lib/work-orders/insertPrioritizedJobsFromInspection.ts
import { createBrowserSupabase } from "@shared/lib/supabase/client";
import { Database } from "@shared/types/types/supabase";
import { estimateLabor } from "@ai/lib/ai/generateLaborTimeEstimate";

type Inspection = Database["public"]["Tables"]["inspections"]["Row"];
type WorkOrderLineInsert =
  Database["public"]["Tables"]["work_order_lines"]["Insert"];
type PartsRequestInsert =
  Database["public"]["Tables"]["parts_requests"]["Insert"];

type InspectionResult = {
  sections: {
    title: string;
    items: {
      name: string;
      value?: string;
      unit?: string;
      notes?: string;
      status?: "ok" | "fail" | "na" | "recommend";
      recommend?: boolean;
    }[];
  }[];
};

export async function insertPrioritizedJobsFromInspection(
  inspectionId: string,
  workOrderId: string,
  vehicleId: string,
  userId: string,
  autoGenerateParts: boolean = true
) {
  const supabase = createBrowserSupabase();

  const { data: inspection, error } = await supabase
    .from("inspections")
    .select("*")
    .eq("id", inspectionId)
    .single<Inspection>();

  if (error || !inspection) {
    console.error("Failed to fetch inspection:", error);
    return;
  }

  // Some generated supabase.ts versions don't include `result` on inspections.Row.
  // Cast locally just for this access.
  const result = (inspection as unknown as { result?: unknown })?.result as
    | InspectionResult
    | undefined;

  if (!result?.sections) {
    console.warn("Invalid inspection format");
    return;
  }

  const allJobs: WorkOrderLineInsert[] = [];
  const jobItemMap: {
    itemName: string;
    originalItem: InspectionResult["sections"][number]["items"][number];
    jobIndex: number;
  }[] = [];

  const diagnosisKeywords = ["check engine", "diagnose", "misfire", "no start"];
  const maintenanceKeywords = ["oil", "fluid", "filter", "belt", "coolant"];
  const autoPartsKeywords = ["brake", "pads", "rotor", "fluid", "coolant", "filter", "belt"];

  for (const section of result.sections) {
    for (const item of section.items) {
      const name = item.name?.toLowerCase() || "";
      let jobType: WorkOrderLineInsert["job_type"] = "repair";

      if (diagnosisKeywords.some((k) => name.includes(k))) jobType = "diagnosis";
      else if (item.status === "fail") jobType = "inspection-fail";
      else if (maintenanceKeywords.some((k) => name.includes(k))) jobType = "maintenance";

      const laborTime = await estimateLabor(item.name, jobType);

      const complaintParts = [item.name];
      if (item.value) complaintParts.push(`(${item.value}${item.unit || ""})`);
      if (item.notes) complaintParts.push(`- ${item.notes}`);

      // NOTE: omit created_at/updated_at here ‚Äî DB defaults/trigger should set them.
      const job: WorkOrderLineInsert = {
        work_order_id: workOrderId,
        vehicle_id: vehicleId,
        complaint: complaintParts.join(" "),
        status: "queued",
        job_type: jobType,
        punched_in_at: null,
        punched_out_at: null,
        hold_reason: null,
        assigned_to: null,
        assigned_tech_id: null,
        labor_time: laborTime ?? null,
      };

      const shouldInclude =
        item.status === "fail" || item.recommend === true || jobType !== "repair";

      if (shouldInclude) {
        jobItemMap.push({
          itemName: item.name,
          originalItem: item,
          jobIndex: allJobs.length,
        });
        allJobs.push(job);
      }
    }
  }

  const insertedJobsRes = await supabase
    .from("work_order_lines")
    .insert(allJobs)
    .select("id, complaint");

  if (insertedJobsRes.error) {
    console.error("Error inserting job lines:", insertedJobsRes.error);
    return;
  }

  const insertedJobs = insertedJobsRes.data;
  const partsRequests: PartsRequestInsert[] = [];

  if (autoGenerateParts) {
    for (let i = 0; i < insertedJobs.length; i++) {
      const { complaint, id: jobId } = insertedJobs[i];
      const { originalItem } = jobItemMap[i];

      // complaint is string | null in types ‚Üí guard it
      const lower = (complaint ?? "").toLowerCase();
      if (autoPartsKeywords.some((k) => lower.includes(k))) {
        partsRequests.push({
          id: crypto.randomUUID(),
          job_id: jobId,
          work_order_id: workOrderId,
          part_name: originalItem.name,
          quantity: 1,
          urgency: "medium",
          notes: "Auto-generated from inspection",
          photo_urls: [],
          requested_by: userId,
          created_at: new Date().toISOString(),
          viewed_at: null,
          fulfilled_at: null,
          archived: false,
        });
      }
    }

    if (partsRequests.length > 0) {
      const { error: partsError } = await supabase
        .from("parts_requests")
        .insert(partsRequests);

      if (partsError) {
        console.error("Error inserting parts requests:", partsError);
      }
    }
  }
}

========================================
FILE: features/work-orders/lib/work-orders/insertPrioritizedJobs.ts
========================================
// src/lib/work-orders/insertPrioritizedJobs.ts
import { createBrowserSupabase } from "@shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

type WorkOrderLineInsert =
  Database["public"]["Tables"]["work_order_lines"]["Insert"];

export async function insertPrioritizedJobs(
  workOrderId: string,
  jobs: WorkOrderLineInsert[],
) {
  const supabase = createBrowserSupabase();

  // 1. Define the job type priority order
  const priority = ["diagnosis", "inspection-fail", "maintenance", "repair"];

  // 2. Sort jobs based on the job_type priority
  const sortedJobs = jobs.sort((a, b) => {
    const aPriority = priority.indexOf(a.job_type || "repair");
    const bPriority = priority.indexOf(b.job_type || "repair");
    return aPriority - bPriority;
  });

  // 3. Insert each job in sorted order
  const insertedJobs = [];
  for (const job of sortedJobs) {
    const { data, error } = await supabase
      .from("work_order_lines")
      .insert({
        ...job,
        work_order_id: workOrderId,
      })
      .select()
      .single();

    if (error) {
      console.error("Failed to insert job:", error);
      continue;
    }

    insertedJobs.push(data);
  }

  return insertedJobs;
}

========================================
FILE: features/work-orders/lib/work-orders/parseWorkOrderCommand.ts
========================================
export type Command = {
  action: "set" | "complete" | "hold" | "clear";
  field?: string;
  value?: string;
};

export function parseWorkOrderCommand(transcript: string): Command | null {
  const lower = transcript.toLowerCase().trim();

  // Match: "set complaint to engine knocking"
  const setMatch = lower.match(/set (\w+) to (.+)/);
  if (setMatch) {
    return {
      action: "set",
      field: setMatch[1],
      value: setMatch[2],
    };
  }

  // Match: "complete job" or "mark complete"
  if (lower.includes("complete job") || lower.includes("mark complete")) {
    return { action: "complete" };
  }

  // Match: "hold for parts", "hold for authorization"
  const holdMatch = lower.match(/hold(?: for)? (\w+)/);
  if (holdMatch) {
    return {
      action: "hold",
      field: "hold_reason",
      value: holdMatch[1],
    };
  }

  // Match: "clear correction", "clear cause"
  const clearMatch = lower.match(/clear (\w+)/);
  if (clearMatch) {
    return {
      action: "clear",
      field: clearMatch[1],
    };
  }

  return null; // No valid command parsed
}


========================================
FILE: features/work-orders/mobile/MobileCustomerVehicleForm.tsx
========================================
// features/work-orders/mobile/MobileCustomerVehicleForm.tsx
"use client";

import type { Dispatch, SetStateAction } from "react";
import type { SupabaseClient } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";
import type { MobileCustomer, MobileVehicle } from "./types";

type DB = Database;
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];

type Props = {
  wo: WorkOrderRow | null;
  customer: MobileCustomer;
  vehicle: MobileVehicle;
  onCustomerChange: Dispatch<SetStateAction<MobileCustomer>>;
  onVehicleChange: Dispatch<SetStateAction<MobileVehicle>>;
  supabase: SupabaseClient<DB>; // kept for future lookups
};

export function MobileCustomerVehicleForm({
  wo,
  customer,
  vehicle,
  onCustomerChange,
  onVehicleChange,
}: Props) {
  const woLabel = wo?.custom_id ?? (wo ? wo.id.slice(0, 8) : null);

  const inputBase =
    "w-full rounded-md border border-white/15 bg-black/40 px-3 py-2 text-sm text-white " +
    "placeholder:text-neutral-400 focus:border-[var(--accent-copper-light)] " +
    "focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]";

  const inputTight =
    "w-full rounded-md border border-white/15 bg-black/40 px-2 py-2 text-sm text-white " +
    "placeholder:text-neutral-400 focus:border-[var(--accent-copper-light)] " +
    "focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]";

  const labelClass =
    "text-[11px] uppercase tracking-[0.16em] text-neutral-400";

  return (
    <div className="glass-card rounded-2xl border border-white/12 bg-black/40 p-4 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between gap-2">
        <div>
          <h2 className="text-sm font-semibold text-neutral-100">
            Customer &amp; Vehicle
          </h2>
          <p className="text-[11px] text-neutral-400">
            Full customer and unit details for this work order.
          </p>
        </div>
        {woLabel && (
          <span className="glass-chip font-mono text-[10px]">
            WO&nbsp;{woLabel}
          </span>
        )}
      </div>

      {/* Customer */}
      <div className="space-y-3">
        <h3 className={labelClass}>Customer</h3>
        <div className="grid grid-cols-1 gap-3">
          <div className="flex gap-2">
            <div className="flex-1 space-y-1">
              <label className={labelClass}>First name</label>
              <input
                className={inputBase}
                value={customer.first_name ?? ""}
                onChange={(e) =>
                  onCustomerChange((prev) => ({
                    ...prev,
                    first_name: e.target.value || null,
                  }))
                }
                placeholder="First"
              />
            </div>
            <div className="flex-1 space-y-1">
              <label className={labelClass}>Last name</label>
              <input
                className={inputBase}
                value={customer.last_name ?? ""}
                onChange={(e) =>
                  onCustomerChange((prev) => ({
                    ...prev,
                    last_name: e.target.value || null,
                  }))
                }
                placeholder="Last"
              />
            </div>
          </div>

          <div className="space-y-1">
            <label className={labelClass}>Phone</label>
            <input
              className={inputBase}
              value={customer.phone ?? ""}
              onChange={(e) =>
                onCustomerChange((prev) => ({
                  ...prev,
                  phone: e.target.value || null,
                }))
              }
              placeholder="Mobile"
            />
          </div>

          <div className="space-y-1">
            <label className={labelClass}>Email</label>
            <input
              type="email"
              className={inputBase}
              value={customer.email ?? ""}
              onChange={(e) =>
                onCustomerChange((prev) => ({
                  ...prev,
                  email: e.target.value || null,
                }))
              }
              placeholder="name@example.com"
            />
          </div>
        </div>
      </div>

      {/* Vehicle */}
      <div className="space-y-3">
        <h3 className={labelClass}>Vehicle</h3>
        <div className="grid grid-cols-1 gap-3">
          <div className="flex gap-2">
            <div className="w-20 space-y-1">
              <label className={labelClass}>Year</label>
              <input
                inputMode="numeric"
                className={inputTight}
                value={vehicle.year ?? ""}
                onChange={(e) =>
                  onVehicleChange((prev) => ({
                    ...prev,
                    year: e.target.value || null,
                  }))
                }
                placeholder="YYYY"
              />
            </div>
            <div className="flex-1 space-y-1">
              <label className={labelClass}>Make</label>
              <input
                className={inputBase}
                value={vehicle.make ?? ""}
                onChange={(e) =>
                  onVehicleChange((prev) => ({
                    ...prev,
                    make: e.target.value || null,
                  }))
                }
                placeholder="Ford, Kenworth‚Ä¶"
              />
            </div>
            <div className="flex-1 space-y-1">
              <label className={labelClass}>Model</label>
              <input
                className={inputBase}
                value={vehicle.model ?? ""}
                onChange={(e) =>
                  onVehicleChange((prev) => ({
                    ...prev,
                    model: e.target.value || null,
                  }))
                }
                placeholder="F-150, T800‚Ä¶"
              />
            </div>
          </div>

          <div className="space-y-1">
            <label className={labelClass}>VIN</label>
            <input
              className={inputBase}
              value={vehicle.vin ?? ""}
              onChange={(e) =>
                onVehicleChange((prev) => ({
                  ...prev,
                  vin: e.target.value || null,
                }))
              }
              placeholder="17-character VIN"
            />
          </div>

          <div className="space-y-1">
            <label className={labelClass}>License plate</label>
            <input
              className={inputBase}
              value={vehicle.license_plate ?? ""}
              onChange={(e) =>
                onVehicleChange((prev) => ({
                  ...prev,
                  license_plate: e.target.value || null,
                }))
              }
              placeholder="ABC 123"
            />
          </div>

          <div className="space-y-1">
            <label className={labelClass}>Odometer / mileage</label>
            <input
              inputMode="numeric"
              className={inputBase}
              value={vehicle.mileage ?? ""}
              onChange={(e) =>
                onVehicleChange((prev) => ({
                  ...prev,
                  mileage: e.target.value || null,
                }))
              }
              placeholder="km or mi"
            />
          </div>
        </div>
      </div>
    </div>
  );
}

export default MobileCustomerVehicleForm;

========================================
FILE: features/work-orders/mobile/MobileFocusedJob.tsx
========================================
// features/work-orders/mobile/MobileFocusedJob.tsx
"use client";

import {
  useEffect,
  useMemo,
  useState,
  useCallback,
  type JSX,
} from "react";
import { format } from "date-fns";
import { toast } from "sonner";
import { v4 as uuidv4 } from "uuid";
import { createBrowserSupabase } from "@/features/shared/lib/supabase/client";

import CauseCorrectionModal from "@work-orders/components/workorders/CauseCorrectionModal";
import PartsRequestModal from "@/features/work-orders/components/workorders/PartsRequestModal";
import HoldModal from "@/features/work-orders/components/workorders/HoldModal";
import PhotoCaptureModal from "@/features/work-orders/components/workorders/extras/PhotoCaptureModal";
import AddJobModal from "@work-orders/components/workorders/AddJobModal";
import AIAssistantModal from "@work-orders/components/workorders/AiAssistantModal";

import NewChatModal from "@/features/ai/components/chat/NewChatModal";
import SuggestedQuickAdd from "@work-orders/components/SuggestedQuickAdd";
import JobPunchButton from "@/features/work-orders/components/JobPunchButton";

import type { RealtimePostgresChangesPayload } from "@supabase/supabase-js";
import type { Database } from "@shared/types/types/supabase";

type Mode = "tech" | "view";

const statusTextColor: Record<string, string> = {
  in_progress: "text-sky-200",
  awaiting: "text-slate-200",
  queued: "text-indigo-200",
  on_hold: "text-amber-200",
  completed: "text-emerald-200",
  paused: "text-amber-200",
  assigned: "text-sky-200",
  unassigned: "text-neutral-200",
  awaiting_approval: "text-blue-200",
  declined: "text-red-200",
};

const chip = (s: string | null) =>
  statusTextColor[(s ?? "awaiting").toLowerCase().replaceAll(" ", "_")] ??
  "text-neutral-200";

const btnBase =
  "rounded-md border text-sm px-3 py-2 transition-colors text-left";
const btnNeutral =
  btnBase +
  " border-white/15 bg-black/40 text-neutral-100 hover:bg-white/5";
const btnWarn =
  btnBase +
  " border-amber-400/80 bg-amber-500/10 text-amber-100 hover:bg-amber-500/20";
const btnDanger =
  btnBase +
  " border-red-500/80 bg-red-500/10 text-red-100 hover:bg-red-500/20";
const btnInfo =
  btnBase +
  " border-sky-500/80 bg-sky-500/10 text-sky-100 hover:bg-sky-500/20";
const btnAccent =
  btnBase +
  " border-[var(--accent-copper-light)] bg-[var(--accent-copper-faint)] text-[var(--accent-copper-light)] hover:bg-[var(--accent-copper-soft)]";

type DB = Database;
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];

type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

type WorkflowStatus =
  | "awaiting"
  | "awaiting_approval"
  | "declined"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "paused"
  | "completed"
  | "assigned"
  | "unassigned";

export default function MobileFocusedJob(props: {
  workOrderLineId: string;
  onBack: () => void;
  onChanged?: () => void | Promise<void>;
  mode?: Mode;
}): JSX.Element {
  const { workOrderLineId, onBack, onChanged, mode = "tech" } = props;

  const supabase = useMemo(() => createBrowserSupabase(), []);

  const [busy, setBusy] = useState(false);
  const [line, setLine] = useState<WorkOrderLine | null>(null);
  const [workOrder, setWorkOrder] = useState<WorkOrder | null>(null);
  const [vehicle, setVehicle] = useState<Vehicle | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);

  const [techNotes, setTechNotes] = useState("");
  const [savingNotes, setSavingNotes] = useState(false);

  // sub-modals
  const [openComplete, setOpenComplete] = useState(false);
  const [openParts, setOpenParts] = useState(false);
  const [openHold, setOpenHold] = useState(false);
  const [openPhoto, setOpenPhoto] = useState(false);
  const [openChat, setOpenChat] = useState(false);
  const [openAddJob, setOpenAddJob] = useState(false);
  const [openAi, setOpenAi] = useState(false);

  // prefill
  const [prefillCause, setPrefillCause] = useState("");
  const [prefillCorrection, setPrefillCorrection] = useState("");

  // parts used
  const [allocs, setAllocs] = useState<AllocationRow[]>([]);
  const [allocsLoading, setAllocsLoading] = useState(false);

  const showErr = (prefix: string, err?: { message?: string } | null) => {
    toast.error(`${prefix}: ${err?.message ?? "Something went wrong."}`);
    console.error(prefix, err);
  };

  const closeAllSubModals = () => {
    setOpenComplete(false);
    setOpenParts(false);
    setOpenHold(false);
    setOpenPhoto(false);
    setOpenChat(false);
    setOpenAddJob(false);
    setOpenAi(false);
  };

  // initial load
  useEffect(() => {
    if (!workOrderLineId) return;
    (async () => {
      setBusy(true);
      try {
        const { data: l, error: le } = await supabase
          .from("work_order_lines")
          .select("*")
          .eq("id", workOrderLineId)
          .maybeSingle<WorkOrderLine>();
        if (le) throw le;
        setLine(l ?? null);
        setTechNotes(l?.notes ?? "");

        if (l?.work_order_id) {
          const { data: wo, error: we } = await supabase
            .from("work_orders")
            .select("*")
            .eq("id", l.work_order_id)
            .maybeSingle<WorkOrder>();
          if (we) throw we;
          setWorkOrder(wo ?? null);

          if (wo?.vehicle_id) {
            const { data: v, error: ve } = await supabase
              .from("vehicles")
              .select("*")
              .eq("id", wo.vehicle_id)
              .maybeSingle<Vehicle>();
            if (ve) throw ve;
            setVehicle(v ?? null);
          } else {
            setVehicle(null);
          }

          if (wo?.customer_id) {
            const { data: c, error: ce } = await supabase
              .from("customers")
              .select("*")
              .eq("id", wo.customer_id)
              .maybeSingle<Customer>();
            if (ce) throw ce;
            setCustomer(c ?? null);
          } else {
            setCustomer(null);
          }
        }
      } catch (e) {
        const err = e as { message?: string };
        toast.error(err?.message ?? "Failed to load job");
      } finally {
        setBusy(false);
      }
    })();
  }, [workOrderLineId, supabase]);

  // realtime line
  useEffect(() => {
    if (!workOrderLineId) return;
    const ch = supabase
      .channel(`wol-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `id=eq.${workOrderLineId}`,
        },
        (payload: RealtimePostgresChangesPayload<WorkOrderLine>) => {
          const next = payload.new;
          if (next && typeof (next as Partial<WorkOrderLine>).id === "string") {
            setLine(next as WorkOrderLine);
          }
        },
      )
      .subscribe();
    return () => {
      void supabase.removeChannel(ch);
    };
  }, [workOrderLineId, supabase]);

  const loadAllocations = useCallback(async () => {
    if (!workOrderLineId) return;
    setAllocsLoading(true);
    try {
      const { data, error } = await supabase
        .from("work_order_part_allocations")
        .select("*, parts(name)")
        .eq("work_order_line_id", workOrderLineId)
        .order("created_at", { ascending: true });
      if (error) throw error;
      setAllocs((data as AllocationRow[]) ?? []);
    } catch (e) {
      console.warn("[MobileFocusedJob] load allocations failed", e);
    } finally {
      setAllocsLoading(false);
    }
  }, [supabase, workOrderLineId]);

  useEffect(() => {
    void loadAllocations();
  }, [loadAllocations]);

  useEffect(() => {
    if (!workOrderLineId) return;

    const ch = supabase
      .channel(`wol-parts-${workOrderLineId}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_part_allocations",
          filter: `work_order_line_id=eq.${workOrderLineId}`,
        },
        () => void loadAllocations(),
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        //
      }
    };
  }, [workOrderLineId, supabase, loadAllocations]);

  const refresh = useCallback(
    async () => {
      const { data: l } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("id", workOrderLineId)
        .maybeSingle<WorkOrderLine>();
      setLine(l ?? null);
      setTechNotes(l?.notes ?? "");
      await onChanged?.();
      await loadAllocations();
    },
    [supabase, workOrderLineId, onChanged, loadAllocations],
  );

  useEffect(() => {
    const handler = () => void refresh();
    window.addEventListener("wol:refresh", handler);
    return () => window.removeEventListener("wol:refresh", handler);
  }, [refresh]);

  // parts request events
  useEffect(() => {
    const handleClose = () => setOpenParts(false);
    const handleSubmitted = async () => {
      setOpenParts(false);
      await refresh();
    };

    window.addEventListener("parts-request:close", handleClose);
    window.addEventListener("parts-request:submitted", handleSubmitted);
    return () => {
      window.removeEventListener("parts-request:close", handleClose);
      window.removeEventListener("parts-request:submitted", handleSubmitted);
    };
  }, [refresh]);

  // inspection done ‚Üí open complete
  useEffect(() => {
    const onInspectionDone = (evt: Event) => {
      const e = evt as CustomEvent<{
        workOrderLineId?: string;
        cause?: string;
        correction?: string;
      }>;
      const detail = e.detail || {};
      if (!detail.workOrderLineId) return;
      if (detail.workOrderLineId !== workOrderLineId) return;

      closeAllSubModals();
      setPrefillCause(detail.cause ?? "");
      setPrefillCorrection(detail.correction ?? "");
      setOpenComplete(true);
    };

    window.addEventListener("inspection:completed", onInspectionDone);
    return () =>
      window.removeEventListener("inspection:completed", onInspectionDone);
  }, [workOrderLineId]);

    const applyHold = async (reason: string, notes?: string) => {
    if (busy) return;
    if (!line) return;

    setBusy(true);
    try {
      const update: DB["public"]["Tables"]["work_order_lines"]["Update"] = {
        hold_reason: reason || "On hold",
        status: "on_hold",
        // keep any existing notes unless overridden
        notes: notes ?? line.notes ?? null,
      };

      // üîπ If the job is actively running, "punch off" when putting it on hold
      if (line.punched_in_at && !line.punched_out_at) {
        update.punched_out_at = new Date().toISOString();
      }

      const { error } = await supabase
        .from("work_order_lines")
        .update(update)
        .eq("id", workOrderLineId);

      if (error) return showErr("Apply hold failed", error);

      toast.success("Hold applied");
      await refresh();
    } finally {
      setBusy(false);
    }
  };

  const releaseHold = async () => {
    if (busy) return;
    setBusy(true);
    try {
      const { error } = await supabase
        .from("work_order_lines")
        .update({
          hold_reason: null,
          status: "awaiting",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", workOrderLineId);
      if (error) return showErr("Remove hold failed", error);
      toast.success("Hold removed");
      await refresh();
    } finally {
      setBusy(false);
    }
  };

  const uploadPhoto = async (file: File) => {
    if (!workOrderLineId || !workOrder?.id) return;
    const path = `wo/${workOrder.id}/lines/${workOrderLineId}/${uuidv4()}_${file.name}`;
    const { error } = await supabase.storage
      .from("job-photos")
      .upload(path, file, {
        contentType: file.type || "image/jpeg",
        upsert: true,
      });
    if (error) return showErr("Photo upload failed", error);
    toast.success("Photo attached");
  };

  const saveNotes = async () => {
    setSavingNotes(true);
    const { error } = await supabase
      .from("work_order_lines")
      .update({
        notes: techNotes,
      } as DB["public"]["Tables"]["work_order_lines"]["Update"])
      .eq("id", workOrderLineId);
    setSavingNotes(false);
    if (error) return showErr("Update notes failed", error);
    toast.success("Notes saved");
    await refresh();
  };

  const startAt = line?.punched_in_at ?? null;
  const finishAt = line?.punched_out_at ?? null;

  const titleText =
    `${line?.line_no ? `#${line.line_no} ` : ""}` +
    (line?.description || line?.complaint || "Focused Job") +
    (line?.job_type ? ` ‚Äî ${String(line.job_type).replaceAll("_", " ")}` : "");

  const createdStart = startAt ? format(new Date(startAt), "PPpp") : "‚Äî";
  const createdFinish = finishAt ? format(new Date(finishAt), "PPpp") : "‚Äî";

  return (
    <>
      <div className="app-shell flex min-h-screen flex-col text-foreground">
        {/* Header */}
        <header className="metal-bar sticky top-0 z-40 flex items-center justify-between gap-2 px-3 py-2">
          <button
            type="button"
            onClick={() => {
              closeAllSubModals();
              onBack();
            }}
            className="inline-flex items-center gap-1 rounded-full border border-white/15 bg-black/40 px-3 py-1 text-[11px] text-neutral-100 hover:bg-black/70"
          >
            <span>‚Üê</span>
            <span className="uppercase tracking-[0.16em]">Back</span>
          </button>
          <div className="flex-1 truncate px-2 text-center text-[11px] font-medium">
            {line ? (
              <span className={chip(line.status ?? null)}>{titleText}</span>
            ) : (
              "Job"
            )}
          </div>
          {workOrder?.id ? (
            <button
              type="button"
              className="rounded-full border border-[var(--accent-copper-light)] bg-[var(--accent-copper-soft)] px-3 py-1.5 text-[11px] font-semibold text-black shadow-[0_0_12px_rgba(248,113,22,0.35)] hover:bg-[var(--accent-copper-light)]"
              onClick={() => {
                closeAllSubModals();
                setOpenAddJob(true);
              }}
              disabled={busy}
            >
              + Job
            </button>
          ) : (
            <div className="w-14" />
          )}
        </header>

        {/* Body */}
        <main className="mobile-body-gradient flex-1 overflow-y-auto px-3 py-3">
          <div className="mx-auto max-w-xl space-y-4">
            {busy && !line ? (
              <div className="grid gap-3">
                <div className="h-6 w-40 animate-pulse rounded-full bg-white/5" />
                <div className="h-24 animate-pulse rounded-2xl bg-white/5" />
              </div>
            ) : !line ? (
              <div className="glass-card text-sm text-neutral-300">
                No job found.
              </div>
            ) : (
              <>
                {/* meta info */}
                <div className="grid gap-2 sm:grid-cols-2">
                  <div className="glass-card p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Status
                    </div>
                    <div
                      className={`mt-1 text-sm font-semibold ${chip(
                        line.status ?? null,
                      )}`}
                    >
                      {String(line.status || "awaiting").replaceAll("_", " ")}
                    </div>
                  </div>
                  <div className="glass-card p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Start
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {createdStart}
                    </div>
                  </div>
                  <div className="glass-card p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Finish
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {createdFinish}
                    </div>
                  </div>
                  <div className="glass-card p-3">
                    <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                      Hold Reason
                    </div>
                    <div className="mt-1 text-sm text-neutral-100">
                      {line.hold_reason ?? "‚Äî"}
                    </div>
                  </div>
                </div>

                {/* vehicle & customer */}
                <div className="glass-card p-3 text-sm">
                  <div className="grid gap-3 sm:grid-cols-2">
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Vehicle
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {vehicle
                          ? `${vehicle.year ?? ""} ${vehicle.make ?? ""} ${
                              vehicle.model ?? ""
                            }`
                              .trim()
                              .replace(/\s+/g, " ") || "‚Äî"
                          : "‚Äî"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        VIN: {vehicle?.vin ?? "‚Äî"} ‚Ä¢ Plate:{" "}
                        {vehicle?.license_plate ?? "‚Äî"}
                      </div>
                    </div>
                    <div>
                      <div className="text-[11px] uppercase tracking-[0.18em] text-neutral-400">
                        Customer
                      </div>
                      <div className="mt-1 truncate text-neutral-100">
                        {customer
                          ? [customer.first_name ?? "", customer.last_name ?? ""]
                              .filter(Boolean)
                              .join(" ") || "‚Äî"
                          : "‚Äî"}
                      </div>
                      <div className="mt-0.5 text-[11px] text-neutral-400">
                        {customer?.phone ?? "‚Äî"}{" "}
                        {customer?.email ? `‚Ä¢ ${customer.email}` : ""}
                      </div>
                    </div>
                  </div>
                </div>

                {/* punch ‚Äî hide once completed */}
                {mode === "tech" && line && line.status !== "completed" && (
                  <div className="glass-card p-3">
                    <JobPunchButton
                      lineId={line.id}
                      punchedInAt={line.punched_in_at}
                      punchedOutAt={line.punched_out_at}
                      status={line.status as WorkflowStatus}
                      onFinishRequested={() => {
                        closeAllSubModals();
                        setPrefillCause(line.cause ?? "");
                        setPrefillCorrection(line.correction ?? "");
                        setOpenComplete(true);
                      }}
                      onUpdated={refresh}
                      disabled={
                        busy ||
                        line.status === "awaiting_approval" ||
                        line.status === "declined" ||
                        (!!line.approval_state &&
                          line.approval_state !== "approved")
                      }
                    />
                    {(line.status === "awaiting_approval" ||
                      (line.approval_state &&
                        line.approval_state !== "approved") ||
                      line.status === "declined") && (
                      <div className="mt-2 text-[11px] text-amber-300">
                        {line.status === "awaiting_approval"
                          ? "Awaiting approval ‚Äî punching disabled"
                          : line.status === "declined"
                          ? "Declined ‚Äî punching disabled"
                          : "Not approved ‚Äî punching disabled"}
                      </div>
                    )}
                  </div>
                )}

                {/* controls */}
                <div className="grid gap-2 sm:grid-cols-2">
                  {mode === "tech" ? (
                    <>
                      <button
                        type="button"
                        className={btnAccent}
                        onClick={() => {
                          closeAllSubModals();
                          setPrefillCause(line?.cause ?? "");
                          setPrefillCorrection(line?.correction ?? "");
                          setOpenComplete(true);
                        }}
                        disabled={busy}
                      >
                        Complete (Cause / Correction)
                      </button>

                      <button
                        type="button"
                        className={btnDanger}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenParts(true);
                        }}
                        disabled={busy}
                      >
                        Request Parts
                      </button>

                      <button
                        type="button"
                        className={btnWarn}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenHold(true);
                        }}
                        disabled={busy}
                      >
                        {line.status === "on_hold" ? "On Hold" : "Hold"}
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenPhoto(true);
                        }}
                        disabled={busy}
                      >
                        Add Photo
                      </button>

                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>

                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>
                    </>
                  ) : (
                    <>
                      <button
                        type="button"
                        className={btnNeutral}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenChat(true);
                        }}
                      >
                        Chat
                      </button>
                      <button
                        type="button"
                        className={btnInfo}
                        onClick={() => {
                          closeAllSubModals();
                          setOpenAi(true);
                        }}
                      >
                        AI Assist
                      </button>
                    </>
                  )}
                </div>

                {/* parts used */}
                <div className="glass-card p-3">
                  <div className="mb-2 text-sm font-medium text-neutral-100">
                    Parts used
                  </div>

                  {allocsLoading ? (
                    <div className="text-sm text-neutral-300">Loading‚Ä¶</div>
                  ) : allocs.length === 0 ? (
                    <div className="text-sm text-neutral-300">
                      No parts used yet.
                    </div>
                  ) : (
                    <div className="overflow-hidden rounded-xl border border-white/10 bg-black/40">
                      <div className="grid grid-cols-12 bg-white/5 px-3 py-2 text-[11px] uppercase tracking-[0.16em] text-neutral-400">
                        <div className="col-span-7">Part</div>
                        <div className="col-span-3">Location</div>
                        <div className="col-span-2 text-right">Qty</div>
                      </div>
                      <ul className="max-h-56 overflow-auto divide-y divide-white/5">
                        {allocs.map((a) => (
                          <li
                            key={a.id}
                            className="grid grid-cols-12 items-center px-3 py-2 text-sm"
                          >
                            <div className="col-span-7 truncate text-neutral-100">
                              {a.parts?.name ?? "Part"}
                            </div>
                            <div className="col-span-3 truncate text-neutral-400">
                              {a.location_id
                                ? `loc ${String(a.location_id).slice(0, 6)}‚Ä¶`
                                : "‚Äî"}
                            </div>
                            <div className="col-span-2 text-right font-semibold text-neutral-100">
                              {a.qty}
                            </div>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                {/* tech notes */}
                <div className="glass-card p-3">
                  <label className="mb-1 block text-sm font-medium text-neutral-100">
                    Tech Notes
                  </label>
                  <textarea
                    rows={4}
                    value={techNotes}
                    onChange={(e) => setTechNotes(e.target.value)}
                    onBlur={saveNotes}
                    disabled={savingNotes}
                    className="w-full rounded-md border border-white/15 bg-black/40 px-3 py-2 text-sm text-white placeholder:text-neutral-400 focus:border-[var(--accent-copper-light)] focus:outline-none focus:ring-2 focus:ring-[var(--accent-copper-light)]"
                    placeholder="Add notes for this job‚Ä¶"
                  />
                </div>

                {/* AI suggestions */}
                <div className="glass-card p-3">
                  <h3 className="mb-2 text-sm font-medium text-neutral-100">
                    AI Suggested Repairs
                  </h3>
                  {line && workOrder ? (
                    <SuggestedQuickAdd
                      jobId={line.id}
                      workOrderId={workOrder.id}
                      vehicleId={vehicle?.id ?? null}
                      onAdded={async () => {
                        toast.success("Suggested line added");
                        await refresh();
                      }}
                    />
                  ) : (
                    <div className="text-sm text-neutral-300">
                      Vehicle/work order details required.
                    </div>
                  )}
                </div>

                <div className="pb-16 text-[11px] text-neutral-400">
                  Job ID: {line.id}
                  {typeof line.labor_time === "number"
                    ? ` ‚Ä¢ Labor: ${line.labor_time.toFixed(1)}h`
                    : ""}
                  {line.hold_reason ? ` ‚Ä¢ Hold: ${line.hold_reason}` : ""}
                  {line.approval_state
                    ? ` ‚Ä¢ Approval: ${line.approval_state}`
                    : ""}
                </div>
              </>
            )}
          </div>
        </main>
      </div>

      {/* sub-modals */}
      {openComplete && line && (
        <CauseCorrectionModal
          isOpen={openComplete}
          onClose={() => setOpenComplete(false)}
          jobId={line.id}
          initialCause={prefillCause}
          initialCorrection={prefillCorrection}
          onSubmit={async (cause: string, correction: string) => {
            const { error } = await supabase
              .from("work_order_lines")
              .update({
                cause,
                correction,
                punched_out_at: new Date().toISOString(),
                status: "completed",
              } as DB["public"]["Tables"]["work_order_lines"]["Update"])
              .eq("id", line.id);
            if (error) return showErr("Complete job failed", error);
            toast.success("Job completed");
            setOpenComplete(false);
            await refresh();
          }}
        />
      )}

      {openParts && workOrder?.id && line && (
        <PartsRequestModal
          isOpen={openParts}
          workOrderId={workOrder.id}
          jobId={line.id}
          requestNote={line.description ?? ""}
        />
      )}

      {openHold && line && (
        <HoldModal
          isOpen={openHold}
          onClose={() => setOpenHold(false)}
          onApply={applyHold}
          onRelease={line.hold_reason ? releaseHold : undefined}
          canRelease={!!line.hold_reason}
          defaultReason={line.hold_reason || "Awaiting parts"}
        />
      )}

      {openPhoto && (
        <PhotoCaptureModal
          isOpen={openPhoto}
          onClose={() => setOpenPhoto(false)}
          onCapture={uploadPhoto}
        />
      )}

      {openChat && (
        <NewChatModal
          isOpen={openChat}
          onClose={() => setOpenChat(false)}
          created_by="system"
          onCreated={() => setOpenChat(false)}
          context_type="work_order_line"
          context_id={line?.id ?? null}
        />
      )}

      {openAi && (
        <AIAssistantModal
          isOpen={openAi}
          onClose={() => setOpenAi(false)}
          workOrderLineId={line?.id ?? undefined}
          defaultVehicle={
            vehicle
              ? {
                  year: vehicle.year ? String(vehicle.year) : undefined,
                  make: vehicle.make ?? undefined,
                  model: vehicle.model ?? undefined,
                }
              : undefined
          }
        />
      )}

      {openAddJob && workOrder?.id && (
        <AddJobModal
          isOpen={openAddJob}
          onClose={() => setOpenAddJob(false)}
          workOrderId={workOrder.id}
          vehicleId={vehicle?.id ?? null}
          techId={line?.assigned_to || "system"}
          shopId={workOrder?.shop_id ?? null}
          onJobAdded={async () => {
            await refresh();
            setOpenAddJob(false);
          }}
        />
      )}
    </>
  );
}

========================================
FILE: features/work-orders/mobile/MobileJobCard.tsx
========================================
"use client";

import { useEffect, useState } from "react";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export type WorkOrderLine =
  DB["public"]["Tables"]["work_order_lines"]["Row"];

export type AllocationRow =
  DB["public"]["Tables"]["work_order_part_allocations"]["Row"] & {
    parts?: { name: string | null } | null;
  };

export type TechnicianInfo = {
  id: string;
  full_name: string | null;
  role: string | null;
};

export type JobCardPricing = {
  partsTotal?: number | null;
  laborTotal?: number | null;
  lineTotal?: number | null;
  currency?: string; // e.g. "CAD", "USD"
};

export type JobCardProps = {
  index: number;
  line: WorkOrderLine;
  parts: AllocationRow[];
  technicians: TechnicianInfo[];
  canAssign?: boolean;
  isPunchedIn?: boolean;
  onOpen: () => void;
  onAssign?: () => void;
  onOpenInspection?: () => void;
  onAddPart?: () => void; // kept for compatibility, not used in this mobile card
  /** Optional pricing info ‚Äì we‚Äôll wire this from the page later */
  pricing?: JobCardPricing;
};

/* ---------------------------- Status visuals ---------------------------- */

type KnownStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

/** Status pill styling (matches WO header pills) */
const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded border px-2 py-0.5 text-[10px] font-medium tracking-wide";

const BADGE: Record<KnownStatus, string> = {
  awaiting_approval: "bg-blue-900/20 border-blue-500/40 text-blue-300",
  awaiting: "bg-sky-900/20 border-sky-500/40 text-sky-300",
  queued: "bg-indigo-900/20 border-indigo-500/40 text-indigo-300",
  in_progress: "bg-orange-900/20 border-orange-500/40 text-orange-300",
  on_hold: "bg-amber-900/20 border-amber-500/40 text-amber-300",
  planned: "bg-purple-900/20 border-purple-500/40 text-purple-300",
  new: "bg-neutral-800 border-neutral-600 text-neutral-200",
  completed: "bg-green-900/20 border-green-500/40 text-green-300",
  ready_to_invoice:
    "bg-emerald-900/20 border-emerald-500/40 text-emerald-300",
  invoiced: "bg-teal-900/20 border-teal-500/40 text-teal-300",
};

const statusChip = (s: string | null | undefined): string => {
  const key = (s ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;
  return `${BASE_BADGE} ${BADGE[key] ?? BADGE.awaiting}`;
};

/**
 * Card border / background styles ‚Äì kept in sync with the mobile WO client
 */
const CARD_SURFACE: Record<
  KnownStatus,
  { border: string; surface: string; ring: string }
> = {
  awaiting_approval: {
    border: "border-sky-500/50",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.10),rgba(15,23,42,0.98))]",
    ring: "ring-sky-400/70",
  },
  awaiting: {
    border: "border-slate-600/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(148,163,184,0.12),rgba(15,23,42,0.98))]",
    ring: "ring-slate-300/80",
  },
  queued: {
    border: "border-indigo-500/70",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(129,140,248,0.12),rgba(15,23,42,0.98))]",
    ring: "ring-indigo-400/80",
  },
  in_progress: {
    border: "border-[color:var(--accent-copper-soft)]",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.20),rgba(15,23,42,0.98))]",
    ring: "ring-[color:var(--accent-copper-soft)]/80",
  },
  on_hold: {
    border: "border-amber-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(251,191,36,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-amber-300/80",
  },
  planned: {
    border: "border-purple-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(192,132,252,0.16),rgba(15,23,42,0.98))]",
    ring: "ring-purple-300/80",
  },
  new: {
    border: "border-neutral-600/80",
    surface: "bg-neutral-950/90",
    ring: "ring-neutral-400/80",
  },
  completed: {
    border: "border-teal-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-teal-300/80",
  },
  ready_to_invoice: {
    border: "border-emerald-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-emerald-300/80",
  },
  invoiced: {
    border: "border-teal-400/80",
    surface:
      "bg-[radial-gradient(circle_at_top,_rgba(45,212,191,0.18),rgba(15,23,42,0.97))]",
    ring: "ring-teal-300/80",
  },
};

export function JobCard({
  index,
  line,
  technicians,
  canAssign,
  isPunchedIn,
  onOpen,
  onAssign,
  onOpenInspection,
  pricing,
}: JobCardProps): JSX.Element {
  const statusKey = (line.status ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;

  const surfaceCfg = CARD_SURFACE[statusKey] ?? CARD_SURFACE.awaiting;

  const isCompletedLike = () => {
    const s = (line.status ?? "").toLowerCase();
    return s === "completed" || s === "ready_to_invoice" || s === "invoiced";
  };

  // Completed / invoiced jobs start collapsed
  const [collapsed, setCollapsed] = useState<boolean>(isCompletedLike());

  // If status changes (e.g. job finished), update collapsed state
  useEffect(() => {
    setCollapsed(isCompletedLike());
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [line.status]);

  const jobLabel =
    line.description || line.complaint || "Untitled job";

  const laborText =
    typeof line.labor_time === "number"
      ? `${line.labor_time}h`
      : "‚Äî";

  const jobTypeText = String(line.job_type ?? "job").replaceAll(
    "_",
    " ",
  );
  const statusText = String(line.status ?? "awaiting").replaceAll(
    "_",
    " ",
  );

  const showPricingRow =
    pricing &&
    (pricing.partsTotal != null ||
      pricing.laborTotal != null ||
      pricing.lineTotal != null);

  const currency =
    pricing?.currency && pricing.currency.trim().length > 0
      ? pricing.currency
      : undefined;

  const formatMoney = (v: number | null | undefined): string => {
    if (v == null || Number.isNaN(v)) return "‚Äî";
    const n = Number(v);
    return `${currency ?? "$"}${n.toFixed(2)}`;
  };

  const handleCardClick = () => {
    // Always open job; completed jobs will show details in modal anyway
    if (isCompletedLike()) {
      setCollapsed(false);
    }
    onOpen();
  };

  return (
    <div
      className={`group cursor-pointer rounded-xl border ${surfaceCfg.border} ${surfaceCfg.surface} p-3 transition
        shadow-[0_18px_45px_rgba(0,0,0,0.85)]
        hover:shadow-[0_22px_55px_rgba(0,0,0,0.95)]
        ${isPunchedIn ? `ring-2 ${surfaceCfg.ring}` : "ring-0"}
      `}
      title="Open focused job"
      onClick={handleCardClick}
    >
      <div className="flex items-start justify-between gap-3">
        {/* LEFT CONTENT */}
        <div className="min-w-0 space-y-1.5">
          {/* Top row: title + controls */}
          <div className="flex flex-wrap items-center gap-2">
            {/* Left side: title + assign + inspection */}
            <div className="flex min-w-0 flex-1 flex-wrap items-center gap-2">
              <div className="truncate text-sm font-medium text-white">
                {index + 1}. {jobLabel}
              </div>

              {canAssign && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onAssign?.();
                  }}
                  className="rounded-md border border-sky-500/70 px-2 py-0.5 text-[11px] font-medium text-sky-200 hover:bg-sky-900/25"
                  title="Assign mechanic to this line"
                >
                  Assign mechanic
                </button>
              )}

              {line.job_type === "inspection" && (
                <button
                  type="button"
                  onClick={(e) => {
                    e.stopPropagation();
                    onOpenInspection?.();
                  }}
                  className={`rounded-md border px-2 py-0.5 text-[11px] font-medium ${
                    isCompletedLike()
                      ? "border-teal-400 text-teal-200"
                      : "border-orange-400 text-orange-200 hover:bg-orange-500/10"
                  }`}
                >
                  {isCompletedLike()
                    ? "View inspection"
                    : "Open inspection"}
                </button>
              )}
            </div>

            {/* Right side: status pill only (no parts UI on mobile) */}
            <div className="ml-auto flex items-center gap-2">
              <span className={statusChip(line.status)}>
                {statusText}
              </span>
            </div>
          </div>

          {/* Meta line */}
          <div className="text-[11px] text-neutral-300">
            {jobTypeText} ‚Ä¢ {laborText} ‚Ä¢ Status: {statusText}
          </div>

          {/* Completed jobs: small ‚Äútap to expand‚Äù hint */}
          {isCompletedLike() && (
            <div className="text-[10px] text-teal-200/80">
              {collapsed
                ? "Completed job ‚Äì tap to view details."
                : "Completed job ‚Äì tap header to collapse."}
            </div>
          )}

          {/* Everything below here can be collapsed for completed / invoiced lines */}
          {!collapsed && (
            <>
              {/* Technician chips */}
              {technicians.length > 0 && (
                <div className="mt-0.5 flex flex-wrap gap-1">
                  {technicians.map((tech) => (
                    <span
                      key={tech.id}
                      className="inline-flex items-center gap-1 rounded-full bg-sky-900/40 px-2 py-0.5 text-[10px] text-sky-100"
                    >
                      <span className="h-1.5 w-1.5 rounded-full bg-sky-300" />
                      {tech.full_name ?? "Mechanic"}
                    </span>
                  ))}
                </div>
              )}

              {/* Complaint / cause / correction */}
              {(line.complaint || line.cause || line.correction) && (
                <div className="mt-0.5 flex flex-wrap items-center gap-2 text-[11px] text-neutral-300">
                  {line.complaint && <span>Cmpl: {line.complaint}</span>}
                  {line.cause && <span>| Cause: {line.cause}</span>}
                  {line.correction && (
                    <span>| Corr: {line.correction}</span>
                  )}
                </div>
              )}

              {/* Pricing summary row (optional, only if provided) */}
              {showPricingRow && (
                <div className="mt-2 flex flex-wrap items-center justify-end gap-3 text-[11px] text-neutral-300">
                  {pricing?.partsTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Parts</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.partsTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.laborTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Labor</span>
                      <span className="font-semibold">
                        {formatMoney(pricing.laborTotal)}
                      </span>
                    </span>
                  )}
                  {pricing?.lineTotal != null && (
                    <span className="flex items-center gap-1">
                      <span className="text-neutral-400">Line total</span>
                      <span className="font-semibold text-[color:var(--accent-copper-light)]">
                        {formatMoney(pricing.lineTotal)}
                      </span>
                    </span>
                  )}
                </div>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/mobile/MobileJobLineAdd.tsx
========================================
// features/work-orders/mobile/MobileJobLineAdd.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import NewWorkOrderLineForm from "@/features/work-orders/components/NewWorkOrderLineForm";

type DB = Database;

type JobType = "diagnosis" | "inspection" | "maintenance" | "repair";

type Props = {
  workOrderId: string | null;
  vehicleId: string | null;
  defaultJobType?: JobType;
  onCreated?: () => void;
};

export function MobileJobLineAdd({
  workOrderId,
  vehicleId,
  defaultJobType = "diagnosis",
  onCreated,
}: Props) {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const [shopId, setShopId] = useState<string | null>(null);

  // look up shop_id from the work order once
  useEffect(() => {
    if (!workOrderId) return;

    (async () => {
      const { data } = await supabase
        .from("work_orders")
        .select("shop_id")
        .eq("id", workOrderId)
        .maybeSingle();

      setShopId(data?.shop_id ?? null);
    })();
  }, [supabase, workOrderId]);

  if (!workOrderId) {
    return null;
  }

  return (
    <div className="space-y-2">
      <div className="text-[0.7rem] uppercase tracking-[0.16em] text-neutral-500">
        Add job line
      </div>
      <NewWorkOrderLineForm
        workOrderId={workOrderId}
        vehicleId={vehicleId}
        defaultJobType={defaultJobType}
        shopId={shopId}
        onCreated={onCreated}
      />
    </div>
  );
}

========================================
FILE: features/work-orders/mobile/MobileWorkOrderClient.tsx
========================================
"use client";

import {
  useCallback,
  useEffect,
  useMemo,
  useState,
  type JSX,
} from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { format } from "date-fns";
import { toast } from "sonner";

import { supabaseBrowser as supabase } from "@/features/shared/lib/supabase/client";
import type { Database } from "@shared/types/types/supabase";

import PreviousPageButton from "@shared/components/ui/PreviousPageButton";
import VoiceContextSetter from "@/features/shared/voice/VoiceContextSetter";
import VoiceButton from "@/features/shared/voice/VoiceButton";
import { useTabState } from "@/features/shared/hooks/useTabState";
import { JobCard } from "@/features/work-orders/mobile/MobileJobCard";
import MobileFocusedJob from "@/features/work-orders/mobile/MobileFocusedJob";

type DB = Database;
type WorkOrder = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLine = DB["public"]["Tables"]["work_order_lines"]["Row"];
type Vehicle = DB["public"]["Tables"]["vehicles"]["Row"];
type Customer = DB["public"]["Tables"]["customers"]["Row"];
type WorkOrderQuoteLine =
  DB["public"]["Tables"]["work_order_quote_lines"]["Row"];
type WorkOrderQuoteLineWithLineId = WorkOrderQuoteLine & {
  work_order_line_id?: string | null;
};

// üîπ Extra metadata shape for inspection template ids (mirrors desktop logic)
type WorkOrderLineWithInspectionMeta = WorkOrderLine & {
  inspection_template_id?: string | null;
  inspection_template?: string | null;
  inspectionTemplate?: string | null;
  template?: string | null;
  metadata?: {
    inspection_template?: string | null;
    template?: string | null;
  } | null;
  metadata2?: {
    inspection_template?: string | null;
    template?: string | null;
  } | null;
};

const looksLikeUuid = (s: string) => s.includes("-") && s.length >= 36;

function splitCustomId(raw: string): { prefix: string; n: number | null } {
  const m = raw.toUpperCase().match(/^([A-Z]+)\s*0*?(\d+)?$/);
  if (!m) return { prefix: raw.toUpperCase(), n: null };
  const n = m[2] ? parseInt(m[2], 10) : null;
  return { prefix: m[1], n: Number.isFinite(n!) ? n : null };
}

// üîπ Desktop-style helper for finding the inspection template id on a line
function extractInspectionTemplateId(
  ln: WorkOrderLineWithInspectionMeta,
): string | null {
  return (
    ln.inspection_template_id ??
    ln.inspection_template ??
    ln.inspectionTemplate ??
    ln.template ??
    ln.metadata?.inspection_template ??
    ln.metadata?.template ??
    ln.metadata2?.inspection_template ??
    ln.metadata2?.template ??
    null
  );
}

/* ---------------------------- Badges (WO header) ---------------------------- */

type KnownStatus =
  | "awaiting_approval"
  | "awaiting"
  | "queued"
  | "in_progress"
  | "on_hold"
  | "planned"
  | "new"
  | "completed"
  | "ready_to_invoice"
  | "invoiced";

const BASE_BADGE =
  "inline-flex items-center whitespace-nowrap rounded-full border px-2.5 py-0.5 text-[10px] font-medium tracking-wide";

const BADGE: Record<KnownStatus, string> = {
  awaiting_approval:
    "bg-sky-900/30 border-sky-400/60 text-sky-200 shadow-[0_0_18px_rgba(56,189,248,0.35)]",
  awaiting:
    "bg-slate-900/40 border-slate-400/60 text-slate-200 shadow-[0_0_18px_rgba(148,163,184,0.25)]",
  queued:
    "bg-indigo-900/30 border-indigo-400/70 text-indigo-200 shadow-[0_0_18px_rgba(129,140,248,0.40)]",
  in_progress:
    "bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.32),rgba(15,23,42,0.9))] border-[color:var(--accent-copper-soft)] text-[color:var(--accent-copper-light)] shadow-[0_0_20px_rgba(248,113,22,0.50)]",
  on_hold:
    "bg-amber-950/40 border-amber-400/70 text-amber-200 shadow-[0_0_18px_rgba(251,191,36,0.35)]",
  planned:
    "bg-purple-950/40 border-purple-400/70 text-purple-200 shadow-[0_0_18px_rgba(147,51,234,0.40)]",
  new:
    "bg-neutral-900/80 border-neutral-500/70 text-neutral-200 shadow-[0_0_14px_rgba(148,163,184,0.28)]",
  completed:
    "bg-emerald-950/50 border-emerald-400/70 text-emerald-200 shadow-[0_0_20px_rgba(16,185,129,0.55)]",
  ready_to_invoice:
    "bg-emerald-950/40 border-emerald-400/80 text-emerald-200 shadow-[0_0_20px_rgba(16,185,129,0.55)]",
  invoiced:
    "bg-teal-950/40 border-teal-400/80 text-teal-200 shadow-[0_0_20px_rgba(45,212,191,0.55)]",
};

const chip = (s: string | null | undefined): string => {
  const key = (s ?? "awaiting")
    .toLowerCase()
    .replaceAll(" ", "_") as KnownStatus;
  return `${BASE_BADGE} ${BADGE[key] ?? BADGE.awaiting}`;
};

/* ------------------------ Line status ‚Üí card styles ------------------------ */

type LineRollupStatus = "awaiting" | "in_progress" | "on_hold" | "completed";

const LINE_STATUS_LABELS: Record<LineRollupStatus, string> = {
  awaiting: "Awaiting",
  in_progress: "In progress",
  on_hold: "On hold",
  completed: "Completed",
};

const LINE_CARD_STYLES: Record<LineRollupStatus, string> = {
  awaiting:
    "border-slate-700 bg-neutral-950/80 hover:border-orange-400/70",
  in_progress:
    "border-emerald-500 bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.22),rgba(15,23,42,0.96))] shadow-[0_0_26px_rgba(16,185,129,0.70)]",
  on_hold:
    "border-amber-500 bg-[radial-gradient(circle_at_top,_rgba(251,191,36,0.16),rgba(15,23,42,0.98))]",
  completed:
    "border-sky-500 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.16),rgba(15,23,42,0.97))]",
};

const LINE_PILL_STYLES: Record<LineRollupStatus, string> = {
  awaiting:
    "border-slate-500 bg-slate-900/80 text-slate-200",
  in_progress:
    "border-emerald-400 bg-emerald-500/20 text-emerald-100 shadow-[0_0_20px_rgba(16,185,129,0.9)]",
  on_hold:
    "border-amber-400 bg-amber-500/15 text-amber-100",
  completed:
    "border-sky-400 bg-sky-500/15 text-sky-100",
};

function toLineBucket(status: string | null | undefined): LineRollupStatus {
  const s = (status ?? "").toLowerCase();
  if (s === "in_progress") return "in_progress";
  if (s === "on_hold") return "on_hold";
  if (s === "completed" || s === "ready_to_invoice" || s === "invoiced") {
    return "completed";
  }
  return "awaiting";
}

// roles allowed to approve / decline
const APPROVAL_ROLES = new Set([
  "owner",
  "admin",
  "manager",
  "advisor",
  "lead_hand",
  "lead",
  "leadhand",
]);

/* ------------------------------------------------------------------------- */

export default function MobileWorkOrderClient({
  routeId,
}: {
  routeId: string;
}): JSX.Element {
  const router = useRouter();

  const [wo, setWo] = useTabState<WorkOrder | null>("m:wo:id:wo", null);
  const [lines, setLines] = useTabState<WorkOrderLine[]>(
    "m:wo:id:lines",
    [],
  );
  const [quoteLines, setQuoteLines] = useTabState<WorkOrderQuoteLine[]>(
    "m:wo:id:quoteLines",
    [],
  );
  const [vehicle, setVehicle] = useTabState<Vehicle | null>(
    "m:wo:id:veh",
    null,
  );
  const [customer, setCustomer] = useTabState<Customer | null>(
    "m:wo:id:cust",
    null,
  );

  const [loading, setLoading] = useState<boolean>(false);
  const [viewError, setViewError] = useState<string | null>(null);

  const [techNamesById, setTechNamesById] = useState<Record<string, string>>(
    {},
  );

  const [currentUserId, setCurrentUserId] = useTabState<string | null>(
    "m:wo:id:uid",
    null,
  );
  const [, setUserId] = useTabState<string | null>(
    "m:wo:id:effectiveUid",
    null,
  );
  const [currentUserRole, setCurrentUserRole] = useState<string | null>(null);

  const [showDetails, setShowDetails] = useTabState<boolean>(
    "m:wo:showDetails",
    true,
  );
  const [warnedMissing, setWarnedMissing] = useState(false);

  // mobile focused job view
  const [focusedJobId, setFocusedJobId] = useState<string | null>(null);
  const [focusedOpen, setFocusedOpen] = useState(false);

  /* ---------------------- AUTH ---------------------- */
  useEffect(() => {
    let mounted = true;

    const waitForSession = async () => {
      let {
        data: { session },
      } = await supabase.auth.getSession();

      if (!session) {
        for (let i = 0; i < 8; i++) {
          await new Promise((r) => setTimeout(r, 150 * (i + 1)));
          const res = await supabase.auth.getSession();
          session = res.data.session;
          if (session) break;
        }
      }

      const {
        data: { user },
      } = await supabase.auth.getUser();
      if (!mounted) return;

      const uid = user?.id ?? null;
      setCurrentUserId(uid);
      setUserId(uid);

      if (uid) {
        const { data: prof } = await supabase
          .from("profiles")
          .select("role")
          .eq("id", uid)
          .maybeSingle();
        setCurrentUserRole(prof?.role ?? null);
      }

      if (!uid) setLoading(false);
    };

    void waitForSession();

    const { data: sub } = supabase.auth.onAuthStateChange((_evt, s) => {
      if (s?.user) void waitForSession();
      else {
        setCurrentUserId(null);
        setUserId(null);
        setLoading(false);
      }
    });

    return () => {
      mounted = false;
      sub?.subscription?.unsubscribe?.();
    };
  }, [routeId, setCurrentUserId, setUserId]);

  /* ---------------------- FETCH ---------------------- */
  const fetchAll = useCallback(
    async (retry = 0) => {
      if (!routeId) return;
      setLoading(true);
      setViewError(null);

      try {
        let woRow: WorkOrder | null = null;

        // by UUID
        if (looksLikeUuid(routeId)) {
          const { data, error } = await supabase
            .from("work_orders")
            .select("*")
            .eq("id", routeId)
            .maybeSingle();
          if (!error) woRow = (data as WorkOrder | null) ?? null;
        }

        // by custom_id
        if (!woRow) {
          const eqRes = await supabase
            .from("work_orders")
            .select("*")
            .eq("custom_id", routeId)
            .maybeSingle();
          woRow = (eqRes.data as WorkOrder | null) ?? null;

          if (!woRow) {
            const ilikeRes = await supabase
              .from("work_orders")
              .select("*")
              .ilike("custom_id", routeId.toUpperCase())
              .maybeSingle();
            woRow = (ilikeRes.data as WorkOrder | null) ?? null;
          }

          if (!woRow) {
            const { prefix, n } = splitCustomId(routeId);
            if (n !== null) {
              const { data: cands } = await supabase
                .from("work_orders")
                .select("*")
                .ilike("custom_id", `${prefix}%`)
                .limit(50);
              const wanted = `${prefix}${n}`;
              const match = (cands ?? []).find(
                (r) =>
                  (r.custom_id ?? "")
                    .toUpperCase()
                    .replace(/^([A-Z]+)0+/, "$1") === wanted,
              );
              if (match) woRow = match as WorkOrder;
            }
          }
        }

        if (!woRow) {
          if (retry < 2) {
            await new Promise((r) => setTimeout(r, 200 * Math.pow(2, retry)));
            return fetchAll(retry + 1);
          }
          setViewError("Work order not visible / not found.");
          setWo(null);
          setLines([]);
          setQuoteLines([]);
          setVehicle(null);
          setCustomer(null);
          setLoading(false);
          return;
        }

        setWo(woRow);

        if (!warnedMissing && (!woRow.vehicle_id || !woRow.customer_id)) {
          toast.error(
            "This work order is missing vehicle and/or customer. Open the Create form to set them.",
          );
          setWarnedMissing(true);
        }

        const [linesRes, vehRes, custRes, quotesRes] = await Promise.all([
          supabase
            .from("work_order_lines")
            .select("*")
            .eq("work_order_id", woRow.id)
            .order("created_at", { ascending: true }),
          woRow.vehicle_id
            ? supabase
                .from("vehicles")
                .select("*")
                .eq("id", woRow.vehicle_id)
                .maybeSingle()
            : Promise.resolve({ data: null, error: null } as const),
          woRow.customer_id
            ? supabase
                .from("customers")
                .select("*")
                .eq("id", woRow.customer_id)
                .maybeSingle()
            : Promise.resolve({ data: null, error: null } as const),
          supabase
            .from("work_order_quote_lines")
            .select("*")
            .eq("work_order_id", woRow.id)
            .order("created_at", { ascending: true }),
        ]);

        if (linesRes.error) throw linesRes.error;
        const lineRows = (linesRes.data ?? []) as WorkOrderLine[];
        setLines(lineRows);

        // üîπ populate tech names from assigned_to
        const techIds = Array.from(
          new Set(
            lineRows
              .map((ln) => ln.assigned_to)
              .filter((id): id is string => Boolean(id)),
          ),
        );

        if (techIds.length > 0) {
          const { data: techProfiles, error: techErr } = await supabase
            .from("profiles")
            .select("id, full_name")
            .in("id", techIds);

          if (!techErr && techProfiles) {
            const map: Record<string, string> = {};
            techProfiles.forEach((p) => {
              map[p.id] = p.full_name ?? "Technician";
            });
            setTechNamesById(map);
          } else {
            setTechNamesById({});
          }
        } else {
          setTechNamesById({});
        }

        if (quotesRes.error) throw quotesRes.error;
        setQuoteLines(
          (quotesRes.data as WorkOrderQuoteLine[] | null) ?? [],
        );

        if (vehRes?.error) throw vehRes.error;
        setVehicle((vehRes?.data as Vehicle | null) ?? null);

        if (custRes?.error) throw custRes.error;
        setCustomer((custRes?.data as Customer | null) ?? null);
      } catch (e: unknown) {
        const msg =
          e instanceof Error ? e.message : "Failed to load work order.";
        setViewError(msg);
        // eslint-disable-next-line no-console
        console.error("[Mobile WO id page] load error:", e);
      } finally {
        setLoading(false);
      }
    },
    [
      routeId,
      warnedMissing,
      setWo,
      setLines,
      setQuoteLines,
      setVehicle,
      setCustomer,
      setTechNamesById,
    ],
  );

  useEffect(() => {
    if (!routeId || !currentUserId) return;
    void fetchAll();
  }, [fetchAll, routeId, currentUserId]);

  /* ---------------------- REALTIME ---------------------- */
  useEffect(() => {
    if (!wo?.id) return;

    const ch = supabase
      .channel(`m:wo:${wo.id}`)
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_orders",
          filter: `id=eq.${wo.id}`,
        },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => fetchAll(),
      )
      .on(
        "postgres_changes",
        {
          event: "*",
          schema: "public",
          table: "work_order_quote_lines",
          filter: `work_order_id=eq.${wo.id}`,
        },
        () => fetchAll(),
      )
      .subscribe();

    return () => {
      try {
        supabase.removeChannel(ch);
      } catch {
        //
      }
    };
  }, [wo?.id, fetchAll]);

  // üîÅ refresh when a parts request or inspection completes
  useEffect(() => {
    const handleParts = () => {
      void fetchAll();
    };
    const handleInspectionCompleted = (
      ev: CustomEvent<{
        workOrderLineId?: string;
        cause?: string;
        correction?: string;
      }>,
    ) => {
      const d = ev.detail || {};
      const lineId = d.workOrderLineId;
      if (!lineId) return;

      setFocusedJobId(lineId);
      setFocusedOpen(true);

      // legacy event for desktop flow ‚Äì harmless if unused on mobile
      window.dispatchEvent(
        new CustomEvent("wo:prefill-cause-correction", {
          detail: {
            lineId,
            cause: d.cause ?? "",
            correction: d.correction ?? "",
          },
        }),
      );
    };

    window.addEventListener("parts-request:submitted", handleParts);
    window.addEventListener(
      "inspection:completed",
      handleInspectionCompleted as EventListener,
    );

    return () => {
      window.removeEventListener("parts-request:submitted", handleParts);
      window.removeEventListener(
        "inspection:completed",
        handleInspectionCompleted as EventListener,
      );
    };
  }, [fetchAll]);

  /* ----------------------- Derived data ----------------------- */

  // simple map of active quote-lines per work_order_line
  const activeQuotesByLine = useMemo(() => {
    const m: Record<string, WorkOrderQuoteLine[]> = {};

    (quoteLines as WorkOrderQuoteLineWithLineId[]).forEach((q) => {
      const status = (q.status ?? "").toLowerCase();
      if (status === "converted" || status === "declined") return;

      const lineId = q.work_order_line_id ?? null;
      if (!lineId) return;

      if (!m[lineId]) m[lineId] = [];
      m[lineId].push(q);
    });

    return m;
  }, [quoteLines]);

  const approvalPending = useMemo(
    () => lines.filter((l) => (l.approval_state ?? null) === "pending"),
    [lines],
  );

  const quotePending = useMemo(
    () =>
      quoteLines.filter((q) => {
        const status = (q.status ?? "").toLowerCase();
        return status !== "converted" && status !== "declined";
      }),
    [quoteLines],
  );

  const activeJobLines = useMemo(
    () => lines.filter((l) => (l.approval_state ?? null) !== "pending"),
    [lines],
  );

  const sortedLines = useMemo(() => {
    const pr: Record<string, number> = {
      diagnosis: 1,
      inspection: 2,
      maintenance: 3,
      repair: 4,
    };
    return [...activeJobLines].sort((a, b) => {
      const pa = pr[String(a.job_type ?? "repair")] ?? 999;
      const pb = pr[String(b.job_type ?? "repair")] ?? 999;
      if (pa !== pb) return pa - pb;
      const ta = a.created_at ? new Date(a.created_at).getTime() : 0;
      const tb = b.created_at ? new Date(b.created_at).getTime() : 0;
      return ta - tb;
    });
  }, [activeJobLines]);

  const createdAt = wo?.created_at ? new Date(wo.created_at) : null;
  const createdAtText =
    createdAt && !Number.isNaN(createdAt.getTime())
      ? format(createdAt, "PPpp")
      : "‚Äî";

  const canAssign = false; // assignments handled in focused view / desktop
  const canApprove = currentUserRole
    ? APPROVAL_ROLES.has(currentUserRole)
    : false;

  type WorkOrderWaiterFlags = {
    is_waiter?: boolean | null;
    waiter?: boolean | null;
    customer_waiting?: boolean | null;
  };

  const waiterFlagSource: (WorkOrder & WorkOrderWaiterFlags) | null = wo
    ? (wo as WorkOrder & WorkOrderWaiterFlags)
    : null;

  const isWaiter =
    !!(
      waiterFlagSource &&
      (waiterFlagSource.is_waiter ||
        waiterFlagSource.waiter ||
        waiterFlagSource.customer_waiting)
    );

  /* ----------------------- line & quote actions ----------------------- */

  const approveLine = useCallback(
    async (lineId: string) => {
      if (!lineId) return;
      const { error } = await supabase
        .from("work_order_lines")
        .update({
          approval_state: "approved",
          status: "queued",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", lineId);
      if (error) return toast.error(error.message);
      toast.success("Line approved");
      void fetchAll();
    },
    [fetchAll],
  );

  const declineLine = useCallback(
    async (lineId: string) => {
      if (!lineId) return;
      const { error } = await supabase
        .from("work_order_lines")
        .update({
          approval_state: "declined",
          status: "awaiting",
        } as DB["public"]["Tables"]["work_order_lines"]["Update"])
        .eq("id", lineId);
      if (error) return toast.error(error.message);
      toast.success("Line declined");
      void fetchAll();
    },
    [fetchAll],
  );

  const sendToParts = useCallback(async (lineId: string) => {
    if (!lineId) return;
    const { error } = await supabase
      .from("work_order_lines")
      .update({
        status: "on_hold",
        hold_reason: "Awaiting parts quote",
      } as DB["public"]["Tables"]["work_order_lines"]["Update"])
      .eq("id", lineId);
    if (error) return toast.error(error.message);
    toast.success("Sent to parts for quoting");
  }, []);

  const sendAllPendingToParts = useCallback(async () => {
    if (!approvalPending.length) return;
    const ids = approvalPending.map((l) => l.id);
    const { error } = await supabase
      .from("work_order_lines")
      .update({
        status: "on_hold",
        hold_reason: "Awaiting parts quote",
      } as DB["public"]["Tables"]["work_order_lines"]["Update"])
      .in("id", ids);
    if (error) {
      toast.error(error.message);
      return;
    }
    toast.success("Queued all pending lines for parts quoting");
  }, [approvalPending]);

  const authorizeQuote = useCallback(
    async (quoteId: string) => {
      if (!quoteId) return;
      try {
        const res = await fetch(
          `/api/work-orders/quotes/${quoteId}/authorize`,
          {
            method: "POST",
          },
        );
        const j = await res.json().catch(() => null);
        if (!res.ok) {
          throw new Error(j?.error || "Failed to authorize quote line");
        }
        toast.success("Quote authorized and added as job line");
        void fetchAll();
      } catch (e) {
        toast.error(
          e instanceof Error
            ? e.message
            : "Failed to authorize quote line",
        );
      }
    },
    [fetchAll],
  );

  const declineQuote = useCallback(
    async (quoteId: string) => {
      if (!quoteId) return;
      const { error } = await supabase
        .from("work_order_quote_lines")
        .update({ status: "declined" })
        .eq("id", quoteId);
      if (error) {
        toast.error(error.message);
        return;
      }
      toast.success("Quote declined");
      void fetchAll();
    },
    [fetchAll],
  );

  /* ----------------------- mobile focused job view ----------------------- */

  if (focusedOpen && focusedJobId) {
    return (
      <MobileFocusedJob
        workOrderLineId={focusedJobId}
        onBack={() => setFocusedOpen(false)}
        onChanged={fetchAll}
        mode="tech"
      />
    );
  }

  /* -------------------------- UI -------------------------- */
  if (!routeId)
    return <div className="p-6 text-red-400">Missing work order id.</div>;

  const Skeleton = ({ className = "" }: { className?: string }) => (
    <div
      className={`animate-pulse rounded-2xl bg-neutral-900/70 backdrop-blur-md ${className}`}
    />
  );

  const hasAnyPending = approvalPending.length > 0 || quotePending.length > 0;

  // üîπ Open mobile inspection page for a given line
  // inside MobileWorkOrderClient, in openInspection()
const openInspection = (ln: WorkOrderLine) => {
  if (!ln?.id || !wo?.id) return;

  const anyLine = ln as WorkOrderLineWithInspectionMeta;
  const templateId = extractInspectionTemplateId(anyLine);

  if (!templateId) {
    toast.error(
      "This job line doesn't have an inspection template attached yet. Attach or build a template first.",
    );
    return;
  }

  const sp = new URLSearchParams();
  sp.set("workOrderId", wo.id);
  sp.set("workOrderLineId", ln.id);
  sp.set("templateId", templateId);
  sp.set("view", "mobile"); // üëà NEW

  router.push(`/mobile/inspections/${ln.id}?${sp.toString()}`);
};

  return (
    <div className="mx-auto flex min-h-[calc(100vh-3rem)] max-w-4xl flex-col bg-transparent px-3 py-4 text-white">
      <VoiceContextSetter
        currentView="work_order_page_mobile"
        workOrderId={wo?.id}
        vehicleId={vehicle?.id}
        customerId={customer?.id}
        lineId={null}
      />

      {/* header bar */}
      <div className="mb-4 flex items-center justify-between gap-2">
        {/* Use history/back behavior instead of hard-coded route */}
        <PreviousPageButton />
        {wo?.custom_id && (
          <span className="rounded-full border border-white/12 bg-black/40 px-3 py-1 text-[11px] text-neutral-300 backdrop-blur">
            Internal ID:{" "}
            <span className="font-mono text-neutral-100">
              {wo.id.slice(0, 8)}
            </span>
          </span>
        )}
      </div>

      {!currentUserId && (
        <div className="mb-4 rounded-2xl border border-amber-500/40 bg-amber-950/40 px-3 py-3 text-xs text-amber-100 backdrop-blur">
          You appear signed out on this tab. If actions fail, open{" "}
          <Link
            href="/sign-in"
            className="underline decoration-dotted underline-offset-2 hover:text-white"
          >
            Sign In
          </Link>{" "}
          and return here.
        </div>
      )}

      {viewError && (
        <div className="mb-4 whitespace-pre-wrap rounded-2xl border border-red-500/50 bg-red-950/70 px-3 py-3 text-xs text-red-100 backdrop-blur">
          {viewError}
        </div>
      )}

      {loading ? (
        <div className="mt-4 grid gap-4">
          <Skeleton className="h-20" />
          <Skeleton className="h-32" />
          <Skeleton className="h-40" />
        </div>
      ) : !wo ? (
        <div className="mt-4 text-sm text-red-300">Work order not found.</div>
      ) : (
        <div className="space-y-5">
          {/* Header card */}
          <div className="rounded-2xl border border-white/10 bg-black/40 p-4 shadow-[0_18px_45px_rgba(0,0,0,0.85)] backdrop-blur-md">
            <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div className="space-y-1">
                <div className="flex flex-wrap items-center gap-2">
                  <h1 className="text-lg font-semibold sm:text-xl">
                    Work Order{" "}
                    <span className="text-[color:var(--accent-copper-light)]">
                      {wo.custom_id || `#${wo.id.slice(0, 8)}`}
                    </span>
                  </h1>
                  <span className={chip(wo.status)}>
                    {(wo.status ?? "awaiting").replaceAll("_", " ")}
                  </span>
                  {isWaiter && (
                    <span
                      className="
                        ml-auto
                        inline-flex items-center whitespace-nowrap
                        rounded-full border border-red-500
                        bg-red-500/10
                        px-4 py-1.5
                        text-xs sm:text-sm font-semibold uppercase tracking-[0.16em]
                        text-red-200
                        shadow-[0_0_18px_rgba(248,113,113,0.9)]
                      "
                    >
                      Waiter
                    </span>
                  )}
                </div>
                <p className="text-[11px] text-neutral-400">
                  Created {createdAtText}
                </p>
              </div>
            </div>

            <div className="mt-3 grid gap-3 text-[11px] text-neutral-300 sm:grid-cols-2">
              <div>
                <div className="text-neutral-500">Created</div>
                <div>{createdAtText}</div>
              </div>
              <div>
                <div className="text-neutral-500">WO ID</div>
                <div className="truncate font-mono text-[11px] text-neutral-200">
                  {wo.id}
                </div>
              </div>
              <div>
                <div className="text-neutral-500">Custom ID</div>
                <div className="truncate">
                  {wo.custom_id ?? (
                    <span className="text-neutral-500">Not set</span>
                  )}
                </div>
              </div>
              <div>
                <div className="text-neutral-500">Status</div>
                <div className="mt-0.5">
                  <span className={chip(wo.status)}>
                    {(wo.status ?? "awaiting").replaceAll("_", " ")}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {/* Vehicle & Customer */}
          <div className="rounded-2xl border border-white/10 bg-black/35 p-4 shadow-[0_14px_36px_rgba(0,0,0,0.80)] backdrop-blur-md">
            <div className="flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold sm:text-base">
                Vehicle &amp; Customer
              </h2>
              <button
                type="button"
                className="text-[11px] font-medium text-[color:var(--accent-copper-light)] underline-offset-2 hover:underline"
                onClick={() => setShowDetails((v) => !v)}
                aria-expanded={showDetails}
              >
                {showDetails ? "Hide details" : "Show details"}
              </button>
            </div>

            {showDetails && (
              <div className="mt-3 grid gap-4 sm:grid-cols-2">
                <div className="rounded-xl border border-white/10 bg-black/40 p-3 backdrop-blur">
                  <h3 className="mb-1 text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-400">
                    Vehicle
                  </h3>
                  {vehicle ? (
                    <>
                      <p className="text-sm font-medium text.white">
                        {(vehicle.year ?? "").toString()} {vehicle.make ?? ""}{" "}
                        {vehicle.model ?? ""}
                      </p>
                      <p className="mt-1 text-[11px] text-neutral-400">
                        VIN:{" "}
                        <span className="font-mono">
                          {vehicle.vin ?? "‚Äî"}
                        </span>
                        <br />
                        Plate:{" "}
                        {vehicle.license_plate ?? (
                          <span className="text-neutral-500">‚Äî</span>
                        )}
                        <br />
                        Mileage:{" "}
                        {vehicle.mileage ?? (
                          <span className="text-neutral-500">‚Äî</span>
                        )}
                      </p>
                    </>
                  ) : (
                    <p className="text-sm text-neutral-500">
                      No vehicle linked yet.
                    </p>
                  )}
                </div>

                <div className="rounded-xl border border-white/10 bg-black/40 p-3 backdrop-blur">
                  <h3 className="mb-1 text-[11px] font-semibold uppercase tracking-[0.18em] text-neutral-400">
                    Customer
                  </h3>
                  {customer ? (
                    <>
                      <p className="text-sm font-medium text-white">
                        {[
                          customer.first_name ?? "",
                          customer.last_name ?? "",
                        ]
                          .filter(Boolean)
                          .join(" ") || "‚Äî"}
                      </p>
                      <p className="mt-1 text-[11px] text-neutral-400">
                        {customer.phone ?? "‚Äî"}{" "}
                        {customer.email ? (
                          <>
                            <span className="mx-1 text-neutral-600">‚Ä¢</span>
                            {customer.email}
                          </>
                        ) : null}
                      </p>
                      {customer.id && (
                        <Link
                          href={`/mobile/work-orders/${wo.id}/vehicle`}
                          className="mt-2 inline-flex text-[11px] font-medium text-[color:var(--accent-copper-light)] underline-offset-2 hover:underline"
                          title="Open customer profile"
                        >
                          View customer profile ‚Üí
                        </Link>
                      )}
                    </>
                  ) : (
                    <p className="text-sm text-neutral-500">
                      No customer linked yet.
                    </p>
                  )}
                </div>
              </div>
            )}
          </div>

          {/* Awaiting Customer Approval */}
          <div className="rounded-2xl border border-slate-600/60 bg-[radial-gradient(circle_at_top,_rgba(248,113,22,0.20),rgba(15,23,42,0.98)),radial-gradient(circle_at_bottom,_rgba(15,23,42,1),#020617_85%)] p-4 shadow-[0_22px_55px_rgba(0,0,0,0.95)]">
            <div className="mb-3 flex items-center justify-between gap-2">
              <h2 className="text-sm font-semibold text-sky-100 sm:text-base">
                Awaiting customer approval
              </h2>
              {approvalPending.length > 1 && (
                <button
                  type="button"
                  className="rounded-full bg-sky-500 px-3 py-1.5 text-[11px] font-semibold text-slate-950 shadow-[0_0_18px_rgba(56,189,248,0.65)] hover:bg-sky-400"
                  onClick={sendAllPendingToParts}
                  title="Queue all lines for parts quoting"
                >
                  Quote all pending lines
                </button>
              )}
            </div>

            {!hasAnyPending ? (
              <p className="text-xs text-slate-200/75">
                No lines waiting for approval.
              </p>
            ) : (
              <div className="space-y-4">
                {/* Job lines needing approval */}
                {approvalPending.length > 0 && (
                  <div className="space-y-2">
                    <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-sky-200/90">
                      Jobs awaiting approval
                    </div>
                    {approvalPending.map((ln, idx) => {
                      const isAwaitingPartsBase =
                        (ln.status === "on_hold" &&
                          (ln.hold_reason ?? "")
                            .toLowerCase()
                            .includes("part")) ||
                        (ln.hold_reason ?? "")
                          .toLowerCase()
                          .includes("quote");

                      const hasQuotedParts =
                        (activeQuotesByLine[ln.id] ?? []).length > 0;

                      const partsLabel = hasQuotedParts
                        ? "Quoted, awaiting approval"
                        : "Awaiting parts quote";

                      return (
                        <div
                          key={ln.id}
                          className="rounded-xl border border-white/10 bg-slate-950/70 p-3 backdrop-blur"
                        >
                          <div className="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                            <div className="min-w-0">
                              <div className="truncate text-sm font-medium text-white">
                                {idx + 1}.{" "}
                                {ln.description ||
                                  ln.complaint ||
                                  "Untitled job"}
                              </div>
                              <div className="mt-0.5 text-[11px] text-slate-300">
                                {String(ln.job_type ?? "job").replaceAll(
                                  "_",
                                  " ",
                                )}{" "}
                                ‚Ä¢{" "}
                                {typeof ln.labor_time === "number"
                                  ? `${ln.labor_time}h`
                                  : "‚Äî"}{" "}
                                ‚Ä¢ Status:{" "}
                                {(ln.status ?? "awaiting").replaceAll(
                                  "_",
                                  " ",
                                )}{" "}
                                ‚Ä¢ Approval:{" "}
                                {(ln.approval_state ?? "pending").replaceAll(
                                  "_",
                                  " ",
                                )}
                              </div>

                              {isAwaitingPartsBase && (
                                <div className="mt-1 inline-flex items-center rounded-full border border-sky-400/70 bg-sky-500/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-sky-100">
                                  {partsLabel}
                                </div>
                              )}

                              {ln.notes && (
                                <div className="mt-1 text-[11px] text-slate-300">
                                  Notes: {ln.notes}
                                </div>
                              )}
                            </div>

                            <div className="flex flex-wrap items-center gap-2">
                              {canApprove && (
                                <>
                                  <button
                                    type="button"
                                    className="rounded-md border border-emerald-400/80 px-2.5 py-1 text-[11px] font-medium text-emerald-100 hover:bg-emerald-500/10"
                                    onClick={() => approveLine(ln.id)}
                                  >
                                    Approve
                                  </button>
                                  <button
                                    type="button"
                                    className="rounded-md border border-red-400/80 px-2.5 py-1 text-[11px] font-medium text-red-100 hover:bg-red-500/10"
                                    onClick={() => declineLine(ln.id)}
                                  >
                                    Decline
                                  </button>
                                </>
                              )}

                              {isAwaitingPartsBase ? (
                                <button
                                  type="button"
                                  disabled
                                  className="cursor-not-allowed rounded-md border border-slate-500/70 px-2.5 py-1 text-[11px] text-slate-300"
                                >
                                  Sent to parts
                                </button>
                              ) : (
                                <button
                                  type="button"
                                  className="rounded-md border border-sky-400/80 px-2.5 py-1 text-[11px] font-medium text-sky-100 hover:bg-sky-500/15"
                                  onClick={() => sendToParts(ln.id)}
                                  title="Send to parts for quoting"
                                >
                                  Send to parts
                                </button>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {/* Quote lines created from AI suggestions etc. */}
                {quotePending.length > 0 && (
                  <div className="space-y-2">
                    <div className="text-[11px] font-semibold uppercase tracking-[0.18em] text-[color:var(--accent-copper-light)]/90">
                      Quote lines / AI suggestions
                    </div>
                    {quotePending.map((q, idx) => (
                      <div
                        key={q.id}
                        className="rounded-xl border border-white/10 bg-slate-950/75 p-3 backdrop-blur"
                      >
                        <div className="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                          <div className="min-w-0">
                            <div className="truncate text-sm font-medium text-white">
                              {idx + 1}. {q.description}
                            </div>
                            <div className="mt-0.5 text-[11px] text-slate-300">
                              {String(q.job_type ?? "job").replaceAll(
                                "_",
                                " ",
                              )}{" "}
                              ‚Ä¢{" "}
                              {typeof q.est_labor_hours === "number"
                                ? `${q.est_labor_hours}h`
                                : "‚Äî"}{" "}
                              ‚Ä¢ Quote status:{" "}
                              {(q.status ?? "pending_parts").replaceAll(
                                "_",
                                " ",
                              )}
                            </div>
                            {q.notes && (
                              <div className="mt-1 text-[11px] text-slate-300">
                                Notes: {q.notes}
                              </div>
                            )}
                          </div>

                          {canApprove && (
                            <div className="flex flex-wrap items-center gap-2">
                              <button
                                type="button"
                                className="rounded-md border border-emerald-400/80 px-2.5 py-1 text-[11px] font-medium text-emerald-100 hover:bg-emerald-500/10"
                                onClick={() => authorizeQuote(q.id)}
                              >
                                Approve &amp; add job
                              </button>
                              <button
                                type="button"
                                className="rounded-md border border-red-400/80 px-2.5 py-1 text-[11px] font-medium text-red-100 hover:bg-red-500/10"
                                onClick={() => declineQuote(q.id)}
                              >
                                Decline
                              </button>
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Jobs list */}
          <div className="rounded-2xl border border-white/10 bg-black/35 p-4 shadow-[0_16px_40px_rgba(0,0,0,0.88)] backdrop-blur-md">
            <div className="mb-3 flex items-center justify-between gap-2">
              <div>
                <h2 className="text-sm font-semibold sm:text-base">
                  Jobs in this work order
                </h2>
                <p className="text-[11px] text-neutral-500">
                  Tap a job or open inspection to go into the focused job view.
                </p>
              </div>
            </div>

            {sortedLines.length === 0 ? (
              <p className="text-sm text-neutral-400">No lines yet.</p>
            ) : (
              <div className="space-y-2">
                {sortedLines.map((ln, idx) => {
                  const punchedIn =
                    !!ln.punched_in_at && !ln.punched_out_at;

                  const openFocused = () => {
                    setFocusedJobId(ln.id);
                    setFocusedOpen(true);
                  };

                  const assignedTechName = ln.assigned_to
                    ? techNamesById[ln.assigned_to] ?? "Assigned tech"
                    : null;

                  const bucket = toLineBucket(ln.status);
                  const cardColor = LINE_CARD_STYLES[bucket];
                  const pillColor = LINE_PILL_STYLES[bucket];
                  const statusLabel = LINE_STATUS_LABELS[bucket];

                  return (
                    <div
                      key={ln.id}
                      className={[
                        "space-y-1 rounded-xl border p-2 transition-shadow",
                        cardColor,
                        punchedIn
                          ? "ring-2 ring-emerald-500/80"
                          : "ring-0",
                      ].join(" ")}
                    >
                      {/* header row with status pill on the right */}
                      <div className="mb-1 flex items-center justify-between gap-2 px-1">
                        <div className="text-[11px] text-neutral-400">
                          {idx + 1}.{" "}
                          {String(ln.job_type ?? "job").replaceAll(
                            "_",
                            " ",
                          )}
                        </div>
                        <span
                          className={[
                            "inline-flex items-center rounded-full border px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-[0.16em]",
                            pillColor,
                          ].join(" ")}
                        >
                          {statusLabel}
                        </span>
                      </div>

                      <div className="rounded-lg border border-white/10 bg-black/40">
                        <JobCard
                          index={idx}
                          line={ln}
                          parts={[]} // stripped-down: no parts list on main mobile view
                          technicians={[]} // assignment handled in focused view / desktop
                          canAssign={canAssign}
                          isPunchedIn={punchedIn}
                          onOpen={openFocused}
                          onAssign={undefined}
                          // üîπ go straight to mobile inspection screen
                          onOpenInspection={() => openInspection(ln)}
                          onAddPart={undefined}
                        />
                      </div>

                      {/* Assigned tech pill */}
                      <div className="pl-2 pt-1 text-[11px] text-neutral-400">
                        Assigned to:{" "}
                        <span className="font-medium text-neutral-200">
                          {assignedTechName ?? "Unassigned"}
                        </span>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      )}

      <div className="mt-4 flex justify-center pb-1">
        <VoiceButton />
      </div>
    </div>
  );
}

========================================
FILE: features/work-orders/mobile/MobileWorkOrderLines.tsx
========================================
"use client";

import { useState } from "react";
import type { Database } from "@shared/types/types/supabase";
import AssignTechModal from "@/features/work-orders/components/workorders/extras/AssignTechModal";

type DB = Database;
type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];

type Props = {
  lines: WorkOrderLineRow[];
  workOrderId: string | null;
  onDelete: (lineId: string) => Promise<void> | void;
  /** set true from parent when this WO is a waiting / waiter job */
  isWaiter?: boolean;
};

const statusTextColor: Record<string, string> = {
  in_progress: "text-emerald-300 border-emerald-400/40 bg-emerald-500/10",
  awaiting: "text-slate-200 border-slate-300/30 bg-slate-500/10",
  queued: "text-indigo-200 border-indigo-400/40 bg-indigo-500/10",
  on_hold: "text-amber-200 border-amber-400/50 bg-amber-500/10",
  completed: "text-emerald-200 border-emerald-400/60 bg-emerald-500/10",
  paused: "text-amber-200 border-amber-400/50 bg-amber-500/10",
  assigned: "text-sky-200 border-sky-400/50 bg-sky-500/10",
  unassigned: "text-neutral-200 border-neutral-400/40 bg-neutral-700/20",
  awaiting_approval: "text-blue-200 border-blue-400/50 bg-blue-500/10",
  declined: "text-red-200 border-red-500/60 bg-red-500/10",
};

const statusChip = (s: string | null | undefined) => {
  const key = (s ?? "awaiting").toLowerCase().replaceAll(" ", "_");
  return (
    statusTextColor[key] ??
    "text-neutral-200 border-neutral-500/40 bg-neutral-700/20"
  );
};

// waiter pill styling (matches desktop vibe but a bit tighter for mobile)
const waiterPillClasses =
  "inline-flex items-center rounded-full border border-red-500/80 bg-red-500/15 px-2 py-0.5 text-[0.6rem] font-semibold uppercase tracking-[0.16em] text-red-100 shadow-[0_0_10px_rgba(248,113,113,0.75)]";

export function MobileWorkOrderLines({
  lines,
  workOrderId,
  onDelete,
  isWaiter = false,
}: Props) {
  const [assignLineId, setAssignLineId] = useState<string | null>(null);
  const [assignOpen, setAssignOpen] = useState(false);

  if (!workOrderId) return null;

  if (!lines.length) {
    return (
      <div className="glass-card rounded-2xl border border-dashed border-white/15 bg-black/30 px-3 py-3 text-[0.75rem] text-neutral-300">
        No jobs added yet. Use{" "}
        <span className="font-semibold text-[var(--accent-copper-light)]">
          Add job line
        </span>{" "}
        below to start the quote.
      </div>
    );
  }

  return (
    <>
      <div className="glass-card rounded-2xl border border-white/12 bg-black/40 px-3 py-3 shadow-card">
        <div className="mb-2 flex items-center justify-between">
          <h2 className="text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-neutral-400">
            Jobs on this work order
          </h2>
          <span className="text-[0.65rem] text-neutral-500">
            {lines.length} line{lines.length === 1 ? "" : "s"}
          </span>
        </div>

        <ul className="space-y-2">
          {lines.map((line, idx) => {
            const label =
              line.description ||
              line.complaint ||
              "Job line";

            const statusLabel = line.status
              ? line.status.replaceAll("_", " ")
              : "awaiting";

            return (
              <li
                key={line.id}
                className="group flex items-stretch justify-between gap-2 rounded-2xl border border-white/12 bg-gradient-to-br from-neutral-950/95 via-neutral-900/90 to-black/90 px-3 py-2 text-xs shadow-[0_0_0_1px_rgba(15,23,42,0.9)]"
              >
                <div className="min-w-0 flex-1">
                  <div className="flex items-center gap-1.5 text-[0.7rem] text-neutral-500">
                    <span className="font-mono text-[0.65rem] text-neutral-500">
                      #{(idx + 1).toString().padStart(2, "0")}
                    </span>

                    {line.job_type && (
                      <span className="rounded-full border border-white/10 bg-white/5 px-1.5 py-0.5 text-[0.6rem] uppercase tracking-[0.16em] text-neutral-300">
                        {String(line.job_type).replaceAll("_", " ")}
                      </span>
                    )}

                    {isWaiter && (
                      <span className={waiterPillClasses}>Waiting</span>
                    )}
                  </div>

                  <div className="mt-0.5 truncate text-[0.8rem] font-medium text-neutral-50">
                    {label}
                  </div>

                  {line.complaint && (
                    <div className="mt-0.5 line-clamp-2 text-[0.7rem] text-neutral-400">
                      {line.complaint}
                    </div>
                  )}

                  {line.status && (
                    <div className="mt-1">
                      <span
                        className={`inline-flex items-center rounded-full border px-2 py-0.5 text-[0.6rem] uppercase tracking-[0.16em] ${statusChip(
                          line.status,
                        )}`}
                      >
                        {statusLabel}
                      </span>
                    </div>
                  )}
                </div>

                <div className="flex flex-col items-end justify-between gap-1 pl-1">
                  {typeof line.labor_time === "number" && (
                    <span className="rounded-full border border-white/10 bg-black/40 px-2 py-0.5 text-[0.6rem] text-neutral-200">
                      {line.labor_time.toFixed(1)}h
                    </span>
                  )}

                  <div className="flex flex-col items-end gap-1">
                    <button
                      type="button"
                      onClick={() => {
                        setAssignLineId(line.id);
                        setAssignOpen(true);
                      }}
                      className="shrink-0 rounded-full border border-sky-500/70 px-2 py-0.5 text-[0.7rem] text-sky-100 hover:bg-sky-500/15"
                    >
                      Assign
                    </button>

                    <button
                      type="button"
                      onClick={() => onDelete(line.id)}
                      className="shrink-0 rounded-full border border-red-500/70 px-2 py-0.5 text-[0.7rem] text-red-100 hover:bg-red-500/15"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </li>
            );
          })}
        </ul>
      </div>

      {assignOpen && assignLineId && (
        <AssignTechModal
          isOpen={assignOpen}
          onClose={() => setAssignOpen(false)}
          workOrderLineId={assignLineId}
          // let the modal fetch its own mechanics; you can wire onAssigned
          // if you want to re-fetch this work order after assignment.
        />
      )}
    </>
  );
}

========================================
FILE: features/work-orders/mobile/types.ts
========================================
// features/work-orders/mobile/types.ts

export type MobileCustomer = {
  id: string | null;
  first_name: string | null;
  last_name: string | null;
  phone: string | null;
  email: string | null;
  business_name?: string | null;
  address?: string | null;
  city?: string | null;
  province?: string | null;
  postal_code?: string | null;
};

export type MobileVehicle = {
  id: string | null;

  // optional because mobile does NOT input this
  vin?: string | null;

  year: string | number | null;
  make: string | null;
  model: string | null;
  license_plate: string | null;
  mileage: string | null;

  // optional in mobile UI
  color?: string | null;
  unit_number?: string | null;
  engine_hours?: string | number | null;
};

========================================
FILE: features/work-orders/state/draft.ts
========================================
// features/work-orders/state/draft.ts
// Small, SSR-safe helpers to stash decoded VIN ‚Üí Create page (no Zustand).
// Uses localStorage when available, falls back to sessionStorage.

export type VehicleDraft = {
  vin?: string | null;
  year?: string | null;
  make?: string | null;
  model?: string | null;
  trim?: string | null;
  engine?: string | null;
  plate?: string | null;
};

const KEY = "woDraft:vehicle";

function getStore(): Storage | null {
  if (typeof window === "undefined") return null;
  try {
    return window.localStorage ?? window.sessionStorage ?? null;
  } catch {
    try {
      return window.sessionStorage ?? null;
    } catch {
      return null;
    }
  }
}

export function setVehicleDraft(v: VehicleDraft) {
  const s = getStore();
  if (!s) return;
  try {
    s.setItem(KEY, JSON.stringify(v));
  } catch { /* ignore quota */ }
}

export function getVehicleDraft(): VehicleDraft | null {
  const s = getStore();
  if (!s) return null;
  try {
    const raw = s.getItem(KEY);
    return raw ? (JSON.parse(raw) as VehicleDraft) : null;
  } catch {
    return null;
  }
}

export function clearVehicleDraft() {
  const s = getStore();
  try { s?.removeItem(KEY); } catch { /* noop */ }
}

========================================
FILE: features/work-orders/state/mergeFromOcr.ts
========================================
// features/work-orders/state/mergeFromOcr.ts
import { useWorkOrderDraft } from "app/work-orders/state/useWorkOrderDraft";

export function mergeFromOcr(fields: Record<string, string | null | undefined>) {
  const setVehicle = useWorkOrderDraft.getState().setVehicle;
  const setCustomer = useWorkOrderDraft.getState().setCustomer;

  setVehicle({
    vin: fields.vin ?? undefined,
    plate: fields.plate ?? undefined,
    year: fields.year ?? undefined,
    make: fields.make ?? undefined,
    model: fields.model ?? undefined
  });

  setCustomer({
    first_name: fields.first_name ?? undefined,
    last_name: fields.last_name ?? undefined,
    phone: fields.phone ?? undefined,
    email: fields.email ?? undefined
  });
}
