===============================================================================
ProFixIQ – Portal + API Full Source Dump
Generated: Tue Dec 16 11:22:22 PM UTC 2025
===============================================================================

===============================================================================
FILE: app/portal/appointments/page.tsx
===============================================================================

// app/portal/appointments/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast, Toaster } from "sonner";

import WeeklyCalendar from "./WeeklyCalendar";
import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";

type ShopRow = Database["public"]["Tables"]["shops"]["Row"];
type CustomerRow = Database["public"]["Tables"]["customers"]["Row"];

export type Booking = {
  id: string;
  shop_slug?: string | null;
  starts_at: string; // ISO
  ends_at: string; // ISO
  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;
  notes?: string | null;
  status?: string | null; // pending, confirmed, cancelled...
};

const isoDate = (d: Date) => d.toISOString().slice(0, 10);

function startOfToday(): Date {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
}

function cardClass() {
  return "rounded-2xl border border-neutral-800/70 bg-neutral-950/45 p-4 backdrop-blur-md";
}

function fieldClass() {
  return "mt-1 w-full rounded-md border border-neutral-800 bg-neutral-950/60 px-2 py-1 text-sm text-white outline-none focus:border-orange-500/60 focus:ring-1 focus:ring-orange-500/40";
}

function safeString(v: unknown): string {
  return typeof v === "string" ? v : "";
}

function customerLabel(c: CustomerRow): string {
  const rec = c as unknown as Record<string, unknown>;

  const first = safeString(rec["first_name"]);
  const last = safeString(rec["last_name"]);
  const full = safeString(rec["full_name"]) || safeString(rec["name"]);
  const name =
    full || `${first} ${last}`.trim() || safeString(rec["email"]) || "Customer";

  const phone = safeString(rec["phone"]) || safeString(rec["mobile"]);
  return phone ? `${name} (${phone})` : name;
}

export default function PortalAppointmentsPage() {
  const supabase = createClientComponentClient<Database>();
  const search = useSearchParams();
  const router = useRouter();

  const [shops, setShops] = useState<ShopRow[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");

  const [customers, setCustomers] = useState<CustomerRow[]>([]);
  const [loadingCustomers, setLoadingCustomers] = useState(false);

  const [weekStart, setWeekStart] = useState<Date>(() => startOfToday());

  const [bookings, setBookings] = useState<Booking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  const [editing, setEditing] = useState<Booking | null>(null);
  const [creatingDate, setCreatingDate] = useState<string | null>(null);

  // load shops
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        toast.error("Unable to load shops.");
        return;
      }

      const rows = (data ?? []) as ShopRow[];
      setShops(rows);

      if (!shopSlug && rows.length > 0) {
        const first = rows[0].slug as string;
        setShopSlug(first);
        router.replace(`/portal/appointments?shop=${encodeURIComponent(first)}`);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const selectedShop = useMemo(
    () => shops.find((s) => (s.slug as string | null) === shopSlug) ?? null,
    [shops, shopSlug],
  );

  // load customers for selected shop
  useEffect(() => {
    if (!selectedShop) return;

    (async () => {
      setLoadingCustomers(true);
      try {
        const { data, error } = await supabase
          .from("customers")
          .select("*")
          .eq("shop_id", selectedShop.id)
          .order("last_name", { ascending: true })
          .order("first_name", { ascending: true });

        if (error) {
          console.error(error);
          toast.error("Unable to load customers.");
          setCustomers([]);
        } else {
          setCustomers((data ?? []) as CustomerRow[]);
        }
      } catch (e) {
        console.error(e);
        toast.error("Unable to load customers.");
        setCustomers([]);
      } finally {
        setLoadingCustomers(false);
      }
    })();
  }, [supabase, selectedShop]);

  const weekEnd = useMemo(() => {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + 6);
    return d;
  }, [weekStart]);

  // fetch bookings for week
  useEffect(() => {
    if (!shopSlug) return;
    (async () => {
      setLoadingBookings(true);
      try {
        const start = isoDate(weekStart);
        const end = isoDate(weekEnd);
        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
          { cache: "no-store" },
        );
        if (!res.ok) throw new Error("Failed to load appointments.");
        const j = (await res.json().catch(() => [])) as Booking[];
        setBookings(j ?? []);
      } catch (err: unknown) {
        console.error(err);
        toast.error("Failed to load appointments.");
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [shopSlug, weekStart, weekEnd]);

  async function handleCreate(form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) {
    if (!shopSlug) {
      toast.error("Select a shop first.");
      return;
    }

    try {
      const startIso = new Date(`${form.date}T${form.startsAt}`).toISOString();
      const endIso = new Date(`${form.date}T${form.endsAt}`).toISOString();

      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: form.notes,
          customerId: form.customerId ?? null,
          customerName: form.customerName,
          customerEmail: form.customerEmail,
          customerPhone: form.customerPhone,
        }),
      });

      const j = (await res
        .json()
        .catch(() => ({}))) as { booking?: Booking; error?: string };

      if (!res.ok || !j.booking) {
        throw new Error(j?.error || "Unable to create appointment.");
      }

      setBookings((prev) => [...prev, j.booking as Booking]);

      toast.success("Appointment created.");
      setCreatingDate(null);

      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Create failed";
      toast.error(message);
    }
  }

  async function handleUpdate(id: string, patch: Partial<Booking>) {
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(patch),
      });
      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Update failed");

      toast.success("Appointment updated.");
      setEditing(null);
      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Update failed";
      toast.error(message);
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("Delete this appointment?")) return;
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Delete failed.");
      toast.success("Appointment deleted.");
      setBookings((prev) => prev.filter((b) => b.id !== id));
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Delete failed";
      toast.error(message);
    }
  }

  const totalForWeek = useMemo(() => bookings.length, [bookings]);

  return (
    <div className="space-y-6">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-500">Appointments</h1>
        <p className="text-sm text-neutral-400">
          Admin / manager view of customer bookings for the week.
        </p>
      </header>

      {/* Shop selector */}
      <div className={cardClass()}>
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex items-center gap-3">
            <div className="text-[0.7rem] uppercase tracking-[0.12em] text-neutral-400">
              Shop
            </div>
            <select
              value={shopSlug}
              onChange={(e) => {
                const slug = e.target.value;
                setShopSlug(slug);
                router.replace(`/portal/appointments?shop=${encodeURIComponent(slug)}`);
              }}
              className={fieldClass() + " min-w-[220px]"}
            >
              {shops.map((s) => (
                <option key={s.slug as string} value={s.slug as string}>
                  {s.name}
                </option>
              ))}
            </select>
          </div>

          <div className="rounded-xl border border-neutral-800/70 bg-neutral-950/50 px-3 py-2">
            <div className="text-[0.65rem] uppercase tracking-[0.13em] text-neutral-500">
              This week
            </div>
            <div className="text-sm font-semibold text-neutral-100">
              {totalForWeek} booking{totalForWeek === 1 ? "" : "s"}
            </div>
          </div>
        </div>
      </div>

      {/* Calendar */}
      <div className={cardClass()}>
        <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
          <h2 className="text-sm font-semibold text-neutral-50">Weekly calendar</h2>
          <div className="flex items-center gap-2">
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() - 7);
                setWeekStart(d);
              }}
            >
              ← Prev
            </Button>
            <Button type="button" variant="outline" size="xs" onClick={() => setWeekStart(startOfToday())}>
              Today
            </Button>
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + 7);
                setWeekStart(d);
              }}
            >
              Next →
            </Button>
          </div>
        </div>

        <div className="overflow-x-auto pb-2">
          <WeeklyCalendar
            weekStart={weekStart}
            bookings={bookings}
            onSelectDay={(dayIso) => setCreatingDate(dayIso)}
            onSelectBooking={(b) => setEditing(b)}
            loading={loadingBookings}
          />
        </div>

        <p className="mt-3 text-[0.75rem] text-neutral-500">
          Click a day to create. Click an appointment to edit.
        </p>
      </div>

      {/* Create / Edit */}
      <div className={cardClass()}>
        {editing ? (
          <EditForm
            booking={editing}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onCancel={() => setEditing(null)}
            onSave={(patch) => void handleUpdate(editing.id, patch)}
          />
        ) : (
          <CreateForm
            defaultDate={creatingDate ?? isoDate(weekStart)}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onSubmit={handleCreate}
          />
        )}
      </div>

      {/* List */}
      <div className={cardClass()}>
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">
            Appointments this week ({bookings.length})
          </h2>
          {loadingBookings && <span className="text-[0.75rem] text-neutral-400">Loading…</span>}
        </div>

        {loadingBookings ? (
          <p className="text-sm text-neutral-400">Fetching appointments…</p>
        ) : bookings.length === 0 ? (
          <p className="text-sm text-neutral-400">No appointments for this week.</p>
        ) : (
          <ul className="divide-y divide-neutral-800/70">
            {bookings
              .slice()
              .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at))
              .map((b) => (
                <li key={b.id} className="flex flex-wrap items-center gap-3 py-3 text-sm">
                  <div className="min-w-0 flex-1">
                    <div className="font-medium text-neutral-50">{b.customer_name || "Customer"}</div>
                    <div className="text-[0.75rem] text-neutral-400">
                      {new Date(b.starts_at).toLocaleString()} –{" "}
                      {new Date(b.ends_at).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}
                    </div>
                    {b.notes ? <div className="mt-1 text-[0.75rem] text-neutral-500">{b.notes}</div> : null}
                  </div>

                  <div className="flex items-center gap-2">
                    <Button type="button" size="xs" variant="outline" onClick={() => setEditing(b)}>
                      Edit
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="ghost"
                      className="text-red-300 hover:bg-red-900/25"
                      onClick={() => void handleDelete(b.id)}
                    >
                      Delete
                    </Button>
                  </div>
                </li>
              ))}
          </ul>
        )}
      </div>
    </div>
  );
}

async function refreshBookings(
  shopSlug: string,
  weekStart: Date,
  weekEnd: Date,
  setBookings: (b: Booking[]) => void,
) {
  const start = isoDate(weekStart);
  const end = isoDate(weekEnd);
  const res = await fetch(
    `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
    { cache: "no-store" },
  );
  const refreshed = (await res.json().catch(() => [])) as Booking[];
  setBookings(refreshed ?? []);
}

/* -------------------------------------------------------------------------- */
/* Forms                                                                      */
/* -------------------------------------------------------------------------- */

function CreateForm({
  defaultDate,
  customers,
  loadingCustomers,
  onSubmit,
}: {
  defaultDate: string;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onSubmit: (form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) => void;
}) {
  const [date, setDate] = useState(defaultDate);
  const [startsAt, setStartsAt] = useState("09:00");
  const [endsAt, setEndsAt] = useState("10:00");
  const [customerId, setCustomerId] = useState<string>("");
  const [customerName, setCustomerName] = useState("");
  const [customerEmail, setCustomerEmail] = useState("");
  const [customerPhone, setCustomerPhone] = useState("");
  const [notes, setNotes] = useState("");

  useEffect(() => {
    setDate(defaultDate);
  }, [defaultDate]);

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        onSubmit({
          date,
          startsAt,
          endsAt,
          customerId: customerId || undefined,
          customerName,
          customerEmail,
          customerPhone,
          notes,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Create appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading…" : "Select…"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} className={fieldClass()} placeholder="John Smith" />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <Button type="submit" size="sm" className="mt-1 font-semibold">
        Save appointment
      </Button>
    </form>
  );
}

function EditForm({
  booking,
  customers,
  loadingCustomers,
  onCancel,
  onSave,
}: {
  booking: Booking;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onCancel: () => void;
  onSave: (patch: Partial<Booking>) => void;
}) {
  const start = new Date(booking.starts_at);
  const end = new Date(booking.ends_at);

  const [date, setDate] = useState(booking.starts_at.slice(0, 10));
  const [startsAt, setStartsAt] = useState(start.toISOString().slice(11, 16));
  const [endsAt, setEndsAt] = useState(end.toISOString().slice(11, 16));

  const [customerId, setCustomerId] = useState<string>(booking.customer_id ?? "");
  const [customerName, setCustomerName] = useState(booking.customer_name ?? "");
  const [customerEmail, setCustomerEmail] = useState(booking.customer_email ?? "");
  const [customerPhone, setCustomerPhone] = useState(booking.customer_phone ?? "");
  const [notes, setNotes] = useState(booking.notes ?? "");
  const [status, setStatus] = useState(booking.status ?? "pending");

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        const starts_at = new Date(`${date}T${startsAt}`).toISOString();
        const ends_at = new Date(`${date}T${endsAt}`).toISOString();
        onSave({
          starts_at,
          ends_at,
          customer_id: customerId || null,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          notes,
          status,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Edit appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading…" : "Select…"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} className={fieldClass()} />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <label className="text-xs text-neutral-300">
        Status
        <select value={status} onChange={(e) => setStatus(e.target.value)} className={fieldClass()}>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </label>

      <div className="flex gap-2">
        <Button type="submit" size="sm" className="font-semibold">
          Save changes
        </Button>
        <Button type="button" size="sm" variant="outline" onClick={onCancel}>
          Cancel
        </Button>
      </div>
    </form>
  );
}

===============================================================================
FILE: app/portal/appointments/WeeklyCalendar.tsx
===============================================================================

// app/portal/appointments/WeeklyCalendar.tsx
"use client";

import { useMemo } from "react";
import type { Booking } from "./page";
import { Button } from "@shared/components/ui/Button";

type Props = {
  weekStart: Date;
  bookings: Booking[];
  onSelectDay: (iso: string) => void;
  onSelectBooking: (b: Booking) => void;
  loading?: boolean;
};

const dayKey = (d: Date) => d.toISOString().slice(0, 10);

function displayCustomerName(b: Booking): string {
  // @ts-expect-error – optional extra field if you ever add it
  const fromExtra = b.customer_full_name as string | undefined;
  return b.customer_name || fromExtra || "Customer";
}

export default function WeeklyCalendar({
  weekStart,
  bookings,
  onSelectDay,
  onSelectBooking,
  loading = false,
}: Props) {
  const days = useMemo(
    () =>
      Array.from({ length: 7 }, (_, i) => {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + i);
        return d;
      }),
    [weekStart],
  );

  const grouped = useMemo(() => {
    const map = new Map<string, Booking[]>();
    for (const b of bookings) {
      const k = b.starts_at.slice(0, 10);
      const arr = map.get(k) ?? [];
      arr.push(b);
      map.set(k, arr);
    }
    map.forEach((arr) => {
      arr.sort(
        (a, b) => +new Date(a.starts_at) - +new Date(b.starts_at),
      );
    });
    return map;
  }, [bookings]);

  const todayKey = new Date().toISOString().slice(0, 10);

  return (
    <div className="grid grid-cols-1 gap-3 md:grid-cols-7">
      {days.map((d) => {
        const k = dayKey(d);
        const dayBookings = grouped.get(k) ?? [];
        const isToday = todayKey === k;

        return (
          <div
            key={k}
            className="flex min-h-[140px] flex-col gap-2 rounded-2xl border border-white/10 bg-black/40 p-3 text-xs text-neutral-100 shadow-card backdrop-blur-md overflow-hidden"
          >
            {/* Day header */}
            <Button
              type="button"
              variant={isToday ? "default" : "outline"}
              size="sm"
              onClick={() => onSelectDay(k)}
              className="flex w-full items-center justify-between rounded-xl px-2 py-1 text-[0.75rem]"
            >
              <span className="font-medium">
                {d.toLocaleDateString(undefined, {
                  weekday: "short",
                  month: "short",
                  day: "numeric",
                })}
              </span>
              {isToday && (
                <span className="rounded-full bg-black/15 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.12em]">
                  Today
                </span>
              )}
            </Button>

            {/* Appointments list */}
            <div className="flex-1 space-y-1.5">
              {loading && dayBookings.length === 0 ? (
                <div className="rounded-md border border-neutral-800 bg-neutral-900/60 px-2 py-2 text-[0.65rem] text-neutral-400">
                  Loading…
                </div>
              ) : dayBookings.length === 0 ? (
                <div className="rounded-md border border-dashed border-neutral-800 bg-neutral-950/40 px-2 py-2 text-[0.65rem] text-neutral-500">
                  No appointments
                </div>
              ) : (
                dayBookings.map((b) => {
                  const start = new Date(b.starts_at);
                  const end = new Date(b.ends_at);
                  const timeLabel = `${start.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })} – ${end.toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  })}`;

                  return (
                    <Button
                      key={b.id}
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => onSelectBooking(b)}
                      className="flex w-full flex-col items-start gap-0.5 rounded-xl border border-orange-400/40 bg-orange-500/10 px-2 py-1.5 text-left text-[0.7rem] hover:bg-orange-500/20"
                    >
                      <div className="flex w-full items-center justify-between gap-2">
                        <div className="truncate font-semibold text-white">
                          {displayCustomerName(b)}
                        </div>
                        <div className="whitespace-nowrap text-[0.6rem] text-orange-200/90">
                          {timeLabel}
                        </div>
                      </div>
                      {b.notes && (
                        <div className="mt-0.5 line-clamp-2 text-[0.6rem] text-neutral-200/80">
                          {b.notes}
                        </div>
                      )}
                    </Button>
                  );
                })
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}

===============================================================================
FILE: app/portal/auth/confirm/page.tsx
===============================================================================

// app/portal/auth/confirm/page.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const COPPER = "#C57A4A";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const {
        data: { user },
      } = await supabase.auth.getUser();

      if (cancelled) return;

      router.replace(user ? "/portal/profile" : "/portal/auth/sign-in");
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Portal
        </div>

        <h1 className="mt-4 text-xl font-blackops uppercase tracking-[0.16em]">
          Finishing sign up
        </h1>

        <p className="mt-2 text-sm text-neutral-400">
          One moment… we’re completing your sign-in.
        </p>

        <div className="mt-5 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
          <div className="h-full w-1/2 animate-pulse rounded-full" style={{ backgroundColor: COPPER }} />
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/auth/sign-in/page.tsx
===============================================================================

// app/portal/auth/sign-in/page.tsx
"use client";

import { Suspense } from "react";
import PortalSignInForm from "./PortalSignInForm";

const COPPER = "#C57A4A";

function LoadingCard({ label }: { label: string }) {
  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Customer Portal
        </div>
        <div className="mt-4 text-sm text-neutral-300">{label}</div>
        <div className="mt-4 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
          <div
            className="h-full w-1/2 animate-pulse rounded-full"
            style={{ backgroundColor: COPPER }}
          />
        </div>
      </div>
    </div>
  );
}

export default function PortalSignInPage() {
  return (
    <Suspense fallback={<LoadingCard label="Loading sign in…" />}>
      <PortalSignInForm />
    </Suspense>
  );
}

===============================================================================
FILE: app/portal/auth/sign-in/PortalSignInForm.tsx
===============================================================================

// app/portal/auth/sign-in/page.tsx
"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

const COPPER = "#C57A4A";

export default function PortalSignInPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  const [email, setEmail] = useState<string>("");
  const [password, setPassword] = useState<string>("");
  const [error, setError] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const { data } = await supabase.auth.getUser();
      if (cancelled) return;
      if (data?.user) router.replace("/portal/profile");
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  const handleSignIn = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);
    setError("");

    const { error: signInError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });

    if (signInError) {
      setError(signInError.message);
      setLoading(false);
      return;
    }

    router.replace("/portal/profile");
  };

  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <header className="space-y-2">
          <div
            className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
            style={{ color: COPPER }}
          >
            Customer Portal
          </div>
          <h1 className="text-2xl font-blackops" style={{ color: COPPER }}>
            Sign in
          </h1>
          <p className="text-sm text-neutral-400">
            Use the email and password you created when you signed up.
          </p>
        </header>

        {error ? (
          <p className="mt-4 rounded-lg border border-red-500/40 bg-red-950/40 px-3 py-2 text-sm text-red-100">
            {error}
          </p>
        ) : null}

        <form onSubmit={handleSignIn} className="mt-5 space-y-4">
          <div className="space-y-1">
            <label className="block text-xs font-medium text-neutral-300">
              Email
            </label>
            <input
              type="email"
              autoComplete="email"
              placeholder="you@example.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-neutral-500 outline-none focus:ring-2"
              style={{ boxShadow: "none" }}
              required
            />
          </div>

          <div className="space-y-1">
            <label className="block text-xs font-medium text-neutral-300">
              Password
            </label>
            <input
              type="password"
              autoComplete="current-password"
              placeholder="••••••••"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white placeholder:text-neutral-500 outline-none focus:ring-2"
              required
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-2.5 text-sm font-semibold transition hover:bg-white/10 disabled:opacity-60"
          >
            <span style={{ color: COPPER }}>
              {loading ? "Signing in…" : "Sign in"}
            </span>
          </button>
        </form>

        <div className="mt-5 flex items-center justify-between text-sm text-neutral-400">
          <span>Need an account?</span>
          <Link href="/portal/auth/sign-up" className="font-semibold hover:underline" style={{ color: COPPER }}>
            Sign up
          </Link>
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/auth/sign-up/page.tsx
===============================================================================

// app/portal/auth/sign-up/page.tsx
"use client";

import { Suspense } from "react";
import PortalSignUpForm from "./PortalSignUpForm";

const COPPER = "#C57A4A";

function LoadingCard({ label }: { label: string }) {
  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Customer Portal
        </div>
        <div className="mt-4 text-sm text-neutral-300">{label}</div>
        <div className="mt-4 h-1.5 w-full overflow-hidden rounded-full border border-white/10 bg-white/5">
          <div
            className="h-full w-1/2 animate-pulse rounded-full"
            style={{ backgroundColor: COPPER }}
          />
        </div>
      </div>
    </div>
  );
}

export default function PortalSignUpPage() {
  return (
    <Suspense fallback={<LoadingCard label="Loading sign up…" />}>
      <PortalSignUpForm />
    </Suspense>
  );
}

===============================================================================
FILE: app/portal/auth/sign-up/PortalSignUpForm.tsx
===============================================================================

// app/portal/auth/sign-up/page.tsx
"use client";

import React, { useState } from "react";
import Link from "next/link";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import { Input } from "@shared/components/ui/input";
import { Button } from "@shared/components/ui/Button";

const COPPER = "#C57A4A";

export default function PortalSignUpForm() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  const [email, setEmail] = useState<string>("");
  const [password, setPassword] = useState<string>("");

  const [error, setError] = useState<string>("");
  const [notice, setNotice] = useState<string>("");
  const [loading, setLoading] = useState<boolean>(false);

  const handleSignUp = async (e: React.FormEvent) => {
    e.preventDefault();
    setError("");
    setNotice("");
    setLoading(true);

    try {
      const origin =
        typeof window !== "undefined"
          ? window.location.origin
          : process.env.NEXT_PUBLIC_SITE_URL;

      const safeOrigin = (origin ?? "").replace(/\/$/, "");
      const emailRedirectTo = `${safeOrigin}/portal/auth/confirm`;

      const { data, error: signUpError } = await supabase.auth.signUp({
        email: email.trim().toLowerCase(),
        password,
        options: { emailRedirectTo },
      });

      if (signUpError) {
        setError(signUpError.message);
      } else if (!data.session) {
        setNotice(
          "Check your email to confirm your account. After confirming, you’ll land on your profile.",
        );
      } else {
        router.replace("/portal/profile");
      }
    } catch (err: unknown) {
      const message =
        err instanceof Error
          ? err.message
          : "Unable to create your account right now.";
      setError(message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="mx-auto max-w-lg">
      <div className="rounded-2xl border border-white/10 bg-black/25 p-5 backdrop-blur-md sm:p-6">
        <header className="space-y-2">
          <div
            className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
            style={{ color: COPPER }}
          >
            Customer Portal
          </div>

          <h1 className="text-2xl font-blackops" style={{ color: COPPER }}>
            Create account
          </h1>

          <p className="text-sm text-neutral-400">
            Access service history, bookings, and documents.
          </p>
        </header>

        <form onSubmit={handleSignUp} className="mt-5 space-y-4">
          <div>
            <label className="mb-1 block text-xs font-medium text-neutral-300">
              Email
            </label>
            <Input
              type="email"
              autoComplete="email"
              placeholder="you@example.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="border-white/10 bg-white/5 text-white placeholder:text-neutral-500"
              required
            />
          </div>

          <div>
            <label className="mb-1 block text-xs font-medium text-neutral-300">
              Password
            </label>
            <Input
              type="password"
              autoComplete="new-password"
              placeholder="At least 6 characters"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="border-white/10 bg-white/5 text-white placeholder:text-neutral-500"
              required
              minLength={6}
            />
          </div>

          {error ? (
            <p className="rounded-lg border border-red-500/40 bg-red-950/40 px-3 py-2 text-sm text-red-100">
              {error}
            </p>
          ) : null}

          {notice ? (
            <p className="rounded-lg border border-emerald-500/30 bg-emerald-950/25 px-3 py-2 text-sm text-emerald-100">
              {notice}
            </p>
          ) : null}

          <Button type="submit" disabled={loading} className="w-full font-semibold">
            {loading ? "Creating account…" : "Sign up"}
          </Button>
        </form>

        <div className="mt-5 flex items-center justify-between text-sm text-neutral-400">
          <span>Already have an account?</span>
          <Link href="/portal/auth/sign-in" className="font-semibold hover:underline" style={{ color: COPPER }}>
            Sign in
          </Link>
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/booking/BookingPageClient.tsx
===============================================================================

"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import Calendar from "@shared/components/ui/Calendar";
import LinkButton from "@shared/components/ui/LinkButton";

type DB = Database;

type Slot = { start: string; end: string };
type AvailabilityResponse = { tz: string; slots: Slot[]; disabled?: boolean };

// Only the columns we actually fetch/use
type ShopOption = Pick<
  DB["public"]["Tables"]["shops"]["Row"],
  "id" | "name" | "slug" | "accepts_online_booking"
>;

type HourRow = { weekday: number; open_time: string; close_time: string };

const WEEKDAYS = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

const pad = (n: number) => (n < 10 ? `0${n}` : `${n}`);
const toYMD = (d: Date) =>
  `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;

// Format a Date in a specific IANA timezone
const fmtTime = (iso: string, tz: string) =>
  new Intl.DateTimeFormat(undefined, {
    timeZone: tz,
    hour: "2-digit",
    minute: "2-digit",
  }).format(new Date(iso));

export default function PortalBookingPage() {
  const supabase = createClientComponentClient<DB>();

  const search = useSearchParams();
  const router = useRouter();

  const [month, setMonth] = useState(() => new Date());
  const [selectedDate, setSelectedDate] = useState<Date | null>(null);

  const [loading, setLoading] = useState(false);
  const [shops, setShops] = useState<ShopOption[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");
  const [tz, setTz] = useState<string>("UTC");
  const [slots, setSlots] = useState<Slot[]>([]);

  // shop hours / closed days
  const [hours, setHours] = useState<HourRow[]>([]);

  // Load shops that accept online booking
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        toast.error("Failed to load shops.");
        return;
      }

      const list = (data ?? []) as ShopOption[];
      setShops(list);

      if (!shopSlug && list.length > 0) {
        const first = list[0].slug as string;
        setShopSlug(first);
        router.replace(`/portal/booking?shop=${encodeURIComponent(first)}`);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Compute visible month range
  const range = useMemo(() => {
    const y = month.getFullYear();
    const m = month.getMonth();
    const first = new Date(y, m, 1);
    const last = new Date(y, m + 1, 0);
    return { start: toYMD(first), end: toYMD(last) };
  }, [month]);

  // Fetch shop hours for the selected shop → used for closed days label/logic
  useEffect(() => {
    const shop = shops.find((s) => (s.slug as string) === shopSlug);
    if (!shop) return;

    (async () => {
      try {
        const res = await fetch(`/api/settings/hours?shopId=${shop.id}`, {
          cache: "no-store",
        });
        if (!res.ok) {
          setHours([]);
          return;
        }
        const j = await res.json();
        const raw: HourRow[] = Array.isArray(j?.hours) ? j.hours : [];

        const normalized = Array.from({ length: 7 }, (_, i) => {
          const found = raw.find((h) => h.weekday === i);
          const open = found?.open_time ?? "08:00";
          const close = found?.close_time ?? "17:00";
          return { weekday: i, open_time: open, close_time: close };
        });

        setHours(normalized);
      } catch {
        setHours([]);
      }
    })();
  }, [shops, shopSlug]);

  const closedWeekdays = useMemo(() => {
    const set = new Set<number>();
    hours.forEach((h) => {
      if (h.open_time === h.close_time) {
        set.add(h.weekday);
      }
    });
    return set;
  }, [hours]);

  const closedLabel = useMemo(() => {
    if (closedWeekdays.size === 0) return "";
    const names = Array.from(closedWeekdays)
      .sort()
      .map((d) => WEEKDAYS[d]);
    return names.join(", ");
  }, [closedWeekdays]);

  // Fetch availability whenever shop or month changes
  useEffect(() => {
    if (!shopSlug) return;

    (async () => {
      setLoading(true);
      try {
        const res = await fetch(
          `/api/portal/availability?shop=${encodeURIComponent(
            shopSlug,
          )}&start=${range.start}&end=${range.end}&slotMins=30`,
          { cache: "no-store" },
        );

        if (!res.ok) throw new Error("Failed to load availability.");

        const data: AvailabilityResponse = await res.json();

        if (data.disabled) {
          toast.warning("This shop is not accepting online bookings.");
          setSlots([]);
          setTz(data.tz || "UTC");
        } else {
          setSlots(data.slots || []);
          setTz(data.tz || "UTC");
        }
      } catch (err) {
        console.error(err);
        toast.error("Failed to load availability.");
      } finally {
        setLoading(false);
      }
    })();
  }, [shopSlug, range.start, range.end]);

  // Group slots by day using local Y-M-D
  const slotsByDay = useMemo(() => {
    const map = new Map<string, Slot[]>();
    (slots || []).forEach((s) => {
      const k = toYMD(new Date(s.start));
      const arr = map.get(k) ?? [];
      arr.push(s);
      map.set(k, arr);
    });
    map.forEach((arr) =>
      arr.sort((a, b) => +new Date(a.start) - +new Date(b.start)),
    );
    return map;
  }, [slots]);

  // Slots for the selected date
  const daySlots = useMemo(() => {
    if (!selectedDate) return [];
    const k = toYMD(selectedDate);
    return slotsByDay.get(k) ?? [];
  }, [selectedDate, slotsByDay]);

  async function book(startIso: string, endIso: string) {
    try {
      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: "",
        }),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(j?.error || "Booking failed");

      toast.success(
        "Appointment requested! We’ll email you when it’s confirmed.",
      );
      setSlots((prev) => prev.filter((s) => s.start !== startIso));
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Could not book.";
      toast.error(msg);
    }
  }

  const disabledDate = (d: Date) => {
    const weekday = d.getDay();
    if (closedWeekdays.has(weekday)) return true;
    return !slotsByDay.has(toYMD(d));
  };

  const isSelectedClosed =
    selectedDate && closedWeekdays.has(selectedDate.getDay());

  return (
    <div className="mx-auto max-w-5xl px-3 py-6 text-white">
      <Toaster position="top-center" />

      <div className="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Book an appointment
          </h1>
          <p className="mt-1 text-xs text-neutral-400">
            Choose a shop, then pick a date and time.
          </p>
        </div>

        <div className="flex flex-wrap items-center gap-2 rounded-2xl border border-white/10 bg-black/40 px-3 py-2 backdrop-blur-md">
          <label className="text-[0.7rem] uppercase tracking-[0.12em] text-neutral-400">
            Shop
          </label>
          <select
            value={shopSlug}
            onChange={(e) => {
              const slug = e.target.value;
              setShopSlug(slug);
              setSelectedDate(null);
              router.replace(`/portal/booking?shop=${encodeURIComponent(slug)}`);
            }}
            className="min-w-[200px] rounded-md border border-neutral-700 bg-neutral-950 px-2 py-1 text-sm text-white focus:border-orange-500 focus:outline-none focus:ring-1 focus:ring-orange-500"
          >
            {shops.map((s) => (
              <option key={s.id} value={s.slug as string}>
                {s.name}
              </option>
            ))}
          </select>

          <LinkButton href="/portal/history" variant="outline" size="sm">
            View history
          </LinkButton>
        </div>
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        <div className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card">
          <Calendar
            className="shadow-inner"
            month={month}
            onMonthChange={setMonth}
            value={selectedDate}
            onChange={setSelectedDate}
            disabled={disabledDate}
          />
        </div>

        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card">
          <h2 className="mb-1 font-semibold text-white">Available times</h2>
          <p className="mb-3 text-xs text-neutral-400">
            Times shown in <span className="font-medium">{tz}</span>.
            {closedLabel && (
              <span className="mt-1 block text-[0.7rem] text-neutral-500">
                Closed: {closedLabel}
              </span>
            )}
          </p>

          {!shopSlug ? (
            <p className="text-sm text-neutral-400">
              Select a shop to view availability.
            </p>
          ) : !selectedDate ? (
            <p className="text-sm text-neutral-400">
              Pick a date on the calendar to see times.
            </p>
          ) : loading ? (
            <p className="text-sm text-neutral-400">Loading…</p>
          ) : daySlots.length === 0 ? (
            isSelectedClosed ? (
              <p className="text-sm text-neutral-400">
                Shop is closed on this day.
              </p>
            ) : (
              <p className="text-sm text-neutral-400">
                Shop is closed or fully booked for this date.
              </p>
            )
          ) : (
            <ul className="grid grid-cols-2 gap-2">
              {daySlots.map((s, i) => (
                <li key={i}>
                  <button
                    onClick={() => book(s.start, s.end)}
                    className="w-full rounded-lg border border-orange-600 px-3 py-2 text-sm text-orange-400 transition hover:bg-orange-600 hover:text-black"
                  >
                    {fmtTime(s.start, tz)} – {fmtTime(s.end, tz)}
                  </button>
                </li>
              ))}
            </ul>
          )}
        </div>
      </div>

      <p className="mt-6 text-xs text-neutral-500">
        * Your request is pending until confirmed by the shop.
      </p>
    </div>
  );
}

===============================================================================
FILE: app/portal/booking/confirmation/BookingConfirmationClient.tsx
===============================================================================

"use client";

import { useEffect, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;

export default function BookingConfirmationClient() {
  const params = useSearchParams();
  const router = useRouter();
  const supabase = createClientComponentClient<DB>();

  const id = params.get("wo");
  const [data, setData] = useState<{
    id: string;
    status: string | null;
    scheduled_at: string | null;
  } | null>(null);

  useEffect(() => {
    if (!id) return;

    (async () => {
      const { data, error } = await supabase
        .from("work_orders")
        .select("id, status, scheduled_at")
        .eq("id", id)
        .single();

      if (error) {
        console.error(error);
        setData(null);
        return;
      }
      setData(data);
    })();
  }, [id, supabase]);

  return (
    <div className="mx-auto max-w-xl space-y-4 rounded-2xl border border-white/10 bg-black/30 p-5 text-white backdrop-blur-md shadow-card">
      <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
        Appointment confirmed
      </h1>

      {data ? (
        <div className="space-y-1 text-sm text-neutral-200">
          <div>
            <strong>Work Order:</strong> {data.id}
          </div>
          <div>
            <strong>Status:</strong> {data.status ?? "awaiting"}
          </div>
          <div>
            <strong>When:</strong>{" "}
            {data.scheduled_at
              ? new Date(data.scheduled_at).toLocaleString()
              : "Not set"}
          </div>
        </div>
      ) : (
        <p className="text-sm text-neutral-400">Loading…</p>
      )}

      <div className="flex flex-wrap gap-3 pt-2">
        <button
          className="rounded-lg border border-white/10 bg-black/40 px-4 py-2 text-sm font-semibold text-neutral-200 hover:bg-black/55"
          onClick={() => router.push("/portal")}
        >
          Go to portal
        </button>
        <button
          className="rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black"
          onClick={() => router.push("/portal/booking")}
        >
          Make another booking
        </button>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/booking/confirmation/page.tsx
===============================================================================

"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      router.replace(session?.user ? "/portal/profile" : "/portal/signin");
    })();
  }, [router, supabase]);

  return (
    <div className="mx-auto flex max-w-md items-center justify-center rounded-2xl border border-white/10 bg-black/30 p-6 text-sm text-neutral-200 backdrop-blur-md shadow-card">
      Completing sign-in…
    </div>
  );
}

export const dynamic = "force-dynamic";
export const revalidate = 0;

===============================================================================
FILE: app/portal/booking/page.tsx
===============================================================================


import { Suspense } from "react";
import BookingPageClient from "./BookingPageClient";

export default function Page() {
  return (
    <Suspense
      fallback={
        <div className="min-h-[60vh] grid place-items-center text-white">
          <p>Loading booking page…</p>
        </div>
      }
    >
      <BookingPageClient />
    </Suspense>
  );
}

===============================================================================
FILE: app/portal/confirm/page.tsx
===============================================================================

"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      router.replace(session?.user ? "/portal/profile" : "/portal/signin");
    })();
  }, [router, supabase]);

  return (
    <div className="mx-auto flex max-w-md items-center justify-center rounded-2xl border border-white/10 bg-black/30 p-6 text-sm text-neutral-200 backdrop-blur-md shadow-card">
      Completing sign-in…
    </div>
  );
}

===============================================================================
FILE: app/portal/history/components/HistoryList.tsx
===============================================================================

"use client";

import { useMemo, useState } from "react";
import type { HistoryItem } from "../types";

type Props = { items: HistoryItem[] };

const STATUS_LABELS: Record<string, string> = {
  awaiting: "Awaiting",
  scheduled: "Scheduled",
  in_progress: "In progress",
  completed: "Completed",
  on_hold: "On hold",
  cancelled: "Cancelled",
};

// Keep semantic colors, but align to glass + lighter borders.
const STATUS_CLASSES: Record<string, string> = {
  awaiting: "border border-amber-500/35 bg-amber-500/10 text-amber-200",
  scheduled: "border border-sky-500/35 bg-sky-500/10 text-sky-200",
  in_progress: "border border-orange-500/40 bg-orange-500/10 text-orange-200",
  completed: "border border-emerald-500/35 bg-emerald-500/10 text-emerald-200",
  on_hold: "border border-purple-500/35 bg-purple-500/10 text-purple-200",
  cancelled: "border border-red-500/35 bg-red-500/10 text-red-200",
};

export default function HistoryList({ items }: Props) {
  const [q, setQ] = useState("");
  const [status, setStatus] = useState("");

  const filtered = useMemo(() => {
    const needle = q.trim().toLowerCase();

    // newest → oldest by service_date
    const sorted = [...items].sort((a, b) => {
      const ta = a.service_date ? Date.parse(a.service_date) : 0;
      const tb = b.service_date ? Date.parse(b.service_date) : 0;
      return tb - ta;
    });

    return sorted.filter((h) => {
      const statusOk = !status || h.work_order?.status === status;

      const hay = [
        h.description ?? "",
        h.notes ?? "",
        h.vehicle
          ? `${h.vehicle.year ?? ""} ${h.vehicle.make ?? ""} ${
              h.vehicle.model ?? ""
            } ${h.vehicle.vin ?? ""} ${h.vehicle.license_plate ?? ""}`
          : "",
        h.work_order
          ? `${h.work_order.id ?? ""} ${h.work_order.type ?? ""} ${
              h.work_order.status ?? ""
            }`
          : "",
      ]
        .join(" ")
        .toLowerCase();

      const qOk = !needle || hay.includes(needle);
      return statusOk && qOk;
    });
  }, [items, q, status]);

  if (!items.length) {
    return (
      <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-300 backdrop-blur-md shadow-card">
        No service history yet. Once this vehicle has been in for service,
        you’ll see it here.
      </div>
    );
  }

  const hasFilters = Boolean(q || status);

  return (
    <div className="space-y-4">
      {/* Filters */}
      <div className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card">
        <div className="flex flex-wrap items-center gap-3">
          <div className="min-w-[200px] flex-1">
            <label className="mb-1 block text-[11px] uppercase tracking-[0.12em] text-neutral-400">
              Search
            </label>
            <input
              value={q}
              onChange={(e) => setQ(e.target.value)}
              className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              placeholder="Search vehicle, work order, notes…"
            />
          </div>

          <div>
            <label className="mb-1 block text-[11px] uppercase tracking-[0.12em] text-neutral-400">
              Status
            </label>
            <select
              value={status}
              onChange={(e) => setStatus(e.target.value)}
              className="min-w-[170px] rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            >
              <option value="">All statuses</option>
              <option value="awaiting">Awaiting</option>
              <option value="scheduled">Scheduled</option>
              <option value="in_progress">In progress</option>
              <option value="completed">Completed</option>
              <option value="on_hold">On hold</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>

          {hasFilters && (
            <button
              className="ml-auto rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-200 hover:bg-black/55"
              onClick={() => {
                setQ("");
                setStatus("");
              }}
            >
              Clear filters
            </button>
          )}
        </div>

        <div className="mt-2 text-xs text-neutral-400">
          Showing{" "}
          <span className="font-semibold text-orange-300">
            {filtered.length}
          </span>{" "}
          of {items.length} visits
        </div>
      </div>

      {/* Empty-after-filter */}
      {filtered.length === 0 ? (
        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-300 backdrop-blur-md shadow-card">
          No service visits match your filters. Try clearing the search or
          choosing a different status.
        </div>
      ) : (
        <ul className="space-y-3">
          {filtered.map((h) => {
            const statusKey = h.work_order?.status ?? "";
            const statusLabel =
              STATUS_LABELS[statusKey] ?? (statusKey || "Unknown");
            const statusClass =
              STATUS_CLASSES[statusKey] ??
              "border border-white/10 bg-black/40 text-neutral-200";

            const title = h.vehicle
              ? `${h.vehicle.year ?? ""} ${h.vehicle.make ?? ""} ${
                  h.vehicle.model ?? ""
                }`.trim() || "Vehicle"
              : "Vehicle";

            return (
              <li
                key={h.id}
                className="rounded-2xl border border-white/10 bg-black/30 p-3 backdrop-blur-md shadow-card"
              >
                <div className="flex flex-wrap items-center justify-between gap-2">
                  <div className="text-xs text-neutral-400">
                    {formatDate(h.service_date)}
                  </div>

                  {h.work_order && (
                    <span
                      className={`inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium ${statusClass}`}
                    >
                      {statusLabel}
                    </span>
                  )}
                </div>

                <div className="mt-1 text-sm font-semibold text-neutral-50">
                  {title}
                  {h.work_order && (
                    <span className="ml-1 text-xs font-normal text-neutral-400">
                      · WO #{h.work_order.id}
                    </span>
                  )}
                </div>

                {h.vehicle && (
                  <div className="mt-0.5 text-xs text-neutral-400">
                    {h.vehicle.vin && (
                      <span className="mr-3">
                        VIN:{" "}
                        <span className="font-mono text-neutral-200">
                          {h.vehicle.vin}
                        </span>
                      </span>
                    )}
                    {h.vehicle.license_plate && (
                      <span>
                        Plate:{" "}
                        <span className="font-mono text-neutral-200">
                          {h.vehicle.license_plate}
                        </span>
                      </span>
                    )}
                  </div>
                )}

                {h.description && (
                  <div className="mt-2 text-sm text-neutral-200">
                    {h.description}
                  </div>
                )}

                {h.notes && (
                  <div className="mt-1 text-xs text-neutral-400">
                    {h.notes}
                  </div>
                )}
              </li>
            );
          })}
        </ul>
      )}
    </div>
  );
}

function formatDate(iso: string | null): string {
  if (!iso) return "—";
  try {
    return new Date(iso).toLocaleString(undefined, {
      year: "numeric",
      month: "short",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    });
  } catch {
    return iso;
  }
}

===============================================================================
FILE: app/portal/history/page.tsx
===============================================================================

export const dynamic = "force-dynamic";
export const revalidate = 0;

// app/portal/history/page.tsx
import { cookies } from "next/headers";
import Link from "next/link";
import { createServerComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import HistoryList from "./components/HistoryList";

export default async function HistoryPage() {
  const supabase = createServerComponentClient<Database>({ cookies });

  // Ensure user is logged in
  const {
    data: { user },
    error: userErr,
  } = await supabase.auth.getUser();

  if (userErr) {
    console.error("Error getting user:", userErr);
  }

  if (!user) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Service history
          </h1>
          <p className="text-xs text-neutral-400">
            Sign in to view your previous visits.
          </p>
        </header>

        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-200 backdrop-blur-md shadow-card">
          <p>You need to be signed in to view your service history.</p>
          <Link
            href="/portal/signin"
            className="mt-3 inline-flex items-center justify-center rounded-lg border border-orange-600 px-3 py-2 text-xs font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black"
          >
            Go to sign in
          </Link>
        </div>
      </div>
    );
  }

  // Find the customer row linked to this auth user
  const { data: customer, error: custErr } = await supabase
    .from("customers")
    .select("id")
    .eq("user_id", user.id)
    .maybeSingle();

  if (custErr) {
    console.error("Error loading customer:", custErr);
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Service history
          </h1>
        </header>

        <div className="rounded-2xl border border-red-500/35 bg-red-900/20 p-4 text-sm text-red-100 backdrop-blur-md shadow-card">
          Failed to load your customer profile. Please try again later.
        </div>
      </div>
    );
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Service history
          </h1>
          <p className="text-xs text-neutral-400">
            Complete your profile so we can connect your visits.
          </p>
        </header>

        <div className="rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-200 backdrop-blur-md shadow-card">
          <p>
            We couldn’t find a customer profile linked to your account yet.
            Complete your profile so we can connect your visits.
          </p>
          <Link
            href="/portal/profile"
            className="mt-3 inline-flex items-center justify-center rounded-lg border border-orange-600 px-3 py-2 text-xs font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black"
          >
            Go to profile
          </Link>
        </div>
      </div>
    );
  }

  // Fetch history records joined with vehicle + work order
  const { data: history, error } = await supabase
    .from("history")
    .select(
      `
      *,
      vehicle:vehicles(id, year, make, model, vin, license_plate),
      work_order:work_orders(id, status, type)
    `,
    )
    .eq("customer_id", customer.id)
    .order("created_at", { ascending: false });

  if (error) {
    console.error("Error loading history:", error);
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <header className="space-y-1">
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Service history
          </h1>
        </header>

        <div className="rounded-2xl border border-red-500/35 bg-red-900/20 p-4 text-sm text-red-100 backdrop-blur-md shadow-card">
          Failed to load history.
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-3xl space-y-4 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
          Service history
        </h1>
        <p className="text-xs text-neutral-400">
          Past visits, notes, and work orders linked to your vehicles.
        </p>
      </header>

      <HistoryList items={history || []} />
    </div>
  );
}

===============================================================================
FILE: app/portal/history/types.ts
===============================================================================

import type { Database } from "@shared/types/types/supabase";

export type Vehicle = Database["public"]["Tables"]["vehicles"]["Row"];
export type WorkOrder = Database["public"]["Tables"]["work_orders"]["Row"];
export type HistoryRow = Database["public"]["Tables"]["history"]["Row"];

/**
 * Small shapes the UI needs. These keep us compatible even if your
 * work_orders table doesn’t actually have `status` or `type` right now.
 */
type VehicleMini = {
  id: Vehicle["id"];
  year: Vehicle["year"];
  make: Vehicle["make"];
  model: Vehicle["model"];
  vin: Vehicle extends { vin: infer V } ? V | null : string | null;
  license_plate: Vehicle extends { license_plate: infer P }
    ? P | null
    : string | null;
};

type WorkOrderMini = {
  id: WorkOrder["id"];
  // optional so UI can render even if your table lacks these columns
  status?: string | null;
  type?: string | null;
};

/** Joined shape returned by our select in page.tsx */
export type HistoryItem = Omit<HistoryRow, "vehicle_id" | "work_order_id"> & {
  vehicle: VehicleMini | null;
  work_order: WorkOrderMini | null;
};

===============================================================================
FILE: app/portal/layout.tsx
===============================================================================

// app/portal/layout.tsx
import React from "react";
import PortalAppShell from "@/features/portal/components/PortalShell";

export default function PortalLayout({ children }: { children: React.ReactNode }) {
  return <PortalAppShell>{children}</PortalAppShell>;
}

===============================================================================
FILE: app/portal/page.tsx
===============================================================================

// app/portal/page.tsx
"use client";

import Link from "next/link";

function StatCard({
  title,
  value,
  sub,
}: {
  title: string;
  value: string;
  sub?: string;
}) {
  return (
    <div className="rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-4 backdrop-blur">
      <div className="text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
        {title}
      </div>
      <div className="mt-2 text-2xl font-blackops text-orange-500">{value}</div>
      {sub ? <div className="mt-1 text-xs text-neutral-500">{sub}</div> : null}
    </div>
  );
}

export default function PortalHomePage() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-blackops text-orange-500">Home</h1>
        <p className="mt-1 text-sm text-neutral-400">
          Quick overview — just like the mobile dashboard.
        </p>
      </div>

      {/* Summary row */}
      <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
        <StatCard title="Upcoming" value="—" sub="Next appointment" />
        <StatCard title="Vehicles" value="—" sub="Saved to your account" />
        <StatCard title="Last visit" value="—" sub="Most recent service" />
      </div>

      {/* Quick actions */}
      <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
        <Link
          href="/portal/booking"
          className="rounded-2xl border border-orange-500/40 bg-orange-500/10 p-4 text-sm font-semibold text-orange-300 transition hover:bg-orange-500/15"
        >
          📅 Book an appointment
          <div className="mt-1 text-xs font-normal text-neutral-400">
            Pick a shop, choose time, confirm.
          </div>
        </Link>

        <Link
          href="/portal/vehicles"
          className="rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-4 text-sm font-semibold text-neutral-100 backdrop-blur transition hover:bg-neutral-900/50"
        >
          🚗 Manage vehicles
          <div className="mt-1 text-xs font-normal text-neutral-400">
            Add VIN, plate, mileage, color.
          </div>
        </Link>
      </div>

      {/* Recent activity block */}
      <div className="rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-4 backdrop-blur">
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">Recent activity</h2>
          <Link href="/portal/appointments" className="text-xs text-orange-300 underline underline-offset-2">
            View appointments
          </Link>
        </div>

        <div className="mt-3 rounded-xl border border-dashed border-neutral-800/70 bg-neutral-950/30 p-3 text-sm text-neutral-400">
          No activity yet. Once you book, your timeline will show here.
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/profile/page.tsx
===============================================================================

"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

type CustomerRow = Database["public"]["Tables"]["customers"]["Row"];

// Local form shape = all strings so inputs are happy
type CustomerForm = {
  first_name: string;
  last_name: string;
  phone: string;
  email: string;
  street: string;
  city: string;
  province: string;
  postal_code: string;
};

const emptyForm: CustomerForm = {
  first_name: "",
  last_name: "",
  phone: "",
  email: "",
  street: "",
  city: "",
  province: "",
  postal_code: "",
};

export default function PortalProfilePage() {
  const supabase = createClientComponentClient<Database>();

  const [form, setForm] = useState<CustomerForm>(emptyForm);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [saved, setSaved] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);
      setError(null);
      setSaved(false);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr) {
        if (!cancelled) setError(userErr.message);
        setLoading(false);
        return;
      }
      if (!user) {
        if (!cancelled) setError("You must be signed in.");
        setLoading(false);
        return;
      }

      const { data: customer, error: fetchErr } = await supabase
        .from("customers")
        .select(
          "first_name,last_name,phone,email,street,city,province,postal_code",
        )
        .eq("user_id", user.id)
        .maybeSingle<CustomerRow>();

      if (fetchErr) {
        if (!cancelled) setError(fetchErr.message);
        setLoading(false);
        return;
      }

      if (!cancelled) {
        setForm({
          first_name: customer?.first_name ?? "",
          last_name: customer?.last_name ?? "",
          phone: customer?.phone ?? "",
          email: customer?.email ?? "",
          street: customer?.street ?? "",
          city: customer?.city ?? "",
          province: customer?.province ?? "",
          postal_code: customer?.postal_code ?? "",
        });
        setLoading(false);
      }
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase]);

  const onSave = async () => {
    setSaving(true);
    setError(null);
    setSaved(false);

    const {
      data: { user },
      error: userErr,
    } = await supabase.auth.getUser();

    if (userErr || !user) {
      setError(userErr?.message || "You must be signed in.");
      setSaving(false);
      return;
    }

    // convert "" → null for nullable DB columns
    const toNull = (s: string) => (s.trim() === "" ? null : s.trim());

    const { error: updateErr } = await supabase
      .from("customers")
      .update({
        first_name: toNull(form.first_name),
        last_name: toNull(form.last_name),
        phone: toNull(form.phone),
        email: toNull(form.email),
        street: toNull(form.street),
        city: toNull(form.city),
        province: toNull(form.province),
        postal_code: toNull(form.postal_code),
      })
      .eq("user_id", user.id);

    if (updateErr) {
      setError(updateErr.message);
    } else {
      setSaved(true);
    }
    setSaving(false);
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-xl rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-200 backdrop-blur-md shadow-card">
        Loading your profile…
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-xl space-y-5 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
          My profile
        </h1>
        <p className="text-xs text-neutral-400">
          Keep your contact details up to date so your shop can reach you
          easily.
        </p>
      </header>

      <div className="space-y-4 rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card sm:p-6">
        {error ? (
          <div className="rounded-xl border border-red-500/35 bg-red-900/20 px-3 py-2 text-sm text-red-100">
            {error}
          </div>
        ) : null}

        {saved ? (
          <div className="rounded-xl border border-emerald-500/35 bg-emerald-900/15 px-3 py-2 text-sm text-emerald-100">
            Saved!
          </div>
        ) : null}

        {/* Contact */}
        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <input
            className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            placeholder="First name"
            value={form.first_name}
            onChange={(e) => setForm({ ...form, first_name: e.target.value })}
          />
          <input
            className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            placeholder="Last name"
            value={form.last_name}
            onChange={(e) => setForm({ ...form, last_name: e.target.value })}
          />
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <input
            className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            placeholder="Phone"
            value={form.phone}
            onChange={(e) => setForm({ ...form, phone: e.target.value })}
          />
          <input
            className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            placeholder="Email"
            value={form.email}
            onChange={(e) => setForm({ ...form, email: e.target.value })}
          />
        </div>

        {/* Address */}
        <div className="space-y-3">
          <input
            className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
            placeholder="Street address"
            value={form.street}
            onChange={(e) => setForm({ ...form, street: e.target.value })}
          />

          <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
            <input
              className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              placeholder="City"
              value={form.city}
              onChange={(e) => setForm({ ...form, city: e.target.value })}
            />
            <input
              className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              placeholder="Province/State"
              value={form.province}
              onChange={(e) => setForm({ ...form, province: e.target.value })}
            />
            <input
              className="w-full rounded-lg border border-white/10 bg-black/40 px-3 py-2 text-sm text-white outline-none placeholder:text-neutral-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              placeholder="Postal/ZIP code"
              value={form.postal_code}
              onChange={(e) =>
                setForm({ ...form, postal_code: e.target.value })
              }
            />
          </div>
        </div>

        <button
          className="mt-2 inline-flex items-center justify-center rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
          onClick={onSave}
          disabled={saving}
        >
          {saving ? "Saving…" : "Save"}
        </button>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/settings/page.tsx
===============================================================================

"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";

import type { Database } from "@shared/types/types/supabase";
import LinkButton from "@shared/components/ui/LinkButton";

type Customer = Database["public"]["Tables"]["customers"]["Row"];
type SettingsRow = Database["public"]["Tables"]["customer_settings"]["Row"];
type SettingsInsert = Database["public"]["Tables"]["customer_settings"]["Insert"];

export default function PortalSettingsPage() {
  const supabase = createClientComponentClient<Database>();

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [customer, setCustomer] = useState<Customer | null>(null);

  const [form, setForm] = useState<SettingsRow>({
    customer_id: "",
    comm_email_enabled: true,
    comm_sms_enabled: false,
    marketing_opt_in: false,
    preferred_contact: "email",
    units: "imperial",
    language: "en",
    timezone: "UTC",
    updated_at: new Date().toISOString(),
  });

  const tzOptions = useMemo(
    () => [
      "UTC",
      "America/New_York",
      "America/Chicago",
      "America/Denver",
      "America/Los_Angeles",
      "America/Phoenix",
      "Europe/London",
      "Europe/Paris",
      "Asia/Tokyo",
      "Australia/Sydney",
    ],
    [],
  );

  useEffect(() => {
    (async () => {
      setLoading(true);
      setError(null);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();
      if (userErr || !user) {
        setError("You must be signed in to view settings.");
        setLoading(false);
        return;
      }

      const { data: cust, error: custErr } = await supabase
        .from("customers")
        .select("*")
        .eq("user_id", user.id)
        .single();

      if (custErr || !cust) {
        setError(
          "We couldn't find your customer profile. Please complete your profile first.",
        );
        setLoading(false);
        return;
      }

      setCustomer(cust);

      const { data: existing, error: settingsErr } = await supabase
        .from("customer_settings")
        .select("*")
        .eq("customer_id", cust.id)
        .maybeSingle();

      if (settingsErr) {
        setError(settingsErr.message);
        setLoading(false);
        return;
      }

      if (existing) {
        setForm(existing);
      } else {
        const defaults: SettingsInsert = {
          customer_id: cust.id,
          comm_email_enabled: true,
          comm_sms_enabled: false,
          marketing_opt_in: false,
          preferred_contact: "email",
          units: "imperial",
          language: "en",
          timezone: "UTC",
        };

        await supabase
          .from("customer_settings")
          .upsert(defaults)
          .select()
          .single();

        setForm({
          ...(defaults as SettingsRow),
          updated_at: new Date().toISOString(),
        });
      }

      setLoading(false);
    })();
  }, [supabase]);

  const update = <K extends keyof SettingsRow>(key: K, value: SettingsRow[K]) =>
    setForm((f) => ({ ...f, [key]: value }));

  const onSave = async () => {
    if (!customer) return;
    setSaving(true);
    setError(null);

    const payload: SettingsInsert = {
      customer_id: customer.id,
      comm_email_enabled: form.comm_email_enabled,
      comm_sms_enabled: form.comm_sms_enabled,
      marketing_opt_in: form.marketing_opt_in,
      preferred_contact: form.preferred_contact ?? "email",
      units: form.units ?? "imperial",
      language: form.language ?? "en",
      timezone: form.timezone ?? "UTC",
    };

    const { error: upsertErr } = await supabase
      .from("customer_settings")
      .upsert(payload, { onConflict: "customer_id" });

    if (upsertErr) {
      setError(upsertErr.message);
    } else {
      update(
        "updated_at",
        new Date().toISOString() as SettingsRow["updated_at"],
      );
    }
    setSaving(false);
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-2xl rounded-2xl border border-white/10 bg-black/30 p-4 text-sm text-neutral-200 backdrop-blur-md shadow-card">
        Loading your settings…
      </div>
    );
  }

  if (error) {
    return (
      <div className="mx-auto max-w-2xl space-y-4 text-white">
        <header>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
            Settings
          </h1>
        </header>

        <div className="space-y-3 rounded-2xl border border-red-500/35 bg-red-900/20 p-4 text-sm backdrop-blur-md shadow-card">
          <p className="text-red-100">{error}</p>
          <LinkButton href="/portal/profile" variant="outline" size="sm">
            Go to profile
          </LinkButton>
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-2xl space-y-6 text-white">
      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-300">
          Settings
        </h1>
        <p className="text-xs text-neutral-400">
          Choose how we contact you and how information is displayed.
        </p>
      </header>

      <section className="space-y-3 rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card sm:p-5">
        <h2 className="text-sm font-semibold text-neutral-50">
          Communication
        </h2>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4 accent-orange-500"
            checked={!!form.comm_email_enabled}
            onChange={(e) => update("comm_email_enabled", e.target.checked)}
          />
          <span>Email notifications</span>
        </label>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4 accent-orange-500"
            checked={!!form.comm_sms_enabled}
            onChange={(e) => update("comm_sms_enabled", e.target.checked)}
          />
          <span>SMS notifications</span>
        </label>

        <label className="flex items-center gap-3 text-sm text-neutral-100">
          <input
            type="checkbox"
            className="h-4 w-4 accent-orange-500"
            checked={!!form.marketing_opt_in}
            onChange={(e) => update("marketing_opt_in", e.target.checked)}
          />
          <span>Receive service tips &amp; updates</span>
        </label>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs text-neutral-400">
              Preferred contact
            </label>
            <select
              className="w-full rounded-lg border border-white/10 bg-black/40 p-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              value={form.preferred_contact ?? "email"}
              onChange={(e) =>
                update(
                  "preferred_contact",
                  e.target.value as SettingsRow["preferred_contact"],
                )
              }
            >
              <option value="email">Email</option>
              <option value="sms">SMS</option>
              <option value="phone">Phone</option>
            </select>
          </div>
        </div>
      </section>

      <section className="space-y-3 rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card sm:p-5">
        <h2 className="text-sm font-semibold text-neutral-50">Display</h2>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-2">
          <div>
            <label className="mb-1 block text-xs text-neutral-400">Units</label>
            <select
              className="w-full rounded-lg border border-white/10 bg-black/40 p-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              value={form.units ?? "imperial"}
              onChange={(e) =>
                update("units", e.target.value as SettingsRow["units"])
              }
            >
              <option value="imperial">Imperial (mi, °F)</option>
              <option value="metric">Metric (km, °C)</option>
            </select>
          </div>

          <div>
            <label className="mb-1 block text-xs text-neutral-400">
              Language
            </label>
            <select
              className="w-full rounded-lg border border-white/10 bg-black/40 p-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              value={form.language ?? "en"}
              onChange={(e) => update("language", e.target.value)}
            >
              <option value="en">English</option>
            </select>
          </div>

          <div className="sm:col-span-2">
            <label className="mb-1 block text-xs text-neutral-400">
              Timezone
            </label>
            <select
              className="w-full rounded-lg border border-white/10 bg-black/40 p-2 text-sm text-white outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500"
              value={form.timezone ?? "UTC"}
              onChange={(e) => update("timezone", e.target.value)}
            >
              {tzOptions.map((tz) => (
                <option key={tz} value={tz}>
                  {tz}
                </option>
              ))}
            </select>
          </div>
        </div>
      </section>

      <div className="flex flex-wrap items-center gap-3">
        <button
          onClick={onSave}
          disabled={saving}
          className="inline-flex items-center justify-center rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-300 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
        >
          {saving ? "Saving…" : "Save settings"}
        </button>
        <span className="text-xs text-neutral-400">
          Last updated:{" "}
          {form.updated_at ? new Date(form.updated_at).toLocaleString() : "—"}
        </span>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/shop/[slug]/metadata.ts
===============================================================================

// app/portal/shop/[slug]/metadata.ts
import type { Metadata } from "next";

export async function generateMetadata({
  params,
}: {
  params: Promise<{ slug: string }>;
}): Promise<Metadata> {
  const { slug } = await params;
  return { title: `Booking QR — ${slug} | ProFixIQ` };
}

===============================================================================
FILE: app/portal/shop/[slug]/PageClient.tsx
===============================================================================

// app/portal/shop/[slug]/PageClient.tsx
"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

import ShareBox from "./ShareBox";
import ReviewsList from "@shared/components/reviews/ReviewsList";
import ReviewForm from "@shared/components/reviews/ReviewForm";

type Props = {
  slug: string;
  /** Pass from server if you already looked it up; otherwise we’ll fetch by slug. */
  shopId?: string;
};

export default function ShopSharePage({ slug, shopId: shopIdProp }: Props) {
  const supabase = createClientComponentClient<Database>();
  const [shopId, setShopId] = useState<string>(shopIdProp ?? "");
  const [loadingShopId, setLoadingShopId] = useState(!shopIdProp);

  useEffect(() => {
    if (shopIdProp) return; // already provided by server
    (async () => {
      setLoadingShopId(true);
      const { data } = await supabase
        .from("shops")
        .select("id")
        .eq("slug", slug)
        .maybeSingle();
      if (data?.id) setShopId(data.id);
      setLoadingShopId(false);
    })();
  }, [slug, shopIdProp, supabase]);

  /** Build a base URL that works in all environments */
  const base =
    typeof process !== "undefined" && process.env.NEXT_PUBLIC_BASE_URL
      ? process.env.NEXT_PUBLIC_BASE_URL
      : typeof window !== "undefined" && window.location?.origin
      ? window.location.origin
      : "https://example.com";

  const bookingUrl = `${base}/portal/booking?shop=${encodeURIComponent(slug)}`;
  const qrSrc = `/api/portal/qr?shop=${encodeURIComponent(slug)}`;

  return (
    <div className="mx-auto max-w-3xl space-y-8 py-6">
      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-400">
          Share your booking link
        </h1>
        <p className="text-sm text-neutral-400">
          Copy your booking link, download a QR code, and manage reviews for this
          shop.
        </p>
      </header>

      <ShareBox slug={slug} bookingUrl={bookingUrl} qrSrc={qrSrc} />

      {/* Reviews */}
      <section className="space-y-4">
        <div className="flex items-center justify-between gap-2">
          <h2 className="text-lg font-semibold text-neutral-50">
            Customer reviews
          </h2>
          {loadingShopId && (
            <span className="text-xs text-neutral-500">Loading shop…</span>
          )}
        </div>

        {shopId ? (
          <>
            <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 p-4">
              <ReviewsList shopId={shopId} />
            </div>
            <div className="rounded-xl border border-neutral-800 bg-neutral-950/80 p-4">
              <ReviewForm shopId={shopId} />
            </div>
          </>
        ) : !loadingShopId ? (
          <div className="rounded-xl border border-red-700/40 bg-red-900/30 p-3 text-sm text-red-100">
            We couldn’t resolve this shop. Check that the share link uses a valid
            slug.
          </div>
        ) : null}
      </section>
    </div>
  );
}

===============================================================================
FILE: app/portal/shop/[slug]/page.tsx
===============================================================================

// app/portal/shop/[slug]/page.tsx
import type { Metadata } from "next";
import PublicProfileClient from "./ShopPublicProfileView";

export const dynamic = "force-dynamic";
export const revalidate = 0;

type PageProps = {
  params: Promise<{ slug: string }>;
};

export async function generateMetadata(
  props: PageProps
): Promise<Metadata> {
  const { slug } = await props.params;
  return {
    title: `Shop • ${slug} | ProFixIQ`,
  };
}

export default async function Page(props: PageProps) {
  const { slug } = await props.params;
  return <PublicProfileClient slug={slug} />;
}

===============================================================================
FILE: app/portal/shop/[slug]/ShareBox.tsx
===============================================================================

// app/portal/shop/[slug]/ShareBox.tsx
"use client";

import { useState } from "react";
import LinkButton from "@shared/components/ui/LinkButton";
import { toast } from "sonner";

export default function ShareBox({
  slug,
  bookingUrl,
  qrSrc,
}: {
  slug: string;
  bookingUrl: string;
  qrSrc: string;
}) {
  const [copying, setCopying] = useState(false);
  const [downloading, setDownloading] = useState(false);

  async function copyLink() {
    try {
      setCopying(true);
      await navigator.clipboard.writeText(bookingUrl);
      toast.success("Booking link copied!");
    } catch {
      toast.error("Couldn’t copy link");
    } finally {
      setCopying(false);
    }
  }

  async function downloadQR() {
    try {
      setDownloading(true);
      const res = await fetch(qrSrc, { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to fetch QR");
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `profixiq-booking-${slug}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast.success("QR code downloaded");
    } catch {
      toast.error("Couldn’t download QR");
    } finally {
      setDownloading(false);
    }
  }

  return (
    <div className="space-y-6 rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4 sm:p-5">
      {/* Booking link */}
      <div className="space-y-2">
        <label className="block text-xs font-medium uppercase tracking-[0.12em] text-neutral-400">
          Booking link
        </label>
        <div className="flex flex-col gap-2 sm:flex-row">
          <input
            readOnly
            value={bookingUrl}
            className="flex-1 rounded-lg border border-neutral-700 bg-neutral-900 px-3 py-2 text-sm text-white outline-none focus:border-orange-400 focus:ring-1 focus:ring-orange-500"
          />
          <button
            onClick={copyLink}
            disabled={copying}
            className="rounded-lg border border-orange-600 px-3 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
          >
            {copying ? "Copying…" : "Copy link"}
          </button>
        </div>
      </div>

      {/* QR + actions */}
      <div className="grid grid-cols-1 items-start gap-4 sm:grid-cols-[auto,1fr]">
        {/* eslint-disable-next-line @next/next/no-img-element */}
        <img
          src={qrSrc}
          alt="Booking QR code"
          className="h-44 w-44 rounded-lg border border-neutral-800 bg-black p-2"
        />

        <div className="space-y-3 text-sm text-neutral-300">
          <p>
            Print this QR and place it at your counter. Customers can scan it to
            open your booking page for{" "}
            <span className="font-mono text-orange-400">@{slug}</span>.
          </p>

          <div className="flex flex-wrap gap-2">
            <LinkButton
              href={`/portal/booking?shop=${encodeURIComponent(slug)}`}
              className="rounded-lg border border-orange-600 bg-orange-600 px-3 py-2 text-sm font-semibold text-black transition hover:bg-orange-500"
            >
              Open booking page
            </LinkButton>

            <button
              onClick={downloadQR}
              disabled={downloading}
              className="rounded-lg border border-orange-600 px-3 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black disabled:opacity-60"
            >
              {downloading ? "Downloading…" : "Download QR"}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/shop/[slug]/ShopPublicProfileView.tsx
===============================================================================

"use client";

import { useEffect, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";
import Link from "next/link";

type DB = Database;
type ShopsRow = DB["public"]["Tables"]["shops"]["Row"];

type Props = { slug: string };

type PublicFields = Pick<
  ShopsRow,
  | "name"
  | "phone_number"
  | "email"
  | "address"
  | "city"
  | "province"
  | "postal_code"
  | "images"
  | "geo_lat"
  | "geo_lng"
> & {
  description?: string | null;
  website?: string | null;
};

const emptyPublic: PublicFields = {
  name: "",
  phone_number: null,
  email: null,
  address: null,
  city: null,
  province: null,
  postal_code: null,
  images: null,
  geo_lat: null,
  geo_lng: null,
  description: null,
  website: null,
};

export default function PublicProfileClient({ slug }: Props) {
  const supabase = createClientComponentClient<DB>();
  const [data, setData] = useState<PublicFields>(emptyPublic);
  const [loading, setLoading] = useState(true);
  const [notFound, setNotFound] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const { data: row, error } = await supabase
        .from("shops")
        .select(
          [
            "name",
            "phone_number",
            "email",
            "address",
            "city",
            "province",
            "postal_code",
            "images",
            "geo_lat",
            "geo_lng",
            // Uncomment if these exist in your DB:
            // "description",
            // "website",
          ].join(","),
        )
        .eq("slug", slug)
        .maybeSingle<ShopsRow>();

      if (cancelled) return;

      if (error || !row) {
        setNotFound(true);
        setLoading(false);
        return;
      }

      const next: PublicFields = {
        name: row.name ?? "",
        phone_number: row.phone_number ?? null,
        email: row.email ?? null,
        address: row.address ?? null,
        city: row.city ?? null,
        province: row.province ?? null,
        postal_code: row.postal_code ?? null,
        images: row.images ?? null,
        geo_lat: row.geo_lat ?? null,
        geo_lng: row.geo_lng ?? null,
        // description: row.description ?? null, // if column exists
        // website: row.website ?? null,         // if column exists
      };

      setData(next);
      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [slug, supabase]);

  // Defensive: ensure we always have an array
  const images: string[] = Array.isArray(data.images)
    ? (data.images as string[])
    : [];
  const hero = images[0] ?? null;
  const gallery = images.slice(1);

  if (loading) {
    return (
      <div className="mx-auto max-w-4xl p-6 text-sm text-neutral-400">
        Loading shop…
      </div>
    );
  }

  if (notFound) {
    return (
      <div className="mx-auto max-w-4xl px-4 py-8 space-y-2">
        <h1 className="text-2xl font-blackops text-orange-400">
          Shop not found
        </h1>
        <p className="text-sm text-neutral-400">
          We couldn’t find a shop with slug{" "}
          <span className="font-mono">{slug}</span>.
        </p>
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-5xl space-y-8 px-4 py-8">
      {/* Hero */}
      {hero && (
        <div className="overflow-hidden rounded-2xl border border-neutral-800">
          {/* eslint-disable-next-line @next/next/no-img-element */}
          <img
            src={hero}
            alt={`${data.name} hero`}
            className="h-64 w-full object-cover"
          />
        </div>
      )}

      {/* Header */}
      <header className="space-y-1">
        <h1 className="text-3xl font-blackops text-orange-400">
          {data.name}
        </h1>
        {data.description ? (
          <p className="text-sm text-neutral-300">{data.description}</p>
        ) : null}
      </header>

      {/* Contact / Basics */}
      <section className="grid grid-cols-1 gap-4 md:grid-cols-3">
        <div className="rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4">
          <h2 className="mb-2 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
            Contact
          </h2>
          <ul className="space-y-1 text-sm text-neutral-100">
            {data.phone_number ? <li>📞 {data.phone_number}</li> : null}
            {data.email ? <li>✉️ {data.email}</li> : null}
            {data.website ? (
              <li>
                🌐{" "}
                <a
                  href={data.website}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-orange-400 underline underline-offset-2"
                >
                  {data.website}
                </a>
              </li>
            ) : null}
          </ul>
        </div>

        <div className="rounded-2xl border border-neutral-800 bg-neutral-950/80 p-4 md:col-span-2">
          <h2 className="mb-2 text-xs font-semibold uppercase tracking-[0.12em] text-neutral-400">
            Location
          </h2>
          <p className="text-sm text-neutral-100">
            {[data.address, data.city, data.province, data.postal_code]
              .filter(Boolean)
              .join(", ")}
          </p>

          {data.geo_lat !== null && data.geo_lng !== null ? (
            <p className="mt-2 text-sm">
              <a
                className="text-orange-400 underline underline-offset-2"
                href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                  `${data.geo_lat},${data.geo_lng}`,
                )}`}
                target="_blank"
                rel="noopener noreferrer"
              >
                Open in Google Maps
              </a>
            </p>
          ) : null}
        </div>
      </section>

      {/* Gallery */}
      {gallery.length > 0 && (
        <section className="space-y-3">
          <h2 className="text-sm font-semibold text-neutral-50">Gallery</h2>
          <div className="grid grid-cols-2 gap-3 sm:grid-cols-3">
            {gallery.map((url) => (
              // eslint-disable-next-line @next/next/no-img-element
              <img
                key={url}
                src={url}
                alt="Shop photo"
                className="h-40 w-full rounded-lg border border-neutral-800 object-cover"
              />
            ))}
          </div>
        </section>
      )}

      {/* Primary CTA to book */}
      <div className="pt-2">
        <Link
          href={`/portal/booking?shop=${encodeURIComponent(slug)}`}
          className="inline-flex items-center rounded-lg border border-orange-600 px-4 py-2 text-sm font-semibold text-orange-400 transition hover:bg-orange-600 hover:text-black"
        >
          Book an appointment
        </Link>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/portal/vehicles/page.tsx
===============================================================================

// app/portal/vehicles/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

/** Minimal shapes (keep lint happy, no `any`, no big supabase types) */
type VehicleRow = {
  id: string;
  customer_id: string | null;
  year: number | null;
  make: string | null;
  model: string | null;
  vin: string | null;
  license_plate: string | null;
  mileage: string | null;
  color: string | null;
  created_at?: string | null;
};

type CustomerRow = {
  id: string;
  user_id: string;
  first_name?: string | null;
  last_name?: string | null;
};

type VehicleForm = {
  year: string; // keep as string in UI
  make: string;
  model: string;
  vin: string;
  license_plate: string;
  mileage: string;
  color: string;
};

export default function PortalVehiclesPage() {
  const supabase = createClientComponentClient<Database>();

  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [vehicles, setVehicles] = useState<VehicleRow[]>([]);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const [editingId, setEditingId] = useState<string | null>(null);
  const [form, setForm] = useState<VehicleForm>({
    year: "",
    make: "",
    model: "",
    vin: "",
    license_plate: "",
    mileage: "",
    color: "",
  });

  const isEdit = useMemo(() => Boolean(editingId), [editingId]);

  useEffect(() => {
    (async () => {
      setLoading(true);
      setError(null);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr || !user) {
        setError("You must be signed in.");
        setLoading(false);
        return;
      }

      const { data: cust, error: custErr } = await supabase
        .from("customers")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();

      if (custErr) setError(custErr.message);

      if (cust) {
        const typed = cust as unknown as CustomerRow;
        setCustomer(typed);

        const { data: v, error: vehErr } = await supabase
          .from("vehicles")
          .select("*")
          .eq("customer_id", typed.id)
          .order("created_at", { ascending: false });

        if (vehErr) setError(vehErr.message);
        setVehicles((v as unknown as VehicleRow[]) ?? []);
      } else {
        setCustomer(null);
        setVehicles([]);
      }

      setLoading(false);
    })();
  }, [supabase]);

  const resetForm = () => {
    setEditingId(null);
    setForm({
      year: "",
      make: "",
      model: "",
      vin: "",
      license_plate: "",
      mileage: "",
      color: "",
    });
  };

  const startEdit = (v: VehicleRow) => {
    setEditingId(v.id);
    setForm({
      year: v.year != null ? String(v.year) : "",
      make: v.make ?? "",
      model: v.model ?? "",
      vin: v.vin ?? "",
      license_plate: v.license_plate ?? "",
      mileage: v.mileage ?? "",
      color: v.color ?? "",
    });
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const toNull = (s: string): string | null =>
    s.trim() === "" ? null : s.trim();

  const toYear = (s: string): number | null => {
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  };

  const onSave = async () => {
    if (!customer?.id) {
      setError("Create your profile first.");
      return;
    }
    setSaving(true);
    setError(null);

    if (!form.make.trim() || !form.model.trim()) {
      setError("Make and model are required.");
      setSaving(false);
      return;
    }

    const payload = {
      customer_id: customer.id,
      year: toYear(form.year),
      make: form.make.trim(),
      model: form.model.trim(),
      vin: toNull(form.vin),
      license_plate: toNull(form.license_plate),
      mileage: toNull(form.mileage),
      color: toNull(form.color),
    };

    if (isEdit && editingId) {
      const { data: updated, error: upErr } = await supabase
        .from("vehicles")
        .update(payload)
        .eq("id", editingId)
        .select()
        .maybeSingle();

      if (upErr) setError(upErr.message);
      if (updated) {
        const u = updated as unknown as VehicleRow;
        setVehicles((prev) => prev.map((x) => (x.id === u.id ? u : x)));
        resetForm();
      }
    } else {
      const { data: inserted, error: insErr } = await supabase
        .from("vehicles")
        .insert(payload)
        .select()
        .maybeSingle();

      if (insErr) setError(insErr.message);
      if (inserted) {
        const i = inserted as unknown as VehicleRow;
        setVehicles((prev) => [i, ...prev]);
        resetForm();
      }
    }

    setSaving(false);
  };

  const onDelete = async (id: string) => {
    if (!confirm("Delete this vehicle?")) return;
    const { error: delErr } = await supabase.from("vehicles").delete().eq("id", id);

    if (delErr) {
      setError(delErr.message);
    } else {
      setVehicles((prev) => prev.filter((v) => v.id !== id));
      if (editingId === id) resetForm();
    }
  };

  if (loading) {
    return (
      <div className="mx-auto max-w-3xl rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-4 text-sm text-neutral-300 backdrop-blur">
        Loading your vehicles…
      </div>
    );
  }

  return (
    <div className="mx-auto max-w-3xl space-y-6">
      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-500">My Vehicles</h1>
        <p className="text-sm text-neutral-400">
          Save your vehicles so booking and service history stays organized.
        </p>
      </header>

      {error && (
        <div className="rounded-2xl border border-red-700/60 bg-red-900/30 px-3 py-2 text-sm text-red-100 backdrop-blur">
          {error}
        </div>
      )}

      <div className="space-y-3 rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-4 backdrop-blur sm:p-5">
        <div className="mb-1 flex items-center justify-between gap-2">
          <h2 className="text-sm font-semibold text-neutral-50">
            {isEdit ? "Edit vehicle" : "Add vehicle"}
          </h2>
          {isEdit && (
            <span className="text-xs text-neutral-500">
              Editing <span className="font-mono">{editingId?.slice(0, 8)}…</span>
            </span>
          )}
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <input
            className="input"
            placeholder="Year"
            value={form.year}
            onChange={(e) => setForm({ ...form, year: e.target.value })}
          />
          <input
            className="input"
            placeholder="Make *"
            value={form.make}
            onChange={(e) => setForm({ ...form, make: e.target.value })}
          />
          <input
            className="input"
            placeholder="Model *"
            value={form.model}
            onChange={(e) => setForm({ ...form, model: e.target.value })}
          />
        </div>

        <div className="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <input
            className="input"
            placeholder="VIN"
            value={form.vin}
            onChange={(e) => setForm({ ...form, vin: e.target.value })}
          />
          <input
            className="input"
            placeholder="License plate"
            value={form.license_plate}
            onChange={(e) => setForm({ ...form, license_plate: e.target.value })}
          />
          <input
            className="input"
            placeholder="Mileage"
            value={form.mileage}
            onChange={(e) => setForm({ ...form, mileage: e.target.value })}
          />
        </div>

        <input
          className="input"
          placeholder="Color"
          value={form.color}
          onChange={(e) => setForm({ ...form, color: e.target.value })}
        />

        <div className="flex flex-wrap gap-3">
          <button className="btn" onClick={onSave} disabled={saving}>
            {saving ? "Saving…" : isEdit ? "Save changes" : "Add vehicle"}
          </button>

          {isEdit && (
            <button className="btn-secondary" onClick={resetForm} disabled={saving}>
              Cancel
            </button>
          )}
        </div>

        <p className="text-xs text-neutral-500">Fields marked with * are required.</p>
      </div>

      <div className="space-y-3">
        {vehicles.length === 0 ? (
          <div className="rounded-2xl border border-dashed border-neutral-800/70 bg-neutral-950/40 p-4 text-sm text-neutral-400 backdrop-blur">
            No vehicles yet. Add your first vehicle above so you can book appointments faster and
            see service history.
          </div>
        ) : (
          vehicles.map((v) => {
            const title =
              [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim() ||
              "Vehicle";

            return (
              <div
                key={v.id}
                className="flex flex-col justify-between gap-3 rounded-2xl border border-neutral-800/70 bg-neutral-950/50 p-3 backdrop-blur sm:flex-row sm:items-center"
              >
                <div>
                  <div className="text-sm font-semibold text-neutral-50">{title}</div>
                  <div className="mt-0.5 text-xs text-neutral-400">
                    VIN <span className="font-mono">{v.vin || "—"}</span> • Plate{" "}
                    <span className="font-mono">{v.license_plate || "—"}</span> • Mileage{" "}
                    <span className="font-mono">{v.mileage || "—"}</span>
                    {v.color && (
                      <>
                        {" "}
                        • Color <span className="font-mono">{v.color}</span>
                      </>
                    )}
                  </div>
                </div>

                <div className="flex gap-2">
                  <button className="btn-secondary" onClick={() => startEdit(v)}>
                    Edit
                  </button>
                  <button className="btn-danger" onClick={() => onDelete(v.id)}>
                    Delete
                  </button>
                </div>
              </div>
            );
          })
        )}
      </div>
    </div>
  );
}

===============================================================================
FILE: features/portal/components/PortalShell.tsx
===============================================================================

// features/portal/components/PortalShell.tsx
"use client";

import React, { useMemo, useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";

type NavItem = {
  href: string;
  label: string;
  icon: string; // emoji for now; swap to your icon set later
};

const NAV: NavItem[] = [
  { href: "/portal", label: "Home", icon: "🏠" },
  { href: "/portal/booking", label: "Book", icon: "📅" },
  { href: "/portal/appointments", label: "Appointments", icon: "🗓️" },
  { href: "/portal/history", label: "History", icon: "🧾" },
  { href: "/portal/vehicles", label: "Vehicles", icon: "🚗" },
  { href: "/portal/profile", label: "Profile", icon: "👤" },
  { href: "/portal/settings", label: "Settings", icon: "⚙️" },
];

function cx(...parts: Array<string | false | null | undefined>) {
  return parts.filter(Boolean).join(" ");
}

const COPPER = "#C57A4A";

export default function PortalShell({
  title = "Customer Portal",
  subtitle = "Manage bookings, vehicles, and your profile",
  children,
}: {
  title?: string;
  subtitle?: string;
  children: React.ReactNode;
}) {
  const pathname = usePathname();
  const [open, setOpen] = useState<boolean>(false);

  const activeHref = useMemo(() => {
    const exact = NAV.find((x) => x.href === pathname);
    if (exact) return exact.href;

    const starts = NAV.find(
      (x) => x.href !== "/portal" && pathname.startsWith(x.href),
    );
    return starts?.href ?? "/portal";
  }, [pathname]);

  return (
    <div className="min-h-dvh bg-neutral-950 text-neutral-100">
      {/* Background glow (burnt copper / metallic vibe) */}
      <div className="pointer-events-none fixed inset-0 opacity-45">
        <div
          className="absolute inset-0"
          style={{
            background:
              "radial-gradient(circle at 18% 12%, rgba(197,122,74,0.22), transparent 55%)",
          }}
        />
        <div
          className="absolute inset-0"
          style={{
            background:
              "radial-gradient(circle at 78% 18%, rgba(153,70,24,0.16), transparent 56%)",
          }}
        />
        <div
          className="absolute inset-0"
          style={{
            background:
              "radial-gradient(circle at 50% 86%, rgba(255,255,255,0.06), transparent 58%)",
          }}
        />
      </div>

      <div className="relative mx-auto flex min-h-dvh w-full max-w-6xl">
        {/* Desktop sidebar */}
        <aside className="hidden w-72 flex-col border-r border-white/10 bg-black/20 backdrop-blur-md md:flex">
          <div className="px-5 py-5">
            <div className="text-lg font-blackops" style={{ color: COPPER }}>
              ProFixIQ
            </div>
            <div className="mt-1 text-xs text-neutral-400">Customer Portal</div>
          </div>

          <nav className="flex-1 space-y-1 px-3 pb-4">
            {NAV.map((item) => {
              const active = item.href === activeHref;
              return (
                <Link
                  key={item.href}
                  href={item.href}
                  className={cx(
                    "flex items-center gap-3 rounded-xl border px-3 py-2 text-sm transition",
                    active
                      ? "border-white/10 bg-white/5"
                      : "border-transparent text-neutral-200 hover:border-white/10 hover:bg-white/5",
                  )}
                >
                  <span className="text-base">{item.icon}</span>
                  <span
                    className={cx(
                      "font-semibold",
                      active ? "text-neutral-50" : "text-neutral-200",
                    )}
                  >
                    {item.label}
                  </span>
                  {active ? (
                    <span
                      className="ml-auto h-2 w-2 rounded-full"
                      style={{ backgroundColor: COPPER }}
                    />
                  ) : null}
                </Link>
              );
            })}
          </nav>

          <div className="px-5 pb-5 text-xs text-neutral-500">
            Powered by ProFixIQ
          </div>
        </aside>

        {/* Mobile overlay sidebar */}
        {open && (
          <div className="fixed inset-0 z-40 md:hidden">
            <div
              className="absolute inset-0 bg-black/60"
              onClick={() => setOpen(false)}
            />
            <div className="absolute left-0 top-0 h-full w-80 border-r border-white/10 bg-black/55 backdrop-blur-md">
              <div className="flex items-center justify-between px-5 py-5">
                <div>
                  <div className="text-lg font-blackops" style={{ color: COPPER }}>
                    ProFixIQ
                  </div>
                  <div className="mt-1 text-xs text-neutral-400">
                    Customer Portal
                  </div>
                </div>
                <button
                  className="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-neutral-200"
                  onClick={() => setOpen(false)}
                >
                  Close
                </button>
              </div>

              <nav className="space-y-1 px-3">
                {NAV.map((item) => {
                  const active = item.href === activeHref;
                  return (
                    <Link
                      key={item.href}
                      href={item.href}
                      onClick={() => setOpen(false)}
                      className={cx(
                        "flex items-center gap-3 rounded-xl border px-3 py-3 text-sm transition",
                        active
                          ? "border-white/10 bg-white/5"
                          : "border-transparent text-neutral-200 hover:border-white/10 hover:bg-white/5",
                      )}
                    >
                      <span className="text-base">{item.icon}</span>
                      <span className="font-semibold">{item.label}</span>
                      {active ? (
                        <span
                          className="ml-auto h-2 w-2 rounded-full"
                          style={{ backgroundColor: COPPER }}
                        />
                      ) : null}
                    </Link>
                  );
                })}
              </nav>

              <div className="px-5 py-5 text-xs text-neutral-500">
                Powered by ProFixIQ
              </div>
            </div>
          </div>
        )}

        {/* Main column */}
        <div className="flex min-w-0 flex-1 flex-col">
          {/* Top bar */}
          <header className="sticky top-0 z-30 border-b border-white/10 bg-black/20 backdrop-blur-md">
            <div className="flex items-center justify-between px-4 py-4">
              <div className="flex items-center gap-3">
                <button
                  className="rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-neutral-100 md:hidden"
                  onClick={() => setOpen(true)}
                  aria-label="Open menu"
                >
                  ☰
                </button>

                <div>
                  <div className="text-sm font-semibold text-neutral-50">
                    {title}
                  </div>
                  <div className="text-xs text-neutral-400">{subtitle}</div>
                </div>
              </div>

              <Link
                href="/portal/booking"
                className="hidden rounded-xl border border-white/10 bg-white/5 px-3 py-2 text-sm font-semibold transition hover:bg-white/10 sm:inline-flex"
              >
                <span style={{ color: COPPER }}>Book</span>
              </Link>
            </div>
          </header>

          {/* Content */}
          <main className="flex-1 p-4 sm:p-6">
            <div className="rounded-3xl border border-white/10 bg-black/25 p-4 backdrop-blur-md sm:p-6">
              {children}
            </div>
          </main>
        </div>
      </div>
    </div>
  );
}

===============================================================================
FILE: app/api/portal/availability/route.ts
===============================================================================

// app/api/portal/availability/route.ts
import { NextResponse, NextRequest } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

/** Build a Date in UTC that corresponds to local components in a given IANA tz. */
function makeZonedDate(tz: string, y: number, m: number, d: number, hh = 0, mm = 0) {
  const tentative = new Date(Date.UTC(y, m - 1, d, hh, mm, 0, 0));
  const fmt = new Intl.DateTimeFormat("en-CA", {
    timeZone: tz,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  });
  const parts = Object.fromEntries(fmt.formatToParts(tentative).map(p => [p.type, p.value]));
  const want = Date.UTC(y, m - 1, d, hh, mm);
  const got = Date.UTC(
    Number(parts.year),
    Number(parts.month) - 1,
    Number(parts.day),
    Number(parts.hour),
    Number(parts.minute),
  );
  return new Date(tentative.getTime() + (want - got));
}

function parseYMD(ymd: string) {
  const [y, m, d] = ymd.split("-").map(Number);
  if (!y || !m || !d) throw new Error("Invalid date");
  return { y, m, d };
}

function* iterateDays(startYMD: string, endYMD: string) {
  const s = parseYMD(startYMD);
  const e = parseYMD(endYMD);
  const d0 = new Date(Date.UTC(s.y, s.m - 1, s.d));
  const d1 = new Date(Date.UTC(e.y, e.m - 1, e.d));
  for (let t = d0.getTime(); t <= d1.getTime(); t += 24 * 60 * 60 * 1000) {
    const dt = new Date(t);
    yield { utc: dt, y: dt.getUTCFullYear(), m: dt.getUTCMonth() + 1, d: dt.getUTCDate() };
  }
}

const addMinutes = (date: Date, mins: number) => new Date(date.getTime() + mins * 60_000);
const overlaps = (aStart: Date, aEnd: Date, bStart: Date, bEnd: Date) => aStart < bEnd && bStart < aEnd;

// Narrowed types from your generated Database types
type ShopsRow = Database["public"]["Tables"]["shops"]["Row"];
type ShopPick = Pick<ShopsRow, "id" | "slug" | "timezone" | "accepts_online_booking">;

type ShopHoursRow = Database["public"]["Tables"]["shop_hours"]["Row"];
type HoursPick = Pick<ShopHoursRow, "weekday" | "open_time" | "close_time">;

type TimeOffRow = Database["public"]["Tables"]["shop_time_off"]["Row"];
type TimeOffPick = Pick<TimeOffRow, "starts_at" | "ends_at">;

type BookingRow = Database["public"]["Tables"]["bookings"]["Row"];
type BookingPick = Pick<BookingRow, "starts_at" | "ends_at" | "status">;

export async function GET(req: NextRequest) {
  try {
    const supabase = createRouteHandlerClient<Database>({ cookies });
    const { searchParams } = new URL(req.url);

    const slug = searchParams.get("shop") || "";
    const startYMD = searchParams.get("start") || "";
    const endYMD = searchParams.get("end") || "";
    const slotMins = Math.max(5, Math.min(180, Number(searchParams.get("slotMins") || 30)));

    if (!slug || !startYMD || !endYMD) {
      return NextResponse.json({ error: "Missing required params: shop, start, end" }, { status: 400 });
    }

    // 1) Load shop config (only the columns you have)
    const shopRes = await supabase
      .from("shops")
      .select("id, slug, timezone, accepts_online_booking")
      .eq("slug", slug)
      .maybeSingle();

    const shop = shopRes.data as ShopPick | null;
    if (!shop) return NextResponse.json({ error: "Shop not found" }, { status: 404 });
    if (!shop.accepts_online_booking) {
      return NextResponse.json({ slots: [], tz: shop.timezone ?? "UTC", disabled: true });
    }

    // Use hard-coded defaults since your table doesn’t have these fields
    const tz = shop.timezone || "UTC";
    const MIN_NOTICE_MIN = 120; // 2 hours
    const MAX_LEAD_DAYS = 30;   // 30 days
    const now = new Date();
    const maxLeadUntil = addMinutes(now, MAX_LEAD_DAYS * 24 * 60);

    // 2) Weekly hours
    const hoursRes = await supabase
      .from("shop_hours")
      .select("weekday, open_time, close_time")
      .eq("shop_id", shop.id);
    const hours = (hoursRes.data ?? []) as HoursPick[];

    // 3) Time-off within the requested window
    const s = parseYMD(startYMD);
    const e = parseYMD(endYMD);
    const windowStartUtc = makeZonedDate(tz, s.y, s.m, s.d, 0, 0);
    const windowEndUtc = addMinutes(makeZonedDate(tz, e.y, e.m, e.d, 23, 59), 1);

    const timeOffRes = await supabase
      .from("shop_time_off")
      .select("starts_at, ends_at")
      .eq("shop_id", shop.id)
      .gte("ends_at", windowStartUtc.toISOString())
      .lte("starts_at", windowEndUtc.toISOString());
    const timeOff = (timeOffRes.data ?? []) as TimeOffPick[];

    // 4) Existing bookings within the window
    const bookingsRes = await supabase
      .from("bookings")
      .select("starts_at, ends_at, status")
      .eq("shop_id", shop.id)
      .gte("ends_at", windowStartUtc.toISOString())
      .lte("starts_at", windowEndUtc.toISOString());
    const bookings = (bookingsRes.data ?? []) as BookingPick[];

    const offWindows = timeOff.map(t => ({
      start: new Date(t.starts_at),
      end: new Date(t.ends_at),
    }));

    const bookingWindows = bookings
      .filter(b => b.status === "pending" || b.status === "confirmed")
      .map(b => ({ start: new Date(b.starts_at), end: new Date(b.ends_at) }));

    // Helper: weekday in shop tz (0–6)
    const weekdayInTz = (d: Date) => {
      const fmt = new Intl.DateTimeFormat("en-US", { timeZone: tz, weekday: "short" });
      return ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(fmt.format(d));
    };

    const slots: { start: string; end: string }[] = [];

    for (const day of iterateDays(startYMD, endYMD)) {
      const localWeekday = weekdayInTz(day.utc);
      const dayHours = hours.filter(h => h.weekday === localWeekday);
      if (dayHours.length === 0) continue;

      for (const h of dayHours) {
        const [oh, om] = h.open_time.split(":").map(Number);
        const [ch, cm] = h.close_time.split(":").map(Number);

        const open = makeZonedDate(tz, day.y, day.m, day.d, oh, om);
        const close = makeZonedDate(tz, day.y, day.m, day.d, ch, cm);

        for (let sdt = new Date(open); addMinutes(sdt, slotMins) <= close; sdt = addMinutes(sdt, slotMins)) {
          const edt = addMinutes(sdt, slotMins);

          // min notice & max lead
          if (sdt < addMinutes(now, MIN_NOTICE_MIN)) continue;
          if (sdt > maxLeadUntil) continue;

          const isBlocked =
            offWindows.some(w => overlaps(sdt, edt, w.start, w.end)) ||
            bookingWindows.some(w => overlaps(sdt, edt, w.start, w.end));
          if (isBlocked) continue;

          slots.push({ start: sdt.toISOString(), end: edt.toISOString() });
        }
      }
    }

    return NextResponse.json({ tz, slots });
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : "Failed to compute availability";
    return NextResponse.json({ error: message }, { status: 500 });
  }
}

===============================================================================
FILE: app/api/portal/bookings/[id]/route.ts
===============================================================================

// app/api/portal/bookings/[id]/route.ts
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { NextResponse } from "next/server";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type PatchBody = {
  status?: "pending" | "confirmed" | "completed" | "cancelled";
  starts_at?: string;
  ends_at?: string;
  notes?: string | null;
};

function jsonError(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

function getIdFromUrl(url: string): string {
  const { pathname } = new URL(url);
  return pathname.split("/").pop() ?? "";
}

const STAFF_ROLES = new Set([
  "owner",
  "admin",
  "manager",
  "advisor",
  "mechanic",
  "parts",
]);

async function isStaffForShop(
  supabase: ReturnType<typeof createRouteHandlerClient<Database>>,
  userId: string,
  shopId: string,
): Promise<boolean> {
  const { data: profile } = await supabase
    .from("profiles")
    .select("id, role, shop_id")
    .eq("id", userId)
    .maybeSingle();

  if (!profile) return false;
  return STAFF_ROLES.has(profile.role ?? "") && profile.shop_id === shopId;
}

async function isCustomerOwner(
  supabase: ReturnType<typeof createRouteHandlerClient<Database>>,
  userId: string,
  customerId: string | null,
): Promise<boolean> {
  if (!customerId) return false;
  const { data } = await supabase
    .from("customers")
    .select("id")
    .eq("id", customerId)
    .eq("user_id", userId)
    .maybeSingle();
  return !!data;
}

export async function PATCH(req: Request): Promise<Response> {
  const bookingId = getIdFromUrl(req.url);
  if (!bookingId) return jsonError("Missing booking id");

  const supabase = createRouteHandlerClient<Database>({ cookies });

  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();

  if (authErr || !user) return jsonError("Not authenticated", 401);

  let body: PatchBody;
  try {
    body = (await req.json()) as PatchBody;
  } catch {
    return jsonError("Invalid JSON body");
  }

  const { data: booking, error: bErr } = await supabase
    .from("bookings")
    .select("id, shop_id, customer_id, status, starts_at, ends_at, notes")
    .eq("id", bookingId)
    .maybeSingle();

  if (bErr || !booking) return jsonError("Booking not found", 404);

  const staff = await isStaffForShop(supabase, user.id, booking.shop_id);
  const owner = await isCustomerOwner(supabase, user.id, booking.customer_id);

  if (!staff && !owner) return jsonError("Not allowed", 403);

  // Customers can only cancel, not reschedule or mark complete.
  if (owner) {
    if (body.starts_at || body.ends_at) {
      return jsonError("Customers may not reschedule bookings", 403);
    }
    if (body.status && body.status !== "cancelled") {
      return jsonError("Customers may only cancel a booking", 403);
    }
  }

  // Validate reschedule times (staff only)
  let nextStart: Date | null = null;
  let nextEnd: Date | null = null;
  if (body.starts_at || body.ends_at) {
    if (!staff) return jsonError("Only staff can reschedule", 403);

    if (!body.starts_at || !body.ends_at) {
      return jsonError("starts_at and ends_at are required to reschedule");
    }

    nextStart = new Date(body.starts_at);
    nextEnd = new Date(body.ends_at);

    if (Number.isNaN(nextStart.getTime()) || Number.isNaN(nextEnd.getTime())) {
      return jsonError("Invalid starts_at/ends_at");
    }
    if (nextEnd <= nextStart) return jsonError("ends_at must be after starts_at");
  }

  const patch: Partial<Database["public"]["Tables"]["bookings"]["Update"]> = {};

  if (typeof body.notes !== "undefined") patch.notes = body.notes ?? null;
  if (body.status) patch.status = body.status;
  if (nextStart && nextEnd) {
    patch.starts_at = nextStart.toISOString();
    patch.ends_at = nextEnd.toISOString();
  }

  if (Object.keys(patch).length === 0) {
    return jsonError("Nothing to update");
  }

  const { data: updated, error: upErr } = await supabase
    .from("bookings")
    .update(patch)
    .eq("id", bookingId)
    .select("*")
    .maybeSingle();

  if (upErr || !updated) return jsonError("Failed to update booking", 500);

  return NextResponse.json({ booking: updated }, { status: 200 });
}

export async function DELETE(req: Request): Promise<Response> {
  const bookingId = getIdFromUrl(req.url);
  if (!bookingId) return jsonError("Missing booking id");

  const supabase = createRouteHandlerClient<Database>({ cookies });

  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();

  if (authErr || !user) return jsonError("Not authenticated", 401);

  const { data: booking, error: bErr } = await supabase
    .from("bookings")
    .select("id, shop_id, customer_id")
    .eq("id", bookingId)
    .maybeSingle();

  if (bErr || !booking) return jsonError("Booking not found", 404);

  const staff = await isStaffForShop(supabase, user.id, booking.shop_id);
  const owner = await isCustomerOwner(supabase, user.id, booking.customer_id);

  if (!staff && !owner) return jsonError("Not allowed", 403);

  const { error: delErr } = await supabase.from("bookings").delete().eq("id", bookingId);
  if (delErr) return jsonError("Failed to delete booking", 500);

  return NextResponse.json({ ok: true }, { status: 200 });
}

===============================================================================
FILE: app/api/portal/bookings/route.ts
===============================================================================

// app/api/portal/bookings/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type Db = Database;

// Shape we return to the client (matches Booking in /portal/appointments)
type BookingPayload = {
  id: string;
  shop_slug: string | null;
  starts_at: string;
  ends_at: string;
  customer_id: string | null;
  customer_name: string | null;
  customer_email: string | null;
  customer_phone: string | null;
  notes: string | null;
  status: string | null;
};

type BookingRow = Db["public"]["Tables"]["bookings"]["Row"] & {
  customers?: Pick<
    Db["public"]["Tables"]["customers"]["Row"],
    "first_name" | "last_name" | "email" | "phone"
  > | null;
  shops?: Pick<Db["public"]["Tables"]["shops"]["Row"], "slug"> | null;
};

function bad(msg: string, status = 400): NextResponse {
  return NextResponse.json({ error: msg }, { status });
}

export async function GET(req: Request): Promise<Response> {
  const supabase = createRouteHandlerClient<Db>({ cookies });

  const url = new URL(req.url);
  const shopSlug = url.searchParams.get("shop") ?? "";
  const start = url.searchParams.get("start") ?? "";
  const end = url.searchParams.get("end") ?? "";

  if (!shopSlug || !start || !end) {
    return bad("Missing shop, start, or end");
  }

  // Auth
  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();
  if (authErr || !user) return bad("Not authenticated", 401);

  // Staff profile
  const { data: profile, error: profErr } = await supabase
    .from("profiles")
    .select("shop_id, role")
    .eq("id", user.id)
    .single();

  if (profErr || !profile?.shop_id) {
    return bad("Profile / shop not found", 403);
  }

  const staffRoles = [
    "owner",
    "admin",
    "manager",
    "advisor",
    "mechanic",
    "parts",
  ] as const;

  if (
    !profile.role ||
    !staffRoles.includes(profile.role as (typeof staffRoles)[number])
  ) {
    return bad("Not allowed", 403);
  }

  // Shop by slug
  const { data: shop, error: shopErr } = await supabase
    .from("shops")
    .select("id, slug")
    .eq("slug", shopSlug)
    .single();

  if (shopErr || !shop) return bad("Shop not found", 404);
  if (shop.id !== profile.shop_id) {
    return bad("You cannot view bookings for this shop", 403);
  }

  // Build date window for the week (inclusive)
  const startIso = new Date(`${start}T00:00:00.000Z`).toISOString();
  const endDate = new Date(`${end}T00:00:00.000Z`);
  endDate.setDate(endDate.getDate() + 1); // next day
  const endIso = endDate.toISOString();

  // Query bookings + customer + shop slug
  const { data: rows, error: rowsErr } = await supabase
    .from("bookings")
    .select(
      `
        id,
        shop_id,
        customer_id,
        starts_at,
        ends_at,
        status,
        notes,
        customers:customer_id (
          first_name,
          last_name,
          email,
          phone
        ),
        shops:shop_id (
          slug
        )
      `,
    )
    .eq("shop_id", shop.id)
    .gte("starts_at", startIso)
    .lt("starts_at", endIso)
    .order("starts_at", { ascending: true });

  if (rowsErr || !rows) {
    return bad("Failed to load bookings", 500);
  }

  const bookings = rows as unknown as BookingRow[];

  const payload: BookingPayload[] = bookings.map((row) => {
    const customer = row.customers ?? null;
    const shopRel = row.shops ?? null;

    const nameFromCustomer =
      [customer?.first_name, customer?.last_name]
        .filter((part) => !!part && part.trim().length > 0)
        .join(" ") || null;

    const emailFromCustomer = customer?.email ?? null;
    const phoneFromCustomer = customer?.phone ?? null;

    return {
      id: row.id,
      shop_slug: shopRel?.slug ?? null,
      starts_at: row.starts_at,
      ends_at: row.ends_at,
      customer_id: row.customer_id ?? null,
      customer_name: nameFromCustomer,
      customer_email: emailFromCustomer,
      customer_phone: phoneFromCustomer,
      notes: row.notes ?? null,
      status: row.status ?? null,
    };
  });

  return NextResponse.json(payload);
}

===============================================================================
FILE: app/api/portal/book/route.ts
===============================================================================

// app/api/portal/book/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type Body = {
  shopSlug: string;
  startsAt: string; // ISO
  endsAt: string;   // ISO
  notes?: string;
  vehicleId?: string | null;

  // Optional: when internal staff creates a booking for a specific / new customer
  customerId?: string | null;
  customerName?: string;
  customerEmail?: string;
  customerPhone?: string;
};

function bad(msg: string, code = 400) {
  return NextResponse.json({ error: msg }, { status: code });
}

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<Database>({ cookies });

    // 1) Auth
    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();
    if (authErr || !user) return bad("Not authenticated", 401);

    // 2) Parse body
    const body = (await req.json()) as Body;
    const {
      shopSlug,
      startsAt,
      endsAt,
      notes = "",
      vehicleId = null,
      customerId: rawCustomerId = null,
      customerName = "",
      customerEmail = "",
      customerPhone = "",
    } = body || {};

    if (!shopSlug || !startsAt || !endsAt) {
      return bad("Missing shopSlug, startsAt, or endsAt");
    }

    const start = new Date(startsAt);
    const end = new Date(endsAt);
    if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end <= start) {
      return bad("Invalid start/end");
    }

    // 3) Load shop (correct table = shops)
    const { data: shop, error: shopErr } = await supabase
      .from("shops")
      .select(
        "id, slug, accepts_online_booking, min_notice_minutes, max_lead_days, timezone",
      )
      .eq("slug", shopSlug)
      .single();

    if (shopErr || !shop) return bad("Shop not found", 404);
    if (shop.accepts_online_booking === false) {
      return bad("Shop is not accepting online bookings", 403);
    }

    // 4) Resolve customer
    const hasExplicitCustomer =
      !!rawCustomerId && rawCustomerId.trim().length > 0;
    const hasInlineCustomerFields =
      !!customerName.trim() ||
      !!customerEmail.trim() ||
      !!customerPhone.trim();

    let customerId: string | null = null;
    let customerShopId: string | null = null;

    if (hasExplicitCustomer) {
      // 4a. Existing customer chosen in appointments UI
      const { data: customerRow, error: customerRowErr } = await supabase
        .from("customers")
        .select("id, shop_id")
        .eq("id", rawCustomerId)
        .maybeSingle();

      if (customerRowErr || !customerRow) {
        return bad("Selected customer not found", 404);
      }

      if (customerRow.shop_id && customerRow.shop_id !== shop.id) {
        return bad("Customer belongs to a different shop", 403);
      }

      customerId = customerRow.id;
      customerShopId = customerRow.shop_id;
    } else if (hasInlineCustomerFields) {
      // 4b. NEW customer created from appointments UI (no customerId, but name/email/phone entered)
      const trimmedName = customerName.trim();
      let firstName: string | null = null;
      let lastName: string | null = null;

      if (trimmedName) {
        const parts = trimmedName.split(" ");
        firstName = parts[0] || null;
        lastName = parts.slice(1).join(" ") || null;
      }

      const insertCustomer: Database["public"]["Tables"]["customers"]["Insert"] = {
        shop_id: shop.id,
        first_name: firstName,
        last_name: lastName,
        email: customerEmail.trim() || null,
        phone: customerPhone.trim() || null,
      };

      const { data: newCustomer, error: newCustErr } = await supabase
        .from("customers")
        .insert(insertCustomer)
        .select("id, shop_id")
        .single();

      if (newCustErr || !newCustomer) {
        return bad("Failed to create customer for booking", 500);
      }

      customerId = newCustomer.id;
      customerShopId = newCustomer.shop_id;
    } else {
      // 4c. Portal self-serve: use the logged-in portal user → customers.user_id = auth.id
      const { data: customerRow, error: custErr } = await supabase
        .from("customers")
        .select("id, shop_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (custErr || !customerRow) {
        return bad("Customer profile not found for this user", 404);
      }

      customerId = customerRow.id;
      customerShopId = customerRow.shop_id;
    }

    if (!customerId) {
      return bad("Could not resolve customer for booking", 500);
    }

    // 5) Enforce notice / max lead
    const now = new Date();
    const minutesUntil = Math.floor((start.getTime() - now.getTime()) / 60000);
    const minNotice = shop.min_notice_minutes ?? 120;
    if (minutesUntil < minNotice) {
      return bad(`Bookings require at least ${minNotice} minutes notice`);
    }

    const midnightToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const daysUntil = Math.floor(
      (start.getTime() - midnightToday.getTime()) / 86400000,
    );
    const maxLead = shop.max_lead_days ?? 30;
    if (daysUntil > maxLead) {
      return bad(`Bookings cannot be more than ${maxLead} days in advance`);
    }

    // 6) Overlap check (same shop, overlapping time window)
    const { data: overlaps, error: ovErr } = await supabase
      .from("bookings")
      .select("id")
      .eq("shop_id", shop.id)
      .or(`and(starts_at.lt.${endsAt},ends_at.gt.${startsAt})`)
      .limit(1);

    if (ovErr) return bad("Failed to check availability", 500);
    if (overlaps && overlaps.length > 0) {
      return bad("This time overlaps an existing booking", 409);
    }

    // 7) Insert booking
    const insertBooking: Database["public"]["Tables"]["bookings"]["Insert"] = {
      shop_id: shop.id,
      customer_id: customerId,
      vehicle_id: vehicleId ?? null,
      starts_at: startsAt,
      ends_at: endsAt,
      status: "pending",
      notes: notes || null,
    };

    const { data: created, error: insErr } = await supabase
      .from("bookings")
      .insert(insertBooking)
      .select("*")
      .single();

    if (insErr || !created) return bad("Failed to create booking", 500);

    // 8) If this came from portal (no explicit customer & no inline fields) and customer
    // isn't linked to a shop yet, attach it. For staff-created customers we already set shop_id.
    const cameFromPortal = !hasExplicitCustomer && !hasInlineCustomerFields;
    if (cameFromPortal && !customerShopId) {
      const { error: attachErr } = await supabase
        .from("customers")
        .update({ shop_id: shop.id })
        .eq("id", customerId);

      if (attachErr) {
        console.warn("Could not link customer to shop:", attachErr.message);
      }
    }

    // 9) Return the booking
    return NextResponse.json({ booking: created }, { status: 201 });
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : String(err);
    console.error("Booking error:", message);
    return bad("Unexpected error", 500);
  }
}

===============================================================================
FILE: app/api/portal/qr/route.ts
===============================================================================

export const dynamic = "force-dynamic";
export const revalidate = 0;

import { NextRequest, NextResponse } from "next/server";

export function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);

  // Accept `data` or `url` param (both common)
  const raw = searchParams.get("data") ?? searchParams.get("url") ?? "";
  const data = raw.trim();

  if (!data) {
    return NextResponse.json(
      { error: "Missing required query param: data (or url)" },
      { status: 400 },
    );
  }

  // Simple, dependency-free QR generation via Google Chart image endpoint
  // Example: /api/portal/qr?data=https%3A%2F%2Fprofixiq.com%2Fportal%2Fbooking%3Fshop%3Ddemo
  const size = searchParams.get("size")?.trim() || "300x300";
  const qrUrl = `https://chart.googleapis.com/chart?cht=qr&chs=${encodeURIComponent(
    size,
  )}&chl=${encodeURIComponent(data)}&choe=UTF-8`;

  return NextResponse.redirect(qrUrl, { status: 302 });
}


===============================================================================
FILE: app/api/portal/qr/[slug]/route.ts
===============================================================================

import { NextResponse } from "next/server";
import QRCode from "qrcode";

export async function GET(_: Request, ctx: unknown) {
  const { params } = ctx as { params: { slug: string } };
  const { slug } = params;

  const base = process.env.NEXT_PUBLIC_BASE_URL || "http://localhost:3000";
  const url = `${base}/portal/booking?shop=${encodeURIComponent(slug)}`;

  const dataUrl = await QRCode.toDataURL(url, {
    margin: 1,
    errorCorrectionLevel: "H",
    width: 512,
    color: {
      dark: "#f60a00",
      light: "#00000000",
    },
  });

  const pngBase64 = dataUrl.split(",")[1];
  const pngBytes = Uint8Array.from(atob(pngBase64), (c) => c.charCodeAt(0));

  return new NextResponse(pngBytes, {
    headers: {
      "Content-Type": "image/png",
      "Cache-Control": "public, max-age=600",
    },
  });
}

===============================================================================
FILE: app/api/portal/send-invite/route.ts
===============================================================================

import { NextResponse } from "next/server";

export async function POST(req: Request) {
  const { email, link } = await req.json();
  // TODO: wire to your email service (Resend, SES, SMTP, etc.)
  console.log("[portal invite] send to:", email, "link:", link);
  return NextResponse.json({ ok: true });
}

