

===== FILE: app/api/portal/request/submit/route.ts =====

// app/api/portal/request/submit/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;

type Body = {
  workOrderId: string;
  bookingId: string;
};

function bad(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

type PartsNeededItem = {
  name?: string | null;
  qty?: number | null;
};

function toNonEmptyString(v: unknown): string | null {
  if (typeof v !== "string") return null;
  const s = v.trim();
  return s.length ? s : null;
}

function toPositiveQty(v: unknown, fallback = 1): number {
  const n = Number(v);
  if (!Number.isFinite(n)) return fallback;
  if (n <= 0) return fallback;
  return n;
}

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<DB>({ cookies });

    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();
    if (authErr || !user) return bad("Not authenticated", 401);

    let body: Body;
    try {
      body = (await req.json()) as Body;
    } catch {
      return bad("Invalid JSON body");
    }

    const workOrderId = (body?.workOrderId ?? "").trim();
    const bookingId = (body?.bookingId ?? "").trim();
    if (!workOrderId || !bookingId) return bad("Missing workOrderId or bookingId");

    // Resolve portal customer
    const { data: customer, error: custErr } = await supabase
      .from("customers")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();

    if (custErr) return bad(custErr.message, 500);
    if (!customer?.id) return bad("Customer profile not found", 404);

    // Load WO + ensure ownership
    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("id, shop_id, customer_id")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woErr) return bad("Failed to load work order", 500);
    if (!wo) return bad("Work order not found", 404);
    if (wo.customer_id !== customer.id) return bad("Not allowed", 403);

    // Load booking + ensure same shop
    const { data: booking, error: bErr } = await supabase
      .from("bookings")
      .select("id, shop_id, starts_at, ends_at, status")
      .eq("id", bookingId)
      .maybeSingle();

    if (bErr) return bad("Failed to load booking", 500);
    if (!booking) return bad("Booking not found", 404);
    if (booking.shop_id !== wo.shop_id) return bad("Not allowed", 403);

    // Optional sanity
    const startT = Date.parse(String(booking.starts_at ?? ""));
    if (Number.isFinite(startT) && startT < Date.now() - 60_000) {
      return bad("This booking time is in the past. Please start again.", 409);
    }

    // Finalize booking (Option B)
    const bookingUpdate: DB["public"]["Tables"]["bookings"]["Update"] = {
      status: booking.status ?? "pending",
    };

    const { error: updErr } = await supabase
      .from("bookings")
      .update(bookingUpdate)
      .eq("id", booking.id);

    if (updErr) return bad("Failed to finalize booking", 500);

    /* ------------------------------------------------------------------ */
    /* Parts request creation (NEW)                                         */
    /* ------------------------------------------------------------------ */

    // Pull WO lines (we prefer menu-lines that stored parts_needed)
    const { data: lines, error: linesErr } = await supabase
      .from("work_order_lines")
      .select("id, complaint, parts_needed")
      .eq("work_order_id", wo.id)
      .order("created_at", { ascending: true });

    if (linesErr) {
      // Non-fatal: booking still submitted successfully
      console.warn("portal submit: failed to load work_order_lines:", linesErr.message);
      return NextResponse.json(
        { ok: true, workOrderId: wo.id, bookingId: booking.id, partsRequestId: null },
        { status: 200 },
      );
    }

    // Build items list:
    // - If a line has parts_needed: create items from it
    // - Else fall back to complaint as a single “needs quote” item
    const items: { description: string; qty: number }[] = [];

    for (const line of lines ?? []) {
      const rec = line as unknown as Record<string, unknown>;

      const complaint = toNonEmptyString(rec["complaint"]);
      const partsNeededRaw = rec["parts_needed"];

      if (Array.isArray(partsNeededRaw)) {
        for (const p of partsNeededRaw) {
          const pr = p as PartsNeededItem;
          const name = toNonEmptyString(pr?.name ?? null);
          if (!name) continue;
          items.push({ description: name, qty: toPositiveQty(pr?.qty, 1) });
        }
        continue;
      }

      // If no structured parts list, treat complaint as “quote needed”
      if (complaint) {
        items.push({ description: complaint, qty: 1 });
      }
    }

    // If there’s nothing to quote, just finish submit.
    if (items.length === 0) {
      return NextResponse.json(
        { ok: true, workOrderId: wo.id, bookingId: booking.id, partsRequestId: null },
        { status: 200 },
      );
    }

    // Create / reuse active parts request (idempotent function handles duplicates)
    type RpcArgs = DB["public"]["Functions"]["create_part_request_with_items"]["Args"];

    const rpcArgs: RpcArgs = {
      p_work_order_id: wo.id,
      p_items: items as unknown as RpcArgs["p_items"],
      // No job id available in portal flow right now; keep optional
      // p_job_id: undefined,
      p_notes: "Portal request submit: auto parts quote",
    };

    const { data: partsRequestId, error: prErr } = await supabase.rpc(
      "create_part_request_with_items",
      rpcArgs,
    );

    if (prErr) {
      // Non-fatal: booking submitted even if parts request failed
      console.warn("portal submit: create_part_request_with_items failed:", prErr.message);
      return NextResponse.json(
        { ok: true, workOrderId: wo.id, bookingId: booking.id, partsRequestId: null },
        { status: 200 },
      );
    }

    return NextResponse.json(
      { ok: true, workOrderId: wo.id, bookingId: booking.id, partsRequestId },
      { status: 200 },
    );
  } catch (e: unknown) {
    const msg = e instanceof Error ? e.message : String(e);
    console.error("portal request submit error:", msg);
    return bad("Unexpected error", 500);
  }
}

===== FILE: app/api/portal/request/add-menu-line/route.ts =====

// app/api/portal/request/add-menu-line/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;

type Body = {
  workOrderId: string;
  menuItemId: string;
  qty?: number;
};

function bad(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

type MenuItemPick = {
  id: string;
  shop_id: string;
  description: string | null;
  complaint: string | null;
  base_price: number | null;
  total_price: number | null;
  base_labor_hours: number | null;
  labor_hours: number | null;
  base_part_cost: number | null;
};

type MenuItemPartPick = {
  name: string | null;
  quantity: number | null;
  unit_cost: number | null;
};

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<DB>({ cookies });

    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();
    if (authErr || !user) return bad("Not authenticated", 401);

    let body: Body;
    try {
      body = (await req.json()) as Body;
    } catch {
      return bad("Invalid JSON body");
    }

    const workOrderId = (body?.workOrderId ?? "").trim();
    const menuItemId = (body?.menuItemId ?? "").trim();
    

    if (!workOrderId || !menuItemId) return bad("Missing workOrderId or menuItemId");

    // Portal customer
    const { data: customer, error: custErr } = await supabase
      .from("customers")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();

    if (custErr) return bad(custErr.message, 500);
    if (!customer?.id) return bad("Customer profile not found", 404);

    // Load WO (ownership + shop)
    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("id, shop_id, customer_id, vehicle_id")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woErr) return bad("Failed to load work order", 500);
    if (!wo) return bad("Work order not found", 404);
    if (wo.customer_id !== customer.id) return bad("Not allowed", 403);

    const { data: menu, error: menuErr } = await supabase
      .from("menu_items")
      .select(
        "id, shop_id, description, complaint, base_price, total_price, base_labor_hours, labor_hours, base_part_cost",
      )
      .eq("id", menuItemId)
      .maybeSingle();

    if (menuErr) return bad("Failed to load menu item", 500);
    if (!menu) return bad("Menu item not found", 404);

    const typedMenu = menu as unknown as MenuItemPick;
    if (typedMenu.shop_id !== wo.shop_id) return bad("Menu item belongs to a different shop", 403);

    const { data: partsRows } = await supabase
      .from("menu_item_parts")
      .select("name, quantity, unit_cost")
      .eq("menu_item_id", typedMenu.id);

    const parts = (Array.isArray(partsRows) ? partsRows : []) as unknown as MenuItemPartPick[];

    const laborHours = typedMenu.labor_hours ?? typedMenu.base_labor_hours ?? null;
    const linePrice = typedMenu.total_price ?? typedMenu.base_price ?? null;

    const description =
      typedMenu.description?.trim() ||
      typedMenu.complaint?.trim() ||
      "Service";

    const partsNeeded = parts
      .filter((p) => (p.name ?? "").trim().length > 0)
      .map((p) => ({
        name: (p.name ?? "").trim(),
        qty: p.quantity ?? 1,
        unitCost: p.unit_cost ?? null,
      }));

    // Insert work_order_line (status enums already exist in your schema)
    const insertLine: DB["public"]["Tables"]["work_order_lines"]["Insert"] = {
      work_order_id: wo.id,
      shop_id: wo.shop_id,
      vehicle_id: wo.vehicle_id ?? null,
      menu_item_id: typedMenu.id,
      complaint: description,
      labor_time: laborHours,
      price_estimate: linePrice,
      status: "awaiting_approval",
      approval_state: "pending",
      // store parts suggestion into existing json-ish column if present in your types
      // if your schema uses a different column name, swap it here:
      parts_needed: partsNeeded as unknown as DB["public"]["Tables"]["work_order_lines"]["Insert"]["parts_needed"],
      
    };

    const { data: created, error: insErr } = await supabase
      .from("work_order_lines")
      .insert(insertLine)
      .select("*")
      .single();

    if (insErr || !created) return bad("Failed to add line", 500);

    return NextResponse.json({ line: created }, { status: 201 });
  } catch (e: unknown) {
    const msg = e instanceof Error ? e.message : String(e);
    console.error("add-menu-line error:", msg);
    return bad("Unexpected error", 500);
  }
}


===== FILE: app/api/portal/request/add-custom-line/route.ts =====

// app/api/portal/request/add-custom-line/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;

type Body = {
  workOrderId: string;
  description: string; // customer complaint / request
  notes?: string;
};

function bad(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<DB>({ cookies });

    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();
    if (authErr || !user) return bad("Not authenticated", 401);

    let body: Body;
    try {
      body = (await req.json()) as Body;
    } catch {
      return bad("Invalid JSON body");
    }

    const workOrderId = (body?.workOrderId ?? "").trim();
    const description = (body?.description ?? "").trim();
    const notes = (body?.notes ?? "").trim();

    if (!workOrderId || !description) return bad("Missing workOrderId or description");

    const { data: customer, error: custErr } = await supabase
      .from("customers")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();

    if (custErr) return bad(custErr.message, 500);
    if (!customer?.id) return bad("Customer profile not found", 404);

    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("id, shop_id, customer_id, vehicle_id")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woErr) return bad("Failed to load work order", 500);
    if (!wo) return bad("Work order not found", 404);
    if (wo.customer_id !== customer.id) return bad("Not allowed", 403);

    const insertLine: DB["public"]["Tables"]["work_order_lines"]["Insert"] = {
      work_order_id: wo.id,
      shop_id: wo.shop_id,
      vehicle_id: wo.vehicle_id ?? null,
      complaint: description,
      notes: notes || null,
      status: "awaiting_approval",
      approval_state: "pending",
      // labor_time intentionally null — customer can't set it
      labor_time: null,
      price_estimate: null,
    };

    const { data: created, error: insErr } = await supabase
      .from("work_order_lines")
      .insert(insertLine)
      .select("*")
      .single();

    if (insErr || !created) return bad("Failed to add custom line", 500);

    return NextResponse.json({ line: created }, { status: 201 });
  } catch (e: unknown) {
    const msg = e instanceof Error ? e.message : String(e);
    console.error("add-custom-line error:", msg);
    return bad("Unexpected error", 500);
  }
}


===== FILE: app/api/portal/request/add-quote-only/route.ts =====

import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type DB = Database;

type Body = {
  workOrderId: string;
  vehicleId?: string | null;
  description: string;
  notes?: string | null;
};

function bad(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

function isNonEmptyString(v: unknown): v is string {
  return typeof v === "string" && v.trim().length > 0;
}

function isNullableString(v: unknown): v is string | null | undefined {
  return typeof v === "string" || v === null || typeof v === "undefined";
}

function parseBody(raw: unknown): Body | null {
  if (!raw || typeof raw !== "object") return null;

  const r = raw as Record<string, unknown>;

  const workOrderId = r.workOrderId;
  const vehicleId = r.vehicleId;
  const description = r.description;
  const notes = r.notes;

  if (!isNonEmptyString(workOrderId)) return null;
  if (!isNonEmptyString(description)) return null;
  if (!isNullableString(vehicleId)) return null;
  if (!isNullableString(notes)) return null;

  return {
    workOrderId: workOrderId.trim(),
    vehicleId: typeof vehicleId === "string" ? vehicleId : null,
    description: description.trim(),
    notes: typeof notes === "string" ? notes : null,
  };
}

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<DB>({ cookies });

    // 1) Auth (portal user)
    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();

    if (authErr || !user) return bad("Not authenticated", 401);

    // 2) Parse body safely (no any)
    let rawJson: unknown;
    try {
      rawJson = await req.json();
    } catch {
      return bad("Invalid JSON body");
    }

    const body = parseBody(rawJson);
    if (!body) return bad("Missing/invalid fields");

    const { workOrderId, vehicleId, description, notes } = body;

    // 3) Confirm the portal user owns the customer on this work order
    const { data: customer, error: custErr } = await supabase
      .from("customers")
      .select("id")
      .eq("user_id", user.id)
      .maybeSingle();

    if (custErr) return bad("Failed to resolve customer", 500);
    if (!customer?.id) return bad("Customer profile not found", 404);

    const { data: wo, error: woErr } = await supabase
      .from("work_orders")
      .select("id, shop_id, customer_id, vehicle_id")
      .eq("id", workOrderId)
      .maybeSingle();

    if (woErr) return bad("Failed to load work order", 500);
    if (!wo) return bad("Work order not found", 404);
    if (wo.customer_id !== customer.id) return bad("Not allowed", 403);

    const effectiveVehicleId =
      vehicleId ?? (wo.vehicle_id ? String(wo.vehicle_id) : null);

    // 4) Create a quote request entry (work_order_quote_lines)
    // Use existing stage enum-like values:
    // - advisor_pending means shop/parts/tech will price it.
    const insertQuote: DB["public"]["Tables"]["work_order_quote_lines"]["Insert"] =
      {
        work_order_id: wo.id,
        shop_id: wo.shop_id,
        vehicle_id: effectiveVehicleId,
        description,
        notes: notes ?? null,
        stage: "advisor_pending",
        job_type: "customer_request",
        qty: 1,
        // keep totals null/0 until priced; your schema may allow null
        est_labor_hours: null,
        labor_total: null,
        parts_total: null,
        subtotal: null,
        tax_total: null,
        grand_total: null,
        metadata: {
          source: "portal",
          line_kind: "quote_only",
        } as DB["public"]["Tables"]["work_order_quote_lines"]["Insert"]["metadata"],
      };

    const { data: created, error: insErr } = await supabase
      .from("work_order_quote_lines")
      .insert(insertQuote)
      .select("*")
      .single();

    if (insErr || !created) {
      return bad(insErr?.message || "Failed to create quote request", 500);
    }

    return NextResponse.json({ quote: created }, { status: 201 });
  } catch (err: unknown) {
    const msg = err instanceof Error ? err.message : String(err);
    console.error("portal add-quote-only error:", msg);
    return bad("Unexpected error", 500);
  }
}


===== FILE: app/portal/request/when/page.tsx =====

// app/portal/request/when/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";
import LinkButton from "@shared/components/ui/LinkButton";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];
type ShopRow = Pick<DB["public"]["Tables"]["shops"]["Row"], "id" | "slug" | "timezone">;
type ShopHoursRow = DB["public"]["Tables"]["shop_hours"]["Row"];

type VisitType = "waiter" | "drop_off";

const COPPER = "#C57A4A";

function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none focus:border-white/20";
}

function pillClass(active: boolean) {
  return active
    ? "border-white/15 bg-white/10 text-neutral-50"
    : "border-white/10 bg-black/30 text-neutral-200 hover:bg-black/45";
}

function toIsoDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

function addDays(base: Date, days: number) {
  const d = new Date(base);
  d.setDate(d.getDate() + days);
  return d;
}

function rec(row: unknown): Record<string, unknown> {
  return (row && typeof row === "object" ? (row as Record<string, unknown>) : {}) as Record<
    string,
    unknown
  >;
}

function normalizeWeekdayToJs(dowRaw: number): number | null {
  if (!Number.isFinite(dowRaw)) return null;
  if (dowRaw >= 0 && dowRaw <= 6) return dowRaw;
  if (dowRaw >= 1 && dowRaw <= 7) return null;
  return null;
}

function getWeekdayCandidates(h: ShopHoursRow): number[] {
  const r = rec(h);

  const raw =
    (typeof r.weekday === "number" ? r.weekday : null) ??
    (typeof r.day_of_week === "number" ? r.day_of_week : null) ??
    (typeof r.dow === "number" ? r.dow : null);

  if (typeof raw !== "number" || !Number.isFinite(raw)) return [];

  const direct = normalizeWeekdayToJs(raw);
  if (direct != null) return [direct];

  if (raw >= 1 && raw <= 7) {
    const mon1 = raw % 7; // Mon=1..Sun=7 => Sun becomes 0
    const sun1 = raw - 1; // Sun=1..Sat=7
    return Array.from(new Set([mon1, sun1])).filter((n) => n >= 0 && n <= 6);
  }

  return [];
}

function getOpen(h: ShopHoursRow): string | null {
  const r = rec(h);
  const v =
    (typeof r.open_time === "string" ? r.open_time : null) ??
    (typeof r.open === "string" ? r.open : null);
  return typeof v === "string" ? v : null;
}

function getClose(h: ShopHoursRow): string | null {
  const r = rec(h);
  const v =
    (typeof r.close_time === "string" ? r.close_time : null) ??
    (typeof r.close === "string" ? r.close : null);
  return typeof v === "string" ? v : null;
}

function isClosedRow(h: ShopHoursRow): boolean {
  const r = rec(h);
  const closed =
    (typeof r.is_closed === "boolean" ? r.is_closed : false) ||
    (typeof r.closed === "boolean" ? r.closed : false) ||
    (typeof r.is_open === "boolean" ? !r.is_open : false);

  return !!closed;
}

function parseHmToMinutes(hm: string): number | null {
  const cleaned = hm.trim().split(/[^\d:]/)[0] ?? "";
  const parts = cleaned.split(":").map((x) => x.trim());
  if (parts.length < 2) return null;

  const hh = Number(parts[0]);
  const mm = Number(parts[1]);
  if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  if (hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;

  return hh * 60 + mm;
}

function minutesToLabel(mins: number) {
  const hh = Math.floor(mins / 60);
  const mm = mins % 60;
  const h12 = ((hh + 11) % 12) + 1;
  const ampm = hh >= 12 ? "PM" : "AM";
  const mmStr = mm.toString().padStart(2, "0");
  return `${h12}:${mmStr} ${ampm}`;
}

type Slot = {
  startsAtIso: string;
  label: string;
};

async function postJson<TResp>(
  url: string,
  body: unknown,
): Promise<{ ok: true; data: TResp } | { ok: false; error: string; status: number }> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const j = (await res.json().catch(() => ({}))) as { error?: string } & Record<string, unknown>;

  if (!res.ok) {
    return {
      ok: false,
      error: (typeof j?.error === "string" && j.error) || "Request failed",
      status: res.status,
    };
  }

  return { ok: true, data: j as unknown as TResp };
}

function mergeRanges(ranges: Array<[number, number]>): Array<[number, number]> {
  const sorted = ranges
    .filter(([a, b]) => Number.isFinite(a) && Number.isFinite(b) && b > a)
    .sort((x, y) => x[0] - y[0]);

  const out: Array<[number, number]> = [];
  for (const [s, e] of sorted) {
    const last = out[out.length - 1];
    if (!last) out.push([s, e]);
    else if (s <= last[1]) last[1] = Math.max(last[1], e);
    else out.push([s, e]);
  }
  return out;
}

export default function PortalRequestWhenPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();

  const [loading, setLoading] = useState(true);

  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [shop, setShop] = useState<ShopRow | null>(null);
  const [vehicles, setVehicles] = useState<VehicleRow[]>([]);
  const [shopHours, setShopHours] = useState<ShopHoursRow[]>([]);

  const [vehicleId, setVehicleId] = useState<string>("");
  const [date, setDate] = useState<string>(() => toIsoDate(new Date()));
  const [visitType, setVisitType] = useState<VisitType>("drop_off");
  const [selectedSlotIso, setSelectedSlotIso] = useState<string>("");

  const [starting, setStarting] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr || !user) {
        toast.error("Please sign in to request service.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cancelled) return;

      if (cErr) {
        toast.error(cErr.message);
        setCustomer(null);
        setLoading(false);
        return;
      }

      const cust = (c ?? null) as CustomerRow | null;
      setCustomer(cust);

      if (!cust?.shop_id) {
        setShop(null);
        setVehicles([]);
        setShopHours([]);
        setLoading(false);
        return;
      }

      const { data: s, error: sErr } = await supabase
        .from("shops")
        .select("id,slug,timezone")
        .eq("id", cust.shop_id)
        .maybeSingle();

      if (cancelled) return;

      if (sErr || !s) {
        toast.error("Unable to load your shop.");
        setShop(null);
        setVehicles([]);
        setShopHours([]);
        setLoading(false);
        return;
      }

      setShop(s as ShopRow);

      const { data: v, error: vErr } = await supabase
        .from("vehicles")
        .select("id,customer_id,shop_id,year,make,model,vin,license_plate,mileage,color,created_at")
        .eq("customer_id", cust.id)
        .order("created_at", { ascending: false });

      if (cancelled) return;

      if (vErr) {
        toast.error(vErr.message);
        setVehicles([]);
      } else {
        const vv = (v ?? []) as unknown as VehicleRow[];
        setVehicles(vv);
        if (!vehicleId && vv[0]?.id) setVehicleId(vv[0].id);
      }

      const { data: h, error: hErr } = await supabase.from("shop_hours").select("*").eq("shop_id", s.id);

      if (cancelled) return;

      if (hErr) {
        toast.error("Unable to load shop hours.");
        setShopHours([]);
      } else {
        setShopHours((h ?? []) as ShopHoursRow[]);
      }

      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [supabase, router]);

  const dateOptions = useMemo(() => {
    const base = new Date();
    const days = Array.from({ length: 21 }).map((_, i) => addDays(base, i));
    return days.map((d) => {
      const iso = toIsoDate(d);
      const label = d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
      return { iso, label };
    });
  }, []);

  const slots: Slot[] = useMemo(() => {
    if (!date) return [];
    if (!shopHours.length) return [];

    const d = new Date(`${date}T00:00:00`);
    const jsDay = d.getDay();

    const candidateRows = shopHours.filter((h) => {
      if (isClosedRow(h)) return false;
      const cands = getWeekdayCandidates(h);
      return cands.includes(jsDay);
    });

    if (!candidateRows.length) return [];

    const ranges: Array<[number, number]> = [];

    for (const row of candidateRows) {
      const open = getOpen(row);
      const close = getClose(row);
      if (!open || !close) continue;

      const openM = parseHmToMinutes(open);
      const closeM = parseHmToMinutes(close);
      if (openM == null || closeM == null) continue;
      if (closeM <= openM) continue;

      ranges.push([openM, closeM]);
    }

    const merged = mergeRanges(ranges);
    if (!merged.length) return [];

    const startOfDay = new Date(`${date}T00:00:00.000`);
    const out: Slot[] = [];

    for (const [openM, closeM] of merged) {
      for (let m = openM; m + 60 <= closeM; m += 60) {
        const slotStart = new Date(startOfDay);
        slotStart.setMinutes(m, 0, 0);

        out.push({
          startsAtIso: slotStart.toISOString(),
          label: minutesToLabel(m),
        });
      }
    }

    return out;
  }, [date, shopHours]);

  useEffect(() => {
    setSelectedSlotIso("");
  }, [date]);

  const canStart = Boolean(customer?.id && shop?.id && vehicleId && selectedSlotIso);

  async function onStart() {
    if (!canStart || starting) return;

    setStarting(true);
    try {
      const payload = { vehicleId, startsAt: selectedSlotIso, visitType };

      const r = await postJson<{ workOrderId?: string; bookingId?: string }>(
        "/api/portal/request/start",
        payload,
      );

      if (!r.ok) {
        toast.error(r.error);
        return;
      }

      const wo = r.data.workOrderId ?? "";
      const booking = r.data.bookingId ?? "";

      if (!wo || !booking) {
        toast.error("Start failed: missing work order id or booking id.");
        return;
      }

      // ✅ Option B: carry bookingId into build page (NOT startsAt)
      router.push(
        `/portal/request/build?wo=${encodeURIComponent(wo)}&booking=${encodeURIComponent(booking)}`,
      );
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Start failed.";
      toast.error(msg);
    } finally {
      setStarting(false);
    }
  }

  if (loading) {
    return <div className={cardClass() + " mx-auto max-w-xl text-sm text-neutral-200"}>Loading…</div>;
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Request service</h1>
          <p className="mt-2 text-sm text-neutral-400">We couldn’t find your customer profile yet.</p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">Go to profile</LinkButton>
            <LinkButton href="/portal/vehicles" size="sm">Add a vehicle</LinkButton>
          </div>
        </div>
      </div>
    );
  }

  if (!shop?.id) {
    return (
      <div className="mx-auto max-w-xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Request service</h1>
          <p className="mt-2 text-sm text-neutral-400">Your portal account isn’t linked to a shop yet.</p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">Go to profile</LinkButton>
            <LinkButton href="/portal/customer-appointments" size="sm">My appointments</LinkButton>
          </div>
        </div>
      </div>
    );
  }

  const customerName =
    [customer.first_name ?? "", customer.last_name ?? ""].filter(Boolean).join(" ").trim() || "Customer";

  return (
    <div className="mx-auto w-full max-w-xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <div
          className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
          style={{ color: COPPER }}
        >
          Request
        </div>
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">Pick a time</h1>
        <p className="text-xs text-neutral-400">
          {customerName} • Shop: <span className="text-neutral-300">{shop.slug}</span>
        </p>
      </header>

      <section className={cardClass() + " space-y-4"}>
        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Vehicle</div>

          {vehicles.length === 0 ? (
            <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
              No vehicles found. Add one first.
              <div className="mt-3">
                <LinkButton href="/portal/vehicles" size="sm">Add vehicle</LinkButton>
              </div>
            </div>
          ) : (
            <select className={inputClass()} value={vehicleId} onChange={(e) => setVehicleId(e.target.value)}>
              {vehicles.map((v) => {
                const label = [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim() || "Vehicle";
                const vin = v.vin ? ` • VIN ${String(v.vin).slice(-6)}` : "";
                return (
                  <option key={v.id} value={v.id}>
                    {label}
                    {vin}
                  </option>
                );
              })}
            </select>
          )}
        </div>

        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Date</div>
          <select className={inputClass()} value={date} onChange={(e) => setDate(e.target.value)}>
            {dateOptions.map((d) => (
              <option key={d.iso} value={d.iso}>
                {d.label}
              </option>
            ))}
          </select>
        </div>

        <div className="space-y-2">
          <div className="flex items-center justify-between">
            <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Time</div>
            <div className="text-[0.75rem] text-neutral-500">1-hour slots</div>
          </div>

          {slots.length === 0 ? (
            <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
              No hours available for this day.
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-2 sm:grid-cols-3">
              {slots.map((s) => {
                const active = selectedSlotIso === s.startsAtIso;
                return (
                  <button
                    key={s.startsAtIso}
                    type="button"
                    onClick={() => setSelectedSlotIso(s.startsAtIso)}
                    className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(active)}
                  >
                    {s.label}
                  </button>
                );
              })}
            </div>
          )}
        </div>

        <div className="space-y-2">
          <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">Visit type</div>
          <div className="grid grid-cols-2 gap-2">
            <button
              type="button"
              className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(visitType === "waiter")}
              onClick={() => setVisitType("waiter")}
            >
              Waiter
              <div className="mt-1 text-[0.75rem] text-neutral-400">You plan to wait at the shop.</div>
            </button>
            <button
              type="button"
              className={"rounded-xl border px-3 py-2 text-sm transition " + pillClass(visitType === "drop_off")}
              onClick={() => setVisitType("drop_off")}
            >
              Drop off
              <div className="mt-1 text-[0.75rem] text-neutral-400">Leave the vehicle for service.</div>
            </button>
          </div>
        </div>

        <div className="flex flex-wrap gap-2 pt-1">
          <Button
            type="button"
            onClick={() => void onStart()}
            disabled={!canStart || starting || vehicles.length === 0}
            className="min-w-[180px]"
          >
            {starting ? "Starting…" : "Next: build request"}
          </Button>

          <LinkButton href="/portal/customer-appointments" variant="outline" size="sm">
            Back
          </LinkButton>
        </div>

        <p className="text-[0.75rem] text-neutral-500">
          Next you’ll build your service request (menu items, custom lines, and quote-only requests).
        </p>
      </section>
    </div>
  );
}

===== FILE: app/portal/request/build/page.tsx =====

// app/portal/request/build/page.tsx
"use client";

import React, { useEffect, useMemo, useState } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";
import LinkButton from "@shared/components/ui/LinkButton";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type VehicleRow = DB["public"]["Tables"]["vehicles"]["Row"];
type WorkOrderRow = DB["public"]["Tables"]["work_orders"]["Row"];
type WorkOrderLineRow = DB["public"]["Tables"]["work_order_lines"]["Row"];
type QuoteLineRow = DB["public"]["Tables"]["work_order_quote_lines"]["Row"];
type MenuItemRow = DB["public"]["Tables"]["menu_items"]["Row"];

const COPPER = "#C57A4A";

function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/30 p-4 backdrop-blur-md shadow-card";
}

function inputClass() {
  return "w-full rounded-xl border border-white/10 bg-black/40 px-3 py-2 text-sm text-neutral-100 placeholder:text-neutral-500 outline-none focus:border-white/20";
}

function sectionTitle(s: string) {
  return (
    <div className="text-xs font-semibold uppercase tracking-[0.14em] text-neutral-400">
      {s}
    </div>
  );
}

async function postJson<TResp>(
  url: string,
  body: unknown,
): Promise<
  { ok: true; data: TResp } | { ok: false; error: string; status: number }
> {
  const res = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(body),
    cache: "no-store",
  });

  const j = (await res.json().catch(() => ({}))) as { error?: string } & Record<
    string,
    unknown
  >;

  if (!res.ok)
    return {
      ok: false,
      error: (typeof j?.error === "string" && j.error) || "Request failed",
      status: res.status,
    };

  return { ok: true, data: j as unknown as TResp };
}

function fmtMoney(n: number | null | undefined) {
  if (typeof n !== "number" || !Number.isFinite(n)) return "—";
  return n.toLocaleString(undefined, { style: "currency", currency: "CAD" });
}

function ymm(v: VehicleRow | null) {
  if (!v) return "";
  return [v.year ?? "", v.make ?? "", v.model ?? ""].filter(Boolean).join(" ").trim();
}

function safeTrim(s: unknown) {
  return typeof s === "string" ? s.trim() : "";
}

function rec(row: unknown): Record<string, unknown> {
  return (row && typeof row === "object" ? (row as Record<string, unknown>) : {}) as Record<
    string,
    unknown
  >;
}

function getOptString(row: unknown, key: string): string | null {
  const v = rec(row)[key];
  return typeof v === "string" ? v : null;
}

function getOptNumber(row: unknown, key: string): number | null {
  const v = rec(row)[key];
  return typeof v === "number" && Number.isFinite(v) ? v : null;
}

function menuTitle(m: MenuItemRow): string {
  const name = getOptString(m, "name");
  const title = getOptString(m, "title");
  return (name || title || m.description || "Menu item").toString();
}

function lineTitle(l: WorkOrderLineRow): string {
  const desc = getOptString(l, "description");
  return (desc || l.complaint || "Line").toString();
}

export default function PortalRequestBuildPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();
  const sp = useSearchParams();

  const workOrderId = sp.get("wo") ?? "";

  // ✅ Option B: carry bookingId from when page (NOT startsAt)
  const bookingId =
    sp.get("booking") ??
    sp.get("bookingId") ??
    "";

  const [loading, setLoading] = useState(true);
  const [customer, setCustomer] = useState<CustomerRow | null>(null);
  const [wo, setWo] = useState<WorkOrderRow | null>(null);
  const [vehicle, setVehicle] = useState<VehicleRow | null>(null);

  const [menuItems, setMenuItems] = useState<MenuItemRow[]>([]);
  const [menuSearch, setMenuSearch] = useState("");

  const [lines, setLines] = useState<WorkOrderLineRow[]>([]);
  const [quoteLines, setQuoteLines] = useState<QuoteLineRow[]>([]);
  const [refreshing, setRefreshing] = useState(false);

  const [customDesc, setCustomDesc] = useState("");
  const [customNotes, setCustomNotes] = useState("");

  const [qoDesc, setQoDesc] = useState("");
  const [qoNotes, setQoNotes] = useState("");
  const [qoQty, setQoQty] = useState("1");

  const [submitting, setSubmitting] = useState(false);

  const filteredMenu = useMemo(() => {
    const q = menuSearch.trim().toLowerCase();
    if (!q) return menuItems.slice(0, 40);

    return menuItems
      .filter((m) => {
        const hay = [
          menuTitle(m),
          m.description ?? "",
          m.category ?? "",
          m.service_key ?? "",
        ]
          .join(" ")
          .toLowerCase();

        return hay.includes(q);
      })
      .slice(0, 40);
  }, [menuItems, menuSearch]);

  async function loadAll() {
    if (!workOrderId) {
      toast.error("Missing work order id.");
      router.replace("/portal/request/when");
      return;
    }

    setRefreshing(true);

    try {
      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (userErr || !user) {
        toast.error("Please sign in.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cErr) throw new Error(cErr.message);

      const cust = (c ?? null) as CustomerRow | null;
      if (!cust?.id) {
        toast.error("Customer profile not found.");
        router.replace("/portal/profile");
        return;
      }
      setCustomer(cust);

      const { data: w, error: wErr } = await supabase
        .from("work_orders")
        .select("*")
        .eq("id", workOrderId)
        .eq("customer_id", cust.id)
        .maybeSingle();

      if (wErr) throw new Error(wErr.message);
      if (!w) {
        toast.error("Work order not found.");
        router.replace("/portal/request/when");
        return;
      }
      setWo(w as WorkOrderRow);

      if (w.vehicle_id) {
        const { data: v, error: vErr } = await supabase
          .from("vehicles")
          .select("id,customer_id,shop_id,year,make,model,vin,license_plate,mileage,color,created_at")
          .eq("id", w.vehicle_id)
          .maybeSingle();

        if (!vErr && v) setVehicle(v as unknown as VehicleRow);
      } else {
        setVehicle(null);
      }

      const { data: l, error: lErr } = await supabase
        .from("work_order_lines")
        .select("*")
        .eq("work_order_id", w.id)
        .order("created_at", { ascending: true });

      if (lErr) throw new Error(lErr.message);
      setLines((l ?? []) as unknown as WorkOrderLineRow[]);

      const { data: ql, error: qlErr } = await supabase
        .from("work_order_quote_lines")
        .select("*")
        .eq("work_order_id", w.id)
        .order("created_at", { ascending: true });

      if (qlErr) throw new Error(qlErr.message);
      setQuoteLines((ql ?? []) as unknown as QuoteLineRow[]);

      if (cust.shop_id) {
        const { data: mi, error: miErr } = await supabase
          .from("menu_items")
          .select("*")
          .eq("shop_id", cust.shop_id)
          .eq("is_active", true)
          .order("category", { ascending: true })
          .limit(500);

        if (miErr) throw new Error(miErr.message);

        const all = (mi ?? []) as unknown as MenuItemRow[];

        const vy = (vehicle?.year ?? null) as number | null;
        const vm = safeTrim(vehicle?.make ?? null);
        const vmo = safeTrim(vehicle?.model ?? null);

        const filtered = all.filter((m) => {
          const my = getOptNumber(m, "vehicle_year");
          const mm = safeTrim(getOptString(m, "vehicle_make"));
          const mmo = safeTrim(getOptString(m, "vehicle_model"));

          const hasAnyVehicleKey = my != null || !!mm || !!mmo;
          if (!hasAnyVehicleKey) return true;

          const yearOk = my == null || (vy != null && my === vy);
          const makeOk = !mm || (vm && mm.toLowerCase() === vm.toLowerCase());
          const modelOk = !mmo || (vmo && mmo.toLowerCase() === vmo.toLowerCase());

          return yearOk && makeOk && modelOk;
        });

        setMenuItems(filtered);
      } else {
        setMenuItems([]);
      }
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Failed to load request.";
      toast.error(msg);
    } finally {
      setRefreshing(false);
      setLoading(false);
    }
  }

  useEffect(() => {
    void loadAll();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [workOrderId]);

  async function addMenuLine(menuItemId: string) {
    if (!wo?.id) return;

    const r = await postJson<{ line?: unknown }>(
      "/api/portal/request/add-menu-line",
      { workOrderId: wo.id, menuItemId },
    );

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Added menu item.");
    await loadAll();
  }

  async function addCustomLine() {
    if (!wo?.id) return;

    const desc = customDesc.trim();
    if (!desc) {
      toast.error("Enter a description for the custom line.");
      return;
    }

    const r = await postJson<{ line?: unknown }>(
      "/api/portal/request/add-custom-line",
      {
        workOrderId: wo.id,
        description: desc,
        notes: customNotes.trim() || null,
      },
    );

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Added custom line.");
    setCustomDesc("");
    setCustomNotes("");
    await loadAll();
  }

  async function addQuoteOnly() {
    if (!wo?.id) return;

    const desc = qoDesc.trim();
    if (!desc) {
      toast.error("Enter a description for the quote request.");
      return;
    }

    const qtyN = Number(qoQty);
    const qty = Number.isFinite(qtyN)
      ? Math.max(1, Math.min(99, Math.trunc(qtyN)))
      : 1;

    const r = await postJson<{ quoteLine?: unknown }>(
      "/api/portal/request/add-quote-only",
      { workOrderId: wo.id, description: desc, notes: qoNotes.trim() || null, qty },
    );

    if (!r.ok) {
      toast.error(r.error);
      return;
    }

    toast.success("Sent to quote queue.");
    setQoDesc("");
    setQoNotes("");
    setQoQty("1");
    await loadAll();
  }

  async function onSubmit() {
    if (!wo?.id || submitting) return;

    // ✅ Option B: bookingId must be present (slot already reserved)
    if (!bookingId) {
      toast.error("Missing booking. Please go back and pick a time again.");
      router.replace("/portal/request/when");
      return;
    }

    setSubmitting(true);
    try {
      const r = await postJson<{ ok?: boolean; bookingId?: string; workOrderId?: string }>(
        "/api/portal/request/submit",
        { workOrderId: wo.id, bookingId },
      );

      if (!r.ok) {
        toast.error(r.error);
        return;
      }

      toast.success("Submitted.");
      router.replace("/portal/customer-appointments");
    } catch (e: unknown) {
      const msg = e instanceof Error ? e.message : "Submit failed.";
      toast.error(msg);
    } finally {
      setSubmitting(false);
    }
  }

  if (loading) {
    return (
      <div className={cardClass() + " mx-auto max-w-3xl text-sm text-neutral-200"}>
        Loading…
      </div>
    );
  }

  if (!wo?.id || !customer?.id) {
    return (
      <div className="mx-auto max-w-3xl space-y-3 text-white">
        <Toaster position="top-center" />
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            Build request
          </h1>
          <p className="mt-2 text-sm text-neutral-400">This request is missing or expired.</p>
          <div className="mt-4">
            <LinkButton href="/portal/request/when" size="sm">
              Start again
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  const name =
    [customer.first_name ?? "", customer.last_name ?? ""].filter(Boolean).join(" ").trim() ||
    "Customer";

  return (
    <div className="mx-auto w-full max-w-3xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <div className="flex flex-wrap items-center justify-between gap-2">
          <div>
            <div
              className="inline-flex items-center rounded-full border border-white/10 bg-white/5 px-3 py-1 text-[11px] uppercase tracking-[0.2em]"
              style={{ color: COPPER }}
            >
              Request
            </div>
            <h1 className="mt-2 text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
              Build your request
            </h1>
            <p className="mt-1 text-xs text-neutral-400">
              {name} • {vehicle ? ymm(vehicle) : "Vehicle not set"} • WO{" "}
              <span className="font-mono text-neutral-300">{wo.id.slice(0, 8)}…</span>
            </p>
          </div>

          <div className="flex gap-2">
            <Button type="button" variant="outline" onClick={() => void loadAll()} disabled={refreshing}>
              {refreshing ? "Refreshing…" : "Refresh"}
            </Button>
            <LinkButton href="/portal/request/when" variant="outline" size="sm">
              Back
            </LinkButton>
          </div>
        </div>
      </header>

      <section className={cardClass()}>
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-100">Current draft</h2>
          <div className="text-[0.75rem] text-neutral-500">
            Lines: {lines.length} • Quote requests: {quoteLines.length}
          </div>
        </div>

        {lines.length === 0 && quoteLines.length === 0 ? (
          <div className="mt-3 rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
            Nothing added yet. Add menu items, custom lines, or quote requests below.
          </div>
        ) : (
          <div className="mt-3 space-y-2">
            {lines.map((l) => {
              const title = lineTitle(l);
              const status = (l.status ?? "pending").toString();
              const est = getOptNumber(l, "price_estimate");

              return (
                <div key={l.id} className="rounded-xl border border-white/10 bg-black/35 p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-0.5 text-xs text-neutral-400">
                        Status: <span className="text-neutral-300">{status}</span>
                        {l.menu_item_id ? (
                          <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                            menu
                          </span>
                        ) : (
                          <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                            custom
                          </span>
                        )}
                      </div>

                      {typeof l.notes === "string" && l.notes.trim().length > 0 ? (
                        <div className="mt-2 text-xs text-neutral-400">{l.notes}</div>
                      ) : null}
                    </div>

                    <div className="text-right text-xs text-neutral-400">Est: {fmtMoney(est)}</div>
                  </div>
                </div>
              );
            })}

            {quoteLines.map((q) => {
              const title = (q.description ?? "Quote request").toString();
              const stage = (q.stage ?? "advisor_pending").toString();
              const qty = typeof q.qty === "number" && Number.isFinite(q.qty) ? q.qty : 1;

              return (
                <div key={q.id} className="rounded-xl border border-white/10 bg-black/25 p-3">
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-0.5 text-xs text-neutral-400">
                        Stage: <span className="text-neutral-300">{stage}</span> • Qty{" "}
                        <span className="text-neutral-300">{qty}</span>
                        <span className="ml-2 rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] text-neutral-200">
                          quote
                        </span>
                      </div>

                      {typeof q.notes === "string" && q.notes.trim().length > 0 ? (
                        <div className="mt-2 text-xs text-neutral-500">{q.notes}</div>
                      ) : null}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </section>

      <section className={cardClass() + " space-y-3"}>
        <div className="flex items-end justify-between gap-3">
          <div>
            {sectionTitle("Add menu items")}
            <div className="mt-1 text-xs text-neutral-500">Fixed pricing lines your shop already offers.</div>
          </div>
          <div className="w-full max-w-sm">
            <input
              className={inputClass()}
              placeholder="Search menu…"
              value={menuSearch}
              onChange={(e) => setMenuSearch(e.target.value)}
            />
          </div>
        </div>

        {filteredMenu.length === 0 ? (
          <div className="rounded-xl border border-dashed border-white/10 bg-black/25 p-3 text-sm text-neutral-300">
            No menu items found.
          </div>
        ) : (
          <div className="grid grid-cols-1 gap-2 sm:grid-cols-2">
            {filteredMenu.map((m) => {
              const title = menuTitle(m);
              const hrs = (m.base_labor_hours ?? m.labor_hours ?? null) as number | null;
              const price = (m.total_price ?? m.base_price ?? null) as number | null;

              return (
                <button
                  key={m.id}
                  type="button"
                  onClick={() => void addMenuLine(m.id)}
                  className="rounded-xl border border-white/10 bg-black/35 p-3 text-left transition hover:bg-black/45 active:scale-[0.99]"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">{title}</div>
                      <div className="mt-1 text-xs text-neutral-400">
                        {m.category ? <span>{String(m.category)}</span> : <span>Menu</span>}
                        {hrs != null ? <span className="ml-2">• {hrs}h</span> : null}
                      </div>
                    </div>
                    <div className="text-xs text-neutral-300">{fmtMoney(price)}</div>
                  </div>
                </button>
              );
            })}
          </div>
        )}
      </section>

      <section className={cardClass() + " space-y-3"}>
        {sectionTitle("Add custom line")}
        <div className="text-xs text-neutral-500">
          For concerns you already know. We’ll estimate labor and route parts quoting as needed.
        </div>

        <input
          className={inputClass()}
          placeholder="Example: Replace rear differential input u-joint"
          value={customDesc}
          onChange={(e) => setCustomDesc(e.target.value)}
        />
        <textarea
          className={inputClass() + " min-h-[92px] resize-none"}
          placeholder="Optional notes (symptoms, urgency, noises, etc.)"
          value={customNotes}
          onChange={(e) => setCustomNotes(e.target.value)}
        />

        <div className="flex gap-2">
          <Button type="button" onClick={() => void addCustomLine()}>
            Add custom line
          </Button>
        </div>
      </section>

      <section className={cardClass() + " space-y-3"}>
        {sectionTitle("Quote-only request")}
        <div className="text-xs text-neutral-500">
          Request pricing without committing to a work order line yet. Parts will be priced and returned to your portal.
        </div>

        <div className="grid grid-cols-1 gap-2 sm:grid-cols-[1fr_120px]">
          <input
            className={inputClass()}
            placeholder="Example: Replace tires (quote only)"
            value={qoDesc}
            onChange={(e) => setQoDesc(e.target.value)}
          />
          <input
            className={inputClass()}
            inputMode="numeric"
            placeholder="Qty"
            value={qoQty}
            onChange={(e) => setQoQty(e.target.value)}
          />
        </div>

        <textarea
          className={inputClass() + " min-h-[92px] resize-none"}
          placeholder="Optional notes (size, brand preference, etc.)"
          value={qoNotes}
          onChange={(e) => setQoNotes(e.target.value)}
        />

        <div className="flex gap-2">
          <Button type="button" onClick={() => void addQuoteOnly()} variant="outline">
            Send quote request
          </Button>
        </div>
      </section>

      <section className={cardClass()}>
        <div className="flex flex-wrap items-center justify-between gap-3">
          <div>
            <div className="text-sm font-semibold text-neutral-100">Submit request</div>
            <div className="mt-1 text-xs text-neutral-500">
              Submitting will finalize your draft and keep the reserved booking.
            </div>
          </div>

          <Button type="button" onClick={() => void onSubmit()} disabled={submitting}>
            {submitting ? "Submitting…" : "Submit request"}
          </Button>
        </div>
      </section>

      <div className="pb-2 text-[0.75rem] text-neutral-500">
        Tip: Menu items are pre-priced. Custom and quote-only lines can trigger parts pricing and AI assistance.
      </div>
    </div>
  );
}

===== FILE: app/portal/request/page.tsx =====

(missing)


===== FILE: app/portal/confirm/page.tsx =====

// app/portal/auth/confirm/page.tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export default function PortalConfirmPage() {
  const router = useRouter();
  const supabase = createClientComponentClient<Database>();

  useEffect(() => {
    let cancelled = false;

    (async () => {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      if (cancelled) return;

      // ✅ land on portal home
      router.replace(session?.user ? "/portal" : "/portal/auth/sign-in");
    })();

    return () => {
      cancelled = true;
    };
  }, [router, supabase]);

  return (
    <div className="mx-auto flex max-w-md items-center justify-center rounded-2xl border border-white/10 bg-black/30 p-6 text-sm text-neutral-200 backdrop-blur-md shadow-card">
      Completing sign-in…
    </div>
  );
}

===== FILE: app/api/portal/book/route.ts =====

// app/api/portal/book/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type Body = {
  shopSlug: string;
  startsAt: string; // ISO
  endsAt: string;   // ISO
  notes?: string;
  vehicleId?: string | null;

  // Optional: when internal staff creates a booking for a specific / new customer
  customerId?: string | null;
  customerName?: string;
  customerEmail?: string;
  customerPhone?: string;
};

function bad(msg: string, code = 400) {
  return NextResponse.json({ error: msg }, { status: code });
}

export async function POST(req: Request) {
  try {
    const supabase = createRouteHandlerClient<Database>({ cookies });

    // 1) Auth
    const {
      data: { user },
      error: authErr,
    } = await supabase.auth.getUser();
    if (authErr || !user) return bad("Not authenticated", 401);

    // 2) Parse body
    const body = (await req.json()) as Body;
    const {
      shopSlug,
      startsAt,
      endsAt,
      notes = "",
      vehicleId = null,
      customerId: rawCustomerId = null,
      customerName = "",
      customerEmail = "",
      customerPhone = "",
    } = body || {};

    if (!shopSlug || !startsAt || !endsAt) {
      return bad("Missing shopSlug, startsAt, or endsAt");
    }

    const start = new Date(startsAt);
    const end = new Date(endsAt);
    if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime()) || end <= start) {
      return bad("Invalid start/end");
    }

    // 3) Load shop (correct table = shops)
    const { data: shop, error: shopErr } = await supabase
      .from("shops")
      .select(
        "id, slug, accepts_online_booking, min_notice_minutes, max_lead_days, timezone",
      )
      .eq("slug", shopSlug)
      .single();

    if (shopErr || !shop) return bad("Shop not found", 404);
    if (shop.accepts_online_booking === false) {
      return bad("Shop is not accepting online bookings", 403);
    }

    // 4) Resolve customer
    const hasExplicitCustomer =
      !!rawCustomerId && rawCustomerId.trim().length > 0;
    const hasInlineCustomerFields =
      !!customerName.trim() ||
      !!customerEmail.trim() ||
      !!customerPhone.trim();

    let customerId: string | null = null;
    let customerShopId: string | null = null;

    if (hasExplicitCustomer) {
      // 4a. Existing customer chosen in appointments UI
      const { data: customerRow, error: customerRowErr } = await supabase
        .from("customers")
        .select("id, shop_id")
        .eq("id", rawCustomerId)
        .maybeSingle();

      if (customerRowErr || !customerRow) {
        return bad("Selected customer not found", 404);
      }

      if (customerRow.shop_id && customerRow.shop_id !== shop.id) {
        return bad("Customer belongs to a different shop", 403);
      }

      customerId = customerRow.id;
      customerShopId = customerRow.shop_id;
    } else if (hasInlineCustomerFields) {
      // 4b. NEW customer created from appointments UI (no customerId, but name/email/phone entered)
      const trimmedName = customerName.trim();
      let firstName: string | null = null;
      let lastName: string | null = null;

      if (trimmedName) {
        const parts = trimmedName.split(" ");
        firstName = parts[0] || null;
        lastName = parts.slice(1).join(" ") || null;
      }

      const insertCustomer: Database["public"]["Tables"]["customers"]["Insert"] = {
        shop_id: shop.id,
        first_name: firstName,
        last_name: lastName,
        email: customerEmail.trim() || null,
        phone: customerPhone.trim() || null,
      };

      const { data: newCustomer, error: newCustErr } = await supabase
        .from("customers")
        .insert(insertCustomer)
        .select("id, shop_id")
        .single();

      if (newCustErr || !newCustomer) {
        return bad("Failed to create customer for booking", 500);
      }

      customerId = newCustomer.id;
      customerShopId = newCustomer.shop_id;
    } else {
      // 4c. Portal self-serve: use the logged-in portal user → customers.user_id = auth.id
      const { data: customerRow, error: custErr } = await supabase
        .from("customers")
        .select("id, shop_id")
        .eq("user_id", user.id)
        .maybeSingle();

      if (custErr || !customerRow) {
        return bad("Customer profile not found for this user", 404);
      }

      customerId = customerRow.id;
      customerShopId = customerRow.shop_id;
    }

    if (!customerId) {
      return bad("Could not resolve customer for booking", 500);
    }

    // 5) Enforce notice / max lead
    const now = new Date();
    const minutesUntil = Math.floor((start.getTime() - now.getTime()) / 60000);
    const minNotice = shop.min_notice_minutes ?? 120;
    if (minutesUntil < minNotice) {
      return bad(`Bookings require at least ${minNotice} minutes notice`);
    }

    const midnightToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const daysUntil = Math.floor(
      (start.getTime() - midnightToday.getTime()) / 86400000,
    );
    const maxLead = shop.max_lead_days ?? 30;
    if (daysUntil > maxLead) {
      return bad(`Bookings cannot be more than ${maxLead} days in advance`);
    }

    // 6) Overlap check (same shop, overlapping time window)
    const { data: overlaps, error: ovErr } = await supabase
      .from("bookings")
      .select("id")
      .eq("shop_id", shop.id)
      .or(`and(starts_at.lt.${endsAt},ends_at.gt.${startsAt})`)
      .limit(1);

    if (ovErr) return bad("Failed to check availability", 500);
    if (overlaps && overlaps.length > 0) {
      return bad("This time overlaps an existing booking", 409);
    }

    // 7) Insert booking
    const insertBooking: Database["public"]["Tables"]["bookings"]["Insert"] = {
      shop_id: shop.id,
      customer_id: customerId,
      vehicle_id: vehicleId ?? null,
      starts_at: startsAt,
      ends_at: endsAt,
      status: "pending",
      notes: notes || null,
    };

    const { data: created, error: insErr } = await supabase
      .from("bookings")
      .insert(insertBooking)
      .select("*")
      .single();

    if (insErr || !created) return bad("Failed to create booking", 500);

    // 8) If this came from portal (no explicit customer & no inline fields) and customer
    // isn't linked to a shop yet, attach it. For staff-created customers we already set shop_id.
    const cameFromPortal = !hasExplicitCustomer && !hasInlineCustomerFields;
    if (cameFromPortal && !customerShopId) {
      const { error: attachErr } = await supabase
        .from("customers")
        .update({ shop_id: shop.id })
        .eq("id", customerId);

      if (attachErr) {
        console.warn("Could not link customer to shop:", attachErr.message);
      }
    }

    // 9) Return the booking
    return NextResponse.json({ booking: created }, { status: 201 });
  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : String(err);
    console.error("Booking error:", message);
    return bad("Unexpected error", 500);
  }
}

===== FILE: app/api/portal/bookings/route.ts =====

// app/api/portal/bookings/route.ts
import { NextResponse } from "next/server";
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type Db = Database;

// Shape we return to the client (matches Booking in /portal/appointments)
type BookingPayload = {
  id: string;
  shop_slug: string | null;
  starts_at: string;
  ends_at: string;
  customer_id: string | null;
  customer_name: string | null;
  customer_email: string | null;
  customer_phone: string | null;
  notes: string | null;
  status: string | null;
};

type BookingRow = Db["public"]["Tables"]["bookings"]["Row"] & {
  customers?: Pick<
    Db["public"]["Tables"]["customers"]["Row"],
    "first_name" | "last_name" | "email" | "phone"
  > | null;
  shops?: Pick<Db["public"]["Tables"]["shops"]["Row"], "slug"> | null;
};

function bad(msg: string, status = 400): NextResponse {
  return NextResponse.json({ error: msg }, { status });
}

export async function GET(req: Request): Promise<Response> {
  const supabase = createRouteHandlerClient<Db>({ cookies });

  const url = new URL(req.url);
  const shopSlug = url.searchParams.get("shop") ?? "";
  const start = url.searchParams.get("start") ?? "";
  const end = url.searchParams.get("end") ?? "";

  if (!shopSlug || !start || !end) {
    return bad("Missing shop, start, or end");
  }

  // Auth
  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();
  if (authErr || !user) return bad("Not authenticated", 401);

  // Staff profile
  const { data: profile, error: profErr } = await supabase
    .from("profiles")
    .select("shop_id, role")
    .eq("id", user.id)
    .single();

  if (profErr || !profile?.shop_id) {
    return bad("Profile / shop not found", 403);
  }

  const staffRoles = [
    "owner",
    "admin",
    "manager",
    "advisor",
    "mechanic",
    "parts",
  ] as const;

  if (
    !profile.role ||
    !staffRoles.includes(profile.role as (typeof staffRoles)[number])
  ) {
    return bad("Not allowed", 403);
  }

  // Shop by slug
  const { data: shop, error: shopErr } = await supabase
    .from("shops")
    .select("id, slug")
    .eq("slug", shopSlug)
    .single();

  if (shopErr || !shop) return bad("Shop not found", 404);
  if (shop.id !== profile.shop_id) {
    return bad("You cannot view bookings for this shop", 403);
  }

  // Build date window for the week (inclusive)
  const startIso = new Date(`${start}T00:00:00.000Z`).toISOString();
  const endDate = new Date(`${end}T00:00:00.000Z`);
  endDate.setDate(endDate.getDate() + 1); // next day
  const endIso = endDate.toISOString();

  // Query bookings + customer + shop slug
  const { data: rows, error: rowsErr } = await supabase
    .from("bookings")
    .select(
      `
        id,
        shop_id,
        customer_id,
        starts_at,
        ends_at,
        status,
        notes,
        customers:customer_id (
          first_name,
          last_name,
          email,
          phone
        ),
        shops:shop_id (
          slug
        )
      `,
    )
    .eq("shop_id", shop.id)
    .gte("starts_at", startIso)
    .lt("starts_at", endIso)
    .order("starts_at", { ascending: true });

  if (rowsErr || !rows) {
    return bad("Failed to load bookings", 500);
  }

  const bookings = rows as unknown as BookingRow[];

  const payload: BookingPayload[] = bookings.map((row) => {
    const customer = row.customers ?? null;
    const shopRel = row.shops ?? null;

    const nameFromCustomer =
      [customer?.first_name, customer?.last_name]
        .filter((part) => !!part && part.trim().length > 0)
        .join(" ") || null;

    const emailFromCustomer = customer?.email ?? null;
    const phoneFromCustomer = customer?.phone ?? null;

    return {
      id: row.id,
      shop_slug: shopRel?.slug ?? null,
      starts_at: row.starts_at,
      ends_at: row.ends_at,
      customer_id: row.customer_id ?? null,
      customer_name: nameFromCustomer,
      customer_email: emailFromCustomer,
      customer_phone: phoneFromCustomer,
      notes: row.notes ?? null,
      status: row.status ?? null,
    };
  });

  return NextResponse.json(payload);
}

===== FILE: app/api/portal/bookings/[id]/route.ts =====

// app/api/portal/bookings/[id]/route.ts
import { cookies } from "next/headers";
import { createRouteHandlerClient } from "@supabase/auth-helpers-nextjs";
import { NextResponse } from "next/server";
import type { Database } from "@shared/types/types/supabase";

export const runtime = "nodejs";

type PatchBody = {
  status?: "pending" | "confirmed" | "completed" | "cancelled";
  starts_at?: string;
  ends_at?: string;
  notes?: string | null;
};

function jsonError(msg: string, status = 400) {
  return NextResponse.json({ error: msg }, { status });
}

function getIdFromUrl(url: string): string {
  const { pathname } = new URL(url);
  return pathname.split("/").pop() ?? "";
}

const STAFF_ROLES = new Set([
  "owner",
  "admin",
  "manager",
  "advisor",
  "mechanic",
  "parts",
]);

async function isStaffForShop(
  supabase: ReturnType<typeof createRouteHandlerClient<Database>>,
  userId: string,
  shopId: string,
): Promise<boolean> {
  const { data: profile } = await supabase
    .from("profiles")
    .select("id, role, shop_id")
    .eq("id", userId)
    .maybeSingle();

  if (!profile) return false;
  return STAFF_ROLES.has(profile.role ?? "") && profile.shop_id === shopId;
}

async function isCustomerOwner(
  supabase: ReturnType<typeof createRouteHandlerClient<Database>>,
  userId: string,
  customerId: string | null,
): Promise<boolean> {
  if (!customerId) return false;
  const { data } = await supabase
    .from("customers")
    .select("id")
    .eq("id", customerId)
    .eq("user_id", userId)
    .maybeSingle();
  return !!data;
}

export async function PATCH(req: Request): Promise<Response> {
  const bookingId = getIdFromUrl(req.url);
  if (!bookingId) return jsonError("Missing booking id");

  const supabase = createRouteHandlerClient<Database>({ cookies });

  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();

  if (authErr || !user) return jsonError("Not authenticated", 401);

  let body: PatchBody;
  try {
    body = (await req.json()) as PatchBody;
  } catch {
    return jsonError("Invalid JSON body");
  }

  const { data: booking, error: bErr } = await supabase
    .from("bookings")
    .select("id, shop_id, customer_id, status, starts_at, ends_at, notes")
    .eq("id", bookingId)
    .maybeSingle();

  if (bErr || !booking) return jsonError("Booking not found", 404);

  const staff = await isStaffForShop(supabase, user.id, booking.shop_id);
  const owner = await isCustomerOwner(supabase, user.id, booking.customer_id);

  if (!staff && !owner) return jsonError("Not allowed", 403);

  // Customers can only cancel, not reschedule or mark complete.
  if (owner) {
    if (body.starts_at || body.ends_at) {
      return jsonError("Customers may not reschedule bookings", 403);
    }
    if (body.status && body.status !== "cancelled") {
      return jsonError("Customers may only cancel a booking", 403);
    }
  }

  // Validate reschedule times (staff only)
  let nextStart: Date | null = null;
  let nextEnd: Date | null = null;
  if (body.starts_at || body.ends_at) {
    if (!staff) return jsonError("Only staff can reschedule", 403);

    if (!body.starts_at || !body.ends_at) {
      return jsonError("starts_at and ends_at are required to reschedule");
    }

    nextStart = new Date(body.starts_at);
    nextEnd = new Date(body.ends_at);

    if (Number.isNaN(nextStart.getTime()) || Number.isNaN(nextEnd.getTime())) {
      return jsonError("Invalid starts_at/ends_at");
    }
    if (nextEnd <= nextStart) return jsonError("ends_at must be after starts_at");
  }

  const patch: Partial<Database["public"]["Tables"]["bookings"]["Update"]> = {};

  if (typeof body.notes !== "undefined") patch.notes = body.notes ?? null;
  if (body.status) patch.status = body.status;
  if (nextStart && nextEnd) {
    patch.starts_at = nextStart.toISOString();
    patch.ends_at = nextEnd.toISOString();
  }

  if (Object.keys(patch).length === 0) {
    return jsonError("Nothing to update");
  }

  const { data: updated, error: upErr } = await supabase
    .from("bookings")
    .update(patch)
    .eq("id", bookingId)
    .select("*")
    .maybeSingle();

  if (upErr || !updated) return jsonError("Failed to update booking", 500);

  return NextResponse.json({ booking: updated }, { status: 200 });
}

export async function DELETE(req: Request): Promise<Response> {
  const bookingId = getIdFromUrl(req.url);
  if (!bookingId) return jsonError("Missing booking id");

  const supabase = createRouteHandlerClient<Database>({ cookies });

  const {
    data: { user },
    error: authErr,
  } = await supabase.auth.getUser();

  if (authErr || !user) return jsonError("Not authenticated", 401);

  const { data: booking, error: bErr } = await supabase
    .from("bookings")
    .select("id, shop_id, customer_id")
    .eq("id", bookingId)
    .maybeSingle();

  if (bErr || !booking) return jsonError("Booking not found", 404);

  const staff = await isStaffForShop(supabase, user.id, booking.shop_id);
  const owner = await isCustomerOwner(supabase, user.id, booking.customer_id);

  if (!staff && !owner) return jsonError("Not allowed", 403);

  const { error: delErr } = await supabase.from("bookings").delete().eq("id", bookingId);
  if (delErr) return jsonError("Failed to delete booking", 500);

  return NextResponse.json({ ok: true }, { status: 200 });
}

===== FILE: app/portal/appointments/page.tsx =====

// app/portal/appointments/page.tsx
"use client";

import { useEffect, useMemo, useState } from "react";
import { useSearchParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast, Toaster } from "sonner";

import WeeklyCalendar from "./WeeklyCalendar";
import type { Database } from "@shared/types/types/supabase";
import { Button } from "@shared/components/ui/Button";

type ShopRow = Database["public"]["Tables"]["shops"]["Row"];
type CustomerRow = Database["public"]["Tables"]["customers"]["Row"];

export type Booking = {
  id: string;
  shop_slug?: string | null;
  starts_at: string; // ISO
  ends_at: string; // ISO
  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;
  notes?: string | null;
  status?: string | null; // pending, confirmed, cancelled...
};

const isoDate = (d: Date) => d.toISOString().slice(0, 10);

function startOfToday(): Date {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  return d;
}

function cardClass() {
  return "rounded-2xl border border-neutral-800/70 bg-neutral-950/45 p-4 backdrop-blur-md";
}

function fieldClass() {
  return "mt-1 w-full rounded-md border border-neutral-800 bg-neutral-950/60 px-2 py-1 text-sm text-white outline-none focus:border-orange-500/60 focus:ring-1 focus:ring-orange-500/40";
}

function safeString(v: unknown): string {
  return typeof v === "string" ? v : "";
}

function customerLabel(c: CustomerRow): string {
  const rec = c as unknown as Record<string, unknown>;

  const first = safeString(rec["first_name"]);
  const last = safeString(rec["last_name"]);
  const full = safeString(rec["full_name"]) || safeString(rec["name"]);
  const name =
    full || `${first} ${last}`.trim() || safeString(rec["email"]) || "Customer";

  const phone = safeString(rec["phone"]) || safeString(rec["mobile"]);
  return phone ? `${name} (${phone})` : name;
}

function pillClass(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed")
    return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled")
    return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-orange-500/30 bg-orange-900/10 text-orange-200";
}

export default function PortalAppointmentsPage() {
  const supabase = createClientComponentClient<Database>();
  const search = useSearchParams();
  const router = useRouter();

  const [shops, setShops] = useState<ShopRow[]>([]);
  const [shopSlug, setShopSlug] = useState<string>(search.get("shop") || "");

  const [customers, setCustomers] = useState<CustomerRow[]>([]);
  const [loadingCustomers, setLoadingCustomers] = useState(false);

  const [weekStart, setWeekStart] = useState<Date>(() => startOfToday());

  const [bookings, setBookings] = useState<Booking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  const [editing, setEditing] = useState<Booking | null>(null);
  const [creatingDate, setCreatingDate] = useState<string | null>(null);

  // load shops
  useEffect(() => {
    (async () => {
      const { data, error } = await supabase
        .from("shops")
        .select("id,name,slug,accepts_online_booking")
        .eq("accepts_online_booking", true)
        .order("name", { ascending: true });

      if (error) {
        console.error(error);
        toast.error("Unable to load shops.");
        return;
      }

      const rows = (data ?? []) as ShopRow[];
      setShops(rows);

      if (!shopSlug && rows.length > 0) {
        const first = rows[0].slug as string;
        setShopSlug(first);
        router.replace(`/portal/appointments?shop=${encodeURIComponent(first)}`);
      }
    })();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const selectedShop = useMemo(
    () => shops.find((s) => (s.slug as string | null) === shopSlug) ?? null,
    [shops, shopSlug],
  );

  // load customers for selected shop
  useEffect(() => {
    if (!selectedShop) return;

    (async () => {
      setLoadingCustomers(true);
      try {
        const { data, error } = await supabase
          .from("customers")
          .select("*")
          .eq("shop_id", selectedShop.id)
          .order("last_name", { ascending: true })
          .order("first_name", { ascending: true });

        if (error) {
          console.error(error);
          toast.error("Unable to load customers.");
          setCustomers([]);
        } else {
          setCustomers((data ?? []) as CustomerRow[]);
        }
      } catch (e) {
        console.error(e);
        toast.error("Unable to load customers.");
        setCustomers([]);
      } finally {
        setLoadingCustomers(false);
      }
    })();
  }, [supabase, selectedShop]);

  const weekEnd = useMemo(() => {
    const d = new Date(weekStart);
    d.setDate(d.getDate() + 6);
    return d;
  }, [weekStart]);

  // fetch bookings for week
  useEffect(() => {
    if (!shopSlug) return;
    (async () => {
      setLoadingBookings(true);
      try {
        const start = isoDate(weekStart);
        const end = isoDate(weekEnd);
        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
          { cache: "no-store" },
        );
        if (!res.ok) throw new Error("Failed to load appointments.");
        const j = (await res.json().catch(() => [])) as Booking[];
        setBookings(j ?? []);
      } catch (err: unknown) {
        console.error(err);
        toast.error("Failed to load appointments.");
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [shopSlug, weekStart, weekEnd]);

  async function handleCreate(form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) {
    if (!shopSlug) {
      toast.error("Select a shop first.");
      return;
    }

    try {
      const startIso = new Date(`${form.date}T${form.startsAt}`).toISOString();
      const endIso = new Date(`${form.date}T${form.endsAt}`).toISOString();

      const res = await fetch("/api/portal/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopSlug,
          startsAt: startIso,
          endsAt: endIso,
          notes: form.notes,
          customerId: form.customerId ?? null,
          customerName: form.customerName,
          customerEmail: form.customerEmail,
          customerPhone: form.customerPhone,
        }),
      });

      const j = (await res
        .json()
        .catch(() => ({}))) as { booking?: Booking; error?: string };

      if (!res.ok || !j.booking) {
        throw new Error(j?.error || "Unable to create appointment.");
      }

      setBookings((prev) => [...prev, j.booking as Booking]);

      toast.success("Appointment created.");
      setCreatingDate(null);

      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Create failed";
      toast.error(message);
    }
  }

  async function handleUpdate(id: string, patch: Partial<Booking>) {
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(patch),
      });
      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Update failed");

      toast.success("Appointment updated.");
      setEditing(null);
      await refreshBookings(shopSlug, weekStart, weekEnd, setBookings);
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Update failed";
      toast.error(message);
    }
  }

  async function handleDelete(id: string) {
    if (!confirm("Delete this appointment?")) return;
    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "DELETE",
      });
      if (!res.ok) throw new Error("Delete failed.");
      toast.success("Appointment deleted.");
      setBookings((prev) => prev.filter((b) => b.id !== id));
    } catch (err: unknown) {
      const message = err instanceof Error ? err.message : "Delete failed";
      toast.error(message);
    }
  }

  // quick actions for requests
  async function approveBooking(b: Booking) {
    await handleUpdate(b.id, { status: "confirmed" });
  }

  async function declineBooking(b: Booking) {
    await handleUpdate(b.id, { status: "cancelled" });
  }

  const pending = useMemo(
    () => bookings.filter((b) => (b.status || "pending").toLowerCase() === "pending"),
    [bookings],
  );
  const confirmed = useMemo(
    () => bookings.filter((b) => (b.status || "").toLowerCase() === "confirmed"),
    [bookings],
  );
  const cancelled = useMemo(
    () => bookings.filter((b) => (b.status || "").toLowerCase() === "cancelled"),
    [bookings],
  );

  const totalForWeek = useMemo(() => bookings.length, [bookings]);

  return (
    <div className="space-y-6">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-2xl font-blackops text-orange-500">Appointments</h1>
        <p className="text-sm text-neutral-400">
          Admin / manager view of customer bookings for the week.
        </p>
      </header>

      {/* Shop selector */}
      <div className={cardClass()}>
        <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <div className="flex items-center gap-3">
            <div className="text-[0.7rem] uppercase tracking-[0.12em] text-neutral-400">
              Shop
            </div>
            <select
              value={shopSlug}
              onChange={(e) => {
                const slug = e.target.value;
                setShopSlug(slug);
                router.replace(`/portal/appointments?shop=${encodeURIComponent(slug)}`);
              }}
              className={fieldClass() + " min-w-[220px]"}
            >
              {shops.map((s) => (
                <option key={s.slug as string} value={s.slug as string}>
                  {s.name}
                </option>
              ))}
            </select>
          </div>

          <div className="flex flex-wrap items-center gap-2">
            <div className="rounded-xl border border-neutral-800/70 bg-neutral-950/50 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-neutral-500">
                This week
              </div>
              <div className="text-sm font-semibold text-neutral-100">
                {totalForWeek} booking{totalForWeek === 1 ? "" : "s"}
              </div>
            </div>

            <div className="rounded-xl border border-orange-500/20 bg-orange-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-orange-200/80">
                Requests
              </div>
              <div className="text-sm font-semibold text-orange-100">
                {pending.length}
              </div>
            </div>

            <div className="rounded-xl border border-emerald-500/20 bg-emerald-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-emerald-200/80">
                Confirmed
              </div>
              <div className="text-sm font-semibold text-emerald-100">
                {confirmed.length}
              </div>
            </div>

            <div className="rounded-xl border border-red-500/20 bg-red-950/10 px-3 py-2">
              <div className="text-[0.65rem] uppercase tracking-[0.13em] text-red-200/80">
                Cancelled
              </div>
              <div className="text-sm font-semibold text-red-100">
                {cancelled.length}
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* NEW: Requests panel */}
      <div className={cardClass()}>
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">
            Appointment requests (pending)
          </h2>
          {loadingBookings && (
            <span className="text-[0.75rem] text-neutral-400">Loading…</span>
          )}
        </div>

        {pending.length === 0 ? (
          <div className="rounded-xl border border-dashed border-neutral-800/70 bg-neutral-950/40 p-3 text-sm text-neutral-400">
            No pending requests for this week.
          </div>
        ) : (
          <ul className="divide-y divide-neutral-800/70">
            {pending
              .slice()
              .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at))
              .map((b) => (
                <li key={b.id} className="flex flex-wrap items-center gap-3 py-3 text-sm">
                  <div className="min-w-0 flex-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="font-medium text-neutral-50">
                        {b.customer_name || "Customer"}
                      </div>
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>
                    </div>

                    <div className="mt-0.5 text-[0.75rem] text-neutral-400">
                      {new Date(b.starts_at).toLocaleString()} –{" "}
                      {new Date(b.ends_at).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </div>

                    <div className="mt-1 flex flex-wrap gap-x-3 gap-y-1 text-[0.75rem] text-neutral-500">
                      {b.customer_phone ? <span>{b.customer_phone}</span> : null}
                      {b.customer_email ? <span>{b.customer_email}</span> : null}
                    </div>

                    {b.notes ? (
                      <div className="mt-1 text-[0.75rem] text-neutral-500">
                        {b.notes}
                      </div>
                    ) : null}
                  </div>

                  <div className="flex items-center gap-2">
                    <Button
                      type="button"
                      size="xs"
                      className="font-semibold"
                      onClick={() => void approveBooking(b)}
                    >
                      Approve
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="outline"
                      className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                      onClick={() => void declineBooking(b)}
                    >
                      Decline
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="outline"
                      onClick={() => setEditing(b)}
                    >
                      Edit
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="ghost"
                      className="text-red-300 hover:bg-red-900/25"
                      onClick={() => void handleDelete(b.id)}
                    >
                      Delete
                    </Button>
                  </div>
                </li>
              ))}
          </ul>
        )}
      </div>

      {/* Calendar */}
      <div className={cardClass()}>
        <div className="mb-3 flex flex-wrap items-center justify-between gap-3">
          <h2 className="text-sm font-semibold text-neutral-50">Weekly calendar</h2>
          <div className="flex items-center gap-2">
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() - 7);
                setWeekStart(d);
              }}
            >
              ← Prev
            </Button>
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => setWeekStart(startOfToday())}
            >
              Today
            </Button>
            <Button
              type="button"
              variant="outline"
              size="xs"
              onClick={() => {
                const d = new Date(weekStart);
                d.setDate(d.getDate() + 7);
                setWeekStart(d);
              }}
            >
              Next →
            </Button>
          </div>
        </div>

        <div className="overflow-x-auto pb-2">
          <WeeklyCalendar
            weekStart={weekStart}
            bookings={bookings}
            onSelectDay={(dayIso) => setCreatingDate(dayIso)}
            onSelectBooking={(b) => setEditing(b)}
            loading={loadingBookings}
          />
        </div>

        <p className="mt-3 text-[0.75rem] text-neutral-500">
          Click a day to create. Click an appointment to edit.
        </p>
      </div>

      {/* Create / Edit */}
      <div className={cardClass()}>
        {editing ? (
          <EditForm
            booking={editing}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onCancel={() => setEditing(null)}
            onSave={(patch) => void handleUpdate(editing.id, patch)}
          />
        ) : (
          <CreateForm
            defaultDate={creatingDate ?? isoDate(weekStart)}
            customers={customers}
            loadingCustomers={loadingCustomers}
            onSubmit={handleCreate}
          />
        )}
      </div>

      {/* List */}
      <div className={cardClass()}>
        <div className="mb-3 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-50">
            Appointments this week ({bookings.length})
          </h2>
          {loadingBookings && (
            <span className="text-[0.75rem] text-neutral-400">Loading…</span>
          )}
        </div>

        {loadingBookings ? (
          <p className="text-sm text-neutral-400">Fetching appointments…</p>
        ) : bookings.length === 0 ? (
          <p className="text-sm text-neutral-400">No appointments for this week.</p>
        ) : (
          <ul className="divide-y divide-neutral-800/70">
            {bookings
              .slice()
              .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at))
              .map((b) => (
                <li key={b.id} className="flex flex-wrap items-center gap-3 py-3 text-sm">
                  <div className="min-w-0 flex-1">
                    <div className="flex flex-wrap items-center gap-2">
                      <div className="font-medium text-neutral-50">
                        {b.customer_name || "Customer"}
                      </div>
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>
                    </div>

                    <div className="text-[0.75rem] text-neutral-400">
                      {new Date(b.starts_at).toLocaleString()} –{" "}
                      {new Date(b.ends_at).toLocaleTimeString([], {
                        hour: "2-digit",
                        minute: "2-digit",
                      })}
                    </div>
                    {b.notes ? (
                      <div className="mt-1 text-[0.75rem] text-neutral-500">{b.notes}</div>
                    ) : null}
                  </div>

                  <div className="flex items-center gap-2">
                    {(b.status || "pending").toLowerCase() === "pending" ? (
                      <>
                        <Button type="button" size="xs" onClick={() => void approveBooking(b)}>
                          Approve
                        </Button>
                        <Button
                          type="button"
                          size="xs"
                          variant="outline"
                          className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                          onClick={() => void declineBooking(b)}
                        >
                          Decline
                        </Button>
                      </>
                    ) : null}

                    <Button type="button" size="xs" variant="outline" onClick={() => setEditing(b)}>
                      Edit
                    </Button>
                    <Button
                      type="button"
                      size="xs"
                      variant="ghost"
                      className="text-red-300 hover:bg-red-900/25"
                      onClick={() => void handleDelete(b.id)}
                    >
                      Delete
                    </Button>
                  </div>
                </li>
              ))}
          </ul>
        )}
      </div>
    </div>
  );
}

async function refreshBookings(
  shopSlug: string,
  weekStart: Date,
  weekEnd: Date,
  setBookings: (b: Booking[]) => void,
) {
  const start = isoDate(weekStart);
  const end = isoDate(weekEnd);
  const res = await fetch(
    `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${start}&end=${end}`,
    { cache: "no-store" },
  );
  const refreshed = (await res.json().catch(() => [])) as Booking[];
  setBookings(refreshed ?? []);
}

/* -------------------------------------------------------------------------- */
/* Forms                                                                      */
/* -------------------------------------------------------------------------- */

function CreateForm({
  defaultDate,
  customers,
  loadingCustomers,
  onSubmit,
}: {
  defaultDate: string;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onSubmit: (form: {
    date: string;
    startsAt: string;
    endsAt: string;
    customerId?: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string;
    notes: string;
  }) => void;
}) {
  const [date, setDate] = useState(defaultDate);
  const [startsAt, setStartsAt] = useState("09:00");
  const [endsAt, setEndsAt] = useState("10:00");
  const [customerId, setCustomerId] = useState<string>("");
  const [customerName, setCustomerName] = useState("");
  const [customerEmail, setCustomerEmail] = useState("");
  const [customerPhone, setCustomerPhone] = useState("");
  const [notes, setNotes] = useState("");

  useEffect(() => {
    setDate(defaultDate);
  }, [defaultDate]);

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        onSubmit({
          date,
          startsAt,
          endsAt,
          customerId: customerId || undefined,
          customerName,
          customerEmail,
          customerPhone,
          notes,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Create appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading…" : "Select…"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input
          value={customerName}
          onChange={(e) => setCustomerName(e.target.value)}
          className={fieldClass()}
          placeholder="John Smith"
        />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <Button type="submit" size="sm" className="mt-1 font-semibold">
        Save appointment
      </Button>
    </form>
  );
}

function EditForm({
  booking,
  customers,
  loadingCustomers,
  onCancel,
  onSave,
}: {
  booking: Booking;
  customers: CustomerRow[];
  loadingCustomers: boolean;
  onCancel: () => void;
  onSave: (patch: Partial<Booking>) => void;
}) {
  const start = new Date(booking.starts_at);
  const end = new Date(booking.ends_at);

  const [date, setDate] = useState(booking.starts_at.slice(0, 10));
  const [startsAt, setStartsAt] = useState(start.toISOString().slice(11, 16));
  const [endsAt, setEndsAt] = useState(end.toISOString().slice(11, 16));

  const [customerId, setCustomerId] = useState<string>(booking.customer_id ?? "");
  const [customerName, setCustomerName] = useState(booking.customer_name ?? "");
  const [customerEmail, setCustomerEmail] = useState(booking.customer_email ?? "");
  const [customerPhone, setCustomerPhone] = useState(booking.customer_phone ?? "");
  const [notes, setNotes] = useState(booking.notes ?? "");
  const [status, setStatus] = useState(booking.status ?? "pending");

  const handleSelectCustomer = (id: string) => {
    setCustomerId(id);
    const c = customers.find((x) => x.id === id);
    if (!c) return;

    const rec = c as unknown as Record<string, unknown>;
    const full = safeString(rec["full_name"]) || safeString(rec["name"]);
    const first = safeString(rec["first_name"]);
    const last = safeString(rec["last_name"]);
    const name = full || `${first} ${last}`.trim();

    setCustomerName(name || "");
    setCustomerEmail(safeString(rec["email"]) || safeString(rec["contact_email"]));
    setCustomerPhone(safeString(rec["phone"]) || safeString(rec["mobile"]));
  };

  return (
    <form
      className="space-y-3"
      onSubmit={(e) => {
        e.preventDefault();
        const starts_at = new Date(`${date}T${startsAt}`).toISOString();
        const ends_at = new Date(`${date}T${endsAt}`).toISOString();
        onSave({
          starts_at,
          ends_at,
          customer_id: customerId || null,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          notes,
          status,
        });
      }}
    >
      <h3 className="text-sm font-semibold text-neutral-50">Edit appointment</h3>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Date
          <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className={fieldClass()} />
        </label>

        <div className="flex gap-2">
          <label className="flex-1 text-xs text-neutral-300">
            Start
            <input type="time" value={startsAt} onChange={(e) => setStartsAt(e.target.value)} className={fieldClass()} />
          </label>
          <label className="flex-1 text-xs text-neutral-300">
            End
            <input type="time" value={endsAt} onChange={(e) => setEndsAt(e.target.value)} className={fieldClass()} />
          </label>
        </div>
      </div>

      <label className="text-xs text-neutral-300">
        Customer (from database)
        <select value={customerId} onChange={(e) => handleSelectCustomer(e.target.value)} className={fieldClass()}>
          <option value="">{loadingCustomers ? "Loading…" : "Select…"}</option>
          {customers.map((c) => (
            <option key={c.id} value={c.id}>
              {customerLabel(c)}
            </option>
          ))}
        </select>
      </label>

      <label className="text-xs text-neutral-300">
        Customer name
        <input value={customerName} onChange={(e) => setCustomerName(e.target.value)} className={fieldClass()} />
      </label>

      <div className="grid gap-2 sm:grid-cols-2">
        <label className="text-xs text-neutral-300">
          Email
          <input type="email" value={customerEmail} onChange={(e) => setCustomerEmail(e.target.value)} className={fieldClass()} />
        </label>
        <label className="text-xs text-neutral-300">
          Phone
          <input value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} className={fieldClass()} />
        </label>
      </div>

      <label className="text-xs text-neutral-300">
        Notes
        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={3} className={fieldClass()} />
      </label>

      <label className="text-xs text-neutral-300">
        Status
        <select value={status} onChange={(e) => setStatus(e.target.value)} className={fieldClass()}>
          <option value="pending">Pending</option>
          <option value="confirmed">Confirmed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </label>

      <div className="flex gap-2">
        <Button type="submit" size="sm" className="font-semibold">
          Save changes
        </Button>
        <Button type="button" size="sm" variant="outline" onClick={onCancel}>
          Cancel
        </Button>
      </div>
    </form>
  );
}

===== FILE: app/portal/appointments/WeeklyCalendar.tsx =====

// app/portal/appointments/WeeklyCalendar.tsx
"use client";

import { useMemo } from "react";
import type { Booking } from "./page";
import { Button } from "@shared/components/ui/Button";

type Props = {
  weekStart: Date;
  bookings: Booking[];
  onSelectDay: (iso: string) => void;
  onSelectBooking: (b: Booking) => void;
  loading?: boolean;
};

function pad2(n: number) {
  return n < 10 ? `0${n}` : `${n}`;
}

// Local date key (prevents UTC drift that can happen with toISOString())
function dayKeyLocal(d: Date) {
  return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
}

function timeLabel(startsAtIso: string, endsAtIso: string) {
  const start = new Date(startsAtIso);
  const end = new Date(endsAtIso);
  const s = start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const e = end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  return `${s} – ${e}`;
}

function safeStr(v: unknown) {
  return typeof v === "string" ? v : "";
}

function displayCustomerName(b: Booking): string {
  // keep compatibility with any older/extra fields without ts-ignore
  const rec = b as unknown as Record<string, unknown>;
  const fromExtra =
    safeStr(rec["customer_full_name"]) ||
    safeStr(rec["customerName"]) ||
    safeStr(rec["name"]);

  return safeStr(b.customer_name) || fromExtra || "Customer";
}

function statusPill(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed") return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled") return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-orange-500/30 bg-orange-900/10 text-orange-200";
}

function bookingCardStyle(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "cancelled") {
    return "border-white/10 bg-black/35 text-neutral-300 hover:bg-black/40";
  }
  if (s === "confirmed") {
    return "border-emerald-400/25 bg-emerald-500/10 hover:bg-emerald-500/15";
  }
  // pending
  return "border-orange-400/30 bg-orange-500/10 hover:bg-orange-500/15";
}

export default function WeeklyCalendar({
  weekStart,
  bookings,
  onSelectDay,
  onSelectBooking,
  loading = false,
}: Props) {
  const days = useMemo(() => {
    return Array.from({ length: 7 }, (_, i) => {
      const d = new Date(weekStart);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + i);
      return d;
    });
  }, [weekStart]);

  const grouped = useMemo(() => {
    const map = new Map<string, Booking[]>();

    for (const b of bookings) {
      const d = new Date(b.starts_at);
      const k = dayKeyLocal(d);
      const arr = map.get(k) ?? [];
      arr.push(b);
      map.set(k, arr);
    }

    map.forEach((arr) => {
      arr.sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at));
    });

    return map;
  }, [bookings]);

  const todayKey = dayKeyLocal(new Date());

  return (
    <div className="grid grid-cols-1 gap-3 md:grid-cols-7">
      {days.map((d) => {
        const k = dayKeyLocal(d);
        const dayBookings = grouped.get(k) ?? [];
        const isToday = todayKey === k;

        const activeCount = dayBookings.filter(
          (b) => (b.status || "pending").toLowerCase() !== "cancelled",
        ).length;

        return (
          <div
            key={k}
            className="flex min-h-[160px] flex-col gap-2 rounded-2xl border border-white/10 bg-black/35 p-3 text-xs text-neutral-100 shadow-card backdrop-blur-md overflow-hidden"
          >
            {/* Day header */}
            <div className="flex items-center gap-2">
              <Button
                type="button"
                variant={isToday ? "default" : "outline"}
                size="sm"
                onClick={() => onSelectDay(k)}
                className="flex w-full items-center justify-between rounded-xl px-2 py-1 text-[0.75rem]"
              >
                <span className="font-medium">
                  {d.toLocaleDateString(undefined, {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                  })}
                </span>

                <span className="flex items-center gap-2">
                  {isToday ? (
                    <span className="rounded-full bg-black/15 px-2 py-0.5 text-[0.65rem] font-semibold uppercase tracking-[0.12em]">
                      Today
                    </span>
                  ) : null}

                  <span className="rounded-full border border-white/10 bg-white/5 px-2 py-0.5 text-[0.65rem] text-neutral-200">
                    {activeCount}
                  </span>
                </span>
              </Button>
            </div>

            {/* Appointments list */}
            <div className="flex-1 space-y-1.5">
              {loading && dayBookings.length === 0 ? (
                <div className="space-y-2">
                  <div className="h-9 w-full animate-pulse rounded-xl border border-white/10 bg-white/5" />
                  <div className="h-9 w-full animate-pulse rounded-xl border border-white/10 bg-white/5" />
                </div>
              ) : dayBookings.length === 0 ? (
                <div className="rounded-xl border border-dashed border-white/10 bg-black/25 px-2 py-2 text-[0.65rem] text-neutral-500">
                  No appointments
                </div>
              ) : (
                dayBookings.map((b) => {
                  const s = (b.status || "pending").toLowerCase();
                  const isCancelled = s === "cancelled";

                  return (
                    <Button
                      key={b.id}
                      type="button"
                      variant="ghost"
                      size="sm"
                      onClick={() => onSelectBooking(b)}
                      className={
                        "flex w-full flex-col items-start gap-1 rounded-xl border px-2 py-2 text-left text-[0.7rem] " +
                        bookingCardStyle(b.status)
                      }
                    >
                      <div className="flex w-full items-center justify-between gap-2">
                        <div className={"truncate font-semibold " + (isCancelled ? "text-neutral-200/80 line-through" : "text-white")}>
                          {displayCustomerName(b)}
                        </div>

                        <div className="flex items-center gap-2">
                          <span
                            className={
                              "inline-flex items-center rounded-full border px-2 py-0.5 text-[0.6rem] uppercase tracking-[0.14em] " +
                              statusPill(b.status)
                            }
                          >
                            {b.status || "pending"}
                          </span>

                          <span className={"whitespace-nowrap text-[0.6rem] " + (isCancelled ? "text-neutral-400" : "text-neutral-200")}>
                            {timeLabel(b.starts_at, b.ends_at)}
                          </span>
                        </div>
                      </div>

                      {b.notes ? (
                        <div className="line-clamp-2 text-[0.62rem] text-neutral-200/80">
                          {b.notes}
                        </div>
                      ) : null}
                    </Button>
                  );
                })
              )}
            </div>
          </div>
        );
      })}
    </div>
  );
}

===== FILE: app/portal/customer-appointments/page.tsx =====

"use client";

import { useEffect, useMemo, useState } from "react";
import { useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { Toaster, toast } from "sonner";

import type { Database } from "@shared/types/types/supabase";
import LinkButton from "@shared/components/ui/LinkButton";
import { Button } from "@shared/components/ui/Button";

type DB = Database;

type CustomerRow = DB["public"]["Tables"]["customers"]["Row"];
type ShopRow = Pick<DB["public"]["Tables"]["shops"]["Row"], "id" | "slug">;

type PortalBooking = {
  id: string;
  shop_slug?: string | null;

  starts_at: string; // ISO
  ends_at: string; // ISO

  customer_id?: string | null;
  customer_name?: string | null;
  customer_email?: string | null;
  customer_phone?: string | null;

  notes?: string | null;
  status?: string | null;
};


function cardClass() {
  return "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";
}

function pillClass(status?: string | null) {
  const s = (status || "pending").toLowerCase();
  if (s === "confirmed")
    return "border-emerald-500/30 bg-emerald-900/15 text-emerald-200";
  if (s === "cancelled")
    return "border-red-500/30 bg-red-900/15 text-red-200";
  return "border-white/12 bg-white/5 text-neutral-200";
}

function fmtRange(startsAtIso: string, endsAtIso: string) {
  const start = new Date(startsAtIso);
  const end = new Date(endsAtIso);

  const date = start.toLocaleDateString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric",
  });

  const startTime = start.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });
  const endTime = end.toLocaleTimeString([], {
    hour: "2-digit",
    minute: "2-digit",
  });

  return { date, time: `${startTime} – ${endTime}` };
}

function isoDate(d: Date) {
  return d.toISOString().slice(0, 10);
}

function addDays(base: Date, days: number) {
  const d = new Date(base);
  d.setDate(d.getDate() + days);
  return d;
}

export default function PortalCustomerAppointmentsPage() {
  const supabase = createClientComponentClient<DB>();
  const router = useRouter();

  const [loading, setLoading] = useState(true);
  const [customer, setCustomer] = useState<CustomerRow | null>(null);

  const [shopSlug, setShopSlug] = useState<string>("");
  const [bookings, setBookings] = useState<PortalBooking[]>([]);
  const [loadingBookings, setLoadingBookings] = useState(false);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      setLoading(true);

      const {
        data: { user },
        error: userErr,
      } = await supabase.auth.getUser();

      if (cancelled) return;

      if (userErr || !user) {
        toast.error("Please sign in to view appointments.");
        router.replace("/portal/auth/sign-in");
        return;
      }

      const { data: c, error: cErr } = await supabase
        .from("customers")
        .select("id,user_id,shop_id,first_name,last_name,email,phone")
        .eq("user_id", user.id)
        .maybeSingle();

      if (cErr) {
        toast.error(cErr.message);
        setCustomer(null);
        setLoading(false);
        return;
      }

      setCustomer((c ?? null) as CustomerRow | null);
      setLoading(false);
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase, router]);

  useEffect(() => {
    let cancelled = false;

    (async () => {
      if (!customer?.shop_id) {
        setShopSlug("");
        return;
      }

      const { data, error } = await supabase
        .from("shops")
        .select("id,slug")
        .eq("id", customer.shop_id)
        .maybeSingle<ShopRow>();

      if (cancelled) return;

      if (error) {
        console.error(error);
        toast.error("Unable to load your shop.");
        setShopSlug("");
        return;
      }

      setShopSlug((data?.slug as string) || "");
    })();

    return () => {
      cancelled = true;
    };
  }, [supabase, customer?.shop_id]);

  useEffect(() => {
    if (!customer?.id) return;
    if (!shopSlug) return;

    (async () => {
      setLoadingBookings(true);
      try {
        const now = new Date();
        const start = isoDate(addDays(now, -180));
        const end = isoDate(addDays(now, 365));

        const res = await fetch(
          `/api/portal/bookings?shop=${encodeURIComponent(shopSlug)}&start=${encodeURIComponent(
            start,
          )}&end=${encodeURIComponent(end)}`,
          { cache: "no-store" },
        );

        if (!res.ok) throw new Error("Failed to load your appointments.");

        const j = (await res.json().catch(() => [])) as PortalBooking[];
        const all = Array.isArray(j) ? j : [];
        const mine = all.filter((b) => (b.customer_id ?? null) === customer.id);

        setBookings(mine);
      } catch (e) {
        console.error(e);
        toast.error("Failed to load appointments.");
        setBookings([]);
      } finally {
        setLoadingBookings(false);
      }
    })();
  }, [customer?.id, shopSlug]);

  const upcoming = useMemo(() => {
    const now = Date.now();
    return bookings
      .filter(
        (b) =>
          +new Date(b.ends_at) >= now &&
          (b.status || "pending").toLowerCase() !== "cancelled",
      )
      .sort((a, b) => +new Date(a.starts_at) - +new Date(b.starts_at));
  }, [bookings]);

  const past = useMemo(() => {
    const now = Date.now();
    return bookings
      .filter(
        (b) =>
          +new Date(b.ends_at) < now ||
          (b.status || "").toLowerCase() === "cancelled",
      )
      .sort((a, b) => +new Date(b.starts_at) - +new Date(a.starts_at));
  }, [bookings]);

  async function cancelBooking(id: string) {
    if (!confirm("Cancel this appointment?")) return;

    try {
      const res = await fetch(`/api/portal/bookings/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: "cancelled" }),
      });

      const j = (await res.json().catch(() => ({}))) as { error?: string };
      if (!res.ok) throw new Error(j?.error || "Cancel failed");

      toast.success("Appointment cancelled.");
      setBookings((prev) =>
        prev.map((b) => (b.id === id ? { ...b, status: "cancelled" } : b)),
      );
    } catch (e) {
      const msg = e instanceof Error ? e.message : "Cancel failed.";
      toast.error(msg);
    }
  }

  if (loading) {
    return (
      <div className="mx-auto max-w-xl">
        <div className={cardClass() + " text-sm text-neutral-200"}>
          Loading your portal…
        </div>
      </div>
    );
  }

  if (!customer) {
    return (
      <div className="mx-auto max-w-xl space-y-3">
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            My appointments
          </h1>
          <p className="mt-2 text-sm text-neutral-400">
            We couldn’t find your customer profile yet.
          </p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">
              Go to profile
            </LinkButton>
            <LinkButton href="/portal/request/when" size="sm">
              Request service
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  if (!shopSlug) {
    return (
      <div className="mx-auto max-w-xl space-y-3">
        <div className={cardClass()}>
          <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
            My appointments
          </h1>
          <p className="mt-2 text-sm text-neutral-400">
            Your portal account isn’t linked to a shop yet.
          </p>
          <div className="mt-4 flex gap-2">
            <LinkButton href="/portal/profile" variant="outline" size="sm">
              Go to profile
            </LinkButton>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="mx-auto w-full max-w-xl space-y-5 text-white">
      <Toaster position="top-center" />

      <header className="space-y-1">
        <h1 className="text-lg font-blackops uppercase tracking-[0.18em] text-neutral-200">
          My appointments
        </h1>
        <p className="text-xs text-neutral-400">
          Request service, then track your upcoming visits here.
        </p>
      </header>

      <div className="flex flex-wrap gap-2">
        <LinkButton href="/portal/request/when" size="sm">
          Request service
        </LinkButton>
        <LinkButton href="/portal/history" variant="outline" size="sm">
          View service history
        </LinkButton>
      </div>

      <section className={cardClass()}>
        <div className="flex items-center justify-between">
          <h2 className="text-sm font-semibold text-neutral-100">
            Upcoming ({upcoming.length})
          </h2>
          {loadingBookings ? (
            <span className="text-[0.75rem] text-neutral-400">Loading…</span>
          ) : null}
        </div>

        {loadingBookings ? (
          <p className="mt-3 text-sm text-neutral-400">Fetching your bookings…</p>
        ) : upcoming.length === 0 ? (
          <p className="mt-3 text-sm text-neutral-400">No upcoming appointments.</p>
        ) : (
          <ul className="mt-3 space-y-2">
            {upcoming.map((b) => {
              const { date, time } = fmtRange(b.starts_at, b.ends_at);
              return (
                <li
                  key={b.id}
                  className="rounded-xl border border-white/10 bg-black/35 p-3"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">
                        {date}
                      </div>
                      <div className="mt-0.5 text-xs text-neutral-300">{time}</div>

                      {b.notes ? (
                        <div className="mt-2 text-xs text-neutral-400">
                          {b.notes}
                        </div>
                      ) : null}
                    </div>

                    <div className="flex flex-col items-end gap-2">
                      <span
                        className={
                          "inline-flex items-center rounded-full border px-2 py-1 text-[0.7rem] uppercase tracking-[0.14em] " +
                          pillClass(b.status)
                        }
                      >
                        {b.status || "pending"}
                      </span>

                      <Button
                        type="button"
                        size="xs"
                        variant="outline"
                        onClick={() => void cancelBooking(b.id)}
                        className="border-red-500/40 text-red-200 hover:bg-red-900/20"
                      >
                        Cancel
                      </Button>
                    </div>
                  </div>
                </li>
              );
            })}
          </ul>
        )}
      </section>

      <section className={cardClass()}>
        <h2 className="text-sm font-semibold text-neutral-100">
          Past ({past.length})
        </h2>

        {loadingBookings ? (
          <p className="mt-3 text-sm text-neutral-400">Loading…</p>
        ) : past.length === 0 ? (
          <p className="mt-3 text-sm text-neutral-400">No past appointments.</p>
        ) : (
          <ul className="mt-3 space-y-2">
            {past.slice(0, 25).map((b) => {
              const { date, time } = fmtRange(b.starts_at, b.ends_at);
              return (
                <li
                  key={b.id}
                  className="rounded-xl border border-white/10 bg-black/25 p-3"
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="min-w-0">
                      <div className="text-sm font-semibold text-neutral-100">
                        {date}
                      </div>
                      <div className="mt-0.5 text-xs text-neutral-400">{time}</div>
                    </div>

                    <span
                      className={
                        "inline-flex items-center rounded-full border px-2 py-1 text-[0.7rem] uppercase tracking-[0.14em] " +
                        pillClass(b.status)
                      }
                    >
                      {b.status || "pending"}
                    </span>
                  </div>

                  {b.notes ? (
                    <div className="mt-2 text-xs text-neutral-500">{b.notes}</div>
                  ) : null}
                </li>
              );
            })}
          </ul>
        )}
      </section>

      <p className="text-[0.75rem] text-neutral-500">
        Need to change a time? Cancel and submit a new request.
      </p>
    </div>
  );
}


===== FILE: app/api/parts/request/create/route.ts =====

(missing)


===== FILE: app/parts/requests/page.tsx =====

"use client";

import { useEffect, useMemo, useState } from "react";
import Link from "next/link";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Request = DB["public"]["Tables"]["part_requests"]["Row"];
type Item = DB["public"]["Tables"]["part_request_items"]["Row"];
type WorkOrderMeta = {
  id: string;
  custom_id: string | null;
};

const ALL_STATUSES: Request["status"][] = [
  "requested",
  "quoted",
  "approved",
  "fulfilled",
  "rejected",
  "cancelled",
];

// Status columns we actually want to show on THIS page
const VISIBLE_STATUSES: Request["status"][] = [
  "requested",
  "quoted",
  "approved",
];

function makeEmptyBuckets(): Record<
  Request["status"],
  (Request & { items: Item[] })[]
> {
  return {
    requested: [],
    quoted: [],
    approved: [],
    fulfilled: [],
    rejected: [],
    cancelled: [],
  };
}

export default function PartsRequestsPage() {
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);

  const [byStatus, setByStatus] = useState<
    Record<Request["status"], (Request & { items: Item[] })[]>
  >(makeEmptyBuckets());

  const [workOrdersById, setWorkOrdersById] = useState<
    Record<string, WorkOrderMeta>
  >({});

  const [search, setSearch] = useState("");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    void (async () => {
      setLoading(true);

      // 1) fetch all requests
      const { data: reqs, error } = await supabase
        .from("part_requests")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        console.error("load part_requests failed:", error.message);
        toast.error("Failed to load parts requests");
        setLoading(false);
        return;
      }

      const requestList = (reqs ?? []) as Request[];
      const requestIds = requestList.map((r) => r.id);

      // 2) fetch all items for these requests
      const itemsMap: Record<string, Item[]> = {};
      if (requestIds.length) {
        const { data: items } = await supabase
          .from("part_request_items")
          .select("*")
          .in("request_id", requestIds);

        for (const it of items ?? []) {
          (itemsMap[it.request_id] ||= []).push(it);
        }
      }

      // 3) fetch work order metadata for display (TU000001 instead of UUID)
      const woIds = Array.from(
        new Set(
          requestList
            .map((r) => r.work_order_id)
            .filter((id): id is string => typeof id === "string" && !!id),
        ),
      );

      const woMap: Record<string, WorkOrderMeta> = {};
      if (woIds.length) {
        const { data: workOrders, error: woError } = await supabase
          .from("work_orders")
          .select("id, custom_id")
          .in("id", woIds);

        if (woError) {
          console.error(
            "load work_orders for parts requests failed:",
            woError.message,
          );
        } else {
          for (const wo of workOrders ?? []) {
            woMap[wo.id] = {
              id: wo.id,
              custom_id: wo.custom_id ?? null,
            };
          }
        }
      }
      setWorkOrdersById(woMap);

      // 4) group by status
      const grouped = makeEmptyBuckets();

      for (const r of requestList) {
        const status = (r.status ?? "requested") as Request["status"];
        const bucket = grouped[status] ?? grouped.requested;
        bucket.push({ ...r, items: itemsMap[r.id] ?? [] });
      }

      setByStatus(grouped);
      setLoading(false);
    })();
  }, [supabase]);

  // Derived: apply search filter client-side
  const filteredByStatus = useMemo(() => {
    const q = search.trim().toLowerCase();
    if (!q) return byStatus;

    const filtered = makeEmptyBuckets();

    (ALL_STATUSES as Request["status"][]).forEach((status) => {
      const list = byStatus[status] ?? [];
      filtered[status] = list.filter((r) => {
        const woMeta = r.work_order_id
          ? workOrdersById[r.work_order_id]
          : undefined;

        // label used both for display and search
        const woLabel =
          woMeta?.custom_id ||
          woMeta?.id ||
          r.work_order_id || // fall back to raw FK if meta missing
          "";

        const inWorkOrder = woLabel.toLowerCase().includes(q);
        const inRequestId = r.id.toLowerCase().includes(q);
        const inItems = (r.items ?? []).some((it) =>
          (it.description ?? "").toLowerCase().includes(q),
        );

        return inWorkOrder || inRequestId || inItems;
      });
    });

    return filtered;
  }, [search, byStatus, workOrdersById]);

  const handleDelete = async (requestId: string) => {
    const confirmed = window.confirm(
      "Delete this parts request? This will also remove its items.",
    );
    if (!confirmed) return;

    // delete items first (in case cascade is not configured)
    const { error: itemsError } = await supabase
      .from("part_request_items")
      .delete()
      .eq("request_id", requestId);

    if (itemsError) {
      console.error(
        "delete part_request_items failed:",
        itemsError.message,
      );
      toast.error("Unable to delete request items.");
      return;
    }

    const { error } = await supabase
      .from("part_requests")
      .delete()
      .eq("id", requestId);

    if (error) {
      console.error("delete part_requests failed:", error.message);
      toast.error("Unable to delete parts request.");
      return;
    }

    // update local state
    setByStatus((prev) => {
      const next = makeEmptyBuckets();
      (ALL_STATUSES as Request["status"][]).forEach((status) => {
        next[status] = (prev[status] ?? []).filter(
          (r) => r.id !== requestId,
        );
      });
      return next;
    });

    toast.success("Parts request deleted.");
  };

  const totalVisibleCount = VISIBLE_STATUSES.reduce(
    (sum, status) => sum + (filteredByStatus[status]?.length ?? 0),
    0,
  );

  return (
    <div className="space-y-4 p-6 text-white">
      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 className="text-2xl font-bold">Parts Requests</h1>
          <p className="mt-1 text-sm text-neutral-400">
            Active requests that still need quoting or approval. Completed
            requests move off this list.
          </p>
        </div>
        <Link
          href="/parts"
          className="inline-flex items-center rounded border border-neutral-700 px-3 py-1.5 text-sm hover:bg-neutral-800"
        >
          Parts Catalog
        </Link>
      </div>

      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <p className="text-xs text-neutral-500">
          Search by WO#, request id, or line description. Showing{" "}
          <span className="font-semibold text-neutral-200">
            {totalVisibleCount}
          </span>{" "}
          active request{totalVisibleCount === 1 ? "" : "s"}.
        </p>
        <div className="w-full md:w-80">
          <input
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            placeholder="Search requests…"
            className="w-full rounded border border-neutral-700 bg-neutral-900 px-3 py-1.5 text-sm text-white placeholder:text-neutral-500 focus:border-orange-500 focus:outline-none"
          />
        </div>
      </div>

      {loading ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-neutral-400">
          Loading…
        </div>
      ) : (
        <div className="grid gap-4 lg:grid-cols-3 xl:grid-cols-4">
          {VISIBLE_STATUSES.map((status) => {
            const list = filteredByStatus[status] ?? [];
            return (
              <div
                key={status}
                className="flex flex-col rounded border border-neutral-800 bg-neutral-900"
              >
                <div className="border-b border-neutral-800 px-3 py-2 text-sm capitalize text-neutral-300">
                  {status}
                </div>
                <div className="flex-1 space-y-3 p-3">
                  {list.length === 0 ? (
                    <div className="text-sm text-neutral-500">
                      No requests
                    </div>
                  ) : (
                    list.map((r) => {
                      const woMeta = r.work_order_id
                        ? workOrdersById[r.work_order_id]
                        : undefined;

                      // Prefer TU000001-style custom id; otherwise fall back
                      // to whatever FK we have, shortened.
                      const woDisplayId =
                        woMeta?.custom_id ||
                        (woMeta?.id ??
                          r.work_order_id ??
                          "")
                          .toString()
                          .slice(0, 8) || null;

                      return (
                        <div
                          key={r.id}
                          className="rounded border border-neutral-800 bg-neutral-950"
                        >
                          <Link
                            href={`/parts/requests/${r.id}`}
                            className="block p-3 hover:border-orange-500"
                          >
                            <div className="flex items-start justify-between gap-2">
                              <div>
                                <div className="text-sm font-semibold">
                                  WO: {woDisplayId ?? "—"}
                                </div>
                                <div className="text-xs text-neutral-400">
                                  {r.created_at
                                    ? new Date(
                                        r.created_at,
                                      ).toLocaleString()
                                    : "—"}
                                </div>
                              </div>
                            </div>

                            <ul className="mt-2 list-disc space-y-1 pl-5 text-sm">
                              {(r.items ?? []).slice(0, 4).map((it) => (
                                <li key={it.id}>
                                  {it.description} × {Number(it.qty)}
                                </li>
                              ))}
                              {(r.items ?? []).length > 4 && (
                                <li>
                                  + {(r.items ?? []).length - 4} more…
                                </li>
                              )}
                            </ul>
                          </Link>

                          <div className="flex items-center justify-end gap-2 border-t border-neutral-800 px-3 py-2">
                            <button
                              type="button"
                              onClick={() => void handleDelete(r.id)}
                              className="text-xs font-medium text-red-300 hover:text-red-200"
                            >
                              Delete
                            </button>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

===== FILE: app/parts/requests/[id]/page.tsx =====

"use client";

import { useEffect, useMemo, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { createClientComponentClient } from "@supabase/auth-helpers-nextjs";
import { toast } from "sonner";
import type { Database } from "@shared/types/types/supabase";

type DB = Database;
type Request = DB["public"]["Tables"]["part_requests"]["Row"];
type Item = DB["public"]["Tables"]["part_request_items"]["Row"] & {
  // schema is catching up
  work_order_line_id?: string | null;
  markup_pct?: number | null;
  qty?: number | null;
};
type Status = Request["status"];
type Part = DB["public"]["Tables"]["parts"]["Row"];
type QuoteUpdate =
  DB["public"]["Tables"]["work_order_quote_lines"]["Update"];

const DEFAULT_MARKUP = 30; // %

type UpsertResponse = {
  ok: boolean;
  menuItemId?: string;
  updated?: boolean;
  error?: string;
  detail?: string;
};

export default function PartsRequestDetail() {
  const { id } = useParams<{ id: string }>();
  const supabase = useMemo(() => createClientComponentClient<DB>(), []);
  const router = useRouter();

  const [req, setReq] = useState<Request | null>(null);
  const [items, setItems] = useState<Item[]>([]);
  const [loading, setLoading] = useState(true);
  const [addingItem, setAddingItem] = useState(false);
  const [parts, setParts] = useState<Part[]>([]);
  const [markupPct, setMarkupPct] = useState<Record<string, number>>({});
  const [savedRows, setSavedRows] = useState<Record<string, boolean>>({});
  // per-line manual part inputs
  const [manualParts, setManualParts] = useState<
    Record<string, { name: string; sku: string }>
  >({});

  async function load() {
    setLoading(true);

    // header
    const { data: r, error: rErr } = await supabase
      .from("part_requests")
      .select("*")
      .eq("id", id)
      .maybeSingle();
    if (rErr) toast.error(rErr.message);
    setReq(r ?? null);

    // items
    const { data: its, error: itErr } = await supabase
      .from("part_request_items")
      .select("*")
      .eq("request_id", id);
    if (itErr) toast.error(itErr.message);
    const itemsList = (its ?? []) as Item[];
    setItems(itemsList);

    // inventory
    if (r?.shop_id) {
      const { data: ps } = await supabase
        .from("parts")
        .select("*")
        .eq("shop_id", r.shop_id)
        .order("name")
        .limit(500);
      setParts(ps ?? []);
    } else {
      setParts([]);
    }

    // markup init
    const m: Record<string, number> = {};
    for (const it of itemsList) {
      m[it.id] =
        typeof it.markup_pct === "number" && !Number.isNaN(it.markup_pct)
          ? it.markup_pct
          : DEFAULT_MARKUP;
    }
    setMarkupPct(m);

    // clear saved flags on fresh load
    setSavedRows({});

    setLoading(false);
  }

  useEffect(() => {
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [id]);

  function getLineIdFromItems(list: Item[]): string | null {
    for (const it of list) {
      if (it.work_order_line_id) return it.work_order_line_id;
    }
    return null;
  }

  async function addItem() {
    if (!req) {
      toast.error("Request not loaded yet.");
      return;
    }
    setAddingItem(true);
    try {
      const lineId = getLineIdFromItems(items);

      const insertPayload: DB["public"]["Tables"]["part_request_items"]["Insert"] =
        {
          request_id: req.id,
          work_order_line_id: lineId ?? null,
          description: "",
          qty: 1,
          quoted_price: 0,
          vendor: null,
        };

      const { data, error } = await supabase
        .from("part_request_items")
        .insert(insertPayload)
        .select("*")
        .maybeSingle<Item>();

      if (error) {
        toast.error(error.message);
        return;
      }
      if (!data) {
        toast.error("Could not create a new item.");
        return;
      }

      // append to local state so it feels instant
      setItems((prev) => [...prev, data]);
      setMarkupPct((prev) => ({
        ...prev,
        [data.id]: DEFAULT_MARKUP,
      }));
      setSavedRows((prev) => ({ ...prev, [data.id]: false }));
    } finally {
      setAddingItem(false);
    }
  }

  async function deleteLine(itemId: string) {
    const ok = window.confirm("Remove this item from the request?");
    if (!ok) return;

    const { error } = await supabase
      .from("part_request_items")
      .delete()
      .eq("id", itemId);

    if (error) {
      toast.error(error.message);
      return;
    }

    setItems((prev) => prev.filter((it) => it.id !== itemId));
    setMarkupPct((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });
    setSavedRows((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });
    setManualParts((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });

    toast.success("Item removed.");
  }

  async function setStatus(s: Status) {
    const { error } = await supabase.rpc("set_part_request_status", {
      p_request: id,
      p_status: s,
    });
    if (error) {
      toast.error(error.message);
      return;
    }

    if (s === "quoted") {
      const lineId = getLineIdFromItems(items);
      if (lineId) {
        // ✅ mark line quoted and pending approval on the WO
        const { error: wolErr } = await supabase
          .from("work_order_lines")
          .update({
            status: "quoted",
            approval_state: "pending",
            hold_reason: "Parts quote ready – awaiting customer approval",
          } as DB["public"]["Tables"]["work_order_lines"]["Update"])
          .eq("id", lineId);
        if (wolErr) {
          console.warn("could not set line to quoted:", wolErr.message);
        }

        // 🔗 sync pricing into work_order_quote_lines for this WO line
        if (req?.work_order_id) {
          let partsTotalForLine = 0;

          for (const it of items) {
            if (it.work_order_line_id !== lineId) continue;

            const cost =
              typeof it.quoted_price === "number" &&
              !Number.isNaN(it.quoted_price)
                ? it.quoted_price
                : 0;
            const m = markupPct[it.id] ?? DEFAULT_MARKUP;
            const unitSell = cost * (1 + m / 100);
            const qty =
              typeof it.qty === "number" && it.qty > 0
                ? Number(it.qty)
                : 0;

            partsTotalForLine += unitSell * qty;
          }

          const { error: quoteErr } = await supabase
            .from("work_order_quote_lines")
            .update({
              stage: "advisor_pending",
              parts_total: partsTotalForLine,
              grand_total: partsTotalForLine,
            } as QuoteUpdate)
            .match({
              work_order_id: req.work_order_id,
              work_order_line_id: lineId,
            });

          if (quoteErr) {
            console.warn(
              "could not sync work_order_quote_lines from parts quote:",
              quoteErr.message,
            );
          }
        }

        // save to menu items (grow Saved Menu)
        try {
          const res = await fetch("/api/menu-items/upsert-from-line", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ workOrderLineId: lineId }),
          });

          const j = (await res.json().catch(() => null)) as UpsertResponse | null;

          if (!res.ok || !j?.ok) {
            console.warn("menu save failed:", j);
            const msg =
              j?.detail ||
              j?.error ||
              "Quoted, but couldn’t save to menu items (see server logs / RLS).";
            toast.warning(msg);
          } else {
            const suffix = j.updated ? "updated" : "saved";
            toast.success(`Quoted and ${suffix} to menu items.`);
          }
        } catch (e) {
          console.warn("menu save error:", e);
          const msg =
            e instanceof Error
              ? `Quoted, but couldn’t save to menu items: ${e.message}`
              : "Quoted, but couldn’t save to menu items (network error).";
          toast.warning(msg);
        }
      } else {
        // no linked work_order_line_id → can’t grow menu, just mark quoted
        toast.success("Parts request marked as quoted.");
      }
    } else {
      toast.success(`Parts request marked as ${s}.`);
    }

    await load();
  }

  async function saveLine(it: Item) {
    const qty =
      typeof it.qty === "number" && !Number.isNaN(it.qty) ? it.qty : null;
    if (!qty || qty <= 0) {
      toast.error("Enter a quantity greater than 0 before saving.");
      return;
    }

    const cost =
      typeof it.quoted_price === "number" && !Number.isNaN(it.quoted_price)
        ? it.quoted_price
        : 0;
    const m = markupPct[it.id] ?? DEFAULT_MARKUP;

    const { error } = await supabase
      .from("part_request_items")
      .update({
        vendor: it.vendor ?? null,
        quoted_price: cost,
        qty,
        markup_pct: m,
      })
      .eq("id", it.id);

    if (error) {
      toast.error(error.message);
      return;
    }

    setSavedRows((prev) => ({ ...prev, [it.id]: true }));
    toast.success("Line saved");
  }

  async function attachPartToItem(itemId: string, partId: string) {
    const p = parts.find((x) => x.id === partId);
    const desc = p?.name ?? "Part";

    const { error } = await supabase
      .from("part_request_items")
      .update({
        part_id: partId,
        description: desc,
      })
      .eq("id", itemId);

    if (error) {
      console.warn("attachPartToItem failed:", error.message);
      toast.error("Cannot attach part — check RLS.");
    } else {
      // change → unsave
      setSavedRows((prev) => ({ ...prev, [itemId]: false }));
      await load();
    }
  }

  // manual: create part in inventory, then attach
  async function createManualPartAndAttach(
    itemId: string,
    name: string,
    sku: string,
  ) {
    const item = items.find((x) => x.id === itemId);
    if (!item) return;
    if (!req?.shop_id) {
      toast.error("Cannot create part — missing shop.");
      return;
    }
    if (!name.trim()) {
      toast.error("Enter a name for the part.");
      return;
    }

    // create part in inventory
    const { data: inserted, error } = await supabase
      .from("parts")
      .insert({
        shop_id: req.shop_id,
        name: name.trim(),
        sku: sku.trim() || null,
      })
      .select("*")
      .maybeSingle<Part>();

    if (error) {
      toast.error(error.message);
      return;
    }

    if (!inserted) {
      toast.error("Unable to create part.");
      return;
    }

    // attach to item
    const { error: attachErr } = await supabase
      .from("part_request_items")
      .update({
        part_id: inserted.id,
        description: inserted.name ?? name.trim(),
      })
      .eq("id", itemId);

    if (attachErr) {
      toast.error(attachErr.message);
      return;
    }

    toast.success("Part created and attached.");
    // clear manual fields for that line
    setManualParts((prev) => {
      const copy = { ...prev };
      delete copy[itemId];
      return copy;
    });

    // reload so the new part shows up in the select too
    await load();
  }

  const grandTotals = (() => {
    let sum = 0;
    for (const it of items) {
      const cost =
        typeof it.quoted_price === "number" && !Number.isNaN(it.quoted_price)
          ? it.quoted_price
          : 0;
      const m = markupPct[it.id] ?? DEFAULT_MARKUP;
      const unitSell = cost * (1 + m / 100);
      const qty =
        typeof it.qty === "number" && it.qty > 0 ? Number(it.qty) : 0;
      sum += unitSell * qty;
    }
    return sum;
  })();

  return (
    <div className="space-y-4 p-6 text-white">
      <button
        className="rounded border border-neutral-700 px-2 py-1 text-sm hover:bg-neutral-800"
        onClick={() => router.back()}
      >
        ← Back
      </button>

      {loading || !req ? (
        <div className="rounded border border-neutral-800 bg-neutral-900 p-3 text-neutral-400">
          Loading…
        </div>
      ) : (
        <>
          {/* header */}
          <div className="rounded border border-neutral-800 bg-neutral-900 p-4">
            <div className="flex flex-wrap items-center justify-between gap-2">
              <div>
                <div className="text-xl font-semibold">
                  Request #{req.id.slice(0, 8)}
                </div>
                <div className="text-sm text-neutral-400">
                  WO: {req.work_order_id ?? "—"} ·{" "}
                  {req.created_at
                    ? new Date(req.created_at).toLocaleString()
                    : "—"}
                </div>
              </div>
              <div className="flex flex-wrap items-center gap-2">
                <span className="rounded-full border border-neutral-700 bg-neutral-950 px-3 py-1 text-xs capitalize text-neutral-200">
                  Status: {req.status}
                </span>
                {req.status !== "approved" && (
                  <button
                    className="rounded border border-blue-600 px-3 py-1.5 text-sm text-blue-300 hover:bg-blue-900/20"
                    onClick={() => void setStatus("approved")}
                  >
                    Mark Approved
                  </button>
                )}
                {req.status !== "quoted" && (
                  <button
                    className="rounded border border-orange-500 px-3 py-1.5 text-sm text-orange-300 hover:bg-orange-500/10"
                    onClick={() => void setStatus("quoted")}
                  >
                    Mark Quoted
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* items + table */}
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <h2 className="text-sm font-semibold text-neutral-200">
                Items in this request
              </h2>
              <button
                type="button"
                className="inline-flex items-center rounded border border-neutral-600 bg-neutral-900 px-3 py-1.5 text-xs font-medium text-neutral-100 hover:bg-neutral-800 disabled:opacity-60"
                onClick={() => void addItem()}
                disabled={addingItem}
              >
                {addingItem ? "Adding…" : "＋ Add item"}
              </button>
            </div>

            <div className="overflow-hidden rounded border border-neutral-800">
              <table className="w-full text-sm">
                <thead className="bg-neutral-900 text-neutral-400">
                  <tr>
                    <th className="p-2 text-left">Inventory</th>
                    <th className="p-2 text-left">Description</th>
                    <th className="p-2 text-right">Qty</th>
                    <th className="p-2 text-left">Vendor</th>
                    <th className="p-2 text-right">Cost (unit)</th>
                    <th className="p-2 text-right">Markup %</th>
                    <th className="p-2 text-right">Sell (unit)</th>
                    <th className="p-2 text-right">Line total</th>
                    <th className="w-32 p-2" />
                  </tr>
                </thead>
                <tbody>
                  {items.map((it) => {
                    const cost =
                      typeof it.quoted_price === "number" &&
                      !Number.isNaN(it.quoted_price)
                        ? it.quoted_price
                        : 0;
                    const m = markupPct[it.id] ?? DEFAULT_MARKUP;
                    const qty =
                      typeof it.qty === "number" && it.qty > 0
                        ? it.qty
                        : null;
                    const unitSell = cost * (1 + m / 100);
                    const lineTotal = unitSell * (qty ?? 0);
                    const isSaved = savedRows[it.id] === true;

                    const manual = manualParts[it.id] || {
                      name: "",
                      sku: "",
                    };

                    return (
                      <tr
                        key={it.id}
                        className={`border-t border-neutral-800 ${
                          isSaved ? "bg-neutral-900/50 text-neutral-400" : ""
                        }`}
                      >
                        <td className="p-2 align-top">
                          <div className="flex flex-col gap-1">
                            <select
                              className="w-40 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                              value={it.part_id ?? ""}
                              onChange={(e) => {
                                setSavedRows((prev) => ({
                                  ...prev,
                                  [it.id]: false,
                                }));
                                void attachPartToItem(it.id, e.target.value);
                              }}
                              disabled={isSaved}
                            >
                              <option value="">— select —</option>
                              {parts.map((p) => (
                                <option key={p.id} value={p.id as string}>
                                  {p.sku ? `${p.sku} — ${p.name}` : p.name}
                                </option>
                              ))}
                            </select>

                            {/* manual entry */}
                            <div className="flex gap-1">
                              <input
                                className="flex-1 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                                placeholder="Manual part name"
                                value={manual.name}
                                onChange={(e) =>
                                  setManualParts((prev) => ({
                                    ...prev,
                                    [it.id]: {
                                      name: e.target.value,
                                      sku: prev[it.id]?.sku ?? "",
                                    },
                                  }))
                                }
                                disabled={isSaved}
                              />
                              <input
                                className="w-20 rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                                placeholder="SKU"
                                value={manual.sku}
                                onChange={(e) =>
                                  setManualParts((prev) => ({
                                    ...prev,
                                    [it.id]: {
                                      name: prev[it.id]?.name ?? "",
                                      sku: e.target.value,
                                    },
                                  }))
                                }
                                disabled={isSaved}
                              />
                            </div>
                            <button
                              className="rounded border border-neutral-700 bg-neutral-900 px-2 py-0.5 text-xs hover:bg-neutral-800 disabled:opacity-50"
                              onClick={() =>
                                void createManualPartAndAttach(
                                  it.id,
                                  manual.name,
                                  manual.sku,
                                )
                              }
                              disabled={isSaved}
                            >
                              Add & attach
                            </button>
                          </div>
                        </td>
                        <td className="p-2 align-top">
                          <input
                            className="w-full rounded border border-neutral-700 bg-neutral-900 p-1 text-xs disabled:opacity-50"
                            value={it.description ?? ""}
                            placeholder="Description"
                            onChange={(e) => {
                              const v = e.target.value;
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id
                                    ? ({ ...x, description: v } as Item)
                                    : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            min={1}
                            step={1}
                            className="w-16 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={qty ?? ""} // allow empty
                            onChange={(e) => {
                              const raw = e.target.value;
                              setItems((prev) => {
                                return prev.map((x) => {
                                  if (x.id !== it.id) return x;
                                  return {
                                    ...x,
                                    qty: raw === "" ? null : Number(raw),
                                  } as Item;
                                });
                              });
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 align-top">
                          <input
                            className="w-32 rounded border border-neutral-700 bg-neutral-900 p-1 disabled:opacity-50"
                            value={it.vendor ?? ""}
                            onChange={(e) => {
                              const v = e.target.value;
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id ? { ...x, vendor: v } : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            step={0.01}
                            className="w-24 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={cost === 0 ? "" : cost}
                            onChange={(e) => {
                              const raw = e.target.value;
                              const v = raw === "" ? null : Number(raw);
                              setItems((prev) =>
                                prev.map((x) =>
                                  x.id === it.id
                                    ? ({ ...x, quoted_price: v } as Item)
                                    : x,
                                ),
                              );
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right align-top">
                          <input
                            type="number"
                            step={1}
                            className="w-20 rounded border border-neutral-700 bg-neutral-900 p-1 text-right disabled:opacity-50"
                            value={m}
                            onChange={(e) => {
                              setMarkupPct((prev) => ({
                                ...prev,
                                [it.id]: Math.max(
                                  0,
                                  Number(e.target.value || DEFAULT_MARKUP),
                                ),
                              }));
                              setSavedRows((prev) => ({
                                ...prev,
                                [it.id]: false,
                              }));
                            }}
                            disabled={isSaved}
                          />
                        </td>
                        <td className="p-2 text-right tabular-nums align-top">
                          {unitSell.toFixed(2)}
                        </td>
                        <td className="p-2 text-right tabular-nums align-top">
                          {lineTotal.toFixed(2)}
                        </td>
                        <td className="p-2 align-top">
                          <div className="flex flex-col items-stretch gap-1">
                            <button
                              className={`rounded border px-2 py-1 text-xs ${
                                isSaved
                                  ? "cursor-default border-neutral-700 bg-neutral-800/60 text-neutral-300"
                                  : "border-neutral-700 hover:bg-neutral-800"
                              }`}
                              onClick={() => !isSaved && void saveLine(it)}
                              disabled={isSaved}
                            >
                              {isSaved ? "Saved" : "Save"}
                            </button>
                            <button
                              className="rounded border border-red-700 px-2 py-1 text-xs text-red-200 hover:bg-red-900/40"
                              onClick={() => void deleteLine(it.id as string)}
                            >
                              Delete
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
                <tfoot>
                  <tr className="bg-neutral-900/50">
                    <td className="p-2 text-right" colSpan={7}>
                      <span className="text-sm text-neutral-300">
                        Total (with markup)
                      </span>
                    </td>
                    <td className="p-2 text-right tabular-nums font-semibold">
                      {grandTotals.toFixed(2)}
                    </td>
                    <td />
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </>
      )}
    </div>
  );
}

===== FILE: app/portal/parts/page.tsx =====

import PortalShell from "@/features/portal/components/PortalShell";
import Link from "next/link";

const muted = "text-neutral-400";
const glass =
  "rounded-2xl border border-white/10 bg-black/25 p-4 backdrop-blur-md shadow-card";

export default function PortalPartsPage() {
  return (
    <PortalShell
      title="Customer Portal"
      subtitle="Parts approvals, requested parts, and statuses"
    >
      <div className="space-y-4">
        <div>
          <div className="text-xs uppercase tracking-[0.16em] text-neutral-500">
            Parts
          </div>
          <h1 className="font-header text-3xl text-orange-400">Parts & Approvals</h1>
          <p className={`mt-1 text-sm ${muted}`}>
            If your shop requests parts approval, you’ll see them here.
          </p>
        </div>

        <div className={glass}>
          <div className="text-sm font-semibold text-neutral-100">What you can do here</div>
          <ul className={`mt-2 list-disc pl-5 text-sm ${muted} space-y-1`}>
            <li>Review requested parts from the shop</li>
            <li>Approve or decline before ordering</li>
            <li>Track status (requested → approved → ordered → installed)</li>
          </ul>

          <div className="mt-4 flex flex-wrap gap-2">
            <Link
              href="/portal/request/when"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              Start a new request
            </Link>
            <Link
              href="/portal/history"
              className="inline-flex items-center rounded-full border border-white/18 bg-black/40 px-3 py-1 text-xs font-semibold text-neutral-100 hover:bg-black/70"
            >
              View history
            </Link>
          </div>
        </div>

        <div className={`${glass} ${muted} text-sm`}>
          Next step: wire this page to your parts-request table/view once we confirm the exact
          schema you’re using for portal approvals.
        </div>
      </div>
    </PortalShell>
  );
}


===== FILE: app/portal/parts/requests/page.tsx =====

(missing)


===== FILE: src/features/shared/lib/supabase/client.ts =====

(missing)


===== FILE: src/features/shared/lib/supabase/server.ts =====

(missing)


===== FILE: src/shared/components/ui/Button.tsx =====

(missing)
